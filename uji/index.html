<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SIMPADAN TANGKAP - SISTEM PEMETAAN NELAYAN</title>
    
    <!-- LOAD SEMUA CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- Style tambahan untuk tombol informasi dan gambar modal -->
    <style>
        /* Tombol informasi jenis ikan */
        .fish-info-btn {
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .fish-info-btn:hover {
            background-color: #0b5ed7;
            transform: scale(1.1);
        }

        /* Tombol informasi jenis kapal */
        .boat-info-btn {
            background-color: #198754;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .boat-info-btn:hover {
            background-color: #157347;
            transform: scale(1.1);
        }

        /* Modal gambar ikan - DIPERBAIKI */
        .fish-modal-img {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 15px auto;
        }
        
        /* Modal gambar kapal */
        .boat-modal-img {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 15px auto;
        }
        
        /* Container untuk gambar ikan */
        .fish-image-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Container untuk gambar kapal */
        .boat-image-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .fish-image-title {
            font-size: 16px;
            font-weight: 600;
            color: #0c2461;
            margin-bottom: 8px;
            text-align: left;
        }
        
        .boat-image-title {
            font-size: 16px;
            font-weight: 600;
            color: #0c2461;
            margin-bottom: 8px;
            text-align: left;
        }
        
        .fish-image-caption {
            font-size: 14px;
            color: #6c757d;
            text-align: left;
            font-style: italic;
        }
        
        .boat-image-caption {
            font-size: 14px;
            color: #6c757d;
            text-align: left;
            font-style: italic;
        }
        
        /* Loading untuk gambar */
        .fish-image-loading {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .boat-image-loading {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Perbaikan untuk backdrop modal */
        .modal-backdrop {
            z-index: 1040;
        }
        
        .modal {
            z-index: 1050;
        }
        
        /* Perbaikan untuk modal fishInfoModal dan boatInfoModal */
        #fishInfoModal .modal-content,
        #boatInfoModal .modal-content {
            z-index: 1060;
        }
    </style>
    
    <!-- LOAD SEMUA JAVASCRIPT LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- LOAD FILE JAVASCRIPT YANG DIPISAHKAN -->
    <script src="idcard.js" onerror="console.log('File idcard.js tidak ditemukan, menggunakan versi di main.js')"></script>
    <script src="reload.js" onerror="console.log('File reload.js belum tersedia di server, menggunakan database lokal.')"></script>
    <script src="convert.js"></script>
    <script src="main.js" defer></script>
    
    <!-- Skrip untuk mengelola modal gambar ikan dan kapal - DIPERBAIKI -->
    <script>
        // Fungsi untuk menampilkan modal info ikan
        function showFishInfoModal() {
            try {
                // Hapus backdrop yang mungkin tertinggal
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Hapus kelas modal-open dari body jika ada
                document.body.classList.remove('modal-open');
                
                const fishModal = new bootstrap.Modal(document.getElementById('fishInfoModal'), {
                    backdrop: true,
                    keyboard: true
                });
                fishModal.show();
                
                // Preload gambar untuk memastikan dapat dimuat
                preloadFishImages();
            } catch (error) {
                console.error('Gagal membuka modal info ikan:', error);
                alert('Modal informasi ikan tidak dapat dibuka. Silakan coba lagi.');
            }
        }
        
        // Fungsi untuk menampilkan modal info kapal
        function showBoatInfoModal() {
            try {
                // Hapus backdrop yang mungkin tertinggal
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Hapus kelas modal-open dari body jika ada
                document.body.classList.remove('modal-open');
                
                const boatModal = new bootstrap.Modal(document.getElementById('boatInfoModal'), {
                    backdrop: true,
                    keyboard: true
                });
                boatModal.show();
                
                // Preload gambar untuk memastikan dapat dimuat
                preloadBoatImages();
            } catch (error) {
                console.error('Gagal membuka modal info kapal:', error);
                alert('Modal informasi kapal tidak dapat dibuka. Silakan coba lagi.');
            }
        }
        
        // Fungsi untuk memuat gambar ikan secara asinkron
        function preloadFishImages() {
            const imageUrls = [
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-1.jpg',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-2.jpg',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-3.jpg'
            ];
            
            imageUrls.forEach((url, index) => {
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    console.log(`Gambar ikan ${index + 1} berhasil dimuat`);
                };
                img.onerror = function() {
                    console.error(`Gagal memuat gambar ikan ${index + 1}: ${url}`);
                    // Tampilkan placeholder jika gambar gagal dimuat
                    const imgElement = document.getElementById(`fishImage${index + 1}`);
                    if (imgElement) {
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23f8f9fa"/><text x="200" y="150" text-anchor="middle" font-family="Arial" font-size="16" fill="%236c757d">Gambar tidak tersedia</text></svg>';
                        imgElement.alt = `Gambar referensi ikan ${index + 1} tidak tersedia`;
                    }
                };
            });
        }
        
        // Fungsi untuk memuat gambar kapal secara asinkron
        function preloadBoatImages() {
            const imageUrls = [
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-1.png',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-2.png',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-3.png'
            ];
            
            imageUrls.forEach((url, index) => {
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    console.log(`Gambar kapal ${index + 1} berhasil dimuat`);
                };
                img.onerror = function() {
                    console.error(`Gagal memuat gambar kapal ${index + 1}: ${url}`);
                    // Tampilkan placeholder jika gambar gagal dimuat
                    const imgElement = document.getElementById(`boatImage${index + 1}`);
                    if (imgElement) {
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23f8f9fa"/><text x="200" y="150" text-anchor="middle" font-family="Arial" font-size="16" fill="%236c757d">Gambar tidak tersedia</text></svg>';
                        imgElement.alt = `Gambar referensi kapal ${index + 1} tidak tersedia`;
                    }
                };
            });
        }
        
        // Fungsi untuk menampilkan gambar spesifik di modal
        function showSpecificFishImage(imageNumber) {
            showFishInfoModal();
            // Jika perlu scroll ke gambar tertentu
            setTimeout(() => {
                const imageElement = document.getElementById(`fishImage${imageNumber}`);
                if (imageElement) {
                    imageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }
        
        // Fungsi untuk menampilkan gambar spesifik di modal kapal
        function showSpecificBoatImage(imageNumber) {
            showBoatInfoModal();
            // Jika perlu scroll ke gambar tertentu
            setTimeout(() => {
                const imageElement = document.getElementById(`boatImage${imageNumber}`);
                if (imageElement) {
                    imageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }
        
        // Fungsi untuk menutup modal ikan dengan aman - DITAMBAHKAN
        function closeFishInfoModalSafely() {
            try {
                const modalElement = document.getElementById('fishInfoModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Hapus backdrop setelah modal ditutup
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // Hapus kelas modal-open dari body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 300);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }
        
        // Fungsi untuk menutup modal kapal dengan aman - DITAMBAHKAN
        function closeBoatInfoModalSafely() {
            try {
                const modalElement = document.getElementById('boatInfoModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Hapus backdrop setelah modal ditutup
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // Hapus kelas modal-open dari body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 300);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }
        
        // Fungsi untuk kembali ke input data nelayan - DIPERBAIKI
        function goToInputDataAfterModal() {
            // Tutup modal dengan aman terlebih dahulu
            closeFishInfoModalSafely();
            closeBoatInfoModalSafely();
            
            // Tunggu sebentar untuk memastikan modal benar-benar tertutup
            setTimeout(() => {
                try {
                    // Klik tab input data
                    const inputTab = document.getElementById('v-pills-input-tab');
                    if (inputTab) {
                        inputTab.click();
                        
                        // Scroll ke atas halaman
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                        
                        // Fokus ke form input
                        const namaInput = document.getElementById('nama');
                        if (namaInput) {
                            setTimeout(() => {
                                namaInput.focus();
                            }, 100);
                        }
                    }
                } catch (error) {
                    console.error('Error navigating to input tab:', error);
                }
            }, 400);
        }
    </script>
</head>
<body>

    <!-- Modal Loading -->
    <div class="loading-modal-overlay" id="loadingModal" style="display: none;">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <h3 class="loading-title" id="loadingTitle">Memproses Data</h3>
            <p class="loading-message" id="loadingMessage">Mohon tunggu, sistem sedang memproses permintaan Anda. Proses ini mungkin memerlukan waktu beberapa saat tergantung jumlah data yang tersedia.</p>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <div id="qr-code-generator">
        <div id="qr-right"></div> 
    </div>
    
    <!-- Container untuk tabel PDF (hidden) -->
    <div class="pdf-table-container" id="pdfTableContainer"></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- PERBAIKAN LOGIN: TAMBAHKAN INPUT USERNAME -->
    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMPADAN TANGKAP" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-eye fa-4x\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMPADAN TANGKAP</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <!-- PERBAIKAN: UBAH FORM LOGIN SESUAI DENGAN main.js -->
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-primary fw-bold mb-2" id="currentDateDisplay"></p>
                        
                        <!-- Input Username -->
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden mb-3">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-user text-primary"></i></span>
                            <input type="text" class="form-control bg-light border-0 fs-6" id="loginUsername" placeholder="Masukkan username" required>
                        </div>
                        
                        <!-- Input Password -->
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="loginPassword" placeholder="Masukkan password" required>
                            <button type="button" class="input-group-text bg-light border-0 password-toggle-btn" id="loginPasswordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="passwordHint">Masukkan username dan password untuk mengakses sistem</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                
                <!-- TOMBOL TAMBAHAN BARU -->
                <div class="login-extra-buttons">
                    <a href="https://drive.google.com/drive/folders/1zmLnQ8bXFEL682BXzA2pV6WsQq7p4wdo?usp=sharing" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Panduan Aplikasi
                    </a>
                    <a href="http://www.dinasperikanansitubondo.com/simpadan/peta" target="_blank" class="btn btn-outline-success">
                        <i class="fas fa-map me-2"></i>Lihat Peta
                    </a>
                </div>
                
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notifikasi Login Berhasil -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="w-100 d-flex flex-column align-items-center justify-content-center">
                        <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                        <h4 class="fw-bold mb-0 text-center">Akses Diotorisasi</h4>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon d-flex justify-content-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMPADAN TANGKAP</h5>
                    
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-4 text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Sistem ini menggunakan teknologi keamanan dinamis untuk melindungi data sensitif
                    </p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    </script>

</body>
</html>
