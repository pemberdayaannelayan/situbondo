<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SIMPADAN TANGKAP - SISTEM PEMETAAN NELAYAN</title>
    
    <!-- LOAD SEMUA CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- Style tambahan untuk login yang diperbaiki -->
    <style>
        /* ==============================
           PERBAIKAN UTAMA UNTUK LOGIN
           ============================== */
        
        /* Overlay login dengan background yang lebih kontras */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 50%, #4a69bd 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 20px;
        }
        
        /* Kartu login dengan kontras yang lebih baik */
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
            margin: 20px;
        }
        
        /* Header login dengan warna yang lebih kontras */
        .login-header-new {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            position: relative;
        }
        
        /* Kontainer logo dengan bayangan yang lebih jelas */
        .simata-logo-container {
            margin-bottom: 20px;
        }
        
        .simata-icon-box {
            width: 90px;
            height: 90px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            border: 3px solid rgba(255, 255, 255, 0.8);
        }
        
        .simata-icon-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Judul dan subtitle dengan kontras yang lebih baik */
        .simata-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
            font-family: 'Montserrat', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ffffff;
        }
        
        .simata-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .simata-slogan {
            font-size: 13px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 18px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Form login dengan kontras yang lebih baik */
        .login-form-container {
            padding: 30px;
            background: #ffffff;
        }
        
        /* Label form dengan warna yang kontras */
        .login-form-label {
            font-weight: 600;
            color: #0c2461;
            margin-bottom: 8px;
            font-size: 15px;
            display: block;
        }
        
        /* Input group dengan kontras yang lebih baik */
        .login-input-group {
            margin-bottom: 20px;
        }
        
        .login-input-group .input-group {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .login-input-group .input-group:focus-within {
            border-color: #0c2461;
            box-shadow: 0 0 0 3px rgba(12, 36, 97, 0.1);
        }
        
        .login-input-group .input-group-text {
            background: #f8f9fa;
            border: none;
            color: #0c2461;
            font-size: 16px;
            padding: 12px 15px;
        }
        
        .login-input-group .form-control {
            border: none;
            padding: 12px 15px;
            font-size: 16px;
            color: #333;
            background: #fff;
        }
        
        .login-input-group .form-control:focus {
            box-shadow: none;
        }
        
        /* Tombol password toggle */
        .password-toggle-btn {
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .password-toggle-btn:hover {
            color: #0c2461;
            background: #e9ecef;
        }
        
        /* Tombol login dengan kontras yang lebih baik */
        .login-button {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-weight: 600;
            font-size: 16px;
            color: white;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(12, 36, 97, 0.2);
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(12, 36, 97, 0.3);
        }
        
        .login-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Checkbox remember me */
        .remember-me-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-check-input:checked {
            background-color: #0c2461;
            border-color: #0c2461;
        }
        
        .form-check-label {
            color: #555;
            font-size: 14px;
        }
        
        /* Link lupa password */
        .forgot-password-link {
            color: #0c2461;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .forgot-password-link:hover {
            color: #1e3799;
            text-decoration: underline;
        }
        
        /* Informasi tambahan */
        .login-info-text {
            text-align: center;
            color: #6c757d;
            font-size: 13px;
            margin-top: 20px;
            line-height: 1.5;
        }
        
        /* Tombol tambahan */
        .login-extra-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .login-extra-buttons .btn {
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* Footer login */
        .login-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 12px;
        }
        
        /* Animasi lingkaran background */
        .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            z-index: 1;
            opacity: 0.3;
        }
        
        .circles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            animation: animate 25s linear infinite;
            bottom: -150px;
        }
        
        .circles li:nth-child(1) {
            left: 25%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
        }
        
        .circles li:nth-child(2) {
            left: 10%;
            width: 20px;
            height: 20px;
            animation-delay: 2s;
            animation-duration: 12s;
        }
        
        .circles li:nth-child(3) {
            left: 70%;
            width: 20px;
            height: 20px;
            animation-delay: 4s;
        }
        
        .circles li:nth-child(4) {
            left: 40%;
            width: 60px;
            height: 60px;
            animation-delay: 0s;
            animation-duration: 18s;
        }
        
        .circles li:nth-child(5) {
            left: 65%;
            width: 20px;
            height: 20px;
            animation-delay: 0s;
        }
        
        .circles li:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3s;
        }
        
        .circles li:nth-child(7) {
            left: 35%;
            width: 150px;
            height: 150px;
            animation-delay: 7s;
        }
        
        .circles li:nth-child(8) {
            left: 50%;
            width: 25px;
            height: 25px;
            animation-delay: 15s;
            animation-duration: 45s;
        }
        
        .circles li:nth-child(9) {
            left: 20%;
            width: 15px;
            height: 15px;
            animation-delay: 2s;
            animation-duration: 35s;
        }
        
        .circles li:nth-child(10) {
            left: 85%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 11s;
        }
        
        @keyframes animate {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Alert error untuk login */
        .login-error-alert {
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
            border: 1px solid #f8d7da;
        }
        
        /* Media queries untuk responsif */
        @media (max-width: 576px) {
            .login-card {
                margin: 10px;
                max-width: 95%;
            }
            
            .login-form-container {
                padding: 20px;
            }
            
            .simata-title {
                font-size: 22px;
            }
            
            .simata-icon-box {
                width: 70px;
                height: 70px;
            }
        }
        
        /* Tombol informasi jenis ikan */
        .fish-info-btn {
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .fish-info-btn:hover {
            background-color: #0b5ed7;
            transform: scale(1.1);
        }

        /* Tombol informasi jenis kapal */
        .boat-info-btn {
            background-color: #198754;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .boat-info-btn:hover {
            background-color: #157347;
            transform: scale(1.1);
        }

        /* Modal gambar ikan - DIPERBAIKI */
        .fish-modal-img {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 15px auto;
        }
        
        /* Modal gambar kapal */
        .boat-modal-img {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 15px auto;
        }
        
        /* Container untuk gambar ikan */
        .fish-image-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Container untuk gambar kapal */
        .boat-image-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .fish-image-title {
            font-size: 16px;
            font-weight: 600;
            color: #0c2461;
            margin-bottom: 8px;
            text-align: left;
        }
        
        .boat-image-title {
            font-size: 16px;
            font-weight: 600;
            color: #0c2461;
            margin-bottom: 8px;
            text-align: left;
        }
        
        .fish-image-caption {
            font-size: 14px;
            color: #6c757d;
            text-align: left;
            font-style: italic;
        }
        
        .boat-image-caption {
            font-size: 14px;
            color: #6c757d;
            text-align: left;
            font-style: italic;
        }
        
        /* Loading untuk gambar */
        .fish-image-loading {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .boat-image-loading {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Perbaikan untuk backdrop modal */
        .modal-backdrop {
            z-index: 1040;
        }
        
        .modal {
            z-index: 1050;
        }
        
        /* Perbaikan untuk modal fishInfoModal dan boatInfoModal */
        #fishInfoModal .modal-content,
        #boatInfoModal .modal-content {
            z-index: 1060;
        }
    </style>
    
    <!-- LOAD SEMUA JAVASCRIPT LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- LOAD FILE JAVASCRIPT YANG DIPISAHKAN -->
    <script src="idcard.js" onerror="console.log('File idcard.js tidak ditemukan, menggunakan versi di main.js')"></script>
    <script src="reload.js" onerror="console.log('File reload.js belum tersedia di server, menggunakan database lokal.')"></script>
    <script src="convert.js"></script>
    <script src="main.js" defer></script>
    
    <!-- Skrip untuk mengelola modal gambar ikan dan kapal - DIPERBAIKI -->
    <script>
        // Fungsi untuk menampilkan modal info ikan
        function showFishInfoModal() {
            try {
                // Hapus backdrop yang mungkin tertinggal
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Hapus kelas modal-open dari body jika ada
                document.body.classList.remove('modal-open');
                
                const fishModal = new bootstrap.Modal(document.getElementById('fishInfoModal'), {
                    backdrop: true,
                    keyboard: true
                });
                fishModal.show();
                
                // Preload gambar untuk memastikan dapat dimuat
                preloadFishImages();
            } catch (error) {
                console.error('Gagal membuka modal info ikan:', error);
                alert('Modal informasi ikan tidak dapat dibuka. Silakan coba lagi.');
            }
        }
        
        // Fungsi untuk menampilkan modal info kapal
        function showBoatInfoModal() {
            try {
                // Hapus backdrop yang mungkin tertinggal
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Hapus kelas modal-open dari body jika ada
                document.body.classList.remove('modal-open');
                
                const boatModal = new bootstrap.Modal(document.getElementById('boatInfoModal'), {
                    backdrop: true,
                    keyboard: true
                });
                boatModal.show();
                
                // Preload gambar untuk memastikan dapat dimuat
                preloadBoatImages();
            } catch (error) {
                console.error('Gagal membuka modal info kapal:', error);
                alert('Modal informasi kapal tidak dapat dibuka. Silakan coba lagi.');
            }
        }
        
        // Fungsi untuk memuat gambar ikan secara asinkron
        function preloadFishImages() {
            const imageUrls = [
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-1.jpg',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-2.jpg',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/info-jenis-ikan-tangkapan-3.jpg'
            ];
            
            imageUrls.forEach((url, index) => {
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    console.log(`Gambar ikan ${index + 1} berhasil dimuat`);
                };
                img.onerror = function() {
                    console.error(`Gagal memuat gambar ikan ${index + 1}: ${url}`);
                    // Tampilkan placeholder jika gambar gagal dimuat
                    const imgElement = document.getElementById(`fishImage${index + 1}`);
                    if (imgElement) {
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23f8f9fa"/><text x="200" y="150" text-anchor="middle" font-family="Arial" font-size="16" fill="%236c757d">Gambar tidak tersedia</text></svg>';
                        imgElement.alt = `Gambar referensi ikan ${index + 1} tidak tersedia`;
                    }
                };
            });
        }
        
        // Fungsi untuk memuat gambar kapal secara asinkron
        function preloadBoatImages() {
            const imageUrls = [
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-1.png',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-2.png',
                'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simpadan/hasil-tangkapan/jenis-perahu-3.png'
            ];
            
            imageUrls.forEach((url, index) => {
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    console.log(`Gambar kapal ${index + 1} berhasil dimuat`);
                };
                img.onerror = function() {
                    console.error(`Gagal memuat gambar kapal ${index + 1}: ${url}`);
                    // Tampilkan placeholder jika gambar gagal dimuat
                    const imgElement = document.getElementById(`boatImage${index + 1}`);
                    if (imgElement) {
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23f8f9fa"/><text x="200" y="150" text-anchor="middle" font-family="Arial" font-size="16" fill="%236c757d">Gambar tidak tersedia</text></svg>';
                        imgElement.alt = `Gambar referensi kapal ${index + 1} tidak tersedia`;
                    }
                };
            });
        }
        
        // Fungsi untuk menampilkan gambar spesifik di modal
        function showSpecificFishImage(imageNumber) {
            showFishInfoModal();
            // Jika perlu scroll ke gambar tertentu
            setTimeout(() => {
                const imageElement = document.getElementById(`fishImage${imageNumber}`);
                if (imageElement) {
                    imageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }
        
        // Fungsi untuk menampilkan gambar spesifik di modal kapal
        function showSpecificBoatImage(imageNumber) {
            showBoatInfoModal();
            // Jika perlu scroll ke gambar tertentu
            setTimeout(() => {
                const imageElement = document.getElementById(`boatImage${imageNumber}`);
                if (imageElement) {
                    imageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }
        
        // Fungsi untuk menutup modal ikan dengan aman - DITAMBAHKAN
        function closeFishInfoModalSafely() {
            try {
                const modalElement = document.getElementById('fishInfoModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Hapus backdrop setelah modal ditutup
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // Hapus kelas modal-open dari body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 300);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }
        
        // Fungsi untuk menutup modal kapal dengan aman - DITAMBAHKAN
        function closeBoatInfoModalSafely() {
            try {
                const modalElement = document.getElementById('boatInfoModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Hapus backdrop setelah modal ditutup
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // Hapus kelas modal-open dari body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 300);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }
        
        // Fungsi untuk kembali ke input data nelayan - DIPERBAIKI
        function goToInputDataAfterModal() {
            // Tutup modal dengan aman terlebih dahulu
            closeFishInfoModalSafely();
            closeBoatInfoModalSafely();
            
            // Tunggu sebentar untuk memastikan modal benar-benar tertutup
            setTimeout(() => {
                try {
                    // Klik tab input data
                    const inputTab = document.getElementById('v-pills-input-tab');
                    if (inputTab) {
                        inputTab.click();
                        
                        // Scroll ke atas halaman
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                        
                        // Fokus ke form input
                        const namaInput = document.getElementById('nama');
                        if (namaInput) {
                            setTimeout(() => {
                                namaInput.focus();
                            }, 100);
                        }
                    }
                } catch (error) {
                    console.error('Error navigating to input tab:', error);
                }
            }, 400);
        }
        
        // Fungsi untuk login dengan username dan password
        function loginWithUsernamePassword(username, password) {
            // Kredensial default
            const defaultUsername = "admin";
            const defaultPassword = "admin123";
            
            // Ambil kredensial dari localStorage jika ada
            const savedUsername = localStorage.getItem('simpadan_username') || defaultUsername;
            const savedPassword = localStorage.getItem('simpadan_password') || defaultPassword;
            
            // Validasi login
            if (username === savedUsername && password === savedPassword) {
                return true;
            }
            
            return false;
        }
        
        // Fungsi untuk setup login system - DIPERBAIKI
        function setupLoginSystem() {
            // Cek jika sudah login
            if (localStorage.getItem('simpadan_logged_in') === 'true') {
                // Otomatis login jika sudah pernah login
                setTimeout(() => {
                    showLoginSuccessModal();
                }, 500);
                return;
            }
            
            // Setup form login
            const loginForm = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('passwordToggle');
            const loginButton = document.getElementById('loginButton');
            const loginSpinner = document.getElementById('loginSpinner');
            
            // Toggle password visibility
            if (passwordToggle) {
                passwordToggle.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                    }
                });
            }
            
            // Handle form submission
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = usernameInput.value.trim();
                    const password = passwordInput.value.trim();
                    
                    // Validasi input
                    if (!username || !password) {
                        showLoginError('Username dan password harus diisi');
                        return;
                    }
                    
                    // Tampilkan loading
                    loginButton.disabled = true;
                    if (loginSpinner) loginSpinner.classList.remove('d-none');
                    
                    // Simulasi proses login
                    setTimeout(() => {
                        if (loginWithUsernamePassword(username, password)) {
                            // Simpan status login
                            localStorage.setItem('simpadan_logged_in', 'true');
                            
                            // Simpan username jika "Ingat saya" dicentang
                            const rememberMe = document.getElementById('rememberMe');
                            if (rememberMe && rememberMe.checked) {
                                localStorage.setItem('simpadan_remembered_username', username);
                            } else {
                                localStorage.removeItem('simpadan_remembered_username');
                            }
                            
                            // Tampilkan modal sukses
                            showLoginSuccessModal();
                        } else {
                            showLoginError('Username atau password salah');
                            loginButton.disabled = false;
                            if (loginSpinner) loginSpinner.classList.add('d-none');
                        }
                    }, 1000);
                });
            }
            
            // Isi username jika diingat
            const rememberedUsername = localStorage.getItem('simpadan_remembered_username');
            if (rememberedUsername && usernameInput) {
                usernameInput.value = rememberedUsername;
                const rememberMeCheckbox = document.getElementById('rememberMe');
                if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
            }
            
            // Tampilkan tanggal saat ini
            const dateDisplay = document.getElementById('currentDateDisplay');
            if (dateDisplay) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateDisplay.textContent = now.toLocaleDateString('id-ID', options);
            }
            
            // Fokus ke input username
            setTimeout(() => {
                if (usernameInput) usernameInput.focus();
            }, 300);
        }
        
        function showLoginError(message) {
            // Hapus alert error yang sudah ada
            const existingAlert = document.querySelector('.login-error-alert');
            if (existingAlert) existingAlert.remove();
            
            // Buat elemen alert baru
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger login-error-alert';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>
                        <strong class="d-block">Login Gagal!</strong>
                        <span class="small">${message}</span>
                    </div>
                </div>
            `;
            
            // Sisipkan alert setelah form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.appendChild(alertDiv);
                
                // Auto hide setelah 5 detik
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (alertDiv.parentNode) alertDiv.remove();
                    }, 500);
                }, 5000);
            }
        }
        
        function showLoginSuccessModal() {
            // Sembunyikan modal login
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
            
            // Tampilkan modal sukses
            const loginSuccessModal = new bootstrap.Modal(document.getElementById('loginSuccessModal'), {
                backdrop: 'static',
                keyboard: false
            });
            loginSuccessModal.show();
            
            // Setup tombol lanjut
            const continueBtn = document.getElementById('btnContinueDashboard');
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    loginSuccessModal.hide();
                    document.getElementById('appContent').style.display = 'block';
                    initAppAfterLogin();
                });
            }
        }
        
        function initAppAfterLogin() {
            // Inisialisasi aplikasi setelah login berhasil
            console.log('Aplikasi diinisialisasi setelah login');
            
            // Muat data awal
            if (typeof loadInitialData === 'function') {
                loadInitialData();
            }
            
            // Setup event listeners lainnya
            setupAppEventListeners();
        }
        
        function setupAppEventListeners() {
            // Setup tombol logout
            const logoutBtn = document.getElementById('v-pills-logout-tab');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
                        localStorage.removeItem('simpadan_logged_in');
                        window.location.reload();
                    }
                });
            }
        }
        
        // Inisialisasi saat DOM siap
        document.addEventListener('DOMContentLoaded', function() {
            setupLoginSystem();
            
            // Setup tombol lupa password
            const forgotPasswordLink = document.querySelector('.forgot-password-link');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Untuk reset password, silakan hubungi administrator sistem di 0878-6561-4222');
                });
            }
            
            // Setup tombol tambahan
            setupAdditionalButtons();
        });
        
        function setupAdditionalButtons() {
            // Tombol panduan aplikasi
            const guideBtn = document.querySelector('.login-extra-buttons .btn-outline-primary');
            if (guideBtn) {
                guideBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open('https://drive.google.com/drive/folders/1zmLnQ8bXFEL682BXzA2pV6WsQq7p4wdo?usp=sharing', '_blank');
                });
            }
            
            // Tombol lihat peta
            const mapBtn = document.querySelector('.login-extra-buttons .btn-outline-success');
            if (mapBtn) {
                mapBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open('http://www.dinasperikanansitubondo.com/simpadan/peta', '_blank');
                });
            }
        }
    </script>
</head>
<body>

    <!-- Modal Loading -->
    <div class="loading-modal-overlay" id="loadingModal" style="display: none;">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <h3 class="loading-title" id="loadingTitle">Memproses Data</h3>
            <p class="loading-message" id="loadingMessage">Mohon tunggu, sistem sedang memproses permintaan Anda. Proses ini mungkin memerlukan waktu beberapa saat tergantung jumlah data yang tersedia.</p>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <div id="qr-code-generator">
        <div id="qr-right"></div> 
    </div>
    
    <!-- Container untuk tabel PDF (hidden) -->
    <div class="pdf-table-container" id="pdfTableContainer"></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Modal Login Baru dengan Username dan Password - DIPERBAIKI -->
    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMPADAN TANGKAP" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-fish fa-2x text-primary\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMPADAN TANGKAP</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            
            <div class="login-form-container">
                <form id="loginForm">
                    <div class="login-input-group">
                        <label for="username" class="login-form-label">Username</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user text-primary"></i></span>
                            <input type="text" class="form-control" id="username" placeholder="Masukkan username" required autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="login-input-group">
                        <label for="password" class="login-form-label">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control" id="password" placeholder="Masukkan password" required autocomplete="off">
                            <button type="button" class="input-group-text password-toggle-btn" id="passwordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="remember-me-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Ingat username</label>
                        </div>
                        <a href="#" class="forgot-password-link">Lupa password?</a>
                    </div>
                    
                    <button type="submit" class="login-button" id="loginButton">
                        MASUK KE DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                    
                    <div class="login-info-text">
                        <p class="mb-1">Gunakan username dan password yang telah diberikan</p>
                        <p class="mb-0" id="currentDateDisplay"></p>
                    </div>
                </form>
                
                <!-- TOMBOL TAMBAHAN BARU -->
                <div class="login-extra-buttons">
                    <button type="button" class="btn btn-outline-primary" id="guideBtn">
                        <i class="fas fa-download me-2"></i>Panduan Aplikasi
                    </button>
                    <button type="button" class="btn btn-outline-success" id="mapBtn">
                        <i class="fas fa-map me-2"></i>Lihat Peta
                    </button>
                </div>
                
                <div class="login-footer">
                    <small>&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notifikasi Login Berhasil -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="w-100 d-flex flex-column align-items-center justify-content-center">
                        <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                        <h4 class="fw-bold mb-0 text-center">Akses Diotorisasi</h4>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon d-flex justify-content-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMPADAN TANGKAP</h5>
                    
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-4 text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Sistem ini menggunakan teknologi keamanan dinamis untuk melindungi data sensitif
                    </p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Data Wilayah - DIREVISI DENGAN TAB DESA DAN KECAMATAN -->
    <div class="modal fade" id="modalDataWilayah" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="wilayah-modal-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="modal-title fw-bold mb-1"><i class="fas fa-map-marked-alt me-2"></i> Data Wilayah</h5>
                            <p class="mb-0 opacity-75">Kelola data berdasarkan wilayah administratif</p>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div class="wilayah-search-box px-4">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Pilih desa atau kecamatan untuk memuat data nelayan dari wilayah tersebut. Anda juga dapat langsung input data untuk wilayah yang dipilih.
                        </div>
                        
                        <div class="row align-items-center mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchWilayah" placeholder="Cari nama desa atau kecamatan...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end align-items-center gap-3">
                                    <div class="wilayah-status-indicator" id="wilayahStatusIndicator">
                                        <i class="fas fa-globe"></i>
                                        <span>Mode Global</span>
                                    </div>
                                    <button class="btn btn-warning" id="btnInputGlobalModal">
                                        <i class="fas fa-globe me-2"></i> Switch ke Global
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TABS NAVIGASI UNTUK DESA DAN KECAMATAN -->
                    <div class="wilayah-tabs-container px-4">
                        <ul class="nav nav-tabs wilayah-tabs" id="wilayahTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="desa-tab" data-bs-toggle="tab" data-bs-target="#desa-panel" type="button" role="tab">
                                    <i class="fas fa-village me-2"></i> Data Desa
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="kecamatan-tab" data-bs-toggle="tab" data-bs-target="#kecamatan-panel" type="button" role="tab">
                                    <i class="fas fa-map me-2"></i> Data Kecamatan
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="tab-content px-4 pb-4">
                        <!-- PANEL DESA -->
                        <div class="tab-pane fade show active" id="desa-panel" role="tabpanel">
                            <div class="wilayah-global-card mb-4">
                                <div class="icon">
                                    <i class="fas fa-globe-americas"></i>
                                </div>
                                <h5 class="fw-bold">Mode Global</h5>
                                <p class="text-muted mb-3">Akses dan kelola semua data nelayan tanpa batasan wilayah</p>
                                <button class="btn btn-warning px-4" id="btnGlobalMode">
                                    <i class="fas fa-database me-2"></i> Aktifkan Mode Global
                                </button>
                            </div>
                            
                            <h6 class="fw-bold mb-3">Daftar Desa / Kelurahan</h6>
                            
                            <!-- KONTAINER KARTU DESA -->
                            <div class="wilayah-grid" id="wilayahDesaCardsContainer">
                                <!-- Kartu desa akan dimuat di sini oleh JavaScript -->
                            </div>
                            
                            <!-- STATE KOSONG UNTUK DESA -->
                            <div class="wilayah-empty-state d-none" id="wilayahDesaEmptyState">
                                <i class="fas fa-search"></i>
                                <h5 class="text-muted">Desa tidak ditemukan</h5>
                                <p class="text-muted">Coba gunakan kata kunci pencarian yang berbeda</p>
                            </div>
                        </div>
                        
                        <!-- PANEL KECAMATAN -->
                        <div class="tab-pane fade" id="kecamatan-panel" role="tabpanel">
                            <div class="wilayah-global-card mb-4">
                                <div class="icon">
                                    <i class="fas fa-globe-americas"></i>
                                </div>
                                <h5 class="fw-bold">Mode Global</h5>
                                <p class="text-muted mb-3">Akses dan kelola semua data nelayan tanpa batasan wilayah</p>
                                <button class="btn btn-warning px-4" id="btnGlobalModeKecamatan">
                                    <i class="fas fa-database me-2"></i> Aktifkan Mode Global
                                </button>
                            </div>
                            
                            <h6 class="fw-bold mb-3">Daftar Kecamatan</h6>
                            
                            <!-- KONTAINER KARTU KECAMATAN -->
                            <div class="wilayah-grid" id="wilayahKecamatanCardsContainer">
                                <!-- Kartu kecamatan akan dimuat di sini oleh JavaScript -->
                            </div>
                            
                            <!-- STATE KOSONG UNTUK KECAMATAN -->
                            <div class="wilayah-empty-state d-none" id="wilayahKecamatanEmptyState">
                                <i class="fas fa-search"></i>
                                <h5 class="text-muted">Kecamatan tidak ditemukan</h5>
                                <p class="text-muted">Coba gunakan kata kunci pencarian yang berbeda</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top py-3">
                    <div class="d-flex justify-content-between w-100">
                        <div class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            <span id="totalDesaCount">0</span> desa dan <span id="totalKecamatanCount">0</span> kecamatan tersedia
                        </div>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-data-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <!-- Konten aplikasi utama tetap sama seperti sebelumnya -->
        <!-- ... -->
    </div>

    <!-- Script tambahan untuk login yang diperbaiki -->
    <script>
        // Event listener untuk tombol panduan dan peta di login
        document.addEventListener('DOMContentLoaded', function() {
            // Setup tombol panduan aplikasi di login
            const guideBtn = document.getElementById('guideBtn');
            if (guideBtn) {
                guideBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open('https://drive.google.com/drive/folders/1zmLnQ8bXFEL682BXzA2pV6WsQq7p4wdo?usp=sharing', '_blank');
                });
            }
            
            // Setup tombol lihat peta di login
            const mapBtn = document.getElementById('mapBtn');
            if (mapBtn) {
                mapBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open('http://www.dinasperikanansitubondo.com/simpadan/peta', '_blank');
                });
            }
            
            // Tambahkan placeholder untuk gambar jika gagal dimuat
            const loginLogo = document.querySelector('.simata-icon-box img');
            if (loginLogo) {
                loginLogo.onerror = function() {
                    this.style.display = 'none';
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-fish fa-3x text-primary';
                    this.parentNode.appendChild(icon);
                };
            }
        });
    </script>

</body>
</html>
