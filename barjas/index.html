[file name]: index.html
[file content begin]
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM BANTUAN NELAYAN - KAB. SITUBONDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Palette: Luxurious Green, Blue, Orange */
            --primary-color: #005f73; /* Deep Teal Blue */
            --secondary-color: #0a9396; /* Emerald Green */
            --accent-color: #ca6702; /* Burnt Orange/Gold */
            
            --dark-blue: #001219;
            --light-bg: #f0f4f8;
            
            /* Luxurious Gradients */
            --gradient-primary: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            --gradient-header: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            --gradient-secondary: linear-gradient(135deg, #0a9396, #94d2bd);
            --gradient-accent: linear-gradient(135deg, #ca6702, #ee9b00);
            
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.15);
            
            --glass-effect: rgba(255, 255, 255, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Header - New Luxurious Style */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 35px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #ee9b00; /* Gold Line */
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .app-logo {
            font-size: 3.5rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: #ffecd1; /* Soft Cream */
            border-top: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
            padding-top: 10px;
        }
        
        /* Navigation */
        .col-md-3.col-lg-2.bg-light {
            background-color: #f8f9fa !important;
            border-right: 1px solid #e9ecef;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 14px 20px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #e3f2fd;
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-left: 4px solid #ee9b00;
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
            color: white;
        }

        /* Content Styling */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid #ee9b00;
            padding-left: 15px;
            margin: 25px 0;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 1.6rem;
            position: relative;
            background: linear-gradient(to right, rgba(238, 155, 0, 0.1), transparent);
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            padding: 10px 20px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 95, 115, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #001219 0%, #004d40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 95, 115, 0.4);
        }
        
        .btn-success {
            background: var(--gradient-secondary);
            border: none;
        }
        
        .btn-warning {
            background: var(--gradient-accent);
            color: white;
            border: none;
        }

        /* Forms */
        .form-label {
            font-weight: 600;
            color: #2b2d42;
            font-size: 0.9rem;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            font-size: 0.95rem;
            background-color: #fdfdfd;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(10, 147, 150, 0.2);
            background-color: white;
        }
        
        /* Tables */
        .data-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: none;
            white-space: nowrap;
        }
        
        .data-table th {
            background: var(--primary-color) !important; 
            background: linear-gradient(90deg, #005f73, #0a9396) !important;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
        }
        
        .data-table td {
            border-bottom: 1px solid #e9ecef;
            padding: 12px 10px;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: #e0f2f1;
        }
        
        /* Cards & Stats */
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-sm);
            background: white;
        }
        
        .card-header {
            background: linear-gradient(90deg, #005f73, #001219);
            color: white;
            font-weight: 600;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        
        .stats-box {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border-left: 5px solid var(--accent-color);
            transition: transform 0.3s;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Login Modal - Luxurious */
        .login-header {
            background: var(--gradient-header);
            border-bottom: 4px solid #ee9b00;
            padding-bottom: 20px;
            padding-top: 20px;
        }
        
        .login-header .fa-ship {
            padding: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .btn-login {
            background: linear-gradient(90deg, #005f73, #0a9396, #ee9b00);
            background-size: 200% auto;
            transition: 0.5s;
        }
        
        .btn-login:hover {
            background-position: right center;
        }

        /* Footer */
        .copyright {
            background-color: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }
        
        .feature-icon {
            width: 25px;
            text-align: center;
        }

        /* Utils */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1050; min-width: 280px; }
        .input-error { border-color: #dc3545 !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important; }
        .error-message { color: #dc3545; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: 500; }
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.8; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-weight: 300; letter-spacing: 1px;}
        
        /* Floating Buttons & Smart Menu */
        @keyframes signal-pulse {
            0% { box-shadow: 0 0 0 0 rgba(238, 155, 0, 0.7), 0 0 0 0 rgba(10, 147, 150, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(238, 155, 0, 0), 0 0 0 30px rgba(10, 147, 150, 0); }
            100% { box-shadow: 0 0 0 0 rgba(238, 155, 0, 0), 0 0 0 0 rgba(10, 147, 150, 0); }
        }

        .fab-common {
            position: fixed;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 1045;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.4rem;
            border: none;
        }

        .floating-action-btn {
            bottom: 25px;
            background: var(--gradient-accent);
            animation: signal-pulse 2.5s infinite;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1) rotate(90deg);
            background: #ee9b00;
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.4);
        }

        .smart-menu-container {
            position: fixed;
            bottom: 100px;
            right: 25px;
            z-index: 1045;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 15px;
        }

        .smart-menu-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
             box-shadow: 0 5px 15px rgba(0, 95, 115, 0.4);
        }

        .smart-menu-toggle:hover {
            transform: scale(1.1);
            background: #0a9396;
        }

        .smart-menu-toggle.active {
            transform: rotate(45deg);
            background: #dc3545;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
        }

        .smart-menu-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            opacity: 0;
            transform: translateY(20px) scale(0.5);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .smart-menu-container.active .smart-menu-item {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .smart-menu-item:hover {
            background: var(--primary-color);
            color: white;
            border-color: white;
            transform: scale(1.1);
        }

        .smart-menu-tooltip {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%) translateX(20px);
            background: rgba(0, 18, 25, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            visibility: hidden;
        }

        .smart-menu-item:hover .smart-menu-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0);
        }

        .smart-menu-container.active .smart-menu-item:nth-child(2) { transition-delay: 0.05s; }
        .smart-menu-container.active .smart-menu-item:nth-child(3) { transition-delay: 0.1s; }
        .smart-menu-container.active .smart-menu-item:nth-child(4) { transition-delay: 0.15s; }
        .smart-menu-container.active .smart-menu-item:nth-child(5) { transition-delay: 0.2s; }
        .smart-menu-container.active .smart-menu-item:nth-child(6) { transition-delay: 0.25s; }
        .smart-menu-container.active .smart-menu-item:nth-child(7) { transition-delay: 0.3s; }
        .smart-menu-container.active .smart-menu-item:nth-child(8) { transition-delay: 0.35s; }
        .smart-menu-container.active .smart-menu-item:nth-child(9) { transition-delay: 0.4s; }
        .smart-menu-container.active .smart-menu-item:nth-child(10) { transition-delay: 0.45s; }
        
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1050; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; box-shadow: var(--shadow-lg); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
        
        .privacy-blurred {
            color: #6c757d;
            letter-spacing: 2px;
            font-weight: bold;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; }
            .col-md-3.col-lg-2 { position: fixed; left: -300px; top: 0; bottom: 0; z-index: 1050; width: 280px; transition: left 0.3s ease; overflow-y: auto; padding-top: 60px; background: white; }
            .col-md-3.col-lg-2.mobile-show { left: 0; }
            .col-md-9.col-lg-10 { width: 100%; flex: 0 0 100%; max-width: 100%; }
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar-overlay.mobile-show { display: block; }
            .app-title { font-size: 1.1rem; line-height: 1.2; }
            .app-logo { font-size: 2rem; margin-bottom: 5px; }
            .app-header { padding: 60px 15px 25px 15px; }
            .col-md-9.col-lg-10.p-5 { padding: 1.5rem !important; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .smart-menu-container { bottom: 100px; right: 20px; }
            .floating-action-btn { bottom: 20px; right: 20px; }
        }

        @media print {
            @page { size: landscape; margin: 0.5cm; }
            body * { visibility: hidden; }
            .app-container, .app-container * { visibility: visible; }
            .app-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .nav-pills, .mobile-menu-btn, .sidebar-overlay, .floating-action-btn, .smart-menu-container, .btn-group, .filter-section, .toast, .col-md-3.col-lg-2 { display: none !important; }
            .col-md-9.col-lg-10 { width: 100%; flex: 0 0 100%; max-width: 100%; padding: 0 !important; }
            .data-table th:last-child, .data-table td:last-child { display: none !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 15px; }
        }

        .whatsapp-link { color: #25D366; text-decoration: none; }
        .whatsapp-number { color: #25D366; cursor: pointer; text-decoration: underline; font-weight: 500;}
        .drive-link { color: var(--primary-color); font-weight: 600; text-decoration: none; }
        .login-shake { animation: login-shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes login-shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        .spinner-border-sm { width: 1rem; height: 1rem; }
        #login-particles { display: none; }
        .app-content-unauthenticated { display: none; }
        .btn-not-group { background: #6c757d; color: white; border: none; }
        .whatsapp-input-container { position: relative; }
        .whatsapp-prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-weight: 500; }
        .whatsapp-input { padding-left: 45px !important; }
        .preview-container { max-height: 70vh; overflow-y: auto; padding: 15px; background-color: #f9f9f9; }
        .preview-table { width: 100%; border-collapse: collapse; }
        .preview-table th, .preview-table td { padding: 8px; border: 1px solid #ddd; }
        .preview-table th { background-color: #f0f0f0; }
        
        /* New Info Style */
        .info-pill {
            background: rgba(0, 95, 115, 0.05);
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        /* Modal Detail Data */
        .detail-modal-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .detail-modal-value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .detail-col {
            flex: 1;
            padding: 0 10px;
        }

        /* Welcome Modal */
        .welcome-modal {
            background: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            color: white;
        }
        
        .welcome-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ee9b00;
        }
        
        .welcome-modal .btn-welcome {
            background: linear-gradient(90deg, #ee9b00, #ca6702);
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .welcome-modal .btn-welcome:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.3);
        }

        /* Logo Garuda */
        .logo-garuda {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .logo-garuda-sm {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        /* Filter Container */
        .filter-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--secondary-color);
        }

        /* Ekstrak Data Styles */
        .extract-security-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
        }

        .extract-preview {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Peta Preview */
        .peta-preview-map {
            height: 300px;
            width: 100%;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            margin-bottom: 15px;
        }
        
        .koordinat-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="modal fade login-modal" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: none;">
                <div class="login-header">
                    <div class="text-center mb-2">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                             alt="Logo Garuda" class="logo-garuda">
                    </div>
                    <h2 class="text-center text-white fw-bold mb-0" style="font-family: 'Montserrat'; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">AUTHENTICATION</h2>
                    <p class="text-center text-white-50 mb-0 small">Sistem Bantuan Nelayan Kab. Situbondo</p>
                </div>
                <div class="login-body p-4">
                    <form id="loginForm">
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-key me-2 text-primary"></i> Kode Keamanan
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="securityCode" placeholder="Masukkan kode akses..." style="padding: 12px;">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text text-danger mt-2 fw-bold text-center" id="attemptsCount" style="display:none;"></div>
                            
                            <div class="info-pill mt-4">
                                <div class="small text-uppercase fw-bold text-primary mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">
                                    <i class="fas fa-shield-alt me-1"></i> System Information
                                </div>
                                <div class="fw-bold text-dark" style="font-size: 0.9rem;">
                                    BIDANG PEMBERDAYAAN NELAYAN
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-login text-white w-100 py-3 fw-bold shadow-sm" id="loginButton">
                                    <span class="login-button-text">MASUK SISTEM</span>
                                    <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="login-blocked-message d-none mt-3 p-3 rounded bg-danger bg-opacity-10 text-danger text-center" id="blockedMessage">
                            <i class="fas fa-ban me-2"></i>
                            <span id="blockedText">Akses diblokir sementara karena terlalu banyak percobaan. </span>
                            <span class="fw-bold" id="countdown">30</span> detik.
                        </div>
                        
                        <div class="text-center mt-4 small text-muted">
                            &copy; 2025 Dinas Peternakan dan Perikanan
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda mb-4">
                    <h3 class="fw-bold mb-3">Selamat Datang!</h3>
                    <p id="welcomeMessage">Selamat datang di Sistem Bantuan Nelayan Kabupaten Situbondo.</p>
                    
                    <div class="alert alert-warning mt-4" id="reloadAlert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Penting:</strong> Sebaiknya lakukan reload data terlebih dahulu untuk memastikan data terkini.
                    </div>
                    
                    <button type="button" class="btn btn-welcome w-100" id="welcomeReloadBtn">
                        <i class="fas fa-sync-alt me-2"></i> RELOAD DATA SEKARANG
                    </button>
                    
                    <button type="button" class="btn btn-outline-light w-100 mt-3" id="skipReloadBtn">
                        <i class="fas fa-forward me-2"></i> LEWATI DAN LANJUTKAN
                    </button>
                    
                    <div class="mt-4 small text-white-50">
                        <i class="fas fa-info-circle me-1"></i>
                        Tekan tombol di atas untuk memulai
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content-unauthenticated" id="appContent">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda">
                </div>
                <h1 class="app-title">SISTEM APLIKASI BANTUAN BARANG PINJAM PAKAI<br>BIDANG PEMBERDAYAAN NELAYAN</h1>
                <p class="app-subtitle">Dinas Peternakan dan Perikanan Kabupaten Situbondo</p>
                <div class="watermark">Professional Edition v2.2</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-4 bg-light" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button" role="tab">
                            <i class="fas fa-tachometer-alt feature-icon"></i> Dashboard
                        </button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button" role="tab">
                            <i class="fas fa-pencil-alt feature-icon"></i> Input Data
                        </button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button" role="tab">
                            <i class="fas fa-database feature-icon"></i> Data Bantuan
                        </button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button" role="tab">
                            <i class="fas fa-filter feature-icon"></i> Filter Data
                        </button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button" role="tab">
                            <i class="fas fa-print feature-icon"></i> Cetak Laporan
                        </button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button" role="tab">
                            <i class="fas fa-file-export feature-icon"></i> Ekspor Data
                        </button>
                        <!-- MENU BARU: Ekstrak Data -->
                        <button class="nav-link" id="v-pills-extract-tab" data-bs-toggle="pill" data-bs-target="#v-pills-extract" type="button" role="tab">
                            <i class="fas fa-map-marked-alt feature-icon"></i> Ekstrak Data
                        </button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button" role="tab">
                            <i class="fas fa-download feature-icon"></i> Backup & Restore
                        </button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button" role="tab">
                            <i class="fas fa-cog feature-icon"></i> Pengaturan
                        </button>
                        <button class="nav-link" id="btn-reload-repo" type="button">
                            <i class="fas fa-sync-alt feature-icon"></i> Reload Data
                        </button>
                        <button class="nav-link text-danger mt-3" id="v-pills-logout-tab" type="button" style="border: 1px solid #dc3545;">
                            <i class="fas fa-sign-out-alt feature-icon"></i> Keluar
                        </button>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-5">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                            <h3 class="section-title">Dashboard Overview</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Penerima</div>
                                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold" id="totalPenerima">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: var(--secondary-color);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Bantuan (Rp)</div>
                                            <i class="fas fa-money-bill-wave fa-2x text-success opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-success" id="totalBantuan">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #ffc107;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Tahun Aktif</div>
                                            <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-warning" id="tahunAktif">2025</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #17a2b8;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Rata-rata</div>
                                            <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-info" id="rataBantuan">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Distribusi per Kecamatan</div>
                                        <div class="card-body"><canvas id="kecamatanChart" height="250"></canvas></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Tren Bantuan Tahunan</div>
                                        <div class="card-body"><canvas id="tahunChart" height="250"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-history me-2"></i> Transaksi Terbaru</div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover data-table mb-0">
                                                    <thead><tr><th>Tanggal</th><th>Nama Penerima</th><th>Desa</th><th>Jenis Bantuan</th><th>Jumlah</th></tr></thead>
                                                    <tbody id="recentData"><tr><td colspan="5" class="text-center p-4">Tidak ada data</td></tr></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-input" role="tabpanel">
                            <h3 class="section-title">Input Data Bantuan</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-pencil-alt me-2"></i> Formulir Input Data</div>
                                <div class="card-body p-4">
                                    <form id="inputForm" novalidate>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="nama" class="form-label"><i class="fas fa-user text-primary me-2"></i> Nama Penerima</label>
                                                <input type="text" class="form-control" id="nama" required>
                                                <div class="error-message" id="namaError">Nama penerima wajib diisi.</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="nik" class="form-label"><i class="fas fa-id-card text-primary me-2"></i> NIK</label>
                                                <input type="text" class="form-control" id="nik" required maxlength="16">
                                                <div class="error-message" id="nikError">NIK wajib diisi dan harus 16 digit angka.</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="whatsapp" class="form-label"><i class="fab fa-whatsapp text-success me-2"></i> Nomor WhatsApp</label>
                                                <div class="whatsapp-input-container">
                                                    <span class="whatsapp-prefix">+62</span>
                                                    <input type="tel" class="form-control whatsapp-input" id="whatsapp" placeholder="8xx-xxxx-xxxx" required>
                                                </div>
                                                <div class="error-message" id="whatsappError">Nomor WhatsApp wajib diisi.</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="namaKelompok" class="form-label"><i class="fas fa-users text-primary me-2"></i> Nama Kelompok</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="namaKelompok" placeholder="Opsional">
                                                    <button type="button" class="btn btn-not-group" id="btnBukanKelompok">Individu</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="jabatan" class="form-label"><i class="fas fa-user-tag text-primary me-2"></i> Jabatan</label>
                                                <select class="form-select" id="jabatan">
                                                    <option value="Individu" selected>Individu</option>
                                                    <option value="Ketua Kelompok">Ketua Kelompok</option>
                                                    <option value="Sekretaris">Sekretaris</option>
                                                    <option value="Bendahara">Bendahara</option>
                                                    <option value="Pengawas">Pengawas</option>
                                                    <option value="Anggota">Anggota</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="tahunAnggaran" class="form-label"><i class="fas fa-calendar text-primary me-2"></i> Tahun Anggaran</label>
                                                <select class="form-select" id="tahunAnggaran"></select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="kecamatan" class="form-label"><i class="fas fa-map-marker-alt text-primary me-2"></i> Kecamatan</label>
                                                <select class="form-select" id="kecamatan" required>
                                                    <option value="">Pilih Kecamatan</option>
                                                </select>
                                                <div class="error-message" id="kecamatanError">Kecamatan wajib dipilih.</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="desa" class="form-label"><i class="fas fa-map-marked-alt text-primary me-2"></i> Desa</label>
                                                <select class="form-select" id="desa" required>
                                                    <option value="">Pilih Desa</option>
                                                </select>
                                                <div class="error-message" id="desaError">Desa wajib dipilih.</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="alamat" class="form-label"><i class="fas fa-home text-primary me-2"></i> Alamat Lengkap</label>
                                                <textarea class="form-control" id="alamat" rows="1"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="jenisBantuan" class="form-label"><i class="fas fa-gift text-primary me-2"></i> Jenis Bantuan</label>
                                                <select class="form-select" id="jenisBantuan">
                                                    <option value="Uang">Uang</option>
                                                    <option value="Barang">Barang</option>
                                                    <option value="Jasa">Jasa</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="namaBantuan" class="form-label"><i class="fas fa-box-open text-primary me-2"></i> Nama Bantuan</label>
                                                <input type="text" class="form-control" id="namaBantuan" placeholder="Contoh: Mesin Perahu, Uang Tunai, Jaring" required>
                                                <div class="error-message" id="namaBantuanError">Nama bantuan wajib diisi.</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="jumlahBantuan" class="form-label"><i class="fas fa-coins text-primary me-2"></i> Jumlah Bantuan</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="jumlahBantuan" placeholder="Jumlah" required>
                                                    <select class="form-select" id="satuanBantuan" style="max-width: 120px;">
                                                        <option value="Rupiah">Rupiah</option>
                                                        <option value="Unit">Unit</option>
                                                        <option value="Paket">Paket</option>
                                                    </select>
                                                </div>
                                                <div class="error-message" id="jumlahBantuanError">Jumlah bantuan wajib diisi.</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="tanggalTerima" class="form-label"><i class="fas fa-calendar-check text-primary me-2"></i> Tanggal Menerima</label>
                                                <input type="date" class="form-control" id="tanggalTerima" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="namaPetugas" class="form-label"><i class="fas fa-user-tie text-primary me-2"></i> Nama Petugas</label>
                                                <input type="text" class="form-control" id="namaPetugas" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="driveLink" class="form-label"><i class="fab fa-google-drive text-primary me-2"></i> Link Google Drive</label>
                                                <input type="url" class="form-control" id="driveLink" placeholder="https://drive.google.com/...">
                                                <div class="error-message" id="driveLinkError">Format URL tidak valid.</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="kodeValidasi" class="form-label"><i class="fas fa-qrcode text-primary me-2"></i> Kode Validasi</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="kodeValidasi" placeholder="Klik Generate" readonly required>
                                                    <button type="button" class="btn btn-primary" id="generateKodeBtn">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="keterangan" class="form-label"><i class="fas fa-sticky-note text-primary me-2"></i> Keterangan</label>
                                            <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                                            <button type="reset" class="btn btn-light me-2 text-secondary">
                                                <i class="fas fa-undo me-1"></i> Reset
                                            </button>
                                            <button type="submit" class="btn btn-primary px-4">
                                                <i class="fas fa-save me-1"></i> Simpan Data
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data" role="tabpanel">
                            <h3 class="section-title">Database Bantuan</h3>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <span><i class="fas fa-database me-2"></i> Daftar Penerima</span>
                                    <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
                                        <select class="form-select form-select-sm" id="filterKecamatanData" style="width: auto;">
                                            <option value="">Semua Kecamatan</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="filterDesaData" style="width: auto;">
                                            <option value="">Semua Desa</option>
                                        </select>
                                        <div class="input-group" style="max-width: 300px;">
                                            <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari data...">
                                            <button class="btn btn-sm btn-light border" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>WhatsApp</th><th>Kelompok</th>
                                                    <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                                    <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th><th>Dokumen</th>
                                                    <th>Validasi</th><th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="17" class="text-center py-4">Memuat data...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-filter" role="tabpanel">
                            <h3 class="section-title">Filter Lanjutan</h3>
                            <div class="card mb-4">
                                <div class="card-header"><i class="fas fa-filter me-2"></i> Parameter Filter</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Tahun</label>
                                            <select class="form-select" id="filterTahun"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Kecamatan</label>
                                            <select class="form-select" id="filterKecamatan"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Desa</label>
                                            <select class="form-select" id="filterDesa"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Jenis Bantuan</label>
                                            <select class="form-select" id="filterJenis">
                                                <option value="">Semua Jenis</option>
                                                <option value="Uang">Uang</option>
                                                <option value="Barang">Barang</option>
                                                <option value="Jasa">Jasa</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <button class="btn btn-secondary me-2" id="resetFilterBtn"><i class="fas fa-undo me-1"></i> Reset</button>
                                        <button class="btn btn-primary" id="applyFilterBtn"><i class="fas fa-check me-1"></i> Terapkan</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list me-2"></i> Hasil Filter</span>
                                    <span class="badge bg-warning text-dark" id="filterResultCount">0 Data</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="filterTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>WhatsApp</th><th>Kelompok</th>
                                                    <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                                    <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th><th>Dokumen</th><th>Validasi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="filterTableBody">
                                                <tr><td colspan="16" class="text-center py-4">Silakan terapkan filter</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-print" role="tabpanel">
                            <h3 class="section-title">Cetak Laporan</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-print me-2"></i> Konfigurasi Cetak</div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <label class="form-label">Tahun</label>
                                            <select class="form-select" id="printTahun"></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Kecamatan</label>
                                            <select class="form-select" id="printKecamatan"></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Jenis Bantuan</label>
                                            <select class="form-select" id="printJenis">
                                                <option value="">Semua Jenis</option>
                                                <option value="Uang">Uang</option>
                                                <option value="Barang">Barang</option>
                                                <option value="Jasa">Jasa</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="p-4 border rounded bg-light text-center h-100">
                                                <i class="fas fa-eye fa-3x text-info mb-3"></i>
                                                <h5>Pratinjau Layar</h5>
                                                <button class="btn btn-info text-white mt-2 w-100" id="previewBtn">Buka Pratinjau</button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="p-4 border rounded bg-light text-center h-100">
                                                <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                                <h5>Unduh PDF</h5>
                                                <button class="btn btn-danger mt-2 w-100" id="printPdfBtn">Download Laporan PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-export" role="tabpanel">
                            <h3 class="section-title">Ekspor Data</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-file-export me-2"></i> Ekspor Universal</div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-4">Filter data sebelum melakukan ekspor untuk hasil yang spesifik.</div>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4"><select class="form-select" id="exportTahun"></select></div>
                                        <div class="col-md-4"><select class="form-select" id="exportKecamatan"></select></div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="exportJenis">
                                                <option value="">Semua Jenis</option>
                                                <option value="Uang">Uang</option>
                                                <option value="Barang">Barang</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-3"><button class="btn btn-success w-100 py-3" id="exportExcelBtn"><i class="fas fa-file-excel fa-lg mb-1 d-block"></i>Excel</button></div>
                                        <div class="col-md-3"><button class="btn btn-info text-white w-100 py-3" id="exportCsvBtn"><i class="fas fa-file-csv fa-lg mb-1 d-block"></i>CSV</button></div>
                                        <div class="col-md-3"><button class="btn btn-warning text-white w-100 py-3" id="exportJsonBtn"><i class="fas fa-file-code fa-lg mb-1 d-block"></i>JSON</button></div>
                                        <div class="col-md-3"><button class="btn btn-danger w-100 py-3" id="exportPdfBtn"><i class="fas fa-file-pdf fa-lg mb-1 d-block"></i>PDF</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB PANEL BARU: Ekstrak Data -->
                        <div class="tab-pane fade" id="v-pills-extract" role="tabpanel">
                            <h3 class="section-title">Ekstrak Data untuk Peta Statistik</h3>
                            <div class="card mb-4">
                                <div class="card-header"><i class="fas fa-map-marked-alt me-2"></i> Generate Data Peta</div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <strong>Informasi:</strong> Fitur ini akan menghasilkan file data statistik per desa dalam format JavaScript (datapeta.js) yang dapat digunakan untuk visualisasi peta.
                                    </div>
                                    <div class="extract-security-form">
                                        <div class="mb-3">
                                            <label for="extractSecurityCode" class="form-label">Kode Keamanan</label>
                                            <input type="password" class="form-control" id="extractSecurityCode" placeholder="Masukkan kode keamanan">
                                            <div class="invalid-feedback" id="extractSecurityCodeError" style="display: none;">Kode keamanan salah.</div>
                                        </div>
                                        <div class="d-grid">
                                            <button class="btn btn-primary" id="generateDataPetaBtn">
                                                <i class="fas fa-map-marked-alt me-2"></i> Generate Data Peta
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4" id="extractPreviewSection" style="display: none;">
                                        <h5 class="mb-3">Pratinjau Data Peta</h5>
                                        <div class="extract-preview" id="extractPreview"></div>
                                        
                                        <div class="mt-4">
                                            <h6 class="mb-3">Koordinat Maps untuk Setiap Penerima:</h6>
                                            <div id="koordinatDetails"></div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end mt-3">
                                            <button class="btn btn-success" id="downloadDataPetaBtn">
                                                <i class="fas fa-download me-2"></i> Download datapeta.js
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-info-circle me-2"></i> Panduan Penggunaan</div>
                                <div class="card-body">
                                    <h6>Langkah-langkah penggunaan data peta:</h6>
                                    <ol>
                                        <li>Masukkan kode keamanan: <strong>19450817</strong></li>
                                        <li>Klik tombol "Generate Data Peta"</li>
                                        <li>Preview data akan muncul, periksa kelengkapan data termasuk koordinat maps untuk setiap desa</li>
                                        <li>Klik "Download datapeta.js" untuk mendapatkan file script</li>
                                        <li>File datapeta.js dapat diupload ke repository untuk digunakan di website peta statistik</li>
                                    </ol>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Penting:</strong> File datapeta.js berisi data statistik per desa yang sudah diringkas dan dilengkapi dengan koordinat maps untuk setiap desa penerima bantuan.
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        <strong>Fitur Koordinat Maps:</strong> Sistem otomatis melampirkan koordinat GPS untuk setiap desa berdasarkan database yang tersedia. Koordinat dapat digunakan untuk menampilkan lokasi di Google Maps atau peta digital lainnya.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-backup" role="tabpanel">
                            <h3 class="section-title">Manajemen Data & Keamanan</h3>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white"><i class="fas fa-download me-2"></i> Backup Data (Reload.js)</div>
                                        <div class="card-body text-center">
                                            <i class="fas fa-shield-alt fa-4x text-primary mb-3"></i>
                                            <h5>Amankan Data Anda</h5>
                                            <p class="text-muted small">Mengunduh file <strong>reload.js</strong> terenkripsi otomatis untuk keperluan reload repo.</p>
                                            <button class="btn btn-primary w-100" id="backupDataBtn">Download</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-success text-white"><i class="fas fa-upload me-2"></i> Restore Data</div>
                                        <div class="card-body text-center">
                                            <i class="fas fa-history fa-4x text-success mb-3"></i>
                                            <h5>Pulihkan Data</h5>
                                            <p class="text-muted small">Mengembalikan data dari file backup sebelumnya.</p>
                                            <input type="file" class="form-control mb-3" id="restoreFileInput" accept=".json,.js">
                                            <button class="btn btn-success w-100" id="restoreDataBtn" disabled>Proses Restore</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4 border-danger">
                                <div class="card-header bg-danger text-white"><i class="fas fa-exclamation-triangle me-2"></i> Zona Bahaya</div>
                                <div class="card-body text-center">
                                    <h5>Reset Sistem</h5>
                                    <p class="text-danger small">Tindakan ini akan menghapus seluruh data secara permanen.</p>
                                    <button class="btn btn-outline-danger" id="resetDataBtn" data-bs-toggle="modal" data-bs-target="#confirmResetModal">Reset Data Pabrik</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-settings" role="tabpanel">
                            <h3 class="section-title">Pengaturan Sistem</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-cogs me-2"></i> Preferensi Aplikasi</div>
                                <div class="card-body">
                                    <form id="settingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Aplikasi</label>
                                                <input type="text" class="form-control" id="appName" value="SISTEM BANTUAN NELAYAN">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Instansi</label>
                                                <input type="text" class="form-control" id="appSubtitle" value="Dinas Peternakan dan Perikanan Kab. Situbondo">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Kode Keamanan Baru</label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="settingSecurityCode" placeholder="Biarkan kosong jika tidak berubah">
                                                    <button class="btn btn-outline-secondary toggle-password-settings" type="button">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                                <small class="text-muted" style="display:none !important;">Default: <strong>BidangPN1945</strong></small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Baris per Halaman</label>
                                                <select class="form-select" id="itemsPerPage">
                                                    <option value="10">10</option>
                                                    <option value="25">25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Tahun Default</label>
                                                <select class="form-select" id="defaultTahun"></select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3 p-3 bg-light border rounded">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="privacyToggle">
                                                <label class="form-check-label fw-bold" for="privacyToggle">Mode Privasi Data (Sensor NIK & HP)</label>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                <strong>ON:</strong> NIK dan Nomor HP disensor (****). <br>
                                                <strong>OFF:</strong> Data ditampilkan penuh (Memerlukan PIN).
                                            </small>
                                        </div>
                                        
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="notifications" checked>
                                            <label class="form-check-label" for="notifications">Aktifkan Notifikasi Suara & Pop-up</label>
                                        </div>
                                        
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Simpan Perubahan</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4 border-left-primary shadow-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="fw-bold mb-2" style="color: var(--primary-color);">SUPPORT CENTER</h6>
                                            <p class="small text-muted mb-0">Butuh bantuan teknis? Hubungi tim pengembang.</p>
                                        </div>
                                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                            <a href="https://wa.me/6285647709114" class="btn btn-success btn-sm me-2"><i class="fab fa-whatsapp me-1"></i> WhatsApp</a>
                                            <a href="mailto:admin@anekamarket.my.id" class="btn btn-primary btn-sm"><i class="fas fa-envelope me-1"></i> Email</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4 bg-light border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary">Informasi Teknis</h6>
                                    <div class="row small text-muted">
                                        <div class="col-6">Versi: 2.2.0 (Professional)</div>
                                        <div class="col-6 text-end">Database: LocalStorage Encrypted</div>
                                        <div class="col-6">Browser: <span id="browserInfo">-</span></div>
                                        <div class="col-6 text-end">Usage: <span id="storageInfo">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright text-center py-3">
                &copy; 2025 Dinas Peternakan dan Perikanan Kabupaten Situbondo - Bidang Pemberdayaan Nelayan.
            </div>
        </div>
        
        <div class="smart-menu-container" id="smartMenu">
            <button class="smart-menu-toggle pulse-effect" id="smartMenuToggle" title="Menu Pintas">
                <i class="fas fa-th-large"></i>
            </button>

            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('btn-reload-repo')">
                <i class="fas fa-sync-alt"></i>
                <span class="smart-menu-tooltip">Reload Data</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-settings-tab')">
                <i class="fas fa-cog"></i>
                <span class="smart-menu-tooltip">Pengaturan</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-backup-tab')">
                <i class="fas fa-download"></i>
                <span class="smart-menu-tooltip">Backup & Restore</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-extract-tab')">
                <i class="fas fa-map-marked-alt"></i>
                <span class="smart-menu-tooltip">Ekstrak Data</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-export-tab')">
                <i class="fas fa-file-export"></i>
                <span class="smart-menu-tooltip">Ekspor Data</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-print-tab')">
                <i class="fas fa-print"></i>
                <span class="smart-menu-tooltip">Cetak Laporan</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-filter-tab')">
                <i class="fas fa-filter"></i>
                <span class="smart-menu-tooltip">Filter Data</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-data-tab')">
                <i class="fas fa-database"></i>
                <span class="smart-menu-tooltip">Data Bantuan</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-input-tab')">
                <i class="fas fa-pencil-alt"></i>
                <span class="smart-menu-tooltip">Input Data</span>
            </a>
            <a href="#" class="smart-menu-item" onclick="triggerSmartMenu('v-pills-dashboard-tab')">
                <i class="fas fa-tachometer-alt"></i>
                <span class="smart-menu-tooltip">Dashboard</span>
            </a>
        </div>

        <button class="floating-action-btn fab-common" id="fabBtn" title="Tambah Data Baru">
            <i class="fas fa-plus"></i>
        </button>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast notification-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Detail Data -->
    <div class="modal fade" id="detailDataModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i> Detail Data Bantuan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-modal-label">Nama Penerima</div>
                            <div class="detail-modal-value" id="detailNama">-</div>
                            
                            <div class="detail-modal-label">NIK</div>
                            <div class="detail-modal-value" id="detailNik">-</div>
                            
                            <div class="detail-modal-label">WhatsApp</div>
                            <div class="detail-modal-value" id="detailWhatsapp">-</div>
                            
                            <div class="detail-modal-label">Kelompok</div>
                            <div class="detail-modal-value" id="detailKelompok">-</div>
                            
                            <div class="detail-modal-label">Jabatan</div>
                            <div class="detail-modal-value" id="detailJabatan">-</div>
                            
                            <div class="detail-modal-label">Tahun Anggaran</div>
                            <div class="detail-modal-value" id="detailTahun">-</div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-modal-label">Kecamatan</div>
                            <div class="detail-modal-value" id="detailKecamatan">-</div>
                            
                            <div class="detail-modal-label">Desa</div>
                            <div class="detail-modal-value" id="detailDesa">-</div>
                            
                            <div class="detail-modal-label">Alamat</div>
                            <div class="detail-modal-value" id="detailAlamat">-</div>
                            
                            <div class="detail-modal-label">Jenis Bantuan</div>
                            <div class="detail-modal-value" id="detailJenisBantuan">-</div>
                            
                            <div class="detail-modal-label">Nama Bantuan</div>
                            <div class="detail-modal-value" id="detailNamaBantuan">-</div>
                            
                            <div class="detail-modal-label">Jumlah Bantuan</div>
                            <div class="detail-modal-value" id="detailJumlahBantuan">-</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="detail-modal-label">Tanggal Menerima</div>
                            <div class="detail-modal-value" id="detailTanggal">-</div>
                            
                            <div class="detail-modal-label">Nama Petugas</div>
                            <div class="detail-modal-value" id="detailPetugas">-</div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-modal-label">Link Google Drive</div>
                            <div class="detail-modal-value" id="detailDriveLink">-</div>
                            
                            <div class="detail-modal-label">Kode Validasi</div>
                            <div class="detail-modal-value" id="detailKodeValidasi">-</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="detail-modal-label">Keterangan</div>
                            <div class="detail-modal-value" id="detailKeterangan">-</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="confirmResetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Konfirmasi Reset Total</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger fw-bold">PERINGATAN: Semua data akan hilang permanen!</p>
                    <p>Ketik <strong>RESET</strong> untuk melanjutkan:</p>
                    <input type="text" class="form-control" id="resetConfirmationInput">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>Hapus Semua Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalTitle">Pratinjau Dokumen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printFromPreviewBtn"><i class="fas fa-print me-1"></i> Cetak Sekarang</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="privacyAuthModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fs-6 fw-bold">Keamanan Sensor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="closePrivacyModal"></button>
                </div>
                <div class="modal-body">
                    <p class="small mb-2">Masukkan PIN untuk melihat data lengkap:</p>
                    <div class="input-group">
                        <input type="password" class="form-control text-center fw-bold" id="privacyPasswordInput" placeholder="MASUKKAN PIN" maxlength="8">
                        <button class="btn btn-outline-secondary toggle-password-privacy" type="button">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback d-block text-center mt-2" id="privacyError" style="display:none !important;">PIN Salah!</div>
                </div>
                <div class="modal-footer p-2 justify-content-center">
                    <button type="button" class="btn btn-warning w-100 fw-bold" id="submitPrivacyAuth">Buka Sensor</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="universalPinModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fs-6 fw-bold">Keamanan Otoritas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small mb-2">Masukkan PIN untuk melanjutkan aksi ini:</p>
                    <div class="input-group">
                        <input type="password" class="form-control text-center fw-bold" id="universalPinInput" placeholder="PIN" maxlength="8">
                    </div>
                    <div class="invalid-feedback d-block text-center mt-2" id="universalPinError" style="display:none !important;">PIN Salah!</div>
                </div>
                <div class="modal-footer p-2 justify-content-center">
                    <button type="button" class="btn btn-danger w-100 fw-bold" id="submitUniversalPin">Konfirmasi</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        let appData = [];
        let appSettings = {
            securityCode: 'BidangPN1945',
            itemsPerPage: 25,
            notifications: true,
            appName: 'SISTEM BANTUAN NELAYAN',
            appSubtitle: 'Dinas Peternakan dan Perikanan Kab. Situbondo',
            defaultTahun: new Date().getFullYear(),
            lastBackupDate: '-',
            privacyMode: true
        };
        let currentPage = 1;
        let filteredData = [];
        let isFilterActive = false;
        let loginAttempts = 0;
        let isBlocked = false;
        let blockTimeout;
        let generatedCodes = {};
        
        const SECURITY_CONSTANTS = {
            PIN: '17081945',
            DEFAULT_PASS: 'BidangPN1945',
            EXTRACT_CODE: '19450817' // Kode keamanan untuk ekstrak data
        };

        let pendingSecurityAction = null;
        let generatedPetaData = null; // Menyimpan data peta yang dihasilkan
        
        // DATA DESA/KECAMATAN YANG DIPERBARUI SESUAI PERMINTAAN
        const kecamatanList = [
            "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", 
            "Bungatan", "Jangkar", "Jatibanteng", "Kapongan", "Kendit", 
            "Mangaran", "Mlandingan", "Panarukan", "Panji", "Situbondo", 
            "Suboh", "Sumbermalang"
        ];
        
        // Data desa per kecamatan yang diperbarui
        const desaByKecamatan = {
            "Arjasa": ["Arjasa", "Bayeman", "Curah Tatal", "Jatisari", "Kayumas", "Kedungdowo", "Ketowan", "Lamongan"],
            "Asembagus": ["Asembagus", "Awar-awar", "Bantal", "Gudang", "Kedunglo", "Kertosari", "Mojosari", "Parante", "Trigonco", "Wringin Anom"],
            "Banyuglugur": ["Banyuglugur", "Kalianget", "Kalisari", "Lubawang", "Selobanteng", "Telempong", "Tepos"],
            "Banyuputih": ["Banyuputih", "Sumberanyar", "Sumberejo", "Sumberwaru", "Wonorejo"],
            "Besuki": ["Besuki", "Blimbing", "Bloro", "Demung", "Jetis", "Kalimas", "Langkap", "Pesisir", "Sumberejo", "Widoropayung"],
            "Bungatan": ["Bletok", "Bungatan", "Mlandingan Wetan", "Pasir Putih", "Patemon", "Selowogo", "Sumbertengah"],
            "Jangkar": ["Agel", "Curah Kalak", "Gadingan", "Jangkar", "Kumbangsari", "Palangan", "Pesanggrahan", "Sopet"],
            "Jatibanteng": ["Curahsuri", "Jatibanteng", "Kembangsari", "Pategalan", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"],
            "Kapongan": ["Curah Cottok", "Gebangan", "Kandang", "Kapongan", "Kesambi Rampak", "Landangan", "Peleyan", "Pokaan", "Seletreng", "Wonokoyo"],
            "Kendit": ["Balung", "Bugeman", "Kendit", "Klatakan", "Kukusan", "Rajekwesi", "Tambak Ukir"],
            "Mangaran": ["Mangaran", "Semiring", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Trebungan"],
            "Mlandingan": ["Alas Bayur", "Campoan", "Mlandingan Kulon", "Selomukti", "Sumberanyar", "Sumber Pinang", "Trebungan"],
            "Panarukan": ["Alasmalang", "Duwet", "Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"],
            "Panji": ["Battal", "Curah Jeru", "Juglangan", "Kayu Putih", "Klampokan", "Panji Kidul", "Panji Lor", "Sliwung", "Tenggir", "Tokelan", "Ardirejo", "Mimbaan"],
            "Situbondo": ["Kalibagor", "Kotakan", "Olean", "Talkandang", "Dawuhan", "Patokan"],
            "Suboh": ["Buduan", "Cemara", "Dawuan", "Gunung Malang", "Gunung Putri", "Ketah", "Mojodungkol", "Suboh"],
            "Sumbermalang": ["Alastengah", "Baderan", "Kalirejo", "Plalangan", "Sumberargo", "Taman", "Tamankursi", "Tamansari", "Tlogosari"]
        };
        
        // Gabungkan semua desa untuk dropdown
        const desaList = Object.values(desaByKecamatan).flat().sort();
        
        // ==================== DATABASE KOORDINAT YANG DIPERBARUI ====================
        // Database koordinat kecamatan yang AKURAT untuk Kabupaten Situbondo (diperbarui)
        const koordinatKecamatan = {
            "Arjasa": { lat: -7.7069, lng: 113.6347 },
            "Asembagus": { lat: -7.7536, lng: 114.1561 },
            "Banyuglugur": { lat: -7.7211, lng: 113.8883 },
            "Banyuputih": { lat: -7.7608, lng: 114.0200 },
            "Besuki": { lat: -7.7333, lng: 113.7000 },
            "Bungatan": { lat: -7.6833, lng: 113.8833 },
            "Jangkar": { lat: -7.7500, lng: 114.0833 },
            "Jatibanteng": { lat: -7.7167, lng: 113.9833 },
            "Kapongan": { lat: -7.6833, lng: 114.0167 },
            "Kendit": { lat: -7.7333, lng: 113.9333 },
            "Mangaran": { lat: -7.6667, lng: 114.0667 },
            "Mlandingan": { lat: -7.6833, lng: 113.9500 },
            "Panarukan": { lat: -7.7000, lng: 113.9167 },
            "Panji": { lat: -7.7167, lng: 113.6667 },
            "Situbondo": { lat: -7.7062, lng: 113.9603 },
            "Suboh": { lat: -7.8000, lng: 113.8333 },
            "Sumbermalang": { lat: -7.7667, lng: 113.7833 }
        };

        // Database koordinat desa yang DIPERBARUI dan DILENGKAPI untuk semua desa
        const koordinatDesa = {
            // ===== KECAMATAN ARJASA =====
            "Arjasa, Arjasa": { lat: -7.7069, lng: 113.6347 },
            "Bayeman, Arjasa": { lat: -7.7150, lng: 113.6250 },
            "Curah Tatal, Arjasa": { lat: -7.6900, lng: 113.6200 },
            "Jatisari, Arjasa": { lat: -7.6980, lng: 113.6400 },
            "Kayumas, Arjasa": { lat: -7.7100, lng: 113.6300 },
            "Kedungdowo, Arjasa": { lat: -7.7000, lng: 113.6500 },
            "Ketowan, Arjasa": { lat: -7.7050, lng: 113.6200 },
            "Lamongan, Arjasa": { lat: -7.6950, lng: 113.6350 },

            // ===== KECAMATAN ASEMBAGUS =====
            "Asembagus, Asembagus": { lat: -7.7536, lng: 114.1561 },
            "Awar-awar, Asembagus": { lat: -7.7600, lng: 114.1400 },
            "Bantal, Asembagus": { lat: -7.7500, lng: 114.1500 },
            "Gudang, Asembagus": { lat: -7.7500, lng: 114.1500 },
            "Kedunglo, Asembagus": { lat: -7.7450, lng: 114.1500 },
            "Kertosari, Asembagus": { lat: -7.7480, lng: 114.1650 },
            "Mojosari, Asembagus": { lat: -7.7480, lng: 114.1650 },
            "Parante, Asembagus": { lat: -7.7650, lng: 114.1450 },
            "Trigonco, Asembagus": { lat: -7.7650, lng: 114.1450 },
            "Wringin Anom, Asembagus": { lat: -7.7400, lng: 114.1700 },

            // ===== KECAMATAN BANYUGLUGUR =====
            "Banyuglugur, Banyuglugur": { lat: -7.7211, lng: 113.8883 },
            "Kalianget, Banyuglugur": { lat: -7.7300, lng: 113.8800 },
            "Kalisari, Banyuglugur": { lat: -7.7100, lng: 113.9000 },
            "Lubawang, Banyuglugur": { lat: -7.7250, lng: 113.9100 },
            "Selobanteng, Banyuglugur": { lat: -7.7200, lng: 113.8950 },
            "Telempong, Banyuglugur": { lat: -7.7150, lng: 113.8850 },
            "Tepos, Banyuglugur": { lat: -7.7250, lng: 113.9100 },

            // ===== KECAMATAN BANYUPUTIH =====
            "Banyuputih, Banyuputih": { lat: -7.7608, lng: 114.0200 },
            "Sumberanyar, Banyuputih": { lat: -7.7608, lng: 114.0200 },
            "Sumberejo, Banyuputih": { lat: -7.7650, lng: 114.0250 },
            "Sumberwaru, Banyuputih": { lat: -7.7550, lng: 114.0150 },
            "Wonorejo, Banyuputih": { lat: -7.7500, lng: 114.0300 },

            // ===== KECAMATAN BESUKI =====
            "Besuki, Besuki": { lat: -7.7333, lng: 113.7000 },
            "Blimbing, Besuki": { lat: -7.7400, lng: 113.7100 },
            "Bloro, Besuki": { lat: -7.7300, lng: 113.6900 },
            "Demung, Besuki": { lat: -7.7300, lng: 113.6900 },
            "Jetis, Besuki": { lat: -7.7200, lng: 113.7050 },
            "Kalimas, Besuki": { lat: -7.7350, lng: 113.6950 },
            "Langkap, Besuki": { lat: -7.7350, lng: 113.6950 },
            "Pesisir, Besuki": { lat: -7.7250, lng: 113.6800 },
            "Sumberejo, Besuki": { lat: -7.7150, lng: 113.7000 },
            "Widoropayung, Besuki": { lat: -7.7100, lng: 113.7100 },

            // ===== KECAMATAN BUNGATAN =====
            "Bletok, Bungatan": { lat: -7.6833, lng: 113.8833 },
            "Bungatan, Bungatan": { lat: -7.6833, lng: 113.8833 },
            "Mlandingan Wetan, Bungatan": { lat: -7.6900, lng: 113.8900 },
            "Pasir Putih, Bungatan": { lat: -7.6750, lng: 113.8700 },
            "Patemon, Bungatan": { lat: -7.6800, lng: 113.8750 },
            "Selowogo, Bungatan": { lat: -7.6850, lng: 113.8800 },
            "Sumbertengah, Bungatan": { lat: -7.6950, lng: 113.8850 },

            // ===== KECAMATAN JANGKAR =====
            "Agel, Jangkar": { lat: -7.7500, lng: 114.0833 },
            "Curah Kalak, Jangkar": { lat: -7.7450, lng: 114.0800 },
            "Gadingan, Jangkar": { lat: -7.7550, lng: 114.0900 },
            "Jangkar, Jangkar": { lat: -7.7500, lng: 114.0833 },
            "Kumbangsari, Jangkar": { lat: -7.7500, lng: 114.0950 },
            "Palangan, Jangkar": { lat: -7.7400, lng: 114.0750 },
            "Pesanggrahan, Jangkar": { lat: -7.7650, lng: 114.1000 },
            "Sopet, Jangkar": { lat: -7.7700, lng: 114.1050 },

            // ===== KECAMATAN JATIBANTENG =====
            "Curahsuri, Jatibanteng": { lat: -7.7200, lng: 113.9900 },
            "Jatibanteng, Jatibanteng": { lat: -7.7167, lng: 113.9833 },
            "Kembangsari, Jatibanteng": { lat: -7.7100, lng: 113.9800 },
            "Pategalan, Jatibanteng": { lat: -7.7250, lng: 113.9850 },
            "Patemon, Jatibanteng": { lat: -7.7150, lng: 113.9750 },
            "Semambung, Jatibanteng": { lat: -7.7300, lng: 113.9950 },
            "Sumberanyar, Jatibanteng": { lat: -7.7300, lng: 113.9950 },
            "Wringinanom, Jatibanteng": { lat: -7.7300, lng: 113.9950 },

            // ===== KECAMATAN KAPONGAN =====
            "Curah Cottok, Kapongan": { lat: -7.6900, lng: 114.0200 },
            "Gebangan, Kapongan": { lat: -7.6800, lng: 114.0150 },
            "Kandang, Kapongan": { lat: -7.6833, lng: 114.0167 },
            "Kapongan, Kapongan": { lat: -7.6833, lng: 114.0167 },
            "Kesambi Rampak, Kapongan": { lat: -7.6950, lng: 114.0300 },
            "Landangan, Kapongan": { lat: -7.6700, lng: 114.0050 },
            "Peleyan, Kapongan": { lat: -7.7000, lng: 114.0350 },
            "Pokaan, Kapongan": { lat: -7.7200, lng: 114.0450 },
            "Seletreng, Kapongan": { lat: -7.7100, lng: 114.0400 },
            "Wonokoyo, Kapongan": { lat: -7.7050, lng: 114.0250 },

            // ===== KECAMATAN KENDIT =====
            "Balung, Kendit": { lat: -7.7400, lng: 113.9400 },
            "Bugeman, Kendit": { lat: -7.7333, lng: 113.9333 },
            "Kendit, Kendit": { lat: -7.7333, lng: 113.9333 },
            "Klatakan, Kendit": { lat: -7.7350, lng: 113.9300 },
            "Kukusan, Kendit": { lat: -7.7250, lng: 113.9250 },
            "Rajekwesi, Kendit": { lat: -7.7200, lng: 113.9200 },
            "Tambak Ukir, Kendit": { lat: -7.7100, lng: 113.9150 },

            // ===== KECAMATAN MANGARAN =====
            "Mangaran, Mangaran": { lat: -7.6667, lng: 114.0667 },
            "Semiring, Mangaran": { lat: -7.6700, lng: 114.0700 },
            "Tanjung Glugur, Mangaran": { lat: -7.6750, lng: 114.0750 },
            "Tanjung Kamal, Mangaran": { lat: -7.6750, lng: 114.0750 },
            "Tanjung Pecinan, Mangaran": { lat: -7.6800, lng: 114.0800 },
            "Trebungan, Mangaran": { lat: -7.6650, lng: 114.0650 },

            // ===== KECAMATAN MLANDINGAN =====
            "Alas Bayur, Mlandingan": { lat: -7.6833, lng: 113.9500 },
            "Campoan, Mlandingan": { lat: -7.6800, lng: 113.9550 },
            "Mlandingan Kulon, Mlandingan": { lat: -7.6900, lng: 113.9400 },
            "Selomukti, Mlandingan": { lat: -7.6850, lng: 113.9450 },
            "Sumberanyar, Mlandingan": { lat: -7.6900, lng: 113.9400 },
            "Sumber Pinang, Mlandingan": { lat: -7.6900, lng: 113.9400 },
            "Trebungan, Mlandingan": { lat: -7.6750, lng: 113.9600 },

            // ===== KECAMATAN PANARUKAN ===== (KOORDINAT DIPERBARUI SESUAI DATA)
            "Alasmalang, Panarukan": { lat: -7.6970, lng: 113.7687 },
            "Duwet, Panarukan": { lat: -7.6977, lng: 113.7882 },
            "Gelung, Panarukan": { lat: -7.7134, lng: 113.8028 },
            "Kilensari, Panarukan": { lat: -7.6843, lng: 113.7656 },
            "Paowan, Panarukan": { lat: -7.7298, lng: 113.7800 },
            "Peleyan, Panarukan": { lat: -7.6950, lng: 113.8071 },
            "Sumberkolak, Panarukan": { lat: -7.7118, lng: 113.7618 },
            "Wringinanom, Panarukan": { lat: -7.7061, lng: 113.8256 },

            // ===== KECAMATAN PANJI ===== (KOORDINAT DIPERBARUI SESUAI DATA)
            "Battal, Panji": { lat: -7.7099, lng: 113.6780 },
            "Curah Jeru, Panji": { lat: -7.6941, lng: 113.6958 },
            "Juglangan, Panji": { lat: -7.6946, lng: 113.6653 },
            "Kayu Putih, Panji": { lat: -7.7025, lng: 113.6737 },
            "Klampokan, Panji": { lat: -7.7272, lng: 113.6482 },
            "Panji Kidul, Panji": { lat: -7.7126, lng: 113.7038 },
            "Panji Lor, Panji": { lat: -7.7019, lng: 113.7059 },
            "Sliwung, Panji": { lat: -7.7188, lng: 113.6806 },
            "Tenggir, Panji": { lat: -7.7163, lng: 113.6579 },
            "Tokelan, Panji": { lat: -7.7320, lng: 113.6703 },
            "Ardirejo, Panji": { lat: -7.7155, lng: 113.6944 },
            "Mimbaan, Panji": { lat: -7.7091, lng: 113.6952 },

            // ===== KECAMATAN SITUBONDO ===== (KOORDINAT DIPERBARUI SESUAI DATA)
            "Kalibagor, Situbondo": { lat: -7.7082, lng: 114.0061 },
            "Kotakan, Situbondo": { lat: -7.6814, lng: 114.0225 },
            "Olean, Situbondo": { lat: -7.6819, lng: 114.0367 },
            "Talkandang, Situbondo": { lat: -7.6681, lng: 114.0475 },
            "Dawuhan, Situbondo": { lat: -7.6926, lng: 113.9937 },
            "Patokan, Situbondo": { lat: -7.6729, lng: 113.9771 },

            // ===== KECAMATAN SUBOH ===== (KOORDINAT DIPERBARUI SESUAI DATA)
            "Buduan, Suboh": { lat: -7.8523, lng: 113.7659 },
            "Cemara, Suboh": { lat: -7.8267, lng: 113.7425 },
            "Dawuan, Suboh": { lat: -7.8398, lng: 113.7719 },
            "Gunung Malang, Suboh": { lat: -7.8708, lng: 113.7489 },
            "Gunung Putri, Suboh": { lat: -7.8647, lng: 113.7325 },
            "Ketah, Suboh": { lat: -7.8614, lng: 113.7894 },
            "Mojodungkol, Suboh": { lat: -7.8360, lng: 113.7829 },
            "Suboh, Suboh": { lat: -7.8475, lng: 113.7580 },

            // ===== KECAMATAN SUMBERMALANG ===== (KOORDINAT DIPERBARUI SESUAI DATA)
            "Alastengah, Sumbermalang": { lat: -7.8771, lng: 113.8437 },
            "Baderan, Sumbermalang": { lat: -7.8318, lng: 113.8214 },
            "Kalirejo, Sumbermalang": { lat: -7.8203, lng: 113.8525 },
            "Plalangan, Sumbermalang": { lat: -7.8630, lng: 113.8629 },
            "Sumberargo, Sumbermalang": { lat: -7.8405, lng: 113.8077 },
            "Taman, Sumbermalang": { lat: -7.8482, lng: 113.8374 },
            "Tamankursi, Sumbermalang": { lat: -7.8641, lng: 113.8256 },
            "Tamansari, Sumbermalang": { lat: -7.8618, lng: 113.8125 },
            "Tlogosari, Sumbermalang": { lat: -7.8816, lng: 113.8243 }
        };

        // ==================== DATA CONTOH UNTUK PETA STATISTIK ====================
        const SAMPLE_DATA = {
            metadata: {
                lastUpdate: "9 Desember 2025 pukul 23.35",
                totalDesa: 136,
                totalPenerima: 2487,
                generatedAt: "2025-12-09T23:35:00.000Z",
                timestamp: 1733772900000,
                sumber: "Sistem Bantuan Nelayan Kab. Situbondo",
                instansi: "Dinas Peternakan dan Perikanan Kab. Situbondo",
                bidang: "Pemberdayaan Nelayan",
                versi: "2.0"
            },
            summary: {
                totalBantuanBarang: 3150,
                totalBantuanUang: 1850000000,
                totalBantuanJasa: 420,
                desaTerbanyak: ["Panarukan, Panarukan", 145]
            },
            data: [
                {
                    id: "1",
                    desa: "Panarukan",
                    kecamatan: "Panarukan",
                    jumlahPenerima: 145,
                    totalBantuanBarang: 180,
                    totalBantuanUang: 85000000,
                    totalBantuanJasa: 25,
                    rataBantuan: 1.24,
                    koordinat: { lat: -7.7069, lng: 113.6347 },
                    tahunDistribusi: [
                        { tahun: "2023", jumlah: 65 },
                        { tahun: "2024", jumlah: 80 }
                    ],
                    jenisBantuan: [
                        { jenis: "Jaring", jumlah: 85 },
                        { jenis: "Perahu", jumlah: 15 },
                        { jenis: "Mesin", jumlah: 45 },
                        { jenis: "Uang Tunai", jumlah: 35 },
                        { jenis: "Pelatihan", jumlah: 25 }
                    ],
                    kelompokDistribusi: [
                        { kelompok: "Nelayan Tradisional", jumlah: 95 },
                        { kelompok: "Nelayan Modern", jumlah: 35 },
                        { kelompok: "Individu", jumlah: 15 }
                    ],
                    statistik: {
                        uang: { jumlah: 35, nilai: 85000000 },
                        barang: { jumlah: 145, nilai: 180 },
                        jasa: { jumlah: 25, nilai: 25 }
                    },
                    detailPenerima: [],
                    warnaIntensitas: 1.0,
                    popupContent: "<strong>Panarukan, Panarukan</strong><br>Jumlah Penerima: 145<br>Total Bantuan: Rp 85.000.000 + 180 unit + 25 paket<br>Uang: 35 penerima (Rp 85.000.000)<br>Barang: 145 penerima (180 unit)<br>Jasa: 25 penerima (25 paket)"
                }
            ]
        };

        // --- APPLICATION LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', function() {
            // Cek jika ada error di console
            if (typeof console !== 'undefined') {
                console.log('Aplikasi Sistem Bantuan Nelayan Kab. Situbondo diinisialisasi');
            }
            
            initializeApp();
            setupEventListeners();
            
            // Tampilkan modal login
            try {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            } catch (error) {
                console.error('Error menampilkan modal login:', error);
            }
        });
        
        function initializeApp() {
            loadSettings();
            loadData();
            
            fillYearDropdowns();
            fillKecamatanDropdown();
            fillDesaDropdown();
            
            // Fill filter dropdowns for data table
            fillFilterDropdownsForDataTable();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalTerima').value = today;
            
            initializeCharts();
            setupBrowserInfo();
            updateDashboard();
            applySettingsToUI();
        }

        function setupEventListeners() {
            // Login & Auth
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Welcome Modal
            document.getElementById('welcomeReloadBtn').addEventListener('click', handleWelcomeReload);
            document.getElementById('skipReloadBtn').addEventListener('click', handleSkipReload);
            
            // Password Visibility Toggles
            const toggleHandlers = [
                { btn: '.toggle-password', input: 'securityCode' },
                { btn: '.toggle-password-settings', input: 'settingSecurityCode' },
                { btn: '.toggle-password-privacy', input: 'privacyPasswordInput' }
            ];
            
            toggleHandlers.forEach(handler => {
                const btn = document.querySelector(handler.btn);
                if (btn) {
                    btn.addEventListener('click', function() {
                        togglePasswordVisibility(this, handler.input);
                    });
                }
            });
            
            // Main Input Form
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('inputForm').addEventListener('reset', resetForm);
            
            const btnBukanKelompok = document.getElementById('btnBukanKelompok');
            if (btnBukanKelompok) {
                btnBukanKelompok.addEventListener('click', setBukanKelompok);
            }
            
            const generateKodeBtn = document.getElementById('generateKodeBtn');
            if (generateKodeBtn) {
                generateKodeBtn.addEventListener('click', generateKodeValidasi);
            }
            
            const jabatanSelect = document.getElementById('jabatan');
            if (jabatanSelect) {
                jabatanSelect.addEventListener('change', handleJabatanChange);
            }
            
            const nikInput = document.getElementById('nik');
            if (nikInput) {
                nikInput.addEventListener('input', () => {
                    document.getElementById('kodeValidasi').value = '';
                });
            }

            // Form Live Validation
            ['nama', 'nik', 'whatsapp', 'namaPetugas', 'namaBantuan', 'jumlahBantuan', 'driveLink', 'kodeValidasi', 'kecamatan', 'desa', 'tanggalTerima'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => clearError(id));
                }
            });
            
            // Data Table & Search
            const searchData = document.getElementById('searchData');
            if (searchData) {
                searchData.addEventListener('input', handleSearch);
            }
            
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            // Filter for Data Table
            const filterKecamatanData = document.getElementById('filterKecamatanData');
            if (filterKecamatanData) {
                filterKecamatanData.addEventListener('change', handleDataTableFilter);
            }
            
            const filterDesaData = document.getElementById('filterDesaData');
            if (filterDesaData) {
                filterDesaData.addEventListener('change', handleDataTableFilter);
            }
            
            // Advanced Filter
            const applyFilterBtn = document.getElementById('applyFilterBtn');
            if (applyFilterBtn) {
                applyFilterBtn.addEventListener('click', applyFilter);
            }
            
            const resetFilterBtn = document.getElementById('resetFilterBtn');
            if (resetFilterBtn) {
                resetFilterBtn.addEventListener('click', resetFilter);
            }
            
            // Print & Export Actions
            const printPdfBtn = document.getElementById('printPdfBtn');
            if (printPdfBtn) {
                printPdfBtn.addEventListener('click', printToPdf);
            }
            
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', showPreview);
            }
            
            // Export buttons
            const exportButtons = {
                'exportExcelBtn': () => exportData('excel'),
                'exportCsvBtn': () => exportData('csv'),
                'exportJsonBtn': () => exportData('json'),
                'exportPdfBtn': () => exportData('pdf')
            };
            
            Object.keys(exportButtons).forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', exportButtons[id]);
                }
            });
            
            // System Management
            const backupDataBtn = document.getElementById('backupDataBtn');
            if (backupDataBtn) {
                backupDataBtn.addEventListener('click', backupData);
            }
            
            const restoreFileInput = document.getElementById('restoreFileInput');
            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', enableRestoreButton);
            }
            
            const restoreDataBtn = document.getElementById('restoreDataBtn');
            if (restoreDataBtn) {
                restoreDataBtn.addEventListener('click', restoreData);
            }
            
            const resetConfirmationInput = document.getElementById('resetConfirmationInput');
            if (resetConfirmationInput) {
                resetConfirmationInput.addEventListener('input', enableResetButton);
            }
            
            // Refactored Reset Listener (Double Security)
            const confirmResetBtn = document.getElementById('confirmResetBtn');
            if (confirmResetBtn) {
                confirmResetBtn.addEventListener('click', function() {
                    const inputVal = document.getElementById('resetConfirmationInput').value;
                    if (inputVal === 'RESET') {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmResetModal'));
                        if (modal) modal.hide();
                        
                        requestHighSecurityAction(() => {
                            performFactoryReset();
                        });
                    }
                });
            }
            
            // Settings Form
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', handleSaveSettings);
            }
            
            // Privacy Toggle Logic
            const privacyToggle = document.getElementById('privacyToggle');
            if (privacyToggle) {
                privacyToggle.addEventListener('click', handlePrivacyToggle);
            }
            
            const submitPrivacyAuth = document.getElementById('submitPrivacyAuth');
            if (submitPrivacyAuth) {
                submitPrivacyAuth.addEventListener('click', checkPrivacyPassword);
            }
            
            const closePrivacyModal = document.getElementById('closePrivacyModal');
            if (closePrivacyModal) {
                closePrivacyModal.addEventListener('click', cancelPrivacyChange);
            }
            
            // Universal PIN Logic
            const submitUniversalPin = document.getElementById('submitUniversalPin');
            if (submitUniversalPin) {
                submitUniversalPin.addEventListener('click', handleUniversalPinSubmit);
            }
            
            // UI Helpers
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleMobileMenu);
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992 && document.getElementById('sidebarMenu').classList.contains('mobile-show')) {
                        toggleMobileMenu();
                    }
                });
            });

            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', () => {
                    const inputTab = document.getElementById('v-pills-input-tab');
                    if (inputTab) inputTab.click();
                });
            }
            
            const jenisBantuan = document.getElementById('jenisBantuan');
            if (jenisBantuan) {
                jenisBantuan.addEventListener('change', updateSatuanBantuan);
            }
            
            const printFromPreviewBtn = document.getElementById('printFromPreviewBtn');
            if (printFromPreviewBtn) {
                printFromPreviewBtn.addEventListener('click', () => window.print());
            }
            
            const logoutTab = document.getElementById('v-pills-logout-tab');
            if (logoutTab) {
                logoutTab.addEventListener('click', logout);
            }
            
            const reloadRepoBtn = document.getElementById('btn-reload-repo');
            if (reloadRepoBtn) {
                reloadRepoBtn.addEventListener('click', handleReloadFromRepo);
            }

            // Smart Menu Logic
            setupSmartMenu();

            // FITUR BARU: Ekstrak Data - DIPERBAIKI
            const generateDataPetaBtn = document.getElementById('generateDataPetaBtn');
            if (generateDataPetaBtn) {
                generateDataPetaBtn.addEventListener('click', generateDataPeta);
            }
            
            const downloadDataPetaBtn = document.getElementById('downloadDataPetaBtn');
            if (downloadDataPetaBtn) {
                downloadDataPetaBtn.addEventListener('click', downloadDataPeta);
            }

            window.addEventListener('beforeunload', autoBackupData);
        }

        // --- SMART MENU LOGIC ---
        function setupSmartMenu() {
            const smartMenuToggle = document.getElementById('smartMenuToggle');
            const smartMenuContainer = document.getElementById('smartMenu');
            
            if (!smartMenuToggle || !smartMenuContainer) return;
            
            smartMenuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                smartMenuContainer.classList.toggle('active');
            });

            // Close smart menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!smartMenuContainer.contains(e.target)) {
                    smartMenuToggle.classList.remove('active');
                    smartMenuContainer.classList.remove('active');
                }
            });
        }

        function triggerSmartMenu(targetId) {
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.click();
                // Close menu after selection
                const smartMenuToggle = document.getElementById('smartMenuToggle');
                const smartMenu = document.getElementById('smartMenu');
                if (smartMenuToggle) smartMenuToggle.classList.remove('active');
                if (smartMenu) smartMenu.classList.remove('active');
            }
        }
        
        function fillYearDropdowns() {
            const yearSelects = ['tahunAnggaran', 'filterTahun', 'printTahun', 'exportTahun', 'defaultTahun'];
            const currentYear = new Date().getFullYear();

            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                
                if (!['tahunAnggaran', 'defaultTahun'].includes(selectId)) {
                    select.add(new Option('Semua Tahun', ''));
                }
                
                for (let year = 2020; year <= 2090; year++) {
                    select.add(new Option(year, year));
                }
                
                select.value = (selectId === 'tahunAnggaran') ? currentYear : (selectId === 'defaultTahun' ? appSettings.defaultTahun : '');
            });
        }
        
        function fillKecamatanDropdown() {
            ['kecamatan', 'filterKecamatan', 'printKecamatan', 'exportKecamatan'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                const defaultText = selectId === 'kecamatan' ? 'Pilih Kecamatan' : 'Semua Kecamatan';
                select.add(new Option(defaultText, ''));
                kecamatanList.forEach(kec => select.add(new Option(kec, kec)));
            });
        }
        
        function fillDesaDropdown() {
            // Update desa dropdown berdasarkan kecamatan yang dipilih
            const kecamatanSelect = document.getElementById('kecamatan');
            const desaSelect = document.getElementById('desa');
            
            if (kecamatanSelect && desaSelect) {
                kecamatanSelect.addEventListener('change', function() {
                    const selectedKecamatan = this.value;
                    desaSelect.innerHTML = '<option value="">Pilih Desa</option>';
                    
                    if (selectedKecamatan && desaByKecamatan[selectedKecamatan]) {
                        desaByKecamatan[selectedKecamatan].forEach(desa => {
                            desaSelect.add(new Option(desa, desa));
                        });
                    }
                });
            }
            
            // Untuk filter dropdowns
            ['filterDesa'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                select.add(new Option('Semua Desa', ''));
                desaList.forEach(desa => select.add(new Option(desa, desa)));
            });
        }
        
        function fillFilterDropdownsForDataTable() {
            // Fill kecamatan filter for data table
            const kecFilter = document.getElementById('filterKecamatanData');
            if (kecFilter) {
                kecFilter.innerHTML = '';
                kecFilter.add(new Option('Semua Kecamatan', ''));
                kecamatanList.forEach(kec => kecFilter.add(new Option(kec, kec)));
            }
            
            // Fill desa filter for data table
            const desaFilter = document.getElementById('filterDesaData');
            if (desaFilter) {
                desaFilter.innerHTML = '';
                desaFilter.add(new Option('Semua Desa', ''));
                desaList.forEach(desa => desaFilter.add(new Option(desa, desa)));
            }
        }

        // --- AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            if (isBlocked) return showNotification('Akses diblokir sementara karena terlalu banyak percobaan.', 'error');
            
            const securityCodeInput = document.getElementById('securityCode').value;
            const loginButton = document.getElementById('loginButton');
            
            if (!loginButton) return;
            
            loginButton.disabled = true;
            const loginSpinner = document.getElementById('loginSpinner');
            if (loginSpinner) loginSpinner.classList.remove('d-none');
            
            const loginButtonText = document.querySelector('.login-button-text');
            if (loginButtonText) loginButtonText.textContent = 'Memverifikasi...';
            
            setTimeout(() => {
                if (securityCodeInput === appSettings.securityCode) {
                    try {
                        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        if (loginModal) loginModal.hide();
                        
                        showWelcomeMessage();
                    } catch (error) {
                        console.error('Error hiding login modal:', error);
                    }
                } else {
                    loginAttempts++;
                    updateAttemptsCount();
                    
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.classList.add('login-shake');
                        setTimeout(() => loginForm.classList.remove('login-shake'), 600);
                    }
                    
                    if (loginAttempts >= 3) {
                        blockAccess();
                    } else {
                        showNotification(`Kode keamanan salah. Sisa percobaan: ${3 - loginAttempts}.`, 'error');
                    }
                }

                loginButton.disabled = false;
                if (loginSpinner) loginSpinner.classList.add('d-none');
                if (loginButtonText) loginButtonText.textContent = 'MASUK SISTEM';
            }, 500);
        }
        
        function showWelcomeMessage() {
            try {
                const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                if (!welcomeMessage) return;
                
                const hours = new Date().getHours();
                let greeting = '';
                if (hours < 11) greeting = 'Pagi';
                else if (hours < 15) greeting = 'Siang';
                else if (hours < 19) greeting = 'Sore';
                else greeting = 'Malam';
                
                welcomeMessage.innerHTML = `
                    <strong>Selamat ${greeting}!</strong><br>
                    Selamat datang di Sistem Bantuan Nelayan Kabupaten Situbondo.<br>
                    <small class="text-white-75">Login sebagai Administrator - Akses penuh</small>
                `;
                
                welcomeModal.show();
            } catch (error) {
                console.error('Error showing welcome modal:', error);
            }
        }
        
        function handleWelcomeReload() {
            try {
                const welcomeModal = bootstrap.Modal.getInstance(document.getElementById('welcomeModal'));
                if (welcomeModal) welcomeModal.hide();
                
                handleReloadFromRepo();
                
                setTimeout(() => {
                    document.getElementById('appContent').style.display = 'block';
                    showNotification('Selamat datang! Sistem siap digunakan.', 'success');
                }, 1000);
            } catch (error) {
                console.error('Error in welcome reload:', error);
            }
        }
        
        function handleSkipReload() {
            try {
                const welcomeModal = bootstrap.Modal.getInstance(document.getElementById('welcomeModal'));
                if (welcomeModal) welcomeModal.hide();
                
                document.getElementById('appContent').style.display = 'block';
                showNotification('Selamat datang! Sistem siap digunakan.', 'success');
            } catch (error) {
                console.error('Error in skip reload:', error);
            }
        }
        
        function togglePasswordVisibility(btn, inputId) {
            const passwordInput = document.getElementById(inputId);
            if (!passwordInput) return;
            
            const icon = btn.querySelector('i');
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            icon.classList.toggle('fa-eye', !isPassword);
            icon.classList.toggle('fa-eye-slash', isPassword);
        }
        
        function updateAttemptsCount() {
            const attemptsEl = document.getElementById('attemptsCount');
            const blockedMessage = document.getElementById('blockedMessage');
            
            if (attemptsEl) {
                attemptsEl.style.display = loginAttempts > 0 && !isBlocked ? 'block' : 'none';
                attemptsEl.textContent = `Percobaan gagal: ${loginAttempts}/3`;
            }
            
            if (blockedMessage) {
                blockedMessage.classList.toggle('d-none', !isBlocked);
            }
        }
        
        function blockAccess() {
            isBlocked = true;
            updateAttemptsCount();
            showNotification('Akses diblokir selama 30 detik.', 'error');
            
            let countdown = 30;
            const countdownElement = document.getElementById('countdown');
            
            blockTimeout = setInterval(() => {
                countdown--;
                if (countdownElement) countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(blockTimeout);
                    isBlocked = false;
                    loginAttempts = 0;
                    updateAttemptsCount();
                }
            }, 1000);
        }
        
        function logout() {
            autoBackupData();
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                document.getElementById('appContent').style.display = 'none';
                const securityCodeInput = document.getElementById('securityCode');
                if (securityCodeInput) securityCodeInput.value = '';
                
                try {
                    new bootstrap.Modal(document.getElementById('loginModal')).show();
                } catch (error) {
                    console.error('Error showing login modal:', error);
                }
                
                showNotification('Anda telah berhasil logout.', 'info');
            }
        }
        
        // --- SECURITY & PRIVACY LOGIC ---
        function requestHighSecurityAction(callback) {
            pendingSecurityAction = callback;
            const universalPinInput = document.getElementById('universalPinInput');
            const universalPinError = document.getElementById('universalPinError');
            
            if (universalPinInput) universalPinInput.value = '';
            if (universalPinError) universalPinError.style.display = 'none';
            
            try {
                new bootstrap.Modal(document.getElementById('universalPinModal')).show();
            } catch (error) {
                console.error('Error showing universal pin modal:', error);
            }
        }

        function handleUniversalPinSubmit() {
            const pinInput = document.getElementById('universalPinInput');
            const pinError = document.getElementById('universalPinError');
            
            if (!pinInput || !pinError) return;
            
            const pin = pinInput.value;
            if (pin === SECURITY_CONSTANTS.PIN) {
                try {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('universalPinModal'));
                    if (modal) modal.hide();
                    
                    if (pendingSecurityAction) {
                        pendingSecurityAction();
                        pendingSecurityAction = null;
                    }
                } catch (error) {
                    console.error('Error hiding universal pin modal:', error);
                }
            } else {
                pinError.style.display = 'block';
                pinInput.classList.add('is-invalid');
            }
        }

        function handlePrivacyToggle(e) {
            const toggle = e.target;
            
            // Jika user baru saja meng-uncheck (ingin mematikan sensor)
            if (!toggle.checked) {
                // Tahan dulu secara visual (tetapkan kembali ke true sampai password benar)
                toggle.checked = true;
                
                // Buka modal minta password
                const privacyPasswordInput = document.getElementById('privacyPasswordInput');
                const privacyError = document.getElementById('privacyError');
                
                if (privacyPasswordInput) privacyPasswordInput.value = '';
                if (privacyError) privacyError.style.display = 'none';
                
                try {
                    const authModal = new bootstrap.Modal(document.getElementById('privacyAuthModal'));
                    authModal.show();
                } catch (error) {
                    console.error('Error showing privacy auth modal:', error);
                }
            } else {
                // Jika user baru saja men-check (ingin menyalakan sensor)
                appSettings.privacyMode = true;
                saveSettings();
                renderDataTable();
                renderFilterTable();
                showNotification('Sensor Data diaktifkan.', 'success');
            }
        }

        function checkPrivacyPassword() {
            const input = document.getElementById('privacyPasswordInput');
            const errorElement = document.getElementById('privacyError');
            
            if (!input || !errorElement) return;
            
            const password = input.value;
            
            if (password === SECURITY_CONSTANTS.PIN) { 
                appSettings.privacyMode = false;
                saveSettings();
                
                const privacyToggle = document.getElementById('privacyToggle');
                if (privacyToggle) privacyToggle.checked = false;
                
                try {
                    const modalEl = document.getElementById('privacyAuthModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                } catch (error) {
                    console.error('Error hiding privacy auth modal:', error);
                }
                
                renderDataTable();
                renderFilterTable();
                showNotification('Sensor Data dinonaktifkan. NIK dan No HP terlihat.', 'warning');
            } else {
                errorElement.style.display = 'block';
                input.classList.add('is-invalid');
            }
        }

        function cancelPrivacyChange() {
            const privacyToggle = document.getElementById('privacyToggle');
            if (privacyToggle) privacyToggle.checked = true;
        }

        function formatPrivacy(value) {
            if (!appSettings.privacyMode) return value;
            if (!value) return '-';
            const str = String(value);
            if (str.length <= 4) return '****';
            return str.slice(0, -4) + '****';
        }
        
        // --- FITUR DETAIL DATA ---
        function showDetailData(id) {
            const data = appData.find(item => item.id === id);
            if (!data) return;
            
            // Apply privacy mode
            const nikDisplay = formatPrivacy(data.nik);
            const whatsappDisplay = data.whatsapp ? `+62 ${formatPrivacy(data.whatsapp)}` : '-';
            
            // Fill modal with data
            const elements = {
                'detailNama': data.nama || '-',
                'detailNik': nikDisplay,
                'detailWhatsapp': whatsappDisplay,
                'detailKelompok': data.namaKelompok || '-',
                'detailJabatan': data.jabatan || '-',
                'detailTahun': data.tahunAnggaran || '-',
                'detailKecamatan': data.kecamatan || '-',
                'detailDesa': data.desa || '-',
                'detailAlamat': data.alamat || '-',
                'detailJenisBantuan': data.jenisBantuan || '-',
                'detailNamaBantuan': data.namaBantuan || '-',
                'detailJumlahBantuan': `${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}`,
                'detailTanggal': formatDate(data.tanggalTerima) || '-',
                'detailPetugas': data.namaPetugas || '-',
                'detailKodeValidasi': data.kodeValidasi || '-',
                'detailKeterangan': data.keterangan || '-'
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = elements[id];
            });
            
            // Handle Google Drive link
            const driveLink = data.driveLink || '-';
            const driveLinkElement = document.getElementById('detailDriveLink');
            if (driveLinkElement) {
                if (driveLink !== '-' && driveLink.startsWith('http')) {
                    driveLinkElement.innerHTML = `<a href="${driveLink}" target="_blank" class="drive-link">${driveLink}</a>`;
                } else {
                    driveLinkElement.textContent = driveLink;
                }
            }
            
            // Show modal
            try {
                const detailModal = new bootstrap.Modal(document.getElementById('detailDataModal'));
                detailModal.show();
            } catch (error) {
                console.error('Error showing detail modal:', error);
            }
        }
        
        // --- FORM HANDLING & VALIDATION ---
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                showNotification('Harap perbaiki data yang salah pada formulir.', 'error');
                return;
            }
            
            const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
            const isEditing = !!editId;

            const formData = {
                id: isEditing ? parseInt(editId) : Date.now(),
                nama: document.getElementById('nama').value.trim(),
                nik: document.getElementById('nik').value.trim(),
                whatsapp: document.getElementById('whatsapp').value.replace(/\D/g, ''),
                namaKelompok: document.getElementById('namaKelompok').value.trim() || 'Individu',
                jabatan: document.getElementById('jabatan').value,
                tahunAnggaran: document.getElementById('tahunAnggaran').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alamat: document.getElementById('alamat').value.trim(),
                jenisBantuan: document.getElementById('jenisBantuan').value,
                namaBantuan: document.getElementById('namaBantuan').value.trim(),
                jumlahBantuan: document.getElementById('jumlahBantuan').value,
                satuanBantuan: document.getElementById('satuanBantuan').value,
                tanggalTerima: document.getElementById('tanggalTerima').value,
                namaPetugas: document.getElementById('namaPetugas').value.trim(),
                driveLink: document.getElementById('driveLink').value.trim(),
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value.trim(),
                tanggalInput: isEditing 
                    ? appData.find(item => item.id === parseInt(editId))?.tanggalInput 
                    : new Date().toISOString()
            };
            
            if (isEditing) {
                const index = appData.findIndex(item => item.id === parseInt(editId));
                if (index > -1) {
                    appData[index] = formData;
                    showNotification('Data berhasil diperbarui!', 'success');
                }
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan!', 'success');
            }
            
            saveData();
            resetForm();
            updateDashboard();
            renderDataTable();
            
            try {
                new bootstrap.Tab(document.getElementById('v-pills-data-tab')).show();
            } catch (error) {
                console.error('Error switching to data tab:', error);
            }
        }

        function resetForm() {
            document.getElementById('inputForm').reset();
            document.getElementById('inputForm').removeAttribute('data-edit-id');
            
            const elements = {
                'jabatan': 'Individu',
                'namaKelompok': '',
                'tahunAnggaran': appSettings.defaultTahun,
                'tanggalTerima': new Date().toISOString().split('T')[0],
                'kodeValidasi': ''
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = elements[id];
            });
            
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Reset desa dropdown
            const desaSelect = document.getElementById('desa');
            if (desaSelect) {
                desaSelect.innerHTML = '<option value="">Pilih Desa</option>';
            }
        }

        function setError(id, message) {
            const element = document.getElementById(id);
            if (element) element.classList.add('input-error');
            
            const errorEl = document.getElementById(`${id}Error`);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }
        }

        function clearError(id) {
            const element = document.getElementById(id);
            if (element) element.classList.remove('input-error');
            
            const errorEl = document.getElementById(`${id}Error`);
            if (errorEl) errorEl.style.display = 'none';
        }

        function validateForm() {
            let isValid = true;
            const requiredFields = ['nama', 'nik', 'whatsapp', 'namaPetugas', 'namaBantuan', 'jumlahBantuan', 'kodeValidasi', 'kecamatan', 'desa', 'tanggalTerima'];
            
            requiredFields.forEach(id => {
                const element = document.getElementById(id);
                if (element && !element.value.trim()) {
                    setError(id, 'Kolom ini wajib diisi.');
                    isValid = false;
                }
            });

            const nik = document.getElementById('nik').value.trim();
            if (nik && !/^\d{16}$/.test(nik)) {
                setError('nik', 'NIK harus terdiri dari 16 digit angka.');
                isValid = false;
            } else if (isNikExists(nik)) {
                setError('nik', 'NIK ini sudah terdaftar di sistem.');
                isValid = false;
            }

            const whatsapp = document.getElementById('whatsapp').value.replace(/\D/g, '');
            if (whatsapp && !/^\d{9,13}$/.test(whatsapp)) {
                setError('whatsapp', 'Nomor WhatsApp tidak valid (9-13 digit).');
                isValid = false;
            }

            const driveLink = document.getElementById('driveLink').value.trim();
            if (driveLink && !/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(driveLink)) {
                setError('driveLink', 'Format URL Google Drive tidak valid.');
                isValid = false;
            }

            return isValid;
        }

        function isNikExists(nik) {
            const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
            return appData.some(data => data.nik === nik && data.id !== (editId ? parseInt(editId) : null));
        }
        
        function setBukanKelompok() {
            const namaKelompok = document.getElementById('namaKelompok');
            const jabatan = document.getElementById('jabatan');
            
            if (namaKelompok) namaKelompok.value = 'Individu';
            if (jabatan) jabatan.value = 'Individu';
        }

        function handleJabatanChange() {
            const jabatan = document.getElementById('jabatan').value;
            const namaKelompok = document.getElementById('namaKelompok');
            if (jabatan === 'Individu') {
                if (namaKelompok) namaKelompok.value = 'Individu';
            } else if (namaKelompok && namaKelompok.value.toLowerCase() === 'individu') {
                namaKelompok.value = '';
            }
        }
        
        function generateKodeValidasi() {
            const nikInput = document.getElementById('nik');
            const nik = nikInput.value.trim();
            clearError('nik');

            if (!/^\d{16}$/.test(nik)) {
                setError('nik', 'Isi NIK dengan 16 digit angka sebelum generate kode.');
                showNotification('NIK tidak valid untuk generate kode.', 'error');
                return;
            }
            if (isNikExists(nik)) {
                setError('nik', 'NIK ini sudah terdaftar, tidak bisa generate kode baru.');
                showNotification('NIK sudah terdaftar.', 'error');
                return;
            }

            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            
            const kodeValidasi = document.getElementById('kodeValidasi');
            if (kodeValidasi) kodeValidasi.value = result;
            
            clearError('kodeValidasi');
            showNotification('Kode validasi berhasil digenerate.', 'success');
        }
        
        function updateSatuanBantuan() {
            const jenis = document.getElementById('jenisBantuan').value;
            const satuanSelect = document.getElementById('satuanBantuan');
            if (!satuanSelect) return;
            
            const options = {
                'Uang': ['Rupiah'],
                'Barang': ['Unit', 'Paket', 'Set', 'Buah', 'Ekor'],
                'Jasa': ['Jam', 'Hari', 'Paket', 'Kegiatan']
            };
            satuanSelect.innerHTML = (options[jenis] || []).map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }
        
        // --- DATA PERSISTENCE ---
        function loadData() {
            try {
                const savedData = localStorage.getItem('barjasData');
                appData = savedData ? JSON.parse(savedData) : [];
                const savedCodes = localStorage.getItem('barjasGeneratedCodes');
                generatedCodes = savedCodes ? JSON.parse(savedCodes) : {};
            } catch (e) {
                console.error("Gagal memuat data:", e);
                appData = [];
                generatedCodes = {};
            }
            renderDataTable();
        }
        
        function saveData() {
            try {
                localStorage.setItem('barjasData', JSON.stringify(appData));
                localStorage.setItem('barjasGeneratedCodes', JSON.stringify(generatedCodes));
            } catch (e) {
                console.error("Gagal menyimpan data:", e);
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('barjasSettings');
            if (savedSettings) {
                try {
                    const loaded = JSON.parse(savedSettings);
                    Object.assign(appSettings, loaded);
                    // SECURITY FIX: Jika kode keamanan kosong atau tidak valid, paksa kembali ke default
                    if (!appSettings.securityCode || appSettings.securityCode.trim() === '') {
                        appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
                        console.warn("Kode keamanan direset ke default karena kosong.");
                    }
                } catch(e) {
                     appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS; // Force default on error
                }
            } else {
                 appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS; // Init default
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('barjasSettings', JSON.stringify(appSettings));
            } catch (e) {
                console.error("Gagal menyimpan pengaturan:", e);
            }
        }

        function applySettingsToUI() {
            const elements = {
                'itemsPerPage': appSettings.itemsPerPage,
                'notifications': appSettings.notifications,
                'appName': appSettings.appName,
                'appSubtitle': appSettings.appSubtitle,
                'defaultTahun': appSettings.defaultTahun,
                'privacyToggle': appSettings.privacyMode
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = elements[id];
                    } else {
                        element.value = elements[id];
                    }
                }
            });
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            
            const newSecurityCode = document.getElementById('settingSecurityCode').value;
            if (newSecurityCode && newSecurityCode.trim() !== "") {
                appSettings.securityCode = newSecurityCode;
            }
            
            appSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value) || 25;
            appSettings.notifications = document.getElementById('notifications').checked;
            appSettings.appName = document.getElementById('appName').value;
            appSettings.appSubtitle = document.getElementById('appSubtitle').value;
            appSettings.defaultTahun = document.getElementById('defaultTahun').value;

            saveSettings();
            applySettingsToUI();
            showNotification('Pengaturan berhasil disimpan.', 'success');
            renderDataTable();
            
            const appTitle = document.querySelector('.app-title');
            const appSubtitle = document.querySelector('.app-subtitle');
            
            if (appTitle) appTitle.innerHTML = appSettings.appName.replace(/\n/g, '<br>');
            if (appSubtitle) appSubtitle.textContent = appSettings.appSubtitle;
            
            // Clear password field for security
            const settingSecurityCode = document.getElementById('settingSecurityCode');
            if (settingSecurityCode) settingSecurityCode.value = '';
        }
        
        // --- DATA TABLE ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const dataToRender = isFilterActive ? filteredData : appData;
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToRender.length);
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="18" class="text-center py-4">Tidak ada data</td></tr>`;
                
                const tableInfo = document.getElementById('tableInfo');
                if (tableInfo) tableInfo.textContent = 'Menampilkan 0 dari 0 data';
                
                const pagination = document.getElementById('pagination');
                if (pagination) pagination.innerHTML = '';
                
                return;
            }
            
            for (let i = startIndex; i < endIndex; i++) {
                const data = dataToRender[i];
                const row = document.createElement('tr');
                
                const nikDisplay = formatPrivacy(data.nik);
                const whatsappRaw = data.whatsapp ? `0${data.whatsapp}` : '-';
                const whatsappDisplay = formatPrivacy(whatsappRaw);
                
                const whatsappLink = appSettings.privacyMode ? 'javascript:void(0)' : `https://wa.me/62${data.whatsapp}`;
                const whatsappClass = appSettings.privacyMode ? 'text-muted text-decoration-none' : 'whatsapp-number';
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';
                
                // Tombol aksi
                let actionButtons = `
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-info text-white" onclick="showDetailData(${data.id})" title="Lihat Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning text-white" onclick="editData(${data.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteData(${data.id})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold text-primary">${data.nama}</td>
                    <td class="${privacyClass}">${nikDisplay}</td>
                    <td><a href="${whatsappLink}" target="${appSettings.privacyMode ? '_self' : '_blank'}" class="${whatsappClass}">${whatsappDisplay}</a></td>
                    <td>${data.namaKelompok || '-'}</td>
                    <td>${data.jabatan || '-'}</td>
                    <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td>
                    <td>${data.desa}</td>
                    <td><span class="badge bg-info">${data.jenisBantuan}</span></td>
                    <td>${data.namaBantuan || '-'}</td>
                    <td class="fw-bold">${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td>
                    <td>${data.namaPetugas || '-'}</td>
                    <td>${data.driveLink ? `<a href="${data.driveLink}" class="drive-link" target="_blank"><i class="fas fa-external-link-alt"></i> Buka</a>` : '-'}</td>
                    <td><span class="badge bg-secondary">${data.kodeValidasi}</span></td>
                    <td>${actionButtons}</td>
                `;
                tableBody.appendChild(row);
            }
            
            const tableInfo = document.getElementById('tableInfo');
            if (tableInfo) {
                tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${dataToRender.length} data`;
            }
            
            updatePagination(dataToRender.length);
        }
        
        function updatePagination(totalItems) {
            const paginationEl = document.getElementById('pagination');
            if (!paginationEl) return;
            
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationEl.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageItem = (page, text, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page}); return false;">${text}</a>`;
                return li;
            };

            paginationEl.appendChild(createPageItem(currentPage - 1, '<i class="fas fa-chevron-left"></i>', currentPage === 1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationEl.appendChild(createPageItem(i, i, false, i === currentPage));
            }

            paginationEl.appendChild(createPageItem(currentPage + 1, '<i class="fas fa-chevron-right"></i>', currentPage === totalPages));
        }
        
        function changePage(page) {
            const dataToRender = isFilterActive ? filteredData : appData;
            const totalPages = Math.ceil(dataToRender.length / (parseInt(appSettings.itemsPerPage) || 25));
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderDataTable();
            }
        }
        
        function handleSearch() {
            const searchTerm = document.getElementById('searchData').value.toLowerCase();
            const filterKecamatan = document.getElementById('filterKecamatanData').value;
            const filterDesa = document.getElementById('filterDesaData').value;
            
            isFilterActive = !!searchTerm || !!filterKecamatan || !!filterDesa;
            
            filteredData = appData.filter(d => {
                const matchesSearch = !searchTerm || Object.values(d).some(v => 
                    String(v).toLowerCase().includes(searchTerm)
                );
                const matchesKecamatan = !filterKecamatan || d.kecamatan === filterKecamatan;
                const matchesDesa = !filterDesa || d.desa === filterDesa;
                
                return matchesSearch && matchesKecamatan && matchesDesa;
            });
            
            currentPage = 1;
            renderDataTable();
        }
        
        function handleDataTableFilter() {
            handleSearch();
        }
        
        function clearSearch() {
            const searchData = document.getElementById('searchData');
            const filterKecamatanData = document.getElementById('filterKecamatanData');
            const filterDesaData = document.getElementById('filterDesaData');
            
            if (searchData) searchData.value = '';
            if (filterKecamatanData) filterKecamatanData.value = '';
            if (filterDesaData) filterDesaData.value = '';
            
            handleSearch();
        }
        
        // --- FILTER ---
        function applyFilter() {
            const filters = {
                tahun: document.getElementById('filterTahun')?.value || '',
                kecamatan: document.getElementById('filterKecamatan')?.value || '',
                desa: document.getElementById('filterDesa')?.value || '',
                jenis: document.getElementById('filterJenis')?.value || '',
            };
            
            filteredData = appData.filter(d => 
                (!filters.tahun || d.tahunAnggaran == filters.tahun) &&
                (!filters.kecamatan || d.kecamatan === filters.kecamatan) &&
                (!filters.desa || d.desa === filters.desa) &&
                (!filters.jenis || d.jenisBantuan === filters.jenis)
            );
            
            renderFilterTable();
            
            const filterResultCount = document.getElementById('filterResultCount');
            if (filterResultCount) {
                filterResultCount.textContent = `${filteredData.length} Data`;
            }
            
            showNotification(`Filter diterapkan. Ditemukan ${filteredData.length} data.`, 'success');
        }
        
        function resetFilter() {
            ['filterTahun', 'filterKecamatan', 'filterDesa', 'filterJenis'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            filteredData = [];
            renderFilterTable();
            
            const filterResultCount = document.getElementById('filterResultCount');
            if (filterResultCount) {
                filterResultCount.textContent = '0 Data';
            }
            
            showNotification('Filter direset.', 'info');
        }
        
        function renderFilterTable() {
            const tableBody = document.getElementById('filterTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" class="text-center py-4">Tidak ada data yang sesuai</td></tr>`;
                return;
            }
            
            filteredData.forEach((data, i) => {
                const nikDisplay = formatPrivacy(data.nik);
                const whatsappRaw = data.whatsapp ? `0${data.whatsapp}` : '-';
                const whatsappDisplay = formatPrivacy(whatsappRaw);
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td> <td>${data.nama}</td> 
                    <td class="${privacyClass}">${nikDisplay}</td> 
                    <td>${whatsappDisplay}</td>
                    <td>${data.namaKelompok || '-'}</td> <td>${data.jabatan || '-'}</td> <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td> <td>${data.desa}</td> <td>${data.jenisBantuan}</td>
                    <td>${data.namaBantuan || '-'}</td> <td>${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td> <td>${data.namaPetugas || '-'}</td>
                    <td>${data.driveLink ? 'Ya' : 'Tidak'}</td> <td>${data.kodeValidasi}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- CRUD ACTIONS ---
        function editData(id) {
            const data = appData.find(item => item.id === id);
            if (!data) return;
            
            Object.keys(data).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = data[key];
            });

            const whatsappInput = document.getElementById('whatsapp');
            if (whatsappInput) whatsappInput.value = data.whatsapp; 
            
            document.getElementById('inputForm').setAttribute('data-edit-id', id);
            
            try {
                new bootstrap.Tab(document.getElementById('v-pills-input-tab')).show();
            } catch (error) {
                console.error('Error switching to input tab:', error);
            }
            
            window.scrollTo(0, 0);
            showNotification('Mode edit aktif. Klik "Simpan Data" setelah selesai.', 'info');
        }
        
        function deleteData(id) {
            if (confirm('Konfirmasi: Anda yakin ingin menghapus data ini?')) {
                requestHighSecurityAction(() => {
                    appData = appData.filter(item => item.id !== id);
                    saveData();
                    showNotification('Data berhasil dihapus.', 'success');
                    updateDashboard();
                    renderDataTable();
                });
            }
        }
        
        // --- DASHBOARD ---
        function updateDashboard() {
            const totalPenerima = document.getElementById('totalPenerima');
            const totalBantuan = document.getElementById('totalBantuan');
            const tahunAktif = document.getElementById('tahunAktif');
            const rataBantuan = document.getElementById('rataBantuan');
            
            if (totalPenerima) totalPenerima.textContent = formatNumber(appData.length);
            
            const uangData = appData.filter(d => d.jenisBantuan === 'Uang');
            const totalBantuanValue = uangData.reduce((sum, d) => sum + (parseFloat(d.jumlahBantuan) || 0), 0);
            
            if (totalBantuan) totalBantuan.textContent = `Rp ${formatNumber(totalBantuanValue)}`;
            
            const tahunCount = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const tahunAktifValue = Object.keys(tahunCount).reduce((a, b) => tahunCount[a] > tahunCount[b] ? a : b, appSettings.defaultTahun);
            
            if (tahunAktif) tahunAktif.textContent = tahunAktifValue;
            
            const rataBantuanValue = uangData.length > 0 ? totalBantuanValue / uangData.length : 0;
            
            if (rataBantuan) rataBantuan.textContent = `Rp ${formatNumber(rataBantuanValue.toFixed(0))}`;
            
            updateCharts();
            updateRecentData();
        }
        
        function updateRecentData() {
            const recentDataContainer = document.getElementById('recentData');
            if (!recentDataContainer) return;
            
            recentDataContainer.innerHTML = '';
            const recent = [...appData].sort((a, b) => new Date(b.tanggalInput) - new Date(a.tanggalInput)).slice(0, 5);
            
            if (recent.length === 0) {
                recentDataContainer.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>`;
                return;
            }
            
            recent.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(d.tanggalInput)}</td> <td>${d.nama}</td> <td>${d.desa}</td>
                    <td>${d.jenisBantuan}</td> <td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td>
                `;
                recentDataContainer.appendChild(row);
            });
        }
        
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js tidak tersedia');
                return;
            }
            
            Chart.defaults.font.family = "'Inter', sans-serif";
            const pieCtx = document.getElementById('kecamatanChart')?.getContext('2d');
            if (pieCtx) {
                window.kecamatanChart = new Chart(pieCtx, { 
                    type: 'pie', 
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'right' 
                            } 
                        } 
                    } 
                });
            }
            
            const barCtx = document.getElementById('tahunChart')?.getContext('2d');
            if (barCtx) {
                window.tahunChart = new Chart(barCtx, { 
                    type: 'bar', 
                    options: { 
                        responsive: true, 
                        scales: { 
                            y: { 
                                beginAtZero: true 
                            } 
                        } 
                    } 
                });
            }
        }
        
        function updateCharts() {
            if (!appData || appData.length === 0) return;

            const kecamatanData = appData.reduce((acc, d) => ({...acc, [d.kecamatan]: (acc[d.kecamatan] || 0) + 1}), {});
            if (window.kecamatanChart) {
                window.kecamatanChart.data = {
                    labels: Object.keys(kecamatanData),
                    datasets: [{ 
                        data: Object.values(kecamatanData), 
                        backgroundColor: ['#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226'] 
                    }]
                };
                window.kecamatanChart.update();
            }
            
            const tahunData = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const sortedYears = Object.keys(tahunData).sort();
            if (window.tahunChart) {
                window.tahunChart.data = {
                    labels: sortedYears,
                    datasets: [{ 
                        label: 'Jumlah Penerima', 
                        data: sortedYears.map(year => tahunData[year]), 
                        backgroundColor: '#0a9396' 
                    }]
                };
                window.tahunChart.update();
            }
        }
        
        // --- PRINT & EXPORT ---
        function getFilteredDataForExport(prefix) {
            const filters = {
                tahun: document.getElementById(`${prefix}Tahun`)?.value || '',
                kecamatan: document.getElementById(`${prefix}Kecamatan`)?.value || '',
                jenis: document.getElementById(`${prefix}Jenis`)?.value || '',
            };
            
            if (!filters.tahun && !filters.kecamatan && !filters.jenis) return appData;

            return appData.filter(d => 
                (!filters.tahun || d.tahunAnggaran == filters.tahun) &&
                (!filters.kecamatan || d.kecamatan === filters.kecamatan) &&
                (!filters.jenis || d.jenisBantuan === filters.jenis)
            );
        }

        function printToPdf() {
            const dataToPrint = getFilteredDataForExport('print');
            if (dataToPrint.length === 0) return showNotification('Tidak ada data untuk dicetak sesuai filter.', 'warning');
            
            if (typeof window.jspdf === 'undefined') {
                showNotification('Library jsPDF tidak tersedia.', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'pt', 'a4');
            
            doc.setFontSize(16);
            doc.text(appSettings.appName, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            doc.setFontSize(12);
            doc.text(appSettings.appSubtitle, doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });
            
            const cols = ["No", "Nama", "NIK", "Desa", "Kecamatan", "Nama Bantuan", "Jumlah", "Tanggal"];
            const rows = dataToPrint.map((d, i) => [
                i + 1, d.nama, 
                formatPrivacy(d.nik), 
                d.desa, d.kecamatan, d.namaBantuan || '-',
                `${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}`, formatDate(d.tanggalTerima)
            ]);
            
            doc.autoTable({ 
                head: [cols], 
                body: rows, 
                startY: 80, 
                theme: 'grid', 
                headStyles: { 
                    fillColor: [0, 95, 115] 
                } 
            });
            
            doc.save(`laporan_nelayan_${new Date().toISOString().slice(0,10)}.pdf`);
            showNotification('Laporan PDF berhasil diunduh.', 'success');
        }
        
        function showPreview() {
            const dataToPreview = getFilteredDataForExport('print');
            if (dataToPreview.length === 0) return showNotification('Tidak ada data untuk pratinjau sesuai filter.', 'warning');

            const previewModalTitle = document.getElementById('previewModalTitle');
            const previewContent = document.getElementById('previewContent');
            
            if (!previewModalTitle || !previewContent) return;
            
            previewModalTitle.textContent = `Pratinjau Laporan (${dataToPreview.length} data)`;
            
            let content = `
                <div class="print-header text-center mb-4">
                    <h4>${appSettings.appName}</h4>
                    <p class="mb-1">${appSettings.appSubtitle}</p>
                    <p class="text-muted">Tanggal: ${formatDate(new Date().toISOString())}</p>
                </div>
                <table class="preview-table"><thead><tr>
                    <th>No</th><th>Nama</th><th>NIK</th><th>Desa</th><th>Nama Bantuan</th><th>Jumlah</th><th>Tanggal</th>
                </tr></thead><tbody>`;

            dataToPreview.forEach((d, i) => {
                content += `<tr>
                    <td>${i + 1}</td><td>${d.nama}</td><td>${formatPrivacy(d.nik)}</td><td>${d.desa}</td>
                    <td>${d.namaBantuan}</td><td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td><td>${formatDate(d.tanggalTerima)}</td>
                </tr>`;
            });

            content += `</tbody></table>`;
            previewContent.innerHTML = content;
            
            try {
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            } catch (error) {
                console.error('Error showing preview modal:', error);
            }
        }

        function exportData(format) {
            const dataToExport = getFilteredDataForExport('export');
            if (dataToExport.length === 0) return showNotification('Tidak ada data untuk diekspor sesuai filter.', 'warning');

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `data_nelayan_${timestamp}`;

            switch(format) {
                case 'excel':
                    if (typeof XLSX === 'undefined') {
                        showNotification('Library XLSX tidak tersedia.', 'error');
                        return;
                    }
                    
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Data');
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                    break;
                    
                case 'csv':
                    if (typeof XLSX === 'undefined') {
                        showNotification('Library XLSX tidak tersedia.', 'error');
                        return;
                    }
                    
                    const csvWs = XLSX.utils.json_to_sheet(dataToExport);
                    const csv = XLSX.utils.sheet_to_csv(csvWs);
                    downloadFile(csv, 'text/csv', `${filename}.csv`);
                    break;
                    
                case 'json':
                    downloadFile(JSON.stringify(dataToExport, null, 2), 'application/json', `${filename}.json`);
                    break;
                    
                case 'pdf':
                    if (typeof window.jspdf === 'undefined') {
                        showNotification('Library jsPDF tidak tersedia.', 'error');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape', 'pt', 'a4');
                    doc.text('DATA BANTUAN NELAYAN', doc.internal.pageSize.getWidth()/2, 40, {align: 'center'});
                    doc.autoTable({ 
                        body: dataToExport, 
                        startY: 60, 
                        theme: 'grid', 
                        headStyles: { 
                            fillColor: [0, 95, 115] 
                        } 
                    });
                    doc.save(`${filename}.pdf`);
                    break;
            }
            showNotification(`Data berhasil diekspor ke format ${format.toUpperCase()}.`, 'success');
        }

        function downloadFile(content, mimeType, filename) {
            try {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('Gagal mengunduh file.', 'error');
            }
        }

        // --- FITUR BARU: EKSTRAK DATA UNTUK PETA STATISTIK - DIPERBAIKI ---
        function generateDataPeta() {
            const securityCode = document.getElementById('extractSecurityCode').value;
            const errorElement = document.getElementById('extractSecurityCodeError');
            
            if (securityCode !== SECURITY_CONSTANTS.EXTRACT_CODE) {
                if (errorElement) errorElement.style.display = 'block';
                showNotification('Kode keamanan salah.', 'error');
                return;
            }
            
            if (errorElement) errorElement.style.display = 'none';
            
            if (appData.length === 0) {
                // Jika tidak ada data di appData, gunakan data contoh
                generatedPetaData = SAMPLE_DATA;
                
                // Tampilkan preview
                const extractPreviewSection = document.getElementById('extractPreviewSection');
                const extractPreview = document.getElementById('extractPreview');
                const koordinatDetails = document.getElementById('koordinatDetails');
                
                if (extractPreviewSection) extractPreviewSection.style.display = 'block';
                if (extractPreview) extractPreview.innerHTML = JSON.stringify(generatedPetaData, null, 2);
                
                if (koordinatDetails) {
                    koordinatDetails.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Data contoh digunakan karena database kosong. Setiap penerima dalam data contoh telah dilengkapi dengan koordinat maps desa mereka.
                        </div>
                    `;
                }
                
                showNotification('Menggunakan data contoh karena database kosong.', 'warning');
                return;
            }
            
            // Proses data untuk statistik per desa DENGAN KOORDINAT MAPS
            const dataByDesa = {};
            
            appData.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                
                if (!dataByDesa[key]) {
                    dataByDesa[key] = {
                        desa: item.desa,
                        kecamatan: item.kecamatan,
                        jumlahPenerima: 0,
                        jenisBantuan: {},
                        totalBantuanUang: 0,
                        totalBantuanBarang: 0,
                        totalBantuanJasa: 0,
                        tahunDistribusi: {},
                        kelompokDistribusi: {},
                        detailPenerima: [],
                        statistik: {
                            uang: { jumlah: 0, nilai: 0 },
                            barang: { jumlah: 0, nilai: 0 },
                            jasa: { jumlah: 0, nilai: 0 }
                        }
                    };
                }
                
                // Update statistik
                dataByDesa[key].jumlahPenerima++;
                
                // Update jenis bantuan
                if (!dataByDesa[key].jenisBantuan[item.jenisBantuan]) {
                    dataByDesa[key].jenisBantuan[item.jenisBantuan] = 0;
                }
                dataByDesa[key].jenisBantuan[item.jenisBantuan]++;
                
                // Update distribusi tahun
                if (!dataByDesa[key].tahunDistribusi[item.tahunAnggaran]) {
                    dataByDesa[key].tahunDistribusi[item.tahunAnggaran] = 0;
                }
                dataByDesa[key].tahunDistribusi[item.tahunAnggaran]++;
                
                // Update distribusi kelompok
                const kelompok = item.namaKelompok || 'Individu';
                if (!dataByDesa[key].kelompokDistribusi[kelompok]) {
                    dataByDesa[key].kelompokDistribusi[kelompok] = 0;
                }
                dataByDesa[key].kelompokDistribusi[kelompok]++;
                
                // Update statistik detail
                const jumlah = parseFloat(item.jumlahBantuan) || 0;
                if (item.jenisBantuan === 'Uang') {
                    dataByDesa[key].totalBantuanUang += jumlah;
                    dataByDesa[key].statistik.uang.jumlah++;
                    dataByDesa[key].statistik.uang.nilai += jumlah;
                } else if (item.jenisBantuan === 'Barang') {
                    dataByDesa[key].totalBantuanBarang += jumlah;
                    dataByDesa[key].statistik.barang.jumlah++;
                    dataByDesa[key].statistik.barang.nilai += jumlah;
                } else if (item.jenisBantuan === 'Jasa') {
                    dataByDesa[key].totalBantuanJasa += jumlah;
                    dataByDesa[key].statistik.jasa.jumlah++;
                    dataByDesa[key].statistik.jasa.nilai += jumlah;
                }
                
                // Tambah detail penerima DENGAN ALAMAT LENGKAP dan KOORDINAT
                const alamatLengkap = `${item.alamat || ''}, Desa ${item.desa}, Kecamatan ${item.kecamatan}, Kabupaten Situbondo`;
                
                // Dapatkan koordinat untuk desa ini
                const koordinatKey = `${item.desa}, ${item.kecamatan}`;
                let koordinat = koordinatDesa[koordinatKey];
                
                // Jika koordinat desa tidak ditemukan, gunakan koordinat kecamatan
                if (!koordinat) {
                    koordinat = koordinatKecamatan[item.kecamatan];
                    
                    // Jika koordinat kecamatan juga tidak ditemukan, gunakan koordinat default Situbondo
                    if (!koordinat) {
                        koordinat = { lat: -7.7062, lng: 113.9603 }; // Pusat Kabupaten Situbondo
                    }
                }
                
                // Buat link Google Maps
                const mapsLink = `https://www.google.com/maps?q=${koordinat.lat},${koordinat.lng}&z=15`;
                
                dataByDesa[key].detailPenerima.push({
                    nama: item.nama,
                    nik: formatPrivacy(item.nik),
                    whatsapp: formatPrivacy(item.whatsapp),
                    jenisBantuan: item.jenisBantuan,
                    namaBantuan: item.namaBantuan,
                    jumlah: item.jumlahBantuan,
                    satuan: item.satuanBantuan,
                    tahun: item.tahunAnggaran,
                    kelompok: item.namaKelompok || 'Individu',
                    jabatan: item.jabatan || '-',
                    tanggal: formatDate(item.tanggalTerima),
                    petugas: item.namaPetugas,
                    alamat: alamatLengkap,
                    koordinat: koordinat,
                    mapsLink: mapsLink
                });
            });
            
            // Konversi ke array dan format untuk peta DENGAN KOORDINAT LENGKAP
            const dataPeta = {
                metadata: {
                    generatedAt: new Date().toISOString(),
                    timestamp: Date.now(),
                    totalDesa: Object.keys(dataByDesa).length,
                    totalPenerima: appData.length,
                    sumber: 'Sistem Bantuan Nelayan Kab. Situbondo',
                    instansi: 'Dinas Peternakan dan Perikanan Kab. Situbondo',
                    bidang: 'Pemberdayaan Nelayan',
                    versi: '2.0',
                    lastUpdate: new Date().toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    koordinatSumber: 'Database Koordinat Resmi Kabupaten Situbondo'
                },
                summary: {
                    totalBantuanUang: Object.values(dataByDesa).reduce((sum, d) => sum + d.totalBantuanUang, 0),
                    totalBantuanBarang: Object.values(dataByDesa).reduce((sum, d) => sum + d.totalBantuanBarang, 0),
                    totalBantuanJasa: Object.values(dataByDesa).reduce((sum, d) => sum + d.totalBantuanJasa, 0),
                    desaTerbanyak: Object.entries(dataByDesa).sort((a, b) => b[1].jumlahPenerima - a[1].jumlahPenerima)[0] || null,
                    desaDenganKoordinat: Object.values(dataByDesa).filter(d => {
                        const key = `${d.desa}, ${d.kecamatan}`;
                        return koordinatDesa[key] || koordinatKecamatan[d.kecamatan];
                    }).length
                },
                data: Object.values(dataByDesa).map(item => {
                    // Format jenis bantuan untuk peta
                    const jenisBantuanFormatted = Object.keys(item.jenisBantuan).map(jenis => ({
                        jenis: jenis,
                        jumlah: item.jenisBantuan[jenis]
                    }));
                    
                    // Format tahun distribusi
                    const tahunDistribusiFormatted = Object.keys(item.tahunDistribusi).map(tahun => ({
                        tahun: tahun,
                        jumlah: item.tahunDistribusi[tahun]
                    }));
                    
                    // Format kelompok distribusi
                    const kelompokDistribusiFormatted = Object.keys(item.kelompokDistribusi).map(kelompok => ({
                        kelompok: kelompok,
                        jumlah: item.kelompokDistribusi[kelompok]
                    }));
                    
                    // Get coordinates from database with fallback mechanism
                    const key = `${item.desa}, ${item.kecamatan}`;
                    let koordinat = koordinatDesa[key];
                    
                    // Jika koordinat desa tidak ditemukan, gunakan koordinat kecamatan
                    if (!koordinat) {
                        koordinat = koordinatKecamatan[item.kecamatan];
                        
                        // Jika koordinat kecamatan juga tidak ditemukan, gunakan koordinat default Situbondo
                        if (!koordinat) {
                            koordinat = { lat: -7.7062, lng: 113.9603 }; // Pusat Kabupaten Situbondo
                        }
                    }
                    
                    // Buat link Google Maps untuk desa
                    const mapsLink = `https://www.google.com/maps?q=${koordinat.lat},${koordinat.lng}&z=15`;
                    
                    return {
                        ...item,
                        id: key.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase(),
                        jenisBantuan: jenisBantuanFormatted,
                        tahunDistribusi: tahunDistribusiFormatted,
                        kelompokDistribusi: kelompokDistribusiFormatted,
                        koordinat: koordinat,
                        mapsLink: mapsLink,
                        totalBantuan: item.totalBantuanUang + item.totalBantuanBarang + item.totalBantuanJasa,
                        rataBantuan: item.jumlahPenerima > 0 ? 
                            (item.totalBantuanUang + item.totalBantuanBarang + item.totalBantuanJasa) / item.jumlahPenerima : 0,
                        warnaIntensitas: Math.min(1, item.jumlahPenerima / Math.max(...Object.values(dataByDesa).map(d => d.jumlahPenerima))),
                        popupContent: `
                            <strong>${item.desa}, ${item.kecamatan}</strong><br>
                            Jumlah Penerima: ${item.jumlahPenerima}<br>
                            Total Bantuan: Rp ${formatNumber(item.totalBantuanUang + item.totalBantuanBarang + item.totalBantuanJasa)}<br>
                            Uang: ${item.statistik.uang.jumlah} penerima (Rp ${formatNumber(item.totalBantuanUang)})<br>
                            Barang: ${item.statistik.barang.jumlah} penerima (${formatNumber(item.totalBantuanBarang)} unit)<br>
                            Jasa: ${item.statistik.jasa.jumlah} penerima (${formatNumber(item.totalBantuanJasa)} paket)<br>
                            <a href="${mapsLink}" target="_blank" style="color: #005f73; font-weight: bold;">
                                <i class="fas fa-map-marker-alt"></i> Lihat di Google Maps
                            </a>
                        `
                    };
                })
            };
            
            // Simpan data untuk preview dan download
            generatedPetaData = dataPeta;
            
            // Tampilkan preview dengan informasi koordinat
            const extractPreviewSection = document.getElementById('extractPreviewSection');
            const extractPreview = document.getElementById('extractPreview');
            const koordinatDetails = document.getElementById('koordinatDetails');
            
            if (extractPreviewSection) extractPreviewSection.style.display = 'block';
            if (extractPreview) extractPreview.innerHTML = JSON.stringify(dataPeta, null, 2);
            
            // Tampilkan detail koordinat untuk setiap desa
            if (koordinatDetails) {
                let koordinatHTML = '<h6>Koordinat Maps untuk Setiap Desa:</h6>';
                
                dataPeta.data.forEach((desaData, index) => {
                    koordinatHTML += `
                        <div class="koordinat-info mb-3">
                            <strong>${index + 1}. ${desaData.desa}, ${desaData.kecamatan}</strong><br>
                            <small>Latitude: ${desaData.koordinat.lat}, Longitude: ${desaData.koordinat.lng}</small><br>
                            <small>Jumlah Penerima: ${desaData.jumlahPenerima} orang</small><br>
                            <a href="${desaData.mapsLink}" target="_blank" class="small">
                                <i class="fas fa-external-link-alt"></i> Buka di Google Maps
                            </a>
                        </div>
                    `;
                });
                
                koordinatDetails.innerHTML = koordinatHTML;
            }
            
            showNotification('Data peta berhasil digenerate dengan koordinat maps untuk setiap desa!', 'success');
        }
        
        function downloadDataPeta() {
            if (!generatedPetaData) {
                showNotification('Generate data terlebih dahulu.', 'warning');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 10);
            const fileContent = `// DATA PETA STATISTIK NELAYAN KAB. SITUBONDO
// Generated: ${new Date().toLocaleString('id-ID')}
// Total Desa: ${generatedPetaData.metadata.totalDesa}
// Total Penerima: ${generatedPetaData.metadata.totalPenerima}
// Desa dengan Koordinat: ${generatedPetaData.summary.desaDenganKoordinat}
// Sumber: ${generatedPetaData.metadata.sumber}
// Koordinat Sumber: ${generatedPetaData.metadata.koordinatSumber}
// Last Update: ${generatedPetaData.metadata.lastUpdate}

window.DATA_PETA_STATISTIK = ${JSON.stringify(generatedPetaData, null, 2)};

// Fungsi untuk memuat data peta
function loadDataPetaStatistik() {
    if (typeof DATA_PETA_STATISTIK !== 'undefined') {
        console.log('Data peta statistik berhasil dimuat:', DATA_PETA_STATISTIK);
        return DATA_PETA_STATISTIK;
    }
    return null;
}

// Fungsi untuk mendapatkan data berdasarkan desa
function getDataByDesa(namaDesa, kecamatan) {
    if (!DATA_PETA_STATISTIK || !DATA_PETA_STATISTIK.data) return null;
    
    return DATA_PETA_STATISTIK.data.find(item => 
        item.desa === namaDesa && item.kecamatan === kecamatan
    );
}

// Fungsi untuk mendapatkan data berdasarkan kecamatan
function getDataByKecamatan(kecamatan) {
    if (!DATA_PETA_STATISTIK || !DATA_PETA_STATISTIK.data) return [];
    
    return DATA_PETA_STATISTIK.data.filter(item => item.kecamatan === kecamatan);
}

// Fungsi untuk mendapatkan koordinat desa
function getKoordinatDesa(namaDesa, kecamatan) {
    const data = getDataByDesa(namaDesa, kecamatan);
    return data ? data.koordinat : null;
}

// Fungsi untuk mendapatkan semua data kecamatan
function getAllKecamatanData() {
    if (!DATA_PETA_STATISTIK || !DATA_PETA_STATISTIK.data) return {};
    
    const result = {};
    DATA_PETA_STATISTIK.data.forEach(item => {
        if (!result[item.kecamatan]) {
            result[item.kecamatan] = {
                kecamatan: item.kecamatan,
                jumlahDesa: 0,
                jumlahPenerima: 0,
                totalBantuan: 0,
                desa: []
            };
        }
        result[item.kecamatan].jumlahDesa++;
        result[item.kecamatan].jumlahPenerima += item.jumlahPenerima;
        result[item.kecamatan].totalBantuan += item.totalBantuan;
        result[item.kecamatan].desa.push(item);
    });
    
    return result;
}

// Fungsi untuk membuat link Google Maps
function createGoogleMapsLink(lat, lng, zoom = 15) {
    return \`https://www.google.com/maps?q=\${lat},\${lng}&z=\${zoom}\`;
}

// Fungsi untuk update data secara realtime
function updatePetaData(newData) {
    if (!DATA_PETA_STATISTIK || !newData) return false;
    
    // Logika update data
    console.log('Memperbarui data peta...');
    return true;
}

// Ekspor untuk penggunaan global
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        DATA_PETA_STATISTIK,
        loadDataPetaStatistik,
        getDataByDesa,
        getDataByKecamatan,
        getKoordinatDesa,
        getAllKecamatanData,
        createGoogleMapsLink,
        updatePetaData
    };
}`;

            try {
                const blob = new Blob([fileContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'datapeta.js';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('File datapeta.js berhasil didownload! Berisi koordinat maps untuk setiap desa.', 'success');
            } catch (error) {
                console.error('Error downloading datapeta.js:', error);
                showNotification('Gagal mengunduh file datapeta.js.', 'error');
            }
        }

        // --- BACKUP (RELOAD.JS) & RESTORE ---
        function autoBackupData() {
            if (appData.length === 0) return;
            appSettings.lastBackupDate = new Date().toLocaleDateString('id-ID');
            saveSettings();
        }

        function backupData() {
            if (appData.length === 0) return showNotification('Tidak ada data untuk dibackup.', 'warning');
            
            // 1. Siapkan data JSON
            const dataToBackup = { appData, appSettings, generatedCodes, koordinatDesa, koordinatKecamatan };
            
            // 2. Enkripsi ke Base64
            const encryptedString = btoa(unescape(encodeURIComponent(JSON.stringify(dataToBackup))));
            
            // 3. Buat konten file JS with NEW APP NAME
            const timestamp = new Date().toLocaleString('id-ID');
            const appNameFull = "APLIKASI BARJAS BIDANG PEMBERDAYAAN NELAYAN";
            
            const fileContent = `/* PETUNJUK PENGGUNAAN RELOAD REPO:
    1. Ini adalah file backup otomatis dari Aplikasi.
    2. Jangan ubah kode di dalam tanda petik dua ("...") di bawah.
    3. Upload file ini ke hosting tempat aplikasi berjalan untuk fitur Reload Data.
    
    APP NAME : ${appNameFull}
    TANGGAL  : ${timestamp}
*/

window.BARJAS_BACKUP_ENCRYPTED = "${encryptedString}";
`;

            // 4. Download sebagai reload.js
            downloadFile(fileContent, 'text/javascript', 'reload.js');
            
            // Update timestamp
            appSettings.lastBackupDate = new Date().toLocaleDateString('id-ID');
            saveSettings();
            applySettingsToUI();
            showNotification('Backup file (reload.js) berhasil diunduh.', 'success');
        }
        
        function handleReloadFromRepo() {
            if(!confirm("Apakah Anda yakin ingin me-reload data dari repository? Data lokal akan digabungkan dengan data baru.")) return;
            
            const btn = document.getElementById('btn-reload-repo');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin feature-icon"></i> Loading...';
            btn.disabled = true;

            const oldScript = document.getElementById('reload-script');
            if(oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'reload-script';
            script.src = './reload.js?v=' + new Date().getTime(); 

            script.onload = function() {
                try {
                    if (window.BARJAS_BACKUP_ENCRYPTED) {
                        const rawContent = window.BARJAS_BACKUP_ENCRYPTED;
                        let restored;
                        try {
                            if (typeof rawContent === 'string') {
                                restored = JSON.parse(decodeURIComponent(escape(atob(rawContent))));
                            } else {
                                restored = rawContent;
                            }
                        } catch (decryptionError) {
                            throw new Error("Gagal mendekripsi data.");
                        }
                        
                        // LOGIKA MERGE DATA
                        if(restored && restored.appData && Array.isArray(restored.appData)) {
                            
                            const existingIds = new Set(appData.map(item => item.id));
                            let addedCount = 0;

                            restored.appData.forEach(newItem => {
                                if (!existingIds.has(newItem.id)) {
                                    appData.push(newItem);
                                    existingIds.add(newItem.id); 
                                    addedCount++;
                                }
                            });

                            if(restored.generatedCodes) {
                                generatedCodes = { ...restored.generatedCodes, ...generatedCodes }; 
                            }
                            
                            // Update koordinat jika ada
                            if(restored.koordinatDesa) {
                                Object.assign(koordinatDesa, restored.koordinatDesa);
                            }
                            
                            // Update koordinat kecamatan jika ada
                            if(restored.koordinatKecamatan) {
                                Object.assign(koordinatKecamatan, restored.koordinatKecamatan);
                            }

                            saveData();
                            saveSettings();
                            applySettingsToUI();
                            updateDashboard();
                            renderDataTable();
                            
                            if (addedCount > 0) {
                                showNotification(`Berhasil reload! ${addedCount} data baru ditambahkan.`, 'success');
                            } else {
                                showNotification('Reload selesai. Tidak ada data baru yang ditemukan.', 'info');
                            }

                        } else {
                            throw new Error('Format data tidak valid.');
                        }
                    } else {
                        throw new Error('Variabel backup tidak ditemukan di reload.js.');
                    }
                } catch (e) {
                    showNotification('Error: ' + e.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    delete window.BARJAS_BACKUP_ENCRYPTED;
                }
            };

            script.onerror = function() {
                showNotification('Gagal memuat file reload.js. Pastikan file ada di folder yang sama.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            };
            document.body.appendChild(script);
        }

        function enableRestoreButton() {
            const restoreDataBtn = document.getElementById('restoreDataBtn');
            if (restoreDataBtn) {
                restoreDataBtn.disabled = !this.files.length;
            }
        }
        
        function restoreData() {
            const file = document.getElementById('restoreFileInput').files[0];
            if (!file || !confirm('PENTING: Restore akan menimpa semua data. Lanjutkan?')) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const content = e.target.result;
                    let restored;
                    
                    // Cek apakah file reload.js (mengandung window.BARJAS...) atau JSON biasa
                    if (content.includes('window.BARJAS_BACKUP_ENCRYPTED')) {
                        // Extract string dalam tanda petik
                        const match = content.match(/window\.BARJAS_BACKUP_ENCRYPTED\s*=\s*"([^"]+)"/);
                        if (match && match[1]) {
                            restored = JSON.parse(decodeURIComponent(escape(atob(match[1]))));
                        } else {
                            throw new Error("Format reload.js tidak valid.");
                        }
                    } else {
                        // Coba parse sebagai JSON biasa (legacy backup)
                        try {
                            restored = JSON.parse(decodeURIComponent(escape(atob(content))));
                        } catch (err) {
                            restored = JSON.parse(content);
                        }
                    }

                    if (restored && restored.appData && restored.appSettings) {
                        appData = restored.appData;
                        Object.assign(appSettings, restored.appSettings);
                        
                        // PASTIKAN KODE KEAMANAN TETAP DEFAULT JIKA KOSONG SETELAH RESTORE
                         if (!appSettings.securityCode || appSettings.securityCode.trim() === '') {
                             appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
                         }

                        generatedCodes = restored.generatedCodes || {};
                        
                        // Update koordinat jika ada
                        if(restored.koordinatDesa) {
                            Object.assign(koordinatDesa, restored.koordinatDesa);
                        }
                        
                        // Update koordinat kecamatan jika ada
                        if(restored.koordinatKecamatan) {
                            Object.assign(koordinatKecamatan, restored.koordinatKecamatan);
                        }
                        
                        saveData();
                        saveSettings();
                        applySettingsToUI();
                        document.getElementById('restoreFileInput').value = '';
                        
                        const restoreDataBtn = document.getElementById('restoreDataBtn');
                        if (restoreDataBtn) restoreDataBtn.disabled = true;
                        
                        updateDashboard();
                        renderDataTable();
                        showNotification('Data berhasil direstore.', 'success');
                    } else {
                        throw new Error("Struktur data tidak valid.");
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Gagal merestore data. File mungkin rusak.', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function enableResetButton() {
            const confirmResetBtn = document.getElementById('confirmResetBtn');
            if (confirmResetBtn) {
                confirmResetBtn.disabled = this.value !== 'RESET';
            }
        }
        
        function performFactoryReset() {
            appData = [];
            generatedCodes = {};
            // Reset Settings tapi pertahankan default password
            appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
            saveData();
            saveSettings();
            
            const resetConfirmationInput = document.getElementById('resetConfirmationInput');
            if (resetConfirmationInput) resetConfirmationInput.value = '';
            
            updateDashboard();
            renderDataTable();
            showNotification('Data telah direset!', 'warning');
        }

        // --- UTILS ---
        function setupBrowserInfo() {
            const agent = navigator.userAgent;
            let browserName = "Unknown";
            if (agent.indexOf("Firefox") > -1) browserName = "Firefox";
            else if (agent.indexOf("Chrome") > -1) browserName = "Chrome";
            else if (agent.indexOf("Safari") > -1) browserName = "Safari";
            
            const browserInfo = document.getElementById('browserInfo');
            if (browserInfo) browserInfo.textContent = browserName;
            
            try {
                const usedStorage = (JSON.stringify(localStorage).length / 1024).toFixed(2);
                const storageInfo = document.getElementById('storageInfo');
                if (storageInfo) storageInfo.textContent = `${usedStorage} KB`;
            } catch (e) {
                const storageInfo = document.getElementById('storageInfo');
                if (storageInfo) storageInfo.textContent = 'Error';
            }
        }
        
        function toggleMobileMenu() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarMenu) sidebarMenu.classList.toggle('mobile-show');
            if (sidebarOverlay) sidebarOverlay.classList.toggle('mobile-show');
        }
        
        function showNotification(message, type = 'info') {
            if (!appSettings.notifications) return;
            
            const toastEl = document.querySelector('.notification-toast');
            if (!toastEl) return;
            
            const toastHeader = toastEl.querySelector('.toast-header');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toastMessage) return;
            
            toastMessage.textContent = message;
            
            const styles = {
                success: { bg: 'bg-success-subtle', text: 'text-success-emphasis', title: 'Berhasil' },
                error: { bg: 'bg-danger-subtle', text: 'text-danger-emphasis', title: 'Gagal' },
                warning: { bg: 'bg-warning-subtle', text: 'text-warning-emphasis', title: 'Peringatan' },
                info: { bg: 'bg-primary-subtle', text: 'text-primary-emphasis', title: 'Informasi' }
            };
            
            if (toastHeader) {
                toastHeader.className = `toast-header ${styles[type].bg} ${styles[type].text}`;
            }
            
            if (toastTitle) {
                toastTitle.textContent = styles[type].title;
            }
            
            try {
                new bootstrap.Toast(toastEl).show();
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function formatNumber(num) {
            if (isNaN(num) || num === undefined || num === null) return num; 
            try {
                return new Intl.NumberFormat('id-ID').format(num);
            } catch (error) {
                return num;
            }
        }

        // Ekspor fungsi ke global scope untuk aksi dari HTML
        window.showDetailData = showDetailData;
        window.editData = editData;
        window.deleteData = deleteData;
        window.triggerSmartMenu = triggerSmartMenu;
        window.changePage = changePage;
    </script>
</body>
</html>
[file content end]
