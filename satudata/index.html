<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM PEMETAAN DATA NELAYAN - DESA KILENSARI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Palette: Ocean Deep Blue & Sandy Gold */
            --primary-color: #1a4f6e; /* Deep Ocean */
            --secondary-color: #2b7a8f; /* Shallow Water */
            --accent-color: #d68c45; /* Sandy Gold */
            
            --dark-blue: #0f2c3e;
            --light-bg: #f4f7f9;
            
            --gradient-primary: linear-gradient(135deg, #0f2c3e 0%, #1a4f6e 50%, #2b7a8f 100%);
            --gradient-header: linear-gradient(120deg, #0f2c3e 0%, #1a4f6e 40%, #2b7a8f 70%, #d68c45 100%);
            --gradient-secondary: linear-gradient(135deg, #2b7a8f, #57a0b3);
            --gradient-accent: linear-gradient(135deg, #d68c45, #f4a261);
            
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.15);
            
            --glass-effect: rgba(255, 255, 255, 0.96);
        }
        
        body {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Header */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 35px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #d68c45;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .app-logo {
            font-size: 3.5rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            background: linear-gradient(to bottom, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: #ffecd1;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
            padding-top: 10px;
        }
        
        /* Navigation */
        .col-md-3.col-lg-2.bg-light {
            background-color: #f8f9fa !important;
            border-right: 1px solid #e9ecef;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 14px 20px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #e3f2fd;
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-left: 4px solid #d68c45;
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
            color: white;
        }
        
        /* Content Styling */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid #d68c45;
            padding-left: 15px;
            margin: 25px 0;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 1.6rem;
            position: relative;
            background: linear-gradient(to right, rgba(214, 140, 69, 0.1), transparent);
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Buttons */
        .btn { border-radius: 8px; font-weight: 600; font-family: 'Montserrat', sans-serif; padding: 10px 20px; }
        .btn-primary { background: var(--gradient-primary); border: none; box-shadow: 0 4px 6px rgba(26, 79, 110, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #0f2c3e 0%, #16425b 100%); transform: translateY(-2px); }
        .btn-success { background: var(--gradient-secondary); border: none; }
        .btn-warning { background: var(--gradient-accent); color: white; border: none; }

        /* Forms */
        .form-label { font-weight: 600; color: #2b2d42; font-size: 0.9rem; }
        .form-control, .form-select { border-radius: 8px; padding: 12px 15px; border: 1px solid #ced4da; font-size: 0.95rem; }
        .form-control:focus, .form-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(43, 122, 143, 0.2); }
        .form-control:read-only { background-color: #e9ecef; cursor: not-allowed; }
        
        /* Tables */
        .data-table { border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); border: none; white-space: nowrap; }
        .data-table th { background: linear-gradient(90deg, #1a4f6e, #2b7a8f) !important; color: white; padding: 15px 10px; border: none; }
        .data-table td { border-bottom: 1px solid #e9ecef; padding: 12px 10px; font-size: 0.9rem; }
        .data-table tr:hover { background-color: #e0f2f1; }
        
        /* Cards */
        .card { border-radius: 15px; border: none; box-shadow: var(--shadow-sm); background: white; margin-bottom: 20px; }
        .card-header { background: linear-gradient(90deg, #1a4f6e, #0f2c3e); color: white; font-weight: 600; border-radius: 15px 15px 0 0 !important; padding: 15px 20px; }
        
        .stats-box { background: white; border-radius: 15px; box-shadow: var(--shadow-md); border-left: 5px solid var(--accent-color); transition: transform 0.3s; }
        .stats-box:hover { transform: translateY(-5px); }
        .stats-number { color: var(--primary-color); font-family: 'Montserrat', sans-serif; }
        
        /* Special Sections */
        .ship-details-container {
            background-color: #f8fbff;
            border: 1px dashed var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .ship-details-container::before {
            content: "Data Spesifik Kapal";
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            padding: 2px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Login Modal */
        .login-header { background: var(--gradient-header); border-bottom: 4px solid #d68c45; padding: 20px; }
        .btn-login { background: linear-gradient(90deg, #1a4f6e, #2b7a8f, #d68c45); background-size: 200% auto; transition: 0.5s; }
        .btn-login:hover { background-position: right center; }

        /* Utils */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1050; min-width: 280px; }
        .input-error { border-color: #dc3545 !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important; }
        .error-message { color: #dc3545; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: 500; }
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.8; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-weight: 300; letter-spacing: 1px;}
        
        .whatsapp-input-container { position: relative; }
        .whatsapp-prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-weight: 500; }
        .whatsapp-input { padding-left: 45px !important; }
        
        .floating-action-btn { position: fixed; right: 25px; bottom: 25px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; z-index: 1045; background: var(--gradient-accent); border: none; box-shadow: 0 5px 15px rgba(214, 140, 69, 0.4); font-size: 1.5rem;}
        .floating-action-btn:hover { transform: scale(1.1); }
        
        /* Mobile */
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; }
            .col-md-3.col-lg-2 { position: fixed; left: -300px; top: 0; bottom: 0; z-index: 1050; width: 280px; transition: left 0.3s ease; overflow-y: auto; padding-top: 60px; background: white; }
            .col-md-3.col-lg-2.mobile-show { left: 0; }
            .mobile-menu-btn { display: flex; position: fixed; top: 15px; left: 15px; z-index: 1050; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; align-items: center; justify-content: center; }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
            .sidebar-overlay.mobile-show { display: block; }
        }
        
        .privacy-blurred { color: #6c757d; letter-spacing: 2px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="modal fade login-modal" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: none;">
                <div class="login-header">
                    <div class="text-center mb-2">
                        <i class="fas fa-ship fa-3x text-warning" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));"></i>
                    </div>
                    <h2 class="text-center text-white fw-bold mb-0" style="font-family: 'Montserrat'; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">SATU DATA NELAYAN</h2>
                    <p class="text-center text-white-50 mb-0 small">Desa Kilensari - Kec. Panarukan</p>
                </div>
                <div class="login-body p-4">
                    <form id="loginForm">
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-shield-alt me-2 text-primary"></i> Kode Akses (Auto)
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control text-center fw-bold" id="securityCode" value="KilensariMaju2025" readonly style="padding: 12px; letter-spacing: 3px;">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            </div>
                            <div class="small text-muted text-center mt-2">
                                <i class="fas fa-info-circle"></i> Sistem Login Tanpa Password Manual
                            </div>
                        </div>
                        <button type="submit" class="btn btn-login text-white w-100 py-3 fw-bold shadow-sm" id="loginButton">
                            <span class="login-button-text">MASUK APLIKASI</span>
                            <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
                        </button>
                    </form>
                    <div class="text-center mt-4 small text-muted">
                        &copy; 2025 Pemerintah Desa Kilensari
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="app-container">
            <div class="app-header">
                <div class="app-logo"><i class="fas fa-anchor"></i></div>
                <h1 class="app-title">SISTEM APLIKASI PEMETAAN DATA NELAYAN<br>TINGKAT DESA</h1>
                <p class="app-subtitle">PEMERINTAH KABUPATEN SITUBONDO DESA KILENSARI KECAMATAN PANARUKAN</p>
                <div class="watermark">One Data System v3.0</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-4 bg-light" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input"><i class="fas fa-pencil-alt me-2"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data"><i class="fas fa-database me-2"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter"><i class="fas fa-filter me-2"></i> Filter Data</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print"><i class="fas fa-print me-2"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export"><i class="fas fa-file-export me-2"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup"><i class="fas fa-download me-2"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings"><i class="fas fa-cog me-2"></i> Pengaturan</button>
                        <button class="nav-link text-danger mt-3" id="v-pills-logout-tab" style="border: 1px solid #dc3545;"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-5">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard">
                            <h3 class="section-title">Dashboard Overview</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Nelayan</div>
                                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold" id="totalPenerima">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: var(--secondary-color);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Estimasi Pendapatan/Bln</div>
                                            <i class="fas fa-money-bill-wave fa-2x text-success opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-success" id="totalBantuan">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #ffc107;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Tahun Data</div>
                                            <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-warning" id="tahunAktif">2025</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #17a2b8;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Rata-rata Pendapatan</div>
                                            <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-info" id="rataBantuan">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Distribusi Profesi Nelayan</div>
                                        <div class="card-body"><canvas id="profesiChart" height="250"></canvas></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Distribusi Peran (ABK vs Pemilik)</div>
                                        <div class="card-body"><canvas id="peranChart" height="250"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-input">
                            <h3 class="section-title">Formulir Data Nelayan</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-pencil-alt me-2"></i> Data Identitas & Profesi</div>
                                <div class="card-body p-4">
                                    <form id="inputForm" novalidate>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="nama" class="form-label"><i class="fas fa-user text-primary me-2"></i> Nama Lengkap</label>
                                                <input type="text" class="form-control" id="nama" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="nik" class="form-label"><i class="fas fa-id-card text-primary me-2"></i> NIK</label>
                                                <input type="text" class="form-control" id="nik" required maxlength="16">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="whatsapp" class="form-label"><i class="fab fa-whatsapp text-success me-2"></i> Nomor WhatsApp</label>
                                                <div class="whatsapp-input-container">
                                                    <span class="whatsapp-prefix">+62</span>
                                                    <input type="tel" class="form-control whatsapp-input" id="whatsapp" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="profesi" class="form-label"><i class="fas fa-fish text-primary me-2"></i> Profesi</label>
                                                <select class="form-select" id="profesi" required>
                                                    <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                    <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="sebagai" class="form-label"><i class="fas fa-user-tag text-primary me-2"></i> Sebagai</label>
                                                <select class="form-select" id="sebagai" required>
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="tahunLahir" class="form-label"><i class="fas fa-birthday-cake text-primary me-2"></i> Tahun Kelahiran</label>
                                                <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" min="1900" max="2100" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="usia" class="form-label"><i class="fas fa-hourglass-half text-primary me-2"></i> Usia (Tahun)</label>
                                                <input type="text" class="form-control" id="usia" readonly placeholder="Otomatis">
                                            </div>
                                        </div>

                                        <div id="kapalFields" class="ship-details-container" style="display:none;">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Nama Kapal</label>
                                                    <input type="text" class="form-control" id="namaKapal">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Jenis Kapal</label>
                                                    <select class="form-select" id="jenisKapal">
                                                        <option value="Perahu Jukung">Perahu Jukung</option>
                                                        <option value="Perahu Mayang">Perahu Mayang</option>
                                                        <option value="Perahu Slerek">Perahu Slerek</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Spesifikasi Ukuran Kapal</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="ukuranKapal" placeholder="Contoh: 6">
                                                        <span class="input-group-text fw-bold">GT</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Spesifikasi Mesin Kapal</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="mesinKapal" placeholder="Contoh: 12">
                                                        <span class="input-group-text fw-bold">PK</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">Jenis Alat Tangkap</label>
                                                    <select class="form-select" id="alatTangkap">
                                                        <option value="Jaring Lingkar (Purse Seine)">Jaring Lingkar (Purse Seine)</option>
                                                        <option value="Jaring Insang (Gill Net)">Jaring Insang (Gill Net)</option>
                                                        <option value="Jaring Angkat (Lift Net)">Jaring Angkat (Lift Net)</option>
                                                        <option value="Pancing">Pancing</option>
                                                        <option value="Perangkap Bubu / Sero (Trap)">Perangkap Bubu / Sero (Trap)</option>
                                                        <option value="Pukat Hela (Trawl Net)">Pukat Hela (Trawl Net)</option>
                                                        <option value="Pukat Tarik (Seine Net)">Pukat Tarik (Seine Net)</option>
                                                        <option value="Penggaruk (Dredge)">Penggaruk (Dredge)</option>
                                                        <option value="Tembak Ikan">Tembak Ikan</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label d-block">Apakah Punya BPKP / PAS KAPAL?</label>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="statusPas" id="pasYes" value="ya">
                                                    <label class="form-check-label" for="pasYes">Iya</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="statusPas" id="pasNo" value="tidak">
                                                    <label class="form-check-label" for="pasNo">Tidak</label>
                                                </div>
                                            </div>
                                            
                                            <div id="pasInputContainer" class="mt-2" style="display:none;">
                                                <label class="form-label">Nomor PAS KAPAL</label>
                                                <input type="text" class="form-control" id="nomorPasKapal" placeholder="Masukkan Nomor Dokumen">
                                            </div>
                                            
                                            <div id="pasAlertContainer" class="alert alert-warning alert-dismissible fade show mt-2" role="alert" style="display:none;">
                                                <strong>Peringatan!</strong> Segera urus BPKP dan PAS KAPAL Anda di dinas terkait.
                                                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="kecamatan" class="form-label"><i class="fas fa-map-marker-alt text-primary me-2"></i> Kecamatan</label>
                                                <select class="form-select" id="kecamatan" required disabled>
                                                    <option value="Panarukan" selected>Panarukan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="desa" class="form-label"><i class="fas fa-map-marked-alt text-primary me-2"></i> Desa</label>
                                                <select class="form-select" id="desa" required disabled>
                                                    <option value="Kilensari" selected>Kilensari</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="alamat" class="form-label"><i class="fas fa-home text-primary me-2"></i> Alamat Lengkap (Dusun/RT/RW)</label>
                                            <textarea class="form-control" id="alamat" rows="1"></textarea>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="jenisIkan" class="form-label"><i class="fas fa-fish text-primary me-2"></i> Jenis Ikan Hasil Tangkapan</label>
                                                <input type="text" class="form-control" id="jenisIkan" placeholder="Contoh: Tongkol, Layang, Kerapu">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="pendapatan" class="form-label"><i class="fas fa-coins text-primary me-2"></i> Perkiraan Pendapatan/Bulan</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">Rp</span>
                                                    <input type="text" class="form-control" id="pendapatan" placeholder="0" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="usahaSampingan" class="form-label"><i class="fas fa-store text-primary me-2"></i> Usaha Sampingan (Opsional)</label>
                                            <input type="text" class="form-control" id="usahaSampingan" placeholder="Selain profesi nelayan">
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="tanggalValidasi" class="form-label"><i class="fas fa-calendar-check text-primary me-2"></i> Tanggal Validasi Data</label>
                                                <input type="date" class="form-control" id="tanggalValidasi" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="validator" class="form-label"><i class="fas fa-user-check text-primary me-2"></i> Nama Validator</label>
                                                <input type="text" class="form-control" id="validator" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="driveLink" class="form-label"><i class="fab fa-google-drive text-primary me-2"></i> Link Dokumen (GDrive)</label>
                                                <input type="url" class="form-control" id="driveLink" placeholder="https://...">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="kodeValidasi" class="form-label"><i class="fas fa-qrcode text-primary me-2"></i> Kode Unik</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="kodeValidasi" placeholder="Klik Generate" readonly required>
                                                    <button type="button" class="btn btn-primary" id="generateKodeBtn">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                                            <button type="reset" class="btn btn-light me-2 text-secondary"><i class="fas fa-undo me-1"></i> Reset</button>
                                            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i> Simpan Data</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data">
                            <h3 class="section-title">Database Nelayan Desa Kilensari</h3>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-database me-2"></i> Daftar Nelayan</span>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari data...">
                                        <button class="btn btn-sm btn-light border" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>Profesi</th><th>Peran</th>
                                                    <th>Usia</th><th>Pendapatan</th><th>Jenis Ikan</th><th>Alamat</th>
                                                    <th>Validasi</th><th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="11" class="text-center py-4">Memuat data...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-filter">
                            <h3 class="section-title">Filter Lanjutan</h3>
                            <div class="card mb-4">
                                <div class="card-header"><i class="fas fa-filter me-2"></i> Parameter Filter</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Profesi</label>
                                            <select class="form-select" id="filterProfesi">
                                                <option value="">Semua</option>
                                                <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                <option value="Nelayan Musiman">Nelayan Musiman</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Peran</label>
                                            <select class="form-select" id="filterPeran">
                                                <option value="">Semua</option>
                                                <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                <option value="Pemilik Kapal">Pemilik Kapal</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Rentang Pendapatan</label>
                                            <select class="form-select" id="filterPendapatan">
                                                <option value="">Semua</option>
                                                <option value="low">< 1 Juta</option>
                                                <option value="mid">1 - 3 Juta</option>
                                                <option value="high">> 3 Juta</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <button class="btn btn-secondary me-2" id="resetFilterBtn">Reset</button>
                                        <button class="btn btn-primary" id="applyFilterBtn">Terapkan</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0">
                                            <thead>
                                                <tr><th>No</th><th>Nama</th><th>NIK</th><th>Profesi</th><th>Peran</th><th>Pendapatan</th><th>Validasi</th></tr>
                                            </thead>
                                            <tbody id="filterTableBody"><tr><td colspan="7" class="text-center py-4">Silakan terapkan filter</td></tr></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-print">
                            <h3 class="section-title">Cetak Laporan</h3>
                            <div class="card">
                                <div class="card-body text-center p-5">
                                    <i class="fas fa-print fa-3x text-primary mb-3"></i>
                                    <h5>Cetak Laporan Data Nelayan</h5>
                                    <p>Mencetak data sesuai dengan filter yang aktif atau seluruh data.</p>
                                    <button class="btn btn-primary" id="printPdfBtn">Download PDF</button>
                                    <button class="btn btn-info text-white" id="previewBtn">Preview</button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-export">
                            <h3 class="section-title">Ekspor Data</h3>
                            <div class="row g-3">
                                <div class="col-md-3"><button class="btn btn-success w-100 py-3" id="exportExcelBtn"><i class="fas fa-file-excel fa-lg d-block mb-1"></i> Excel</button></div>
                                <div class="col-md-3"><button class="btn btn-info text-white w-100 py-3" id="exportCsvBtn"><i class="fas fa-file-csv fa-lg d-block mb-1"></i> CSV</button></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-backup">
                            <h3 class="section-title">Backup & Restore</h3>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card p-4 text-center">
                                        <h5>Backup Data</h5>
                                        <button class="btn btn-primary mt-2" id="backupDataBtn">Download Backup</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card p-4 text-center">
                                        <h5>Restore Data</h5>
                                        <input type="file" class="form-control mb-2" id="restoreFileInput">
                                        <button class="btn btn-success" id="restoreDataBtn">Restore</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-settings">
                            <h3 class="section-title">Pengaturan Aplikasi</h3>
                            <div class="card">
                                <div class="card-body">
                                    <form id="settingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Aplikasi</label>
                                                <input type="text" class="form-control" id="appName" value="SISTEM SATU DATA NELAYAN">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Instansi</label>
                                                <input type="text" class="form-control" id="appSubtitle" value="PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN">
                                            </div>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="privacyToggle" checked>
                                            <label class="form-check-label fw-bold">Mode Privasi Data (Sensor NIK & HP)</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <button class="floating-action-btn" id="fabBtn"><i class="fas fa-plus"></i></button>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast notification-toast" role="alert"><div class="toast-header"><strong class="me-auto">Notifikasi</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toastMessage"></div></div>
        </div>
    </div>

    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Pratinjau Dokumen</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><div id="previewContent"></div></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="window.print()">Cetak</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="privacyAuthModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning"><h5 class="modal-title fs-6 fw-bold">PIN Akses</h5><button type="button" class="btn-close" data-bs-dismiss="modal" id="closePrivacyModal"></button></div>
                <div class="modal-body">
                    <input type="password" class="form-control text-center" id="privacyPasswordInput" placeholder="PIN: 17081945">
                    <div class="invalid-feedback d-block text-center mt-2" id="privacyError" style="display:none;">PIN Salah!</div>
                </div>
                <div class="modal-footer p-1"><button type="button" class="btn btn-warning w-100" id="submitPrivacyAuth">Buka</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- VARIABLES ---
        let appData = [];
        let appSettings = {
            appName: 'SISTEM SATU DATA NELAYAN',
            appSubtitle: 'PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN',
            privacyMode: true,
            securityPIN: '17081945'
        };
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];
        let isFilterActive = false;

        // --- LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadSettings();
            setupEvents();
            setupCharts();
            updateDashboard();
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        });

        function setupEvents() {
            // Login (No Password Logic)
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginSpinner').classList.remove('d-none');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('appContent').classList.add('animate-fadeIn');
                    showNotification('Login berhasil! Selamat datang.', 'success');
                }, 800);
            });

            // Form Logic
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('sebagai').addEventListener('change', toggleKapalFields);
            document.querySelectorAll('input[name="statusPas"]').forEach(r => r.addEventListener('change', togglePasFields));
            document.getElementById('tahunLahir').addEventListener('input', calculateUsia);
            document.getElementById('generateKodeBtn').addEventListener('click', generateKode);
            document.getElementById('fabBtn').addEventListener('click', () => document.getElementById('v-pills-input-tab').click());

            // Search & Filter
            document.getElementById('searchData').addEventListener('input', handleSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', () => { document.getElementById('searchData').value=''; handleSearch(); });
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            document.getElementById('resetFilterBtn').addEventListener('click', resetFilter);

            // Settings & Privacy
            document.getElementById('settingsForm').addEventListener('submit', saveSettingsFromForm);
            document.getElementById('privacyToggle').addEventListener('click', handlePrivacyToggle);
            document.getElementById('submitPrivacyAuth').addEventListener('click', checkPrivacyPIN);
            document.getElementById('closePrivacyModal').addEventListener('click', () => document.getElementById('privacyToggle').checked = true);

            // Actions
            document.getElementById('v-pills-logout-tab').addEventListener('click', () => location.reload());
            document.getElementById('printPdfBtn').addEventListener('click', printPdf);
            document.getElementById('previewBtn').addEventListener('click', showPreview);
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('excel'));
            document.getElementById('exportCsvBtn').addEventListener('click', () => exportData('csv'));
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
        }

        // --- FORM LOGIC ENHANCED ---
        function toggleKapalFields() {
            const val = document.getElementById('sebagai').value;
            const container = document.getElementById('kapalFields');
            container.style.display = (val === 'Pemilik Kapal') ? 'block' : 'none';
        }

        function togglePasFields() {
            const val = document.querySelector('input[name="statusPas"]:checked').value;
            document.getElementById('pasInputContainer').style.display = (val === 'ya') ? 'block' : 'none';
            document.getElementById('pasAlertContainer').style.display = (val === 'tidak') ? 'block' : 'none';
        }

        function calculateUsia() {
            const tahun = parseInt(document.getElementById('tahunLahir').value);
            const currentYear = new Date().getFullYear();
            if(tahun > 1900 && tahun <= currentYear) {
                document.getElementById('usia').value = currentYear - tahun;
            }
        }

        function generateKode() {
            const nik = document.getElementById('nik').value;
            if(nik.length < 16) return showNotification('Isi NIK dengan benar dulu!', 'error');
            const code = 'VLD-' + Math.random().toString(36).substr(2, 5).toUpperCase();
            document.getElementById('kodeValidasi').value = code;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                nama: document.getElementById('nama').value,
                nik: document.getElementById('nik').value,
                whatsapp: document.getElementById('whatsapp').value,
                profesi: document.getElementById('profesi').value, // Replaces kelompok
                peran: document.getElementById('sebagai').value, // Replaces jabatan
                tahunLahir: document.getElementById('tahunLahir').value, // Replaces tahun anggaran
                usia: document.getElementById('usia').value,
                
                // Kapal Data
                namaKapal: document.getElementById('namaKapal').value,
                jenisKapal: document.getElementById('jenisKapal').value,
                ukuranKapal: document.getElementById('ukuranKapal').value, // GT
                mesinKapal: document.getElementById('mesinKapal').value, // PK
                alatTangkap: document.getElementById('alatTangkap').value,
                statusPas: document.querySelector('input[name="statusPas"]:checked')?.value || '-',
                nomorPas: document.getElementById('nomorPasKapal').value,

                kecamatan: "Panarukan",
                desa: "Kilensari",
                alamat: document.getElementById('alamat').value,
                
                jenisIkan: document.getElementById('jenisIkan').value, // Replaces jenis bantuan
                pendapatan: document.getElementById('pendapatan').value.replace(/\D/g,''), // Replaces jumlah
                usahaSampingan: document.getElementById('usahaSampingan').value, // Replaces nama bantuan

                tanggalValidasi: document.getElementById('tanggalValidasi').value, // Replaces tgl terima
                validator: document.getElementById('validator').value, // Replaces petugas
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value
            };

            appData.push(formData);
            saveData();
            document.getElementById('inputForm').reset();
            document.getElementById('kapalFields').style.display = 'none';
            showNotification('Data Nelayan Berhasil Disimpan!', 'success');
            updateDashboard();
            renderDataTable();
            document.getElementById('v-pills-data-tab').click();
        }

        // --- DATA & DASHBOARD ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            const list = isFilterActive ? filteredData : appData;
            
            if(list.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-4">Data Kosong</td></tr>`;
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = list.slice(start, end);

            pageData.forEach((d, i) => {
                const nikDisplay = appSettings.privacyMode ? (d.nik.substring(0,12) + '****') : d.nik;
                const row = `<tr>
                    <td>${start + i + 1}</td>
                    <td class="fw-bold text-primary">${d.nama}</td>
                    <td class="${appSettings.privacyMode ? 'privacy-blurred' : ''}">${nikDisplay}</td>
                    <td><span class="badge bg-info">${d.profesi}</span></td>
                    <td>${d.peran}</td>
                    <td>${d.usia} Thn</td>
                    <td class="fw-bold text-success">Rp ${new Intl.NumberFormat('id-ID').format(d.pendapatan)}</td>
                    <td>${d.jenisIkan}</td>
                    <td>${d.alamat}</td>
                    <td><span class="badge bg-secondary">${d.tanggalValidasi}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteData(${d.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
                tableBody.appendChild(document.createElement('tbody')).innerHTML = row; // Append workaround
            });
            document.getElementById('tableInfo').textContent = `Total: ${list.length} Data`;
        }

        function updateDashboard() {
            document.getElementById('totalPenerima').textContent = appData.length;
            
            const totalInc = appData.reduce((acc, curr) => acc + (parseInt(curr.pendapatan) || 0), 0);
            document.getElementById('totalBantuan').textContent = "Rp " + new Intl.NumberFormat('id-ID').format(totalInc);
            
            const avg = appData.length ? (totalInc / appData.length) : 0;
            document.getElementById('rataBantuan').textContent = "Rp " + new Intl.NumberFormat('id-ID').format(avg.toFixed(0));

            // Chart Logic
            const profesiCount = { 'Nelayan Tetap': 0, 'Nelayan Musiman': 0 };
            const peranCount = { 'Anak Buah Kapal': 0, 'Pemilik Kapal': 0 };
            
            appData.forEach(d => {
                if(profesiCount[d.profesi] !== undefined) profesiCount[d.profesi]++;
                if(peranCount[d.peran] !== undefined) peranCount[d.peran]++;
            });

            if(window.profesiChartInstance) window.profesiChartInstance.destroy();
            const ctx1 = document.getElementById('profesiChart').getContext('2d');
            window.profesiChartInstance = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: Object.keys(profesiCount),
                    datasets: [{ data: Object.values(profesiCount), backgroundColor: ['#1a4f6e', '#d68c45'] }]
                }
            });

            if(window.peranChartInstance) window.peranChartInstance.destroy();
            const ctx2 = document.getElementById('peranChart').getContext('2d');
            window.peranChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(peranCount),
                    datasets: [{ label: 'Jumlah', data: Object.values(peranCount), backgroundColor: '#2b7a8f' }]
                }
            });
        }

        // --- FILTER ---
        function applyFilter() {
            const fProfesi = document.getElementById('filterProfesi').value;
            const fPeran = document.getElementById('filterPeran').value;
            const fInc = document.getElementById('filterPendapatan').value;

            filteredData = appData.filter(d => {
                let pass = true;
                if(fProfesi && d.profesi !== fProfesi) pass = false;
                if(fPeran && d.peran !== fPeran) pass = false;
                if(fInc) {
                    const val = parseInt(d.pendapatan);
                    if(fInc === 'low' && val >= 1000000) pass = false;
                    if(fInc === 'mid' && (val < 1000000 || val > 3000000)) pass = false;
                    if(fInc === 'high' && val <= 3000000) pass = false;
                }
                return pass;
            });

            isFilterActive = true;
            renderFilterTable();
            showNotification(`Ditemukan ${filteredData.length} data.`, 'success');
        }

        function renderFilterTable() {
            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';
            filteredData.forEach((d, i) => {
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${d.nama}</td><td>${appSettings.privacyMode ? '****' : d.nik}</td><td>${d.profesi}</td><td>${d.peran}</td><td>${d.pendapatan}</td><td>${d.tanggalValidasi}</td></tr>`;
            });
        }

        function resetFilter() {
            isFilterActive = false;
            document.getElementById('filterProfesi').value = '';
            document.getElementById('filterPeran').value = '';
            document.getElementById('filterPendapatan').value = '';
            renderDataTable();
        }

        // --- PRINT & EXPORT ---
        function printPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            doc.text(appSettings.appName, 14, 20);
            doc.setFontSize(10);
            doc.text(appSettings.appSubtitle, 14, 26);
            
            const dataToPrint = isFilterActive ? filteredData : appData;
            const body = dataToPrint.map((d, i) => [i+1, d.nama, d.nik, d.profesi, d.peran, d.jenisIkan, d.pendapatan, d.validator]);
            
            doc.autoTable({
                head: [['No', 'Nama', 'NIK', 'Profesi', 'Peran', 'Ikan Dominan', 'Pendapatan', 'Validator']],
                body: body,
                startY: 35
            });
            doc.save('Data_Nelayan_Kilensari.pdf');
        }

        function showPreview() {
            const data = isFilterActive ? filteredData : appData;
            let html = '<table class="table table-bordered"><thead><tr><th>Nama</th><th>Profesi</th><th>Peran</th><th>Pendapatan</th></tr></thead><tbody>';
            data.forEach(d => html += `<tr><td>${d.nama}</td><td>${d.profesi}</td><td>${d.peran}</td><td>Rp ${d.pendapatan}</td></tr>`);
            html += '</tbody></table>';
            document.getElementById('previewContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        function exportData(type) {
            const data = isFilterActive ? filteredData : appData;
            if(type === 'excel') {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data Nelayan");
                XLSX.writeFile(wb, "Data_Nelayan.xlsx");
            } else {
                const ws = XLSX.utils.json_to_sheet(data);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], {type: 'text/csv'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'data.csv';
                link.click();
            }
        }

        // --- UTILS & STORAGE ---
        function saveData() { localStorage.setItem('nelayanData', JSON.stringify(appData)); }
        function loadData() { const d = localStorage.getItem('nelayanData'); if(d) appData = JSON.parse(d); }
        function deleteData(id) { if(confirm('Hapus data ini?')) { appData = appData.filter(x => x.id !== id); saveData(); renderDataTable(); updateDashboard(); } }
        
        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            if(!term) { isFilterActive = false; renderDataTable(); return; }
            filteredData = appData.filter(d => d.nama.toLowerCase().includes(term) || d.nik.includes(term));
            isFilterActive = true;
            renderDataTable();
        }

        function showNotification(msg, type) {
            document.getElementById('toastMessage').textContent = msg;
            const t = document.querySelector('.notification-toast');
            new bootstrap.Toast(t).show();
        }

        // Settings & Privacy
        function loadSettings() {
            const s = localStorage.getItem('nelayanSettings');
            if(s) {
                appSettings = JSON.parse(s);
                document.getElementById('appName').value = appSettings.appName;
                document.getElementById('appSubtitle').value = appSettings.appSubtitle;
                document.getElementById('privacyToggle').checked = appSettings.privacyMode;
                document.querySelector('.app-title').innerHTML = appSettings.appName.replace(/\n/g, '<br>');
                document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
            }
        }
        function saveSettingsFromForm(e) {
            e.preventDefault();
            appSettings.appName = document.getElementById('appName').value;
            appSettings.appSubtitle = document.getElementById('appSubtitle').value;
            localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
            location.reload();
        }
        function handlePrivacyToggle(e) {
            if(!e.target.checked) {
                e.target.checked = true; // wait for auth
                new bootstrap.Modal(document.getElementById('privacyAuthModal')).show();
            } else {
                appSettings.privacyMode = true;
                localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
                renderDataTable();
            }
        }
        function checkPrivacyPIN() {
            if(document.getElementById('privacyPasswordInput').value === appSettings.securityPIN) {
                appSettings.privacyMode = false;
                localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
                document.getElementById('privacyToggle').checked = false;
                bootstrap.Modal.getInstance(document.getElementById('privacyAuthModal')).hide();
                renderDataTable();
            } else {
                document.getElementById('privacyError').style.display = 'block';
            }
        }
        function backupData() {
            const blob = new Blob([JSON.stringify(appData)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'backup_nelayan.json';
            link.click();
        }
        function restoreData() {
            const file = document.getElementById('restoreFileInput').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                appData = JSON.parse(e.target.result);
                saveData();
                location.reload();
            };
            reader.readAsText(file);
        }
        function setupCharts() {
            // Placeholder for charts, actual rendering is in updateDashboard
        }
    </script>
</body>
</html>
