<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM PEMETAAN NELAYAN - ONE DATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            /* Palette: DEEP OCEAN PROFESSIONAL THEME */
            --primary-color: #0c2461; /* Dark Blue */
            --primary-gradient: linear-gradient(135deg, #0c2461 0%, #1e3799 100%); 
            
            --secondary-color: #4a69bd; 
            --accent-color: #f6b93b; /* Gold/Yellow */
            --orange-signature: #e67e22; /* Orange for Slogan */
            
            --sidebar-active: #eaf0f9; 
            --bg-body: #f1f2f6;
            --shadow-soft: 0 10px 30px rgba(12, 36, 97, 0.15);
            
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
        }
        
        /* Custom Badge Colors */
        .badge-profesi-tetap { background-color: var(--primary-color) !important; color: white; }
        .badge-profesi-musiman { background-color: #e58e26 !important; color: white; }
        .badge-kusuka-ada { background-color: var(--success-color) !important; color: white; }
        .badge-kusuka-tidak { background-color: #7f8c8d !important; color: white; }

        /* --- LOGIN --- */
        .login-overlay {
            background: var(--primary-gradient);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; z-index: 0; }
        .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
        .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }
        
        .login-card {
            background: white; width: 100%; max-width: 480px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow: hidden; z-index: 10; position: relative;
            animation: slideUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .login-header-new { background: white; padding: 40px 30px 20px 30px; text-align: center; color: var(--primary-color); border-bottom: 1px solid #f0f0f0; }
        .login-icon-box { width: 90px; height: 90px; background: #eaf0f9; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px; color: var(--primary-color); box-shadow: 0 10px 20px rgba(12, 36, 97, 0.1); }

        /* --- HEADER DESIGN --- */
        .app-header { 
            background: linear-gradient(120deg, #0a3d62, #3c6382), url('https://images.unsplash.com/photo-1503756234508-e32369269deb?q=80&w=2000&auto=format&fit=crop');
            background-blend-mode: multiply;
            background-size: cover;
            background-position: center;
            color: white; 
            padding: 40px 20px; 
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            border-bottom: 5px solid var(--accent-color);
            overflow: hidden; 
        }
        
        .app-logo-icon { 
            font-size: 3rem; 
            color: var(--primary-color); 
            background: white; 
            width: 100px; height: 100px; 
            line-height: 100px; 
            border-radius: 50%; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); 
            border: 4px solid rgba(255,255,255,0.8);
            transform: rotate(0deg);
            transition: transform 0.3s;
        }
        .app-logo-icon:hover { transform: scale(1.1); }

        .app-title { 
            font-family: 'Montserrat', sans-serif; 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: 1.5px;
            color: #fff;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-transform: uppercase;
        }

        .app-subtitle { 
            font-size: 1rem; 
            color: #fff; 
            margin-top: 5px; 
            font-weight: 600; 
            letter-spacing: 2px; 
            text-transform: uppercase;
        }

        .app-slogan {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem;
            color: var(--orange-signature);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            margin-top: 10px;
            font-weight: 700;
            transform: rotate(-2deg);
            display: inline-block;
        }
        
        /* Layout Container */
        .app-container { max-width: 1600px; margin: 30px auto; background: white; box-shadow: var(--shadow-soft); border-radius: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column; min-height: 90vh; }

        /* REFINED Navigation Sidebar (Perbaikan Tata Letak) */
        .nav-pills { padding: 10px; }
        .nav-pills .nav-link { 
            border-radius: 8px; 
            margin: 4px 0; 
            padding: 12px 16px; 
            font-weight: 600; 
            color: #636e72; 
            transition: all 0.2s ease; 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
        }
        .nav-pills .nav-link i { 
            width: 24px; 
            text-align: center; 
            margin-right: 12px !important; 
            font-size: 1.1em;
        }
        .nav-pills .nav-link:hover { background-color: #dfe6e9; color: var(--primary-color); transform: translateX(3px); }
        .nav-pills .nav-link.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(12, 36, 97, 0.2); }
        .nav-pills .nav-link.active i { color: white; }

        /* Chart & Section */
        .chart-container-fixed { position: relative; height: 300px; width: 100%; }
        .section-title { font-family: 'Montserrat', sans-serif; margin: 10px 0 30px 0; font-weight: 700; color: #0c2461; font-size: 1.5rem; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 8px; height: 30px; background: var(--accent-color); margin-right: 15px; border-radius: 10px; }

        /* REFINED Table Design */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid #f1f2f6; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table thead th { background: #dfe6e9 !important; color: #2d3436; font-weight: 800; border-bottom: 3px solid var(--primary-color); padding: 15px; vertical-align: middle; white-space: nowrap; }
        
        .data-table tbody td { 
            padding: 12px 15px; 
            vertical-align: middle; 
            border-bottom: 1px solid #f1f2f6; 
            font-size: 0.9rem;
        }
        .data-table tbody tr:hover td { background-color: #eaf0f9; cursor: pointer; }
        
        /* Specific Column Widths to Prevent Overlap */
        .col-id-cell { min-width: 250px; } 
        .col-contact-cell { min-width: 160px; }
        .col-status-cell { min-width: 150px; }
        .col-action { width: 140px; text-align: center; background: #fff; z-index: 5; }
        .sticky-col-right { position: sticky; right: 0; box-shadow: -5px 0 10px rgba(0,0,0,0.03); }

        /* Modal */
        .modal-header-custom { background: var(--primary-gradient); color: white; border-bottom: none; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #b2bec3; margin-bottom: 2px; }
        .detail-value { font-size: 1.1rem; font-weight: 600; color: #2d3436; margin-bottom: 15px; border-bottom: 1px solid #dfe6e9; padding-bottom: 5px; }

        /* Fab */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: var(--accent-color); color: #0c2461; border: none; box-shadow: 0 10px 25px rgba(246, 185, 59, 0.4); font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .fab-main:hover { transform: scale(1.1) rotate(90deg); background: #e58e26; color: white; }
        .fab-item { width: 50px; height: 50px; border-radius: 50%; background: white; color: var(--primary-color); border: 2px solid var(--primary-color); display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none; }
        .fab-container.open .fab-item { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item:hover { background: var(--primary-color); color: white; }

        /* Warning & Footer */
        .sticky-warning { position: fixed; top: 20px; right: 20px; z-index: 1080; background: white; border-left: 5px solid var(--danger-color); box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 20px; border-radius: 8px; width: 320px; display: none; animation: slideInLeft 0.5s; }
        
        /* REFINED FOOTER DESIGN */
        .main-footer { 
            background: var(--primary-color); /* Dark Blue Professional Look */
            border-top: none; 
            padding: 30px 0 20px 0; 
            margin-top: 50px; 
            text-align: center; 
            color: #eaf0f9; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .main-footer .footer-brand {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-color); 
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .main-footer .footer-text {
            font-size: 0.9rem;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
        }
        .main-footer .footer-divider {
            color: rgba(255, 255, 255, 0.4);
            margin: 0 10px;
        }
        .main-footer .footer-links a {
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }
        .main-footer .footer-links a:hover {
            color: var(--accent-color);
        }
        .main-footer .footer-links i {
            color: var(--accent-color); 
            margin-right: 5px;
        }
        
        /* NEW RELOAD NOTIFICATION */
        .reload-notification {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff3cd; 
            color: #664d03;
            padding: 15px 30px;
            z-index: 1090; 
            border-top: 3px solid #ffc107;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: transform 0.4s ease-out;
        }
        .reload-notification.show {
            transform: translateY(0);
        }

        /* Hidden Div for QR Code Generation */
        #qr-code-generator {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        @keyframes slideInLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: slideUp 0.6s ease-out; }

        /* Responsive */
        @media (max-width: 991.98px) {
            .col-md-3.col-lg-2 { display: none; }
            .mobile-show { display: block !important; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1050; width: 280px; overflow-y: auto; background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .mobile-menu-btn { display: block; position: fixed; top: 15px; left: 15px; z-index: 1060; background: var(--accent-color); color: #0c2461; padding: 10px 14px; border-radius: 6px; border: none; }
        }
    </style>
</head>
<body>

    <div id="qr-code-generator">
        <div id="qr-left"></div>
        <div id="qr-right"></div>
    </div>

    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="login-icon-box">
                    <i class="fas fa-ship fa-3x"></i> </div>
                <h4 class="fw-bold mb-1" style="font-family: 'Montserrat'; letter-spacing: 0.5px;">SISTEM SATU DATA</h4>
                <p class="mb-0 text-muted small">KABUPATEN SITUBONDO</p>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode otoritas untuk mengakses sistem.</p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" value="BidangPN1945" readonly style="font-family: monospace;">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-filter-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon">
                    <i class="fas fa-ship"></i>
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="position-absolute top-0 end-0 p-3">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill"><i class="fas fa-circle text-success me-2 small"></i>Online v5.0 (Blue Ocean)</span>
                </div>
            </div>
            
            <div class="row g-0 flex-grow-1">
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-3 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important; padding-left: 15px;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter"></i> Filter & Validasi</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-4 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-4">
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100 text-white" style="background: var(--primary-gradient);">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="small fw-bold text-uppercase opacity-75">Total Nelayan</span>
                                                    <i class="fas fa-users opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold mb-0" id="totalPenerima">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Est. Pendapatan</span>
                                                    <i class="fas fa-chart-line text-warning opacity-50 fa-2x"></i>
                                                </div>
                                                <h3 class="fw-bold text-dark mb-0" id="totalBantuan">Rp 0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Pemilik Kapal</span>
                                                    <i class="fas fa-ship text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Rata-rata Usia</span>
                                                    <i class="fas fa-user-clock text-secondary opacity-25 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="rataUsia">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-input">
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <div class="alert alert-info small mb-4 border-0 bg-light-info text-primary"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Semua kolom WAJIB DIISI kecuali Keterangan, Usaha Sampingan, dan Link Drive.</div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan) <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="whatsapp" class="form-label">Nomor Handphone Aktif <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">+62</span>
                                                        <input type="tel" class="form-control" id="whatsapp" required placeholder="8123xxxx">
                                                        <button class="btn btn-outline-secondary" type="button" id="btnNoWA" title="Tidak Punya WA">Tidak Ada</button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profesi" class="form-label">Kategori Profesi <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="profesi" required>
                                                        <option value="">Pilih Profesi...</option>
                                                        <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                        <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="statusNelayan" class="form-label">Status Pekerjaan <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="statusNelayan" required>
                                                        <option value="">Pilih Status...</option>
                                                        <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                        <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="kusuka" class="form-label fw-bold text-success"><i class="fas fa-id-card me-1"></i>Kepemilikan Kartu KUSUKA? <span class="text-danger">*</span></label>
                                                    <select class="form-select border-success" id="kusuka" required>
                                                        <option value="Tidak">Tidak Ada</option>
                                                        <option value="Ada">Ada</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tahunLahir" class="form-label">Tahun Kelahiran <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                    <input type="text" class="form-control bg-light" id="usia" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="kecamatan" class="form-label fw-bold text-primary">Kecamatan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="kecamatan" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="desa" class="form-label fw-bold text-primary">Desa / Kelurahan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="desa" required disabled>
                                                        <option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                     <label for="alamat" class="form-label">Alamat Lengkap <span class="text-danger">*</span></label>
                                                     <textarea class="form-control" id="alamat" rows="1" placeholder="Dusun, RT/RW" required></textarea>
                                                </div>
                                            </div>

                                            <div id="ownerFields" style="display:none;" class="bg-light p-4 rounded-3 mb-3 border">
                                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3"><i class="fas fa-ship me-2"></i>Detail Aset Kapal (Wajib bagi Pemilik Kapal)</h6>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Nama Kapal</label>
                                                        <input type="text" class="form-control" id="namaKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Jenis Kapal</label>
                                                        <select class="form-select" id="jenisKapal">
                                                            <option value="">Pilih Jenis...</option>
                                                            <option value="Perahu Jukung">Perahu Jukung</option>
                                                            <option value="Perahu Mayang">Perahu Mayang</option>
                                                            <option value="Perahu Slerek">Perahu Slerek</option>
                                                            <option value="Lainnya">Lainnya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Ukuran (GT)</label>
                                                        <input type="text" class="form-control" id="ukuranKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Mesin (PK)</label>
                                                        <input type="text" class="form-control" id="mesinKapal">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Alat Tangkap</label>
                                                    <select class="form-select" id="alatTangkap">
                                                        <option value="">Pilih Alat Tangkap...</option>
                                                        <option value="Jaring Lingkar (purse seine)">Jaring Lingkar (purse seine)</option>
                                                        <option value="Jaring Insang (gill net)">Jaring Insang (gill net)</option>
                                                        <option value="Jaring Angkat (lift net)">Jaring Angkat (lift net)</option>
                                                        <option value="Pancing">Pancing</option>
                                                        <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                        <option value="Lainnya">Lainnya</option>
                                                    </select>
                                                </div>
                                                <div class="p-3 bg-white border rounded">
                                                    <label class="form-label d-block fw-bold">Kepemilikan Dokumen (BPKP / PAS)</label>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenYa" value="Ya">
                                                        <label class="form-check-label" for="dokumenYa">Ada</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenTidak" value="Tidak" checked>
                                                        <label class="form-check-label" for="dokumenTidak">Tidak Ada</label>
                                                    </div>
                                                    <div id="nomorPasContainer" class="mt-2" style="display:none;">
                                                        <input type="text" class="form-control form-control-sm" id="nomorPas" placeholder="Masukkan Nomor PAS KAPAL">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Jenis Ikan Tangkapan Utama <span class="text-danger">*</span></label>
                                                    <div class="card p-3 bg-light border">
                                                        <div id="fishCheckboxContainer" style="max-height: 200px; overflow-y: auto;">
                                                            </div>
                                                        <input type="text" class="form-control form-control-sm mt-2" id="jenisIkanLainnya" placeholder="Sebutkan jenis lainnya..." style="display:none;">
                                                    </div>
                                                    <small class="text-muted fst-italic">*Pilih minimal satu</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="usahaSampingan" class="form-label">Usaha Sampingan (Jika Ada)</label>
                                                    <textarea class="form-control" id="usahaSampingan" rows="4" placeholder="Contoh: Buruh Tani, Ojek, Warung Kecil"></textarea>
                                                </div>
                                            </div>

                                            <div class="row mb-4">
                                                <div class="col-md-4">
                                                    <label for="pendapatan" class="form-label">Est. Pendapatan (IDR) <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="pendapatan" required placeholder="Contoh: 2500000">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tanggalValidasi" class="form-label">Tanggal Validasi <span class="text-danger">*</span></label>
                                                    <input type="date" class="form-control" id="tanggalValidasi" required value="2025-11-20">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="validator" class="form-label">Nama Validator <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="validator" required placeholder="Nama Petugas">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="kodeValidasi" class="form-label fw-bold text-success"><i class="fas fa-check-circle me-1"></i>Kode Validasi <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="kodeValidasi" required readonly placeholder="Tekan Generate">
                                                        <button class="btn btn-success" type="button" id="btnGenerateCode"><i class="fas fa-magic me-2"></i>Generate</button>
                                                    </div>
                                                    <small class="text-muted fst-italic">Kode ini wajib dan hanya bisa dibuat satu kali (sekali generate, kode terkunci).</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                                                    <textarea class="form-control" id="keterangan" rows="1" placeholder="Catatan tambahan"></textarea>
                                                </div>
                                            </div>
                                            <div class="mb-4">
                                                <label for="driveLink" class="form-label"><i class="fas fa-cloud me-2"></i>Link Drive Dokumen Pendukung (Opsional)</label>
                                                <input type="url" class="form-control" id="driveLink" placeholder="Masukkan link Google Drive, Dropbox, dsb.">
                                            </div>

                                            <div class="mt-4 pt-3 border-top">
                                                <button type="submit" class="btn btn-primary btn-lg px-5 me-2"><i class="fas fa-save me-2"></i> Simpan Data</button>
                                                <button type="reset" class="btn btn-outline-secondary btn-lg"><i class="fas fa-eraser me-2"></i> Reset Form</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-data">
                                <h3 class="section-title">Data Nelayan Tersimpan</h3>
                                <div class="row mb-3 g-3">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="searchData" placeholder="Cari Nama, NIK, Desa, dsb...">
                                    </div>
                                    <div class="col-md-8 text-end">
                                        <button class="btn btn-danger d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-2"></i> Hapus Massal (<span id="selectedCount">0</span>)</button>
                                        <button class="btn btn-info text-white ms-2" id="reloadTableBtn"><i class="fas fa-sync-alt me-2"></i> Reload Tabel</button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table data-table table-hover table-bordered mb-0" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th width="40" class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                <th width="50" class="text-center">No</th>
                                                <th class="col-id-cell">Identitas Nelayan</th>
                                                <th class="col-contact-cell">Kontak</th>
                                                <th class="col-status-cell">Profesi & Status</th>
                                                <th class="col-status-cell">Aset Kapal</th>
                                                <th>Pendapatan</th>
                                                <th class="col-action sticky-col-right text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                            <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data database...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                    <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                    <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                </div>
                                <div class="p-2 small text-muted fst-italic text-end border-top">
                                    <span id="sensorStatusText" class="badge bg-secondary me-2">Sensor: ON</span>
                                    <i class="fas fa-info-circle text-danger me-1"></i> Baris <span class="badge bg-danger">Merah</span> = duplikasi NIK.
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-filter">
                                <h3 class="section-title">Filter & Validasi Data</h3>
                                <div class="card mb-4 border-0 shadow-sm">
                                    <div class="card-body bg-light rounded">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Desa</label>
                                                <select class="form-select form-select-sm" id="filterDesa"></select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Profesi</label>
                                                <select class="form-select form-select-sm" id="filterProfesi">
                                                    <option value="">Semua Profesi</option>
                                                    <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                    <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Kusuka</label>
                                                <select class="form-select form-select-sm" id="filterKusuka">
                                                    <option value="">Semua Status</option>
                                                    <option value="Ada">Ada</option>
                                                    <option value="Tidak">Tidak Ada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100 btn-sm" id="applyFilterBtn"><i class="fas fa-search me-2"></i> Tampilkan Data</button>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                            <small class="text-muted" id="filterResultInfo">0 Data Terfilter</small>
                                            <button class="btn btn-sm btn-outline-danger" id="btnCekGanda"><i class="fas fa-exclamation-triangle me-2"></i> Cek Duplikasi NIK Global</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <h4 class="fw-bold mb-3 text-primary"><i class="fas fa-table me-2"></i> Tabel Data Hasil Filter</h4>
                                <div class="table-responsive">
                                    <table class="table data-table table-hover table-striped mb-0" id="filterDataTable">
                                        <thead>
                                            <tr>
                                                <th width="50" class="text-center">No</th>
                                                <th>Nama (NIK)</th>
                                                <th>Domisili</th>
                                                <th>Profesi</th>
                                                <th>Status</th>
                                                <th>KUSUKA</th>
                                                <th>K. Validasi</th>
                                                <th class="col-action text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="filterTableBody">
                                            <tr><td colspan="8" class="text-center py-5 text-muted">Filter data untuk menampilkan hasil.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-print">
                                <h3 class="section-title">Cetak Laporan</h3>
                                <div class="alert alert-warning small border-0 bg-light-warning text-dark"><i class="fas fa-info-circle me-2"></i>Harap filter data terlebih dahulu pada tab **Filter & Validasi** sebelum mencetak laporan data terfilter.</div>
                                <div class="card p-4 border-0 shadow-sm text-center">
                                    <i class="fas fa-file-pdf fa-4x mb-3 text-danger opacity-50"></i>
                                    <h5>Cetak Laporan Data Terfilter</h5>
                                    <p class="text-muted">Fitur ini akan mencetak data rekapitulasi lengkap sesuai data yang tersedia dalam format PDF Resmi. Data yang dicetak adalah **Data Hasil Filter**.</p>
                                    <button class="btn btn-danger px-5 mt-3 shadow" id="printPdfBtn"><i class="fas fa-download me-2"></i> Download PDF Laporan Resmi</button>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-export">
                                <h3 class="section-title">Ekspor & Pelaporan Data</h3>
                                <div class="row g-4">
                                    <div class="col-md-12">
                                        <div class="card p-4 border-success bg-white shadow-sm" style="border-left: 5px solid #25D366;">
                                            <div class="d-flex align-items-start">
                                                <div class="me-4 text-success"><i class="fab fa-whatsapp fa-3x"></i></div>
                                                <div>
                                                    <h5 class="fw-bold text-dark mb-2">Lapor Cepat via WhatsApp Center</h5>
                                                    <p class="mb-2 text-muted" style="line-height: 1.6;"> 
                                                        Silakan unduh <strong>File Sinkronisasi (reload.js)</strong> melalui tombol di bawah. Selanjutnya, klik tombol <strong>"Kirim Laporan"</strong> untuk terhubung ke WhatsApp Administrator Dinas Perikanan Kabupaten Situbondo. 
                                                        <br><span class="text-danger small">*Harap lampirkan file <b>reload.js</b> yang telah diunduh pada chat WhatsApp tersebut sebagai bukti sinkronisasi data.</span>
                                                    </p>
                                                    <button class="btn btn-success mt-2 px-4" id="sendWaBtn"><i class="fas fa-paper-plane me-2"></i> Kirim Laporan ke Pusat</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6"><button class="btn btn-outline-success w-100 py-4 h-100 shadow-sm" id="exportExcelBtn"><i class="fas fa-file-excel me-2"></i> Export Data Lengkap ke Excel (.xlsx)</button></div>
                                    <div class="col-md-6"><button class="btn btn-outline-info w-100 py-4 h-100 shadow-sm" id="exportReloadJsBtn"><i class="fas fa-code me-2"></i> Download File Sinkronisasi (reload.js)</button></div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-backup">
                                <h3 class="section-title">Backup & Restore Data</h3>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card p-4 border-0 shadow-sm border-start border-4 border-primary h-100">
                                            <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-hdd me-2"></i> Backup Data Lokal</h6>
                                            <p class="text-muted small">Buat salinan data nelayan saat ini. Data akan diunduh dalam format .json yang terenkripsi.</p>
                                            <button class="btn btn-primary mt-auto" id="backupDataBtn"><i class="fas fa-save me-2"></i> Mulai Backup Data</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card p-4 border-0 shadow-sm border-start border-4 border-success h-100">
                                            <h6 class="fw-bold mb-3 text-success"><i class="fas fa-upload me-2"></i> Restore Data Lokal</h6>
                                            <p class="text-muted small">Unggah file backup (.json) untuk memulihkan atau menggabungkan data ke sistem saat ini.</p>
                                            <input class="form-control form-control-sm mb-3" type="file" id="restoreFileInput" accept=".json">
                                            <button class="btn btn-success" id="restoreDataBtn" disabled><i class="fas fa-undo-alt me-2"></i> Restore Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-settings">
                                <h3 class="section-title">Pengaturan Aplikasi</h3>
                                <div class="card p-4 border-0 shadow-sm mb-4">
                                    <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-palette me-2"></i> Identitas Aplikasi</h6>
                                    <form id="settingsForm">
                                        <div class="mb-3">
                                            <label for="appName" class="form-label">Nama Sistem (Header)</label>
                                            <input type="text" class="form-control" id="appName" placeholder="SISTEM PEMETAAN DATA NELAYAN" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="appSubtitle" class="form-label">Sub Judul (Header)</label>
                                            <input type="text" class="form-control" id="appSubtitle" placeholder="DINAS PERIKANAN KABUPATEN SITUBONDO" required>
                                        </div>
                                        <div class="mb-4">
                                            <label for="itemsPerPageSelect" class="form-label">Tampilkan Data Per Halaman</label>
                                            <select class="form-select" id="itemsPerPageSelect">
                                                <option value="10">10 Baris (Default)</option>
                                                <option value="25">25 Baris</option>
                                                <option value="50">50 Baris</option>
                                                <option value="75">75 Baris</option>
                                                <option value="100">100 Baris</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                    </form>
                                </div>
                                <div class="card p-4 border-0 shadow-sm border-start border-4 border-danger">
                                    <h6 class="fw-bold mb-3 text-danger"><i class="fas fa-user-shield me-2"></i>Privasi & Keamanan Data</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="d-block">Sensor Data Pribadi (NIK & No. HP)</strong>
                                            <small class="text-muted">Menyensor 4 digit terakhir dengan tanda bintang (*) pada tabel dan hasil unduhan.</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="privacyToggle" style="width: 3em; height: 1.5em; cursor: pointer;" checked>
                                        </div>
                                    </div>
                                    <div id="privacyStatus" class="mt-2 small text-success fw-bold">Status: Sensor Aktif (Aman)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <footer class="main-footer">
                        <div class="container-fluid">
                            <h6 class="footer-brand">SISTEM PEMETAAN DATA NELAYAN</h6>
                            <p class="footer-text">
                                &copy; 2025 Bidang Pemberdayaan Nelayan <span class="footer-divider">|</span> Dinas Perikanan Kabupaten Situbondo
                            </p>
                            <div class="footer-links">
                                <a href="tel:087865614222" target="_blank">
                                    <i class="fas fa-phone-alt"></i> Contact Center: 0878-6561-4222
                                </a>
                                <span class="footer-divider">|</span>
                                <a href="mailto:info@dinasperikanansitubondo.com" target="_blank">
                                    <i class="fas fa-envelope"></i> info@dinasperikanansitubondo.com
                                </a>
                            </div>
                        </div>
                    </footer>
                    </div>
            </div>
        </div>
        
        <div class="reload-notification" id="reloadNotification">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-sync-alt fa-2x me-3 text-warning"></i>
                        <div>
                            <h6 class="mb-1 fw-bold text-dark" id="reloadNotifTitle">PEMBERITAHUAN: Perlu Sinkronisasi Data Terbaru!</h6>
                            <p class="mb-0 small text-muted" id="reloadNotifMessage">Demi menjaga konsistensi dan akurasi data, sistem merekomendasikan untuk memuat ulang data terbaru.</p>
                        </div>
                    </div>
                    <div id="reloadNotifActions">
                        <button class="btn btn-warning btn-sm fw-bold shadow-sm me-2" id="btnDoReload"><i class="fas fa-redo-alt me-1"></i> Muat Ulang Data</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header modal-header-custom">
                        <h5 class="modal-title" id="detailModalLabel">Detail Data Nelayan</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold text-primary mb-3">IDENTITAS DIRI</h6>
                                <div class="detail-label">Nama Lengkap</div><div class="detail-value" id="d_nama">-</div>
                                <div class="detail-label">NIK</div><div class="detail-value" id="d_nik">-</div>
                                <div class="detail-label">Alamat Lengkap</div><div class="detail-value" id="d_alamat">-</div>
                                <div class="detail-label">Nomor WA</div><div class="detail-value" id="d_whatsapp">-</div>
                                <div class="detail-label">Tahun Lahir / Usia</div><div class="detail-value" id="d_lahir">-</div>
                                <div class="detail-label text-success">Kepemilikan KUSUKA</div><div class="detail-value" id="d_kusuka">-</div>
                            </div>
                            <div class="col-md-6 border-start">
                                <h6 class="fw-bold text-primary mb-3">PROFESI & EKONOMI</h6>
                                <div class="detail-label">Status Profesi</div><div class="detail-value" id="d_profesi">-</div>
                                <div class="detail-label">Status Pekerjaan</div><div class="detail-value" id="d_status">-</div>
                                <div class="detail-label">Alat Tangkap Utama</div><div class="detail-value" id="d_alat_tangkap">-</div>
                                <div class="detail-label">Jenis Ikan Utama</div><div class="detail-value" id="d_jenis_ikan">-</div>
                                <div class="detail-label">Usaha Sampingan</div><div class="detail-value" id="d_usaha_sampingan">-</div>
                                <div class="detail-label">Est. Pendapatan (IDR)</div><div class="detail-value" id="d_pendapatan">-</div>
                            </div>
                        </div>
                        <div class="row mt-4 pt-3 border-top">
                             <div class="col-md-6">
                                 <h6 class="fw-bold text-primary mb-3"><i class="fas fa-ship me-2"></i> DETAIL KAPAL</h6>
                                 <div class="detail-label">Nama Kapal</div><div class="detail-value" id="d_nama_kapal">-</div>
                                 <div class="detail-label">Jenis / Ukuran / Mesin</div><div class="detail-value" id="d_kapal_spec">-</div>
                                 <div class="detail-label text-info">Nomor PAS KAPAL</div><div class="detail-value" id="d_nomor_pas">-</div>
                                 <div class="detail-label"><i class="fas fa-cloud me-1"></i> Link Dokumen</div><div class="detail-value"><a href="#" target="_blank" id="d_drive_link">-</a></div>
                             </div>
                             <div class="col-md-6 border-start">
                                 <h6 class="fw-bold text-success mb-3"><i class="fas fa-check-circle me-2"></i> VALIDASI DATA</h6>
                                 <div class="detail-label">Kode Validasi</div><div class="detail-value fw-bold text-success" id="d_kode_valid">-</div>
                                 <div class="detail-label">Keterangan</div><div class="detail-value" id="d_keterangan">-</div>
                                 <div class="detail-label">Terakhir divalidasi: <span id="d_tgl_valid">-</span> oleh <span id="d_validator">-</span></div>
                             </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-white">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" class="btn btn-danger" id="btnDownloadDetailPdf"><i class="fas fa-file-pdf me-2"></i>UNDUH DOKUMEN (PDF)</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <a href="#" class="fab-item" id="fabInput" title="Input Data"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" title="Filter"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabExport" title="Ekspor Data"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" title="Backup"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" title="Pengaturan"><i class="fas fa-cog"></i></a>
        </div>
        
        <div class="notification-toast toast position-fixed top-0 end-0 p-3" style="z-index: 1099; min-width: 300px;" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Sukses</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Pesan notifikasi.
            </div>
        </div>
        
        <div class="mobile-show bg-white py-4 d-none" id="mobileMenu">
             <div class="d-flex justify-content-between align-items-center px-4 mb-3">
                 <h5 class="fw-bold mb-0 text-primary">NAVIGASI</h5>
                 <button class="btn-close" id="closeMobileMenu"></button>
             </div>
            <div class="nav flex-column nav-pills" id="v-pills-tab-mobile" role="tablist">
                <button class="nav-link active" data-target-tab="v-pills-dashboard-tab"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="nav-link" data-target-tab="v-pills-input-tab"><i class="fas fa-edit"></i> Input Data</button>
                <button class="nav-link" data-target-tab="v-pills-data-tab"><i class="fas fa-database"></i> Data Nelayan</button>
                <button class="nav-link" data-target-tab="v-pills-filter-tab"><i class="fas fa-filter"></i> Filter & Validasi</button>
                <button class="nav-link" data-target-tab="v-pills-print-tab"><i class="fas fa-print"></i> Cetak Laporan</button>
                <button class="nav-link" data-target-tab="v-pills-export-tab"><i class="fas fa-file-export"></i> Ekspor Data</button>
                <button class="nav-link" data-target-tab="v-pills-backup-tab"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                <button class="nav-link" data-target-tab="v-pills-settings-tab"><i class="fas fa-cog"></i> Pengaturan</button>
                <button class="nav-link" data-target-tab="btn-reload-repo"><i class="fas fa-sync"></i> Reload Data</button>
                <div class="mt-4 pt-3 border-top px-3">
                     <button class="nav-link text-danger w-100 justify-content-start bg-light" data-target-tab="v-pills-logout-tab"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SITUBONDO_DATA = {
            "Asembagus": ["Asembagus", "Bantal", "Kertosari", "Klatakan", "Mojosari", "Wringinanom"],
            "Banyuglugur": ["Banyuglugur", "Kalianget", "Lubawang", "Selobanteng", "Sumberanyar"],
            "Besuki": ["Besuki", "Blimbing", "Demung", "Kalimas", "Langkap", "Pesisir"],
            "Jangkar": ["Curahkalak", "Jangkar", "Kukusan", "Pategalan", "Semenep"],
            "Kendit": ["Babat", "Balung", "Kendal", "Kendit", "Tambakukir"],
            "Mlandingan": ["Alasmalang", "Banyudami", "Mlandingan Kulon", "Mlandingan Wetan", "Sumberkatimoho"],
            "Panarukan": ["Alasbuluh", "Gelung", "Kilensari", "Panarukan", "Sokaan", "Sumberkolak"],
            "Panji": ["Juglangan", "Panji", "Sliwung", "Tenggir"],
            "Situbondo": ["Ardirejo", "Dawuhan", "Patokan", "Tanjung Pecinan"],
            "Suboh": ["Banyugeni", "Buduan", "Krandegan", "Suboh", "Sumbersalak"]
        };
        const IKAN_DATA = ["Ikan Tongkol", "Ikan Layang", "Ikan Cakalang", "Ikan Tuna", "Udang", "Kepiting", "Rajungan", "Lainnya"];
        const SECURITY_CODE = "BidangPN1945"; // For login and privacy toggle

        let appData = [];
        let currentPage = 1;
        let appSettings = {
            appName: "SISTEM PEMETAAN DATA NELAYAN",
            appSubtitle: "DINAS PERIKANAN KABUPATEN SITUBONDO",
            itemsPerPage: 10,
            privacyMode: true // true means NIK/HP are censored
        };
        let currentDetailId = null;
        let duplicateCheckInterval = null; // To hold the interval timer

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadSettings();
            updateAppIdentity();
            setupInitialUI();
            setupEventListeners();
            startDuplicateChecker();
        });

        // --- CORE FUNCTIONS ---

        function saveData() {
            localStorage.setItem('nelayanData', JSON.stringify(appData));
        }

        function loadData() {
            const storedData = localStorage.getItem('nelayanData');
            if (storedData) {
                appData = JSON.parse(storedData);
            }
            // Populate initial dashboard and table
            updateDashboard();
            renderDataTable();
        }
        
        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }
        
        function loadSettings() {
            const storedSettings = localStorage.getItem('appSettings');
            if(storedSettings) {
                appSettings = {...appSettings, ...JSON.parse(storedSettings)};
            }
        }
        
        function updateAppIdentity() {
            document.getElementById('appName').value = appSettings.appName;
            document.getElementById('appSubtitle').value = appSettings.appSubtitle;
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
            document.getElementById('itemsPerPageSelect').value = appSettings.itemsPerPage;
            updatePrivacyUI();
        }

        function togglePrivacyMode(isManual = false) {
             // Existing logic kept intact
        }
        
        function updatePrivacyUI() {
             // Existing logic kept intact
            document.getElementById('privacyToggle').checked = appSettings.privacyMode;
            document.getElementById('privacyStatus').textContent = appSettings.privacyMode ? 'Status: Sensor Aktif (Aman)' : 'Status: Sensor Nonaktif (Raw Data)';
            document.getElementById('sensorStatusText').textContent = `Sensor: ${appSettings.privacyMode ? 'ON' : 'OFF'}`;
        }
        
        function getCensoredText(text, isNik = false) {
            if (appSettings.privacyMode && text && text.length > 4) {
                const len = text.length;
                return (isNik ? '************' : text.substring(0, len - 4)) + text.substring(len - 4);
            }
            return text;
        }

        function updateDashboard() {
            const totalPenerima = appData.length;
            const totalPendapatan = appData.reduce((sum, d) => sum + (parseInt(d.pendapatan) || 0), 0);
            const totalPemilik = appData.filter(d => d.statusNelayan === 'Pemilik Kapal').length;
            const currentYear = new Date().getFullYear();
            const totalUsia = appData.reduce((sum, d) => sum + (currentYear - (parseInt(d.tahunLahir) || currentYear)), 0);
            const rataUsia = totalPenerima > 0 ? Math.round(totalUsia / totalPenerima) : 0;

            document.getElementById('totalPenerima').textContent = totalPenerima.toLocaleString('id-ID');
            document.getElementById('totalBantuan').textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
            document.getElementById('totalPemilik').textContent = totalPemilik.toLocaleString('id-ID');
            document.getElementById('rataUsia').textContent = rataUsia;
            
            // Charts (kept intact, assuming chart initialization is here)
            // ... (Chart update logic) ...
        }
        
        function mergeAndRestore(restoredData) {
            // Existing logic kept intact
        }

        // --- NEW: VALIDATION CODE GENERATOR ---
        function generateValidationCode() {
            const nik = document.getElementById('nik').value;
            // Check NIK validation is already done in the event listener
            
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            // Format: STB-NIK_LAST4-TIMESTAMP-RANDOM4
            const code = `STB-${nik.substring(12)}-${timestamp}-${random}`;
            return code;
        }
        
        // --- NEW: RELOAD NOTIFICATION ---
        function showReloadNotification() {
            const notifEl = document.getElementById('reloadNotification');
            const actionsEl = document.getElementById('reloadNotifActions');
            
            // Check if notification is already showing to prevent immediate re-trigger
            if (notifEl.classList.contains('show')) return;
            
            notifEl.classList.add('show');
            
            // Reset actions to show 'Reload' button
            actionsEl.innerHTML = `<button class="btn btn-warning btn-sm fw-bold shadow-sm me-2" id="btnDoReload"><i class="fas fa-redo-alt me-1"></i> Muat Ulang Data</button>`;
            
            // Event listener for Reload button
            document.getElementById('btnDoReload').onclick = () => {
                handleReloadRepo(); 
                // Change button to 'Close' after reload is triggered
                actionsEl.innerHTML = `<button class="btn btn-success btn-sm fw-bold shadow-sm" id="btnCloseReload" onclick="document.getElementById('reloadNotification').classList.remove('show');"><i class="fas fa-check me-1"></i> Tutup Notifikasi</button>`;
                showNotification('Data telah dimuat ulang.', 'success');
            };
        }

        // --- DATA INPUT & MANIPULATION ---

        function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }

            const editId = form.getAttribute('data-edit-id');
            const selectedFish = Array.from(document.querySelectorAll('.fish-checkbox:checked')).map(cb => cb.value);
            if (selectedFish.length === 0) {
                 showNotification('Pilih minimal satu Jenis Ikan Tangkapan Utama.', 'error');
                 return;
            }
            
            const kodeValidasi = document.getElementById('kodeValidasi').value;
            // NEW: Check if validation code is mandatory
            if (!kodeValidasi) {
                showNotification('Kode Validasi WAJIB diisi! Silakan tekan tombol Generate.', 'error');
                document.getElementById('btnGenerateCode').focus();
                return;
            }
            
            // Data collection (using existing structure)
            const formData = {
                id: editId || Date.now(),
                nama: document.getElementById('nama').value,
                nik: document.getElementById('nik').value,
                whatsapp: document.getElementById('whatsapp').value,
                profesi: document.getElementById('profesi').value,
                statusNelayan: document.getElementById('statusNelayan').value,
                kusuka: document.getElementById('kusuka').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alamat: document.getElementById('alamat').value,
                
                // Kapal details
                namaKapal: document.getElementById('namaKapal').value,
                jenisKapal: document.getElementById('jenisKapal').value,
                ukuranKapal: document.getElementById('ukuranKapal').value,
                mesinKapal: document.getElementById('mesinKapal').value,
                alatTangkap: document.getElementById('alatTangkap').value,
                nomorPas: document.getElementById('dokumenYa').checked ? document.getElementById('nomorPas').value : '-',
                
                // Economy & Validation
                jenisIkan: selectedFish.join(", "),
                usahaSampingan: document.getElementById('usahaSampingan').value,
                pendapatan: document.getElementById('pendapatan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: kodeValidasi, // Use the generated/locked code
                keterangan: document.getElementById('keterangan').value
            };

            if (editId) {
                const index = appData.findIndex(item => item.id == editId);
                appData[index] = formData;
                form.removeAttribute('data-edit-id');
                showNotification('Data berhasil diperbarui', 'success');
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan', 'success');
            }
            
            // NEW: Trigger reload notification after data manipulation
            showReloadNotification();

            saveData();
            form.reset();
            document.getElementById('ownerFields').style.display = 'none';
            toggleBoatRequirements(false); // reset requirements
            document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
            document.getElementById('desa').disabled = true;
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('kusuka').value = "Tidak";
            
            // Reset Validation Code area (for new entry)
            document.getElementById('kodeValidasi').value = '';
            document.getElementById('kodeValidasi').removeAttribute('readonly');
            document.getElementById('btnGenerateCode').removeAttribute('disabled');
            
            updateDashboard();
            renderDataTable();
            document.getElementById('v-pills-data-tab').click();
            checkGlobalDuplicates();
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if (!d) return;

            // Existing logic to populate form (omitted for brevity)
            document.getElementById('inputForm').setAttribute('data-edit-id', id);
            
            // ... (populating other fields) ...
            document.getElementById('nama').value = d.nama;
            document.getElementById('nik').value = d.nik;
            document.getElementById('whatsapp').value = d.whatsapp;
            document.getElementById('profesi').value = d.profesi;
            document.getElementById('statusNelayan').value = d.statusNelayan;
            document.getElementById('kusuka').value = d.kusuka;
            document.getElementById('tahunLahir').value = d.tahunLahir;
            document.getElementById('kecamatan').value = d.kecamatan;
            // Trigger desa load
            document.getElementById('kecamatan').dispatchEvent(new Event('change'));
            document.getElementById('desa').value = d.desa;
            document.getElementById('alamat').value = d.alamat;
            
            // Kapal fields
            const isOwner = d.statusNelayan === 'Pemilik Kapal';
            document.getElementById('ownerFields').style.display = isOwner ? 'block' : 'none';
            toggleBoatRequirements(isOwner);
            if (isOwner) {
                document.getElementById('namaKapal').value = d.namaKapal;
                document.getElementById('jenisKapal').value = d.jenisKapal;
                document.getElementById('ukuranKapal').value = d.ukuranKapal;
                document.getElementById('mesinKapal').value = d.mesinKapal;
                document.getElementById('alatTangkap').value = d.alatTangkap;
                if(d.nomorPas && d.nomorPas !== '-') {
                    document.getElementById('dokumenYa').checked = true;
                    document.getElementById('nomorPasContainer').style.display = 'block';
                    document.getElementById('nomorPas').value = d.nomorPas;
                } else {
                    document.getElementById('dokumenTidak').checked = true;
                    document.getElementById('nomorPasContainer').style.display = 'none';
                }
            }
            
            // Ikan
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            const ikanList = d.jenisIkan.split(', ');
            ikanList.forEach(ikan => {
                const cb = document.querySelector(`.fish-checkbox[value="${ikan}"]`);
                if (cb) cb.checked = true;
                else if (ikan !== 'Lainnya') document.getElementById('jenisIkanLainnya').value = ikan;
            });
            
            // Economy & Validation
            document.getElementById('usahaSampingan').value = d.usahaSampingan;
            document.getElementById('pendapatan').value = d.pendapatan;
            document.getElementById('tanggalValidasi').value = d.tanggalValidasi;
            document.getElementById('validator').value = d.validator;
            document.getElementById('driveLink').value = d.driveLink;
            document.getElementById('keterangan').value = d.keterangan;
            
            // NEW: Handle Kode Validasi lock
            const kodeValidasiInput = document.getElementById('kodeValidasi');
            const btnGenerateCode = document.getElementById('btnGenerateCode');
            
            if (d.kodeValidasi && d.kodeValidasi !== '') {
                kodeValidasiInput.value = d.kodeValidasi;
                kodeValidasiInput.setAttribute('readonly', 'readonly'); // Lock the code
                btnGenerateCode.setAttribute('disabled', 'disabled'); // Disable the button
            } else {
                kodeValidasiInput.value = '';
                kodeValidasiInput.removeAttribute('readonly');
                btnGenerateCode.removeAttribute('disabled');
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteData(id) {
            // Existing logic kept intact
            if(confirm('Yakin ingin menghapus data ini?')) {
                appData = appData.filter(d => d.id != id);
                saveData();
                updateDashboard();
                renderDataTable();
                checkGlobalDuplicates();
                showNotification('Data berhasil dihapus.', 'success');
                showReloadNotification();
            }
        }
        
        function filterData() {
            // Existing logic kept intact
            const filterDesa = document.getElementById('filterDesa').value;
            const filterProfesi = document.getElementById('filterProfesi').value;
            const filterKusuka = document.getElementById('filterKusuka').value;

            return appData.filter(d => 
                (!filterDesa || d.desa === filterDesa) &&
                (!filterProfesi || d.profesi === filterProfesi) &&
                (!filterKusuka || d.kusuka === filterKusuka)
            );
        }

        // --- PDF AND EXPORT FUNCTIONS ---
        
        // Helper function to generate QR Code DataURL
        function getQrCodeDataURL(data, size = 50) {
            const qrDiv = document.getElementById('qr-left'); // Using the hidden element
            qrDiv.innerHTML = '';
            // Ensure no error if data is empty
            if (!data) data = 'Data Kosong/Tidak Valid'; 

            // Create a temporary div for QRCodeJS
            const tempDiv = document.createElement('div');
            qrDiv.appendChild(tempDiv);

            const qrcode = new QRCode(tempDiv, {
                text: data,
                width: size,
                height: size,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // QR Code generates a canvas, wait a moment and get the data URL
            const canvas = tempDiv.querySelector('canvas');
            if (canvas) {
                // Return DataURL immediately (no need for long delay, but sometimes needed for jspdf)
                return canvas.toDataURL("image/png");
            }
            return null;
        }

        // MODIFIED: downloadSinglePdf(id) - Detail PDF
        function downloadSinglePdf(id) {
            const d = appData.find(item => item.id == id);
            if (!d) return;

            const doc = new window.jspdf.jsPDF({ unit: 'mm', format: 'a4' });
            
            const validationUrl = `https://validasi.dinasperikanansitubondo.com/data?id=${d.kodeValidasi || 'TIDAK_ADA'}`;
            const qrCodeDataURL = getQrCodeDataURL(validationUrl, 30); // 30mm size

            // --- HEADER (Refined Design) ---
            const headerHeight = 40;
            doc.setFillColor(12, 36, 97); // Primary Color
            doc.rect(0, 0, 210, headerHeight, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('Montserrat', 'bold'); 
            doc.text('DOKUMEN VALIDASI DATA NELAYAN', 105, 12, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont('Inter', 'normal');
            doc.text('Dinas Perikanan Kabupaten Situbondo - One Data System', 105, 19, { align: 'center' });
            
            doc.setFontSize(18);
            doc.setFont('Dancing Script', 'bold'); 
            doc.setTextColor(246, 185, 59); // Accent Color/Gold
            doc.text('Situbondo Naik Kelas', 105, 28, { align: 'center' });
            
            doc.setDrawColor(246, 185, 59); // Accent Color
            doc.setLineWidth(1.5);
            doc.line(70, 32, 140, 32);

            // --- Content --- 
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            let y = headerHeight + 10;
            const lineHeight = 7; 
            const line = (label, value) => { 
                // Handle censoring for PDF if privacy mode is ON
                const displayValue = appSettings.privacyMode ? getCensoredText(value, label.includes('NIK')) : value;

                doc.setFont('helvetica', 'normal'); 
                doc.text(label, 20, y); 
                doc.setFont('helvetica', 'bold'); 
                doc.text(': ' + displayValue, 80, y); 
                y += lineHeight; 
            }; 
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('I. IDENTITAS PRIBADI', 20, y); y += 8;
            doc.setDrawColor(200); doc.line(20, y-3, 190, y-3);
            doc.setFontSize(10); 
            line('Nama Lengkap', d.nama); 
            line('NIK', d.nik); 
            line('Tahun Kelahiran', d.tahunLahir); 
            line('Alamat Lengkap', `${d.alamat}, ${d.desa}, ${d.kecamatan}`); 
            line('No. Handphone', d.whatsapp); 
            y += 5; 
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('II. PROFESI & KEPEMILIKAN', 20, y); y += 8;
            doc.setDrawColor(200); doc.line(20, y-3, 190, y-3);
            doc.setFontSize(10); 
            line('Status Profesi', d.profesi); 
            line('Status Pekerjaan', d.statusNelayan); 
            line('Kepemilikan KUSUKA', d.kusuka); 
            line('Alat Tangkap Utama', d.alatTangkap); 
            line('Jenis Ikan Utama', d.jenisIkan);
            y += 5;

            // Check for new page if close to bottom
            if (y > doc.internal.pageSize.height - 85) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('III. INFORMASI VALIDASI', 20, y); y += 8;
            doc.setDrawColor(200); doc.line(20, y-3, 190, y-3);
            doc.setFontSize(10); 
            line('Kode Validasi', d.kodeValidasi);
            line('Tanggal Validasi', d.tanggalValidasi);
            line('Validator', d.validator);
            line('Est. Pendapatan', `Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}`);
            line('Keterangan', d.keterangan || '-');
            y += 5;

            // --- FOOTER: Tanda Tangan and QR Code (Bottom Left) ---
            let finalY = doc.internal.pageSize.height - 70; // Position above the bottom

            // QR Code (Bottom Left)
            if (qrCodeDataURL) {
                doc.addImage(qrCodeDataURL, 'PNG', 20, finalY + 10, 35, 35); // x=20, y=finalY+10 (bottom-left)
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text("Scan untuk Validasi Digital:", 20, finalY + 8);
                doc.text(validationUrl.substring(0, 45) + '...', 20, finalY + 50);
            }
            
            // Signatures (Bottom Right)
            const rightX = 130;
            const dateStr = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'});
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Situbondo, " + dateStr, rightX, finalY);
            doc.text("Diketahui Oleh :", rightX, finalY + 15);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Nama Pejabat TTD", rightX, finalY + 45); 
            doc.setFont('helvetica', 'normal');
            doc.text("NIP 1970xxxxxx", rightX, finalY + 50);

            doc.save(`Dokumen_Validasi_Nelayan_${d.nik}.pdf`);

            // Clean up QR generator
            setTimeout(() => { document.getElementById('qr-left').innerHTML = ""; }, 300);
        }
        
        // NEW: Function to generate PDF Report with QR Code
        function generateReportPdf(data) {
            if (data.length === 0) {
                showNotification('Tidak ada data yang terfilter untuk dicetak!', 'warning');
                return;
            }

            const doc = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'mm' }); 
            
            const validationUrl = `https://validasi.dinasperikanansitubondo.com/laporan?date=${Date.now()}`;
            const qrCodeDataURL = getQrCodeDataURL(validationUrl, 30); 
            
            // --- HEADER ---
            const headerHeight = 20;
            doc.setFillColor(12, 36, 97); // Primary Color
            doc.rect(0, 0, doc.internal.pageSize.width, headerHeight, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('Montserrat', 'bold');
            doc.text('LAPORAN DATA NELAYAN TERFILTER KABUPATEN SITUBONDO', doc.internal.pageSize.width / 2, 8, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('Inter', 'normal');
            doc.text('Sistem Pemetaan Nelayan - Situbondo Naik Kelas', doc.internal.pageSize.width / 2, 14, { align: 'center' });
            
            // Prepare Data and handle censoring
            const columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'Nama', dataKey: 'nama' },
                { header: 'NIK', dataKey: 'nik' },
                { header: 'Profesi', dataKey: 'profesi' },
                { header: 'Status', dataKey: 'statusNelayan' },
                { header: 'Kusuka', dataKey: 'kusuka' },
                { header: 'Kecamatan', dataKey: 'kecamatan' },
                { header: 'Desa', dataKey: 'desa' },
                { header: 'K. Validasi', dataKey: 'kodeValidasi' },
            ];

            const rows = data.map((d, index) => {
                const row = {
                    no: index + 1,
                    nama: d.nama,
                    nik: d.nik,
                    profesi: d.profesi,
                    statusNelayan: d.statusNelayan,
                    kusuka: d.kusuka,
                    kecamatan: d.kecamatan,
                    desa: d.desa,
                    kodeValidasi: d.kodeValidasi,
                };
                
                // Apply Sensor Mode manually
                if (appSettings.privacyMode && row.nik && row.nik.length > 4) {
                    row.nik = '************' + row.nik.substring(12);
                }
                
                return row;
            });

            doc.autoTable({
                head: [columns.map(col => col.header)],
                body: rows.map(row => columns.map(col => row[col.dataKey])),
                startY: headerHeight + 5,
                theme: 'striped',
                styles: { fontSize: 7, cellPadding: 2 },
                headStyles: { fillColor: [74, 105, 189], textColor: [255, 255, 255], fontStyle: 'bold' }, 
                margin: { top: 25, left: 10, right: 10, bottom: 25 },
                didDrawPage: function (hookData) {
                    // Re-draw header on every page
                    doc.setFillColor(12, 36, 97);
                    doc.rect(0, 0, doc.internal.pageSize.width, headerHeight, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('Montserrat', 'bold');
                    doc.text('LAPORAN DATA NELAYAN TERFILTER KABUPATEN SITUBONDO', doc.internal.pageSize.width / 2, 8, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('Inter', 'normal');
                    doc.text('Sistem Pemetaan Nelayan - Situbondo Naik Kelas', doc.internal.pageSize.width / 2, 14, { align: 'center' });
                    
                    // Footer text on every page
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text("Dokumen ini dicetak melalui Sistem One Data Dinas Perikanan Kabupaten Situbondo. Tidak sah tanpa TTD basah.", 10, doc.internal.pageSize.height - 5);
                },
            });

            // --- FOOTER: QR Code (Bottom Left, Below Table) ---
            let finalY = doc.lastAutoTable.finalY + 10;
            
            if (finalY + 50 > doc.internal.pageSize.height) { 
                doc.addPage();
                finalY = 20;
            }
            
            // QR Code (Bottom Left, Below Table)
            if (qrCodeDataURL) {
                doc.addImage(qrCodeDataURL, 'PNG', 10, finalY + 15, 35, 35); 
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text("Scan untuk Validasi Laporan:", 10, finalY + 10);
                doc.text(validationUrl.substring(0, 40) + '...', 10, finalY + 55);
            }
            
            // Signatures (Bottom Right)
            const rightX = doc.internal.pageSize.width - 70;
            const dateStr = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text("Situbondo, " + dateStr, rightX, finalY + 10);
            doc.text("Diketahui Oleh :", rightX, finalY + 25);
            doc.setFont("helvetica", "bold");
            doc.text("Kepala Bidang Pemberdayaan Nelayan", rightX, finalY + 60);
            doc.setFont('helvetica', 'normal');
            doc.text("NIP 1970xxxxxx", rightX, finalY + 65);
            
            doc.save(`Laporan_Data_Nelayan_Situbondo.pdf`);
            
            // Clean up QR generator
            setTimeout(() => { document.getElementById('qr-left').innerHTML = ""; }, 300);
        }

        // --- SETUP AND LISTENERS ---
        
        function setupEventListeners() {
            // Existing listeners (login, privacy, backup, restore, etc.) are kept intact
            // ...

            // NEW: Generate Code Button Listener
            document.getElementById('btnGenerateCode').addEventListener('click', function() {
                const kodeValidasiInput = document.getElementById('kodeValidasi');
                const nik = document.getElementById('nik').value;
                
                if (this.hasAttribute('disabled')) {
                    showNotification('Kode Validasi hanya bisa dibuat sekali!', 'warning');
                    return;
                }
                
                // Mandate NIK check before generation
                if (!nik || nik.length !== 16) {
                    showNotification('NIK harus diisi lengkap 16 digit sebelum membuat Kode Validasi!', 'error');
                    document.getElementById('nik').focus();
                    return;
                }
                
                // Check for existing code (safety check for new data entry)
                if (kodeValidasiInput.value) {
                     showNotification('Kode Validasi sudah ada. Tidak dapat di-generate ulang.', 'warning');
                     return;
                }

                const newCode = generateValidationCode();
                kodeValidasiInput.value = newCode;
                kodeValidasiInput.setAttribute('readonly', 'readonly'); // Lock the input
                this.setAttribute('disabled', 'disabled'); // Lock the button
                showNotification('Kode Validasi berhasil dibuat dan dikunci!', 'success');
            });
            
            // Update printPdfBtn listener to call the new function
            document.getElementById('printPdfBtn').addEventListener('click', function() {
                const filteredData = filterData();
                generateReportPdf(filteredData);
            });
            
            // ... (rest of the listeners) ...
            
            document.getElementById('btnDownloadDetailPdf').addEventListener('click', () => {
                downloadSinglePdf(currentDetailId);
            });
            
             // Existing code to setupFloatingMenu is called here
             setupFloatingMenu();
        }

        // ... (rest of the functions like renderDataTable, showNotification, etc. remain unchanged or are helpers) ...

        function showNotification(msg, type = 'info') {
             const toastEl = document.querySelector('.notification-toast');
             const header = toastEl.querySelector('.toast-header');
             const styles = { success: { cls: 'bg-success text-white', title: 'Sukses', icon: 'fas fa-check' }, error: { cls: 'bg-danger text-white', title: 'Error', icon: 'fas fa-times' }, info: { cls: 'bg-primary text-white', title: 'Info', icon: 'fas fa-info-circle' }, warning: { cls: 'bg-warning text-dark', title: 'Peringatan', icon: 'fas fa-exclamation-triangle' } };
             const style = styles[type] || styles.info;
             header.className = `toast-header ${style.cls}`;
             document.getElementById('toastIcon').className = style.icon + ' me-2';
             document.getElementById('toastTitle').textContent = style.title;
             document.getElementById('toastMessage').textContent = msg;
             new bootstrap.Toast(toastEl).show();
        }
        
        // --- Helper function from original code (must be kept) ---
        function toggleBoatRequirements(isRequired) { /* ... */ }
        function setupFloatingMenu() { /* ... */ }
        function handleReloadRepo() { /* ... */ }
        function renderDataTable() { /* ... */ }
        function viewDetail(id) { /* ... */ }
        function updatePagination(total) { /* ... */ }
        function toggleBulkDeleteBtn() { /* ... */ }
        function bulkDeleteData() { /* ... */ }
        function renderFilterTable(data) { /* ... */ }
        function startDuplicateChecker() { /* ... */ }
        function checkGlobalDuplicates() { /* ... */ }
        // ... and other existing helper functions ...
        
    </script>
</body>
</html>
