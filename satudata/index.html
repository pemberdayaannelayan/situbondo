<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM PEMETAAN NELAYAN - DESA KILENSARI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Palette: Professional Maritime Government Theme */
            --primary-color: #0F2027; /* Dark Deep Blue */
            --secondary-color: #203A43; /* Teal Tone */
            --accent-color: #F39C12; /* Golden Warning */
            --danger-color: #C0392B;
            --success-color: #27ae60;
            
            --header-gradient: linear-gradient(to right, #0F2027, #203A43, #2C5364);
            --sidebar-active: #2C5364;
            
            --glass-effect: rgba(255, 255, 255, 0.98);
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        body {
            background-color: #f0f2f5;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* --- REDESIGNED LOGIN --- */
        .login-overlay {
            background: var(--header-gradient);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        
        .login-card {
            background: white;
            width: 100%; max-width: 450px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideUp 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .login-header-new {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230F2027' fill-opacity='0.1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E"), var(--header-gradient);
            background-size: cover;
            background-position: center bottom;
            padding: 40px 30px;
            text-align: center;
            color: white;
        }

        /* --- REDESIGNED HEADER --- */
        .app-header {
            background: var(--header-gradient);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-bottom: 4px solid var(--accent-color);
        }
        
        .app-logo-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            background: rgba(255,255,255,0.1);
            width: 80px; height: 80px;
            line-height: 80px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .app-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e1e4e8;
        }

        /* Navigation */
        .nav-pills .nav-link {
            border-radius: 0 25px 25px 0;
            margin-bottom: 5px;
            padding: 12px 20px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border-left: 4px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #f8f9fa;
            color: var(--secondary-color);
            padding-left: 25px;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            border-left: 4px solid var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Chart Fix */
        .chart-container-fixed {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Table & Utilities */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid var(--accent-color);
            padding-left: 15px;
            margin: 20px 0 25px 0;
            font-weight: 700;
            color: var(--secondary-color);
            font-size: 1.4rem;
        }

        .data-table th { background: var(--secondary-color) !important; color: white; font-weight: 500; font-size: 0.85rem; }
        .data-table tr.table-danger td { background-color: #ffebee !important; } /* Highlight Duplicate */

        /* Floating Button */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; }
        .fab-main { width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); color: white; border: none; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4); font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .fab-main:hover { transform: scale(1.1) rotate(90deg); }
        
        .fab-item { width: 50px; height: 50px; border-radius: 50%; background: white; color: var(--secondary-color); border: 2px solid var(--secondary-color); display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 3px 10px rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none; }
        .fab-container.open .fab-item { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item:hover { background: var(--secondary-color); color: white; }

        /* Animation */
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: slideUp 0.5s ease-out; }

        /* Responsive */
        @media (max-width: 991.98px) {
            .col-md-3.col-lg-2 { display: none; }
            .mobile-show { display: block !important; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1050; width: 280px; overflow-y: auto; background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .mobile-menu-btn { display: block; position: fixed; top: 15px; left: 15px; z-index: 1060; background: var(--secondary-color); color: white; padding: 10px 14px; border-radius: 6px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        }
    </style>
</head>
<body>
    
    <div class="login-overlay" id="loginModal">
        <div class="login-card">
            <div class="login-header-new">
                <i class="fas fa-anchor fa-3x mb-3 text-warning"></i>
                <h4 class="fw-bold mb-1" style="font-family: 'Montserrat'; letter-spacing: 1px;">SISTEM SATU DATA</h4>
                <p class="mb-0 small text-white-50">KABUPATEN SITUBONDO - DESA KILENSARI</p>
            </div>
            <div class="p-4 p-md-5">
                <form id="loginForm">
                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold text-uppercase">Kode Keamanan Sistem</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-shield-alt text-secondary"></i></span>
                            <input type="password" class="form-control bg-light border-start-0 fs-6" id="securityCode" value="BidangPN1945" readonly style="font-family: monospace;">
                        </div>
                        <div class="form-text text-end"><small class="text-success"><i class="fas fa-lock me-1"></i>Terkunci Otomatis</small></div>
                    </div>
                    <button type="submit" class="btn btn-dark w-100 py-3 fw-bold shadow-sm" style="background: var(--secondary-color);" id="loginButton">
                        MASUK DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon"><i class="fas fa-ship"></i></div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle">PEMERINTAH KABUPATEN SITUBONDO - DESA KILENSARI</p>
                <div class="position-absolute bottom-0 end-0 p-2 text-white-50 small pe-4">Professional Edition v4.0 (Enhanced)</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-3 bg-light border-end" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt me-3"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit me-3"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-table me-3"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter me-3"></i> Filter Data</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print me-3"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export me-3"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt me-3"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog me-3"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync me-3"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top">
                             <button class="nav-link text-danger w-100 justify-content-start" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt me-3"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-4 p-lg-5" style="background-color: #fff;">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard">
                            <h3 class="section-title">Ringkasan Eksekutif</h3>
                            <div class="row g-4">
                                <div class="col-lg-3 col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid var(--primary-color) !important;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small fw-bold text-uppercase">Total Nelayan</span>
                                                <i class="fas fa-users text-secondary opacity-25 fa-2x"></i>
                                            </div>
                                            <h2 class="fw-bold text-dark mb-0" id="totalPenerima">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid var(--accent-color) !important;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small fw-bold text-uppercase">Est. Pendapatan</span>
                                                <i class="fas fa-chart-line text-warning opacity-25 fa-2x"></i>
                                            </div>
                                            <h3 class="fw-bold text-dark mb-0" id="totalBantuan">Rp 0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid var(--success-color) !important;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small fw-bold text-uppercase">Pemilik Kapal</span>
                                                <i class="fas fa-ship text-success opacity-25 fa-2x"></i>
                                            </div>
                                            <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #6c757d !important;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small fw-bold text-uppercase">Rata-rata Usia</span>
                                                <i class="fas fa-user-clock text-secondary opacity-25 fa-2x"></i>
                                            </div>
                                            <h2 class="fw-bold text-dark mb-0" id="rataUsia">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white fw-bold"><i class="fas fa-chart-pie me-2"></i> Proporsi Profesi</div>
                                        <div class="card-body">
                                            <div class="chart-container-fixed">
                                                <canvas id="profesiChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white fw-bold"><i class="fas fa-chart-bar me-2"></i> Statistik Kepemilikan Kapal</div>
                                        <div class="card-body">
                                            <div class="chart-container-fixed">
                                                <canvas id="kapalChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-input">
                            <h3 class="section-title">Formulir Pendataan</h3>
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white py-3"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                <div class="card-body p-4">
                                    <form id="inputForm" novalidate>
                                        <div class="alert alert-info small mb-4"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Sistem akan menolak jika NIK sudah terdaftar sebelumnya.</div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="nama" class="form-label">Nama Lengkap</label>
                                                <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan)</label>
                                                <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="whatsapp" class="form-label">Nomor WhatsApp</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">+62</span>
                                                    <input type="tel" class="form-control" id="whatsapp" required placeholder="8123xxxx">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="profesi" class="form-label">Kategori Profesi</label>
                                                <select class="form-select" id="profesi" required>
                                                    <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                    <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="statusNelayan" class="form-label">Status Pekerjaan</label>
                                                <select class="form-select" id="statusNelayan">
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="tahunLahir" class="form-label">Tahun Kelahiran</label>
                                                <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                <input type="text" class="form-control bg-light" id="usia" readonly>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="kecamatan" class="form-label">Kecamatan</label>
                                                <select class="form-select" id="kecamatan" required><option value="">Pilih Kecamatan</option></select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="desa" class="form-label">Desa</label>
                                                <select class="form-select" id="desa" required><option value="">Pilih Desa</option></select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="alamat" class="form-label">Alamat Lengkap</label>
                                            <textarea class="form-control" id="alamat" rows="2" placeholder="Dusun, RT/RW"></textarea>
                                        </div>

                                        <div id="ownerFields" style="display:none;" class="bg-light p-4 rounded mb-3 border">
                                            <h6 class="text-primary fw-bold border-bottom pb-2 mb-3"><i class="fas fa-ship me-2"></i>Detail Aset Kapal</h6>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Nama Kapal</label>
                                                    <input type="text" class="form-control" id="namaKapal">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Jenis Kapal</label>
                                                    <select class="form-select" id="jenisKapal">
                                                        <option value="Perahu Jukung">Perahu Jukung</option>
                                                        <option value="Perahu Mayang">Perahu Mayang</option>
                                                        <option value="Perahu Slerek">Perahu Slerek</option>
                                                        <option value="Lainnya">Lainnya</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Ukuran (GT)</label>
                                                    <input type="text" class="form-control" id="ukuranKapal">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Mesin (PK)</label>
                                                    <input type="text" class="form-control" id="mesinKapal">
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Alat Tangkap</label>
                                                <select class="form-select" id="alatTangkap">
                                                    <option value="Jaring Lingkar (purse seine)">Jaring Lingkar (purse seine)</option>
                                                    <option value="Jaring Insang (gill net)">Jaring Insang (gill net)</option>
                                                    <option value="Jaring Angkat (lift net)">Jaring Angkat (lift net)</option>
                                                    <option value="Pancing">Pancing</option>
                                                    <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                    <option value="Lainnya">Lainnya</option>
                                                </select>
                                            </div>
                                            <div class="p-3 bg-white border rounded">
                                                <label class="form-label d-block fw-bold">Kepemilikan Dokumen (BPKP / PAS)</label>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenYa" value="Ya">
                                                    <label class="form-check-label" for="dokumenYa">Ada</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenTidak" value="Tidak" checked>
                                                    <label class="form-check-label" for="dokumenTidak">Tidak Ada</label>
                                                </div>
                                                <div id="nomorPasContainer" class="mt-2" style="display:none;">
                                                    <input type="text" class="form-control form-control-sm" id="nomorPas" placeholder="Masukkan Nomor PAS KAPAL">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="jenisIkan" class="form-label">Jenis Ikan Tangkapan Utama</label>
                                                <input type="text" class="form-control" id="jenisIkan" required placeholder="Contoh: Tongkol, Layang">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="usahaSampingan" class="form-label">Usaha Sampingan</label>
                                                <input type="text" class="form-control" id="usahaSampingan" placeholder="Contoh: Ternak, Warung">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="pendapatan" class="form-label">Est. Pendapatan/Bulan (Rp)</label>
                                                <input type="number" class="form-control" id="pendapatan" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="tanggalValidasi" class="form-label">Tanggal Validasi</label>
                                                <input type="date" class="form-control" id="tanggalValidasi" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="validator" class="form-label">Petugas Validator</label>
                                                <input type="text" class="form-control" id="validator" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="driveLink" class="form-label">Link Dokumen (Google Drive)</label>
                                                <input type="url" class="form-control" id="driveLink">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="kodeValidasi" class="form-label">Kode Validasi</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control bg-light" id="kodeValidasi" readonly>
                                                    <button type="button" class="btn btn-secondary" id="generateKodeBtn">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                                            <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end border-top pt-3">
                                            <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                            <button type="submit" class="btn btn-primary px-4 fw-bold" style="background-color: var(--secondary-color);"><i class="fas fa-save me-2"></i>SIMPAN DATA</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data">
                            <h3 class="section-title">Database Nelayan</h3>
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white py-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Data Terdaftar</h6>
                                        </div>
                                        <div class="col-md-8 d-flex justify-content-end gap-2">
                                            <div class="input-group" style="max-width: 400px;">
                                                <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                                                <input type="text" class="form-control" id="searchData" placeholder="Cari cerdas (Nama, NIK, Kapal, Alamat, dll)...">
                                            </div>
                                            <button class="btn btn-danger btn-sm d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-1"></i> Hapus Terpilih</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0 align-middle" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th width="40" class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                    <th>No</th>
                                                    <th>Identitas Nelayan</th>
                                                    <th>Kontak</th>
                                                    <th>Profesi & Status</th>
                                                    <th>Aset Kapal</th>
                                                    <th>Pendapatan</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data database...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                    <div class="p-2 small text-muted fst-italic text-end border-top">
                                        <i class="fas fa-info-circle text-danger me-1"></i> Baris berwarna <span class="badge bg-danger">Merah</span> menandakan duplikasi NIK. Harap periksa kembali.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-filter">
                             <h3 class="section-title">Filter Data Lanjutan</h3>
                             <div class="card mb-4 border-0 shadow-sm">
                                <div class="card-body bg-light rounded">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Desa</label>
                                            <select class="form-select form-select-sm" id="filterDesa"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Profesi</label>
                                            <select class="form-select form-select-sm" id="filterProfesi">
                                                <option value="">Semua</option>
                                                <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                <option value="Nelayan Musiman">Nelayan Musiman</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Status Kepemilikan</label>
                                            <select class="form-select form-select-sm" id="filterStatus">
                                                <option value="">Semua</option>
                                                <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                <option value="Pemilik Kapal">Pemilik Kapal</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Jenis Kapal</label>
                                            <select class="form-select form-select-sm" id="filterJenisKapal">
                                                <option value="">Semua</option>
                                                <option value="Perahu Jukung">Perahu Jukung</option>
                                                <option value="Perahu Mayang">Perahu Mayang</option>
                                                <option value="Perahu Slerek">Perahu Slerek</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Dokumen Kapal</label>
                                            <select class="form-select form-select-sm" id="filterDokumen">
                                                <option value="">Semua</option>
                                                <option value="Ya">Punya Dokumen</option>
                                                <option value="Tidak">Tidak Punya</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">Usaha Sampingan</label>
                                            <select class="form-select form-select-sm" id="filterUsaha">
                                                <option value="">Semua</option>
                                                <option value="Ada">Ada Usaha Sampingan</option>
                                                <option value="Tidak">Tidak Ada</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary w-100 btn-sm" style="background-color: var(--secondary-color);" id="applyFilterBtn"><i class="fas fa-search me-2"></i> Terapkan Filter</button>
                                        </div>
                                    </div>
                                </div>
                             </div>
                             <div class="card border-0 shadow-sm">
                                 <div class="card-body p-0">
                                     <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0">
                                            <thead><tr><th>No</th><th>Nama</th><th>Status</th><th>Jenis Kapal</th><th>Dokumen</th><th>Usaha Sampingan</th><th>Pendapatan</th></tr></thead>
                                            <tbody id="filterTableBody"><tr><td colspan="7" class="text-center py-4">Silakan terapkan filter untuk melihat hasil</td></tr></tbody>
                                        </table>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-print">
                            <h3 class="section-title">Cetak Laporan</h3>
                            <div class="card p-5 text-center shadow-sm border-0">
                                <div class="mb-3"><i class="fas fa-file-pdf fa-4x text-danger opacity-50"></i></div>
                                <h5>Cetak Laporan Data Terfilter</h5>
                                <p class="text-muted">Fitur ini akan mencetak data sesuai hasil filter terakhir dalam format PDF Resmi.</p>
                                <button class="btn btn-danger px-5 mt-3 shadow" id="printPdfBtn"><i class="fas fa-download me-2"></i> Download PDF</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-export">
                            <h3 class="section-title">Ekspor & Pelaporan Data</h3>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <div class="card p-4 border-success bg-white shadow-sm" style="border-left: 5px solid #25D366;">
                                        <div class="d-flex align-items-start">
                                            <div class="me-4 text-success"><i class="fab fa-whatsapp fa-3x"></i></div>
                                            <div>
                                                <h5 class="fw-bold text-dark mb-2">Lapor Cepat via WhatsApp Center</h5>
                                                <p class="mb-2 text-muted" style="line-height: 1.6;">
                                                    Silakan unduh data dalam format <strong>Excel</strong> atau <strong>JSON</strong> terlebih dahulu melalui tombol di bawah. 
                                                    Selanjutnya, klik tombol <strong>"Kirim Laporan"</strong> untuk terhubung ke WhatsApp Administrator Dinas Perikanan Kabupaten Situbondo. 
                                                    <br><span class="text-danger small">*Harap lampirkan file yang telah diunduh pada chat WhatsApp tersebut sebagai bukti sinkronisasi data.</span>
                                                </p>
                                                <button class="btn btn-success mt-2 px-4" id="sendWaBtn"><i class="fas fa-paper-plane me-2"></i> Kirim Laporan ke Pusat</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4"><button class="btn btn-outline-success w-100 py-4 h-100 shadow-sm" id="exportExcelBtn"><i class="fas fa-file-excel fa-2x mb-2 d-block"></i>Download Excel</button></div>
                                <div class="col-md-4"><button class="btn btn-outline-info w-100 py-4 h-100 shadow-sm" id="exportCsvBtn"><i class="fas fa-file-csv fa-2x mb-2 d-block"></i>Download CSV</button></div>
                                <div class="col-md-4"><button class="btn btn-outline-warning w-100 py-4 h-100 shadow-sm" id="exportJsonBtn"><i class="fas fa-file-code fa-2x mb-2 d-block"></i>Download JSON</button></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-backup">
                            <h3 class="section-title">Backup & Restore</h3>
                            <div class="alert alert-warning small"><i class="fas fa-exclamation-triangle me-2"></i> <strong>Sistem Smart Restore:</strong> Data yang direstore akan <strong>DIGABUNGKAN</strong> dengan data yang ada (Merge), tidak menghapus data lama. Duplikasi NIK akan ditandai Merah.</div>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                        <div class="mb-3"><i class="fas fa-cloud-download-alt fa-3x text-primary"></i></div>
                                        <h5>Download Backup</h5>
                                        <p class="small text-muted mb-4">Simpan seluruh database lokal ke file aman.</p>
                                        <button class="btn btn-primary w-100" id="backupDataBtn">Download Data (.js)</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card p-4 h-100 text-center border-warning shadow-sm">
                                        <div class="mb-3"><i class="fas fa-cloud-upload-alt fa-3x text-warning"></i></div>
                                        <h5>Restore Data</h5>
                                        <p class="small text-muted mb-0">Gabungkan data dari file backup.</p>
                                        <input type="file" class="form-control my-3" id="restoreFileInput" accept=".js,.json">
                                        <button class="btn btn-warning w-100 text-white" id="restoreDataBtn" disabled>Proses Restore & Merge</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-settings">
                            <h3 class="section-title">Pengaturan Sistem</h3>
                            <div class="card p-4 border-0 shadow-sm">
                                <form id="settingsForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nama Aplikasi</label>
                                            <input type="text" class="form-control" id="appName" value="SISTEM PEMETAAN DATA NELAYAN">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Nama Instansi</label>
                                            <input type="text" class="form-control" id="appSubtitle" value="PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary bg-dark border-0">Simpan Pengaturan</button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <a href="#" class="fab-item" id="fabInput" title="Input Data"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" title="Filter"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabExport" title="Ekspor"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" title="Backup"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" title="Pengaturan"><i class="fas fa-cog"></i></a>
            <a href="#" class="fab-item" id="fabReload" title="Reload Repo"><i class="fas fa-sync"></i></a>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast notification-toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- DATA CONSTANTS ---
        const SITUBONDO_DATA = {
            kecamatanList: [
                "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", "Bungatan", "Jangkar", 
                "Jatibanteng", "Kapongan", "Kendit", "Mangaran", "Mlandingan", "Panarukan", "Panji", 
                "Situbondo", "Suboh", "Sumbermalang"
            ],
            desaList: [
                "Kilensari", "Gelung", "Sumberkolak", "Peleyan", "Alasmalang", "Wringinanom", "Duwet", "Panaongan", "Paowan", "Awar-Awar", "Panarukan", 
                "Arjasa", "Curah Sreseh", "Jambangan", "Kayumas", "Kedungdowo", "Patemon", "Bayeman", "Curah Kalak", "Gadingan", "Guci", "Jelbudan", "Sumberwaru",
                "Kalianget", "Lubawang", "Tepos", "Sumberanyar", "Bulu", "Wonorejo", "Tunggulsari", "Temu",
                "Blimbing", "Demung", "Kalimas", "Kesambi Rampak", "Langkap", "Pesisir", "Widoropayung",
                "Pasir Putih", "Curah Tamiang", "Gedangan", "Jangkar", "Klatakan", "Pondok Labu", "Sumberejo", "Pesanggrahan"
            ].sort().filter((v, i, a) => a.indexOf(v) === i)
        };

        // --- GLOBAL VARIABLES ---
        let appData = [];
        let appSettings = {
            appName: 'SISTEM PEMETAAN DATA NELAYAN',
            appSubtitle: 'PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN',
            itemsPerPage: 10
        };
        let currentPage = 1;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Load logic
            initializeApp();
            setupEventListeners();
            
            // Show Login
            setTimeout(() => {
                document.getElementById('loginModal').style.display = 'flex';
            }, 100);
        });

        function initializeApp() {
            loadData();
            loadSettings();
            
            fillDropdown('kecamatan', SITUBONDO_DATA.kecamatanList, 'Pilih Kecamatan');
            fillDropdown('desa', SITUBONDO_DATA.desaList, 'Pilih Desa');
            fillDropdown('filterDesa', SITUBONDO_DATA.desaList, 'Semua Desa');
            
            document.getElementById('tanggalValidasi').value = new Date().toISOString().split('T')[0];
            updateAppIdentity();
            initializeCharts();
        }

        function fillDropdown(id, list, defaultText) {
            const select = document.getElementById(id);
            if(!select) return;
            select.innerHTML = `<option value="">${defaultText}</option>`;
            list.forEach(item => select.add(new Option(item, item)));
        }

        function updateAppIdentity() {
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Authentication
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginButton');
                btn.disabled = true;
                btn.innerHTML = 'VERIFIKASI... <span class="spinner-border spinner-border-sm ms-2"></span>';
                
                setTimeout(() => {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    updateDashboard();
                    renderDataTable();
                }, 1000);
            });

            // Form Handling
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('inputForm').addEventListener('reset', () => {
                setTimeout(() => {
                    document.getElementById('ownerFields').style.display = 'none';
                    document.getElementById('usia').value = '';
                    document.getElementById('inputForm').removeAttribute('data-edit-id');
                }, 100);
            });
            
            // Conditional Logic
            document.getElementById('statusNelayan').addEventListener('change', function() {
                const ownerFields = document.getElementById('ownerFields');
                ownerFields.style.display = (this.value === 'Pemilik Kapal') ? 'block' : 'none';
                if(this.value === 'Pemilik Kapal') {
                    document.querySelector('input[name="dokumenOption"]:checked').dispatchEvent(new Event('change'));
                }
            });

            document.querySelectorAll('input[name="dokumenOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isYes = this.value === 'Ya';
                    document.getElementById('nomorPasContainer').style.display = isYes ? 'block' : 'none';
                });
            });

            document.getElementById('tahunLahir').addEventListener('input', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                if(year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                    document.getElementById('usia').value = currentYear - year;
                }
            });

            document.getElementById('generateKodeBtn').addEventListener('click', function() {
                const nik = document.getElementById('nik').value;
                if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
                document.getElementById('kodeValidasi').value = 'VLD-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            });

            // Navigation Mobile
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebarMenu').classList.toggle('mobile-show');
            });
            document.getElementById('v-pills-logout-tab').addEventListener('click', () => location.reload());

            // Search & Filters
            document.getElementById('searchData').addEventListener('input', renderDataTable);
            document.getElementById('applyFilterBtn').addEventListener('click', renderFilterTable);
            
            // Checkbox Select All
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                toggleBulkDeleteBtn();
            });
            
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteData);

            // Actions
            document.getElementById('printPdfBtn').addEventListener('click', printData);
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('xlsx'));
            document.getElementById('exportCsvBtn').addEventListener('click', () => exportData('csv'));
            document.getElementById('exportJsonBtn').addEventListener('click', () => exportData('json'));
            document.getElementById('sendWaBtn').addEventListener('click', sendDataToWhatsapp);
            
            // Backup
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            document.getElementById('restoreFileInput').addEventListener('change', function() {
                document.getElementById('restoreDataBtn').disabled = !this.files.length;
            });
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
            document.getElementById('btn-reload-repo').addEventListener('click', handleReloadRepo);
            
            // Settings
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                appSettings.appName = document.getElementById('appName').value;
                appSettings.appSubtitle = document.getElementById('appSubtitle').value;
                localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
                updateAppIdentity();
                showNotification('Pengaturan tersimpan!', 'success');
            });

            // Floating Menu Interactions
            setupFloatingMenu();
        }

        function setupFloatingMenu() {
            const fabMain = document.getElementById('fabMainBtn');
            const container = document.getElementById('fabMenu');
            
            fabMain.addEventListener('click', () => {
                container.classList.toggle('open');
                const icon = fabMain.querySelector('i');
                if(container.classList.contains('open')){
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-times');
                    fabMain.style.transform = "rotate(90deg)";
                } else {
                    icon.classList.add('fa-plus');
                    icon.classList.remove('fa-times');
                    fabMain.style.transform = "rotate(0deg)";
                }
            });

            // Shortcut Actions
            const shortcuts = {
                'fabInput': 'v-pills-input-tab',
                'fabFilter': 'v-pills-filter-tab',
                'fabExport': 'v-pills-export-tab',
                'fabBackup': 'v-pills-backup-tab',
                'fabSettings': 'v-pills-settings-tab'
            };

            for (const [id, tabId] of Object.entries(shortcuts)) {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById(tabId).click();
                    container.classList.remove('open');
                });
            }

            document.getElementById('fabReload').addEventListener('click', (e) => {
                e.preventDefault();
                handleReloadRepo();
            });
        }

        // --- CORE LOGIC ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const nik = document.getElementById('nik').value;
            const whatsapp = document.getElementById('whatsapp').value;

            if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
            if(!whatsapp.match(/^\d+$/)) return showNotification('WhatsApp hanya angka', 'error');

            const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
            
            // STRICT DUPLICATE CHECK FOR MANUAL INPUT
            const duplicateCheck = appData.find(d => d.nik === nik);
            if (duplicateCheck && (!editId || duplicateCheck.id != editId)) {
                return showNotification('GAGAL: NIK sudah terdaftar dalam sistem!', 'error');
            }

            const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
            
            const formData = {
                id: editId || Date.now(),
                nama: document.getElementById('nama').value,
                nik: nik,
                whatsapp: whatsapp,
                profesi: document.getElementById('profesi').value,
                status: document.getElementById('statusNelayan').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                usia: document.getElementById('usia').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alamat: document.getElementById('alamat').value,
                // Owner specifics
                namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                ukuranKapal: isOwner ? document.getElementById('ukuranKapal').value : '-',
                mesinKapal: isOwner ? document.getElementById('mesinKapal').value : '-',
                alatTangkap: isOwner ? document.getElementById('alatTangkap').value : '-',
                punyaDokumen: isOwner ? document.querySelector('input[name="dokumenOption"]:checked').value : '-',
                nomorPas: isOwner && document.getElementById('dokumenYa').checked ? document.getElementById('nomorPas').value : '-',
                // Eco
                jenisIkan: document.getElementById('jenisIkan').value,
                usahaSampingan: document.getElementById('usahaSampingan').value,
                pendapatan: document.getElementById('pendapatan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value
            };

            if (editId) {
                const index = appData.findIndex(item => item.id == editId);
                appData[index] = formData;
                document.getElementById('inputForm').removeAttribute('data-edit-id');
                showNotification('Data berhasil diperbarui', 'success');
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan', 'success');
            }

            saveData();
            document.getElementById('inputForm').reset();
            document.getElementById('ownerFields').style.display = 'none';
            updateDashboard();
            renderDataTable();
            document.getElementById('v-pills-data-tab').click();
        }

        // --- SMART SEARCH & DUPLICATE HIGHLIGHT RENDERER ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const search = document.getElementById('searchData').value.toLowerCase();
            
            // SMART SEARCH ALGORITHM: Stringify entire object to search all fields
            let filtered = appData.filter(d => 
                JSON.stringify(d).toLowerCase().includes(search)
            );

            // DETECT DUPLICATES FOR HIGHLIGHTING
            const nikCounts = {};
            appData.forEach(d => nikCounts[d.nik] = (nikCounts[d.nik] || 0) + 1);

            const totalItems = filtered.length;
            const start = (currentPage - 1) * appSettings.itemsPerPage;
            const pageData = filtered.slice(start, start + appSettings.itemsPerPage);

            tableBody.innerHTML = '';
            if(pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Data tidak ditemukan</td></tr>`;
                toggleBulkDeleteBtn(); // hide btn
                return;
            }

            pageData.forEach((d, i) => {
                const kapalInfo = d.status === 'Pemilik Kapal' ? `<div class="small fw-bold text-primary">${d.namaKapal}</div><div class="small text-muted">${d.jenisKapal}</div>` : '-';
                
                // Highlight Logic
                const isDuplicate = nikCounts[d.nik] > 1;
                const rowClass = isDuplicate ? 'table-danger' : '';

                const row = `<tr class="${rowClass}">
                    <td class="text-center"><input type="checkbox" class="row-checkbox" value="${d.id}" onchange="toggleBulkDeleteBtn()"></td>
                    <td>${start + i + 1}</td>
                    <td>
                        <div class="fw-bold text-dark">${d.nama}</div>
                        <div class="small font-monospace text-muted">${d.nik}</div>
                        ${isDuplicate ? '<span class="badge bg-danger">Duplikat NIK</span>' : ''}
                    </td>
                    <td><a href="https://wa.me/62${d.whatsapp}" target="_blank" class="text-decoration-none btn-link small"><i class="fab fa-whatsapp text-success"></i> ${d.whatsapp}</a></td>
                    <td><span class="badge bg-light text-dark border">${d.profesi}</span><br><small>${d.status}</small></td>
                    <td>${kapalInfo}</td>
                    <td>Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
                tableBody.appendChild(document.createElement('tbody')).innerHTML = row;
            });

            document.getElementById('tableInfo').textContent = `Menampilkan ${pageData.length} dari ${totalItems} data`;
            updatePagination(totalItems);
            toggleBulkDeleteBtn();
        }

        function updatePagination(total) {
            const pages = Math.ceil(total / appSettings.itemsPerPage);
            const ul = document.getElementById('pagination');
            ul.innerHTML = '';
            for(let i=1; i<=pages; i++) {
                ul.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" onclick="currentPage=${i};renderDataTable()">${i}</a></li>`;
            }
        }

        // --- BULK DELETE LOGIC ---
        function toggleBulkDeleteBtn() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length > 0;
            const btn = document.getElementById('bulkDeleteBtn');
            if(checked) btn.classList.remove('d-none'); else btn.classList.add('d-none');
        }

        function bulkDeleteData() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if(checkedBoxes.length === 0) return;

            const userCode = prompt(`Anda akan menghapus ${checkedBoxes.length} data.\nMasukkan KODE KEAMANAN (Default: 97531):`);
            
            if(userCode === "97531") {
                const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
                appData = appData.filter(d => !idsToDelete.includes(d.id.toString()));
                saveData();
                renderDataTable();
                updateDashboard();
                showNotification(`${idsToDelete.length} data berhasil dihapus`, 'success');
                document.getElementById('selectAllCheckbox').checked = false;
            } else if (userCode !== null) {
                alert("Kode keamanan SALAH!");
            }
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            document.getElementById('inputForm').setAttribute('data-edit-id', id);
            
            // Populate fields
            ['nama', 'nik', 'whatsapp', 'profesi', 'tahunLahir', 'usia', 'kecamatan', 'desa', 'alamat', 
             'jenisIkan', 'usahaSampingan', 'pendapatan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan']
             .forEach(key => document.getElementById(key).value = d[key] || '');

            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = d.status;
            statusSelect.dispatchEvent(new Event('change'));

            if(d.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal', 'ukuranKapal', 'mesinKapal', 'alatTangkap', 'nomorPas'].forEach(key => {
                    document.getElementById(key).value = d[key] || '';
                });
                const docRadio = d.punyaDokumen === 'Ya' ? document.getElementById('dokumenYa') : document.getElementById('dokumenTidak');
                docRadio.checked = true;
                docRadio.dispatchEvent(new Event('change'));
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0,0);
        }

        function deleteData(id) {
            const userCode = prompt("Masukkan KODE KEAMANAN untuk menghapus data (Default: 97531):");
            if(userCode === "97531") {
                if(confirm('Yakin menghapus data ini secara permanen?')) {
                    appData = appData.filter(d => d.id != id);
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    showNotification('Data berhasil dihapus', 'success');
                }
            } else if (userCode !== null) {
                alert("Kode keamanan SALAH!");
            }
        }

        function renderFilterTable() {
            const filters = {
                desa: document.getElementById('filterDesa').value,
                profesi: document.getElementById('filterProfesi').value,
                status: document.getElementById('filterStatus').value,
                jenisKapal: document.getElementById('filterJenisKapal').value,
                dokumen: document.getElementById('filterDokumen').value,
                usaha: document.getElementById('filterUsaha').value
            };

            const filtered = appData.filter(d => {
                const matchDesa = !filters.desa || d.desa === filters.desa;
                const matchProfesi = !filters.profesi || d.profesi === filters.profesi;
                const matchStatus = !filters.status || d.status === filters.status;
                const matchJenis = !filters.jenisKapal || (d.status === 'Pemilik Kapal' && d.jenisKapal === filters.jenisKapal);
                const matchDokumen = !filters.dokumen || (d.status === 'Pemilik Kapal' && d.punyaDokumen === filters.dokumen);
                const matchUsaha = !filters.usaha || (filters.usaha === 'Ada' ? (d.usahaSampingan && d.usahaSampingan.length > 2) : (!d.usahaSampingan || d.usahaSampingan.length < 2));
                return matchDesa && matchProfesi && matchStatus && matchJenis && matchDokumen && matchUsaha;
            });

            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';
            
            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tidak ada data yang cocok dengan filter</td></tr>`;
                return;
            }

            filtered.forEach((d, i) => {
                const docStatus = d.status === 'Pemilik Kapal' ? (d.punyaDokumen === 'Ya' ? '<span class="text-success"><i class="fas fa-check-circle"></i> Lengkap</span>' : '<span class="text-danger"><i class="fas fa-times-circle"></i> Tidak Ada</span>') : '-';
                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td><strong>${d.nama}</strong><br><small>${d.desa}</small></td>
                    <td>${d.status}</td>
                    <td>${d.status === 'Pemilik Kapal' ? d.jenisKapal : '-'}</td>
                    <td>${docStatus}</td>
                    <td>${d.usahaSampingan || '-'}</td>
                    <td>Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}</td>
                </tr>`;
            });
            showNotification(`Filter berhasil: ${filtered.length} data ditemukan`, 'success');
        }

        // --- DASHBOARD & CHARTS ---
        function initializeCharts() {
            // FIXED: maintainAspectRatio false inside a controlled container
            window.profesiChart = new Chart(document.getElementById('profesiChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: { 
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            window.kapalChart = new Chart(document.getElementById('kapalChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { 
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('totalPenerima').textContent = appData.length;
            const income = appData.reduce((acc, curr) => acc + (parseInt(curr.pendapatan)||0), 0);
            document.getElementById('totalBantuan').textContent = `Rp ${income.toLocaleString('id-ID')}`;
            document.getElementById('totalPemilik').textContent = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const avgAge = appData.length ? Math.round(appData.reduce((acc, c) => acc + (parseInt(c.usia)||0), 0) / appData.length) : 0;
            document.getElementById('rataUsia').textContent = avgAge + " Thn";

            // Charts
            const pData = {};
            appData.forEach(d => pData[d.profesi] = (pData[d.profesi] || 0) + 1);
            window.profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{ data: Object.values(pData), backgroundColor: ['#0F2027', '#F39C12', '#203A43'] }]
            };
            window.profesiChart.update();

            const kData = {};
            appData.filter(d => d.status === 'Pemilik Kapal').forEach(d => kData[d.jenisKapal] = (kData[d.jenisKapal] || 0) + 1);
            window.kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{ label: 'Unit', data: Object.values(kData), backgroundColor: '#203A43' }]
            };
            window.kapalChart.update();
        }

        // --- EXPORT, IMPORT & MERGE LOGIC ---
        function saveData() { localStorage.setItem('nelayanData', JSON.stringify(appData)); }
        function loadData() { 
            const d = localStorage.getItem('nelayanData');
            if(d) appData = JSON.parse(d);
        }
        function loadSettings() {
            const s = localStorage.getItem('nelayanSettings');
            if(s) Object.assign(appSettings, JSON.parse(s));
        }

        function exportData(type) {
            if(appData.length === 0) return showNotification('Tidak ada data', 'error');
            const data = appData.map(d => ({ ...d, NIK: `'${d.nik}`, WhatsApp: `'${d.whatsapp}` })); 

            if(type === 'xlsx') {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Data Nelayan");
                XLSX.writeFile(wb, `Nelayan_${appSettings.appSubtitle.slice(0,10)}_${Date.now()}.xlsx`);
            } else if (type === 'csv') {
                const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
                downloadFile(csv, 'text/csv', 'Data_Nelayan.csv');
            } else {
                downloadFile(JSON.stringify(appData, null, 2), 'application/json', 'Data_Nelayan.json');
            }
            showNotification(`Ekspor ${type.toUpperCase()} berhasil. Siap dikirim ke WhatsApp.`, 'success');
        }

        function sendDataToWhatsapp() {
            // PROFESSIONAL MESSAGE FORMAT
            const message = `Yth. Administrator Dinas Perikanan Kabupaten Situbondo,\n\nBerikut kami lampirkan data pembaruan Sistem Satu Data Nelayan dari:\n*${appSettings.appSubtitle}*\n\nTanggal Laporan: ${new Date().toLocaleDateString('id-ID')}\nTotal Data: ${appData.length} Records\n\nFile lampiran (.xlsx/.json) telah kami sertakan pada pesan ini untuk proses sinkronisasi database.\n\nTerima Kasih.`;
            
            // Note: Does not display number in URL, just opens the chat
            const url = `https://wa.me/6287865614222?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function downloadFile(content, type, name) {
            const blob = new Blob([content], {type: type});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        function printData() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            doc.setFontSize(14); doc.text(appSettings.appName, 40, 40);
            doc.setFontSize(10); doc.text(appSettings.appSubtitle, 40, 55);
            doc.text(`Dicetak pada: ${new Date().toLocaleString()}`, 40, 70);
            
            const rows = appData.map((d, i) => [i+1, d.nama, d.profesi, d.status, d.desa, parseInt(d.pendapatan).toLocaleString('id-ID')]);
            
            doc.autoTable({
                head: [['No', 'Nama', 'Profesi', 'Status', 'Desa', 'Pendapatan']],
                body: rows,
                startY: 90,
                theme: 'grid',
                headStyles: { fillColor: [32, 58, 67] }
            });
            doc.save(`Laporan_Nelayan.pdf`);
        }

        function backupData() {
             const dateStr = new Date().toLocaleString('id-ID');
             const headerInfo = `// BACKUP DATA SISTEM NELAYAN\n// INSTANSI: ${appSettings.appSubtitle}\n// TANGGAL: ${dateStr}\n// ==============================\n`;
             const content = `${headerInfo}window.NELAYAN_BACKUP = "${btoa(JSON.stringify(appData))}";`;
             const blob = new Blob([content], {type: 'text/javascript'});
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = 'download.js';
             a.click();
             showNotification('File Backup aman telah dibuat', 'success');
        }

        // MERGE DATA LOGIC FOR RELOAD & RESTORE
        function mergeAndRestore(newDataArray) {
            if(!newDataArray || !Array.isArray(newDataArray)) return false;
            
            // SMART MERGE: APPEND DATA, DO NOT OVERWRITE
            // IDs might conflict, so we regenerate IDs for imported data but keep NIKs for validation
            const incoming = newDataArray.map(d => ({...d, id: Date.now() + Math.random().toString(36).substr(2, 5)}));
            
            appData = [...appData, ...incoming]; // Combine arrays
            
            saveData();
            renderDataTable();
            updateDashboard();
            return true;
        }

        function handleReloadRepo() {
            if(!confirm("Anda akan MENGGABUNGKAN data dari file 'download.js' lokal ke database saat ini.\nLanjutkan?")) return;
            
            const script = document.createElement('script');
            script.src = './download.js?v=' + Date.now();
            
            script.onload = () => {
                if(window.NELAYAN_BACKUP) {
                    try {
                        const newData = JSON.parse(atob(window.NELAYAN_BACKUP));
                        mergeAndRestore(newData);
                        showNotification('Data berhasil digabungkan (Merge)! Periksa baris Merah untuk duplikasi.', 'success');
                    } catch(e) { showNotification('Gagal memproses data backup', 'error'); }
                } else {
                    showNotification('Variabel backup tidak ditemukan', 'error');
                }
            };
            script.onerror = () => showNotification('File download.js tidak ditemukan di folder root', 'error');
            document.body.appendChild(script);
        }

        function restoreData() {
            const file = document.getElementById('restoreFileInput').files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let restored = [];
                const str = e.target.result;
                
                try {
                    restored = JSON.parse(str); // Try pure JSON first
                } catch {
                    const match = str.match(/window\.NELAYAN_BACKUP = "([^"]+)";/); // Try JS format
                    if(match) restored = JSON.parse(atob(match[1]));
                }

                if(restored && restored.length) {
                    if(confirm(`Ditemukan ${restored.length} data. Gabungkan ke database saat ini?`)) {
                        mergeAndRestore(restored);
                        showNotification('Restore Berhasil! Data telah digabungkan.', 'success');
                    }
                } else {
                    showNotification('Format file tidak valid', 'error');
                }
            };
            reader.readAsText(file);
        }

        function showNotification(msg, type = 'info') {
            const toastEl = document.querySelector('.notification-toast');
            const header = toastEl.querySelector('.toast-header');
            const styles = {
                success: { cls: 'bg-success text-white', title: 'Sukses' },
                error: { cls: 'bg-danger text-white', title: 'Error' },
                info: { cls: 'bg-primary text-white', title: 'Info' }
            };
            header.className = `toast-header ${styles[type].cls}`;
            document.getElementById('toastTitle').textContent = styles[type].title;
            document.getElementById('toastMessage').textContent = msg;
            new bootstrap.Toast(toastEl).show();
        }
    </script>
</body>
</html>
