<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM PEMETAAN NELAYAN - ONE DATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            /* Palette: DEEP OCEAN PROFESSIONAL THEME */
            --primary-color: #0c2461; /* Dark Blue */
            --primary-gradient: linear-gradient(135deg, #0c2461 0%, #1e3799 100%); 
            
            --secondary-color: #4a69bd; 
            --accent-color: #f6b93b; /* Gold/Yellow */
            --orange-signature: #e67e22; /* Orange for Slogan */
            
            --sidebar-active: #eaf0f9; 
            --bg-body: #f1f2f6;
            --shadow-soft: 0 10px 30px rgba(12, 36, 97, 0.15);
            
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
        }
        
        /* Custom Badge Colors */
        .badge-profesi-tetap { background-color: #0c2461 !important; color: white; }
        .badge-profesi-musiman { background-color: #e58e26 !important; color: white; }
        .badge-kusuka-ada { background-color: #27ae60 !important; color: white; }
        .badge-kusuka-tidak { background-color: #7f8c8d !important; color: white; }

        /* --- LOGIN --- */
        .login-overlay {
            background: var(--primary-gradient);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; z-index: 0; }
        .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
        .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }
        
        .login-card {
            background: white; width: 100%; max-width: 480px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow: hidden; z-index: 10; position: relative;
            animation: slideUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .login-header-new { background: white; padding: 40px 30px 20px 30px; text-align: center; color: var(--primary-color); border-bottom: 1px solid #f0f0f0; }
        .login-icon-box { width: 90px; height: 90px; background: #eaf0f9; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px; color: var(--primary-color); box-shadow: 0 10px 20px rgba(12, 36, 97, 0.1); }

        /* --- HEADER DESIGN --- */
        .app-header { 
            background: linear-gradient(120deg, #0a3d62, #3c6382), url('https://images.unsplash.com/photo-1503756234508-e32369269deb?q=80&w=2000&auto=format&fit=crop');
            background-blend-mode: multiply;
            background-size: cover;
            background-position: center;
            color: white; 
            padding: 40px 20px; 
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            border-bottom: 5px solid var(--accent-color);
            overflow: hidden; 
        }
        
        .app-logo-icon { 
            font-size: 3rem; 
            color: var(--primary-color); 
            background: white; 
            width: 100px; height: 100px; 
            line-height: 100px; 
            border-radius: 50%; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); 
            border: 4px solid rgba(255,255,255,0.8);
            transform: rotate(0deg);
            transition: transform 0.3s;
        }
        .app-logo-icon:hover { transform: scale(1.1); }

        .app-title { 
            font-family: 'Montserrat', sans-serif; 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: 1.5px;
            color: #fff;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-transform: uppercase;
        }

        .app-subtitle { 
            font-size: 1rem; 
            color: #fff; 
            margin-top: 5px; 
            font-weight: 600; 
            letter-spacing: 2px; 
            text-transform: uppercase;
        }

        .app-slogan {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem;
            color: var(--orange-signature);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            margin-top: 10px;
            font-weight: 700;
            transform: rotate(-2deg);
            display: inline-block;
        }
        
        /* Layout Container */
        .app-container { max-width: 1600px; margin: 30px auto; background: white; box-shadow: var(--shadow-soft); border-radius: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column; min-height: 90vh; }

        /* Navigation */
        .nav-pills .nav-link { border-radius: 50px; margin: 5px 15px; padding: 12px 25px; font-weight: 600; color: #636e72; transition: all 0.3s ease; font-size: 0.9rem; }
        .nav-pills .nav-link:hover { background-color: #dfe6e9; color: var(--primary-color); transform: translateX(5px); }
        .nav-pills .nav-link.active { background: var(--primary-gradient); color: white; box-shadow: 0 5px 15px rgba(12, 36, 97, 0.3); border-left: none; }
        .nav-pills .nav-link.active i { color: white; }

        /* Chart & Section */
        .chart-container-fixed { position: relative; height: 300px; width: 100%; }
        .section-title { font-family: 'Montserrat', sans-serif; margin: 10px 0 30px 0; font-weight: 700; color: #0c2461; font-size: 1.5rem; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 8px; height: 30px; background: var(--accent-color); margin-right: 15px; border-radius: 10px; }

        /* Table */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid #f1f2f6; }
        .data-table thead th { background: #dfe6e9 !important; color: #2d3436; font-weight: 800; border-bottom: 3px solid var(--primary-color); padding: 18px 15px; vertical-align: middle; }
        .data-table tbody tr:hover td { background-color: #eaf0f9; cursor: pointer; }
        .col-action { min-width: 160px; text-align: center; background: #fff; }
        .sticky-col-right { position: sticky; right: 0; background: white; box-shadow: -5px 0 10px rgba(0,0,0,0.03); z-index: 5; }

        /* Modal */
        .modal-header-custom { background: var(--primary-gradient); color: white; border-bottom: none; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #b2bec3; margin-bottom: 2px; }
        .detail-value { font-size: 1.1rem; font-weight: 600; color: #2d3436; margin-bottom: 15px; border-bottom: 1px solid #dfe6e9; padding-bottom: 5px; }

        /* Fab */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: var(--accent-color); color: #0c2461; border: none; box-shadow: 0 10px 25px rgba(246, 185, 59, 0.4); font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .fab-main:hover { transform: scale(1.1) rotate(90deg); background: #e58e26; color: white; }
        .fab-item { width: 50px; height: 50px; border-radius: 50%; background: white; color: var(--primary-color); border: 2px solid var(--primary-color); display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none; }
        .fab-container.open .fab-item { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item:hover { background: var(--primary-color); color: white; }

        /* Warning & Footer */
        .sticky-warning { position: fixed; top: 20px; right: 20px; z-index: 1080; background: white; border-left: 5px solid var(--danger-color); box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 20px; border-radius: 8px; width: 320px; display: none; animation: slideInLeft 0.5s; }
        .main-footer { background: #fff; border-top: 1px solid #dfe6e9; padding: 30px 0; margin-top: auto; text-align: center; }
        
        /* Hidden Div for QR Code Generation */
        #qr-code-generator {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        @keyframes slideInLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: slideUp 0.6s ease-out; }

        /* Responsive */
        @media (max-width: 991.98px) {
            .col-md-3.col-lg-2 { display: none; }
            .mobile-show { display: block !important; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1050; width: 280px; overflow-y: auto; background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .mobile-menu-btn { display: block; position: fixed; top: 15px; left: 15px; z-index: 1060; background: var(--accent-color); color: #0c2461; padding: 10px 14px; border-radius: 6px; border: none; }
        }
    </style>
</head>
<body>

    <div id="qr-code-generator">
        <div id="qr-left"></div>
        <div id="qr-right"></div>
    </div>

    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="login-icon-box">
                    <i class="fas fa-ship fa-3x"></i> </div>
                <h4 class="fw-bold mb-1" style="font-family: 'Montserrat'; letter-spacing: 0.5px;">SISTEM SATU DATA</h4>
                <p class="mb-0 text-muted small">KABUPATEN SITUBONDO</p>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode otoritas untuk mengakses sistem.</p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" value="BidangPN1945" readonly style="font-family: monospace;">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-filter-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon">
                    <i class="fas fa-ship"></i>
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="position-absolute top-0 end-0 p-3">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill"><i class="fas fa-circle text-success me-2 small"></i>Online v5.0 (Blue Ocean)</span>
                </div>
            </div>
            
            <div class="row g-0 flex-grow-1">
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-4 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt me-3"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit me-3"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database me-3"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter me-3"></i> Filter & Validasi</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print me-3"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export me-3"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt me-3"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog me-3"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync me-3"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt me-3"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-4 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-4">
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100 text-white" style="background: var(--primary-gradient);">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="small fw-bold text-uppercase opacity-75">Total Nelayan</span>
                                                    <i class="fas fa-users opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold mb-0" id="totalPenerima">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Est. Pendapatan</span>
                                                    <i class="fas fa-chart-line text-warning opacity-50 fa-2x"></i>
                                                </div>
                                                <h3 class="fw-bold text-dark mb-0" id="totalBantuan">Rp 0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Pemilik Kapal</span>
                                                    <i class="fas fa-ship text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Rata-rata Usia</span>
                                                    <i class="fas fa-user-clock text-secondary opacity-25 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="rataUsia">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-input">
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <div class="alert alert-info small mb-4 border-0 bg-light-info text-primary"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Sistem akan menolak jika NIK sudah terdaftar sebelumnya.</div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap</label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan)</label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="whatsapp" class="form-label">Nomor Handphone Aktif</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">+62</span>
                                                        <input type="tel" class="form-control" id="whatsapp" required placeholder="8123xxxx">
                                                        <button class="btn btn-outline-secondary" type="button" id="btnNoWA" title="Tidak Punya WA">Tidak Ada</button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profesi" class="form-label">Kategori Profesi</label>
                                                    <select class="form-select" id="profesi" required>
                                                        <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                        <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="statusNelayan" class="form-label">Status Pekerjaan</label>
                                                    <select class="form-select" id="statusNelayan">
                                                        <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                        <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="kusuka" class="form-label fw-bold text-success"><i class="fas fa-id-card me-1"></i>Kepemilikan Kartu KUSUKA?</label>
                                                    <select class="form-select border-success" id="kusuka" required>
                                                        <option value="Tidak">Tidak Ada</option>
                                                        <option value="Ada">Ada</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tahunLahir" class="form-label">Tahun Kelahiran</label>
                                                    <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                    <input type="text" class="form-control bg-light" id="usia" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="kecamatan" class="form-label fw-bold text-primary">Kecamatan</label>
                                                    <select class="form-select border-primary" id="kecamatan" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="desa" class="form-label fw-bold text-primary">Desa / Kelurahan</label>
                                                    <select class="form-select border-primary" id="desa" required disabled>
                                                        <option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                     <label for="alamat" class="form-label">Alamat Lengkap</label>
                                                     <textarea class="form-control" id="alamat" rows="1" placeholder="Dusun, RT/RW"></textarea>
                                                </div>
                                            </div>

                                            <div id="ownerFields" style="display:none;" class="bg-light p-4 rounded-3 mb-3 border">
                                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3"><i class="fas fa-ship me-2"></i>Detail Aset Kapal</h6>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Nama Kapal</label>
                                                        <input type="text" class="form-control" id="namaKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Jenis Kapal</label>
                                                        <select class="form-select" id="jenisKapal">
                                                            <option value="Perahu Jukung">Perahu Jukung</option>
                                                            <option value="Perahu Mayang">Perahu Mayang</option>
                                                            <option value="Perahu Slerek">Perahu Slerek</option>
                                                            <option value="Lainnya">Lainnya</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Ukuran (GT)</label>
                                                        <input type="text" class="form-control" id="ukuranKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Mesin (PK)</label>
                                                        <input type="text" class="form-control" id="mesinKapal">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Alat Tangkap</label>
                                                    <select class="form-select" id="alatTangkap">
                                                        <option value="Jaring Lingkar (purse seine)">Jaring Lingkar (purse seine)</option>
                                                        <option value="Jaring Insang (gill net)">Jaring Insang (gill net)</option>
                                                        <option value="Jaring Angkat (lift net)">Jaring Angkat (lift net)</option>
                                                        <option value="Pancing">Pancing</option>
                                                        <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                        <option value="Lainnya">Lainnya</option>
                                                    </select>
                                                </div>
                                                <div class="p-3 bg-white border rounded">
                                                    <label class="form-label d-block fw-bold">Kepemilikan Dokumen (BPKP / PAS)</label>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenYa" value="Ya">
                                                        <label class="form-check-label" for="dokumenYa">Ada</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenTidak" value="Tidak" checked>
                                                        <label class="form-check-label" for="dokumenTidak">Tidak Ada</label>
                                                    </div>
                                                    <div id="nomorPasContainer" class="mt-2" style="display:none;">
                                                        <input type="text" class="form-control form-control-sm" id="nomorPas" placeholder="Masukkan Nomor PAS KAPAL">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Jenis Ikan Tangkapan Utama</label>
                                                    <div class="card p-3 bg-light border">
                                                        <div id="fishCheckboxContainer" style="max-height: 200px; overflow-y: auto;">
                                                            </div>
                                                        <input type="text" class="form-control form-control-sm mt-2" id="jenisIkanLainnya" placeholder="Sebutkan jenis lainnya..." style="display:none;">
                                                    </div>
                                                    <small class="text-muted fst-italic">*Pilih minimal satu</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="usahaSampingan" class="form-label">Usaha Sampingan</label>
                                                    <input type="text" class="form-control" id="usahaSampingan" placeholder="Contoh: Ternak, Warung">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="pendapatan" class="form-label">Est. Pendapatan/Bulan (Rp)</label>
                                                    <input type="number" class="form-control" id="pendapatan" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tanggalValidasi" class="form-label">Tanggal Validasi</label>
                                                    <input type="date" class="form-control" id="tanggalValidasi" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="validator" class="form-label">Petugas Validator</label>
                                                    <input type="text" class="form-control" id="validator" required>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="driveLink" class="form-label">Link Dokumen (Google Drive)</label>
                                                    <input type="url" class="form-control" id="driveLink">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="kodeValidasi" class="form-label">Kode Validasi</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control bg-light" id="kodeValidasi" readonly>
                                                        <button type="button" class="btn btn-secondary" id="generateKodeBtn">Generate</button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                                                <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                            </div>
                                            
                                            <div class="d-flex justify-content-end border-top pt-3">
                                                <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                                <button type="submit" class="btn btn-primary" id="saveDataBtn">Simpan Data Nelayan</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-data">
                                <h3 class="section-title">Semua Data Nelayan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-list-alt me-2 text-primary"></i> 
                                            <span class="fw-bold">Tabel Data Nelayan Terdaftar</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted me-3">Sensor: </small>
                                            <span id="sensorStatusText" class="badge bg-success me-2">Sensor: ON</span>
                                            <input type="text" class="form-control form-control-sm w-auto me-3" placeholder="Cari Nama / NIK" id="searchData">
                                            <button class="btn btn-sm btn-primary" onclick="renderDataTable(true)"><i class="fas fa-redo"></i></button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-striped data-table mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                        <th class="text-center">No</th>
                                                        <th>Nama / NIK</th>
                                                        <th>Kontak (WA)</th>
                                                        <th>Profesi</th>
                                                        <th>Kapal / Status</th>
                                                        <th>Est. Pendapatan</th>
                                                        <th class="text-center sticky-col-right col-action">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dataTableBody">
                                                    </tbody>
                                            </table>
                                        </div>
                                        <div class="p-3 d-flex justify-content-between align-items-center border-top bg-light">
                                            <div class="d-flex align-items-center">
                                                <span class="me-2 small text-muted">Tampilkan</span>
                                                <select class="form-select form-select-sm w-auto" id="itemsPerPageSelect">
                                                    <option value="10">10</option>
                                                    <option value="25">25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                    <option value="99999">Semua</option>
                                                </select>
                                                <span class="ms-2 small text-muted">entri</span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-danger me-2 d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-1"></i>Hapus Terpilih</button>
                                                <nav id="paginationContainer"></nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-filter">
                                <h3 class="section-title">Filter Data & Validasi</h3>
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-cogs me-2 text-primary"></i> Parameter Filter</div>
                                    <div class="card-body">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Profesi</label>
                                                <select class="form-select form-select-sm" id="filterProfesi">
                                                    <option value="">Semua</option>
                                                    <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                    <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Status Kepemilikan</label>
                                                <select class="form-select form-select-sm" id="filterStatus">
                                                    <option value="">Semua</option>
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Jenis Kapal</label>
                                                <select class="form-select form-select-sm" id="filterJenisKapal">
                                                    <option value="">Semua</option>
                                                    <option value="Perahu Jukung">Perahu Jukung</option>
                                                    <option value="Perahu Mayang">Perahu Mayang</option>
                                                    <option value="Perahu Slerek">Perahu Slerek</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Dokumen Kapal</label>
                                                <select class="form-select form-select-sm" id="filterDokumen">
                                                    <option value="">Semua</option>
                                                    <option value="Ya">Punya Dokumen</option>
                                                    <option value="Tidak">Tidak Punya</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Usaha Sampingan</label>
                                                <select class="form-select form-select-sm" id="filterUsaha">
                                                    <option value="">Semua</option>
                                                    <option value="Ada">Ada Usaha Sampingan</option>
                                                    <option value="Tidak">Tidak Ada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold text-success">Kartu KUSUKA</label>
                                                <select class="form-select form-select-sm border-success" id="filterKusuka">
                                                    <option value="">Semua</option>
                                                    <option value="Ada">Ada KUSUKA</option>
                                                    <option value="Tidak">Tidak Ada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold text-primary">Kecamatan</label>
                                                <select class="form-select form-select-sm border-primary" id="filterKecamatan">
                                                    <option value="">Semua</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold text-primary">Desa/Kel.</label>
                                                <select class="form-select form-select-sm border-primary" id="filterDesa" disabled>
                                                    <option value="">Semua</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary btn-sm w-100 me-2" id="applyFilterBtn"><i class="fas fa-search me-1"></i> Terapkan Filter</button>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-danger btn-sm w-100" id="btnCekGanda"><i class="fas fa-copy me-1"></i> Cek Data Ganda (NIK)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-clipboard-list me-2 text-primary"></i> 
                                            <span class="fw-bold">Hasil Data Terfilter</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-info me-2" id="printFilteredPdfBtn"><i class="fas fa-file-pdf me-1"></i> Cetak PDF Laporan</button>
                                            <button class="btn btn-sm btn-outline-success" id="exportFilteredExcelBtn"><i class="fas fa-file-excel me-1"></i> Ekspor Excel</button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-striped data-table mb-0">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 5%;">No</th>
                                                        <th style="width: 15%;">NIK</th>
                                                        <th style="width: 25%;">Nama & Lokasi</th>
                                                        <th style="width: 15%;">Status</th>
                                                        <th style="width: 15%;">Profesi</th>
                                                        <th style="width: 15%;">Kapal</th>
                                                        <th style="width: 10%;" class="text-center sticky-col-right col-action">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="filterTableBody">
                                                    <tr><td colspan="7" class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>Terapkan filter untuk melihat data.</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-print">
                                <h3 class="section-title">Cetak Laporan Resmi</h3>
                                <div class="alert alert-info small"><i class="fas fa-info-circle me-2"></i>Cetak laporan rekapitulasi seluruh data yang sudah tervalidasi. Dokumen akan dilengkapi dengan tanda tangan digital QR code.</div>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                            <div class="mb-3"><i class="fas fa-file-pdf fa-3x text-primary"></i></div>
                                            <h5>Cetak Laporan PDF</h5>
                                            <p class="small text-muted mb-4">Unduh laporan rekapitulasi dalam format PDF A4 Landscape.</p>
                                            <button class="btn btn-primary w-100" id="printPdfBtn">Cetak Laporan Lengkap</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-success shadow-sm">
                                            <div class="mb-3"><i class="fas fa-file-excel fa-3x text-success"></i></div>
                                            <h5>Ekspor Data Excel</h5>
                                            <p class="small text-muted mb-4">Unduh seluruh data dalam format Excel (.xlsx) untuk analisis lebih lanjut.</p>
                                            <button class="btn btn-success w-100" id="exportFullExcelBtn">Unduh Excel Lengkap</button>
                                        </div>
                                    </div>
                                </div>
                                <h3 class="section-title mt-5">Aksi Cepat Lainnya</h3>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-success w-100 py-4 h-100 shadow-sm" id="exportExcelBtn"><i class="fas fa-file-excel fa-2x mb-2 d-block"></i>Download Excel</button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-warning w-100 py-4 h-100 shadow-sm" id="exportReloadJsBtn"><i class="fas fa-file-code fa-2x mb-2 d-block"></i>Download File Sinkronisasi (reload.js)</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-export">
                                <h3 class="section-title">Ekspor Data</h3>
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="card p-4 text-center h-100 shadow-sm border-success">
                                            <div class="mb-3"><i class="fas fa-file-excel fa-3x text-success"></i></div>
                                            <h5>Ekspor ke Excel (.xlsx)</h5>
                                            <p class="small text-muted mb-4">Unduh data ke format Excel.</p>
                                            <button class="btn btn-success w-100" onclick="exportData('xlsx')">Ekspor Sekarang</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card p-4 text-center h-100 shadow-sm border-info">
                                            <div class="mb-3"><i class="fas fa-file-code fa-3x text-info"></i></div>
                                            <h5>Ekspor File Sinkronisasi</h5>
                                            <p class="small text-muted mb-4">Unduh data dalam format file sinkronisasi (.js).</p>
                                            <button class="btn btn-info w-100" onclick="backupData('reload.js')">Unduh reload.js</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card p-4 text-center h-100 shadow-sm border-primary">
                                            <div class="mb-3"><i class="fab fa-whatsapp fa-3x text-primary"></i></div>
                                            <h5>Kirim ke WhatsApp Admin</h5>
                                            <p class="small text-muted mb-4">Kirim data rekapitulasi singkat ke nomor WhatsApp Admin.</p>
                                            <button class="btn btn-primary w-100" id="sendWhatsappBtn">Kirim ke WA</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-backup">
                                <h3 class="section-title">Backup & Restore</h3>
                                <div class="alert alert-warning small"><i class="fas fa-exclamation-triangle me-2"></i> <strong>Sistem Smart Restore:</strong> Data yang direstore akan <strong>DIGABUNGKAN</strong> dengan data yang ada (Merge), tidak menghapus data lama. Duplikasi NIK akan ditandai Merah.</div>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-download-alt fa-3x text-primary"></i></div>
                                            <h5>Download Backup</h5>
                                            <p class="small text-muted mb-4">Simpan seluruh database lokal ke file aman.</p>
                                            <button class="btn btn-primary w-100" id="backupDataBtn">Unduh Database Lengkap</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-warning shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-upload-alt fa-3x text-warning"></i></div>
                                            <h5>Restore Data</h5>
                                            <p class="small text-muted mb-0">Gabungkan data dari file backup.</p>
                                            <input type="file" class="form-control my-3" id="restoreFileInput" accept=".js,.json">
                                            <button class="btn btn-warning w-100 text-white" id="restoreDataBtn" disabled>Proses Restore Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-settings">
                                <h3 class="section-title">Pengaturan Aplikasi</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body p-4">
                                        <h5 class="fw-bold text-primary mb-3"><i class="fas fa-globe me-2"></i> Informasi Aplikasi</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="appNameInput" class="form-label">Nama Aplikasi (Title)</label>
                                                <input type="text" class="form-control" id="appNameInput">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="appSubtitleInput" class="form-label">Sub Judul / Instansi</label>
                                                <input type="text" class="form-control" id="appSubtitleInput">
                                            </div>
                                        </div>
                                        
                                        <h5 class="fw-bold text-primary mt-4 pt-3 border-top mb-3"><i class="fas fa-mask me-2"></i> Pengaturan Privasi & Keamanan</h5>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" role="switch" id="privacyToggle">
                                            <label class="form-check-label fw-bold" for="privacyToggle">Mode Privasi (Sensor NIK & WA)</label>
                                            <div id="privacyStatus" class="mt-2 small fw-bold"></div>
                                        </div>

                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <label for="securityCodeInput" class="form-label">Kode Keamanan (Untuk Hapus Data)</label>
                                                <input type="text" class="form-control" id="securityCodeInput" readonly value="BidangPN1945">
                                                <small class="text-muted">Kode ini tidak dapat diubah di sini.</small>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end border-top pt-3">
                                            <button class="btn btn-primary" id="saveSettingsBtn"><i class="fas fa-save me-1"></i> Simpan Pengaturan</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <footer class="main-footer">
                        <div class="container text-center">
                            <p class="mb-1 small text-muted">SISTEM PEMETAAN NELAYAN - ONE DATA</p>
                            <p class="mb-1 fw-bold text-primary">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                            <div class="small">
                                <a href="#" class="me-3"> <i class="fas fa-map-marker-alt me-1 text-primary"></i> Jl. Raya Panarukan No. 12 </a>
                                <span class="me-3 text-muted">|</span>
                                <a href="mailto:info@dinasperikanansitubondo.com"> <i class="fas fa-envelope me-1 text-primary"></i> info@dinasperikanansitubondo.com </a>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title fw-bold"><i class="fas fa-id-card me-2"></i>DETAIL LENGKAP NELAYAN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 border-end">
                                    <h6 class="text-primary fw-bold mb-3">IDENTITAS PRIBADI</h6>
                                    <div class="detail-label">Nama Lengkap</div>
                                    <div class="detail-value" id="d_nama">-</div>
                                    <div class="detail-label">NIK (Nomor Induk Kependudukan)</div>
                                    <div class="detail-value font-monospace" id="d_nik">-</div>
                                    <div class="detail-label">Usia / Tahun Lahir</div>
                                    <div class="detail-value" id="d_usia">-</div>
                                    <div class="detail-label">Kontak (WhatsApp/Telp)</div>
                                    <div class="detail-value font-monospace" id="d_wa">-</div>
                                    <div class="detail-label">Alamat</div>
                                    <div class="detail-value" id="d_alamat">-</div>
                                </div>
                                <div class="col-md-6 ps-md-4">
                                    <h6 class="text-primary fw-bold mb-3">PROFESI & KEPEMILIKAN</h6>
                                    <div class="detail-label">Profesi</div>
                                    <div class="detail-value"><span id="d_profesi" class="badge bg-primary"></span></div>
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value"><span id="d_status" class="badge bg-secondary"></span></div>
                                    <div class="detail-label">Kartu KUSUKA</div>
                                    <div class="detail-value"><span id="d_kusuka" class="badge bg-success"></span></div>
                                    <div class="detail-label">Kode Validasi</div>
                                    <div class="detail-value font-monospace" id="d_kode">-</div>
                                    <div class="detail-label">Tanggal Validasi</div>
                                    <div class="detail-value" id="d_tgl_validasi">-</div>
                                    <div class="detail-label">Petugas Validator</div>
                                    <div class="detail-value" id="d_validator">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-0 shadow-sm mb-3" id="detailKapalCard">
                        <div class="card-body">
                            <h6 class="text-info fw-bold mb-3"><i class="fas fa-ship me-2"></i>DETAIL ASET KAPAL</h6>
                            <div class="row">
                                <div class="col-md-6 border-end">
                                    <div class="detail-label">Nama / Jenis Kapal</div>
                                    <div class="detail-value" id="d_namaKapal">-</div>
                                    <div class="detail-label">Ukuran (GT) / Mesin (PK)</div>
                                    <div class="detail-value" id="d_ukuranMesin">-</div>
                                    <div class="detail-label">Alat Tangkap</div>
                                    <div class="detail-value" id="d_alatTangkap">-</div>
                                </div>
                                <div class="col-md-6 ps-md-4">
                                    <div class="detail-label">Dokumen PAS Kapal</div>
                                    <div class="detail-value" id="d_punyaDokumen">-</div>
                                    <div class="detail-label">Nomor PAS</div>
                                    <div class="detail-value font-monospace" id="d_nomorPas">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-secondary fw-bold mb-3"><i class="fas fa-cogs me-2"></i>INFORMASI LAINNYA</h6>
                            <div class="row">
                                <div class="col-md-6 border-end">
                                    <div class="detail-label">Jenis Ikan Tangkapan Utama</div>
                                    <div class="detail-value" id="d_jenisIkan">-</div>
                                    <div class="detail-label">Usaha Sampingan</div>
                                    <div class="detail-value" id="d_usahaSampingan">-</div>
                                    <div class="detail-label">Est. Pendapatan/Bulan</div>
                                    <div class="detail-value" id="d_pendapatan">-</div>
                                </div>
                                <div class="col-md-6 ps-md-4">
                                    <div class="detail-label">Link Dokumen (Drive)</div>
                                    <div class="detail-value" id="d_driveLink">-</div>
                                    <div class="detail-label">Keterangan Tambahan</div>
                                    <div class="detail-value" id="d_keterangan">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end pt-3 gap-2">
                         <button class="btn btn-sm btn-warning" id="modalEditBtn"><i class="fas fa-pencil-alt me-1"></i> Edit Data</button>
                         <button class="btn btn-sm btn-danger" id="modalDeleteBtn"><i class="fas fa-trash me-1"></i> Hapus Data</button>
                         <button class="btn btn-sm btn-primary" id="modalPrintPdfBtn"><i class="fas fa-file-pdf me-1"></i> Cetak Detail PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast notification-toast border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-bell me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                <small>Baru saja</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Pesan notifikasi.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SECURITY_CODE = "BidangPN1945";
        let appData = []; // Main array to hold all fisherman data
        let appSettings = {
            appName: "SISTEM PEMETAAN NELAYAN",
            appSubtitle: "DINAS PERIKANAN KABUPATEN SITUBONDO",
            itemsPerPage: 10,
            currentPage: 1,
            privacyMode: true, // Default to true for safety
        };
        const DATA_PER_PAGE = 10;
        let currentPage = 1;

        const wilayah = {
            "Arjasa": ["Arjasa", "Bayeman", "Curah Kalak", "Jatisari", "Kayumas", "Kedungdowo", "Lamongan", "Mangaran", "Patemon", "Seketar"],
            "Asembagus": ["Asembagus", "Asembagus Kota", "Bantal", "Kalisari", "Kedunglo", "Kertosari", "Mojosari", "Sumberanyar"],
            "Banyuglugur": ["Banyuglugur", "Kalianget", "Kepuh", "Bloro", "Tepos"],
            "Banyuputih": ["Sumberanyar", "Sumberejo", "Wonorejo"],
            "Besuki": ["Besuki", "Boro", "Demung", "Jetis", "Langkap", "Sambirampak Kidul", "Tambak", "Tangkilan"],
            "Bungatan": ["Bungatan", "Bungcalok", "Cemara", "Kembangsari", "Kenep", "Kompas", "Patemon", "Sokaan", "Tambak Ukir"],
            "Jangkar": ["Jangkar", "Curah Tatal", "Gelung", "Karang Anyar", "Paowan", "Peleyan", "Semboropon", "Talang", "Tanjung Kamal"],
            "Jatibanteng": ["Curahsuri", "Jatibanteng", "Kalibagor", "Kembangsari", "Pakel", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"],
            "Kapongan": ["Batu Kapur", "Curah Cottok", "Gelung", "Kapongan", "Kesambirampak", "Landangan", "Palangan", "Pokaan", "Seletreng", "Sumberanyar", "Tanjung Pecinan"],
            "Kendit": ["Balung", "Keding", "Kendit", "Kilensari", "Kukusan", "Paowan", "Patokan", "Semboropon", "Tambak Ukir"],
            "Mangaran": ["Mangaran", "Semiring", "Tanjung Kamal", "Tegal Barat"],
            "Mlandingan": ["Besuki", "Buniwangi", "Campoan", "Dusun Wali", "Glingseran", "Sumber Pinang", "Sumberejo"],
            "Panarukan": ["Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"],
            "Panji": ["Ardirejo", "Kemiri", "Panji Kidul", "Panji Lor", "Tokelan"],
            "Panyabungan": ["Alassumurbatu", "Bantal", "Kalisari", "Kedunglo", "Kertosari", "Mojosari", "Sumberanyar"],
            "Prajekan": ["Asembagus", "Bantal", "Kalisari", "Kedunglo", "Kertosari", "Mojosari", "Sumberanyar"],
            "Suboh": ["Buduan", "Cemara", "Kemuning", "Palangan", "Prajekan", "Seketar"],
            "Situbondo": ["Dawuhan", "Patokan", "Situbondo Kota", "Talkandang"],
            "Sumbermalang": ["Alassumurbatu", "Bantal", "Kalisari", "Kedunglo", "Kertosari", "Mojosari", "Sumberanyar"],
            "Wringin": ["Bantal", "Kalisari", "Kedunglo", "Kertosari", "Mojosari", "Sumberanyar"],
        };

        const fishList = [
            "Tuna", "Tongkol", "Cakalang", "Bandeng", "Kembung", "Teri", "Layang", "Udang", "Cumi-cumi", "Rajungan", "Kerapu", "Kakap", "Lainnya"
        ];

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('nelayanData', JSON.stringify(appData));
        }

        function saveSettings() {
            localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
        }

        function loadData() {
            const d = localStorage.getItem('nelayanData');
            if(d) appData = JSON.parse(d);
        }

        function loadSettings() {
            const s = localStorage.getItem('nelayanSettings');
            if(s) Object.assign(appSettings, JSON.parse(s));
        }

        function showNotification(msg, type = 'info') {
            const toastEl = document.querySelector('.notification-toast');
            const header = toastEl.querySelector('.toast-header');
            const styles = { success: { cls: 'bg-success text-white', title: 'Sukses' }, error: { cls: 'bg-danger text-white', title: 'Error' }, info: { cls: 'bg-primary text-white', title: 'Info' }, warning: { cls: 'bg-warning text-dark', title: 'Peringatan' } };
            const style = styles[type] || styles.info;
            header.className = `toast-header ${style.cls}`;
            document.getElementById('toastTitle').textContent = style.title;
            document.getElementById('toastMessage').textContent = msg;
            new bootstrap.Toast(toastEl).show();
        }

        function maskData(data, force = false) {
            if (!data) return "-";
            if (data === '00000000') return "Tidak Ada";
            if (!appSettings.privacyMode && !force) return data;
            let str = data.toString();
            if (str.length <= 4) return str;
            return str.slice(0, -4) + "****";
        }

        function checkGlobalDuplicates() {
            const counts = {};
            appData.forEach(d => counts[d.nik] = (counts[d.nik] || 0) + 1);
            const duplicates = appData.filter(d => counts[d.nik] > 1);
            const warningEl = document.getElementById('duplicateWarning');
            warningEl.style.display = duplicates.length > 0 ? 'block' : 'none';
        }

        // --- UTILITY UI & DATA ---

        function setupSelectOptions() {
            const kecSelect = document.getElementById('kecamatan');
            const filterKecSelect = document.getElementById('filterKecamatan');

            Object.keys(wilayah).forEach(kec => {
                const opt1 = document.createElement('option');
                opt1.value = opt1.textContent = kec;
                kecSelect.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = opt2.textContent = kec;
                filterKecSelect.appendChild(opt2);
            });

            const updateDesaSelect = (kecamatanValue, selectId, isDisabled) => {
                const desaSelect = document.getElementById(selectId);
                desaSelect.innerHTML = selectId.startsWith('filter') ? '<option value="">Semua</option>' : '<option value="">-- Pilih Desa --</option>';
                desaSelect.disabled = isDisabled;

                if (kecamatanValue && wilayah[kecamatanValue]) {
                    wilayah[kecamatanValue].forEach(desa => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = desa;
                        desaSelect.appendChild(opt);
                    });
                }
            };

            document.getElementById('kecamatan').addEventListener('change', function() {
                updateDesaSelect(this.value, 'desa', !this.value);
            });

            document.getElementById('filterKecamatan').addEventListener('change', function() {
                updateDesaSelect(this.value, 'filterDesa', !this.value);
            });

            const fishContainer = document.getElementById('fishCheckboxContainer');
            fishList.forEach((fish, index) => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input fish-checkbox" type="checkbox" value="${fish}" id="fish_${fish.replace(/[^a-zA-Z0-9]/g, '')}">
                    <label class="form-check-label" for="fish_${fish.replace(/[^a-zA-Z0-9]/g, '')}">${fish}</label>
                `;
                fishContainer.appendChild(div);
            });

            document.getElementById('fish_Lainnya').addEventListener('change', function() {
                document.getElementById('jenisIkanLainnya').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // --- DASHBOARD FUNCTIONS ---

        let profesiChart, kapalChart;

        function initializeCharts() {
            const pCtx = document.getElementById('profesiChart').getContext('2d');
            window.profesiChart = new Chart(pCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const kCtx = document.getElementById('kapalChart').getContext('2d');
            window.kapalChart = new Chart(kCtx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }

        function updateDashboard() {
            const totalPenerima = appData.length;
            const totalPendapatan = appData.reduce((sum, d) => sum + (parseInt(d.pendapatan) || 0), 0);
            const totalPemilik = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const totalUsia = appData.reduce((sum, d) => sum + (parseInt(d.usia) || 0), 0);
            const rataUsia = totalPenerima > 0 ? Math.round(totalUsia / totalPenerima) : 0;

            document.getElementById('totalPenerima').textContent = totalPenerima.toLocaleString('id-ID');
            document.getElementById('totalBantuan').textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
            document.getElementById('totalPemilik').textContent = totalPemilik.toLocaleString('id-ID');
            document.getElementById('rataUsia').textContent = rataUsia.toLocaleString('id-ID');

            // Update Profesi Chart
            const pData = appData.reduce((acc, d) => {
                acc[d.profesi] = (acc[d.profesi] || 0) + 1;
                return acc;
            }, {});

            window.profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{
                    data: Object.values(pData),
                    backgroundColor: ['#0c2461', '#e58e26'], // Dark Blue and Orange
                }]
            };
            window.profesiChart.update();

            // Update Kapal Chart
            const kData = appData.filter(d => d.status === 'Pemilik Kapal').reduce((acc, d) => {
                acc[d.jenisKapal] = (acc[d.jenisKapal] || 0) + 1;
                return acc;
            }, {});

            window.kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{
                    label: 'Unit',
                    data: Object.values(kData),
                    backgroundColor: '#4a69bd'
                }]
            };
            window.kapalChart.update();
        }
        
        // --- CRUD & TABLE FUNCTIONS ---

        function getFilteredData(filter = {}) {
            let data = appData;

            // Search filter
            const searchTerm = document.getElementById('searchData')?.value.toLowerCase();
            if (searchTerm) {
                data = data.filter(d => 
                    d.nama.toLowerCase().includes(searchTerm) || 
                    d.nik.includes(searchTerm)
                );
            }
            
            // Filter tab filters (if applied)
            if (filter.profesi) data = data.filter(d => d.profesi === filter.profesi);
            if (filter.status) data = data.filter(d => d.status === filter.status);
            if (filter.jenisKapal) data = data.filter(d => d.jenisKapal === filter.jenisKapal);
            if (filter.dokumen) data = data.filter(d => d.punyaDokumen === filter.dokumen);
            if (filter.usaha) data = data.filter(d => (filter.usaha === 'Ada' ? d.usahaSampingan.length > 0 : d.usahaSampingan.length === 0));
            if (filter.kusuka) data = data.filter(d => d.kusuka === filter.kusuka);
            if (filter.kecamatan) data = data.filter(d => d.kecamatan === filter.kecamatan);
            if (filter.desa) data = data.filter(d => d.desa === filter.desa);
            
            // Sort by NIK for duplicate checks/consistency
            data.sort((a,b) => a.nama.localeCompare(b.nama));
            
            return data;
        }

        function renderDataTable(isSearch = false) {
            const dataTableBody = document.getElementById('dataTableBody');
            const dataToRender = getFilteredData({}); 
            const totalItems = dataToRender.length;
            const itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect')?.value) || 10;
            
            if(isSearch) currentPage = 1; // Reset page on search

            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = dataToRender.slice(start, end);

            const counts = {};
            appData.forEach(d => counts[d.nik] = (counts[d.nik] || 0) + 1);

            dataTableBody.innerHTML = '';
            if(paginatedData.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted"><i class="fas fa-exclamation-circle me-2"></i>Tidak ada data nelayan ditemukan.</td></tr>`;
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }

            paginatedData.forEach((d, i) => {
                const isDuplicate = counts[d.nik] > 1;
                const rowClass = isDuplicate ? 'table-danger' : '';
                const displayNik = maskData(d.nik);
                const badgeClass = d.profesi === 'Nelayan Tetap' ? 'badge-profesi-tetap' : 'badge-profesi-musiman';
                const kusukaBadge = (d.kusuka === "Ada") ? '<span class="badge badge-kusuka-ada ms-2">KUSUKA</span>' : '';
                
                const kapalInfo = d.status === 'Pemilik Kapal' ? 
                    `<small class="text-info fw-bold">${d.namaKapal || '-'}</small><br><small>(${d.jenisKapal})` : 
                    d.status;
                
                let contactDisplay;
                const displayWaRaw = maskData(d.whatsapp, true);
                if (displayWaRaw === '00000000') {
                    contactDisplay = `<span class="badge bg-light text-muted border">Tidak Ada</span>`;
                } else {
                    if (appSettings.privacyMode) {
                        contactDisplay = `<div class="small"><i class="fas fa-phone-alt text-secondary me-1"></i> ${displayWaRaw}</div>`;
                    } else {
                        let cleanNum = d.whatsapp;
                        if(cleanNum.startsWith('0')) cleanNum = '62' + cleanNum.substring(1);
                        contactDisplay = `
                            <div class="d-flex align-items-center gap-1">
                                <a href="https://wa.me/${cleanNum}" target="_blank" class="btn btn-sm btn-success py-0 px-1" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a>
                                <span class="small font-monospace ms-1">${d.whatsapp}</span>
                            </div>
                        `;
                    }
                }

                const row = `<tr class="${rowClass}">
                    <td class="text-center"><input type="checkbox" class="row-checkbox" value="${d.id}" onchange="toggleBulkDeleteBtn()"></td>
                    <td class="text-center">${start + i + 1}</td>
                    <td onclick="viewDetail('${d.id}')" class="clickable-name">
                        <div class="fw-bold text-dark">${d.nama} ${kusukaBadge}</div>
                        <div class="small font-monospace text-muted">${displayNik}</div>
                        ${isDuplicate ? '<span class="badge bg-danger">Duplikat NIK</span>' : ''}
                        <div class="small text-muted"><i class="fas fa-map-marker-alt me-1"></i>${d.kecamatan}, ${d.desa}</div>
                    </td>
                    <td>${contactDisplay}</td>
                    <td><span class="badge ${badgeClass} border">${d.profesi}</span><br><small>${d.status}</small></td>
                    <td>${kapalInfo}</td>
                    <td>Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}</td>
                    <td class="text-center sticky-col-right col-action">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Detail"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
                dataTableBody.innerHTML += row;
            });
            
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            if(totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `<ul class="pagination pagination-sm m-0">`;
            for (let i = 1; i <= totalPages; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
            }
            html += `</ul>`;
            container.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderDataTable();
            window.scrollTo(0,0);
        }

        function toggleBulkDeleteBtn() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            document.getElementById('bulkDeleteBtn').classList.toggle('d-none', checkedCount === 0);
        }

        function bulkDeleteData() {
            const userCode = prompt("Masukkan KODE KEAMANAN untuk menghapus data secara massal:");
            if(userCode === SECURITY_CODE) {
                if(confirm('Yakin menghapus data terpilih secara permanen?')) {
                    const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
                    appData = appData.filter(d => !selectedIds.includes(d.id.toString()));
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    showNotification(`${selectedIds.length} data berhasil dihapus`, 'success');
                    checkGlobalDuplicates();
                }
            } else if (userCode !== null) alert("Kode keamanan SALAH!");
        }

        function viewDetail(id) {
            const d = appData.find(item => item.id == id);
            if (!d) return showNotification('Data tidak ditemukan', 'error');

            const modalEl = document.getElementById('detailModal');
            const detailModal = new bootstrap.Modal(modalEl);

            // Identitas Pribadi
            document.getElementById('d_nama').textContent = d.nama;
            document.getElementById('d_nik').textContent = maskData(d.nik, true); // Force unmasked for detail view if no privacy mode
            document.getElementById('d_usia').textContent = `${d.usia} tahun (${d.tahunLahir})`;
            document.getElementById('d_wa').textContent = maskData(d.whatsapp, true);
            document.getElementById('d_alamat').textContent = `${d.alamat}, ${d.desa}, ${d.kecamatan}`;

            // Profesi & Kepemilikan
            document.getElementById('d_profesi').textContent = d.profesi;
            document.getElementById('d_profesi').className = `badge ${d.profesi === 'Nelayan Tetap' ? 'bg-primary' : 'bg-warning text-dark'}`;
            document.getElementById('d_status').textContent = d.status;
            document.getElementById('d_kusuka').textContent = d.kusuka;
            document.getElementById('d_kusuka').className = `badge ${d.kusuka === 'Ada' ? 'bg-success' : 'bg-secondary'}`;
            document.getElementById('d_kode').textContent = d.kodeValidasi || '-';
            document.getElementById('d_tgl_validasi').textContent = d.tanggalValidasi || '-';
            document.getElementById('d_validator').textContent = d.validator || '-';

            // Detail Kapal
            const isOwner = d.status === 'Pemilik Kapal';
            document.getElementById('detailKapalCard').style.display = isOwner ? 'block' : 'none';
            if (isOwner) {
                document.getElementById('d_namaKapal').textContent = `${d.namaKapal || '-'} / ${d.jenisKapal || '-'}`;
                document.getElementById('d_ukuranMesin').textContent = `${(d.ukuranKapal || '-') + ' GT'} / ${(d.mesinKapal || '-') + ' PK'}`;
                document.getElementById('d_alatTangkap').textContent = d.alatTangkap || '-';
                document.getElementById('d_punyaDokumen').textContent = d.punyaDokumen || '-';
                document.getElementById('d_nomorPas').textContent = d.punyaDokumen === 'Ya' ? (d.nomorPas || '-') : '-';
            }

            // Informasi Lainnya
            document.getElementById('d_jenisIkan').textContent = d.jenisIkan || '-';
            document.getElementById('d_usahaSampingan').textContent = d.usahaSampingan || '-';
            document.getElementById('d_pendapatan').textContent = `Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}`;
            document.getElementById('d_driveLink').textContent = d.driveLink || '-';
            document.getElementById('d_keterangan').textContent = d.keterangan || '-';

            // Action Buttons
            document.getElementById('modalEditBtn').onclick = () => { detailModal.hide(); editData(id); };
            document.getElementById('modalDeleteBtn').onclick = () => { detailModal.hide(); deleteData(id); };
            document.getElementById('modalPrintPdfBtn').onclick = () => { detailModal.hide(); printDetailData(id); };

            detailModal.show();
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            document.getElementById('inputForm').setAttribute('data-edit-id', id);
            document.getElementById('saveDataBtn').textContent = 'Update Data Nelayan';

            ['nama', 'nik', 'whatsapp', 'profesi', 'kusuka', 'tahunLahir', 'alamat', 'usahaSampingan', 'pendapatan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan'].forEach(key => {
                document.getElementById(key).value = d[key] || '';
            });

            // Handle Fish Checkboxes
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('jenisIkanLainnya').value = '';

            const selectedFish = d.jenisIkan.split(', ').map(f => f.trim());
            selectedFish.forEach(fish => {
                let found = false;
                document.querySelectorAll('.fish-checkbox').forEach(cb => {
                    if(cb.value === fish) {
                        cb.checked = true;
                        found = true;
                    }
                });
                if(!found) {
                    const cbLain = document.getElementById('fish_Lainnya');
                    cbLain.checked = true;
                    const inputLain = document.getElementById('jenisIkanLainnya');
                    inputLain.style.display = 'block';
                    inputLain.value = fish;
                }
            });

            // Handle location & status
            const kecSelect = document.getElementById('kecamatan');
            kecSelect.value = d.kecamatan;
            kecSelect.dispatchEvent(new Event('change'));
            document.getElementById('desa').value = d.desa;

            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = d.status;
            statusSelect.dispatchEvent(new Event('change'));

            if(d.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal', 'ukuranKapal', 'mesinKapal', 'alatTangkap', 'nomorPas'].forEach(key => {
                    document.getElementById(key).value = d[key] || '';
                });
                const docRadio = d.punyaDokumen === 'Ya' ? document.getElementById('dokumenYa') : document.getElementById('dokumenTidak');
                docRadio.checked = true;
                docRadio.dispatchEvent(new Event('change'));
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0,0);
        }

        function deleteData(id) {
            const userCode = prompt("Masukkan KODE KEAMANAN untuk menghapus data:");
            if(userCode === SECURITY_CODE) {
                if(confirm('Yakin menghapus data ini secara permanen?')) {
                    appData = appData.filter(d => d.id != id);
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    showNotification('Data berhasil dihapus', 'success');
                    checkGlobalDuplicates();
                }
            } else if (userCode !== null) alert("Kode keamanan SALAH!");
        }

        function renderFilterTable() {
            const filters = {
                desa: document.getElementById('filterDesa').value,
                profesi: document.getElementById('filterProfesi').value,
                status: document.getElementById('filterStatus').value,
                jenisKapal: document.getElementById('filterJenisKapal').value,
                dokumen: document.getElementById('filterDokumen').value,
                usaha: document.getElementById('filterUsaha').value,
                kusuka: document.getElementById('filterKusuka').value,
                kecamatan: document.getElementById('filterKecamatan').value
            };

            const filtered = getFilteredData(filters);
            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';

            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted"><i class="fas fa-exclamation-circle me-2"></i>Tidak ada data yang cocok dengan filter.</td></tr>`;
                document.getElementById('printFilteredPdfBtn').disabled = true;
                document.getElementById('exportFilteredExcelBtn').disabled = true;
                return;
            }

            document.getElementById('printFilteredPdfBtn').disabled = false;
            document.getElementById('exportFilteredExcelBtn').disabled = false;
            
            filtered.forEach((d, i) => {
                const displayNik = maskData(d.nik);
                const kapalInfo = d.status === 'Pemilik Kapal' ? `${d.namaKapal || '-'} (${d.jenisKapal})` : '-';
                const kusukaBadge = (d.kusuka === "Ada") ? '<span class="badge badge-kusuka-ada">Ada</span>' : '<span class="badge badge-kusuka-tidak">Tidak</span>';

                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td class="font-monospace">${displayNik}</td>
                    <td><strong>${d.nama}</strong><br><small><i class="fas fa-map-marker-alt me-1"></i>${d.kecamatan}, ${d.desa}</small></td>
                    <td>${d.status}</td>
                    <td><span class="badge ${d.profesi === 'Nelayan Tetap' ? 'badge-profesi-tetap' : 'badge-profesi-musiman'}">${d.profesi}</span></td>
                    <td>${kapalInfo}</td>
                    <td class="text-center sticky-col-right col-action">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Detail"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
            showNotification(`Filter berhasil: ${filtered.length} data ditemukan`, 'success');
        }

        function showDuplicateDataInFilter() {
            const counts = {};
            appData.forEach(d => counts[d.nik] = (counts[d.nik] || 0) + 1);
            const filtered = appData.filter(d => counts[d.nik] > 1);
            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';

            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-success"><i class="fas fa-check-circle me-2"></i>Hebat! Tidak ditemukan data NIK ganda.</td></tr>`;
                document.getElementById('printFilteredPdfBtn').disabled = true;
                document.getElementById('exportFilteredExcelBtn').disabled = true;
                return;
            }
            
            document.getElementById('printFilteredPdfBtn').disabled = true;
            document.getElementById('exportFilteredExcelBtn').disabled = true;
            
            filtered.sort((a,b) => a.nik.localeCompare(b.nik));
            filtered.forEach((d, i) => {
                const displayNik = maskData(d.nik);
                const kusukaBadge = (d.kusuka === "Ada") ? '<span class="badge badge-kusuka-ada">Ada</span>' : '<span class="badge badge-kusuka-tidak">Tidak</span>';
                tbody.innerHTML += `<tr class="table-danger">
                    <td>${i+1}</td>
                    <td class="fw-bold text-danger">${displayNik}</td>
                    <td><strong>${d.nama}</strong><br><small>${d.desa}</small></td>
                    <td>${d.status}</td>
                    <td><span class="badge ${d.profesi === 'Nelayan Tetap' ? 'badge-profesi-tetap' : 'badge-profesi-musiman'}">${d.profesi}</span></td>
                    <td>${d.status === 'Pemilik Kapal' ? d.namaKapal : '-'}</td>
                    <td class="text-center sticky-col-right col-action">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Detail"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
            showNotification(`Peringatan: ${filtered.length} data NIK ganda ditemukan.`, 'warning');
        }

        // --- EXPORT/IMPORT & PDF FUNCTIONS ---
        
        // Function for single data detail PDF (called from modal)
        function printDetailData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            // Generate QR Codes via DOM Hidden Elements
            document.getElementById('qr-left').innerHTML = "";
            document.getElementById('qr-right').innerHTML = "";

            // 1. QR Kiri (Validasi Digital) - ORANGE
            const textLeft = `Nama: ${d.nama}\nNIK: ${d.nik}\nStatus: Terdaftar & Tervalidasi\nVerifikasi: www.dinasperikanansitubondo.com/satudata`;
            new QRCode(document.getElementById("qr-left"), { 
                text: textLeft, 
                width: 100, 
                height: 100, 
                colorDark: "#e67e22", 
                colorLight: "#ffffff" 
            }); 

            // 2. QR Kanan (Pejabat) - BLUE
            const textRight = `SUGENG PURWO PRIYANTO, S.E, M.M\nPembina\nNip. 19761103 200903 1 002\nKepala Bidang Pemberdayaan Nelayan`;
            new QRCode(document.getElementById("qr-right"), { 
                text: textRight, 
                width: 100, 
                height: 100, 
                colorDark: "#0c2461", 
                colorLight: "#ffffff" 
            }); 

            // Wait a moment for QR canvas to render
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const footerY = 250; // Reference Y position for footer content

                // --- PDF Header ---
                doc.setFillColor(12, 36, 97); // Dark Blue Header
                doc.rect(0, 0, 210, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('DATA NELAYAN KABUPATEN SITUBONDO', 105, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Kartu Tanda Bukti Registrasi Nelayan', 105, 25, { align: 'center' });

                // --- Content Table ---
                const tableData = [
                    ["NIK", maskData(d.nik, true)],
                    ["Nama Lengkap", d.nama],
                    ["Tahun Lahir / Usia", `${d.tahunLahir} / ${d.usia} Tahun`],
                    ["Kontak (WA)", maskData(d.whatsapp, true)],
                    ["Alamat", `${d.alamat}, ${d.desa}, ${d.kecamatan}`],
                    ["Profesi", `${d.profesi} (${d.status})`],
                    ["Kepemilikan KUSUKA", d.kusuka],
                    ["Nama Kapal", d.status === 'Pemilik Kapal' ? d.namaKapal : '-'],
                    ["Jenis Kapal", d.status === 'Pemilik Kapal' ? d.jenisKapal : '-'],
                    ["Ukuran (GT)", d.status === 'Pemilik Kapal' ? d.ukuranKapal : '-'],
                    ["Alat Tangkap", d.status === 'Pemilik Kapal' ? d.alatTangkap : '-'],
                    ["Dokumen PAS Kapal", d.status === 'Pemilik Kapal' ? `${d.punyaDokumen} ${d.punyaDokumen === 'Ya' ? '(' + (d.nomorPas || '-') + ')' : ''}` : '-'],
                    ["Jenis Ikan Utama", d.jenisIkan],
                    ["Usaha Sampingan", d.usahaSampingan || '-'],
                    ["Est. Pendapatan/Bln", `Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}`],
                    ["Tanggal Validasi", d.tanggalValidasi],
                    ["Petugas Validator", d.validator],
                    ["Link Dokumen (Drive)", d.driveLink || '-'],
                    ["Keterangan", d.keterangan || '-']
                ];

                doc.autoTable({
                    startY: 50,
                    head: [['Detail Data', 'Nilai']],
                    body: tableData,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [74, 105, 189], textColor: 255, fontStyle: 'bold' },
                    columnStyles: { 0: { fontStyle: 'bold', cellWidth: 50 }, 1: { cellWidth: 140 } }
                });

                // --- PDF Footer (Tanda Tangan & QR) ---

                // Left Side: Validasi Digital (QR Orange) - REFIXED
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.text('Web Validasi QR Code :', 20, footerY - 15); // Text 1: Title
                
                const qrLeftCanvas = document.querySelector('#qr-left canvas'); 
                if(qrLeftCanvas) {
                    const imgLeft = qrLeftCanvas.toDataURL("image/png");
                    doc.addImage(imgLeft, 'PNG', 20, footerY + 5, 30, 30); // **FIXED: QR Code Image placement (Bottom Left)**
                } 

                doc.setFontSize(8);
                doc.setTextColor(0, 0, 255); // Blue link text
                doc.text('www.dinasperikanansitubondo.com/satudata', 20, footerY + 42); // Text 2: Link

                // Right Side: Tanda Tangan Pejabat (QR Blue) - REVISED LAYOUT
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('Diketahui Oleh :', 140, footerY - 15);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', 140, footerY - 5);
                doc.setFont('helvetica', 'normal');
                doc.text('Kepala Bidang Pemberdayaan Nelayan', 140, footerY);
                
                // Text above QR
                const qrRightCanvas = document.querySelector('#qr-right canvas');
                if(qrRightCanvas) {
                    const imgRight = qrRightCanvas.toDataURL("image/png");
                    doc.addImage(imgRight, 'PNG', 140, footerY + 5, 30, 30); // QR below Text
                } 
                doc.text('Nip. 19761103 200903 1 002', 140, footerY + 42); // Meta Info

                // Meta Info Bottom
                doc.setFontSize(7);
                doc.setTextColor(150);
                doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')} | Kode Validasi: ${d.kodeValidasi || '-'}`, 105, 290, {align:'center'});

                // Save
                const dateStr = new Date().toISOString().split('T')[0];
                const safeName = d.nama.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `${safeName}_${d.nik}_${dateStr}.pdf`;
                doc.save(filename);
                showNotification('Detail Data berhasil dicetak!', 'success');
                
                // Cleanup
                document.getElementById('qr-left').innerHTML = "";
                document.getElementById('qr-right').innerHTML = "";

            }, 500);
        }
        
        // Function for bulk report PDF (called from Print tab and Filter tab)
        function printData(isFiltered = false) {
            let dataToPrint;
            if (isFiltered) {
                // Get the data currently shown in the filter tab
                const filterBtn = document.getElementById('applyFilterBtn');
                if(filterBtn.disabled) return showNotification('Terjadi kesalahan saat mengambil data terfilter. Harap ulangi filter.', 'error');
                
                const filters = {
                    desa: document.getElementById('filterDesa').value,
                    profesi: document.getElementById('filterProfesi').value,
                    status: document.getElementById('filterStatus').value,
                    jenisKapal: document.getElementById('filterJenisKapal').value,
                    dokumen: document.getElementById('filterDokumen').value,
                    usaha: document.getElementById('filterUsaha').value,
                    kusuka: document.getElementById('filterKusuka').value,
                    kecamatan: document.getElementById('filterKecamatan').value
                };
                dataToPrint = getFilteredData(filters);
            } else {
                dataToPrint = appData;
            }

            if (dataToPrint.length === 0) return showNotification('Tidak ada data untuk dicetak.', 'error');

            // --- QR CODE GENERATION FOR REPORT PDF (STATIC) - FIXED ---
            document.getElementById('qr-left').innerHTML = "";
            document.getElementById('qr-right').innerHTML = "";

            // 1. QR Kiri (Validasi Digital) - ORANGE - STATIC
            const textLeft = `Laporan Nelayan Kabupaten Situbondo\nStatus: Resmi & Tervalidasi\nVerifikasi: www.dinasperikanansitubondo.com/satudata`;
            new QRCode(document.getElementById("qr-left"), { 
                text: textLeft, 
                width: 100, 
                height: 100, 
                colorDark: "#e67e22", 
                colorLight: "#ffffff" 
            }); 

            // 2. QR Kanan (Pejabat) - BLUE - STATIC
            const textRight = `SUGENG PURWO PRIYANTO, S.E, M.M\nPembina\nNip. 19761103 200903 1 002\nKepala Bidang Pemberdayaan Nelayan`;
            new QRCode(document.getElementById("qr-right"), { 
                text: textRight, 
                width: 100, 
                height: 100, 
                colorDark: "#0c2461", 
                colorLight: "#ffffff" 
            }); 

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4'); // Landscape
                
                // Prepare Table Data
                const head = [['No', 'Nama Nelayan', 'NIK', 'Kecamatan', 'Desa', 'Profesi', 'Status', 'Kapal (GT/PK)', 'KUSUKA']];
                const body = dataToPrint.map((d, i) => [
                    i + 1, 
                    d.nama, 
                    maskData(d.nik, true), 
                    d.kecamatan, 
                    d.desa, 
                    d.profesi, 
                    d.status, 
                    d.status === 'Pemilik Kapal' ? `${d.ukuranKapal}GT/${d.mesinKapal}PK` : '-',
                    d.kusuka
                ]);
                
                // --- HEADER REPORT ---
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("DINAS PERIKANAN KABUPATEN SITUBONDO", doc.internal.pageSize.width / 2, 40, { align: "center" });
                doc.setFontSize(14);
                doc.text("Sistem Satu Data Bidang Pemberdayaan Nelayan", doc.internal.pageSize.width / 2, 60, { align: "center" });
                doc.setTextColor(230, 126, 34); // Orange Color for Slogan
                doc.setFont("times", "italic"); 
                doc.setFontSize(18);
                doc.text("Situbondo Naik Kelas", doc.internal.pageSize.width / 2, 80, { align: "center" });
                doc.setDrawColor(0);
                doc.setLineWidth(1.5);
                doc.line(40, 95, doc.internal.pageSize.width - 40, 95); 

                // --- SUMMARY INFO ---
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                const dateStr = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                doc.text(`Periode Validasi Data: ${dateStr}`, 40, 115);
                doc.text(`Total Data Tercetak: ${dataToPrint.length} Nelayan`, 40, 128);

                // AutoTable
                doc.autoTable({
                    startY: 140,
                    head: head,
                    body: body,
                    theme: 'striped',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [12, 36, 97], textColor: 255, fontStyle: 'bold' },
                    margin: { left: 40, right: 40 },
                    didDrawPage: (data) => {
                        // Footer logic only on the last page
                        if (data.pageNumber === data.pageCount) {
                            const finalY = data.cursor.y + 10;
                            const rightX = doc.internal.pageSize.width - 50;
                            const leftX = 40;
                            
                            // Tanda Tangan Pejabat (Right Side)
                            doc.setFontSize(10);
                            doc.setFont("helvetica", "normal");
                            doc.text("Situbondo, " + dateStr, rightX, finalY + 10, { align: 'right' });
                            doc.text("Diketahui Oleh:", rightX, finalY + 25, { align: 'right' });
                            doc.setFont("helvetica", "bold");
                            doc.text("SUGENG PURWO PRIYANTO, S.E, M.M", rightX, finalY + 70, { align: 'right' });
                            doc.setFont("helvetica", "normal");
                            doc.text("NIP. 19761103 200903 1 002", rightX, finalY + 92, { align: 'right' });
                            
                            // ADD QR RIGHT (Pejabat) - FIXED
                            const qrRightCanvas = document.querySelector('#qr-right canvas');
                            if(qrRightCanvas) {
                                const imgRight = qrRightCanvas.toDataURL("image/png");
                                // Place QR code between the texts 
                                doc.addImage(imgRight, 'PNG', rightX - 30, finalY + 30, 30, 30); 
                            }
                            
                            // Tanda Tangan Validasi (Left Side) - ADDED
                            doc.setFontSize(8);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.text("Laporan Tervalidasi Digital:", leftX, finalY + 10);
                            
                            const qrLeftCanvas = document.querySelector('#qr-left canvas');
                            if(qrLeftCanvas) {
                                const imgLeft = qrLeftCanvas.toDataURL("image/png");
                                // **FIXED: Place QR code on the bottom left**
                                doc.addImage(imgLeft, 'PNG', leftX, finalY + 20, 30, 30); 
                            }
                            
                            doc.setFontSize(8);
                            doc.setTextColor(0, 0, 255);
                            doc.text('www.dinasperikanansitubondo.com/satudata', leftX, finalY + 60); 
                        }
                    }
                });

                doc.save(`Laporan_Rekapitulasi_Nelayan_${Date.now()}.pdf`);
                showNotification('Laporan rekapitulasi berhasil dicetak!', 'success');
                
                // Cleanup
                document.getElementById('qr-left').innerHTML = "";
                document.getElementById('qr-right').innerHTML = "";
            }, 500);
        }

        function backupData(customFilename = 'download.js') {
            const dateStr = new Date().toLocaleString('id-ID');
            const dataToBackup = appData.map(d => ({ ...d, nik: maskData(d.nik), whatsapp: maskData(d.whatsapp) }));
            const headerInfo = `// BACKUP DATA SISTEM NELAYAN\n// INSTANSI: ${appSettings.appSubtitle}\n// TANGGAL: ${dateStr}\n// SENSOR STATUS: ${appSettings.privacyMode ? 'AKTIF' : 'NON-AKTIF'}\n\n`;
            
            let fileContent;
            if(customFilename.endsWith('.js')) {
                 // Encode data to base64 for JS file
                const encodedData = btoa(JSON.stringify(appData));
                fileContent = `${headerInfo}window.NELAYAN_BACKUP = "${encodedData}";\n// END OF BACKUP DATA`;
            } else {
                // For JSON
                fileContent = JSON.stringify(appData, null, 2);
                customFilename = `backup_nelayan_${Date.now()}.json`;
            }

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = customFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Backup data ke ${customFilename} berhasil.`, 'success');
        }

        function restoreData() {
            const fileInput = document.getElementById('restoreFileInput');
            const file = fileInput.files[0];
            if (!file) return showNotification('Pilih file backup (.js atau .json) untuk restore.', 'error');

            const reader = new FileReader();
            reader.onload = function(e) {
                const str = e.target.result;
                let restored = null;
                try { 
                    restored = JSON.parse(str); 
                } catch {
                    const match = str.match(/window\.NELAYAN_BACKUP = "([^"]+)";/);
                    if(match) restored = JSON.parse(atob(match[1]));
                }
                if(restored && restored.length) {
                    if(confirm(`Ditemukan ${restored.length} data. Gabungkan ke database saat ini?`)) {
                        mergeAndRestore(restored);
                        showNotification('Restore Berhasil! Data telah digabungkan.', 'success');
                    }
                } else { showNotification('Format file tidak valid', 'error'); }
            };
            reader.readAsText(file);
        }

        function mergeAndRestore(restoredData) {
            const existingNiks = new Set(appData.map(d => d.nik));
            let addedCount = 0;
            
            restoredData.forEach(newD => {
                // Only merge data if NIK is unique or replace based on NIK
                const existingIndex = appData.findIndex(d => d.nik === newD.nik);
                
                // If exists, update (smart merge logic, you can adjust this to ignore old data if needed)
                if (existingIndex !== -1) {
                    // console.log(`Data NIK ${newD.nik} sudah ada, dilewati/ditandai duplikat.`);
                    // For now, we will just keep the old one and let the duplicate checker flag it.
                    // To truly merge, you'd replace: appData[existingIndex] = newD;
                } else {
                    // Ensure new data has an ID (if old backup format didn't use IDs)
                    if (!newD.id) newD.id = Date.now() + addedCount; 
                    appData.push(newD);
                    addedCount++;
                }
            });

            saveData();
            updateDashboard();
            renderDataTable();
            checkGlobalDuplicates();
            showNotification(`Berhasil menambahkan ${addedCount} data baru.`, 'success');
        }

        function exportData(type) {
            if(appData.length === 0) return showNotification('Tidak ada data', 'error');

            const dataToExport = appData.map(d => ({ 
                ...d, 
                nik: maskData(d.nik, false), // keep masked or not based on settings
                whatsapp: maskData(d.whatsapp, false) // keep masked or not based on settings
            }));
            
            // Create a clean set of headers for the output file
            const finalData = dataToExport.map(d => ({
                "ID Data": d.id,
                "Nama Lengkap": d.nama,
                "NIK": `'${d.nik}`, // Prefix with ' to ensure NIK is treated as text
                "WhatsApp": `'${d.whatsapp}`, // Prefix with ' to ensure WA is treated as text
                "Profesi": d.profesi,
                "Status Pekerjaan": d.status,
                "Kartu KUSUKA": d.kusuka,
                "Tahun Lahir": d.tahunLahir,
                "Usia": d.usia,
                "Kecamatan": d.kecamatan,
                "Desa": d.desa,
                "Alamat Lengkap": d.alamat,
                "Nama Kapal": d.namaKapal,
                "Jenis Kapal": d.jenisKapal,
                "Ukuran Kapal (GT)": d.ukuranKapal,
                "Mesin Kapal (PK)": d.mesinKapal,
                "Alat Tangkap": d.alatTangkap,
                "Punya Dokumen": d.punyaDokumen,
                "Nomor PAS": d.nomorPas,
                "Jenis Ikan Utama": d.jenisIkan,
                "Usaha Sampingan": d.usahaSampingan,
                "Est. Pendapatan (Rp)": parseInt(d.pendapatan),
                "Tanggal Validasi": d.tanggalValidasi,
                "Validator": d.validator,
                "Link Dokumen": d.driveLink,
                "Kode Validasi": d.kodeValidasi,
                "Keterangan": d.keterangan
            }));

            if(type === 'xlsx') {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalData), "Data Nelayan");
                XLSX.writeFile(wb, `Data_Nelayan_${appSettings.appSubtitle.slice(0,10)}_${Date.now()}.xlsx`);
            }
            if(type === 'xlsx') showNotification('Ekspor Excel berhasil.', 'success');
        }
        
        function sendDataToWhatsapp() {
            const total = appData.length;
            const tetap = appData.filter(d => d.profesi === 'Nelayan Tetap').length;
            const musiman = appData.filter(d => d.profesi === 'Nelayan Musiman').length;
            const pemilik = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const kusukaAda = appData.filter(d => d.kusuka === 'Ada').length;

            let message = `*LAPORAN REKAPITULASI DATA NELAYAN*\n\n`;
            message += `*DINAS PERIKANAN KABUPATEN SITUBONDO*\n`;
            message += `--------------------------------------\n`;
            message += `Total Data Nelayan: *${total.toLocaleString('id-ID')} orang*\n`;
            message += `\n*Detail Profesi:*\n`;
            message += `  - Nelayan Tetap: ${tetap.toLocaleString('id-ID')}\n`;
            message += `  - Nelayan Musiman: ${musiman.toLocaleString('id-ID')}\n`;
            message += `\n*Detail Kepemilikan:*\n`;
            message += `  - Pemilik Kapal: ${pemilik.toLocaleString('id-ID')}\n`;
            message += `  - Punya KUSUKA: ${kusukaAda.toLocaleString('id-ID')}\n\n`;
            message += `_Dicetak otomatis oleh Sistem Satu Data (v5.0)_`;

            const adminWa = '6281234567890'; // Placeholder admin WA number
            const url = `https://wa.me/${adminWa.replace(/^0/, '62').replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- EVENT LISTENERS ---

        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginButton');
                btn.disabled = true;
                btn.innerHTML = 'VERIFIKASI... <span class="spinner-border spinner-border-sm ms-2" id="loginSpinner"></span>';

                setTimeout(() => {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    updateDashboard();
                    renderDataTable();
                    checkGlobalDuplicates();
                    showNotification('Selamat datang di Dashboard!', 'success');
                    btn.disabled = false;
                    btn.innerHTML = 'BUKA DASHBOARD <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>';
                }, 1000);
            });

            // WA Toggle
            document.getElementById('btnNoWA').addEventListener('click', function() {
                const input = document.getElementById('whatsapp');
                if (input.hasAttribute('readonly')) {
                    input.removeAttribute('readonly');
                    input.value = '';
                    this.classList.remove('active', 'btn-secondary');
                    this.classList.add('btn-outline-secondary');
                    this.textContent = "Tidak Ada";
                } else {
                    input.value = '00000000';
                    input.setAttribute('readonly', true);
                    this.classList.add('active', 'btn-secondary');
                    this.classList.remove('btn-outline-secondary');
                    this.textContent = "Hapus";
                }
            });

            // Input Form Submission
            document.getElementById('inputForm').addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!this.checkValidity()) {
                    showNotification('Harap lengkapi semua data wajib!', 'error');
                    this.classList.add('was-validated');
                    return;
                }

                const nik = document.getElementById('nik').value;
                const whatsapp = document.getElementById('whatsapp').value;
                const selectedFish = Array.from(document.querySelectorAll('.fish-checkbox:checked')).map(cb => cb.value);
                
                // Add "Lainnya" value if checked
                const otherFishInput = document.getElementById('jenisIkanLainnya');
                if (document.getElementById('fish_Lainnya').checked && otherFishInput.value.trim()) {
                    selectedFish.push(otherFishInput.value.trim());
                }

                if(selectedFish.length === 0) return showNotification('Pilih minimal satu jenis ikan!', 'error');

                const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
                const duplicateCheck = appData.find(d => d.nik === nik);

                if (duplicateCheck && (!editId || duplicateCheck.id != editId)) {
                    return showNotification('GAGAL: NIK sudah terdaftar dalam sistem!', 'error');
                }

                const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
                const formData = {
                    id: editId || Date.now(),
                    nama: document.getElementById('nama').value,
                    nik: nik,
                    whatsapp: whatsapp,
                    profesi: document.getElementById('profesi').value,
                    status: document.getElementById('statusNelayan').value,
                    kusuka: document.getElementById('kusuka').value,
                    tahunLahir: document.getElementById('tahunLahir').value,
                    usia: document.getElementById('usia').value,
                    kecamatan: document.getElementById('kecamatan').value,
                    desa: document.getElementById('desa').value,
                    alamat: document.getElementById('alamat').value,
                    namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                    jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                    ukuranKapal: isOwner ? document.getElementById('ukuranKapal').value : '-',
                    mesinKapal: isOwner ? document.getElementById('mesinKapal').value : '-',
                    alatTangkap: isOwner ? document.getElementById('alatTangkap').value : '-',
                    punyaDokumen: isOwner ? document.querySelector('input[name="dokumenOption"]:checked').value : '-',
                    nomorPas: isOwner && document.getElementById('dokumenYa').checked ? document.getElementById('nomorPas').value : '-',
                    jenisIkan: selectedFish.join(", "),
                    usahaSampingan: document.getElementById('usahaSampingan').value,
                    pendapatan: document.getElementById('pendapatan').value,
                    tanggalValidasi: document.getElementById('tanggalValidasi').value,
                    validator: document.getElementById('validator').value,
                    driveLink: document.getElementById('driveLink').value,
                    kodeValidasi: document.getElementById('kodeValidasi').value,
                    keterangan: document.getElementById('keterangan').value
                };

                if (editId) {
                    const index = appData.findIndex(item => item.id == editId);
                    appData[index] = formData;
                    document.getElementById('inputForm').removeAttribute('data-edit-id');
                    document.getElementById('saveDataBtn').textContent = 'Simpan Data Nelayan';
                    showNotification('Data berhasil diperbarui!', 'success');
                } else {
                    appData.push(formData);
                    this.reset();
                    showNotification('Data baru berhasil disimpan!', 'success');
                }

                saveData();
                updateDashboard();
                renderDataTable();
                checkGlobalDuplicates();
                this.classList.remove('was-validated');
                setTimeout(() => { document.getElementById('v-pills-data-tab').click(); }, 300);
            });

            // Conditional Logic for Input Form
            document.getElementById('inputForm').addEventListener('reset', function() {
                document.getElementById('inputForm').removeAttribute('data-edit-id');
                document.getElementById('saveDataBtn').textContent = 'Simpan Data Nelayan';
                document.getElementById('ownerFields').style.display = 'none';
                document.getElementById('nomorPasContainer').style.display = 'none';
                document.getElementById('jenisIkanLainnya').style.display = 'none';
                // Reset WA button state after full reset delay
                setTimeout(() => { 
                    const waInput = document.getElementById('whatsapp');
                    const waBtn = document.getElementById('btnNoWA');
                    waInput.removeAttribute('readonly');
                    waInput.value = '';
                    waBtn.classList.remove('active', 'btn-secondary');
                    waBtn.classList.add('btn-outline-secondary');
                    waBtn.textContent = "Tidak Ada";
                    document.getElementById('kecamatan').dispatchEvent(new Event('change'));
                    document.getElementById('desa').value = "Pilih Desa";
                    document.getElementById('kusuka').value = "Tidak";
                }, 100);
            });

            document.getElementById('statusNelayan').addEventListener('change', function() {
                const ownerFields = document.getElementById('ownerFields');
                ownerFields.style.display = (this.value === 'Pemilik Kapal') ? 'block' : 'none';
                if(this.value === 'Pemilik Kapal') {
                    document.querySelector('input[name="dokumenOption"]:checked').dispatchEvent(new Event('change'));
                }
            });

            document.querySelectorAll('input[name="dokumenOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isYes = this.value === 'Ya';
                    document.getElementById('nomorPasContainer').style.display = isYes ? 'block' : 'none';
                });
            });

            document.getElementById('tahunLahir').addEventListener('input', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                if(year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                    document.getElementById('usia').value = currentYear - year;
                }
            });

            document.getElementById('generateKodeBtn').addEventListener('click', function() {
                const nik = document.getElementById('nik').value;
                if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
                document.getElementById('kodeValidasi').value = 'VLD-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            });

            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebarMenu').classList.toggle('mobile-show');
            });

            document.getElementById('v-pills-logout-tab').addEventListener('click', () => {
                if(confirm('Apakah Anda yakin ingin keluar? Sistem akan mengunduh data (reload.js) secara otomatis.')) {
                    backupData('reload.js');
                    setTimeout(() => location.reload(), 2000);
                }
            });

            // Table Actions (Data Tab)
            document.getElementById('searchData').addEventListener('input', renderDataTable);
            document.getElementById('itemsPerPageSelect').addEventListener('change', renderDataTable);
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                toggleBulkDeleteBtn();
            });
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteData);
            
            // Filter Tab Actions
            document.getElementById('applyFilterBtn').addEventListener('click', renderFilterTable);
            document.getElementById('btnCekGanda').addEventListener('click', showDuplicateDataInFilter);
            document.getElementById('printFilteredPdfBtn').addEventListener('click', () => printData(true));
            document.getElementById('exportFilteredExcelBtn').addEventListener('click', () => {
                const filters = {
                    desa: document.getElementById('filterDesa').value,
                    profesi: document.getElementById('filterProfesi').value,
                    status: document.getElementById('filterStatus').value,
                    jenisKapal: document.getElementById('filterJenisKapal').value,
                    dokumen: document.getElementById('filterDokumen').value,
                    usaha: document.getElementById('filterUsaha').value,
                    kusuka: document.getElementById('filterKusuka').value,
                    kecamatan: document.getElementById('filterKecamatan').value
                };
                exportData('xlsx', filters); // Placeholder to use filter data in export
            });

            // Print Tab Actions
            document.getElementById('printPdfBtn').addEventListener('click', () => printData(false));
            document.getElementById('exportFullExcelBtn').addEventListener('click', () => exportData('xlsx'));
            document.getElementById('exportReloadJsBtn').addEventListener('click', () => backupData('reload.js'));
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('xlsx'));
            
            // Export Tab Actions
            document.getElementById('sendWhatsappBtn').addEventListener('click', sendDataToWhatsapp);
            
            // Backup Tab Actions
            document.getElementById('backupDataBtn').addEventListener('click', () => backupData());
            document.getElementById('restoreFileInput').addEventListener('change', function() {
                document.getElementById('restoreDataBtn').disabled = !this.files.length;
            });
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);

            // Settings Tab Actions
            document.getElementById('saveSettingsBtn').addEventListener('click', function() {
                appSettings.appName = document.getElementById('appNameInput').value;
                appSettings.appSubtitle = document.getElementById('appSubtitleInput').value;
                appSettings.privacyMode = document.getElementById('privacyToggle').checked;
                appSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value) || 10;
                
                saveSettings();
                initializeApp();
                renderDataTable(true);
                showNotification('Pengaturan berhasil disimpan!', 'success');
            });
            
            document.getElementById('privacyToggle').addEventListener('change', function() {
                appSettings.privacyMode = this.checked;
                saveSettings();
                updatePrivacyUI();
                renderDataTable(true); // Re-render table to apply sensor
            });
            
            document.getElementById('btn-reload-repo').addEventListener('click', () => {
                if(confirm('Apakah Anda yakin ingin memuat ulang repository? Ini akan menyegarkan data dari file backup terakhir (reload.js) jika ada.')) {
                    // Logic to reload data from localStorage and rerender
                    loadData();
                    updateDashboard();
                    renderDataTable(true);
                    checkGlobalDuplicates();
                    showNotification('Data berhasil dimuat ulang dari penyimpanan lokal.', 'success');
                }
            });
        }
        
        // --- INITIALIZATION ---

        function initializeApp() {
            loadSettings();
            loadData();
            setupSelectOptions();
            initializeCharts();
            
            // Apply settings to UI
            document.title = appSettings.appName + " - ONE DATA";
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
            document.getElementById('appNameInput').value = appSettings.appName;
            document.getElementById('appSubtitleInput').value = appSettings.appSubtitle;
            document.getElementById('itemsPerPageSelect').value = appSettings.itemsPerPage;
            
            updatePrivacyUI();
        }

        function updatePrivacyUI() {
            const toggle = document.getElementById('privacyToggle');
            const status = document.getElementById('privacyStatus');
            const sensorText = document.getElementById('sensorStatusText');

            toggle.checked = appSettings.privacyMode;

            if(appSettings.privacyMode) {
                status.innerHTML = "Status: <span class='text-success'>Sensor Aktif (Aman)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: ON";
                sensorText.className = "badge bg-success me-2";
            } else {
                status.innerHTML = "Status: <span class='text-danger'>Sensor Non-Aktif (Terbuka)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: OFF";
                sensorText.className = "badge bg-danger me-2";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
        });

    </script>
</body>
</html>
