<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM PEMETAAN NELAYAN - DESA KILENSARI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Palette: Dinas Perikanan Situbondo Inspired (Professional Blue & Gold) */
            --primary-color: #003366; /* Deep Royal Blue */
            --secondary-color: #00AEEF; /* Clean Cyan/Blue */
            --accent-color: #F39C12; /* Gold/Orange */
            --danger-color: #C0392B;
            
            --dark-blue: #002244;
            --light-bg: #F4F7F6;
            
            --gradient-primary: linear-gradient(135deg, #002244 0%, #003366 100%);
            --gradient-header: linear-gradient(120deg, #002244 0%, #003366 50%, #00509E 100%);
            --gradient-accent: linear-gradient(135deg, #F39C12, #D35400);
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 15px 25px rgba(0,0,0,0.15);
            
            --glass-effect: rgba(255, 255, 255, 0.98);
        }
        
        body {
            background: #EAEEF2;
            background-image: radial-gradient(#dce4eb 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(0, 51, 102, 0.1);
        }
        
        /* Header */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 40px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid var(--accent-color); 
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .app-logo {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
            color: #E0E0E0; 
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        /* Navigation */
        .col-md-3.col-lg-2.bg-light {
            background-color: #F8F9FA !important;
            border-right: 1px solid #DEE2E6;
        }

        .nav-pills .nav-link {
            border-radius: 6px;
            margin-bottom: 5px;
            padding: 12px 18px;
            font-weight: 600;
            color: #555;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            border-left: 3px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #E8F0FE;
            color: var(--primary-color);
            transform: translateX(3px);
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-color);
            border-left: 3px solid var(--accent-color);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 51, 102, 0.2);
        }
        
        /* Components */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid var(--accent-color);
            padding-left: 15px;
            margin: 20px 0 25px 0;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem;
            background: linear-gradient(to right, rgba(0, 51, 102, 0.05), transparent);
            padding-top: 8px;
            padding-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }
        
        .btn { border-radius: 6px; font-weight: 600; padding: 10px 20px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background: var(--dark-blue); border-color: var(--dark-blue); }
        
        .form-label { font-weight: 600; color: #444; font-size: 0.85rem; margin-bottom: 6px; }
        .form-control, .form-select { border-radius: 6px; padding: 10px 15px; border: 1px solid #ced4da; font-size: 0.95rem; }
        .form-control:focus, .form-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.15); }
        
        /* Tables */
        .data-table { border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid #eee; }
        .data-table th { background: var(--primary-color) !important; color: white; padding: 14px 10px; border: none; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        .data-table td { padding: 12px 10px; font-size: 0.9rem; vertical-align: middle; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background-color: #f8f9fa; }
        
        /* Stats & Cards */
        .card { border-radius: 10px; border: none; box-shadow: var(--shadow-sm); background: white; margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .card-header { background: #f8f9fa; color: var(--primary-color); font-weight: 700; border-bottom: 1px solid #eee; padding: 15px 20px; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; }
        .stats-box { background: white; border-radius: 10px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--accent-color); padding: 20px; position: relative; overflow: hidden; }
        .stats-number { color: var(--primary-color); font-family: 'Montserrat', sans-serif; }

        /* Login */
        .login-header { background: var(--gradient-header); border-bottom: 4px solid var(--accent-color); padding: 30px; }
        .btn-login { background: var(--gradient-accent); border: none; color: white; transition: 0.3s; }
        .btn-login:hover { filter: brightness(1.1); }
        
        /* Custom UI Elements */
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.6; font-size: 0.75rem; color: rgba(255,255,255,0.8); }
        .whatsapp-input-container { position: relative; }
        .whatsapp-prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-weight: 500; font-size: 0.9rem; }
        .whatsapp-input { padding-left: 45px !important; }
        
        /* FLOATING SPEED DIAL MENU */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 15px;
        }

        .fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s;
        }

        .fab-main:hover { transform: scale(1.1); background: var(--dark-blue); }
        .fab-main.active { transform: rotate(45deg); background: var(--danger-color); }

        .fab-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }

        .fab-container.open .fab-item {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Tooltip for FAB */
        .fab-item::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 60px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .fab-item:hover { background: var(--primary-color); color: white; }
        .fab-item:hover::after { opacity: 1; }

        /* PULSE ANIMATION FOR INPUT BUTTON */
        .fab-pulse {
            background: var(--accent-color) !important;
            color: white !important;
            border: none !important;
            animation: pulse-signal 2s infinite;
        }

        @keyframes pulse-signal {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }

        /* Conditional Section */
        #ownerFields { background-color: #FFF8E1; border: 1px dashed var(--accent-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }

        @media (max-width: 991.98px) {
            .col-md-3.col-lg-2 { display: none; }
            .mobile-show { display: block !important; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1050; width: 280px; overflow-y: auto; background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .mobile-menu-btn { display: block; position: fixed; top: 15px; left: 15px; z-index: 1060; background: var(--primary-color); color: white; padding: 10px 14px; border-radius: 6px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        }
    </style>
</head>
<body>
    <div class="modal fade login-modal" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none;">
                <div class="login-header text-center">
                    <div class="mb-3">
                        <i class="fas fa-anchor fa-3x text-warning" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));"></i>
                    </div>
                    <h3 class="text-white fw-bold mb-1" style="font-family: 'Montserrat';">SISTEM SATU DATA</h3>
                    <p class="text-white-50 mb-0 small">KABUPATEN SITUBONDO</p>
                </div>
                <div class="login-body p-4 bg-white">
                    <form id="loginForm">
                        <div class="mb-4">
                            <label class="form-label text-muted">
                                <i class="fas fa-shield-alt me-2 text-primary"></i> Kode Akses (Auto-Locked)
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control bg-light border-0" id="securityCode" value="BidangPN1945" readonly style="padding: 12px; font-family: monospace;">
                                <span class="input-group-text bg-light border-0"><i class="fas fa-lock text-muted"></i></span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-login w-100 py-3 fw-bold shadow-sm" id="loginButton">
                            MASUK APLIKASI
                            <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                        </button>
                    </form>
                    <div class="text-center mt-4 small text-muted border-top pt-3">
                        &copy; 2025 Dinas Perikanan Situbondo
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo"><i class="fas fa-ship"></i></div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle">PEMERINTAH KABUPATEN SITUBONDO DESA KILENSARI</p>
                <div class="watermark">Professional Edition v3.0</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-4 bg-light" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt me-3"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit me-3"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-table me-3"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter me-3"></i> Filter Data</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print me-3"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export me-3"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt me-3"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog me-3"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync me-3"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top">
                             <button class="nav-link text-danger w-100 justify-content-start" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt me-3"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-5" style="background-color: #fdfdfd;">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard">
                            <h3 class="section-title">Ringkasan Eksekutif</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="text-muted fw-bold small text-uppercase">Total Nelayan</div>
                                            <i class="fas fa-users fa-2x text-primary opacity-25"></i>
                                        </div>
                                        <div class="h2 fw-bold mb-0 text-dark" id="totalPenerima">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box" style="border-left-color: var(--secondary-color);">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="text-muted fw-bold small text-uppercase">Est. Pendapatan</div>
                                            <i class="fas fa-chart-line fa-2x text-info opacity-25"></i>
                                        </div>
                                        <div class="h3 fw-bold mb-0 text-info" id="totalBantuan">Rp 0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box" style="border-left-color: #ffc107;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="text-muted fw-bold small text-uppercase">Pemilik Kapal</div>
                                            <i class="fas fa-ship fa-2x text-warning opacity-25"></i>
                                        </div>
                                        <div class="h2 fw-bold mb-0 text-warning" id="totalPemilik">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box" style="border-left-color: #28a745;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="text-muted fw-bold small text-uppercase">Rata-rata Usia</div>
                                            <i class="fas fa-user-clock fa-2x text-success opacity-25"></i>
                                        </div>
                                        <div class="h2 fw-bold mb-0 text-success" id="rataUsia">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Proporsi Profesi</div>
                                        <div class="card-body"><canvas id="profesiChart" height="250"></canvas></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Statistik Kepemilikan</div>
                                        <div class="card-body"><canvas id="kapalChart" height="250"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-input">
                            <h3 class="section-title">Formulir Pendataan</h3>
                            <div class="card">
                                <div class="card-header bg-white"><i class="fas fa-file-alt me-2"></i> Entri Data Nelayan</div>
                                <div class="card-body p-4">
                                    <form id="inputForm" novalidate>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="nama" class="form-label">Nama Lengkap</label>
                                                <input type="text" class="form-control" id="nama" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="nik" class="form-label">NIK (16 Digit)</label>
                                                <input type="text" class="form-control" id="nik" required maxlength="16">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="whatsapp" class="form-label">Nomor WhatsApp</label>
                                                <div class="whatsapp-input-container">
                                                    <span class="whatsapp-prefix">+62</span>
                                                    <input type="tel" class="form-control whatsapp-input" id="whatsapp" required placeholder="8123xxxx">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="profesi" class="form-label">Kategori Profesi</label>
                                                <select class="form-select" id="profesi" required>
                                                    <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                    <option value="Nelayan Musiman">Nelayan Musiman</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="statusNelayan" class="form-label">Status Pekerjaan</label>
                                                <select class="form-select" id="statusNelayan">
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="tahunLahir" class="form-label">Tahun Kelahiran</label>
                                                <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                <input type="text" class="form-control bg-light" id="usia" readonly>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="kecamatan" class="form-label">Kecamatan</label>
                                                <select class="form-select" id="kecamatan" required><option value="">Pilih Kecamatan</option></select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="desa" class="form-label">Desa</label>
                                                <select class="form-select" id="desa" required><option value="">Pilih Desa</option></select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="alamat" class="form-label">Alamat Lengkap (Dusun/RT/RW)</label>
                                            <textarea class="form-control" id="alamat" rows="2"></textarea>
                                        </div>

                                        <div id="ownerFields" style="display:none;">
                                            <h6 class="text-primary border-bottom pb-2 mb-3 fw-bold"><i class="fas fa-ship me-2"></i>Detail Aset Kapal</h6>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Nama Kapal</label>
                                                    <input type="text" class="form-control" id="namaKapal">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Jenis Kapal</label>
                                                    <select class="form-select" id="jenisKapal">
                                                        <option value="Perahu Jukung">Perahu Jukung</option>
                                                        <option value="Perahu Mayang">Perahu Mayang</option>
                                                        <option value="Perahu Slerek">Perahu Slerek</option>
                                                        <option value="Lainnya">Lainnya</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Ukuran (GT)</label>
                                                    <input type="text" class="form-control" id="ukuranKapal">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Mesin (PK)</label>
                                                    <input type="text" class="form-control" id="mesinKapal">
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Alat Tangkap</label>
                                                <select class="form-select" id="alatTangkap">
                                                    <option value="Jaring Lingkar (purse seine)">Jaring Lingkar (purse seine)</option>
                                                    <option value="Jaring Insang (gill net)">Jaring Insang (gill net)</option>
                                                    <option value="Jaring Angkat (lift net)">Jaring Angkat (lift net)</option>
                                                    <option value="Pancing">Pancing</option>
                                                    <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                    <option value="Lainnya">Lainnya</option>
                                                </select>
                                            </div>
                                            <div class="p-3 bg-white border rounded">
                                                <label class="form-label d-block fw-bold">Status Kepemilikan Dokumen (BPKP / PAS)</label>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenYa" value="Ya">
                                                    <label class="form-check-label" for="dokumenYa">Ada</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dokumenOption" id="dokumenTidak" value="Tidak" checked>
                                                    <label class="form-check-label" for="dokumenTidak">Tidak Ada</label>
                                                </div>
                                                <div id="nomorPasContainer" class="mt-2" style="display:none;">
                                                    <input type="text" class="form-control form-control-sm" id="nomorPas" placeholder="Masukkan Nomor PAS KAPAL">
                                                </div>
                                                <div id="dokumenAlert" class="alert alert-warning small mt-2 py-2 mb-0" style="display:block;">
                                                    <i class="fas fa-exclamation-triangle me-1"></i> Harap data kepemilikan segera dilengkapi.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="jenisIkan" class="form-label">Jenis Ikan Tangkapan Utama</label>
                                                <input type="text" class="form-control" id="jenisIkan" required placeholder="Contoh: Tongkol, Layang">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="usahaSampingan" class="form-label">Usaha Sampingan (Jika ada)</label>
                                                <input type="text" class="form-control" id="usahaSampingan" placeholder="Contoh: Ternak, Warung">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="pendapatan" class="form-label">Est. Pendapatan/Bulan (Rp)</label>
                                                <input type="number" class="form-control" id="pendapatan" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="tanggalValidasi" class="form-label">Tanggal Validasi</label>
                                                <input type="date" class="form-control" id="tanggalValidasi" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="validator" class="form-label">Petugas Validator</label>
                                                <input type="text" class="form-control" id="validator" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="driveLink" class="form-label">Link Dokumen (G-Drive)</label>
                                                <input type="url" class="form-control" id="driveLink">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="kodeValidasi" class="form-label">Kode Validasi</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control bg-light" id="kodeValidasi" readonly>
                                                    <button type="button" class="btn btn-secondary" id="generateKodeBtn">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                                            <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="d-flex justify-content-end border-top pt-3">
                                            <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-2"></i>SIMPAN DATA</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data">
                            <h3 class="section-title">Database Nelayan</h3>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                                    <span><i class="fas fa-list me-2"></i> Data Terdaftar</span>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari Nama/NIK...">
                                        <button class="btn btn-sm btn-outline-secondary" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama Lengkap</th><th>Kontak</th><th>Profesi</th><th>Status</th>
                                                    <th>Aset Kapal</th><th>Pendapatan</th><th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data database...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-filter">
                             <h3 class="section-title">Filter Data Lanjutan</h3>
                             <div class="card mb-4 border-0 shadow-sm">
                                <div class="card-body bg-light rounded">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label small">Desa</label>
                                            <select class="form-select form-select-sm" id="filterDesa"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Profesi</label>
                                            <select class="form-select form-select-sm" id="filterProfesi">
                                                <option value="">Semua</option>
                                                <option value="Nelayan Tetap">Nelayan Tetap</option>
                                                <option value="Nelayan Musiman">Nelayan Musiman</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Status Kepemilikan</label>
                                            <select class="form-select form-select-sm" id="filterStatus">
                                                <option value="">Semua</option>
                                                <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                <option value="Pemilik Kapal">Pemilik Kapal</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Jenis Kapal</label>
                                            <select class="form-select form-select-sm" id="filterJenisKapal">
                                                <option value="">Semua</option>
                                                <option value="Perahu Jukung">Perahu Jukung</option>
                                                <option value="Perahu Mayang">Perahu Mayang</option>
                                                <option value="Perahu Slerek">Perahu Slerek</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Dokumen Kapal</label>
                                            <select class="form-select form-select-sm" id="filterDokumen">
                                                <option value="">Semua</option>
                                                <option value="Ya">Punya Dokumen</option>
                                                <option value="Tidak">Tidak Punya</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Usaha Sampingan</label>
                                            <select class="form-select form-select-sm" id="filterUsaha">
                                                <option value="">Semua</option>
                                                <option value="Ada">Ada Usaha Sampingan</option>
                                                <option value="Tidak">Tidak Ada</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary w-100 btn-sm" id="applyFilterBtn"><i class="fas fa-search me-2"></i> Terapkan Filter</button>
                                        </div>
                                    </div>
                                </div>
                             </div>
                             <div class="card">
                                 <div class="card-body p-0">
                                     <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0">
                                            <thead><tr><th>No</th><th>Nama</th><th>Status</th><th>Jenis Kapal</th><th>Dokumen</th><th>Usaha Sampingan</th><th>Pendapatan</th></tr></thead>
                                            <tbody id="filterTableBody"><tr><td colspan="7" class="text-center py-4">Silakan terapkan filter untuk melihat hasil</td></tr></tbody>
                                        </table>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-print">
                            <h3 class="section-title">Cetak Laporan</h3>
                            <div class="card p-5 text-center shadow-sm">
                                <div class="mb-3"><i class="fas fa-file-pdf fa-4x text-danger opacity-50"></i></div>
                                <h5>Cetak Laporan Data Terfilter</h5>
                                <p class="text-muted">Fitur ini akan mencetak data sesuai hasil filter terakhir.</p>
                                <button class="btn btn-danger px-5 mt-3" id="printPdfBtn"><i class="fas fa-download me-2"></i> Download PDF</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-export">
                            <h3 class="section-title">Ekspor & Kirim Data</h3>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <div class="card p-4 border-success" style="background: #f0fff4; border: 1px dashed #198754;">
                                        <div class="d-flex align-items-center">
                                            <div class="me-4 text-success"><i class="fab fa-whatsapp fa-3x"></i></div>
                                            <div>
                                                <h5 class="fw-bold text-success mb-1">Lapor Cepat via WhatsApp</h5>
                                                <p class="mb-2 small text-muted">Kirim notifikasi rekap data ke Dinas Perikanan (087865614222) secara otomatis.</p>
                                                <button class="btn btn-success" id="sendWaBtn"><i class="fas fa-paper-plane me-2"></i> Kirim Laporan Hari Ini</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4"><button class="btn btn-outline-success w-100 py-4 h-100" id="exportExcelBtn"><i class="fas fa-file-excel fa-2x mb-2 d-block"></i>Download Excel</button></div>
                                <div class="col-md-4"><button class="btn btn-outline-info w-100 py-4 h-100" id="exportCsvBtn"><i class="fas fa-file-csv fa-2x mb-2 d-block"></i>Download CSV</button></div>
                                <div class="col-md-4"><button class="btn btn-outline-warning w-100 py-4 h-100" id="exportJsonBtn"><i class="fas fa-file-code fa-2x mb-2 d-block"></i>Download JSON</button></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-backup">
                            <h3 class="section-title">Backup & Restore</h3>
                            <div class="alert alert-info small"><i class="fas fa-info-circle me-2"></i> File backup akan menyertakan metadata instansi dan tanggal secara otomatis.</div>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                        <div class="mb-3"><i class="fas fa-cloud-download-alt fa-3x text-primary"></i></div>
                                        <h5>Download</h5>
                                        <p class="small text-muted mb-4">Simpan database lokal ke file komputer Anda.</p>
                                        <button class="btn btn-primary w-100" id="backupDataBtn">Download Data</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card p-4 h-100 text-center border-warning shadow-sm">
                                        <div class="mb-3"><i class="fas fa-cloud-upload-alt fa-3x text-warning"></i></div>
                                        <h5>Restore</h5>
                                        <p class="small text-muted mb-0">Kembalikan data dari file backup.</p>
                                        <input type="file" class="form-control my-3" id="restoreFileInput" accept=".js,.json">
                                        <button class="btn btn-warning w-100 text-white" id="restoreDataBtn" disabled>Restore Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="v-pills-settings">
                            <h3 class="section-title">Pengaturan Sistem</h3>
                            <div class="card p-4">
                                <form id="settingsForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nama Aplikasi</label>
                                            <input type="text" class="form-control" id="appName" value="SISTEM PEMETAAN DATA NELAYAN">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Nama Instansi</label>
                                            <input type="text" class="form-control" id="appSubtitle" value="PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-bars"></i></button>
            <a href="#" class="fab-item fab-pulse" id="fabInput" data-tooltip="Input Data Baru"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" data-tooltip="Filter Data"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabExport" data-tooltip="Ekspor Data"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" data-tooltip="Backup & Restore"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" data-tooltip="Pengaturan"><i class="fas fa-cog"></i></a>
            <a href="#" class="fab-item" id="fabReload" data-tooltip="Reload Data"><i class="fas fa-sync"></i></a>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast notification-toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- DATA CONSTANTS ---
        const SITUBONDO_DATA = {
            kecamatanList: [
                "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", "Bungatan", "Jangkar", 
                "Jatibanteng", "Kapongan", "Kendit", "Mangaran", "Mlandingan", "Panarukan", "Panji", 
                "Situbondo", "Suboh", "Sumbermalang"
            ],
            desaList: [
                "Kilensari", "Gelung", "Sumberkolak", "Peleyan", "Alasmalang", "Wringinanom", "Duwet", "Panaongan", "Paowan", "Awar-Awar", "Panarukan", 
                "Arjasa", "Curah Sreseh", "Jambangan", "Kayumas", "Kedungdowo", "Patemon", "Bayeman", "Curah Kalak", "Gadingan", "Guci", "Jelbudan", "Sumberwaru",
                "Kalianget", "Lubawang", "Tepos", "Sumberanyar", "Bulu", "Wonorejo", "Tunggulsari", "Temu",
                "Blimbing", "Demung", "Kalimas", "Kesambi Rampak", "Langkap", "Pesisir", "Widoropayung",
                "Pasir Putih", "Curah Tamiang", "Gedangan", "Jangkar", "Klatakan", "Pondok Labu", "Sumberejo", "Pesanggrahan"
            ].sort().filter((v, i, a) => a.indexOf(v) === i)
        };

        // --- GLOBAL VARIABLES ---
        let appData = [];
        let appSettings = {
            appName: 'SISTEM PEMETAAN DATA NELAYAN',
            appSubtitle: 'PEMERINTAH DESA KILENSARI KECAMATAN PANARUKAN',
            itemsPerPage: 10
        };
        let currentPage = 1;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Load logic
            initializeApp();
            setupEventListeners();
            
            // Show Login
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        });

        function initializeApp() {
            loadData();
            loadSettings();
            
            // Populate Dropdowns
            fillDropdown('kecamatan', SITUBONDO_DATA.kecamatanList, 'Pilih Kecamatan');
            fillDropdown('desa', SITUBONDO_DATA.desaList, 'Pilih Desa');
            fillDropdown('filterDesa', SITUBONDO_DATA.desaList, 'Semua Desa');
            
            document.getElementById('tanggalValidasi').value = new Date().toISOString().split('T')[0];
            updateAppIdentity();
            initializeCharts();
        }

        function fillDropdown(id, list, defaultText) {
            const select = document.getElementById(id);
            if(!select) return;
            select.innerHTML = `<option value="">${defaultText}</option>`;
            list.forEach(item => select.add(new Option(item, item)));
        }

        function updateAppIdentity() {
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Authentication
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginButton');
                btn.disabled = true;
                document.getElementById('loginSpinner').classList.remove('d-none');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    document.getElementById('appContent').style.display = 'block';
                    updateDashboard();
                    renderDataTable();
                }, 800);
            });

            // Form Handling
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('inputForm').addEventListener('reset', () => {
                setTimeout(() => {
                    document.getElementById('ownerFields').style.display = 'none';
                    document.getElementById('usia').value = '';
                }, 100);
            });
            
            // Conditional Logic
            document.getElementById('statusNelayan').addEventListener('change', function() {
                const ownerFields = document.getElementById('ownerFields');
                ownerFields.style.display = (this.value === 'Pemilik Kapal') ? 'block' : 'none';
                if(this.value === 'Pemilik Kapal') {
                    document.querySelector('input[name="dokumenOption"]:checked').dispatchEvent(new Event('change'));
                }
            });

            document.querySelectorAll('input[name="dokumenOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isYes = this.value === 'Ya';
                    document.getElementById('nomorPasContainer').style.display = isYes ? 'block' : 'none';
                    document.getElementById('dokumenAlert').style.display = isYes ? 'none' : 'block';
                });
            });

            document.getElementById('tahunLahir').addEventListener('input', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                if(year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                    document.getElementById('usia').value = currentYear - year;
                }
            });

            document.getElementById('generateKodeBtn').addEventListener('click', function() {
                const nik = document.getElementById('nik').value;
                if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
                document.getElementById('kodeValidasi').value = 'VLD-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            });

            // Navigation Mobile
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebarMenu').classList.toggle('mobile-show');
            });
            document.getElementById('v-pills-logout-tab').addEventListener('click', () => location.reload());

            // Search & Filters
            document.getElementById('searchData').addEventListener('input', renderDataTable);
            document.getElementById('clearSearchBtn').addEventListener('click', () => {
                document.getElementById('searchData').value = '';
                renderDataTable();
            });
            document.getElementById('applyFilterBtn').addEventListener('click', renderFilterTable);
            
            // Actions
            document.getElementById('printPdfBtn').addEventListener('click', printData);
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('xlsx'));
            document.getElementById('exportCsvBtn').addEventListener('click', () => exportData('csv'));
            document.getElementById('exportJsonBtn').addEventListener('click', () => exportData('json'));
            document.getElementById('sendWaBtn').addEventListener('click', sendDataToWhatsapp);
            
            // Backup
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            document.getElementById('restoreFileInput').addEventListener('change', function() {
                document.getElementById('restoreDataBtn').disabled = !this.files.length;
            });
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
            document.getElementById('btn-reload-repo').addEventListener('click', handleReloadRepo);
            
            // Settings
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                appSettings.appName = document.getElementById('appName').value;
                appSettings.appSubtitle = document.getElementById('appSubtitle').value;
                localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
                updateAppIdentity();
                showNotification('Pengaturan tersimpan!', 'success');
            });

            // Floating Menu Interactions
            setupFloatingMenu();
        }

        function setupFloatingMenu() {
            const fabMain = document.getElementById('fabMainBtn');
            const container = document.getElementById('fabMenu');
            
            fabMain.addEventListener('click', () => {
                container.classList.toggle('open');
                fabMain.querySelector('i').classList.toggle('fa-bars');
                fabMain.querySelector('i').classList.toggle('fa-times');
                fabMain.classList.toggle('active');
            });

            // Shortcut Actions
            const shortcuts = {
                'fabInput': 'v-pills-input-tab',
                'fabFilter': 'v-pills-filter-tab',
                'fabExport': 'v-pills-export-tab',
                'fabBackup': 'v-pills-backup-tab',
                'fabSettings': 'v-pills-settings-tab'
            };

            for (const [id, tabId] of Object.entries(shortcuts)) {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById(tabId).click();
                    container.classList.remove('open');
                    fabMain.classList.remove('active');
                    fabMain.querySelector('i').className = 'fas fa-bars';
                });
            }

            document.getElementById('fabReload').addEventListener('click', (e) => {
                e.preventDefault();
                handleReloadRepo();
            });
        }

        // --- CORE LOGIC ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const nik = document.getElementById('nik').value;
            const whatsapp = document.getElementById('whatsapp').value;

            if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
            if(!whatsapp.match(/^\d+$/)) return showNotification('WhatsApp hanya angka', 'error');

            const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
            
            const formData = {
                id: document.getElementById('inputForm').getAttribute('data-edit-id') || Date.now(),
                nama: document.getElementById('nama').value,
                nik: nik,
                whatsapp: whatsapp,
                profesi: document.getElementById('profesi').value,
                status: document.getElementById('statusNelayan').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                usia: document.getElementById('usia').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alamat: document.getElementById('alamat').value,
                // Owner specifics
                namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                ukuranKapal: isOwner ? document.getElementById('ukuranKapal').value : '-',
                mesinKapal: isOwner ? document.getElementById('mesinKapal').value : '-',
                alatTangkap: isOwner ? document.getElementById('alatTangkap').value : '-',
                punyaDokumen: isOwner ? document.querySelector('input[name="dokumenOption"]:checked').value : '-',
                nomorPas: isOwner && document.getElementById('dokumenYa').checked ? document.getElementById('nomorPas').value : '-',
                // Eco
                jenisIkan: document.getElementById('jenisIkan').value,
                usahaSampingan: document.getElementById('usahaSampingan').value,
                pendapatan: document.getElementById('pendapatan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value
            };

            const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
            if (editId) {
                const index = appData.findIndex(item => item.id == editId);
                appData[index] = formData;
                document.getElementById('inputForm').removeAttribute('data-edit-id');
                showNotification('Data berhasil diperbarui', 'success');
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan', 'success');
            }

            saveData();
            document.getElementById('inputForm').reset();
            document.getElementById('ownerFields').style.display = 'none';
            updateDashboard();
            renderDataTable();
            document.getElementById('v-pills-data-tab').click();
        }

        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const search = document.getElementById('searchData').value.toLowerCase();
            
            let filtered = appData.filter(d => 
                d.nama.toLowerCase().includes(search) || 
                d.nik.includes(search) || 
                d.desa.toLowerCase().includes(search)
            );

            const totalItems = filtered.length;
            const start = (currentPage - 1) * appSettings.itemsPerPage;
            const pageData = filtered.slice(start, start + appSettings.itemsPerPage);

            tableBody.innerHTML = '';
            if(pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Data tidak ditemukan</td></tr>`;
                return;
            }

            pageData.forEach((d, i) => {
                const kapalInfo = d.status === 'Pemilik Kapal' ? `<div class="small fw-bold">${d.namaKapal}</div><div class="small text-muted">${d.jenisKapal}</div>` : '-';
                
                const row = `<tr>
                    <td>${start + i + 1}</td>
                    <td><div class="fw-bold text-dark">${d.nama}</div><small class="text-muted">${d.nik}</small></td>
                    <td><a href="https://wa.me/62${d.whatsapp}" target="_blank" class="text-decoration-none btn-link"><i class="fab fa-whatsapp text-success"></i> ${d.whatsapp}</a></td>
                    <td><span class="badge bg-light text-dark border">${d.profesi}</span></td>
                    <td>${d.status}</td>
                    <td>${kapalInfo}</td>
                    <td>Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
                tableBody.appendChild(document.createElement('tbody')).innerHTML = row;
            });

            document.getElementById('tableInfo').textContent = `Menampilkan ${pageData.length} dari ${totalItems} data`;
            updatePagination(totalItems);
        }

        function updatePagination(total) {
            const pages = Math.ceil(total / appSettings.itemsPerPage);
            const ul = document.getElementById('pagination');
            ul.innerHTML = '';
            for(let i=1; i<=pages; i++) {
                ul.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" onclick="currentPage=${i};renderDataTable()">${i}</a></li>`;
            }
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            document.getElementById('inputForm').setAttribute('data-edit-id', id);
            
            // Populate fields
            ['nama', 'nik', 'whatsapp', 'profesi', 'tahunLahir', 'usia', 'kecamatan', 'desa', 'alamat', 
             'jenisIkan', 'usahaSampingan', 'pendapatan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan']
             .forEach(key => document.getElementById(key).value = d[key] || '');

            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = d.status;
            statusSelect.dispatchEvent(new Event('change'));

            if(d.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal', 'ukuranKapal', 'mesinKapal', 'alatTangkap', 'nomorPas'].forEach(key => {
                    document.getElementById(key).value = d[key] || '';
                });
                const docRadio = d.punyaDokumen === 'Ya' ? document.getElementById('dokumenYa') : document.getElementById('dokumenTidak');
                docRadio.checked = true;
                docRadio.dispatchEvent(new Event('change'));
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0,0);
        }

        function deleteData(id) {
            // SECURITY CODE CHECK
            const userCode = prompt("Masukkan KODE KEAMANAN untuk menghapus data (Default: 97531):");
            
            if(userCode === "97531") {
                if(confirm('Yakin menghapus data ini secara permanen?')) {
                    appData = appData.filter(d => d.id != id);
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    showNotification('Data berhasil dihapus', 'success');
                }
            } else if (userCode !== null) {
                alert("Kode keamanan SALAH! Akses ditolak.");
            }
        }

        function renderFilterTable() {
            const filters = {
                desa: document.getElementById('filterDesa').value,
                profesi: document.getElementById('filterProfesi').value,
                status: document.getElementById('filterStatus').value,
                jenisKapal: document.getElementById('filterJenisKapal').value,
                dokumen: document.getElementById('filterDokumen').value,
                usaha: document.getElementById('filterUsaha').value
            };

            const filtered = appData.filter(d => {
                const matchDesa = !filters.desa || d.desa === filters.desa;
                const matchProfesi = !filters.profesi || d.profesi === filters.profesi;
                const matchStatus = !filters.status || d.status === filters.status;
                const matchJenis = !filters.jenisKapal || (d.status === 'Pemilik Kapal' && d.jenisKapal === filters.jenisKapal);
                const matchDokumen = !filters.dokumen || (d.status === 'Pemilik Kapal' && d.punyaDokumen === filters.dokumen);
                const matchUsaha = !filters.usaha || (filters.usaha === 'Ada' ? (d.usahaSampingan && d.usahaSampingan.length > 2) : (!d.usahaSampingan || d.usahaSampingan.length < 2));
                
                return matchDesa && matchProfesi && matchStatus && matchJenis && matchDokumen && matchUsaha;
            });

            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';
            
            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tidak ada data yang cocok dengan filter</td></tr>`;
                return;
            }

            filtered.forEach((d, i) => {
                const docStatus = d.status === 'Pemilik Kapal' ? (d.punyaDokumen === 'Ya' ? '<span class="text-success"><i class="fas fa-check-circle"></i> Lengkap</span>' : '<span class="text-danger"><i class="fas fa-times-circle"></i> Tidak Ada</span>') : '-';
                
                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td><strong>${d.nama}</strong><br><small>${d.desa}</small></td>
                    <td>${d.status}</td>
                    <td>${d.status === 'Pemilik Kapal' ? d.jenisKapal : '-'}</td>
                    <td>${docStatus}</td>
                    <td>${d.usahaSampingan || '-'}</td>
                    <td>Rp ${parseInt(d.pendapatan).toLocaleString('id-ID')}</td>
                </tr>`;
            });
            showNotification(`Filter berhasil: ${filtered.length} data ditemukan`, 'success');
        }

        // --- DASHBOARD & CHARTS ---
        function initializeCharts() {
            window.profesiChart = new Chart(document.getElementById('profesiChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false }
            });
            window.kapalChart = new Chart(document.getElementById('kapalChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('totalPenerima').textContent = appData.length;
            const income = appData.reduce((acc, curr) => acc + (parseInt(curr.pendapatan)||0), 0);
            document.getElementById('totalBantuan').textContent = `Rp ${income.toLocaleString('id-ID')}`;
            document.getElementById('totalPemilik').textContent = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const avgAge = appData.length ? Math.round(appData.reduce((acc, c) => acc + (parseInt(c.usia)||0), 0) / appData.length) : 0;
            document.getElementById('rataUsia').textContent = avgAge + " Thn";

            // Charts
            const pData = {};
            appData.forEach(d => pData[d.profesi] = (pData[d.profesi] || 0) + 1);
            window.profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{ data: Object.values(pData), backgroundColor: ['#003366', '#F39C12', '#00AEEF'] }]
            };
            window.profesiChart.update();

            const kData = {};
            appData.filter(d => d.status === 'Pemilik Kapal').forEach(d => kData[d.jenisKapal] = (kData[d.jenisKapal] || 0) + 1);
            window.kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{ label: 'Unit', data: Object.values(kData), backgroundColor: '#00AEEF' }]
            };
            window.kapalChart.update();
        }

        // --- EXPORT & BACKUP ---
        function saveData() { localStorage.setItem('nelayanData', JSON.stringify(appData)); }
        function loadData() { 
            const d = localStorage.getItem('nelayanData');
            if(d) appData = JSON.parse(d);
        }
        function loadSettings() {
            const s = localStorage.getItem('nelayanSettings');
            if(s) Object.assign(appSettings, JSON.parse(s));
        }

        function exportData(type) {
            if(appData.length === 0) return showNotification('Tidak ada data', 'error');
            const data = appData.map(d => ({ ...d, NIK: `'${d.nik}`, WhatsApp: `'${d.whatsapp}` })); // Protect format

            if(type === 'xlsx') {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Data Nelayan");
                XLSX.writeFile(wb, `Nelayan_${appSettings.appSubtitle.slice(0,10)}_${Date.now()}.xlsx`);
            } else if (type === 'csv') {
                const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
                downloadFile(csv, 'text/csv', 'Data_Nelayan.csv');
            } else {
                downloadFile(JSON.stringify(appData, null, 2), 'application/json', 'Data_Nelayan.json');
            }
            showNotification(`Ekspor ${type.toUpperCase()} berhasil`, 'success');
        }

        function sendDataToWhatsapp() {
            const today = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const message = `Laporan Data Nelayan\n*${appSettings.appSubtitle}*\n\nTanggal Laporan: ${today}\nTotal Data Terkini: ${appData.length} Orang.\n\nMohon dicek. Terima kasih.`;
            
            const url = `https://wa.me/6287865614222?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function downloadFile(content, type, name) {
            const blob = new Blob([content], {type: type});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        function printData() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            doc.setFontSize(14); doc.text(appSettings.appName, 40, 40);
            doc.setFontSize(10); doc.text(appSettings.appSubtitle, 40, 55);
            doc.text(`Dicetak pada: ${new Date().toLocaleString()}`, 40, 70);
            
            // Mengambil data dari filter yang aktif jika ada, atau semua data jika tidak
            // Saat ini mengambil semua data untuk simplifikasi, bisa disesuaikan mengambil filtered
            const rows = appData.map((d, i) => [i+1, d.nama, d.profesi, d.status, d.desa, parseInt(d.pendapatan).toLocaleString('id-ID')]);
            
            doc.autoTable({
                head: [['No', 'Nama', 'Profesi', 'Status', 'Desa', 'Pendapatan']],
                body: rows,
                startY: 90,
                theme: 'grid',
                headStyles: { fillColor: [0, 51, 102] }
            });
            doc.save(`Laporan_Nelayan.pdf`);
        }

        function backupData() {
             const dateStr = new Date().toLocaleString('id-ID');
             // HEADER INFORMASI (Komentar JS agar tidak error saat reload tapi terbaca manusia)
             const headerInfo = `// BACKUP DATA SISTEM NELAYAN\n// INSTANSI: ${appSettings.appSubtitle}\n// TANGGAL: ${dateStr}\n// ==============================\n`;
             
             const content = `${headerInfo}window.NELAYAN_BACKUP = "${btoa(JSON.stringify(appData))}";`;
             
             const blob = new Blob([content], {type: 'text/javascript'});
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = 'download.js'; // Nama file sesuai permintaan
             a.click();
             showNotification('File Download berhasil dibuat', 'success');
        }

        function handleReloadRepo() {
            if(!confirm("Reload dari file 'download.js' di folder lokal?")) return;
            const script = document.createElement('script');
            script.src = './download.js?v=' + Date.now();
            
            script.onload = () => {
                if(window.NELAYAN_BACKUP) {
                    try {
                        const newData = JSON.parse(atob(window.NELAYAN_BACKUP));
                        newData.forEach(n => {
                            const idx = appData.findIndex(old => old.id == n.id);
                            if(idx > -1) appData[idx] = n; else appData.push(n);
                        });
                        saveData();
                        renderDataTable();
                        updateDashboard();
                        showNotification('Reload Data Berhasil!', 'success');
                    } catch(e) { showNotification('Gagal memproses data backup', 'error'); }
                } else {
                    showNotification('Variabel backup tidak ditemukan di file', 'error');
                }
            };
            script.onerror = () => showNotification('File download.js tidak ditemukan', 'error');
            document.body.appendChild(script);
        }

        function restoreData() {
            const file = document.getElementById('restoreFileInput').files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let restored = [];
                const str = e.target.result;
                
                try {
                    // Try Pure JSON
                    restored = JSON.parse(str);
                } catch {
                    // Try parsing JS variable
                    const match = str.match(/window\.NELAYAN_BACKUP = "([^"]+)";/);
                    if(match) restored = JSON.parse(atob(match[1]));
                }

                if(restored && restored.length && confirm(`Timpa data lama dengan ${restored.length} data baru?`)) {
                    appData = restored;
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    showNotification('Restore Berhasil!', 'success');
                } else {
                    showNotification('Format file tidak valid', 'error');
                }
            };
            reader.readAsText(file);
        }

        function showNotification(msg, type = 'info') {
            const toastEl = document.querySelector('.notification-toast');
            const header = toastEl.querySelector('.toast-header');
            
            const styles = {
                success: { cls: 'bg-success text-white', title: 'Sukses' },
                error: { cls: 'bg-danger text-white', title: 'Error' },
                info: { cls: 'bg-primary text-white', title: 'Info' }
            };
            
            header.className = `toast-header ${styles[type].cls}`;
            document.getElementById('toastTitle').textContent = styles[type].title;
            document.getElementById('toastMessage').textContent = msg;
            
            new bootstrap.Toast(toastEl).show();
        }
    </script>
</body>
</html>
