<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KILAT PRO - High Res Watermark</title>
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --bg: #f4f6f9;
            --card: #ffffff;
            --text: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 1.5rem; font-weight: 800; letter-spacing: 1px; }
        .header p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.9; }

        /* Section Visibility */
        .section { display: none; padding: 20px; }
        .section.active { display: block; animation: fadeEffect 0.4s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input {
            width: 100%; padding: 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1rem; box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        input { text-transform: uppercase; }

        /* Buttons */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: var(--primary); color: white; font-size: 1rem;
            font-weight: 700; cursor: pointer; display: flex;
            justify-content: center; align-items: center; gap: 8px;
            text-decoration: none; margin-bottom: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: #6c757d; }
        
        /* Camera Toolbar */
        .toolbar { display: flex; gap: 8px; margin-bottom: 10px; }
        .tool-btn {
            flex: 1; padding: 8px; background: #e9ecef; border: none;
            border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer;
        }

        /* Camera Viewport */
        #camera-frame {
            position: relative;
            background: #000;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            /* Default Aspect Ratio 3:4 */
            aspect-ratio: 3/4; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Kunci agar preview tidak gepeng */
            display: block;
        }

        img#result-preview {
            width: 100%;
            height: auto;
            display: none;
            border-radius: 10px;
        }

        /* Location Status */
        .status-pill {
            margin-top: 15px; padding: 10px; border-radius: 8px;
            background: #e7f1ff; color: #0056b3; font-size: 0.8rem;
            text-align: center; border: 1px solid #b6d4fe;
            font-weight: 500;
        }
        .status-pill.error { background: #f8d7da; color: #842029; border-color: #f5c2c7; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>KILAT</h1>
        <p>Kamera Interaktif Lacak Aktifitas Terkini</p>
    </div>

    <div id="view-form" class="section active">
        <div class="form-group">
            <label>Nama Petugas <span style="color:red">*</span></label>
            <input type="text" id="inUser" placeholder="CONTOH: BUDI" oninput="cleanInput(this)">
        </div>
        <div class="form-group">
            <label>Nama Kegiatan <span style="color:red">*</span></label>
            <input type="text" id="inKegiatan" placeholder="CONTOH: PATROLI" oninput="cleanInput(this)">
        </div>
        <div class="form-group">
            <label>Nama Dinas (Opsional)</label>
            <input type="text" id="inDinas" placeholder="DINAS PERIKANAN" oninput="cleanInput(this)">
        </div>
        <div class="form-group">
            <label>Nama Bidang (Opsional)</label>
            <input type="text" id="inBidang" placeholder="BIDANG TANGKAP" oninput="cleanInput(this)">
        </div>
        <button class="btn" onclick="startApp()">üì∏ Masuk & Buka Kamera</button>
    </div>

    <div id="view-camera" class="section">
        <div class="toolbar">
            <button class="tool-btn" onclick="toggleCamera()">üîÑ Balik Kamera</button>
            <select id="selRatio" class="tool-btn" onchange="updateRatio()">
                <option value="0.75">Rasio 3:4</option>
                <option value="1">Rasio 1:1</option>
                <option value="0.5625">Rasio 9:16</option>
            </select>
        </div>

        <div id="camera-frame">
            <video id="video" autoplay playsinline muted></video>
            <img id="result-preview" alt="Hasil">
        </div>

        <div id="loc-status" class="status-pill">üì° Mencari GPS...</div>

        <div id="cam-actions" style="margin-top: 15px;">
            <button class="btn" onclick="processCapture()">Jepret Foto</button>
            <button class="btn btn-secondary" onclick="resetForm()">Kembali</button>
        </div>

        <div id="res-actions" style="display:none; margin-top: 15px;">
            <a id="lnkDownload" class="btn" href="#">‚¨áÔ∏è Simpan Foto</a>
            <button class="btn btn-secondary" onclick="retryPhoto()">Foto Ulang</button>
        </div>
        
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
</div>

<script>
    // --- STATE VARIABLES ---
    let stream = null;
    let camSide = "environment"; // Belakang
    let targetRatio = 0.75; // Default 3:4
    let geoData = { lat: "-", lon: "-", addr: "Mencari alamat...", acc: 0 };
    
    // --- HELPERS ---
    const cleanInput = (el) => { el.value = el.value.replace(/[^a-zA-Z0-9\s]/g, '').toUpperCase(); };

    // --- NAVIGATION ---
    function startApp() {
        if (!document.getElementById('inUser').value || !document.getElementById('inKegiatan').value) {
            alert("Nama dan Kegiatan wajib diisi!"); return;
        }
        document.getElementById('view-form').classList.remove('active');
        document.getElementById('view-camera').classList.add('active');
        initCamera();
        initGPS();
        updateRatio();
    }

    function resetForm() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('view-camera').classList.remove('active');
        document.getElementById('view-form').classList.add('active');
        retryPhoto();
    }

    // --- CAMERA ENGINE ---
    async function initCamera() {
        const video = document.getElementById('video');
        if (stream) stream.getTracks().forEach(t => t.stop());
        
        try {
            // Minta resolusi 4K atau Full HD
            stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    facingMode: camSide,
                    width: { ideal: 4096 }, 
                    height: { ideal: 2160 }
                }
            });
            video.srcObject = stream;
        } catch (e) {
            alert("Gagal akses kamera. Periksa izin browser.");
        }
    }

    function toggleCamera() {
        camSide = (camSide === "environment") ? "user" : "environment";
        initCamera();
    }

    function updateRatio() {
        targetRatio = parseFloat(document.getElementById('selRatio').value);
        // Ubah tampilan CSS container agar preview terlihat benar
        document.getElementById('camera-frame').style.aspectRatio = `${targetRatio}`;
    }

    // --- GPS ENGINE ---
    function initGPS() {
        const el = document.getElementById('loc-status');
        if (!navigator.geolocation) { el.innerText = "GPS Error"; return; }

        navigator.geolocation.watchPosition(
            async (pos) => {
                geoData.lat = pos.coords.latitude.toFixed(6);
                geoData.lon = pos.coords.longitude.toFixed(6);
                geoData.acc = Math.round(pos.coords.accuracy);
                
                let signal = geoData.acc > 50 ? "(Sinyal Lemah)" : "(Akurat)";
                el.innerText = `GPS: ${geoData.lat}, ${geoData.lon} ${signal}`;
                el.className = "status-pill";

                // Reverse Geocode (Hanya sekali jika alamat masih kosong atau user pindah jauh)
                if (geoData.addr === "Mencari alamat...") {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${geoData.lat}&lon=${geoData.lon}`);
                        const json = await res.json();
                        if (json.display_name) geoData.addr = json.display_name;
                    } catch (e) { geoData.addr = "Lokasi tidak terdeteksi"; }
                }
            },
            (err) => {
                el.innerText = "Gagal mengambil Lokasi. Aktifkan GPS.";
                el.className = "status-pill error";
            },
            { enableHighAccuracy: true, maximumAge: 0 }
        );
    }

    // --- CORE: IMAGE PROCESSING (ANTI BLUR) ---
    function processCapture() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimasi rendering

        // 1. Dapatkan Resolusi Asli Video (Misal: 4000x3000)
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        
        // 2. Hitung Crop Area berdasarkan Rasio yang dipilih
        // Kita ingin hasil akhir sesuai rasio, tapi kualitas resolusi penuh
        let sw, sh, sx, sy;
        const vidRatio = vw / vh;

        if (vidRatio > targetRatio) {
            // Video terlalu lebar, potong sisi kiri-kanan
            sh = vh;
            sw = vh * targetRatio;
            sx = (vw - sw) / 2;
            sy = 0;
        } else {
            // Video terlalu tinggi, potong sisi atas-bawah
            sw = vw;
            sh = vw / targetRatio;
            sx = 0;
            sy = (vh - sh) / 2;
        }

        // 3. Set Ukuran Canvas = Ukuran Potongan (Resolusi Tinggi)
        canvas.width = sw;
        canvas.height = sh;

        // 4. Gambar Video ke Canvas
        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

        // 5. Tambahkan Watermark (Dynamic Scaling)
        addWatermark(ctx, sw, sh);

        // 6. Tampilkan Hasil
        const finalImage = canvas.toDataURL("image/jpeg", 1.0); // Quality 100%
        const imgEl = document.getElementById('result-preview');
        imgEl.src = finalImage;
        imgEl.style.display = 'block';
        video.style.display = 'none';

        // 7. Siapkan Download
        prepareDownload(finalImage);

        // UI Toggle
        document.getElementById('cam-actions').style.display = 'none';
        document.getElementById('res-actions').style.display = 'block';
        document.querySelector('.toolbar').style.display = 'none';
    }

    function addWatermark(ctx, w, h) {
        // --- KONFIGURASI FONT DINAMIS ---
        // Kunci agar tidak ngeblur: Ukuran font adalah persentase dari lebar canvas
        const baseSize = w * 0.032; // 3.2% dari lebar foto
        const margin = w * 0.03;
        const lineHeight = baseSize * 1.4;
        
        // Data Input
        const user = document.getElementById('inUser').value;
        const keg = document.getElementById('inKegiatan').value;
        const dinas = document.getElementById('inDinas').value;
        const bidang = document.getElementById('inBidang').value;
        
        // Data Waktu
        const now = new Date();
        const strDate = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const strTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':') + ' WIB';

        // 1. Gradient Background (Bawah)
        const barHeight = baseSize * 10;
        const grad = ctx.createLinearGradient(0, h - barHeight, 0, h);
        grad.addColorStop(0, "rgba(0,0,0,0)");
        grad.addColorStop(0.4, "rgba(0,0,0,0.6)");
        grad.addColorStop(1, "rgba(0,0,0,0.9)");
        ctx.fillStyle = grad;
        ctx.fillRect(0, h - barHeight, w, barHeight);

        // 2. Setting Text Global (Shadow agar tajam)
        ctx.shadowColor = "black";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.fillStyle = "white";
        ctx.textBaseline = "bottom";

        // Cursor Y (Mulai dari bawah)
        let y = h - margin;
        let x = margin;

        // --- RENDER TEXT ---
        
        // URL (Kanan Bawah)
        ctx.textAlign = "right";
        ctx.font = `italic ${baseSize * 0.6}px Arial`;
        ctx.fillText("www.dinasperikanan.com/kilat", w - margin, y);

        // Info Utama (Kiri Bawah)
        ctx.textAlign = "left";

        // Baris 1: Koordinat
        ctx.font = `bold ${baseSize * 0.75}px monospace`;
        ctx.fillText(`LOC: ${geoData.lat}, ${geoData.lon}`, x, y);
        y -= lineHeight;

        // Baris 2: Alamat (Wrap text sederhana / potong)
        ctx.font = `${baseSize * 0.7}px Arial`;
        let addr = geoData.addr.length > 65 ? geoData.addr.substring(0, 65) + "..." : geoData.addr;
        ctx.fillText(addr, x, y);
        y -= (lineHeight * 1.2);

        // Baris 3: Waktu (Kuning)
        ctx.font = `bold ${baseSize}px Arial`;
        ctx.fillStyle = "#FFD700"; 
        ctx.fillText(`${strDate} | ${strTime}`, x, y);
        ctx.fillStyle = "white"; // Reset putih
        y -= (lineHeight * 1.5);

        // Baris 4: Kegiatan (Cyan - Besar)
        ctx.font = `900 ${baseSize * 1.3}px sans-serif`;
        ctx.fillStyle = "#00FFFF";
        ctx.fillText(keg, x, y);
        ctx.fillStyle = "white";
        y -= (lineHeight * 1.2);

        // Baris 5: Dinas & Bidang
        ctx.font = `bold ${baseSize * 0.9}px Arial`;
        let unit = dinas;
        if (bidang) unit += " - " + bidang;
        if (unit) {
            ctx.fillText(unit, x, y);
            y -= (lineHeight * 1.5);
        }

        // Baris 6: User (Paling Atas)
        ctx.font = `bold ${baseSize * 0.8}px Arial`;
        ctx.fillStyle = "#DDDDDD";
        ctx.fillText(`OLEH: ${user}`, x, y);
    }

    // --- DOWNLOAD LOGIC ---
    function prepareDownload(url) {
        const a = document.getElementById('lnkDownload');
        const keg = document.getElementById('inKegiatan').value.replace(/\s+/g, '_');
        
        // Counter Logic
        const today = new Date().toISOString().split('T')[0];
        let lastDate = localStorage.getItem('kilat_date');
        let count = parseInt(localStorage.getItem('kilat_count') || "0");
        
        if (lastDate !== today) { count = 0; localStorage.setItem('kilat_date', today); }
        count++;
        localStorage.setItem('kilat_count', count);
        
        const noUrut = String(count).padStart(3, '0');
        const dateStr = today.replace(/-/g, '');
        
        a.href = url;
        a.download = `${keg}_${dateStr}_${noUrut}.jpg`;
    }

    function retryPhoto() {
        document.getElementById('video').style.display = 'block';
        document.getElementById('result-preview').style.display = 'none';
        document.getElementById('cam-actions').style.display = 'block';
        document.getElementById('res-actions').style.display = 'none';
        document.querySelector('.toolbar').style.display = 'flex';
    }
</script>

</body>
</html>
