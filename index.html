<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Statistik Bantuan Nelayan - Dinas Perikanan Situbondo</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ca6702;
            --dark-blue: #001219;
            --light-bg: #f0f4f8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.3rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-brand img {
            height: 40px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .main-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .header-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--accent-color);
        }
        
        .header-title {
            color: var(--dark-blue);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .header-subtitle {
            color: #6c757d;
            font-size: 1rem;
        }
        
        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            background: white;
            margin-bottom: 25px;
            height: 600px;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .control-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            height: 100%;
            border-left: 4px solid var(--accent-color);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 15px;
            flex-direction: column;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .table-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            width: 320px;
            border: 1px solid #dee2e6;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            max-width: 250px;
            border: 1px solid #dee2e6;
            backdrop-filter: blur(5px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            font-weight: 600;
            padding: 10px 20px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #004d5c, #088488);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 95, 115, 0.3);
        }
        
        .popup-content {
            max-width: 350px;
        }
        
        .popup-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .popup-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .popup-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .popup-stat:last-child {
            border-bottom: none;
        }
        
        .popup-stat-label {
            font-weight: 500;
        }
        
        .popup-stat-value {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .footer {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 20px 0;
            margin-top: 40px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-left: 5px solid var(--secondary-color);
            max-width: 400px;
            display: none;
            transform: translateY(100px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            display: block;
            transform: translateY(0);
        }
        
        .notification.success {
            border-left-color: #28a745;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification.warning {
            border-left-color: #ffc107;
        }
        
        .notification.info {
            border-left-color: #17a2b8;
        }
        
        .data-source-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px dashed var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .map-container {
                height: 450px;
            }
            
            .search-box {
                width: calc(100% - 40px);
                max-width: 300px;
            }
            
            .legend {
                max-width: 200px;
                padding: 10px;
                bottom: 10px;
                right: 10px;
            }
            
            .stat-value {
                font-size: 1.6rem;
            }
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .kecamatan-summary {
            margin-top: 25px;
        }
        
        .kecamatan-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .kecamatan-item:hover {
            background-color: #f8f9fa;
            padding-left: 15px;
        }
        
        .kecamatan-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .kecamatan-count {
            float: right;
            background: var(--secondary-color);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" alt="Logo">
                <span>Peta Statistik Bantuan Nelayan</span>
            </a>
            <div class="text-white text-end">
                <div class="fw-bold">Dinas Peternakan dan Perikanan</div>
                <small>Kabupaten Situbondo</small>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-container">
        <!-- Header -->
        <div class="header-panel">
            <h2 class="header-title">Peta Distribusi Bantuan Nelayan Kabupaten Situbondo</h2>
            <p class="header-subtitle">Visualisasi data statistik per desa berdasarkan Sistem Bantuan Barang Pinjam Pakai - Bidang Pemberdayaan Nelayan</p>
            
            <div class="row mt-4">
                <div class="col-md-9">
                    <div class="data-source-info">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-database me-2"></i> Sumber Data</h6>
                                <p class="mb-1 small">Data diperbarui otomatis dari file <code>datapeta.js</code> yang dihasilkan oleh Sistem Bantuan Nelayan</p>
                                <p class="mb-0 small">URL: <span id="dataSourceUrl" class="fw-bold">https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/main/datapeta.js</span></p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <button id="reloadDataBtn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-2"></i> Reload Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <div class="small text-muted mt-2">
                        <i class="fas fa-clock me-1"></i> 
                        Terakhir diperbarui: <span id="lastUpdateDate" class="fw-bold">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <h5 class="control-title">
                <i class="fas fa-sliders-h"></i>
                Kontrol Peta & Filter Data
            </h5>
            
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Kecamatan</label>
                    <select id="kecamatanFilter" class="form-select">
                        <option value="">Semua Kecamatan</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Jenis Bantuan</label>
                    <select id="jenisBantuanFilter" class="form-select">
                        <option value="">Semua Jenis</option>
                        <option value="Uang">Uang</option>
                        <option value="Barang">Barang</option>
                        <option value="Jasa">Jasa</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Tahun</label>
                    <select id="tahunFilter" class="form-select">
                        <option value="">Semua Tahun</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Tampilan</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="viewMarkers">
                            <i class="fas fa-map-marker-alt"></i> Marker
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="viewHeatmap">
                            <i class="fas fa-fire"></i> Heatmap
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="viewBoth">
                            <i class="fas fa-layer-group"></i> Keduanya
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="clusterMarkers" checked>
                        <label class="form-check-label" for="clusterMarkers">Cluster Marker</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showLabels" checked>
                        <label class="form-check-label" for="showLabels">Tampilkan Label</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="autoZoom">
                        <label class="form-check-label" for="autoZoom">Auto Zoom ke Filter</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map and Stats -->
        <div class="row">
            <div class="col-lg-8 col-md-12 mb-4">
                <div class="map-container">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                        <h5 class="mt-3">Memuat Data Peta...</h5>
                        <p class="text-center mt-2" id="loadingMessage">Mengambil data dari GitHub</p>
                        <div class="progress mt-3" style="width: 80%;">
                            <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" placeholder="Cari desa atau kecamatan...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="mt-2" style="display: none; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="map"></div>
                    
                    <div class="legend">
                        <h6><i class="fas fa-key me-2"></i> Legenda Intensitas</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffffcc; border: 1px solid #ccc;"></div>
                            <span>Rendah (â‰¤10 penerima)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #a1dab4; border: 1px solid #8bc9a3;"></div>
                            <span>Sedang (11-30 penerima)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #41b6c4; border: 1px solid #36a0ad;"></div>
                            <span>Tinggi (31-60 penerima)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #225ea8; border: 1px solid #1d4f8f;"></div>
                            <span>Sangat Tinggi (>60 penerima)</span>
                        </div>
                        <hr class="my-2">
                        <small class="text-muted"><i class="fas fa-info-circle me-1"></i> Klik marker untuk detail lengkap</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="stats-panel">
                    <h5 class="control-title">
                        <i class="fas fa-chart-bar"></i>
                        Statistik Utama
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalDesa">0</div>
                                <div class="stat-label">Desa/Kelurahan</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalPenerima">0</div>
                                <div class="stat-label">Total Penerima</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalBantuan">Rp 0</div>
                                <div class="stat-label">Total Nilai Bantuan</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="rataBantuan">Rp 0</div>
                                <div class="stat-label">Rata-rata per Penerima</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="jenisBantuanChart"></canvas>
                    </div>
                    
                    <div class="kecamatan-summary">
                        <h6 class="mt-4 mb-3"><i class="fas fa-map me-2"></i> Ringkasan per Kecamatan</h6>
                        <div id="kecamatanList" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <p class="mt-2 small">Memuat data kecamatan...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="data-table-container">
            <h5 class="table-title">
                <i class="fas fa-table"></i>
                Data Detail per Desa
            </h5>
            
            <div class="table-responsive">
                <table class="table table-hover" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Desa/Kelurahan</th>
                            <th>Kecamatan</th>
                            <th>Jumlah Penerima</th>
                            <th>Uang (Rp)</th>
                            <th>Barang (Unit)</th>
                            <th>Jasa (Paket)</th>
                            <th>Total Bantuan</th>
                            <th>Rata-rata</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Memuat data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6>Dinas Peternakan dan Perikanan Kabupaten Situbondo</h6>
                    <p class="mb-1">Bidang Pemberdayaan Nelayan</p>
                    <p class="mb-0">Jl. PB. Sudirman No. 99 Situbondo - Jawa Timur</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="mb-1">
                        <a href="https://www.dinasperikanansitubondo.com" class="text-decoration-none" target="_blank">
                            <i class="fas fa-globe me-1"></i> www.dinasperikanansitubondo.com
                        </a>
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-phone me-1"></i> (0338) 671123
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center small">
                &copy; 2025 Peta Statistik Bantuan Nelayan - Sistem Informasi Geografis Kabupaten Situbondo
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="d-flex">
            <div class="me-3" id="notificationIcon">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div class="flex-grow-1">
                <h6 id="notificationTitle" class="mb-1">Notifikasi</h6>
                <p id="notificationMessage" class="mb-0 small"></p>
            </div>
            <button type="button" class="btn-close" id="closeNotificationBtn"></button>
        </div>
    </div>
    
    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    
    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Script -->
    <script>
        // Variabel global
        let map;
        let markers = [];
        let markerCluster;
        let heatmapLayer;
        let petaData = null;
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // URL data peta - PASTIKAN URL INI BENAR!
        // Sesuaikan dengan URL di repository GitHub Anda
        const DATA_PETA_URL = 'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/datapeta.js';
        // Alternatif: 'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/main/datapeta.js'
        
        // Warna untuk intensitas
        const intensityColors = {
            rendah: '#ffffcc',
            sedang: '#a1dab4',
            tinggi: '#41b6c4',
            sangatTinggi: '#225ea8'
        };
        
        // Mode tampilan
        let viewMode = 'markers'; // 'markers', 'heatmap', 'both'
        
        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplikasi peta statistik dimuat');
            initMap();
            loadPetaData();
            setupEventListeners();
        });
        
        // Inisialisasi peta Leaflet
        function initMap() {
            console.log('Menginisialisasi peta...');
            // Posisi tengah: Situbondo
            map = L.map('map').setView([-7.7062, 113.9603], 11);
            
            // Tambahkan tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Tambahkan kontrol skala
            L.control.scale({position: 'bottomleft'}).addTo(map);
            
            console.log('Peta berhasil diinisialisasi');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Reload data button
            document.getElementById('reloadDataBtn').addEventListener('click', loadPetaData);
            
            // Filter events
            document.getElementById('kecamatanFilter').addEventListener('change', applyFilters);
            document.getElementById('jenisBantuanFilter').addEventListener('change', applyFilters);
            document.getElementById('tahunFilter').addEventListener('change', applyFilters);
            
            // View mode buttons
            document.getElementById('viewMarkers').addEventListener('click', function() {
                setViewMode('markers');
            });
            
            document.getElementById('viewHeatmap').addEventListener('click', function() {
                setViewMode('heatmap');
            });
            
            document.getElementById('viewBoth').addEventListener('click', function() {
                setViewMode('both');
            });
            
            // Checkbox events
            document.getElementById('clusterMarkers').addEventListener('change', function() {
                if (petaData) {
                    applyFilters();
                }
            });
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
            });
            
            // Close notification
            document.getElementById('closeNotificationBtn').addEventListener('click', function() {
                document.getElementById('notification').classList.remove('show');
            });
            
            // Auto zoom checkbox
            document.getElementById('autoZoom').addEventListener('change', function() {
                if (this.checked && filteredData.length > 0) {
                    zoomToFilteredData();
                }
            });
            
            console.log('Event listeners berhasil di-setup');
        }
        
        // Set view mode
        function setViewMode(mode) {
            viewMode = mode;
            
            // Update button states
            document.getElementById('viewMarkers').classList.remove('active');
            document.getElementById('viewHeatmap').classList.remove('active');
            document.getElementById('viewBoth').classList.remove('active');
            
            document.getElementById(`view${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // Update map display
            updateMapDisplay();
        }
        
        // Update map display based on view mode
        function updateMapDisplay() {
            // Clear existing layers
            removeMarkersFromMap();
            removeHeatmapFromMap();
            
            // Add layers based on view mode
            if (viewMode === 'markers' || viewMode === 'both') {
                addMarkersToMap();
            }
            
            if (viewMode === 'heatmap' || viewMode === 'both') {
                addHeatmapToMap();
            }
        }
        
        // Load data peta dari GitHub
        function loadPetaData() {
            console.log('Memulai proses load data peta...');
            showLoading(true, 'Mengambil data dari GitHub...');
            
            // Tambahkan timestamp untuk menghindari cache
            const timestamp = Date.now();
            const url = `${DATA_PETA_URL}?t=${timestamp}`;
            
            console.log('URL data peta:', url);
            
            // Update loading progress
            updateLoadingProgress(10);
            
            // Coba metode fetch terlebih dahulu (lebih reliable)
            fetch(url)
                .then(response => {
                    updateLoadingProgress(30);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
                    }
                    
                    return response.text();
                })
                .then(scriptText => {
                    updateLoadingProgress(60);
                    console.log('Data berhasil di-fetch, panjang:', scriptText.length, 'karakter');
                    
                    // Coba parse data
                    try {
                        // Ekstrak data dari script JS
                        const dataMatch = scriptText.match(/window\.DATA_PETA_STATISTIK\s*=\s*({[\s\S]*?});/);
                        
                        if (dataMatch && dataMatch[1]) {
                            // Parse JSON data
                            const dataJson = dataMatch[1];
                            petaData = JSON.parse(dataJson);
                            console.log('Data berhasil di-parse:', petaData);
                        } else {
                            // Coba eksekusi script untuk mendapatkan variabel
                            console.log('Mencoba mengeksekusi script...');
                            
                            // Simpan variabel global sementara
                            window._tempData = null;
                            
                            // Modifikasi script untuk menyimpan data ke variabel sementara
                            const modifiedScript = scriptText.replace(
                                'window.DATA_PETA_STATISTIK =',
                                'window._tempData ='
                            );
                            
                            // Eksekusi script
                            eval(modifiedScript);
                            
                            if (window._tempData) {
                                petaData = window._tempData;
                                console.log('Data berhasil diambil dari eksekusi script:', petaData);
                            } else {
                                throw new Error('Data tidak ditemukan dalam script');
                            }
                        }
                        
                        // Process data
                        processPetaData();
                        updateLoadingProgress(100);
                        showNotification('Data peta berhasil dimuat!', 'success');
                        
                    } catch (error) {
                        console.error('Error parsing data:', error);
                        showNotification(`Error parsing data: ${error.message}`, 'error');
                        showLoading(false);
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    
                    // Coba metode alternatif dengan script tag
                    console.log('Mencoba metode alternatif dengan script tag...');
                    loadWithScriptTag(url);
                });
        }
        
        // Metode alternatif: Load dengan script tag
        function loadWithScriptTag(url) {
            showLoading(true, 'Mencoba metode alternatif...');
            
            // Hapus script sebelumnya jika ada
            const existingScript = document.getElementById('petaDataScript');
            if (existingScript) {
                existingScript.remove();
            }
            
            // Buat script element
            const script = document.createElement('script');
            script.id = 'petaDataScript';
            script.src = url;
            
            // Timeout handling
            const timeout = setTimeout(() => {
                script.onerror = null;
                script.remove();
                showNotification('Timeout: Gagal memuat data. Periksa koneksi atau URL.', 'error');
                showLoading(false);
            }, 15000);
            
            script.onload = function() {
                clearTimeout(timeout);
                updateLoadingProgress(80);
                
                if (window.DATA_PETA_STATISTIK) {
                    petaData = window.DATA_PETA_STATISTIK;
                    console.log('Data berhasil dimuat via script tag:', petaData);
                    processPetaData();
                    updateLoadingProgress(100);
                    showNotification('Data peta berhasil dimuat via script tag!', 'success');
                } else {
                    showNotification('Data tidak ditemukan dalam file JS.', 'error');
                    showLoading(false);
                }
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                showNotification('Gagal memuat file datapeta.js. Pastikan file ada di repository.', 'error');
                showLoading(false);
            };
            
            document.head.appendChild(script);
        }
        
        // Process data peta
        function processPetaData() {
            console.log('Memproses data peta...');
            
            if (!petaData || !petaData.data) {
                showNotification('Data peta kosong atau tidak valid', 'error');
                showLoading(false);
                return;
            }
            
            // Set filtered data awal
            filteredData = [...petaData.data];
            
            // Update metadata
            document.getElementById('lastUpdateDate').textContent = 
                petaData.metadata.lastUpdate || petaData.metadata.generatedAt || '-';
            
            // Update filter dropdowns
            updateFilterDropdowns();
            
            // Update statistik
            updateOverallStats();
            
            // Update chart
            updateChart();
            
            // Render data
            renderMapData();
            renderDataTable();
            updateKecamatanList();
            
            // Sembunyikan loading
            setTimeout(() => {
                showLoading(false);
            }, 500);
            
            console.log('Data peta berhasil diproses:', filteredData.length, 'item');
        }
        
        // Update filter dropdowns
        function updateFilterDropdowns() {
            if (!petaData) return;
            
            const kecamatanFilter = document.getElementById('kecamatanFilter');
            const tahunFilter = document.getElementById('tahunFilter');
            
            // Reset dropdowns
            kecamatanFilter.innerHTML = '<option value="">Semua Kecamatan</option>';
            tahunFilter.innerHTML = '<option value="">Semua Tahun</option>';
            
            // Collect unique values
            const kecamatanSet = new Set();
            const tahunSet = new Set();
            
            petaData.data.forEach(item => {
                if (item.kecamatan) kecamatanSet.add(item.kecamatan);
                
                if (item.tahunDistribusi && item.tahunDistribusi.length > 0) {
                    item.tahunDistribusi.forEach(td => {
                        if (td.tahun) tahunSet.add(td.tahun);
                    });
                }
            });
            
            // Add to dropdowns
            Array.from(kecamatanSet).sort().forEach(kec => {
                kecamatanFilter.add(new Option(kec, kec));
            });
            
            Array.from(tahunSet).sort((a, b) => b - a).forEach(tahun => {
                tahunFilter.add(new Option(tahun, tahun));
            });
        }
        
        // Update overall statistics
        function updateOverallStats() {
            if (!petaData) return;
            
            const totalDesa = petaData.data.length;
            const totalPenerima = petaData.metadata.totalPenerima || 
                petaData.data.reduce((sum, item) => sum + (item.jumlahPenerima || 0), 0);
            
            const totalBantuan = petaData.summary ? 
                (petaData.summary.totalBantuanUang || 0) + 
                (petaData.summary.totalBantuanBarang || 0) + 
                (petaData.summary.totalBantuanJasa || 0) :
                petaData.data.reduce((sum, item) => sum + (item.totalBantuan || 0), 0);
            
            const rataBantuan = totalPenerima > 0 ? totalBantuan / totalPenerima : 0;
            
            document.getElementById('totalDesa').textContent = formatNumber(totalDesa);
            document.getElementById('totalPenerima').textContent = formatNumber(totalPenerima);
            document.getElementById('totalBantuan').textContent = 'Rp ' + formatNumber(totalBantuan);
            document.getElementById('rataBantuan').textContent = 'Rp ' + formatNumber(rataBantuan.toFixed(0));
        }
        
        // Update filtered statistics
        function updateFilteredStats() {
            if (!filteredData || filteredData.length === 0) return;
            
            const totalPenerima = filteredData.reduce((sum, item) => sum + (item.jumlahPenerima || 0), 0);
            const totalBantuan = filteredData.reduce((sum, item) => sum + (item.totalBantuan || 0), 0);
            const rataBantuan = totalPenerima > 0 ? totalBantuan / totalPenerima : 0;
            
            document.getElementById('totalDesa').textContent = formatNumber(filteredData.length);
            document.getElementById('totalPenerima').textContent = formatNumber(totalPenerima);
            document.getElementById('totalBantuan').textContent = 'Rp ' + formatNumber(totalBantuan);
            document.getElementById('rataBantuan').textContent = 'Rp ' + formatNumber(rataBantuan.toFixed(0));
        }
        
        // Update kecamatan list
        function updateKecamatanList() {
            if (!petaData) return;
            
            const kecamatanListEl = document.getElementById('kecamatanList');
            kecamatanListEl.innerHTML = '';
            
            // Group data by kecamatan
            const kecamatanData = {};
            
            filteredData.forEach(item => {
                if (!kecamatanData[item.kecamatan]) {
                    kecamatanData[item.kecamatan] = {
                        nama: item.kecamatan,
                        jumlahDesa: 0,
                        jumlahPenerima: 0,
                        totalBantuan: 0
                    };
                }
                
                kecamatanData[item.kecamatan].jumlahDesa++;
                kecamatanData[item.kecamatan].jumlahPenerima += item.jumlahPenerima || 0;
                kecamatanData[item.kecamatan].totalBantuan += item.totalBantuan || 0;
            });
            
            // Sort by jumlah penerima (descending)
            const sortedKecamatan = Object.values(kecamatanData).sort((a, b) => b.jumlahPenerima - a.jumlahPenerima);
            
            // Add to list
            sortedKecamatan.forEach(kec => {
                const itemEl = document.createElement('div');
                itemEl.className = 'kecamatan-item';
                itemEl.innerHTML = `
                    <div class="kecamatan-name">${kec.nama}</div>
                    <div class="kecamatan-count">${kec.jumlahPenerima} penerima</div>
                    <div class="small text-muted">${kec.jumlahDesa} desa</div>
                `;
                
                itemEl.addEventListener('click', function() {
                    document.getElementById('kecamatanFilter').value = kec.nama;
                    applyFilters();
                });
                
                kecamatanListEl.appendChild(itemEl);
            });
        }
        
        // Render map data
        function renderMapData() {
            updateMapDisplay();
            
            // Auto zoom if enabled
            if (document.getElementById('autoZoom').checked) {
                zoomToFilteredData();
            }
        }
        
        // Add markers to map
        function addMarkersToMap() {
            if (!filteredData || filteredData.length === 0) return;
            
            // Clear existing markers
            removeMarkersFromMap();
            
            // Check clustering option
            const useClustering = document.getElementById('clusterMarkers').checked;
            
            if (useClustering && !markerCluster) {
                markerCluster = L.markerClusterGroup({
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true
                });
            }
            
            // Add markers for each location
            filteredData.forEach(item => {
                if (!item.koordinat || !item.koordinat.lat || !item.koordinat.lng) {
                    console.warn('Koordinat tidak valid untuk:', item.desa);
                    return;
                }
                
                // Determine color based on intensity
                const color = getIntensityColor(item.jumlahPenerima || 0);
                
                // Create custom marker
                const icon = L.divIcon({
                    html: `
                        <div style="
                            background-color: ${color}; 
                            width: 24px; 
                            height: 24px; 
                            border-radius: 50%; 
                            border: 3px solid white; 
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 10px;
                        ">
                            ${Math.min(item.jumlahPenerima || 0, 99)}
                        </div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // Create marker
                const marker = L.marker([item.koordinat.lat, item.koordinat.lng], { 
                    icon: icon,
                    title: `${item.desa}, ${item.kecamatan}`
                });
                
                // Add popup
                marker.bindPopup(createPopupContent(item));
                
                // Add tooltip
                if (document.getElementById('showLabels').checked) {
                    marker.bindTooltip(`${item.desa} (${item.jumlahPenerima || 0})`, {
                        permanent: false,
                        direction: 'top'
                    });
                }
                
                // Add to map or cluster
                if (useClustering) {
                    markerCluster.addLayer(marker);
                } else {
                    marker.addTo(map);
                }
                
                markers.push(marker);
            });
            
            // Add cluster to map if using clustering
            if (useClustering && markerCluster) {
                map.addLayer(markerCluster);
            }
        }
        
        // Remove markers from map
        function removeMarkersFromMap() {
            markers.forEach(marker => {
                if (markerCluster && markerCluster.hasLayer(marker)) {
                    markerCluster.removeLayer(marker);
                } else {
                    map.removeLayer(marker);
                }
            });
            
            markers = [];
            
            if (markerCluster) {
                map.removeLayer(markerCluster);
                markerCluster.clearLayers();
            }
        }
        
        // Add heatmap to map
        function addHeatmapToMap() {
            if (!filteredData || filteredData.length === 0) return;
            
            // Remove existing heatmap
            removeHeatmapFromMap();
            
            // Prepare heatmap data
            const heatmapData = filteredData
                .filter(item => item.koordinat && item.koordinat.lat && item.koordinat.lng)
                .map(item => {
                    const intensity = Math.min(1, (item.jumlahPenerima || 0) / 100);
                    return [item.koordinat.lat, item.koordinat.lng, intensity];
                });
            
            // Create heatmap layer
            if (heatmapData.length > 0) {
                heatmapLayer = L.heatLayer(heatmapData, {
                    radius: 25,
                    blur: 20,
                    maxZoom: 16,
                    gradient: {
                        0.1: '#ffffcc',
                        0.3: '#a1dab4',
                        0.5: '#41b6c4',
                        0.8: '#225ea8'
                    }
                }).addTo(map);
            }
        }
        
        // Remove heatmap from map
        function removeHeatmapFromMap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
        }
        
        // Create popup content
        function createPopupContent(item) {
            const totalBantuan = (item.totalBantuanUang || 0) + (item.totalBantuanBarang || 0) + (item.totalBantuanJasa || 0);
            const rataBantuan = item.jumlahPenerima > 0 ? totalBantuan / item.jumlahPenerima : 0;
            
            let jenisBantuanHtml = '';
            if (item.jenisBantuan && item.jenisBantuan.length > 0) {
                item.jenisBantuan.forEach(jenis => {
                    jenisBantuanHtml += `<div class="popup-stat">
                        <span class="popup-stat-label">${jenis.jenis}:</span>
                        <span class="popup-stat-value">${jenis.jumlah} penerima</span>
                    </div>`;
                });
            }
            
            return `
                <div class="popup-content">
                    <div class="popup-title">${item.desa || 'Desa'}</div>
                    <div class="popup-subtitle">Kecamatan ${item.kecamatan || '-'}</div>
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Jumlah Penerima:</span>
                        <span class="popup-stat-value">${item.jumlahPenerima || 0}</span>
                    </div>
                    
                    ${jenisBantuanHtml}
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Total Bantuan:</span>
                        <span class="popup-stat-value">Rp ${formatNumber(totalBantuan)}</span>
                    </div>
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Rata-rata:</span>
                        <span class="popup-stat-value">Rp ${formatNumber(rataBantuan.toFixed(0))}</span>
                    </div>
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Uang:</span>
                        <span class="popup-stat-value">Rp ${formatNumber(item.totalBantuanUang || 0)}</span>
                    </div>
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Barang:</span>
                        <span class="popup-stat-value">${formatNumber(item.totalBantuanBarang || 0)} unit</span>
                    </div>
                    
                    <div class="popup-stat">
                        <span class="popup-stat-label">Jasa:</span>
                        <span class="popup-stat-value">${formatNumber(item.totalBantuanJasa || 0)} paket</span>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <button class="btn btn-sm btn-primary" onclick="window.zoomToDesa('${item.desa}', '${item.kecamatan}')">
                            <i class="fas fa-search-plus me-1"></i> Zoom
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="window.showDesaDetails('${item.desa}', '${item.kecamatan}')">
                            <i class="fas fa-info-circle me-1"></i> Detail
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Get intensity color
        function getIntensityColor(jumlahPenerima) {
            if (jumlahPenerima <= 10) return intensityColors.rendah;
            if (jumlahPenerima <= 30) return intensityColors.sedang;
            if (jumlahPenerima <= 60) return intensityColors.tinggi;
            return intensityColors.sangatTinggi;
        }
        
        // Apply filters
        function applyFilters() {
            if (!petaData) return;
            
            const kecamatan = document.getElementById('kecamatanFilter').value;
            const jenisBantuan = document.getElementById('jenisBantuanFilter').value;
            const tahun = document.getElementById('tahunFilter').value;
            
            // Apply filters
            filteredData = petaData.data.filter(item => {
                // Kecamatan filter
                if (kecamatan && item.kecamatan !== kecamatan) return false;
                
                // Jenis bantuan filter
                if (jenisBantuan) {
                    const hasJenis = item.jenisBantuan && 
                        item.jenisBantuan.some(j => j.jenis === jenisBantuan && j.jumlah > 0);
                    if (!hasJenis) return false;
                }
                
                // Tahun filter
                if (tahun) {
                    const hasTahun = item.tahunDistribusi && 
                        item.tahunDistribusi.some(t => t.tahun == tahun && t.jumlah > 0);
                    if (!hasTahun) return false;
                }
                
                return true;
            });
            
            // Update UI
            renderMapData();
            renderDataTable();
            updateFilteredStats();
            updateChart();
            updateKecamatanList();
            
            // Show notification
            const kecFilterText = kecamatan ? `Kec. ${kecamatan}` : 'Semua Kecamatan';
            const jenisFilterText = jenisBantuan ? `Jenis: ${jenisBantuan}` : 'Semua Jenis';
            showNotification(`Filter: ${kecFilterText}, ${jenisFilterText}. Ditemukan ${filteredData.length} desa.`, 'info');
        }
        
        // Zoom to filtered data
        function zoomToFilteredData() {
            if (!filteredData || filteredData.length === 0) return;
            
            // Calculate bounds
            const bounds = L.latLngBounds();
            
            filteredData.forEach(item => {
                if (item.koordinat && item.koordinat.lat && item.koordinat.lng) {
                    bounds.extend([item.koordinat.lat, item.koordinat.lng]);
                }
            });
            
            // Zoom to bounds if valid
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Render data table
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            if (!filteredData || filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-database fa-2x text-muted mb-3"></i>
                            <p class="mb-0">Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
                document.getElementById('tableInfo').textContent = 'Menampilkan 0 data';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Fill table
            pageData.forEach((item, index) => {
                const totalBantuan = (item.totalBantuanUang || 0) + (item.totalBantuanBarang || 0) + (item.totalBantuanJasa || 0);
                const rataBantuan = item.jumlahPenerima > 0 ? totalBantuan / item.jumlahPenerima : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td><strong>${item.desa || '-'}</strong></td>
                    <td>${item.kecamatan || '-'}</td>
                    <td class="text-center">${formatNumber(item.jumlahPenerima || 0)}</td>
                    <td>Rp ${formatNumber(item.totalBantuanUang || 0)}</td>
                    <td>${formatNumber(item.totalBantuanBarang || 0)}</td>
                    <td>${formatNumber(item.totalBantuanJasa || 0)}</td>
                    <td><strong>Rp ${formatNumber(totalBantuan)}</strong></td>
                    <td>Rp ${formatNumber(rataBantuan.toFixed(0))}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.zoomToDesa('${item.desa}', '${item.kecamatan}')">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                `;
                
                // Add click event to row
                row.addEventListener('click', function(e) {
                    if (!e.target.closest('button')) {
                        zoomToDesa(item.desa, item.kecamatan);
                    }
                });
                row.style.cursor = 'pointer';
                
                tableBody.appendChild(row);
            });
            
            // Update table info
            document.getElementById('tableInfo').textContent = 
                `Menampilkan ${startIndex + 1} - ${endIndex} dari ${filteredData.length} data`;
            
            // Update pagination
            updatePagination();
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationEl = document.getElementById('pagination');
            paginationEl.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const prevLi = document.createElement('li');
                prevLi.className = 'page-item';
                prevLi.innerHTML = `
                    <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                `;
                paginationEl.appendChild(prevLi);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                // Show only some pages
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    paginationEl.appendChild(pageLi);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    // Add ellipsis
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    paginationEl.appendChild(ellipsisLi);
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                const nextLi = document.createElement('li');
                nextLi.className = 'page-item';
                nextLi.innerHTML = `
                    <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                `;
                paginationEl.appendChild(nextLi);
            }
            
            // Add event listeners
            paginationEl.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page && page >= 1 && page <= totalPages) {
                        currentPage = page;
                        renderDataTable();
                        window.scrollTo({ top: document.getElementById('dataTable').offsetTop - 100, behavior: 'smooth' });
                    }
                });
            });
        }
        
        // Update chart
        function updateChart() {
            const ctx = document.getElementById('jenisBantuanChart').getContext('2d');
            
            // Destroy existing chart
            if (window.jenisBantuanChart) {
                window.jenisBantuanChart.destroy();
            }
            
            if (!filteredData || filteredData.length === 0) return;
            
            // Calculate totals
            let totalUang = 0, totalBarang = 0, totalJasa = 0;
            let countUang = 0, countBarang = 0, countJasa = 0;
            
            filteredData.forEach(item => {
                totalUang += item.totalBantuanUang || 0;
                totalBarang += item.totalBantuanBarang || 0;
                totalJasa += item.totalBantuanJasa || 0;
                
                // Count penerima per jenis
                if (item.jenisBantuan) {
                    item.jenisBantuan.forEach(jenis => {
                        if (jenis.jenis === 'Uang') countUang += jenis.jumlah || 0;
                        if (jenis.jenis === 'Barang') countBarang += jenis.jumlah || 0;
                        if (jenis.jenis === 'Jasa') countJasa += jenis.jumlah || 0;
                    });
                }
            });
            
            // Create chart
            window.jenisBantuanChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Uang', 'Barang', 'Jasa'],
                    datasets: [{
                        data: [countUang, countBarang, countJasa],
                        backgroundColor: ['#005f73', '#0a9396', '#ca6702'],
                        borderColor: ['#004d5c', '#088488', '#b85c02'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = countUang + countBarang + countJasa;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    let nilai = 0;
                                    if (label === 'Uang') nilai = totalUang;
                                    if (label === 'Barang') nilai = totalBarang;
                                    if (label === 'Jasa') nilai = totalJasa;
                                    
                                    return `${label}: ${value} penerima (${percentage}%) - Rp ${formatNumber(nilai)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Handle search
        function handleSearch() {
            const searchTerm = this.value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            if (!petaData || !petaData.data) return;
            
            // Search in data
            const results = petaData.data.filter(item => {
                const desaMatch = item.desa && item.desa.toLowerCase().includes(searchTerm);
                const kecamatanMatch = item.kecamatan && item.kecamatan.toLowerCase().includes(searchTerm);
                const combinedMatch = `${item.desa} ${item.kecamatan}`.toLowerCase().includes(searchTerm);
                
                return desaMatch || kecamatanMatch || combinedMatch;
            }).slice(0, 8); // Limit results
            
            // Display results
            if (results.length > 0) {
                let html = '<div class="list-group list-group-flush">';
                
                results.forEach(item => {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="searchResultClicked('${item.desa}', '${item.kecamatan}'); return false;">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${item.desa}</h6>
                                <small class="text-muted">${item.jumlahPenerima || 0}</small>
                            </div>
                            <small class="text-muted">Kec. ${item.kecamatan}</small>
                        </a>
                    `;
                });
                
                html += '</div>';
                searchResults.innerHTML = html;
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = `
                    <div class="alert alert-light mb-0">
                        <i class="fas fa-search me-2"></i>
                        Tidak ditemukan
                    </div>
                `;
                searchResults.style.display = 'block';
            }
        }
        
        // Handle search result click
        function searchResultClicked(desa, kecamatan) {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            // Set filter
            document.getElementById('kecamatanFilter').value = kecamatan;
            applyFilters();
            
            // Zoom to location
            zoomToDesa(desa, kecamatan);
        }
        
        // Zoom to specific desa
        function zoomToDesa(desa, kecamatan) {
            if (!petaData || !petaData.data) return;
            
            const item = petaData.data.find(d => d.desa === desa && d.kecamatan === kecamatan);
            
            if (item && item.koordinat) {
                map.setView([item.koordinat.lat, item.koordinat.lng], 14);
                
                // Open popup if marker exists
                const marker = markers.find(m => {
                    const latLng = m.getLatLng ? m.getLatLng() : null;
                    return latLng && 
                           Math.abs(latLng.lat - item.koordinat.lat) < 0.001 && 
                           Math.abs(latLng.lng - item.koordinat.lng) < 0.001;
                });
                
                if (marker) {
                    marker.openPopup();
                }
                
                showNotification(`Berpindah ke ${desa}, Kec. ${kecamatan}`, 'info');
            }
        }
        
        // Show desa details
        function showDesaDetails(desa, kecamatan) {
            if (!petaData || !petaData.data) return;
            
            const item = petaData.data.find(d => d.desa === desa && d.kecamatan === kecamatan);
            
            if (item) {
                const totalBantuan = (item.totalBantuanUang || 0) + (item.totalBantuanBarang || 0) + (item.totalBantuanJasa || 0);
                const rataBantuan = item.jumlahPenerima > 0 ? totalBantuan / item.jumlahPenerima : 0;
                
                let detailHtml = `
                    <h5>${item.desa}, ${item.kecamatan}</h5>
                    <p class="mb-3"><strong>${item.jumlahPenerima || 0}</strong> penerima bantuan</p>
                    
                    <table class="table table-sm">
                        <tr>
                            <th>Total Bantuan:</th>
                            <td class="text-end"><strong>Rp ${formatNumber(totalBantuan)}</strong></td>
                        </tr>
                        <tr>
                            <th>Rata-rata per Penerima:</th>
                            <td class="text-end">Rp ${formatNumber(rataBantuan.toFixed(0))}</td>
                        </tr>
                        <tr>
                            <th>Bantuan Uang:</th>
                            <td class="text-end">Rp ${formatNumber(item.totalBantuanUang || 0)}</td>
                        </tr>
                        <tr>
                            <th>Bantuan Barang:</th>
                            <td class="text-end">${formatNumber(item.totalBantuanBarang || 0)} unit</td>
                        </tr>
                        <tr>
                            <th>Bantuan Jasa:</th>
                            <td class="text-end">${formatNumber(item.totalBantuanJasa || 0)} paket</td>
                        </tr>
                    </table>
                `;
                
                // Show jenis bantuan
                if (item.jenisBantuan && item.jenisBantuan.length > 0) {
                    detailHtml += `<h6 class="mt-3">Distribusi Jenis Bantuan</h6>`;
                    item.jenisBantuan.forEach(jenis => {
                        detailHtml += `<div class="mb-1">${jenis.jenis}: ${jenis.jumlah} penerima</div>`;
                    });
                }
                
                // Show tahun distribusi
                if (item.tahunDistribusi && item.tahunDistribusi.length > 0) {
                    detailHtml += `<h6 class="mt-3">Distribusi per Tahun</h6>`;
                    item.tahunDistribusi.forEach(tahun => {
                        detailHtml += `<div class="mb-1">${tahun.tahun}: ${tahun.jumlah} penerima</div>`;
                    });
                }
                
                // Create modal or alert
                alert(detailHtml);
            }
        }
        
        // Show loading overlay
        function showLoading(show, message = 'Memuat data...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            if (show) {
                overlay.style.display = 'flex';
                messageEl.textContent = message;
            } else {
                overlay.style.display = 'none';
            }
        }
        
        // Update loading progress
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const title = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            
            // Set type
            notification.className = 'notification';
            notification.classList.add(type);
            
            // Set icon
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-exclamation-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            icon.innerHTML = `<i class="${iconClass} fa-2x"></i>`;
            
            // Set content
            title.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            messageEl.textContent = message;
            
            // Show notification
            notification.classList.add('show');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Format number with thousands separator
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }
        
        // Expose functions to global scope
        window.zoomToDesa = zoomToDesa;
        window.showDesaDetails = showDesaDetails;
        window.searchResultClicked = searchResultClicked;
        window.loadPetaData = loadPetaData;
        
        // Initial log
        console.log('Script peta statistik siap digunakan');
    </script>
</body>
</html>
