<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Statistik Bantuan Nelayan - Dinas Perikanan Situbondo</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ca6702;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-brand img {
            height: 40px;
        }
        
        .container-main {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .header-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--accent-color);
        }
        
        .map-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            background: white;
            height: 600px;
            margin-bottom: 25px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .stats-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            height: 100%;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 15px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 300px;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        
        .footer {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 20px 0;
            margin-top: 40px;
            color: #6c757d;
        }
        
        .alert-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            display: none;
        }
        
        .alert-custom.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,95,115,0.3);
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" alt="Logo">
                <span>Peta Statistik Bantuan Nelayan</span>
            </a>
            <div class="text-white">
                <div class="fw-bold">Dinas Peternakan dan Perikanan</div>
                <small>Kabupaten Situbondo</small>
            </div>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="container-main">
        <!-- Header -->
        <div class="header-card">
            <h2>Peta Distribusi Bantuan Nelayan Kabupaten Situbondo</h2>
            <p class="text-muted mb-4">Visualisasi data statistik per desa berdasarkan Sistem Bantuan Barang Pinjam Pakai</p>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="alert alert-info mb-0">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <strong><i class="fas fa-database me-2"></i> Sumber Data</strong>
                                <p class="mb-0 small">Data diambil dari file <code>datapeta.js</code> di repository GitHub</p>
                                <p class="mb-0 small">URL: <span id="dataSourceUrl" class="fw-bold">https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/main/datapeta.js</span></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button id="reloadDataBtn" class="btn-custom">
                                    <i class="fas fa-sync-alt me-2"></i> Reload Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-muted small">
                        <i class="fas fa-clock me-1"></i> 
                        Update: <span id="lastUpdateDate" class="fw-bold">-</span>
                    </div>
                    <div id="dataStatus" class="badge bg-warning">Menunggu data...</div>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Filter Kecamatan</label>
                    <select id="kecamatanFilter" class="form-select">
                        <option value="">Semua Kecamatan</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Filter Jenis Bantuan</label>
                    <select id="jenisBantuanFilter" class="form-select">
                        <option value="">Semua Jenis</option>
                        <option value="Uang">Uang</option>
                        <option value="Barang">Barang</option>
                        <option value="Jasa">Jasa</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Filter Tahun</label>
                    <select id="tahunFilter" class="form-select">
                        <option value="">Semua Tahun</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tampilan Peta</label>
                    <select id="viewMode" class="form-select">
                        <option value="markers">Marker Saja</option>
                        <option value="heatmap">Heatmap Saja</option>
                        <option value="both">Marker + Heatmap</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="clusterMarkers" checked>
                        <label class="form-check-label" for="clusterMarkers">Cluster Marker</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showLabels" checked>
                        <label class="form-check-label" for="showLabels">Tampilkan Label</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="autoZoom">
                        <label class="form-check-label" for="autoZoom">Auto Zoom ke Filter</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map and Stats -->
        <div class="row">
            <div class="col-lg-8 col-md-12 mb-4">
                <div class="map-wrapper">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                        <h5 class="mt-3">Memuat Data Peta</h5>
                        <p class="text-center" id="loadingMessage">Mengambil data dari GitHub...</p>
                        <div class="progress mt-3" style="width: 80%;">
                            <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Cari desa atau kecamatan...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="mt-2" style="display: none;"></div>
                    </div>
                    
                    <div id="map"></div>
                    
                    <div class="legend">
                        <h6><i class="fas fa-key me-2"></i> Legenda</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div style="width:20px;height:20px;background:#ffffcc;border:1px solid #ccc;border-radius:3px;margin-right:10px;"></div>
                            <span class="small">Rendah (1-10 penerima)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div style="width:20px;height:20px;background:#a1dab4;border:1px solid #8bc9a3;border-radius:3px;margin-right:10px;"></div>
                            <span class="small">Sedang (11-30)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div style="width:20px;height:20px;background:#41b6c4;border:1px solid #36a0ad;border-radius:3px;margin-right:10px;"></div>
                            <span class="small">Tinggi (31-60)</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div style="width:20px;height:20px;background:#225ea8;border:1px solid #1d4f8f;border-radius:3px;margin-right:10px;"></div>
                            <span class="small">Sangat Tinggi (61+)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="stats-panel">
                    <h5 class="mb-4"><i class="fas fa-chart-bar me-2"></i> Statistik Utama</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalDesa">0</div>
                                <div class="stat-label">Desa/Kelurahan</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalPenerima">0</div>
                                <div class="stat-label">Total Penerima</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalBantuan">Rp 0</div>
                                <div class="stat-label">Total Nilai Bantuan</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-value" id="rataBantuan">Rp 0</div>
                                <div class="stat-label">Rata-rata per Penerima</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i> Distribusi Jenis Bantuan</h6>
                        <div style="height: 200px;">
                            <canvas id="jenisBantuanChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3"><i class="fas fa-map me-2"></i> Top 5 Kecamatan</h6>
                        <div id="topKecamatanList"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="data-table">
            <h5 class="mb-4"><i class="fas fa-table me-2"></i> Data Detail per Desa</h5>
            
            <div class="table-responsive">
                <table class="table table-hover" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Desa/Kelurahan</th>
                            <th>Kecamatan</th>
                            <th>Jumlah Penerima</th>
                            <th>Uang (Rp)</th>
                            <th>Barang (Unit)</th>
                            <th>Jasa (Paket)</th>
                            <th>Total Bantuan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Memuat data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>Dinas Peternakan dan Perikanan Kabupaten Situbondo</h6>
                    <p class="mb-1">Bidang Pemberdayaan Nelayan</p>
                    <p class="mb-0">Jl. PB. Sudirman No. 99 Situbondo - Jawa Timur</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-1">
                        <a href="https://www.dinasperikanansitubondo.com" class="text-decoration-none" target="_blank">
                            <i class="fas fa-globe me-1"></i> www.dinasperikanansitubondo.com
                        </a>
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-phone me-1"></i> (0338) 671123
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center small">
                &copy; 2025 Peta Statistik Bantuan Nelayan - Sistem Informasi Geografis
            </div>
        </div>
    </div>
    
    <!-- Alert Notification -->
    <div class="alert alert-custom alert-dismissible fade" id="alertNotification" role="alert">
        <div class="d-flex">
            <div id="alertIcon" class="me-3">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div class="flex-grow-1">
                <h6 id="alertTitle" class="mb-1">Notifikasi</h6>
                <p id="alertMessage" class="mb-0"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    
    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    
    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Script -->
    <script>
        // ============ GLOBAL VARIABLES ============
        let map;
        let markers = [];
        let markerCluster;
        let heatmapLayer;
        let petaData = null;
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // ============ URL DATA PETA ============
        // GUNAKAN URL INI (sesuaikan dengan repo Anda)
        const DATA_PETA_URLS = [
            'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/main/datapeta.js',
            'https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/datapeta.js',
            './datapeta.js' // Fallback local
        ];
        
        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Peta Statistik Bantuan Nelayan - Initializing...');
            initMap();
            initEventListeners();
            loadPetaData(); // Auto load on startup
        });
        
        // ============ INIT MAP ============
        function initMap() {
            console.log('üó∫Ô∏è Initializing map...');
            map = L.map('map').setView([-7.7062, 113.9603], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            L.control.scale().addTo(map);
            console.log('‚úÖ Map initialized');
        }
        
        // ============ EVENT LISTENERS ============
        function initEventListeners() {
            // Reload button
            document.getElementById('reloadDataBtn').addEventListener('click', loadPetaData);
            
            // Filter events
            document.getElementById('kecamatanFilter').addEventListener('change', applyFilters);
            document.getElementById('jenisBantuanFilter').addEventListener('change', applyFilters);
            document.getElementById('tahunFilter').addEventListener('change', applyFilters);
            document.getElementById('viewMode').addEventListener('change', updateMapDisplay);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
            });
            
            // Checkboxes
            document.getElementById('clusterMarkers').addEventListener('change', updateMapDisplay);
            document.getElementById('showLabels').addEventListener('change', updateMapDisplay);
            
            console.log('‚úÖ Event listeners initialized');
        }
        
        // ============ LOAD DATA FUNCTION ============
        async function loadPetaData() {
            console.log('üì• Starting data load process...');
            showLoading(true, 'Mencari sumber data...');
            updateLoadingProgress(10);
            
            // Try multiple URLs
            for (let i = 0; i < DATA_PETA_URLS.length; i++) {
                const url = DATA_PETA_URLS[i];
                console.log(`üîç Trying URL ${i+1}: ${url}`);
                
                try {
                    const success = await tryLoadData(url);
                    if (success) {
                        console.log(`‚úÖ Data loaded successfully from URL ${i+1}`);
                        showAlert('Data berhasil dimuat!', 'success');
                        return; // Exit if successful
                    }
                } catch (error) {
                    console.warn(`‚ùå Failed with URL ${i+1}:`, error.message);
                }
            }
            
            // If all URLs fail
            console.error('‚ùå All data sources failed');
            showAlert('Gagal memuat data. Periksa koneksi internet atau URL data.', 'error');
            showLoading(false);
        }
        
        // ============ TRY LOAD DATA FROM URL ============
        async function tryLoadData(url) {
            return new Promise((resolve, reject) => {
                console.log(`üîó Fetching from: ${url}`);
                showLoading(true, `Mengambil data dari: ${url}`);
                updateLoadingProgress(30);
                
                // Add timestamp to prevent caching
                const fetchUrl = url + '?t=' + Date.now();
                
                fetch(fetchUrl)
                    .then(response => {
                        updateLoadingProgress(50);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return response.text();
                    })
                    .then(text => {
                        updateLoadingProgress(70);
                        console.log(`üìÑ Response received (${text.length} chars)`);
                        
                        // Parse the JavaScript file
                        parseDataPetaJS(text);
                        updateLoadingProgress(100);
                        
                        setTimeout(() => {
                            showLoading(false);
                            resolve(true);
                        }, 500);
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        reject(error);
                    });
            });
        }
        
        // ============ PARSE DATA PETA JS ============
        function parseDataPetaJS(scriptText) {
            console.log('üîß Parsing data...');
            
            try {
                // Method 1: Extract JSON from variable assignment
                const jsonMatch = scriptText.match(/window\.DATA_PETA_STATISTIK\s*=\s*({[\s\S]*?});/);
                
                if (jsonMatch && jsonMatch[1]) {
                    console.log('üìä Found JSON data in script');
                    petaData = JSON.parse(jsonMatch[1]);
                } 
                // Method 2: Try to execute the script
                else {
                    console.log('‚ö° Trying to execute script...');
                    
                    // Create a temporary function to capture the data
                    const tempFunc = new Function(`
                        let DATA_PETA_STATISTIK = null;
                        ${scriptText}
                        return DATA_PETA_STATISTIK;
                    `);
                    
                    petaData = tempFunc();
                    
                    if (!petaData) {
                        throw new Error('Data tidak ditemukan dalam script');
                    }
                }
                
                console.log('‚úÖ Data parsed successfully:', petaData);
                processData();
                
            } catch (error) {
                console.error('‚ùå Parse error:', error);
                showAlert(`Error parsing data: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ============ PROCESS DATA ============
        function processData() {
            if (!petaData || !petaData.data) {
                showAlert('Data peta kosong atau tidak valid', 'error');
                return;
            }
            
            console.log(`üìä Processing ${petaData.data.length} data items...`);
            
            // Set initial filtered data
            filteredData = [...petaData.data];
            
            // Update UI
            updateDataInfo();
            updateFilterDropdowns();
            updateStats();
            updateChart();
            renderMap();
            renderTable();
            updateTopKecamatan();
            
            // Update status
            document.getElementById('dataStatus').className = 'badge bg-success';
            document.getElementById('dataStatus').textContent = 'Data dimuat';
            
            console.log('‚úÖ Data processing complete');
        }
        
        // ============ UPDATE DATA INFO ============
        function updateDataInfo() {
            const lastUpdate = petaData.metadata?.lastUpdate || 
                              petaData.metadata?.generatedAt || 
                              new Date().toLocaleDateString('id-ID');
            
            document.getElementById('lastUpdateDate').textContent = lastUpdate;
            document.getElementById('dataSourceUrl').textContent = DATA_PETA_URLS[0];
        }
        
        // ============ UPDATE FILTER DROPDOWNS ============
        function updateFilterDropdowns() {
            const kecamatanFilter = document.getElementById('kecamatanFilter');
            const tahunFilter = document.getElementById('tahunFilter');
            
            // Clear and add default options
            kecamatanFilter.innerHTML = '<option value="">Semua Kecamatan</option>';
            tahunFilter.innerHTML = '<option value="">Semua Tahun</option>';
            
            // Collect unique values
            const kecamatanSet = new Set();
            const tahunSet = new Set();
            
            petaData.data.forEach(item => {
                if (item.kecamatan) kecamatanSet.add(item.kecamatan);
                
                if (item.tahunDistribusi) {
                    item.tahunDistribusi.forEach(t => {
                        if (t.tahun) tahunSet.add(t.tahun);
                    });
                }
            });
            
            // Add to dropdowns
            Array.from(kecamatanSet).sort().forEach(kec => {
                kecamatanFilter.add(new Option(kec, kec));
            });
            
            Array.from(tahunSet).sort((a, b) => b - a).forEach(tahun => {
                tahunFilter.add(new Option(tahun, tahun));
            });
        }
        
        // ============ UPDATE STATS ============
        function updateStats() {
            if (!petaData) return;
            
            const totalDesa = filteredData.length;
            const totalPenerima = filteredData.reduce((sum, item) => sum + (item.jumlahPenerima || 0), 0);
            const totalBantuan = filteredData.reduce((sum, item) => sum + (item.totalBantuan || 0), 0);
            const rataBantuan = totalPenerima > 0 ? (totalBantuan / totalPenerima).toFixed(0) : 0;
            
            document.getElementById('totalDesa').textContent = formatNumber(totalDesa);
            document.getElementById('totalPenerima').textContent = formatNumber(totalPenerima);
            document.getElementById('totalBantuan').textContent = 'Rp ' + formatNumber(totalBantuan);
            document.getElementById('rataBantuan').textContent = 'Rp ' + formatNumber(rataBantuan);
        }
        
        // ============ UPDATE CHART ============
        function updateChart() {
            const ctx = document.getElementById('jenisBantuanChart').getContext('2d');
            
            // Destroy old chart
            if (window.jenisBantuanChart) {
                window.jenisBantuanChart.destroy();
            }
            
            if (!filteredData.length) return;
            
            // Calculate totals
            let uang = 0, barang = 0, jasa = 0;
            
            filteredData.forEach(item => {
                uang += item.statistik?.uang?.jumlah || 0;
                barang += item.statistik?.barang?.jumlah || 0;
                jasa += item.statistik?.jasa?.jumlah || 0;
            });
            
            // Create chart
            window.jenisBantuanChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Uang', 'Barang', 'Jasa'],
                    datasets: [{
                        data: [uang, barang, jasa],
                        backgroundColor: ['#005f73', '#0a9396', '#ca6702'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // ============ UPDATE TOP KECAMATAN ============
        function updateTopKecamatan() {
            if (!petaData) return;
            
            // Group by kecamatan
            const kecamatanData = {};
            
            filteredData.forEach(item => {
                if (!kecamatanData[item.kecamatan]) {
                    kecamatanData[item.kecamatan] = {
                        nama: item.kecamatan,
                        jumlah: 0
                    };
                }
                kecamatanData[item.kecamatan].jumlah += item.jumlahPenerima || 0;
            });
            
            // Sort and get top 5
            const topKecamatan = Object.values(kecamatanData)
                .sort((a, b) => b.jumlah - a.jumlah)
                .slice(0, 5);
            
            // Render list
            const listEl = document.getElementById('topKecamatanList');
            listEl.innerHTML = '';
            
            topKecamatan.forEach((kec, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border-bottom';
                itemEl.innerHTML = `
                    <div>
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        <span>${kec.nama}</span>
                    </div>
                    <span class="badge bg-secondary">${formatNumber(kec.jumlah)} penerima</span>
                `;
                listEl.appendChild(itemEl);
            });
        }
        
        // ============ RENDER MAP ============
        function renderMap() {
            // Clear existing layers
            if (markerCluster) {
                map.removeLayer(markerCluster);
                markerCluster = null;
            }
            
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Get view mode
            const viewMode = document.getElementById('viewMode').value;
            const useClustering = document.getElementById('clusterMarkers').checked;
            
            // Create marker cluster if needed
            if (useClustering) {
                markerCluster = L.markerClusterGroup();
            }
            
            // Add markers
            filteredData.forEach(item => {
                if (!item.koordinat || !item.koordinat.lat || !item.koordinat.lng) {
                    return;
                }
                
                // Determine color based on intensity
                const color = getIntensityColor(item.jumlahPenerima || 0);
                
                // Create icon
                const icon = L.divIcon({
                    html: `
                        <div style="
                            background: ${color};
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 10px;
                        ">
                            ${Math.min(item.jumlahPenerima || 0, 99)}
                        </div>
                    `,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });
                
                // Create marker
                const marker = L.marker([item.koordinat.lat, item.koordinat.lng], { icon });
                
                // Add popup
                marker.bindPopup(createPopupContent(item));
                
                // Add tooltip
                if (document.getElementById('showLabels').checked) {
                    marker.bindTooltip(`${item.desa} (${item.jumlahPenerima || 0})`, {
                        direction: 'top',
                        permanent: false
                    });
                }
                
                // Add to map or cluster
                if (viewMode === 'markers' || viewMode === 'both') {
                    if (useClustering) {
                        markerCluster.addLayer(marker);
                    } else {
                        marker.addTo(map);
                    }
                }
                
                markers.push(marker);
            });
            
            // Add cluster to map
            if (useClustering && markerCluster && (viewMode === 'markers' || viewMode === 'both')) {
                map.addLayer(markerCluster);
            }
            
            // Add heatmap
            if (viewMode === 'heatmap' || viewMode === 'both') {
                const heatmapData = filteredData
                    .filter(item => item.koordinat)
                    .map(item => [item.koordinat.lat, item.koordinat.lng, Math.min(1, (item.jumlahPenerima || 0) / 100)]);
                
                if (heatmapData.length > 0) {
                    heatmapLayer = L.heatLayer(heatmapData, {
                        radius: 25,
                        blur: 20,
                        maxZoom: 16,
                        gradient: {
                            0.1: '#ffffcc',
                            0.3: '#a1dab4',
                            0.5: '#41b6c4',
                            0.8: '#225ea8'
                        }
                    }).addTo(map);
                }
            }
            
            // Auto zoom if enabled
            if (document.getElementById('autoZoom').checked) {
                zoomToBounds();
            }
        }
        
        // ============ UPDATE MAP DISPLAY ============
        function updateMapDisplay() {
            if (petaData) {
                renderMap();
            }
        }
        
        // ============ APPLY FILTERS ============
        function applyFilters() {
            if (!petaData) return;
            
            const kecamatan = document.getElementById('kecamatanFilter').value;
            const jenis = document.getElementById('jenisBantuanFilter').value;
            const tahun = document.getElementById('tahunFilter').value;
            
            // Apply filters
            filteredData = petaData.data.filter(item => {
                // Kecamatan filter
                if (kecamatan && item.kecamatan !== kecamatan) return false;
                
                // Jenis bantuan filter
                if (jenis) {
                    const hasJenis = item.jenisBantuan?.some(j => j.jenis === jenis && j.jumlah > 0);
                    if (!hasJenis) return false;
                }
                
                // Tahun filter
                if (tahun) {
                    const hasTahun = item.tahunDistribusi?.some(t => t.tahun == tahun && t.jumlah > 0);
                    if (!hasTahun) return false;
                }
                
                return true;
            });
            
            // Update UI
            updateStats();
            updateChart();
            updateTopKecamatan();
            renderMap();
            renderTable();
            
            // Show notification
            const filterText = [
                kecamatan ? `Kec. ${kecamatan}` : null,
                jenis ? `Jenis: ${jenis}` : null,
                tahun ? `Tahun: ${tahun}` : null
            ].filter(Boolean).join(', ');
            
            showAlert(`Filter diterapkan: ${filterText || 'Semua'}. Ditemukan ${filteredData.length} desa.`, 'info');
        }
        
        // ============ RENDER TABLE ============
        function renderTable() {
            const tableBody = document.getElementById('dataTableBody');
            
            if (!filteredData.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-database fa-2x text-muted mb-3"></i>
                            <p>Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
                document.getElementById('tableInfo').textContent = 'Menampilkan 0 data';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Fill table
            let html = '';
            pageData.forEach((item, index) => {
                const totalBantuan = (item.totalBantuanUang || 0) + (item.totalBantuanBarang || 0) + (item.totalBantuanJasa || 0);
                
                html += `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td><strong>${item.desa}</strong></td>
                        <td>${item.kecamatan}</td>
                        <td class="text-center">${formatNumber(item.jumlahPenerima || 0)}</td>
                        <td>Rp ${formatNumber(item.totalBantuanUang || 0)}</td>
                        <td>${formatNumber(item.totalBantuanBarang || 0)}</td>
                        <td>${formatNumber(item.totalBantuanJasa || 0)}</td>
                        <td><strong>Rp ${formatNumber(totalBantuan)}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="zoomToDesa('${item.desa}', '${item.kecamatan}')">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('tableInfo').textContent = 
                `Menampilkan ${startIndex + 1} - ${endIndex} dari ${filteredData.length} data`;
            
            updatePagination();
        }
        
        // ============ UPDATE PAGINATION ============
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationEl = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            if (currentPage > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a>
                </li>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a>
                </li>`;
            }
            
            paginationEl.innerHTML = html;
            
            // Add event listeners
            paginationEl.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page && page >= 1 && page <= totalPages) {
                        currentPage = page;
                        renderTable();
                    }
                });
            });
        }
        
        // ============ SEARCH FUNCTION ============
        function handleSearch() {
            const term = this.value.toLowerCase().trim();
            const resultsEl = document.getElementById('searchResults');
            
            if (term.length < 2) {
                resultsEl.style.display = 'none';
                return;
            }
            
            if (!petaData) return;
            
            const results = petaData.data.filter(item => {
                const desaMatch = item.desa?.toLowerCase().includes(term);
                const kecMatch = item.kecamatan?.toLowerCase().includes(term);
                return desaMatch || kecMatch;
            }).slice(0, 5);
            
            if (results.length) {
                let html = '<div class="list-group">';
                results.forEach(item => {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="searchResultClicked('${item.desa}', '${item.kecamatan}'); return false;">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${item.desa}</h6>
                                <small>${item.jumlahPenerima || 0} penerima</small>
                            </div>
                            <small class="text-muted">Kec. ${item.kecamatan}</small>
                        </a>
                    `;
                });
                html += '</div>';
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } else {
                resultsEl.innerHTML = '<div class="text-muted p-2">Tidak ditemukan</div>';
                resultsEl.style.display = 'block';
            }
        }
        
        // ============ HELPER FUNCTIONS ============
        function createPopupContent(item) {
            const totalBantuan = (item.totalBantuanUang || 0) + (item.totalBantuanBarang || 0) + (item.totalBantuanJasa || 0);
            const rataBantuan = item.jumlahPenerima > 0 ? (totalBantuan / item.jumlahPenerima).toFixed(0) : 0;
            
            return `
                <div style="min-width: 250px;">
                    <h6 style="margin: 0 0 5px 0; color: #005f73;">${item.desa}</h6>
                    <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">Kec. ${item.kecamatan}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
                        <div><strong>Penerima:</strong></div>
                        <div>${item.jumlahPenerima || 0}</div>
                        
                        <div><strong>Total Bantuan:</strong></div>
                        <div>Rp ${formatNumber(totalBantuan)}</div>
                        
                        <div><strong>Rata-rata:</strong></div>
                        <div>Rp ${formatNumber(rataBantuan)}</div>
                        
                        <div><strong>Uang:</strong></div>
                        <div>Rp ${formatNumber(item.totalBantuanUang || 0)}</div>
                        
                        <div><strong>Barang:</strong></div>
                        <div>${formatNumber(item.totalBantuanBarang || 0)} unit</div>
                        
                        <div><strong>Jasa:</strong></div>
                        <div>${formatNumber(item.totalBantuanJasa || 0)} paket</div>
                    </div>
                    
                    <div style="margin-top: 10px; text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="zoomToDesa('${item.desa}', '${item.kecamatan}')">
                            <i class="fas fa-search-plus"></i> Zoom
                        </button>
                    </div>
                </div>
            `;
        }
        
        function getIntensityColor(jumlah) {
            if (jumlah <= 10) return '#ffffcc';
            if (jumlah <= 30) return '#a1dab4';
            if (jumlah <= 60) return '#41b6c4';
            return '#225ea8';
        }
        
        function zoomToDesa(desa, kecamatan) {
            const item = filteredData.find(d => d.desa === desa && d.kecamatan === kecamatan);
            if (item && item.koordinat) {
                map.setView([item.koordinat.lat, item.koordinat.lng], 14);
                showAlert(`Berpindah ke ${desa}, ${kecamatan}`, 'info');
            }
        }
        
        function zoomToBounds() {
            if (!filteredData.length) return;
            
            const bounds = L.latLngBounds();
            filteredData.forEach(item => {
                if (item.koordinat) {
                    bounds.extend([item.koordinat.lat, item.koordinat.lng]);
                }
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function searchResultClicked(desa, kecamatan) {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            zoomToDesa(desa, kecamatan);
        }
        
        function showLoading(show, message = 'Memuat data...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            if (show) {
                overlay.style.display = 'flex';
                messageEl.textContent = message;
            } else {
                overlay.style.display = 'none';
            }
        }
        
        function updateLoadingProgress(percent) {
            const bar = document.getElementById('loadingProgress');
            if (bar) {
                bar.style.width = percent + '%';
                bar.textContent = percent + '%';
            }
        }
        
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alertNotification');
            const title = document.getElementById('alertTitle');
            const msg = document.getElementById('alertMessage');
            const icon = document.getElementById('alertIcon');
            
            // Set type
            alert.className = `alert alert-custom alert-${type} show`;
            
            // Set icon
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-exclamation-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            icon.innerHTML = `<i class="${iconClass} fa-2x"></i>`;
            
            // Set content
            title.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            msg.textContent = message;
            
            // Show and auto-hide
            alert.classList.add('show');
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }
        
        // ============ EXPOSE FUNCTIONS TO GLOBAL SCOPE ============
        window.zoomToDesa = zoomToDesa;
        window.searchResultClicked = searchResultClicked;
        window.loadPetaData = loadPetaData;
        
        console.log('‚úÖ Script initialized successfully');
    </script>
</body>
</html>
