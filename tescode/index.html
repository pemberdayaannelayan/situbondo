<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SIMATA - SISTEM PEMETAAN NELAYAN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="reload.js" onerror="console.log('File reload.js belum tersedia di server, menggunakan database lokal.')"></script>

    <style>
        /* [Semua CSS yang sudah ada tetap sama, tidak dihapus] */
        /* Hanya menambahkan style untuk fitur verifikasi */
        
        /* STYLE UNTUK FITUR VERIFIKASI */
        .verifikasi-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            background: white;
            border-left: 5px solid #27ae60;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            display: none;
            animation: slideInLeft 0.5s;
        }
        
        .verifikasi-notification.error {
            border-left: 5px solid #e74c3c;
        }
        
        .verifikasi-card {
            border: 2px solid #0c2461;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(12, 36, 97, 0.2);
        }
        
        .verifikasi-header {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #f6b93b;
        }
        
        .verifikasi-result {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e6f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background: #f8f9fa;
        }
        
        .verifikasi-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4a69bd;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .verifikasi-item.valid {
            border-left: 4px solid #27ae60;
        }
        
        .verifikasi-item.invalid {
            border-left: 4px solid #e74c3c;
        }
        
        .verifikasi-qr-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #0c2461;
        }
        
        /* Style untuk tab verifikasi */
        .tab-verifikasi-content {
            padding: 20px;
        }
        
        /* FAB untuk verifikasi cepat */
        .fab-verifikasi {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
            position: fixed;
            bottom: 100px;
            right: 30px;
            z-index: 999;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fab-verifikasi:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.6);
        }
        
        /* Responsive untuk fitur verifikasi */
        @media (max-width: 991.98px) {
            .verifikasi-notification {
                top: 70px;
                right: 10px;
                max-width: 300px;
            }
            
            .fab-verifikasi {
                bottom: 90px;
                right: 20px;
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .verifikasi-qr-container {
                width: 100px;
                height: 100px;
            }
        }
        
        @media (max-width: 575.98px) {
            .verifikasi-notification {
                max-width: 280px;
                padding: 12px;
            }
            
            .fab-verifikasi {
                bottom: 80px;
                right: 15px;
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
        
        /* Animasi untuk verifikasi */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Style untuk input verifikasi cepat */
        .quick-verifikasi-input {
            border-radius: 25px;
            border: 2px solid #0c2461;
            padding: 10px 20px;
            font-size: 1rem;
        }
        
        .quick-verifikasi-input:focus {
            box-shadow: 0 0 0 3px rgba(12, 36, 97, 0.2);
            border-color: #4a69bd;
        }
    </style>
</head>
<body>

    <div id="qr-code-generator">
        <div id="qr-right"></div> 
    </div>

    <!-- Notification untuk verifikasi -->
    <div class="verifikasi-notification" id="verifikasiNotification">
        <div class="d-flex align-items-start">
            <div class="me-3 text-success"><i class="fas fa-check-circle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-success mb-1" id="verifikasiNotificationTitle">Verifikasi Berhasil!</h6>
                <p class="small text-muted mb-2" id="verifikasiNotificationMessage">Data ditemukan dan valid.</p>
                <button class="btn btn-sm btn-outline-success" onclick="document.getElementById('verifikasiNotification').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMATA" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-eye fa-4x\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMATA</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode keamanan untuk mengakses sistem.</p>
                        <p class="small text-primary fw-bold mb-2" id="currentDateDisplay"></p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" placeholder="Masukkan kode keamanan" required>
                            <button type="button" class="input-group-text bg-light border-0 password-toggle-btn" id="passwordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="passwordHint">Kode Keamanan Berubah Setiap Hari</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notifikasi Login Berhasil - TELAH DIPERBAIKI UKURANNYA -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Akses Diotorisasi</h4>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMATA</h5>
                    
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Sistem ini menggunakan teknologi keamanan dinamis untuk melindungi data sensitif
                    </p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Verifikasi Cepat -->
    <div class="modal fade" id="quickVerifikasiModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content verifikasi-card">
                <div class="verifikasi-header">
                    <i class="fas fa-search fa-3x mb-3 text-warning pulse-animation"></i>
                    <h4 class="fw-bold mb-0">Verifikasi Data Cepat</h4>
                    <p class="mb-0 opacity-75">Masukkan NIK atau Kode Validasi</p>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <input type="text" class="form-control form-control-lg quick-verifikasi-input text-center" 
                               id="quickVerifikasiInput" placeholder="Contoh: 3510110101010001 atau VLD-XXXXXX">
                        <small class="text-muted mt-2 d-block text-center">Tekan Enter untuk memverifikasi</small>
                    </div>
                    
                    <div id="quickVerifikasiResult" style="display: none;">
                        <!-- Hasil verifikasi akan ditampilkan di sini -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary px-5 fw-bold shadow" id="btnQuickVerifikasi">
                            <i class="fas fa-search me-2"></i>VERIFIKASI SEKARANG
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>TUTUP
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-filter-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <!-- FAB untuk verifikasi cepat -->
    <button class="fab-verifikasi" id="fabVerifikasi" title="Verifikasi Cepat">
        <i class="fas fa-search"></i>
    </button>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku2.png" alt="Logo SIMATA" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle" id="dynamicSubtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="app-origin" id="appOrigin">App System Bidang Pemberdayaan Nelayan</div>
                <div class="position-absolute top-0 end-0 p-3 d-none d-md-block">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill">
                        <i class="fas fa-circle text-success me-2 small"></i>Online v5.3 (Verifikasi Feature)
                    </span>
                </div>
            </div>
            
            <div class="row g-0 flex-grow-1">
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-3 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important; padding-left: 15px;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter"></i> Filter & Validasi</button>
                        <!-- MENU BARU: VERIFIKASI -->
                        <button class="nav-link" id="v-pills-verifikasi-tab" data-bs-toggle="pill" data-bs-target="#v-pills-verifikasi" type="button"><i class="fas fa-check-circle"></i> Verifikasi Data</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-3 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <!-- Konten dashboard tetap sama -->
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-3 dashboard-row">
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100 text-white" style="background: var(--primary-gradient);">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="small fw-bold text-uppercase opacity-75">Total</span>
                                                    <i class="fas fa-users opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold mb-0" id="totalPenerima">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Penuh Waktu</span>
                                                    <i class="fas fa-user-tie text-primary opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPenuhWaktu">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Kapal</span>
                                                    <i class="fas fa-ship text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Avg Usia</span>
                                                    <i class="fas fa-user-clock text-secondary opacity-25 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="rataUsia">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- TAMBAHAN FITUR RINGKASAN EKSEKUTIF -->
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Sambilan Utama</span>
                                                    <i class="fas fa-user-clock text-warning opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanUtama">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Sambilan Tambahan</span>
                                                    <i class="fas fa-user-clock text-success opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanTambahan">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">ABK</span>
                                                    <i class="fas fa-users text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalABK">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4 g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- FITUR PETA BARU -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-map-marked-alt me-2 text-primary"></i> Peta Sebaran Nelayan Kabupaten Situbondo
                                                </div>
                                                <div class="map-tabs">
                                                    <div class="map-tab active" onclick="switchMapView('all')">Semua Data</div>
                                                    <div class="map-tab" onclick="switchMapView('profesi')">Berdasarkan Profesi</div>
                                                    <div class="map-tab" onclick="switchMapView('kecamatan')">Berdasarkan Kecamatan</div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="map-statistics">
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-points">0</div>
                                                        <div class="stat-label">Total Titik</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-kecamatan">0</div>
                                                        <div class="stat-label">Kecamatan</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-desa">0</div>
                                                        <div class="stat-label">Desa</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-kapal">0</div>
                                                        <div class="stat-label">Pemilik Kapal</div>
                                                    </div>
                                                </div>
                                                <div id="map-container">
                                                    <div id="map"></div>
                                                    <div class="map-controls">
                                                        <button class="btn btn-sm btn-primary w-100 mb-2" onclick="resetMapView()">
                                                            <i class="fas fa-sync-alt me-1"></i> Reset Peta
                                                        </button>
                                                        <button class="btn btn-sm btn-info w-100 mb-2" onclick="zoomToAllMarkers()">
                                                            <i class="fas fa-search-location me-1"></i> Zoom Semua
                                                        </button>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="showCluster" checked onchange="toggleCluster()">
                                                            <label class="form-check-label small" for="showCluster">Grup Marker</label>
                                                        </div>
                                                    </div>
                                                    <div class="map-legend">
                                                        <h6 class="fw-bold mb-2">Legenda</h6>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #0c2461;"></div>
                                                            <span>Nelayan Penuh Waktu</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #e58e26;"></div>
                                                            <span>Nelayan Sambilan Utama</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #27ae60;"></div>
                                                            <span>Nelayan Sambilan Tambahan</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #0984e3;"></div>
                                                            <span>Pemilik Kapal</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #a55eea;"></div>
                                                            <span>Anak Buah Kapal</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TAB VERIFIKASI BARU -->
                            <div class="tab-pane fade" id="v-pills-verifikasi">
                                <div class="tab-verifikasi-content">
                                    <h3 class="section-title"><i class="fas fa-check-circle me-2"></i>Verifikasi Data Nelayan</h3>
                                    
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-header bg-white py-3">
                                            <h6 class="mb-0 fw-bold"><i class="fas fa-search me-2 text-primary"></i>Cari Data Nelayan untuk Verifikasi</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <label for="verifikasiInput" class="form-label">Masukkan NIK atau Kode Validasi</label>
                                                    <input type="text" class="form-control" id="verifikasiInput" placeholder="Contoh: 3510110101010001 atau VLD-XXXXXX">
                                                    <small class="text-muted mt-2">Anda dapat memasukkan NIK (16 digit) atau Kode Validasi (VLD-XXXXXX)</small>
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-primary w-100" id="btnVerifikasi">
                                                        <i class="fas fa-search me-2"></i>Verifikasi Sekarang
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-4">
                                                <div class="col-md-6">
                                                    <div class="card h-100 border-primary">
                                                        <div class="card-header bg-primary text-white">
                                                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Panduan Verifikasi</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <ul class="mb-0">
                                                                <li>Masukkan <strong>NIK 16 digit</strong> untuk verifikasi berdasarkan identitas</li>
                                                                <li>Masukkan <strong>Kode Validasi (VLD-XXXXXX)</strong> untuk verifikasi berdasarkan kode unik</li>
                                                                <li>Hasil verifikasi akan menampilkan data lengkap nelayan</li>
                                                                <li>Data yang valid dapat dicetak ID Card langsung</li>
                                                                <li>Sistem akan mencatat setiap proses verifikasi</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card h-100 border-success">
                                                        <div class="card-header bg-success text-white">
                                                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Statistik Verifikasi</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="text-center">
                                                                <h2 class="fw-bold text-success" id="totalVerifikasi">0</h2>
                                                                <p class="text-muted mb-0">Total Data Terverifikasi</p>
                                                            </div>
                                                            <div class="mt-3">
                                                                <div class="d-flex justify-content-between mb-1">
                                                                    <span>Verifikasi Berhasil</span>
                                                                    <span id="verifikasiBerhasil">0</span>
                                                                </div>
                                                                <div class="progress mb-3">
                                                                    <div class="progress-bar bg-success" id="progressBerhasil" style="width: 0%"></div>
                                                                </div>
                                                                
                                                                <div class="d-flex justify-content-between mb-1">
                                                                    <span>Verifikasi Gagal</span>
                                                                    <span id="verifikasiGagal">0</span>
                                                                </div>
                                                                <div class="progress">
                                                                    <div class="progress-bar bg-danger" id="progressGagal" style="width: 0%"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2 text-primary"></i>Hasil Verifikasi</h6>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="clearVerifikasiHistory()">
                                                <i class="fas fa-trash me-1"></i>Hapus Riwayat
                                            </button>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="verifikasi-result" id="verifikasiResult">
                                                <div class="text-center py-5 text-muted">
                                                    <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                                                    <p>Belum ada hasil verifikasi.<br>Masukkan NIK atau Kode Validasi di atas untuk memulai verifikasi.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab lainnya tetap sama (Input Data, Data Nelayan, dll) -->
                            <div class="tab-pane fade" id="v-pills-input">
                                <!-- Konten input data tetap sama -->
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <div class="alert alert-info small mb-4 border-0 bg-light-info text-primary"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Semua kolom WAJIB DIISI kecuali Keterangan, Usaha Sampingan, dan Link Drive.</div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan) <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <!-- [Konten form lainnya tetap sama] -->
                                            
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab lainnya tetap sama -->
                            <div class="tab-pane fade" id="v-pills-data">
                                <!-- Konten data nelayan tetap sama -->
                            </div>

                            <div class="tab-pane fade" id="v-pills-filter">
                                 <!-- Konten filter tetap sama -->
                            </div>

                            <div class="tab-pane fade" id="v-pills-print">
                                <!-- Konten cetak laporan tetap sama -->
                            </div>

                            <div class="tab-pane fade" id="v-pills-export">
                                <!-- Konten ekspor data tetap sama -->
                            </div>

                            <div class="tab-pane fade" id="v-pills-backup">
                                <!-- Konten backup & restore tetap sama -->
                            </div>

                            <div class="tab-pane fade" id="v-pills-settings">
                                <!-- Konten pengaturan tetap sama -->
                            </div>

                        </div>
                        
                        <footer class="main-footer">
                            <div class="container">
                                <h5 class="footer-brand">SISTEM PEMETAAN DATA NELAYAN</h5>
                                <div class="footer-text">
                                    &copy; 2025 Bidang Pemberdayaan Nelayan <span class="footer-divider">|</span> Dinas Perikanan Kabupaten Situbondo
                                </div>
                                <div class="footer-links">
                                    <a href="#" style="pointer-events: none;">
                                        <i class="fas fa-phone-alt me-1"></i> Contact Center: 0878-6561-4222
                                    </a>
                                    <span class="footer-divider">|</span>
                                    <a href="mailto:info@dinasperikanansitubondo.com">
                                        <i class="fas fa-envelope me-1"></i> info@dinasperikanansitubondo.com
                                    </a>
                                    <span class="footer-divider">|</span>
                                    <a href="#verifikasi" id="footerVerifikasiLink">
                                        <i class="fas fa-check-circle me-1"></i> Verifikasi Data
                                    </a>
                                </div>
                            </div>
                        </footer>

                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal detail tetap sama -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <!-- Konten modal detail tetap sama -->
        </div>

        <!-- Modal verifikasi detail -->
        <div class="modal fade" id="verifikasiDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content verifikasi-card">
                    <div class="verifikasi-header">
                        <i class="fas fa-id-card fa-3x mb-3 text-warning"></i>
                        <h4 class="fw-bold mb-0">Hasil Verifikasi Lengkap</h4>
                        <p class="mb-0 opacity-75">Data Nelayan Terverifikasi</p>
                    </div>
                    <div class="modal-body">
                        <div id="verifikasiDetailContent">
                            <!-- Konten detail verifikasi akan diisi oleh JavaScript -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Tutup
                        </button>
                        <button type="button" class="btn btn-primary" id="btnCetakIDVerifikasi">
                            <i class="fas fa-print me-2"></i>Cetak ID Card
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAB Menu tetap sama -->
        <div class="fab-container" id="fabMenu">
            <!-- Konten FAB tetap sama -->
        </div>
        
        <!-- Toast notification tetap sama -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <!-- Konten toast tetap sama -->
        </div>
    </div>

    <!-- Loading untuk ID Card tetap sama -->
    <div class="idcard-loading" id="idcardLoading">
        <!-- Konten loading tetap sama -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        // ================================
        // FITUR VERIFIKASI BARU
        // ================================
        
        // Variabel untuk fitur verifikasi
        let verifikasiHistory = JSON.parse(localStorage.getItem('simata_verifikasi_history') || '[]');
        let verifikasiStats = JSON.parse(localStorage.getItem('simata_verifikasi_stats') || '{"berhasil":0, "gagal":0}');
        let currentVerifikasiData = null;
        const quickVerifikasiModal = new bootstrap.Modal(document.getElementById('quickVerifikasiModal'));
        const verifikasiDetailModal = new bootstrap.Modal(document.getElementById('verifikasiDetailModal'));
        
        /**
         * Fungsi untuk melakukan verifikasi data
         */
        function verifikasiData(input) {
            if (!input || input.trim() === '') {
                showVerifikasiNotification('Masukkan NIK atau Kode Validasi!', false);
                return null;
            }
            
            const searchTerm = input.trim();
            let result = null;
            
            // Cari berdasarkan NIK (16 digit)
            if (searchTerm.length === 16 && /^\d+$/.test(searchTerm)) {
                result = appData.find(item => item.nik === searchTerm);
            }
            
            // Cari berdasarkan Kode Validasi (VLD-XXXXXX)
            if (!result && searchTerm.startsWith('VLD-')) {
                result = appData.find(item => item.kodeValidasi === searchTerm);
            }
            
            // Cari berdasarkan NIK parsial (jika tidak ditemukan dengan metode di atas)
            if (!result) {
                result = appData.find(item => item.nik.includes(searchTerm) || 
                                              item.kodeValidasi.includes(searchTerm) ||
                                              item.nama.toLowerCase().includes(searchTerm.toLowerCase()));
            }
            
            // Simpan riwayat verifikasi
            const verifikasiRecord = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                input: searchTerm,
                found: !!result,
                data: result ? {
                    id: result.id,
                    nama: result.nama,
                    nik: result.nik,
                    profesi: result.profesi
                } : null
            };
            
            verifikasiHistory.unshift(verifikasiRecord);
            if (verifikasiHistory.length > 50) verifikasiHistory = verifikasiHistory.slice(0, 50);
            
            // Update statistik
            if (result) {
                verifikasiStats.berhasil++;
                showVerifikasiNotification(`Data ditemukan: ${result.nama}`, true);
            } else {
                verifikasiStats.gagal++;
                showVerifikasiNotification('Data tidak ditemukan!', false);
            }
            
            // Simpan ke localStorage
            localStorage.setItem('simata_verifikasi_history', JSON.stringify(verifikasiHistory));
            localStorage.setItem('simata_verifikasi_stats', JSON.stringify(verifikasiStats));
            
            // Update tampilan
            updateVerifikasiStats();
            displayVerifikasiResult(result, searchTerm);
            
            return result;
        }
        
        /**
         * Tampilkan notifikasi verifikasi
         */
        function showVerifikasiNotification(message, isSuccess) {
            const notification = document.getElementById('verifikasiNotification');
            const title = document.getElementById('verifikasiNotificationTitle');
            const msg = document.getElementById('verifikasiNotificationMessage');
            const icon = notification.querySelector('.fa-2x');
            
            if (isSuccess) {
                notification.classList.remove('error');
                title.textContent = 'Verifikasi Berhasil!';
                title.className = 'fw-bold text-success mb-1';
                icon.className = 'fas fa-check-circle fa-2x text-success';
            } else {
                notification.classList.add('error');
                title.textContent = 'Verifikasi Gagal!';
                title.className = 'fw-bold text-danger mb-1';
                icon.className = 'fas fa-times-circle fa-2x text-danger';
            }
            
            msg.textContent = message;
            notification.style.display = 'block';
            
            // Auto hide setelah 5 detik
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        /**
         * Update statistik verifikasi
         */
        function updateVerifikasiStats() {
            document.getElementById('totalVerifikasi').textContent = verifikasiHistory.length;
            document.getElementById('verifikasiBerhasil').textContent = verifikasiStats.berhasil;
            document.getElementById('verifikasiGagal').textContent = verifikasiStats.gagal;
            
            const total = verifikasiStats.berhasil + verifikasiStats.gagal;
            if (total > 0) {
                const berhasilPercent = (verifikasiStats.berhasil / total) * 100;
                const gagalPercent = (verifikasiStats.gagal / total) * 100;
                
                document.getElementById('progressBerhasil').style.width = berhasilPercent + '%';
                document.getElementById('progressGagal').style.width = gagalPercent + '%';
            }
        }
        
        /**
         * Tampilkan hasil verifikasi
         */
        function displayVerifikasiResult(data, searchTerm) {
            const resultContainer = document.getElementById('verifikasiResult');
            
            if (!data) {
                resultContainer.innerHTML = `
                    <div class="verifikasi-item invalid">
                        <div class="d-flex align-items-start">
                            <div class="me-3 text-danger">
                                <i class="fas fa-times-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold text-danger mb-1">Data Tidak Ditemukan</h6>
                                <p class="mb-1">Input: <code>${searchTerm}</code></p>
                                <p class="small text-muted mb-0">Waktu: ${new Date().toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                    </div>
                ` + (resultContainer.children.length > 0 ? resultContainer.innerHTML : '');
                return;
            }
            
            // Generate QR Code untuk data yang ditemukan
            const qrContainerId = 'qr-verifikasi-' + Date.now();
            const qrData = JSON.stringify({
                id: data.id,
                nik: data.nik,
                nama: data.nama,
                timestamp: new Date().toISOString(),
                source: 'SIMATA Verifikasi'
            });
            
            const resultHTML = `
                <div class="verifikasi-item valid">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-success">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold text-success mb-1">Data Ditemukan & Valid</h6>
                                    <p class="mb-1">Input: <code>${searchTerm}</code></p>
                                    <h5 class="fw-bold mt-2">${data.nama}</h5>
                                    <p class="mb-1"><strong>NIK:</strong> ${data.nik}</p>
                                    <p class="mb-1"><strong>Profesi:</strong> ${data.profesi}</p>
                                    <p class="mb-1"><strong>Status:</strong> ${data.status}</p>
                                    <p class="mb-1"><strong>Domisili:</strong> ${data.desa}, ${data.kecamatan}</p>
                                    <p class="small text-muted mb-0">Waktu: ${new Date().toLocaleString('id-ID')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="verifikasi-qr-container" id="${qrContainerId}"></div>
                            <div class="text-center">
                                <button class="btn btn-sm btn-success w-100 mb-2" onclick="showVerifikasiDetail('${data.id}')">
                                    <i class="fas fa-eye me-1"></i> Detail Lengkap
                                </button>
                                <button class="btn btn-sm btn-primary w-100" onclick="safeGenerateIDCard('${data.id}')">
                                    <i class="fas fa-id-card me-1"></i> Cetak ID Card
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultContainer.innerHTML = resultHTML + (resultContainer.children.length > 0 ? resultContainer.innerHTML : '');
            
            // Generate QR Code
            setTimeout(() => {
                const qrContainer = document.getElementById(qrContainerId);
                if (qrContainer && typeof QRCode !== 'undefined') {
                    new QRCode(qrContainer, {
                        text: qrData,
                        width: 100,
                        height: 100,
                        colorDark: "#0c2461",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            }, 100);
        }
        
        /**
         * Tampilkan detail verifikasi
         */
        function showVerifikasiDetail(id) {
            const data = appData.find(item => item.id == id);
            if (!data) return;
            
            currentVerifikasiData = data;
            
            const detailContent = document.getElementById('verifikasiDetailContent');
            detailContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">IDENTITAS PRIBADI</h6>
                        <table class="table table-sm">
                            <tr><th width="40%">Nama Lengkap</th><td>${data.nama}</td></tr>
                            <tr><th>NIK</th><td>${data.nik}</td></tr>
                            <tr><th>Usia</th><td>${data.usia} Tahun (${data.tahunLahir})</td></tr>
                            <tr><th>Domisili</th><td>${data.desa}, ${data.kecamatan}</td></tr>
                            <tr><th>Kontak</th><td>${data.whatsapp}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">PROFESI & KEPEMILIKAN</h6>
                        <table class="table table-sm">
                            <tr><th width="40%">Profesi</th><td>${data.profesi}</td></tr>
                            <tr><th>Status</th><td>${data.status}</td></tr>
                            <tr><th>Alat Tangkap</th><td>${data.alatTangkap}</td></tr>
                            <tr><th>Jenis Ikan</th><td>${data.jenisIkan}</td></tr>
                            <tr><th>Usaha Sampingan</th><td>${data.usahaSampingan || '-'}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${data.status === 'Pemilik Kapal' ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">DATA KAPAL</h6>
                        <table class="table table-sm">
                            <tr><th width="40%">Nama Kapal</th><td>${data.namaKapal}</td></tr>
                            <tr><th>Jenis Kapal</th><td>${data.jenisKapal}</td></tr>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">INFORMASI VALIDASI</h6>
                        <table class="table table-sm">
                            <tr><th width="40%">Tanggal Validasi</th><td>${data.tanggalValidasi}</td></tr>
                            <tr><th>Petugas Validator</th><td>${data.validator}</td></tr>
                            <tr><th>Kode Validasi</th><td><code>${data.kodeValidasi}</code></td></tr>
                            <tr><th>Link Dokumen</th><td>${data.driveLink ? `<a href="${data.driveLink}" target="_blank">${data.driveLink}</a>` : '-'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Data ini telah terverifikasi dalam sistem SIMATA. Untuk keperluan resmi, cetak ID Card menggunakan tombol di bawah.
                </div>
            `;
            
            verifikasiDetailModal.show();
        }
        
        /**
         * Hapus riwayat verifikasi
         */
        function clearVerifikasiHistory() {
            if (confirm('Apakah Anda yakin ingin menghapus semua riwayat verifikasi?')) {
                verifikasiHistory = [];
                localStorage.setItem('simata_verifikasi_history', JSON.stringify(verifikasiHistory));
                document.getElementById('verifikasiResult').innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                        <p>Belum ada hasil verifikasi.<br>Masukkan NIK atau Kode Validasi di atas untuk memulai verifikasi.</p>
                    </div>
                `;
                showNotification('Riwayat verifikasi berhasil dihapus', 'success');
            }
        }
        
        /**
         * Tampilkan riwayat verifikasi
         */
        function loadVerifikasiHistory() {
            const resultContainer = document.getElementById('verifikasiResult');
            
            if (verifikasiHistory.length === 0) {
                resultContainer.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                        <p>Belum ada hasil verifikasi.<br>Masukkan NIK atau Kode Validasi di atas untuk memulai verifikasi.</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            verifikasiHistory.forEach(record => {
                if (record.found && record.data) {
                    historyHTML += `
                        <div class="verifikasi-item valid">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold text-success mb-1">${record.data.nama}</h6>
                                    <p class="mb-1">NIK: ${record.data.nik}</p>
                                    <p class="small text-muted mb-0">${new Date(record.timestamp).toLocaleString('id-ID')} | Input: ${record.input}</p>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="showVerifikasiDetail('${record.data.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    historyHTML += `
                        <div class="verifikasi-item invalid">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-danger">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold text-danger mb-1">Data Tidak Ditemukan</h6>
                                    <p class="mb-1">Input: ${record.input}</p>
                                    <p class="small text-muted mb-0">${new Date(record.timestamp).toLocaleString('id-ID')}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            resultContainer.innerHTML = historyHTML;
        }
        
        /**
         * Handle hash change untuk verifikasi
         */
        function handleHashChange() {
            if (window.location.hash === '#verifikasi') {
                // Jika sudah login, buka tab verifikasi
                if (document.getElementById('appContent').style.display === 'block') {
                    document.getElementById('v-pills-verifikasi-tab').click();
                } else {
                    // Simpan hash untuk setelah login
                    sessionStorage.setItem('hash_redirect', '#verifikasi');
                }
            }
        }
        
        // ================================
        // KODE IDCARD.JS YANG DIGABUNGKAN - TETAP SAMA
        // ================================
        /* [Kode ID Card tetap sama, tidak diubah] */
        
        // ================================
        // KODE UTAMA APLIKASI DENGAN PENAMBAHAN FITUR VERIFIKASI
        // ================================
        
        // --- DATA CONSTANTS ---
        const SITUBONDO_DATA = {
            "Arjasa": [
                "Arjasa", "Bayeman", "Curah Tatal", "Jatisari", "Kayumas", "Kedungdowo", "Ketowan", "Lamongan"
            ],
            "Asembagus": [
                "Asembagus", "Awar-awar", "Bantal", "Gudang", "Kedunglo", "Kertosari", "Mojosari", "Parante", "Trigonco", "Wringin Anom"
            ],
            "Banyuglugur": [
                "Banyuglugur", "Kalianget", "Kalisari", "Lubawang", "Selobanteng", "Telempong", "Tepos"
            ],
            "Banyuputih": [
                "Banyuputih", "Sumberanyar", "Sumberejo", "Sumberwaru", "Wonorejo"
            ],
            "Besuki": [
                "Besuki", "Blimbing", "Bloro", "Demung", "Jetis", "Kalimas", "Langkap", "Pesisir", "Sumberejo", "Widoropayung"
            ],
            "Bungatan": [
                "Bletok", "Bungatan", "Mlandingan Wetan", "Pasir Putih", "Patemon", "Selowogo", "Sumbertengah"
            ],
            "Jangkar": [
                "Agel", "Curah Kalak", "Gadingan", "Jangkar", "Kumbangsari", "Palangan", "Pesanggrahan", "Sopet"
            ],
            "Jatibanteng": [
                "Curahsuri", "Jatibanteng", "Kembangsari", "Pategalan", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"
            ],
            "Kapongan": [
                "Curah Cottok Gebangan", "Kandang", "Kapongan", "Kesambi Rampak", "Landangan", "Peleyan", "Pokaan", "Seletreng", "Wonokoyo"
            ],
            "Kendit": [
                "Balung", "Bugeman", "Kendit", "Klatakan", "Kukusan", "Rajekwesi", "Tambak Ukir"
            ],
            "Mangaran": [
                "Mangaran", "Semiring", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Trebungan"
            ],
            "Mlandingan": [
                "Alas Bayur", "Campoan", "Mlandingan Kulon", "Selomukti", "Sumberanyar", "Sumber Pinang", "Trebungan"
            ],
            "Panarukan": [
                "Alasmalang", "Duwet", "Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"
            ],
            "Panji": [
                "Ardirejo", "Mimbaan",
                "Battal", "Curah Jeru", "Juglangan", "Kayu Putih", "Klampokan", "Panji Kidul", "Panji Lor", "Sliwung", "Tenggir", "Tokelan"
            ],
            "Situbondo": [
                "Dawuhan", "Patokan",
                "Kalibagor", "Kotakan", "Olean", "Talkandang"
            ],
            "Suboh": [
                "Buduan", "Cemara", "Dawuan", "Gunung Malang", "Gunung Putri", "Ketah", "Mojodungkol", "Suboh"
            ],
            "Sumbermalang": [
                "Alastengah", "Baderan", "Kalirejo", "Plalangan", "Sumberargo", "Taman", "Tamankursi", "Tamansari", "Tlogosari"
            ]
        };
        
        /* [Kode lainnya tetap sama, tidak diubah] */
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                setupEventListeners();
                initFishOptions();
                
                displayCurrentDate();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalValidasi').value = today;
                
                const isSessionActive = sessionStorage.getItem('simata_session') === 'active';
                if (isSessionActive) {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                    setTimeout(() => {
                        initializeMap();
                    }, 500);
                    
                    // Load riwayat verifikasi
                    loadVerifikasiHistory();
                    updateVerifikasiStats();
                    
                    // Cek hash untuk verifikasi
                    handleHashChange();
                } else {
                    setTimeout(() => {
                        document.getElementById('loginModal').style.display = 'flex';
                    }, 100);
                    
                    // Cek hash untuk redirect setelah login
                    if (window.location.hash === '#verifikasi') {
                        sessionStorage.setItem('hash_redirect', '#verifikasi');
                    }
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                alert("Terjadi kesalahan sistem saat memuat. Silakan refresh.");
            }
        });

        // --- EVENT LISTENERS DENGAN PENAMBAHAN FITUR VERIFIKASI ---
        function setupEventListeners() {
            /* [Event listeners yang sudah ada tetap sama] */
            
            // Event listener untuk hash change
            window.addEventListener('hashchange', handleHashChange);
            
            // Event listener untuk footer verifikasi link
            document.getElementById('footerVerifikasiLink').addEventListener('click', function(e) {
                e.preventDefault();
                if (document.getElementById('appContent').style.display === 'block') {
                    document.getElementById('v-pills-verifikasi-tab').click();
                } else {
                    window.location.hash = '#verifikasi';
                    sessionStorage.setItem('hash_redirect', '#verifikasi');
                }
            });
            
            // Event listener untuk FAB verifikasi
            document.getElementById('fabVerifikasi').addEventListener('click', function() {
                quickVerifikasiModal.show();
            });
            
            // Event listener untuk tombol verifikasi di tab verifikasi
            document.getElementById('btnVerifikasi').addEventListener('click', function() {
                const input = document.getElementById('verifikasiInput').value.trim();
                const result = verifikasiData(input);
                if (result) {
                    document.getElementById('verifikasiInput').value = '';
                }
            });
            
            // Event listener untuk input verifikasi (enter key)
            document.getElementById('verifikasiInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('btnVerifikasi').click();
                }
            });
            
            // Event listener untuk verifikasi cepat modal
            document.getElementById('btnQuickVerifikasi').addEventListener('click', function() {
                const input = document.getElementById('quickVerifikasiInput').value.trim();
                const result = verifikasiData(input);
                if (result) {
                    document.getElementById('quickVerifikasiInput').value = '';
                    quickVerifikasiModal.hide();
                    
                    // Buka tab verifikasi untuk melihat detail
                    setTimeout(() => {
                        document.getElementById('v-pills-verifikasi-tab').click();
                    }, 500);
                }
            });
            
            // Event listener untuk input verifikasi cepat (enter key)
            document.getElementById('quickVerifikasiInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('btnQuickVerifikasi').click();
                }
            });
            
            // Event listener untuk tombol cetak ID dari modal verifikasi detail
            document.getElementById('btnCetakIDVerifikasi').addEventListener('click', function() {
                if (currentVerifikasiData) {
                    safeGenerateIDCard(currentVerifikasiData.id);
                    verifikasiDetailModal.hide();
                }
            });
            
            /* [Event listeners lainnya tetap sama] */
        }
        
        // --- MODIFIKASI SETELAH LOGIN UNTUK HANDLE VERIFIKASI ---
        // Di dalam event listener login, tambahkan:
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('loginButton');
            const spinner = document.getElementById('loginSpinner');
            const inputCode = document.getElementById('securityCode').value;
            const correctCode = generateSecurityCode();
            
            if (inputCode !== correctCode) {
                showNotification('Kode keamanan salah! Periksa kembali atau hubungi administrator.', 'error');
                return;
            }
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            btn.innerHTML = 'MEMBUKA SISTEM... <span class="spinner-border spinner-border-sm ms-2"></span>';
            
            setTimeout(() => {
                sessionStorage.setItem('simata_session', 'active');

                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                
                initializeCharts();
                updateDashboard();
                renderDataTable();
                setTimeout(() => {
                    initializeMap();
                }, 500);
                
                // Load riwayat verifikasi setelah login
                loadVerifikasiHistory();
                updateVerifikasiStats();
                
                // Cek hash redirect untuk verifikasi
                if (sessionStorage.getItem('hash_redirect') === '#verifikasi') {
                    document.getElementById('v-pills-verifikasi-tab').click();
                    sessionStorage.removeItem('hash_redirect');
                    window.location.hash = '#verifikasi';
                }
                
                loginSuccessModal.show();
                
                btn.disabled = false;
                spinner.classList.add('d-none');
                btn.innerHTML = 'BUKA DASHBOARD';
            }, 1200);
        });
        
        // --- FUNGSI TAMBAHAN UNTUK VERIFIKASI ---
        
        /**
         * Generate QR Code untuk verifikasi
         */
        function generateVerificationQR(data) {
            const qrData = JSON.stringify({
                system: "SIMATA",
                type: "verification",
                id: data.id,
                nik: data.nik,
                name: data.nama,
                profession: data.profesi,
                timestamp: new Date().toISOString(),
                validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 hari
            });
            
            return qrData;
        }
        
        /**
         * Export riwayat verifikasi
         */
        function exportVerifikasiHistory() {
            if (verifikasiHistory.length === 0) {
                showNotification('Tidak ada riwayat verifikasi untuk diekspor', 'warning');
                return;
            }
            
            const dataToExport = verifikasiHistory.map(record => ({
                Tanggal: new Date(record.timestamp).toLocaleString('id-ID'),
                Input: record.input,
                Status: record.found ? 'Ditemukan' : 'Tidak Ditemukan',
                'Nama Nelayan': record.found ? record.data.nama : '-',
                NIK: record.found ? record.data.nik : '-',
                Profesi: record.found ? record.data.profesi : '-'
            }));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataToExport), "Riwayat Verifikasi");
            XLSX.writeFile(wb, `Riwayat_Verifikasi_SIMATA_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showNotification('Riwayat verifikasi berhasil diekspor', 'success');
        }
        
        /**
         * Reset statistik verifikasi
         */
        function resetVerifikasiStats() {
            if (confirm('Apakah Anda yakin ingin mereset statistik verifikasi?')) {
                verifikasiStats = {berhasil: 0, gagal: 0};
                localStorage.setItem('simata_verifikasi_stats', JSON.stringify(verifikasiStats));
                updateVerifikasiStats();
                showNotification('Statistik verifikasi berhasil direset', 'success');
            }
        }
        
        /* [Fungsi-fungsi lainnya tetap sama, tidak diubah] */
        
        // Di akhir script, tambahkan inisialisasi untuk fitur verifikasi:
        // Update tampilan saat pertama kali load
        setTimeout(() => {
            if (document.getElementById('appContent').style.display === 'block') {
                loadVerifikasiHistory();
                updateVerifikasiStats();
            }
        }, 1000);
        
    </script>
</body>
</html>
