<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETA STATISTIK DATA NELAYAN - KAB. SITUBONDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlzGd6K-6l0r0Z8X9Q3Q3Q3Q3Q3Q3Q3Q&libraries=places,visualization"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Google Maps Layer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-google/1.0.3/leaflet-google.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    
    <style>
        :root {
            /* Palette: Blue, Green, Gold */
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ca6702;
            --dark-blue: #001219;
            --light-bg: #f0f4f8;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            --gradient-header: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            --gradient-secondary: linear-gradient(135deg, #0a9396, #94d2bd);
            --gradient-accent: linear-gradient(135deg, #ca6702, #ee9b00);
            
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.15);
            --glass-effect: rgba(255, 255, 255, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Header */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #ee9b00;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .app-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: #ffecd1;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
            padding-top: 10px;
        }
        
        /* Navigation Bar - NAVBAR ATAS */
        .top-navbar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-bottom: 3px solid #ee9b00;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        
        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .nav-pills-horizontal {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 0;
        }
        
        .nav-pills-horizontal .nav-link {
            border-radius: 0;
            padding: 18px 25px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
        }
        
        .nav-pills-horizontal .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
        }
        
        .nav-pills-horizontal .nav-link.active {
            background-color: rgba(255,255,255,0.15);
            border-bottom: 3px solid #ee9b00;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .nav-pills-horizontal .nav-link.logout {
            margin-left: auto;
            border-left: 1px solid rgba(255,255,255,0.2);
        }

        /* Content Styling */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid #ee9b00;
            padding-left: 15px;
            margin: 25px 0;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 1.6rem;
            position: relative;
            background: linear-gradient(to right, rgba(238, 155, 0, 0.1), transparent);
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            padding: 10px 20px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 95, 115, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #001219 0%, #004d40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 95, 115, 0.4);
        }
        
        /* Tables */
        .data-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: none;
            white-space: nowrap;
        }
        
        .data-table th {
            background: linear-gradient(90deg, #005f73, #0a9396) !important;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
        }
        
        .data-table td {
            border-bottom: 1px solid #e9ecef;
            padding: 12px 10px;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: #e0f2f1;
        }
        
        /* Cards & Stats */
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-sm);
            background: white;
        }
        
        .card-header {
            background: linear-gradient(90deg, #005f73, #001219);
            color: white;
            font-weight: 600;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        
        .stats-box {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border-left: 5px solid var(--accent-color);
            transition: transform 0.3s;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Login Modal - DISESUAIKAN TANPA PASSWORD */
        .login-header {
            background: var(--gradient-header);
            border-bottom: 4px solid #ee9b00;
            padding-bottom: 20px;
            padding-top: 20px;
        }
        
        .btn-login {
            background: linear-gradient(90deg, #005f73, #0a9396, #ee9b00);
            background-size: 200% auto;
            transition: 0.5s;
        }
        
        .btn-login:hover {
            background-position: right center;
        }

        /* Footer */
        .copyright {
            background-color: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }
        
        .feature-icon {
            width: 25px;
            text-align: center;
        }

        /* Utils */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1050; min-width: 280px; }
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.8; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-weight: 300; letter-spacing: 1px;}
        
        /* Floating Button */
        .floating-action-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1045;
            transition: all 0.4s;
            font-size: 1.4rem;
            border: none;
            box-shadow: 0 5px 15px rgba(202, 103, 2, 0.4);
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            background: #ee9b00;
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.4);
        }

        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1050; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; box-shadow: var(--shadow-lg); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        /* Map Styling - DIPERBAIKI UNTUK FULL PAGE */
        .full-page-map #map {
            height: calc(100vh - 180px);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            z-index: 1;
            position: relative;
        }
        
        .tab-pane#v-pills-map {
            padding: 0 !important;
        }
        
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            max-width: 450px;
            min-width: 400px;
        }
        
        /* Map Controls - PENATAAN ULANG POSISI TANPA TUMPANG TINDIH */
        .map-legend {
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            position: absolute;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            max-width: 240px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .map-legend:hover {
            background: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            max-width: 250px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .map-controls:hover {
            background: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .cluster-marker {
            background: var(--primary-color);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.3);
        }
        
        /* Panel Header dengan tombol close */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 95, 115, 0.1);
        }
        
        .panel-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--primary-color);
            margin: 0;
        }
        
        .panel-close-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .panel-close-btn:hover {
            background-color: #f8f9fa;
            color: #dc3545;
        }
        
        /* Heatmap Layer Controls - DIPINDAHKAN POSISI */
        .heatmap-controls {
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            position: absolute;
            top: 250px;
            right: 20px;
            z-index: 1000;
            max-width: 220px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .heatmap-controls:hover {
            background: white;
        }
        
        /* Data Summary Panel - DIPINDAHKAN POSISI */
        .data-summary-panel {
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            position: absolute;
            top: 80px;
            left: 20px;
            z-index: 1000;
            max-width: 240px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .data-summary-panel:hover {
            background: white;
        }
        
        /* Map Loading Overlay */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            border-radius: 10px;
        }
        
        /* Search Box - DIPERBAIKI POSISI */
        .search-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 450px;
            max-width: 90%;
            background: rgba(255, 255, 255, 0.98);
            padding: 8px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .search-box .input-group {
            border-radius: 50px;
            overflow: hidden;
        }
        
        .search-box input {
            border: none;
            padding: 12px 20px;
        }
        
        .search-box .btn {
            border-radius: 0 50px 50px 0;
        }
        
        /* Marker Cluster Customization */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.8);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.8);
        }

        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.8);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.8);
        }

        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.8);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.8);
        }
        
        /* Responsive Adjustments */
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; }
            .app-title { font-size: 1.3rem; line-height: 1.3; }
            .app-logo { font-size: 2.5rem; margin-bottom: 10px; }
            .app-header { padding: 70px 15px 30px 15px; }
            .col-md-9.col-lg-10.p-5 { padding: 1.5rem !important; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .floating-action-btn { bottom: 20px; right: 20px; }
            .full-page-map #map { height: calc(100vh - 220px); }
            
            /* Mobile navbar */
            .nav-pills-horizontal {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-pills-horizontal .nav-link {
                padding: 12px 15px;
                font-size: 0.85rem;
            }
            
            /* Mobile map controls stacking */
            .search-box {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                width: 100%;
                margin-bottom: 10px;
                border-radius: 10px;
            }
            
            .map-controls, .map-legend, .heatmap-controls, .data-summary-panel { 
                position: relative; 
                top: auto; 
                bottom: auto; 
                right: auto; 
                left: auto;
                margin-bottom: 15px; 
                max-width: 100%; 
                background: white;
                display: block !important;
            }
            
            .data-summary-panel {
                margin-top: 10px;
            }
            
            /* Floating controls button for mobile */
            .mobile-map-controls-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 1000;
                background: white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                cursor: pointer;
                transition: all 0.3s;
                border: 1px solid #ddd;
            }
        }

        /* Logo */
        .logo-garuda {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        /* Welcome Modal */
        .welcome-modal {
            background: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            color: white;
        }
        
        .welcome-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ee9b00;
        }
        
        .welcome-modal .btn-welcome {
            background: linear-gradient(90deg, #ee9b00, #ca6702);
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .welcome-modal .btn-welcome:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.3);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        /* Map Marker Animation - DESAIN PROFESIONAL */
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Simplified Login Modal */
        .auto-login-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ee9b00;
        }
        
        .auto-login-modal .modal-body {
            padding: 40px;
        }
        
        /* Control buttons for map */
        .map-control-button {
            position: absolute;
            z-index: 1000;
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #ddd;
        }
        
        .map-control-button:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }
        
        /* Fullscreen map toggle */
        .fullscreen-map #map {
            height: calc(100vh - 60px);
            border-radius: 0;
        }
        
        .fullscreen-map .app-container {
            max-width: 100%;
            border-radius: 0;
            margin: 0;
        }
        
        .fullscreen-map .col-md-9.col-lg-10 {
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
            padding: 0 !important;
        }
        
        .fullscreen-map .card-body {
            padding: 0 !important;
        }
        
        /* Transparent controls when not hovering */
        .map-controls-transparent {
            opacity: 0.8;
        }
        
        .map-controls-transparent:hover {
            opacity: 1;
        }
        
        /* NEW: GPS MARKER DESIGN DENGAN PULSE EFFECT DAN ICON GPS */
        .gps-marker {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }
        
        .gps-marker-icon {
            width: 50px;
            height: 50px;
            position: relative;
            z-index: 1002;
        }
        
        .gps-marker-body {
            width: 42px;
            height: 42px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 4px;
            top: 4px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            border: 2px solid white;
        }
        
        .gps-marker-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 14px;
            z-index: 1004;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        /* GPS Icon Styling */
        .gps-icon {
            font-size: 20px;
            color: white;
        }
        
        /* Pulse effect */
        .gps-marker-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            z-index: 1001;
            opacity: 0;
            transform: scale(0.5);
            animation: gpsPulse 2s infinite;
        }
        
        @keyframes gpsPulse {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }
            70% {
                transform: scale(1.5);
                opacity: 0;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Color schemes for GPS markers */
        .gps-color-1 .gps-marker-body { background-color: #4CAF50; } /* Hijau - Rendah */
        .gps-color-1 .gps-marker-pulse { background-color: rgba(76, 175, 80, 0.5); }
        
        .gps-color-2 .gps-marker-body { background-color: #FFC107; } /* Kuning - Sedang */
        .gps-color-2 .gps-marker-pulse { background-color: rgba(255, 193, 7, 0.5); }
        
        .gps-color-3 .gps-marker-body { background-color: #FF9800; } /* Oranye - Tinggi */
        .gps-color-3 .gps-marker-pulse { background-color: rgba(255, 152, 0, 0.5); }
        
        .gps-color-4 .gps-marker-body { background-color: #F44336; } /* Merah - Sangat Tinggi */
        .gps-color-4 .gps-marker-pulse { background-color: rgba(244, 67, 54, 0.5); }
        
        .gps-color-5 .gps-marker-body { background-color: #9C27B0; } /* Ungu - Khusus */
        .gps-color-5 .gps-marker-pulse { background-color: rgba(156, 39, 176, 0.5); }
        
        /* Enhanced popup design dengan informasi lengkap */
        .popup-container {
            max-width: 500px !important;
            min-width: 450px;
            border-radius: 15px;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        
        .popup-header {
            background: linear-gradient(90deg, #005f73, #0a9396);
            color: white;
            padding: 20px;
            margin: -16px -16px 15px -16px;
            border-radius: 15px 15px 0 0;
            position: relative;
        }
        
        .popup-header h5 {
            margin: 0;
            font-weight: 800;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        .popup-header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .popup-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .popup-stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #0a9396;
            transition: transform 0.3s;
        }
        
        .popup-stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .popup-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .popup-stat-value {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .popup-stat-value.total {
            color: #005f73;
        }
        
        .popup-stat-value.value {
            color: #28a745;
        }
        
        .popup-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #ee9b00;
        }
        
        .popup-section-title {
            font-weight: 700;
            font-size: 1rem;
            color: #495057;
            margin-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .popup-section-title i {
            margin-right: 8px;
            color: #005f73;
        }
        
        .detail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: #005f73;
            font-size: 0.9rem;
            text-align: right;
        }
        
        .kelompok-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #2196F3;
        }
        
        .kelompok-name {
            font-weight: 700;
            color: #0d47a1;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .kelompok-detail {
            font-size: 0.85rem;
            color: #546e7a;
        }
        
        .jenis-bantuan-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .jenis-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .jenis-badge:hover {
            transform: translateY(-2px);
        }
        
        .tahun-distribusi {
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.6;
        }
        
        .popup-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .popup-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .popup-btn-primary {
            background: linear-gradient(90deg, #005f73, #0a9396);
            color: white;
        }
        
        .popup-btn-primary:hover {
            background: linear-gradient(90deg, #004d5e, #097880);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 95, 115, 0.3);
        }
        
        .popup-btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .popup-btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        /* Enhanced legend */
        .legend-enhanced {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 2px solid rgba(0, 95, 115, 0.1);
        }
        
        .legend-title {
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 1rem;
        }
        
        .legend-scale {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .legend-item-enhanced {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .legend-item-enhanced:hover {
            background: #e9ecef;
        }
        
        .legend-color-box {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .legend-color-box::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        /* Layer controls positioning untuk menghindari tumpang tindih */
        .layers-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 2px solid rgba(0, 95, 115, 0.1);
            z-index: 1000;
        }
        
        /* Reorganize map controls positions untuk menghindari tumpang tindih */
        .heatmap-controls {
            top: 350px;
            right: 20px;
        }
        
        .data-summary-panel {
            top: 80px;
            left: 20px;
        }
        
        .map-controls {
            top: 350px;
            left: 20px;
        }
        
        /* Mobile controls toggle */
        .mobile-controls-toggle {
            display: none;
        }
        
        @media (max-width: 1200px) {
            .data-summary-panel {
                top: 80px;
                left: 20px;
            }
            
            .map-controls {
                top: 350px;
                left: 20px;
            }
            
            .heatmap-controls {
                top: 350px;
                right: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .mobile-controls-toggle {
                display: block;
            }
            
            .popup-container {
                max-width: 320px !important;
                min-width: 300px !important;
            }
            
            .popup-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .popup-actions {
                flex-direction: column;
            }
            
            .data-summary-panel, 
            .map-controls, 
            .heatmap-controls, 
            .map-legend {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                bottom: auto;
                margin: 10px;
                width: calc(100% - 20px);
                max-width: none;
            }
        }
        
        /* Tab content for full page */
        .tab-content > .tab-pane {
            padding: 20px;
        }
        
        .tab-content > .tab-pane#v-pills-map {
            padding: 0;
        }
        
        /* Map container for full page */
        .map-container-full {
            position: relative;
            height: calc(100vh - 180px);
        }
        
        /* Z-index layering untuk mencegah tumpang tindih */
        .leaflet-top { z-index: 999; }
        .leaflet-bottom { z-index: 999; }
        .leaflet-control { z-index: 999; }
        
        /* Custom marker shadow */
        .marker-shadow {
            filter: drop-shadow(0 3px 8px rgba(0,0,0,0.4));
        }
        
        /* Animation for marker hover */
        @keyframes markerHover {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.1); }
            100% { transform: translateY(0) scale(1); }
        }
        
        .marker-hover {
            animation: markerHover 0.5s ease;
        }
        
        /* Clear layering untuk peta */
        .leaflet-pane { z-index: 400; }
        .leaflet-map-pane { z-index: 400; }
        .leaflet-overlay-pane { z-index: 401; }
        .leaflet-shadow-pane { z-index: 402; }
        .leaflet-marker-pane { z-index: 403; }
        .leaflet-tooltip-pane { z-index: 404; }
        .leaflet-popup-pane { z-index: 405; }
        
        /* Controls z-index */
        .leaflet-control-container { z-index: 406; }
        
        /* Our custom controls */
        .custom-map-control { z-index: 1000; }
        
        /* Panel visibility toggle */
        .panel-hidden {
            display: none !important;
        }
        
        /* Panel toggle button */
        .panel-toggle-btn {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .panel-toggle-btn:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Simplified Auto Login Modal -->
    <div class="modal fade auto-login-modal" id="autoLoginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda mb-4">
                    <h4 class="fw-bold mb-3">Sistem Peta Statistik</h4>
                    <p>Memuat aplikasi...</p>
                    
                    <div class="spinner-border text-primary mt-4" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    
                    <div class="mt-4 small text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Sistem akan otomatis memuat data terbaru
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal (for after auto login) -->
    <div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda mb-4">
                    <h3 class="fw-bold mb-3">Selamat Datang!</h3>
                    <p id="welcomeMessage">Sistem Peta Statistik Data Nelayan Kabupaten Situbondo telah siap digunakan.</p>
                    
                    <button class="btn btn-welcome" data-bs-dismiss="modal">
                        <i class="fas fa-map-marked-alt me-2"></i> Buka Peta
                    </button>
                    
                    <div class="mt-4 small text-white-50">
                        <i class="fas fa-info-circle me-1"></i>
                        Login otomatis berhasil. Akses penuh diberikan.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content" id="appContent" style="display: none;">
        <!-- Navigation Bar - DIPINDAHKAN KE ATAS -->
        <nav class="top-navbar">
            <div class="nav-container">
                <div class="nav-pills-horizontal" id="v-pills-tab" role="tablist">
                    <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button" role="tab">
                        <i class="fas fa-tachometer-alt feature-icon me-2"></i> Dashboard
                    </button>
                    <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button" role="tab">
                        <i class="fas fa-database feature-icon me-2"></i> Data Bantuan
                    </button>
                    <button class="nav-link" id="v-pills-map-tab" data-bs-toggle="pill" data-bs-target="#v-pills-map" type="button" role="tab">
                        <i class="fas fa-map-marked-alt feature-icon me-2"></i> Visual Peta
                    </button>
                    <button class="nav-link" id="btn-reload-repo" type="button">
                        <i class="fas fa-sync-alt feature-icon me-2"></i> Reload Data
                    </button>
                    <button class="nav-link logout text-white" id="v-pills-logout-tab" type="button">
                        <i class="fas fa-sign-out-alt feature-icon me-2"></i> Keluar
                    </button>
                </div>
            </div>
        </nav>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda">
                </div>
                <h1 class="app-title">PETA STATISTIK DATA NELAYAN<br>KABUPATEN SITUBONDO</h1>
                <p class="app-subtitle">Dinas Peternakan dan Perikanan Kabupaten Situbondo</p>
                <div class="watermark">Visualization Edition v2.7</div>
            </div>
            
            <div class="tab-content" id="v-pills-tabContent">
                
                <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                    <h3 class="section-title">Dashboard Overview</h3>
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-box p-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="stats-label text-muted">Total Penerima</div>
                                    <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                                </div>
                                <div class="stats-number h2 fw-bold" id="totalPenerima">0</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-box p-4" style="border-left-color: var(--secondary-color);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="stats-label text-muted">Total Bantuan (Rp)</div>
                                    <i class="fas fa-money-bill-wave fa-2x text-success opacity-50"></i>
                                </div>
                                <div class="stats-number h2 fw-bold text-success" id="totalBantuan">0</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-box p-4" style="border-left-color: #ffc107;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="stats-label text-muted">Tahun Aktif</div>
                                    <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                                </div>
                                <div class="stats-number h2 fw-bold text-warning" id="tahunAktif">2025</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-box p-4" style="border-left-color: #17a2b8;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="stats-label text-muted">Rata-rata</div>
                                    <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                                </div>
                                <div class="stats-number h2 fw-bold text-info" id="rataBantuan">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Distribusi per Kecamatan</div>
                                <div class="card-body"><canvas id="kecamatanChart" height="250"></canvas></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Tren Bantuan Tahunan</div>
                                <div class="card-body"><canvas id="tahunChart" height="250"></canvas></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header"><i class="fas fa-history me-2"></i> Transaksi Terbaru</div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0">
                                            <thead><tr><th>Tanggal</th><th>Nama Penerima</th><th>Desa</th><th>Jenis Bantuan</th><th>Jumlah</th></tr></thead>
                                            <tbody id="recentData"><tr><td colspan="5" class="text-center p-4">Tidak ada data</td></tr></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="v-pills-data" role="tabpanel">
                    <h3 class="section-title">Database Bantuan (View Only)</h3>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                            <span><i class="fas fa-database me-2"></i> Daftar Penerima Bantuan Nelayan</span>
                            <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
                                <div class="input-group" style="max-width: 300px;">
                                    <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari data...">
                                    <button class="btn btn-sm btn-light border" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover data-table mb-0" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>No</th><th>Nama</th><th>NIK</th><th>Kelompok</th>
                                            <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                            <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                        <tr><td colspan="13" class="text-center py-4">Memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TAB PANEL: Visual Peta - FULL PAGE -->
                <div class="tab-pane fade full-page-map" id="v-pills-map" role="tabpanel">
                    <div class="card border-0">
                        <div class="card-header d-flex justify-content-between align-items-center py-3">
                            <span><i class="fas fa-map-marked-alt me-2"></i> Peta Sebaran Data Bantuan Nelayan Kabupaten Situbondo</span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" id="btnFullscreenMap" title="Mode Layar Penuh">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="btnHideControls" title="Sembunyikan Kontrol">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="btnShowAllPanels" title="Tampilkan Semua Panel">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 position-relative map-container-full" id="mapContainer">
                            <!-- Search Box -->
                            <div class="search-box" id="mapSearchBox">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="mapSearch" placeholder="Cari desa/kecamatan...">
                                    <button class="btn btn-primary" id="searchMapBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="clearMapSearchBtn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Map Container -->
                            <div id="map">
                                <div class="map-loading d-none" id="mapLoading">
                                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Memuat peta...</p>
                                </div>
                            </div>
                            
                            <!-- Data Summary Panel -->
                            <div class="data-summary-panel map-controls-transparent custom-map-control" id="dataSummaryPanel">
                                <div class="panel-header">
                                    <h6 class="panel-title">Statistik Peta</h6>
                                    <button class="panel-close-btn" id="closeDataSummaryPanel">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <div class="small text-muted">Titik Data</div>
                                        <div class="fw-bold" id="mapPointCount">0</div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="small text-muted">Total Penerima</div>
                                        <div class="fw-bold" id="mapTotalRecipients">0</div>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <div class="small text-muted">Total Nilai Bantuan</div>
                                        <div class="fw-bold text-success" id="mapTotalValue">Rp 0</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="small text-muted">Desa Terbanyak Bantuan</div>
                                        <div class="fw-bold text-warning" id="topDesa">-</div>
                                    </div>
                                </div>
                                <!-- Toggle button for panel -->
                                <div class="panel-toggle-btn" id="toggleDataSummaryPanel" style="top: 5px; right: 5px;">
                                    <i class="fas fa-chart-bar text-primary"></i>
                                </div>
                            </div>
                            
                            <!-- Map Controls -->
                            <div class="map-controls map-controls-transparent custom-map-control" id="mapControls">
                                <div class="panel-header">
                                    <h6 class="panel-title">Kontrol Peta</h6>
                                    <button class="panel-close-btn" id="closeMapControls">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Tampilkan berdasarkan:</label>
                                    <select class="form-select form-select-sm" id="mapFilterType">
                                        <option value="all">Semua Data</option>
                                        <option value="kecamatan">Kecamatan</option>
                                        <option value="tahun">Tahun</option>
                                        <option value="jenis">Jenis Bantuan</option>
                                        <option value="desa">Desa</option>
                                    </select>
                                </div>
                                <div class="mb-2" id="mapFilterValueContainer" style="display: none;">
                                    <select class="form-select form-select-sm" id="mapFilterValue"></select>
                                </div>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-primary btn-sm" id="applyMapFilter">
                                        <i class="fas fa-filter me-1"></i> Terapkan
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" id="resetMapFilter">
                                        <i class="fas fa-undo me-1"></i> Reset
                                    </button>
                                </div>
                                <!-- Toggle button for panel -->
                                <div class="panel-toggle-btn" id="toggleMapControls" style="top: 5px; right: 5px;">
                                    <i class="fas fa-sliders-h text-primary"></i>
                                </div>
                            </div>
                            
                            <!-- Enhanced Map Legend -->
                            <div class="map-legend map-controls-transparent legend-enhanced custom-map-control" id="mapLegend">
                                <div class="panel-header">
                                    <div class="legend-title">Legenda Peta</div>
                                    <button class="panel-close-btn" id="closeMapLegend">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="legend-scale">
                                    <div class="legend-item-enhanced">
                                        <div class="legend-color-box" style="background-color: #4CAF50;"></div>
                                        <small>1-5 Penerima</small>
                                    </div>
                                    <div class="legend-item-enhanced">
                                        <div class="legend-color-box" style="background-color: #FFC107;"></div>
                                        <small>6-15 Penerima</small>
                                    </div>
                                    <div class="legend-item-enhanced">
                                        <div class="legend-color-box" style="background-color: #FF9800;"></div>
                                        <small>16-30 Penerima</small>
                                    </div>
                                    <div class="legend-item-enhanced">
                                        <div class="legend-color-box" style="background-color: #F44336;"></div>
                                        <small>31+ Penerima</small>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #005f73; border: 2px solid #001219;"></div>
                                        <span class="small">Pusat Kecamatan</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #ff5500; opacity: 0.5;"></div>
                                        <span class="small">Area Heatmap</span>
                                    </div>
                                </div>
                                <!-- Toggle button for panel -->
                                <div class="panel-toggle-btn" id="toggleMapLegend" style="top: 5px; right: 5px;">
                                    <i class="fas fa-map-signs text-primary"></i>
                                </div>
                            </div>
                            
                            <!-- Layer Controls -->
                            <div class="heatmap-controls map-controls-transparent layers-panel custom-map-control" id="layerControls">
                                <div class="panel-header">
                                    <h6 class="panel-title">Layer Peta</h6>
                                    <button class="panel-close-btn" id="closeLayerControls">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="toggleHeatmap" checked>
                                    <label class="form-check-label" for="toggleHeatmap">Heatmap</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="toggleMarkers" checked>
                                    <label class="form-check-label" for="toggleMarkers">Marker GPS</label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="toggleKecamatan" checked>
                                    <label class="form-check-label" for="toggleKecamatan">Kecamatan</label>
                                </div>
                                <div class="btn-group-vertical w-100" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary active" id="btnMapRoad">Jalan</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnMapSatellite">Satelit</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnMapHybrid">Hybrid</button>
                                </div>
                                <!-- Toggle button for panel -->
                                <div class="panel-toggle-btn" id="toggleLayerControls" style="top: 5px; right: 5px;">
                                    <i class="fas fa-layer-group text-primary"></i>
                                </div>
                            </div>
                            
                            <!-- Panel Toggle Buttons (when panels are hidden) -->
                            <div class="panel-toggle-btn" id="toggleDataSummaryBtn" style="top: 80px; left: 20px; display: none;">
                                <i class="fas fa-chart-bar text-primary"></i>
                            </div>
                            <div class="panel-toggle-btn" id="toggleMapControlsBtn" style="top: 350px; left: 20px; display: none;">
                                <i class="fas fa-sliders-h text-primary"></i>
                            </div>
                            <div class="panel-toggle-btn" id="toggleMapLegendBtn" style="bottom: 30px; left: 20px; display: none;">
                                <i class="fas fa-map-signs text-primary"></i>
                            </div>
                            <div class="panel-toggle-btn" id="toggleLayerControlsBtn" style="top: 350px; right: 20px; display: none;">
                                <i class="fas fa-layer-group text-primary"></i>
                            </div>
                            
                            <!-- Locate Button -->
                            <div class="map-control-button" style="bottom: 20px; right: 20px;" id="locateButton" title="Lokasi Saya">
                                <i class="fas fa-location-arrow text-primary"></i>
                            </div>
                            
                            <!-- Layer Visibility Toggle for Mobile -->
                            <button class="mobile-controls-toggle map-control-button" style="top: 20px; right: 20px;" id="mobileControlsToggle" title="Toggle Kontrol">
                                <i class="fas fa-layer-group text-primary"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mt-4 mx-3">
                        <div class="card-header"><i class="fas fa-info-circle me-2"></i> Informasi Peta</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Panduan Penggunaan:</h6>
                                    <ul class="mb-0">
                                        <li>Klik pada marker GPS untuk melihat detail data penerima per desa</li>
                                        <li>Gunakan kontrol filter untuk menampilkan data spesifik</li>
                                        <li>Gunakan search box untuk mencari desa atau kecamatan tertentu</li>
                                        <li>Heatmap menunjukkan kerapatan distribusi bantuan</li>
                                        <li>Marker GPS berwarna menunjukkan intensitas jumlah penerima</li>
                                        <li>Gunakan tombol "Lokasi Saya" untuk melihat posisi Anda di peta</li>
                                        <li>Gunakan tombol layar penuh untuk pengalaman peta yang lebih baik</li>
                                        <li>Klik ikon panel untuk menampilkan/sembunyikan kontrol peta</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Keterangan Warna:</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="badge" style="background-color: #4CAF50; color: white;">Rendah (1-5)</span>
                                        <span class="badge" style="background-color: #FFC107; color: black;">Sedang (6-15)</span>
                                        <span class="badge" style="background-color: #FF9800; color: white;">Tinggi (16-30)</span>
                                        <span class="badge" style="background-color: #F44336; color: white;">Sangat Tinggi (31+)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright text-center py-3">
                &copy; 2025 Dinas Peternakan dan Perikanan Kabupaten Situbondo - Bidang Pemberdayaan Nelayan.
            </div>
        </div>
        
        <button class="floating-action-btn" id="fabBtn" title="Buka Peta Statistik">
            <i class="fas fa-map-marked-alt"></i>
        </button>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast notification-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Detail Lokasi -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i> Detail Data Lokasi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="locationDetailContent">
                        <p class="text-center">Memuat data...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        let appData = [];
        let appSettings = {
            securityCode: '', // Password dihapus untuk login terbuka
            itemsPerPage: 25,
            notifications: true,
            appName: 'PETA STATISTIK DATA NELAYAN',
            appSubtitle: 'Dinas Peternakan dan Perikanan Kab. Situbondo',
            defaultTahun: new Date().getFullYear(),
            privacyMode: true
        };
        let currentPage = 1;
        let filteredData = [];
        let isFilterActive = false;
        
        // Variables for map
        let map = null;
        let mapMarkers = [];
        let mapLayer = null;
        let heatmapLayer = null;
        let kecamatanLayer = null;
        let markerCluster = null;
        let googleLayer = null;
        let currentMapType = 'roadmap';
        let isFullscreen = false;
        let controlsHidden = false;
        
        // Cache for coordinates
        let coordinatesCache = {};
        
        // NEW: Data structures for enhanced visualization
        let locationDataMap = {}; // Map untuk data lokasi
        let jenisBantuanColors = {}; // Warna untuk jenis bantuan
        let desaList = []; // Daftar desa untuk filter
        
        const SECURITY_CONSTANTS = {
            PIN: '17081945',
            DEFAULT_PASS: '' // Password dihapus
        };

        const kecamatanList = [
            "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", 
            "Bungatan", "Jangkar", "Jatibanteng", "Kapongan", "Kendit", 
            "Mangaran", "Mlandingan", "Panarukan", "Panji", "Situbondo", 
            "Suboh", "Sumbermalang"
        ];
        
        // Database koordinat yang DIPERBAIKI untuk Kabupaten Situbondo (Koordinat AKURAT)
        // DIPERBAIKI: Koordinat Kukusan dan Kendit yang benar
        const koordinatKecamatan = {
            "Arjasa": { lat: -7.7922, lng: 114.2626 },
            "Asembagus": { lat: -7.7530, lng: 114.1560 },
            "Banyuglugur": { lat: -7.7210, lng: 113.8880 },
            "Banyuputih": { lat: -7.7600, lng: 114.0200 },
            "Besuki": { lat: -7.7330, lng: 113.7000 },
            "Bungatan": { lat: -7.7167, lng: 113.9000 },
            "Jangkar": { lat: -7.7500, lng: 114.0830 },
            "Jatibanteng": { lat: -7.7170, lng: 113.9830 },
            "Kapongan": { lat: -7.6830, lng: 114.0160 },
            "Kendit": { lat: -7.7166, lng: 113.9333 }, // DIPERBAIKI: Koordinat yang lebih akurat
            "Mangaran": { lat: -7.6670, lng: 114.0670 },
            "Mlandingan": { lat: -7.6830, lng: 113.9500 },
            "Panarukan": { lat: -7.7000, lng: 113.9160 },
            "Panji": { lat: -7.7353, lng: 113.6983 },
            "Situbondo": { lat: -7.7060, lng: 113.9600 },
            "Suboh": { lat: -7.8000, lng: 113.8330 },
            "Sumbermalang": { lat: -7.7670, lng: 113.7830 }
        };

        // Database koordinat desa yang DIPERBAIKI untuk Kabupaten Situbondo
        // DIPERBAIKI: Koordinat Kukusan dan Kendit yang lebih akurat
        const koordinatDesa = {
            // ===== KECAMATAN ARJASA =====
            "Arjasa, Arjasa": { lat: -7.7922, lng: 114.2626 },
            "Bayeman, Arjasa": { lat: -7.7800, lng: 114.2500 },
            "Curah Tatal, Arjasa": { lat: -7.8000, lng: 114.2700 },
            "Jatisari, Arjasa": { lat: -7.7850, lng: 114.2650 },
            "Kayumas, Arjasa": { lat: -7.7900, lng: 114.2600 },
            "Kedungdowo, Arjasa": { lat: -7.7950, lng: 114.2550 },
            "Ketowan, Arjasa": { lat: -7.7880, lng: 114.2580 },
            "Lamongan, Arjasa": { lat: -7.7850, lng: 114.2620 },

            // ===== KECAMATAN ASEMBAGUS =====
            "Asembagus, Asembagus": { lat: -7.7530, lng: 114.1560 },
            "Banyuputih, Asembagus": { lat: -7.7600, lng: 114.1400 },
            "Banyuwulu, Asembagus": { lat: -7.7550, lng: 114.1650 },
            "Gudang, Asembagus": { lat: -7.7500, lng: 114.1500 },
            "Jangkar, Asembagus": { lat: -7.7450, lng: 114.1600 },
            "Kedunglo, Asembagus": { lat: -7.7450, lng: 114.1500 },
            "Kertosari, Asembagus": { lat: -7.7550, lng: 114.1600 },
            "Mojosari, Asembagus": { lat: -7.7480, lng: 114.1650 },

            // ===== KECAMATAN BANYUGLUGUR =====
            "Banyuglugur, Banyuglugur": { lat: -7.7210, lng: 113.8880 },
            "Kalianget, Banyuglugur": { lat: -7.7300, lng: 113.8800 },
            "Kepuh, Banyuglugur": { lat: -7.7150, lng: 113.8950 },

            // ===== KECAMATAN BANYUPUTIH =====
            "Sumberanyar, Banyuputih": { lat: -7.7600, lng: 114.0200 },
            "Sumberejo, Banyuputih": { lat: -7.7650, lng: 114.0250 },
            "Wonorejo, Banyuputih": { lat: -7.7500, lng: 114.0300 },

            // ===== KECAMATAN BESUKI =====
            "Besuki, Besuki": { lat: -7.7330, lng: 113.7000 },
            "Boro, Besuki": { lat: -7.7400, lng: 113.7100 },
            "Demung, Besuki": { lat: -7.7300, lng: 113.6900 },
            "Jetis, Besuki": { lat: -7.7200, lng: 113.7050 },

            // ===== KECAMATAN BUNGATAN =====
            "Bungatan, Bungatan": { lat: -7.7167, lng: 113.9000 },
            "Bungcalok, Bungatan": { lat: -7.7100, lng: 113.9050 },
            "Cemara, Bungatan": { lat: -7.7200, lng: 113.8950 },
            "Kembangsari, Bungatan": { lat: -7.7150, lng: 113.8900 },
            "Kenep, Bungatan": { lat: -7.7180, lng: 113.9020 },
            "Kompas, Bungatan": { lat: -7.7120, lng: 113.9080 },
            "Patemon, Bungatan": { lat: -7.7080, lng: 113.8950 },
            "Sokaan, Bungatan": { lat: -7.7050, lng: 113.9100 },
            "Tambak Ukir, Bungatan": { lat: -7.7250, lng: 113.8800 },

            // ===== KECAMATAN JANGKAR =====
            "Jangkar, Jangkar": { lat: -7.7500, lng: 114.0830 },
            "Curah Tatal, Jangkar": { lat: -7.7450, lng: 114.0800 },
            "Gelung, Jangkar": { lat: -7.7550, lng: 114.0900 },

            // ===== KECAMATAN JATIBANTENG =====
            "Curahsuri, Jatibanteng": { lat: -7.7200, lng: 113.9900 },
            "Jatibanteng, Jatibanteng": { lat: -7.7170, lng: 113.9830 },
            "Kalibagor, Jatibanteng": { lat: -7.7100, lng: 113.9800 },

            // ===== KECAMATAN KAPONGAN =====
            "Batu Kapur, Kapongan": { lat: -7.6900, lng: 114.0200 },
            "Curah Cottok, Kapongan": { lat: -7.6800, lng: 114.0150 },
            "Gelung, Kapongan": { lat: -7.6750, lng: 114.0100 },

            // ===== KECAMATAN KENDIT ===== (DIPERBAIKI KOORDINAT)
            "Balung, Kendit": { lat: -7.7300, lng: 113.9350 },
            "Keding, Kendit": { lat: -7.7250, lng: 113.9400 },
            "Kendit, Kendit": { lat: -7.7166, lng: 113.9333 }, // DIPERBAIKI
            "Kukusan, Kendit": { lat: -7.7083, lng: 113.9417 }, // DITAMBAHKAN: Koordinat Kukusan yang akurat

            // ===== KECAMATAN MANGARAN =====
            "Mangaran, Mangaran": { lat: -7.6670, lng: 114.0670 },
            "Semiring, Mangaran": { lat: -7.6700, lng: 114.0700 },

            // ===== KECAMATAN MLANDINGAN =====
            "Besuki, Mlandingan": { lat: -7.6830, lng: 113.9500 },
            "Buniwangi, Mlandingan": { lat: -7.6850, lng: 113.9450 },

            // ===== KECAMATAN PANARUKAN =====
            "Gelung, Panarukan": { lat: -7.7050, lng: 113.9200 },
            "Kilensari, Panarukan": { lat: -7.6950, lng: 113.9150 },
            "Paowan, Panarukan": { lat: -7.7100, lng: 113.9250 },

            // ===== KECAMATAN PANJI =====
            "Ardirejo, Panji": { lat: -7.7400, lng: 113.7000 },
            "Kemiri, Panji": { lat: -7.7300, lng: 113.7050 },
            "Panji Kidul, Panji": { lat: -7.7350, lng: 113.6950 },
            "Panji Lor, Panji": { lat: -7.7330, lng: 113.6980 },
            "Tokelan, Panji": { lat: -7.7380, lng: 113.7020 },
            "Mimbaan, Panji": { lat: -7.7320, lng: 113.6900 },
            "Wonokerto, Panji": { lat: -7.7280, lng: 113.7100 },

            // ===== KECAMATAN SITUBONDO (IBU KOTA) =====
            "Dawuhan, Situbondo": { lat: -7.7060, lng: 113.9600 },
            "Karang Anyar, Situbondo": { lat: -7.7000, lng: 113.9500 },
            "Karang Asem, Situbondo": { lat: -7.7100, lng: 113.9650 },

            // ===== KECAMATAN SUBOH =====
            "Buduan, Suboh": { lat: -7.8050, lng: 113.8400 },
            "Dawuan, Suboh": { lat: -7.7950, lng: 113.8300 },
            "Gunung Malang, Suboh": { lat: -7.8100, lng: 113.8350 },

            // ===== KECAMATAN SUMBERMALANG =====
            "Baderan, Sumbermalang": { lat: -7.7700, lng: 113.7900 },
            "Kalirejo, Sumbermalang": { lat: -7.7600, lng: 113.7800 },
            "Plalangan, Sumbermalang": { lat: -7.7750, lng: 113.7850 }
        };
        
        // --- APPLICATION LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplikasi Peta Statistik Data Nelayan diinisialisasi');
            
            // Load cached coordinates
            loadCoordinatesCache();
            
            // Initialize jenis bantuan colors
            initJenisBantuanColors();
            
            // AUTO LOGIN - Tanpa password
            autoLogin();
            
            initializeApp();
            setupEventListeners();
            setupPanelControls();
        });
        
        function setupPanelControls() {
            // Setup panel close buttons
            const panels = [
                { panel: 'dataSummaryPanel', closeBtn: 'closeDataSummaryPanel', toggleBtn: 'toggleDataSummaryPanel', toggleIcon: 'toggleDataSummaryBtn' },
                { panel: 'mapControls', closeBtn: 'closeMapControls', toggleBtn: 'toggleMapControls', toggleIcon: 'toggleMapControlsBtn' },
                { panel: 'mapLegend', closeBtn: 'closeMapLegend', toggleBtn: 'toggleMapLegend', toggleIcon: 'toggleMapLegendBtn' },
                { panel: 'layerControls', closeBtn: 'closeLayerControls', toggleBtn: 'toggleLayerControls', toggleIcon: 'toggleLayerControlsBtn' }
            ];
            
            panels.forEach(p => {
                const closeBtn = document.getElementById(p.closeBtn);
                const toggleBtn = document.getElementById(p.toggleBtn);
                const toggleIcon = document.getElementById(p.toggleIcon);
                const panel = document.getElementById(p.panel);
                
                if (closeBtn && panel) {
                    closeBtn.addEventListener('click', function() {
                        panel.classList.add('panel-hidden');
                        if (toggleIcon) toggleIcon.style.display = 'flex';
                    });
                }
                
                if (toggleBtn && panel) {
                    toggleBtn.addEventListener('click', function() {
                        panel.classList.add('panel-hidden');
                        if (toggleIcon) toggleIcon.style.display = 'flex';
                    });
                }
                
                if (toggleIcon && panel) {
                    toggleIcon.addEventListener('click', function() {
                        panel.classList.remove('panel-hidden');
                        toggleIcon.style.display = 'none';
                    });
                }
            });
            
            // Show all panels button
            const showAllPanelsBtn = document.getElementById('btnShowAllPanels');
            if (showAllPanelsBtn) {
                showAllPanelsBtn.addEventListener('click', function() {
                    panels.forEach(p => {
                        const panel = document.getElementById(p.panel);
                        const toggleIcon = document.getElementById(p.toggleIcon);
                        if (panel) {
                            panel.classList.remove('panel-hidden');
                        }
                        if (toggleIcon) {
                            toggleIcon.style.display = 'none';
                        }
                    });
                    showNotification('Semua panel ditampilkan', 'success');
                });
            }
        }
        
        function initJenisBantuanColors() {
            // Warna untuk jenis bantuan
            jenisBantuanColors = {
                'Uang': { bg: '#e3f2fd', text: '#1565c0', icon: 'money-bill-wave' },
                'Barang': { bg: '#e8f5e9', text: '#2e7d32', icon: 'box' },
                'Jasa': { bg: '#fff3e0', text: '#ef6c00', icon: 'hands-helping' },
                'Modal': { bg: '#fce4ec', text: '#c2185b', icon: 'hand-holding-usd' },
                'Sarana': { bg: '#f3e5f5', text: '#7b1fa2', icon: 'tools' },
                'Alat Tangkap': { bg: '#fff8e1', text: '#ff8f00', icon: 'fish' },
                'Bahan Bakar': { bg: '#f3e5f5', text: '#7b1fa2', icon: 'gas-pump' },
                'Pelatihan': { bg: '#e0f7fa', text: '#00838f', icon: 'graduation-cap' }
            };
        }
        
        function autoLogin() {
            // Langsung login tanpa password
            showNotification('Login otomatis berhasil. Selamat datang!', 'success');
            
            // Tampilkan modal welcome
            setTimeout(() => {
                try {
                    const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                    welcomeModal.show();
                    
                    // Auto hide after 2 seconds
                    setTimeout(() => {
                        welcomeModal.hide();
                        document.getElementById('appContent').style.display = 'block';
                        
                        // Load data setelah login
                        handleReloadFromRepo();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error showing welcome modal:', error);
                    document.getElementById('appContent').style.display = 'block';
                    handleReloadFromRepo();
                }
            }, 1000);
        }
        
        function initializeApp() {
            loadSettings();
            loadData();
            initializeCharts();
            updateDashboard();
            setupMapFilterOptions();
            extractDesaList();
        }

        function loadCoordinatesCache() {
            try {
                const cached = localStorage.getItem('coordinatesCache');
                if (cached) {
                    coordinatesCache = JSON.parse(cached);
                    console.log('Koordinat cache dimuat:', Object.keys(coordinatesCache).length, 'entries');
                }
            } catch (e) {
                console.error('Gagal memuat cache koordinat:', e);
            }
        }
        
        function saveCoordinatesCache() {
            try {
                localStorage.setItem('coordinatesCache', JSON.stringify(coordinatesCache));
            } catch (e) {
                console.error('Gagal menyimpan cache koordinat:', e);
            }
        }
        
        function extractDesaList() {
            // Ekstrak daftar desa dari data yang ada
            desaList = [...new Set(appData.map(item => item.desa))].sort();
        }
        
        async function getCoordinates(desa, kecamatan) {
            const key = `${desa}, ${kecamatan}`;
            
            // Cek di cache terlebih dahulu
            if (coordinatesCache[key]) {
                return coordinatesCache[key];
            }
            
            // Cek di database koordinat desa
            if (koordinatDesa[key]) {
                coordinatesCache[key] = koordinatDesa[key];
                saveCoordinatesCache();
                return koordinatDesa[key];
            }
            
            // Cek di koordinat kecamatan
            if (koordinatKecamatan[kecamatan]) {
                coordinatesCache[key] = koordinatKecamatan[kecamatan];
                saveCoordinatesCache();
                return koordinatKecamatan[kecamatan];
            }
            
            // Jika tidak ada, coba geocode
            try {
                const coordinates = await geocodeLocation(`${desa}, ${kecamatan}, Situbondo, Jawa Timur`);
                if (coordinates) {
                    coordinatesCache[key] = coordinates;
                    saveCoordinatesCache();
                    return coordinates;
                }
            } catch (error) {
                console.error('Error geocoding:', error);
            }
            
            // Default ke pusat Situbondo
            return { lat: -7.7060, lng: 113.9600 };
        }
        
        async function geocodeLocation(address) {
            return new Promise((resolve, reject) => {
                if (!window.google || !window.google.maps) {
                    reject(new Error('Google Maps API tidak tersedia'));
                    return;
                }
                
                const geocoder = new google.maps.Geocoder();
                
                geocoder.geocode({ address: address }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        reject(new Error('Geocode gagal: ' + status));
                    }
                });
            });
        }
        
        function setupEventListeners() {
            // Data Table Search
            const searchData = document.getElementById('searchData');
            if (searchData) {
                searchData.addEventListener('input', handleSearch);
            }
            
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            // Map Controls
            const mapFilterType = document.getElementById('mapFilterType');
            if (mapFilterType) {
                mapFilterType.addEventListener('change', handleMapFilterTypeChange);
            }
            
            const applyMapFilterBtn = document.getElementById('applyMapFilter');
            if (applyMapFilterBtn) {
                applyMapFilterBtn.addEventListener('click', applyMapFilter);
            }
            
            const resetMapFilterBtn = document.getElementById('resetMapFilter');
            if (resetMapFilterBtn) {
                resetMapFilterBtn.addEventListener('click', resetMapFilter);
            }
            
            // Map Layer Toggles
            const toggleHeatmap = document.getElementById('toggleHeatmap');
            if (toggleHeatmap) {
                toggleHeatmap.addEventListener('change', toggleHeatmapLayer);
            }
            
            const toggleMarkers = document.getElementById('toggleMarkers');
            if (toggleMarkers) {
                toggleMarkers.addEventListener('change', toggleMarkersLayer);
            }
            
            const toggleKecamatan = document.getElementById('toggleKecamatan');
            if (toggleKecamatan) {
                toggleKecamatan.addEventListener('change', toggleKecamatanLayer);
            }
            
            // Map Search
            const searchMapBtn = document.getElementById('searchMapBtn');
            if (searchMapBtn) {
                searchMapBtn.addEventListener('click', searchMapLocation);
            }
            
            const clearMapSearchBtn = document.getElementById('clearMapSearchBtn');
            if (clearMapSearchBtn) {
                clearMapSearchBtn.addEventListener('click', clearMapSearch);
            }
            
            const mapSearch = document.getElementById('mapSearch');
            if (mapSearch) {
                mapSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchMapLocation();
                    }
                });
            }
            
            // Map Type Controls
            const btnMapRoad = document.getElementById('btnMapRoad');
            const btnMapSatellite = document.getElementById('btnMapSatellite');
            const btnMapHybrid = document.getElementById('btnMapHybrid');
            
            if (btnMapRoad) btnMapRoad.addEventListener('click', () => changeMapType('roadmap'));
            if (btnMapSatellite) btnMapSatellite.addEventListener('click', () => changeMapType('satellite'));
            if (btnMapHybrid) btnMapHybrid.addEventListener('click', () => changeMapType('hybrid'));
            
            // Locate Me Button
            const locateButton = document.getElementById('locateButton');
            if (locateButton) {
                locateButton.addEventListener('click', locateUser);
            }
            
            // System Management
            const logoutTab = document.getElementById('v-pills-logout-tab');
            if (logoutTab) {
                logoutTab.addEventListener('click', logout);
            }
            
            const reloadRepoBtn = document.getElementById('btn-reload-repo');
            if (reloadRepoBtn) {
                reloadRepoBtn.addEventListener('click', handleReloadFromRepo);
            }

            // UI Helpers
            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', () => {
                    const mapTab = document.getElementById('v-pills-map-tab');
                    if (mapTab) {
                        mapTab.click();
                        window.scrollTo(0, 0);
                    }
                });
            }
            
            // Fullscreen map toggle
            const btnFullscreenMap = document.getElementById('btnFullscreenMap');
            if (btnFullscreenMap) {
                btnFullscreenMap.addEventListener('click', toggleFullscreenMap);
            }
            
            // Hide controls toggle
            const btnHideControls = document.getElementById('btnHideControls');
            if (btnHideControls) {
                btnHideControls.addEventListener('click', toggleControlsVisibility);
            }
            
            // Mobile controls toggle
            const mobileControlsToggle = document.getElementById('mobileControlsToggle');
            if (mobileControlsToggle) {
                mobileControlsToggle.addEventListener('click', toggleMobileControls);
            }
            
            // Tab change event
            document.querySelectorAll('#v-pills-tab button').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.id === 'v-pills-map-tab') {
                        setTimeout(() => {
                            initializeMap();
                        }, 300);
                    }
                });
            });
            
            // Transparent controls on mouse enter/leave
            const mapControls = ['dataSummaryPanel', 'mapControls', 'mapLegend', 'layerControls'];
            mapControls.forEach(controlId => {
                const control = document.getElementById(controlId);
                if (control) {
                    control.addEventListener('mouseenter', function() {
                        this.classList.remove('map-controls-transparent');
                    });
                    control.addEventListener('mouseleave', function() {
                        if (!controlsHidden) {
                            this.classList.add('map-controls-transparent');
                        }
                    });
                }
            });
        }
        
        function toggleMobileControls() {
            const controls = ['dataSummaryPanel', 'mapControls', 'mapLegend', 'layerControls'];
            const allHidden = controls.every(id => {
                const control = document.getElementById(id);
                return control && control.style.display === 'none';
            });
            
            controls.forEach(id => {
                const control = document.getElementById(id);
                if (control) {
                    control.style.display = allHidden ? '' : 'none';
                }
            });
            
            const toggleBtn = document.getElementById('mobileControlsToggle');
            if (toggleBtn) {
                toggleBtn.innerHTML = allHidden ? 
                    '<i class="fas fa-layer-group text-primary"></i>' : 
                    '<i class="fas fa-eye text-primary"></i>';
                toggleBtn.title = allHidden ? 'Toggle Kontrol' : 'Tampilkan Kontrol';
            }
        }
        
        function toggleFullscreenMap() {
            const mapContainer = document.getElementById('mapContainer');
            const btnFullscreenMap = document.getElementById('btnFullscreenMap');
            
            if (!isFullscreen) {
                // Enter fullscreen
                document.body.classList.add('fullscreen-map');
                isFullscreen = true;
                btnFullscreenMap.innerHTML = '<i class="fas fa-compress"></i>';
                btnFullscreenMap.title = 'Keluar dari Layar Penuh';
                
                // Adjust map height
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                        // Fit bounds to show all markers
                        if (mapMarkers.length > 0) {
                            const group = new L.featureGroup(mapMarkers);
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    }, 300);
                }
            } else {
                // Exit fullscreen
                document.body.classList.remove('fullscreen-map');
                isFullscreen = false;
                btnFullscreenMap.innerHTML = '<i class="fas fa-expand"></i>';
                btnFullscreenMap.title = 'Mode Layar Penuh';
                
                // Adjust map height
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 300);
                }
            }
        }
        
        function toggleControlsVisibility() {
            const btnHideControls = document.getElementById('btnHideControls');
            const controls = [
                'dataSummaryPanel',
                'mapControls', 
                'mapLegend',
                'layerControls',
                'mapSearchBox'
            ];
            
            if (!controlsHidden) {
                // Hide controls
                controls.forEach(id => {
                    const control = document.getElementById(id);
                    if (control) {
                        control.style.display = 'none';
                    }
                });
                controlsHidden = true;
                btnHideControls.innerHTML = '<i class="fas fa-eye"></i>';
                btnHideControls.title = 'Tampilkan Kontrol';
                showNotification('Kontrol peta disembunyikan', 'info');
            } else {
                // Show controls
                controls.forEach(id => {
                    const control = document.getElementById(id);
                    if (control) {
                        control.style.display = '';
                    }
                });
                controlsHidden = false;
                btnHideControls.innerHTML = '<i class="fas fa-eye-slash"></i>';
                btnHideControls.title = 'Sembunyikan Kontrol';
                showNotification('Kontrol peta ditampilkan', 'info');
            }
        }
        
        function setupMapFilterOptions() {
            const mapFilterType = document.getElementById('mapFilterType');
            if (!mapFilterType) return;
            
            mapFilterType.addEventListener('change', function() {
                const filterValueContainer = document.getElementById('mapFilterValueContainer');
                const filterValueSelect = document.getElementById('mapFilterValue');
                
                if (!filterValueContainer || !filterValueSelect) return;
                
                filterValueSelect.innerHTML = '';
                
                if (this.value === 'all') {
                    filterValueContainer.style.display = 'none';
                    return;
                }
                
                filterValueContainer.style.display = 'block';
                
                if (this.value === 'kecamatan') {
                    filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                    kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
                } else if (this.value === 'tahun') {
                    filterValueSelect.add(new Option('Pilih Tahun', ''));
                    const currentYear = new Date().getFullYear();
                    for (let year = 2020; year <= currentYear; year++) {
                        filterValueSelect.add(new Option(year, year));
                    }
                } else if (this.value === 'jenis') {
                    filterValueSelect.add(new Option('Pilih Jenis', ''));
                    filterValueSelect.add(new Option('Uang', 'Uang'));
                    filterValueSelect.add(new Option('Barang', 'Barang'));
                    filterValueSelect.add(new Option('Jasa', 'Jasa'));
                } else if (this.value === 'desa') {
                    filterValueSelect.add(new Option('Pilih Desa', ''));
                    desaList.forEach(desa => filterValueSelect.add(new Option(desa, desa)));
                }
            });
        }
        
        function handleMapFilterTypeChange() {
            const filterValueContainer = document.getElementById('mapFilterValueContainer');
            const filterValueSelect = document.getElementById('mapFilterValue');
            
            if (!filterValueContainer || !filterValueSelect) return;
            
            filterValueSelect.innerHTML = '';
            
            if (this.value === 'all') {
                filterValueContainer.style.display = 'none';
                return;
            }
            
            filterValueContainer.style.display = 'block';
            
            if (this.value === 'kecamatan') {
                filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
            } else if (this.value === 'tahun') {
                filterValueSelect.add(new Option('Pilih Tahun', ''));
                const currentYear = new Date().getFullYear();
                for (let year = 2020; year <= currentYear; year++) {
                    filterValueSelect.add(new Option(year, year));
                }
            } else if (this.value === 'jenis') {
                filterValueSelect.add(new Option('Pilih Jenis', ''));
                filterValueSelect.add(new Option('Uang', 'Uang'));
                filterValueSelect.add(new Option('Barang', 'Barang'));
                filterValueSelect.add(new Option('Jasa', 'Jasa'));
            } else if (this.value === 'desa') {
                filterValueSelect.add(new Option('Pilih Desa', ''));
                desaList.forEach(desa => filterValueSelect.add(new Option(desa, desa)));
            }
        }
        
        // --- AUTHENTICATION - DIPERBAIKI TANPA PASSWORD ---
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
                document.getElementById('appContent').style.display = 'none';
                
                // Auto login kembali setelah 1 detik
                setTimeout(() => {
                    autoLogin();
                }, 1000);
                
                showNotification('Anda telah berhasil logout. Login otomatis...', 'info');
            }
        }
        
        // --- DATA PERSISTENCE ---
        function loadData() {
            try {
                const savedData = localStorage.getItem('barjasData');
                appData = savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error("Gagal memuat data:", e);
                appData = [];
            }
            renderDataTable();
        }
        
        function saveData() {
            try {
                localStorage.setItem('barjasData', JSON.stringify(appData));
            } catch (e) {
                console.error("Gagal menyimpan data:", e);
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('barjasSettings');
            if (savedSettings) {
                try {
                    const loaded = JSON.parse(savedSettings);
                    Object.assign(appSettings, loaded);
                } catch(e) {
                    // Default settings
                }
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('barjasSettings', JSON.stringify(appSettings));
            } catch (e) {
                console.error("Gagal menyimpan pengaturan:", e);
            }
        }
        
        // --- DATA TABLE ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const dataToRender = isFilterActive ? filteredData : appData;
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToRender.length);
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4">Tidak ada data</td></tr>`;
                
                const tableInfo = document.getElementById('tableInfo');
                if (tableInfo) tableInfo.textContent = 'Menampilkan 0 dari 0 data';
                
                const pagination = document.getElementById('pagination');
                if (pagination) pagination.innerHTML = '';
                
                return;
            }
            
            for (let i = startIndex; i < endIndex; i++) {
                const data = dataToRender[i];
                const row = document.createElement('tr');
                
                const nikDisplay = formatPrivacy(data.nik);
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold text-primary">${data.nama}</td>
                    <td class="${privacyClass}">${nikDisplay}</td>
                    <td>${data.namaKelompok || '-'}</td>
                    <td>${data.jabatan || '-'}</td>
                    <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td>
                    <td>${data.desa}</td>
                    <td><span class="badge bg-info">${data.jenisBantuan}</span></td>
                    <td>${data.namaBantuan || '-'}</td>
                    <td class="fw-bold">${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td>
                    <td>${data.namaPetugas || '-'}</td>
                `;
                tableBody.appendChild(row);
            }
            
            const tableInfo = document.getElementById('tableInfo');
            if (tableInfo) {
                tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${dataToRender.length} data`;
            }
            
            updatePagination(dataToRender.length);
        }
        
        function updatePagination(totalItems) {
            const paginationEl = document.getElementById('pagination');
            if (!paginationEl) return;
            
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationEl.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageItem = (page, text, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page}); return false;">${text}</a>`;
                return li;
            };

            paginationEl.appendChild(createPageItem(currentPage - 1, '<i class="fas fa-chevron-left"></i>', currentPage === 1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationEl.appendChild(createPageItem(i, i, false, i === currentPage));
            }

            paginationEl.appendChild(createPageItem(currentPage + 1, '<i class="fas fa-chevron-right"></i>', currentPage === totalPages));
        }
        
        function changePage(page) {
            const dataToRender = isFilterActive ? filteredData : appData;
            const totalPages = Math.ceil(dataToRender.length / (parseInt(appSettings.itemsPerPage) || 25));
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderDataTable();
            }
        }
        
        function handleSearch() {
            const searchTerm = document.getElementById('searchData').value.toLowerCase();
            
            isFilterActive = !!searchTerm;
            
            filteredData = appData.filter(d => {
                const matchesSearch = !searchTerm || Object.values(d).some(v => 
                    String(v).toLowerCase().includes(searchTerm)
                );
                
                return matchesSearch;
            });
            
            currentPage = 1;
            renderDataTable();
        }
        
        function clearSearch() {
            const searchData = document.getElementById('searchData');
            if (searchData) searchData.value = '';
            
            handleSearch();
        }
        
        // --- DASHBOARD ---
        function updateDashboard() {
            const totalPenerima = document.getElementById('totalPenerima');
            const totalBantuan = document.getElementById('totalBantuan');
            const tahunAktif = document.getElementById('tahunAktif');
            const rataBantuan = document.getElementById('rataBantuan');
            
            if (totalPenerima) totalPenerima.textContent = formatNumber(appData.length);
            
            const uangData = appData.filter(d => d.jenisBantuan === 'Uang');
            const totalBantuanValue = uangData.reduce((sum, d) => sum + (parseFloat(d.jumlahBantuan) || 0), 0);
            
            if (totalBantuan) totalBantuan.textContent = `Rp ${formatNumber(totalBantuanValue)}`;
            
            const tahunCount = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const tahunAktifValue = Object.keys(tahunCount).reduce((a, b) => tahunCount[a] > tahunCount[b] ? a : b, appSettings.defaultTahun);
            
            if (tahunAktif) tahunAktif.textContent = tahunAktifValue;
            
            const rataBantuanValue = uangData.length > 0 ? totalBantuanValue / uangData.length : 0;
            
            if (rataBantuan) rataBantuan.textContent = `Rp ${formatNumber(rataBantuanValue.toFixed(0))}`;
            
            updateCharts();
            updateRecentData();
        }
        
        function updateRecentData() {
            const recentDataContainer = document.getElementById('recentData');
            if (!recentDataContainer) return;
            
            recentDataContainer.innerHTML = '';
            const recent = [...appData].sort((a, b) => new Date(b.tanggalInput) - new Date(a.tanggalInput)).slice(0, 5);
            
            if (recent.length === 0) {
                recentDataContainer.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>`;
                return;
            }
            
            recent.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(d.tanggalInput)}</td> <td>${d.nama}</td> <td>${d.desa}</td>
                    <td>${d.jenisBantuan}</td> <td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td>
                `;
                recentDataContainer.appendChild(row);
            });
        }
        
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js tidak tersedia');
                return;
            }
            
            Chart.defaults.font.family = "'Inter', sans-serif";
            const pieCtx = document.getElementById('kecamatanChart')?.getContext('2d');
            if (pieCtx) {
                window.kecamatanChart = new Chart(pieCtx, { 
                    type: 'pie', 
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'right' 
                            } 
                        } 
                    } 
                });
            }
            
            const barCtx = document.getElementById('tahunChart')?.getContext('2d');
            if (barCtx) {
                window.tahunChart = new Chart(barCtx, { 
                    type: 'bar', 
                    options: { 
                        responsive: true, 
                        scales: { 
                            y: { 
                                beginAtZero: true 
                            } 
                        } 
                    } 
                });
            }
        }
        
        function updateCharts() {
            if (!appData || appData.length === 0) return;

            const kecamatanData = appData.reduce((acc, d) => ({...acc, [d.kecamatan]: (acc[d.kecamatan] || 0) + 1}), {});
            if (window.kecamatanChart) {
                window.kecamatanChart.data = {
                    labels: Object.keys(kecamatanData),
                    datasets: [{ 
                        data: Object.values(kecamatanData), 
                        backgroundColor: ['#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226'] 
                    }]
                };
                window.kecamatanChart.update();
            }
            
            const tahunData = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const sortedYears = Object.keys(tahunData).sort();
            if (window.tahunChart) {
                window.tahunChart.data = {
                    labels: sortedYears,
                    datasets: [{ 
                        label: 'Jumlah Penerima', 
                        data: sortedYears.map(year => tahunData[year]), 
                        backgroundColor: '#0a9396' 
                    }]
                };
                window.tahunChart.update();
            }
        }
        
        // --- MAP FUNCTIONALITY - DIPERBAIKI DENGAN MARKER GPS DENGAN PULSE EFFECT ---
        async function initializeMap() {
            if (!document.getElementById('map')) return;
            
            // Show loading overlay
            const mapLoading = document.getElementById('mapLoading');
            if (mapLoading) mapLoading.classList.remove('d-none');
            
            // Clear existing map
            if (map) {
                map.remove();
                map = null;
            }
            
            // Initialize map centered on Situbondo
            map = L.map('map').setView([-7.7060, 113.9600], 11);
            
            // Add Google Maps layer
            try {
                googleLayer = L.gridLayer.googleMutant({
                    type: currentMapType
                }).addTo(map);
            } catch (error) {
                console.error('Error loading Google Maps layer:', error);
                // Fallback to OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(map);
            }
            
            // Initialize marker cluster
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: 40,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 10) size = 'medium';
                    if (count > 50) size = 'large';
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster marker-cluster-' + size,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            
            // Add markers for data
            await updateMapWithData(appData);
            
            // Add kecamatan boundaries and labels
            addKecamatanBoundaries();
            
            // Add heatmap layer
            addHeatmapLayer();
            
            // Hide loading overlay
            if (mapLoading) mapLoading.classList.add('d-none');
            
            // Set controls to transparent initially
            setTimeout(() => {
                const controls = ['dataSummaryPanel', 'mapControls', 'mapLegend', 'layerControls'];
                controls.forEach(id => {
                    const control = document.getElementById(id);
                    if (control) {
                        control.classList.add('map-controls-transparent');
                    }
                });
            }, 1000);
        }
        
        async function updateMapWithData(data) {
            if (!map) return;
            
            // Show loading
            showNotification('Memuat data peta...', 'info');
            
            // Clear existing markers
            if (markerCluster) {
                markerCluster.clearLayers();
            }
            
            mapMarkers = [];
            locationDataMap = {};
            
            if (data.length === 0) {
                updateMapStatistics(0, 0);
                showNotification('Tidak ada data untuk ditampilkan di peta', 'warning');
                return;
            }
            
            // Group data by desa/kecamatan
            let topDesa = { name: '', count: 0 };
            let kelompokData = {}; // Untuk menyimpan data kelompok per lokasi
            
            data.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                if (!locationDataMap[key]) {
                    locationDataMap[key] = {
                        desa: item.desa,
                        kecamatan: item.kecamatan,
                        items: [],
                        totalValue: 0,
                        jenisBantuan: {},
                        tahunDistribusi: {},
                        bantuanList: [],
                        kelompokList: []
                    };
                }
                
                locationDataMap[key].items.push(item);
                const jumlah = parseFloat(item.jumlahBantuan) || 0;
                locationDataMap[key].totalValue += jumlah;
                
                // Count jenis bantuan
                if (!locationDataMap[key].jenisBantuan[item.jenisBantuan]) {
                    locationDataMap[key].jenisBantuan[item.jenisBantuan] = 0;
                }
                locationDataMap[key].jenisBantuan[item.jenisBantuan]++;
                
                // Count by year
                if (!locationDataMap[key].tahunDistribusi[item.tahunAnggaran]) {
                    locationDataMap[key].tahunDistribusi[item.tahunAnggaran] = 0;
                }
                locationDataMap[key].tahunDistribusi[item.tahunAnggaran]++;
                
                // Add to bantuan list
                locationDataMap[key].bantuanList.push({
                    nama: item.nama,
                    jenis: item.jenisBantuan,
                    bantuan: item.namaBantuan,
                    jumlah: item.jumlahBantuan,
                    satuan: item.satuanBantuan,
                    tahun: item.tahunAnggaran,
                    kelompok: item.namaKelompok || 'Tidak ada kelompok',
                    jabatan: item.jabatan || 'Anggota'
                });
                
                // Collect kelompok data
                if (item.namaKelompok && item.namaKelompok !== '-') {
                    if (!kelompokData[item.namaKelompok]) {
                        kelompokData[item.namaKelompok] = {
                            count: 0,
                            desa: item.desa,
                            kecamatan: item.kecamatan
                        };
                    }
                    kelompokData[item.namaKelompok].count++;
                }
                
                // Update top desa
                if (locationDataMap[key].items.length > topDesa.count) {
                    topDesa = { name: key, count: locationDataMap[key].items.length };
                }
            });
            
            // Add kelompok data to locationDataMap
            Object.keys(kelompokData).forEach(kelompokName => {
                const data = kelompokData[kelompokName];
                const key = `${data.desa}, ${data.kecamatan}`;
                if (locationDataMap[key]) {
                    locationDataMap[key].kelompokList.push({
                        nama: kelompokName,
                        jumlahAnggota: data.count
                    });
                }
            });
            
            // Create markers for each location
            const markers = [];
            let totalRecipients = 0;
            let totalValue = 0;
            let locationCount = 0;
            
            // Process locations
            const locations = Object.keys(locationDataMap);
            
            for (let i = 0; i < locations.length; i++) {
                const key = locations[i];
                const locationData = locationDataMap[key];
                
                // Get coordinates
                const coordinates = await getCoordinates(locationData.desa, locationData.kecamatan);
                
                if (!coordinates) {
                    continue;
                }
                
                // Determine marker color based on number of recipients
                let gpsColorClass = 'gps-color-1'; // Default hijau
                const recipientCount = locationData.items.length;
                
                if (recipientCount <= 5) gpsColorClass = 'gps-color-1'; // Hijau
                else if (recipientCount <= 15) gpsColorClass = 'gps-color-2'; // Kuning
                else if (recipientCount <= 30) gpsColorClass = 'gps-color-3'; // Oranye
                else gpsColorClass = 'gps-color-4'; // Merah
                
                // Create GPS marker dengan pulse effect dan icon GPS
                const gpsMarkerHtml = `
                    <div class="gps-marker marker-shadow ${gpsColorClass}">
                        <div class="gps-marker-pulse"></div>
                        <div class="gps-marker-icon">
                            <div class="gps-marker-body">
                                <i class="fas fa-satellite-dish gps-icon"></i>
                            </div>
                            <div class="gps-marker-count">${recipientCount}</div>
                        </div>
                    </div>
                `;
                
                // Format jenis bantuan for popup
                const jenisBantuanHtml = Object.keys(locationData.jenisBantuan)
                    .map(jenis => {
                        const count = locationData.jenisBantuan[jenis];
                        const colorScheme = jenisBantuanColors[jenis] || { bg: '#f8f9fa', text: '#6c757d', icon: 'gift' };
                        return `<span class="jenis-badge" style="background-color: ${colorScheme.bg}; color: ${colorScheme.text};">
                            <i class="fas fa-${colorScheme.icon} me-1"></i>${jenis}: ${count}
                        </span>`;
                    })
                    .join(' ');
                
                // Format tahun distribusi for popup
                const tahunList = Object.keys(locationData.tahunDistribusi)
                    .sort()
                    .map(tahun => `<span class="badge bg-secondary me-1">${tahun}: ${locationData.tahunDistribusi[tahun]}</span>`)
                    .join(' ');
                
                // Rata-rata bantuan per penerima
                const rataBantuan = recipientCount > 0 ? locationData.totalValue / recipientCount : 0;
                
                // Format kelompok informasi
                let kelompokInfoHtml = '';
                if (locationData.kelompokList.length > 0) {
                    kelompokInfoHtml = `
                        <div class="kelompok-info">
                            <div class="kelompok-name">
                                <i class="fas fa-users me-1"></i>Kelompok Nelayan:
                            </div>
                            <div class="kelompok-detail">
                                ${locationData.kelompokList.map(kel => 
                                    `<strong>${kel.nama}</strong> (${kel.jumlahAnggota} anggota)`
                                ).join('<br>')}
                            </div>
                        </div>
                    `;
                }
                
                // Detail informasi untuk popup
                const detailItems = [
                    { label: 'Desa', value: locationData.desa },
                    { label: 'Kecamatan', value: locationData.kecamatan },
                    { label: 'Total Penerima', value: `${recipientCount} orang` },
                    { label: 'Total Nilai Bantuan', value: `Rp ${formatNumber(locationData.totalValue)}` },
                    { label: 'Rata-rata per Penerima', value: `Rp ${formatNumber(rataBantuan.toFixed(0))}` },
                    { label: 'Jumlah Jenis Bantuan', value: `${Object.keys(locationData.jenisBantuan).length} jenis` }
                ];
                
                // Create popup content - VERSI DENGAN GPS MARKER DAN DETAIL LENGKAP
                const popupContent = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h5 class="mb-0"><i class="fas fa-satellite-dish me-2"></i>${locationData.desa}</h5>
                            <div class="subtitle"><i class="fas fa-landmark me-1"></i> ${locationData.kecamatan} | <i class="fas fa-users me-1"></i> ${recipientCount} Penerima</div>
                        </div>
                        
                        <div class="popup-stats-grid">
                            <div class="popup-stat-box">
                                <div class="popup-stat-label">Total Penerima</div>
                                <div class="popup-stat-value total">${recipientCount}</div>
                            </div>
                            <div class="popup-stat-box">
                                <div class="popup-stat-label">Total Nilai</div>
                                <div class="popup-stat-value value">Rp ${formatNumber(locationData.totalValue)}</div>
                            </div>
                            <div class="popup-stat-box">
                                <div class="popup-stat-label">Rata-rata</div>
                                <div class="popup-stat-value">Rp ${formatNumber(rataBantuan.toFixed(0))}</div>
                            </div>
                            <div class="popup-stat-box">
                                <div class="popup-stat-label">Jenis Bantuan</div>
                                <div class="popup-stat-value">${Object.keys(locationData.jenisBantuan).length}</div>
                            </div>
                        </div>
                        
                        <div class="popup-section">
                            <div class="popup-section-title"><i class="fas fa-info-circle me-1"></i> Detail Informasi</div>
                            <div class="detail-list">
                                ${detailItems.map(item => `
                                    <div class="detail-item">
                                        <span class="detail-label">${item.label}:</span>
                                        <span class="detail-value">${item.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${kelompokInfoHtml}
                        
                        <div class="popup-section">
                            <div class="popup-section-title"><i class="fas fa-gift me-1"></i> Jenis Bantuan</div>
                            <div class="jenis-bantuan-list">
                                ${jenisBantuanHtml}
                            </div>
                        </div>
                        
                        <div class="popup-section">
                            <div class="popup-section-title"><i class="fas fa-calendar-alt me-1"></i> Distribusi per Tahun</div>
                            <div class="tahun-distribusi">
                                ${tahunList}
                            </div>
                        </div>
                        
                        <div class="popup-actions">
                            <button class="popup-btn popup-btn-primary" onclick="showLocationDetail('${locationData.desa}', '${locationData.kecamatan}')">
                                <i class="fas fa-list me-1"></i> Detail Penerima
                            </button>
                            <button class="popup-btn popup-btn-secondary" onclick="zoomToLocation(${coordinates.lat}, ${coordinates.lng})">
                                <i class="fas fa-search-plus me-1"></i> Zoom
                            </button>
                        </div>
                    </div>
                `;
                
                // Create custom icon dengan efek GPS
                const icon = L.divIcon({
                    className: 'pulse-marker',
                    html: gpsMarkerHtml,
                    iconSize: [50, 50],
                    iconAnchor: [25, 50],
                    popupAnchor: [0, -50]
                });
                
                // Create marker dengan event hover
                const marker = L.marker([coordinates.lat, coordinates.lng], { 
                    icon: icon,
                    title: `${locationData.desa}, ${locationData.kecamatan} - ${recipientCount} penerima bantuan`
                }).bindPopup(popupContent);
                
                // Add hover effect
                marker.on('mouseover', function() {
                    const markerElement = this.getElement();
                    if (markerElement) {
                        markerElement.classList.add('marker-hover');
                    }
                });
                
                marker.on('mouseout', function() {
                    const markerElement = this.getElement();
                    if (markerElement) {
                        markerElement.classList.remove('marker-hover');
                    }
                });
                
                markers.push(marker);
                mapMarkers.push(marker);
                
                totalRecipients += recipientCount;
                totalValue += locationData.totalValue;
                locationCount++;
            }
            
            // Add markers to cluster group
            markerCluster.addLayers(markers);
            map.addLayer(markerCluster);
            
            // Update map statistics
            updateMapStatistics(locationCount, totalRecipients, totalValue, topDesa.name);
            
            // Fit bounds to show all markers with padding
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.15));
            }
            
            // Update heatmap
            updateHeatmapLayer(data);
            
            showNotification(`Peta berhasil dimuat: ${locationCount} lokasi ditampilkan`, 'success');
        }
        
        function addKecamatanBoundaries() {
            if (!map) return;
            
            // Add kecamatan center markers
            Object.keys(koordinatKecamatan).forEach(kecamatan => {
                const coords = koordinatKecamatan[kecamatan];
                
                const kecamatanIcon = L.divIcon({
                    className: 'kecamatan-marker',
                    html: `<div style="
                        background-color: #005f73; 
                        width: 15px; 
                        height: 15px; 
                        border-radius: 50%; 
                        border: 2px solid white;
                        box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [19, 19],
                    iconAnchor: [9, 9]
                });
                
                const marker = L.marker([coords.lat, coords.lng], { 
                    icon: kecamatanIcon,
                    title: kecamatan 
                }).addTo(map);
                
                marker.bindTooltip(`<strong>${kecamatan}</strong>`, {
                    permanent: false,
                    direction: 'top',
                    className: 'kecamatan-tooltip'
                });
                
                mapMarkers.push(marker);
            });
            
            kecamatanLayer = L.layerGroup(mapMarkers.filter(m => m.options.icon?.options.className === 'kecamatan-marker'));
        }
        
        function addHeatmapLayer() {
            if (!map) return;
            
            // Create heatmap layer
            heatmapLayer = L.layerGroup().addTo(map);
        }
        
        function updateHeatmapLayer(data) {
            if (!heatmapLayer || !map) return;
            
            // Clear existing heatmap
            heatmapLayer.clearLayers();
            
            if (data.length === 0) return;
            
            // Create heatmap points
            const heatPoints = [];
            
            data.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                const coordinates = koordinatDesa[key] || koordinatKecamatan[item.kecamatan];
                
                if (coordinates) {
                    // Weight based on jumlah bantuan
                    const weight = parseFloat(item.jumlahBantuan) || 1;
                    heatPoints.push([coordinates.lat, coordinates.lng, Math.min(weight / 1000000, 1)]);
                }
            });
            
            // Create heatmap using circle markers
            heatPoints.forEach(point => {
                const [lat, lng, intensity] = point;
                const radius = 30 + (intensity * 70);
                const opacity = 0.3 + (intensity * 0.3);
                
                L.circle([lat, lng], {
                    radius: radius,
                    fillColor: '#ff7800',
                    color: '#ff5500',
                    weight: 0,
                    fillOpacity: opacity
                }).addTo(heatmapLayer);
            });
        }
        
        function toggleHeatmapLayer() {
            const toggle = document.getElementById('toggleHeatmap');
            if (!heatmapLayer || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(heatmapLayer);
            } else {
                map.removeLayer(heatmapLayer);
            }
            
            showNotification(`Heatmap ${toggle.checked ? 'diaktifkan' : 'dinonaktifkan'}`, 'info');
        }
        
        function toggleMarkersLayer() {
            const toggle = document.getElementById('toggleMarkers');
            if (!markerCluster || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(markerCluster);
            } else {
                map.removeLayer(markerCluster);
            }
            
            showNotification(`Marker GPS ${toggle.checked ? 'diaktifkan' : 'dinonaktifkan'}`, 'info');
        }
        
        function toggleKecamatanLayer() {
            const toggle = document.getElementById('toggleKecamatan');
            if (!kecamatanLayer || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(kecamatanLayer);
            } else {
                map.removeLayer(kecamatanLayer);
            }
            
            showNotification(`Layer kecamatan ${toggle.checked ? 'diaktifkan' : 'dinonaktifkan'}`, 'info');
        }
        
        function changeMapType(type) {
            currentMapType = type;
            
            // Update button states
            document.getElementById('btnMapRoad').classList.remove('active');
            document.getElementById('btnMapSatellite').classList.remove('active');
            document.getElementById('btnMapHybrid').classList.remove('active');
            
            if (type === 'roadmap') {
                document.getElementById('btnMapRoad').classList.add('active');
            } else if (type === 'satellite') {
                document.getElementById('btnMapSatellite').classList.add('active');
            } else if (type === 'hybrid') {
                document.getElementById('btnMapHybrid').classList.add('active');
            }
            
            // Update Google Maps layer
            if (googleLayer) {
                map.removeLayer(googleLayer);
                googleLayer = L.gridLayer.googleMutant({
                    type: type
                }).addTo(map);
            }
            
            showNotification(`Tipe peta diubah ke: ${type}`, 'success');
        }
        
        function locateUser() {
            if (!map) return;
            
            if (!navigator.geolocation) {
                showNotification('Geolocation tidak didukung oleh browser Anda', 'error');
                return;
            }
            
            showNotification('Mendeteksi lokasi Anda...', 'info');
            
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Add marker for user location
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: `<div style="
                        background-color: #005f73;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                    ">
                        <i class="fas fa-user"></i>
                    </div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });
                
                // Remove existing user marker if any
                map.eachLayer(function(layer) {
                    if (layer.options && layer.options.icon === userIcon) {
                        map.removeLayer(layer);
                    }
                });
                
                // Add new marker
                L.marker([lat, lng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<strong>Lokasi Anda</strong>')
                    .openPopup();
                
                // Pan to user location
                map.setView([lat, lng], 13);
                
                showNotification('Lokasi Anda berhasil ditampilkan', 'success');
            }, function(error) {
                let errorMessage = 'Gagal mendapatkan lokasi Anda';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Akses lokasi ditolak. Izinkan akses lokasi di pengaturan browser.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Informasi lokasi tidak tersedia.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Permintaan lokasi waktu habis.';
                        break;
                }
                showNotification(errorMessage, 'error');
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
        
        function updateMapStatistics(pointCount, recipients, value, topDesaName) {
            document.getElementById('mapPointCount').textContent = pointCount;
            document.getElementById('mapTotalRecipients').textContent = recipients;
            document.getElementById('mapTotalValue').textContent = `Rp ${formatNumber(value)}`;
            
            if (topDesaName) {
                const desaName = topDesaName.split(',')[0];
                document.getElementById('topDesa').textContent = desaName;
            }
        }
        
        function showLocationDetail(desa, kecamatan) {
            const key = `${desa}, ${kecamatan}`;
            const locationData = locationDataMap[key];
            
            if (!locationData || locationData.items.length === 0) {
                alert('Data tidak ditemukan untuk lokasi ini');
                return;
            }
            
            // Create detail content dengan desain yang lebih baik
            let detailContent = `
                <div class="p-3">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-satellite-dish fa-lg"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-0">${desa}</h4>
                            <p class="text-muted mb-0">${kecamatan}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title text-primary"><i class="fas fa-chart-bar me-2"></i>Statistik Lokasi</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Total Penerima:</small><br>
                                            <strong class="text-primary fs-5">${locationData.items.length}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Total Nilai:</small><br>
                                            <strong class="text-success fs-5">Rp ${formatNumber(locationData.totalValue)}</strong>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-12">
                                            <small class="text-muted">Rata-rata per Penerima:</small><br>
                                            <strong class="text-info">Rp ${formatNumber(Math.round(locationData.totalValue / locationData.items.length))}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6 class="card-title text-info"><i class="fas fa-gift me-2"></i>Jenis Bantuan</h6>
                                    <div class="d-flex flex-wrap gap-2">
            `;
            
            // Add jenis bantuan badges dengan ikon
            Object.keys(locationData.jenisBantuan).forEach(jenis => {
                const count = locationData.jenisBantuan[jenis];
                const colorScheme = jenisBantuanColors[jenis] || { bg: '#f8f9fa', text: '#6c757d', icon: 'gift' };
                detailContent += `
                    <span class="badge py-2 px-3" style="background-color: ${colorScheme.bg}; color: ${colorScheme.text};">
                        <i class="fas fa-${colorScheme.icon} me-1"></i>${jenis}: ${count}
                    </span>
                `;
            });
            
            detailContent += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-warning mb-4">
                        <div class="card-body">
                            <h6 class="card-title text-warning"><i class="fas fa-calendar-alt me-2"></i>Distribusi per Tahun</h6>
                            <div class="d-flex flex-wrap gap-2">
            `;
            
            // Add tahun distribusi
            Object.keys(locationData.tahunDistribusi)
                .sort()
                .forEach(tahun => {
                    const count = locationData.tahunDistribusi[tahun];
                    detailContent += `
                        <span class="badge bg-warning text-dark py-2 px-3">
                            <i class="fas fa-calendar me-1"></i>${tahun}: ${count} penerima
                        </span>
                    `;
                });
            
            detailContent += `
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold mb-3 border-bottom pb-2"><i class="fas fa-users me-2"></i>Daftar Penerima Bantuan (${locationData.items.length} orang)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>No</th>
                                    <th>Nama Penerima</th>
                                    <th>Kelompok</th>
                                    <th>Jabatan</th>
                                    <th>Jenis Bantuan</th>
                                    <th>Jumlah</th>
                                    <th>Tahun</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Sort by nama
            const sortedItems = [...locationData.bantuanList].sort((a, b) => a.nama.localeCompare(b.nama));
            
            sortedItems.forEach((item, index) => {
                const colorScheme = jenisBantuanColors[item.jenis] || { bg: '#f8f9fa', text: '#6c757d', icon: 'gift' };
                detailContent += `
                    <tr>
                        <td class="fw-bold">${index + 1}</td>
                        <td class="fw-bold text-primary">${item.nama}</td>
                        <td>${item.kelompok || '-'}</td>
                        <td>${item.jabatan || 'Anggota'}</td>
                        <td><span class="badge py-1 px-2" style="background-color: ${colorScheme.bg}; color: ${colorScheme.text};">${item.jenis}</span></td>
                        <td class="fw-bold">${formatNumber(item.jumlah)} ${item.satuan || ''}</td>
                        <td><span class="badge bg-secondary">${item.tahun}</span></td>
                    </tr>
                `;
            });
            
            detailContent += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <small class="text-muted">Terakhir diperbarui: ${new Date().toLocaleDateString('id-ID')}</small>
                    </div>
                </div>
            `;
            
            // Update modal content and show
            const locationDetailContent = document.getElementById('locationDetailContent');
            if (locationDetailContent) {
                locationDetailContent.innerHTML = detailContent;
                new bootstrap.Modal(document.getElementById('locationDetailModal')).show();
            }
        }
        
        function zoomToLocation(lat, lng) {
            if (!map) return;
            
            map.setView([lat, lng], 15);
            showNotification('Memperbesar ke lokasi yang dipilih', 'info');
        }
        
        async function applyMapFilter() {
            const filterType = document.getElementById('mapFilterType').value;
            const filterValue = document.getElementById('mapFilterValue').value;
            
            if (filterType === 'all') {
                // Show all data
                await updateMapWithData(appData);
            } else {
                // Filter data
                let filteredMapData = [];
                
                if (filterType === 'kecamatan' && filterValue) {
                    filteredMapData = appData.filter(item => item.kecamatan === filterValue);
                } else if (filterType === 'tahun' && filterValue) {
                    filteredMapData = appData.filter(item => item.tahunAnggaran == filterValue);
                } else if (filterType === 'jenis' && filterValue) {
                    filteredMapData = appData.filter(item => item.jenisBantuan === filterValue);
                } else if (filterType === 'desa' && filterValue) {
                    filteredMapData = appData.filter(item => item.desa === filterValue);
                } else {
                    filteredMapData = appData;
                }
                
                await updateMapWithData(filteredMapData);
                showNotification(`Filter diterapkan: ${filteredMapData.length} data ditampilkan`, 'success');
            }
        }
        
        async function resetMapFilter() {
            document.getElementById('mapFilterType').value = 'all';
            document.getElementById('mapFilterValueContainer').style.display = 'none';
            await updateMapWithData(appData);
            showNotification('Filter peta direset', 'info');
        }
        
        async function searchMapLocation() {
            const searchTerm = document.getElementById('mapSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                showNotification('Masukkan nama desa atau kecamatan untuk dicari', 'warning');
                return;
            }
            
            // Search in coordinates database
            let foundLocation = null;
            let foundKey = null;
            
            // Search in all possible keys
            const allKeys = [...Object.keys(koordinatDesa), ...Object.keys(koordinatKecamatan), ...Object.keys(coordinatesCache)];
            
            for (const key of allKeys) {
                if (key.toLowerCase().includes(searchTerm)) {
                    foundKey = key;
                    break;
                }
            }
            
            if (foundKey) {
                // Get coordinates from the appropriate source
                if (koordinatDesa[foundKey]) {
                    foundLocation = { key: foundKey, coords: koordinatDesa[foundKey] };
                } else if (coordinatesCache[foundKey]) {
                    foundLocation = { key: foundKey, coords: coordinatesCache[foundKey] };
                } else if (koordinatKecamatan[foundKey]) {
                    foundLocation = { key: foundKey, coords: koordinatKecamatan[foundKey] };
                }
            }
            
            if (foundLocation) {
                // Zoom to location
                map.setView([foundLocation.coords.lat, foundLocation.coords.lng], 14);
                
                // Open popup if there's data for this location
                const dataForLocation = appData.filter(item => {
                    const itemKey = `${item.desa}, ${item.kecamatan}`;
                    return itemKey.includes(foundLocation.key) || item.kecamatan === foundLocation.key;
                });
                
                if (dataForLocation.length > 0) {
                    // Find and open marker popup
                    mapMarkers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (markerLatLng.lat.toFixed(4) === foundLocation.coords.lat.toFixed(4) &&
                            markerLatLng.lng.toFixed(4) === foundLocation.coords.lng.toFixed(4)) {
                            marker.openPopup();
                        }
                    });
                }
                
                showNotification(`Lokasi ditemukan: ${foundLocation.key}`, 'success');
            } else {
                // Jika tidak ditemukan, coba geocoding
                showNotification('Mencari koordinat untuk: ' + searchTerm, 'info');
                
                try {
                    const coords = await geocodeLocation(searchTerm + ', Situbondo, Jawa Timur, Indonesia');
                    if (coords) {
                        // Cache the coordinates
                        const newKey = searchTerm;
                        coordinatesCache[newKey] = coords;
                        saveCoordinatesCache();
                        
                        // Zoom to location
                        map.setView([coords.lat, coords.lng], 14);
                        showNotification(`Lokasi ditemukan via geocoding: ${newKey}`, 'success');
                    } else {
                        showNotification('Lokasi tidak ditemukan', 'error');
                    }
                } catch (error) {
                    showNotification('Gagal mencari lokasi: ' + error.message, 'error');
                }
            }
        }
        
        function clearMapSearch() {
            document.getElementById('mapSearch').value = '';
        }
        
        // --- RELOAD DATA ---
        function handleReloadFromRepo(callback) {
            const btn = document.getElementById('btn-reload-repo');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin feature-icon me-2"></i> Loading...';
            btn.disabled = true;

            const oldScript = document.querySelector('#reload-script');
            if(oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'reload-script';
            script.src = './reload.js?v=' + new Date().getTime(); 

            script.onload = function() {
                try {
                    if (window.BARJAS_BACKUP_ENCRYPTED) {
                        const rawContent = window.BARJAS_BACKUP_ENCRYPTED;
                        let restored;
                        try {
                            if (typeof rawContent === 'string') {
                                restored = JSON.parse(decodeURIComponent(escape(atob(rawContent))));
                            } else {
                                restored = rawContent;
                            }
                        } catch (decryptionError) {
                            throw new Error("Gagal mendekripsi data.");
                        }
                        
                        if(restored && restored.appData && Array.isArray(restored.appData)) {
                            
                            const existingIds = new Set(appData.map(item => item.id));
                            let addedCount = 0;

                            restored.appData.forEach(newItem => {
                                if (!existingIds.has(newItem.id)) {
                                    appData.push(newItem);
                                    existingIds.add(newItem.id); 
                                    addedCount++;
                                }
                            });

                            saveData();
                            updateDashboard();
                            renderDataTable();
                            extractDesaList();
                            
                            // Update map if it's currently visible
                            if (document.getElementById('v-pills-map').classList.contains('active')) {
                                updateMapWithData(appData);
                            }
                            
                            if (addedCount > 0) {
                                showNotification(`Berhasil reload! ${addedCount} data baru ditambahkan.`, 'success');
                            } else {
                                showNotification('Reload selesai. Tidak ada data baru yang ditemukan.', 'info');
                            }

                        } else {
                            throw new Error('Format data tidak valid.');
                        }
                    } else {
                        throw new Error('Variabel backup tidak ditemukan di reload.js.');
                    }
                } catch (e) {
                    showNotification('Error: ' + e.message, 'error');
                } finally {
                    btn.innerHTML = '<i class="fas fa-sync-alt feature-icon me-2"></i> Reload Data';
                    btn.disabled = false;
                    delete window.BARJAS_BACKUP_ENCRYPTED;
                    
                    if (callback) callback();
                }
            };

            script.onerror = function() {
                showNotification('Gagal memuat file reload.js. Pastikan file ada di folder yang sama.', 'error');
                btn.innerHTML = '<i class="fas fa-sync-alt feature-icon me-2"></i> Reload Data';
                btn.disabled = false;
                
                if (callback) callback();
            };
            document.body.appendChild(script);
        }

        // --- UTILS ---
        function showNotification(message, type = 'info') {
            if (!appSettings.notifications) return;
            
            const toastEl = document.querySelector('.notification-toast');
            if (!toastEl) return;
            
            const toastHeader = toastEl.querySelector('.toast-header');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toastMessage) return;
            
            toastMessage.textContent = message;
            
            const styles = {
                success: { bg: 'bg-success-subtle', text: 'text-success-emphasis', title: 'Berhasil' },
                error: { bg: 'bg-danger-subtle', text: 'text-danger-emphasis', title: 'Gagal' },
                warning: { bg: 'bg-warning-subtle', text: 'text-warning-emphasis', title: 'Peringatan' },
                info: { bg: 'bg-primary-subtle', text: 'text-primary-emphasis', title: 'Informasi' }
            };
            
            if (toastHeader) {
                toastHeader.className = `toast-header ${styles[type].bg} ${styles[type].text}`;
            }
            
            if (toastTitle) {
                toastTitle.textContent = styles[type].title;
            }
            
            try {
                new bootstrap.Toast(toastEl).show();
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function formatNumber(num) {
            if (isNaN(num) || num === undefined || num === null) return num; 
            try {
                return new Intl.NumberFormat('id-ID').format(num);
            } catch (error) {
                return num;
            }
        }
        
        function formatPrivacy(value) {
            if (!appSettings.privacyMode) return value;
            if (!value) return '-';
            const str = String(value);
            if (str.length <= 4) return '****';
            return str.slice(0, -4) + '****';
        }

        // Ekspor fungsi ke global scope
        window.showLocationDetail = showLocationDetail;
        window.changePage = changePage;
        window.zoomToLocation = zoomToLocation;
    </script>
</body>
</html>
