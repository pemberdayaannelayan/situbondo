<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETA STATISTIK DATA NELAYAN - KAB. SITUBONDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    
    <style>
        :root {
            /* Palette: Blue, Green, Gold */
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ca6702;
            --dark-blue: #001219;
            --light-bg: #f0f4f8;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            --gradient-header: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            --gradient-secondary: linear-gradient(135deg, #0a9396, #94d2bd);
            --gradient-accent: linear-gradient(135deg, #ca6702, #ee9b00);
            
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.15);
            --glass-effect: rgba(255, 255, 255, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Header */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #ee9b00;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .app-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: #ffecd1;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
            padding-top: 10px;
        }
        
        /* Navigation */
        .col-md-3.col-lg-2.bg-light {
            background-color: #f8f9fa !important;
            border-right: 1px solid #e9ecef;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 14px 20px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #e3f2fd;
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-left: 4px solid #ee9b00;
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
            color: white;
        }

        /* Content Styling */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid #ee9b00;
            padding-left: 15px;
            margin: 25px 0;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 1.6rem;
            position: relative;
            background: linear-gradient(to right, rgba(238, 155, 0, 0.1), transparent);
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            padding: 10px 20px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 95, 115, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #001219 0%, #004d40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 95, 115, 0.4);
        }
        
        /* Tables */
        .data-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: none;
            white-space: nowrap;
        }
        
        .data-table th {
            background: linear-gradient(90deg, #005f73, #0a9396) !important;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
        }
        
        .data-table td {
            border-bottom: 1px solid #e9ecef;
            padding: 12px 10px;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: #e0f2f1;
        }
        
        /* Cards & Stats */
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-sm);
            background: white;
        }
        
        .card-header {
            background: linear-gradient(90deg, #005f73, #001219);
            color: white;
            font-weight: 600;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        
        .stats-box {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border-left: 5px solid var(--accent-color);
            transition: transform 0.3s;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Footer */
        .copyright {
            background-color: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }
        
        .feature-icon {
            width: 25px;
            text-align: center;
        }

        /* Utils */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1050; min-width: 280px; }
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.8; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-weight: 300; letter-spacing: 1px;}
        
        /* Floating Button */
        .floating-action-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1045;
            transition: all 0.4s;
            font-size: 1.4rem;
            border: none;
            box-shadow: 0 5px 15px rgba(202, 103, 2, 0.4);
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            background: #ee9b00;
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.4);
        }

        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1050; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; box-shadow: var(--shadow-lg); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        /* Map Styling */
        #map {
            height: 700px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            z-index: 1;
            position: relative;
        }
        
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            max-width: 350px;
            min-width: 300px;
        }
        
        .leaflet-popup-content h4 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
        }
        
        .map-legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 280px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            max-width: 320px;
        }
        
        .cluster-marker {
            background: var(--primary-color);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.3);
        }
        
        /* Heatmap Layer Controls */
        .heatmap-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 320px;
        }
        
        /* Data Summary Panel */
        .data-summary-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            max-width: 350px;
        }
        
        /* Map Loading Overlay */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            border-radius: 10px;
        }
        
        /* Layer Controls */
        .layer-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            position: absolute;
            top: 150px;
            right: 20px;
            z-index: 1000;
            max-width: 200px;
        }
        
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; }
            .col-md-3.col-lg-2 { position: fixed; left: -300px; top: 0; bottom: 0; z-index: 1050; width: 280px; transition: left 0.3s ease; overflow-y: auto; padding-top: 60px; background: white; }
            .col-md-3.col-lg-2.mobile-show { left: 0; }
            .col-md-9.col-lg-10 { width: 100%; flex: 0 0 100%; max-width: 100%; }
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar-overlay.mobile-show { display: block; }
            .app-title { font-size: 1.3rem; line-height: 1.3; }
            .app-logo { font-size: 2.5rem; margin-bottom: 10px; }
            .app-header { padding: 70px 15px 30px 15px; }
            .col-md-9.col-lg-10.p-5 { padding: 1.5rem !important; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .floating-action-btn { bottom: 20px; right: 20px; }
            #map { height: 500px; }
            .map-controls, .map-legend, .heatmap-controls, .data-summary-panel, .layer-controls { 
                position: relative; 
                top: auto; 
                bottom: auto; 
                right: auto; 
                left: auto;
                margin-bottom: 15px; 
                max-width: 100%; 
            }
        }

        /* Logo */
        .logo-garuda {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        /* Welcome Modal */
        .welcome-modal {
            background: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            color: white;
        }
        
        .welcome-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ee9b00;
        }
        
        .welcome-modal .btn-welcome {
            background: linear-gradient(90deg, #ee9b00, #ca6702);
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .welcome-modal .btn-welcome:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.3);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        /* Map Marker Animation */
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Search Box */
        .search-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 400px;
            max-width: 90%;
        }
        
        /* Marker Cluster Customization */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }

        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }

        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }
    </style>
</head>
<body>
    <!-- Welcome Modal (Tanpa Login) -->
    <div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda mb-4">
                    <h3 class="fw-bold mb-3">Selamat Datang</h3>
                    <p id="welcomeMessage">Sistem Peta Statistik Data Nelayan Kabupaten Situbondo</p>
                    
                    <div class="spinner-border text-primary mt-4" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    
                    <div class="mt-4 small text-white-50">
                        <i class="fas fa-info-circle me-1"></i>
                        Sistem akan otomatis memuat data terbaru
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content" id="appContent">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda">
                </div>
                <h1 class="app-title">PETA STATISTIK DATA NELAYAN<br>KABUPATEN SITUBONDO</h1>
                <p class="app-subtitle">Dinas Peternakan dan Perikanan Kabupaten Situbondo</p>
                <div class="watermark">Public Access Edition v3.0</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-4 bg-light" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button" role="tab">
                            <i class="fas fa-tachometer-alt feature-icon"></i> Dashboard
                        </button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button" role="tab">
                            <i class="fas fa-database feature-icon"></i> Data Bantuan
                        </button>
                        <button class="nav-link" id="v-pills-map-tab" data-bs-toggle="pill" data-bs-target="#v-pills-map" type="button" role="tab">
                            <i class="fas fa-map-marked-alt feature-icon"></i> Visual Peta
                        </button>
                        <button class="nav-link" id="btn-reload-repo" type="button">
                            <i class="fas fa-sync-alt feature-icon"></i> Reload Data
                        </button>
                        <button class="nav-link text-info mt-3" id="btn-about" type="button" style="border: 1px solid #0dcaf0;">
                            <i class="fas fa-info-circle feature-icon"></i> Tentang
                        </button>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-5">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                            <h3 class="section-title">Dashboard Overview</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Penerima</div>
                                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold" id="totalPenerima">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: var(--secondary-color);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Bantuan (Rp)</div>
                                            <i class="fas fa-money-bill-wave fa-2x text-success opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-success" id="totalBantuan">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #ffc107;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Tahun Aktif</div>
                                            <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-warning" id="tahunAktif">2025</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #17a2b8;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Rata-rata</div>
                                            <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-info" id="rataBantuan">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Distribusi per Kecamatan</div>
                                        <div class="card-body"><canvas id="kecamatanChart" height="250"></canvas></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Tren Bantuan Tahunan</div>
                                        <div class="card-body"><canvas id="tahunChart" height="250"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-history me-2"></i> Transaksi Terbaru</div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover data-table mb-0">
                                                    <thead><tr><th>Tanggal</th><th>Nama Penerima</th><th>Desa</th><th>Jenis Bantuan</th><th>Jumlah</th></tr></thead>
                                                    <tbody id="recentData"><tr><td colspan="5" class="text-center p-4">Tidak ada data</td></tr></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data" role="tabpanel">
                            <h3 class="section-title">Database Bantuan (View Only)</h3>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <span><i class="fas fa-database me-2"></i> Daftar Penerima Bantuan Nelayan</span>
                                    <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
                                        <div class="input-group" style="max-width: 300px;">
                                            <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari data...">
                                            <button class="btn btn-sm btn-light border" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>Kelompok</th>
                                                    <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                                    <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="13" class="text-center py-4">Memuat data...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TAB PANEL: Visual Peta -->
                        <div class="tab-pane fade" id="v-pills-map" role="tabpanel">
                            <h3 class="section-title">Visualisasi Peta Statistik Data Nelayan</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-map-marked-alt me-2"></i> Peta Sebaran Data Bantuan Nelayan Kabupaten Situbondo</div>
                                <div class="card-body p-0 position-relative">
                                    <!-- Search Box -->
                                    <div class="search-box">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="mapSearch" placeholder="Cari desa/kecamatan...">
                                            <button class="btn btn-primary" id="searchMapBtn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" id="clearMapSearchBtn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Map Container -->
                                    <div id="map">
                                        <div class="map-loading d-none" id="mapLoading">
                                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p>Memuat peta...</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Data Summary Panel -->
                                    <div class="data-summary-panel">
                                        <h6 class="fw-bold mb-3 text-primary">Statistik Peta</h6>
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <div class="small text-muted">Titik Data</div>
                                                <div class="fw-bold" id="mapPointCount">0</div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <div class="small text-muted">Total Penerima</div>
                                                <div class="fw-bold" id="mapTotalRecipients">0</div>
                                            </div>
                                            <div class="col-12 mb-2">
                                                <div class="small text-muted">Total Nilai Bantuan</div>
                                                <div class="fw-bold text-success" id="mapTotalValue">Rp 0</div>
                                            </div>
                                            <div class="col-12">
                                                <div class="small text-muted">Desa Terbanyak Bantuan</div>
                                                <div class="fw-bold text-warning" id="topDesa">-</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Map Controls -->
                                    <div class="map-controls">
                                        <h6 class="fw-bold mb-3">Kontrol Peta</h6>
                                        <div class="mb-3">
                                            <label class="form-label small">Tampilkan berdasarkan:</label>
                                            <select class="form-select form-select-sm" id="mapFilterType">
                                                <option value="all">Semua Data</option>
                                                <option value="kecamatan">Kecamatan</option>
                                                <option value="tahun">Tahun</option>
                                                <option value="jenis">Jenis Bantuan</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="mapFilterValueContainer" style="display: none;">
                                            <select class="form-select form-select-sm" id="mapFilterValue"></select>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary btn-sm" id="applyMapFilter">
                                                <i class="fas fa-filter me-1"></i> Terapkan Filter
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" id="resetMapFilter">
                                                <i class="fas fa-undo me-1"></i> Reset Filter
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Map Legend -->
                                    <div class="map-legend">
                                        <h6 class="fw-bold mb-3">Legenda Peta</h6>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #2ecc71;"></div>
                                            <span>1-5 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #f1c40f;"></div>
                                            <span>6-15 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #e67e22;"></div>
                                            <span>16-30 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #e74c3c;"></div>
                                            <span>31+ Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #005f73; border: 2px solid #001219;"></div>
                                            <span>Pusat Kecamatan</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Layer Controls -->
                                    <div class="heatmap-controls">
                                        <h6 class="fw-bold mb-3">Layer Peta</h6>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="toggleHeatmap" checked>
                                            <label class="form-check-label small" for="toggleHeatmap">Tampilkan Heatmap</label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="toggleMarkers" checked>
                                            <label class="form-check-label small" for="toggleMarkers">Tampilkan Marker</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="toggleKecamatan" checked>
                                            <label class="form-check-label small" for="toggleKecamatan">Tampilkan Kecamatan</label>
                                        </div>
                                    </div>
                                    
                                    <!-- Layer Type Controls -->
                                    <div class="layer-controls">
                                        <h6 class="fw-bold mb-3">Jenis Peta</h6>
                                        <div class="btn-group-vertical w-100" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary active" id="btnMapRoad">Jalan</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnMapSatellite">Satelit</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnMapHybrid">Hybrid</button>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-success w-100" id="btnLocateMe">
                                                <i class="fas fa-location-arrow me-1"></i> Lokasi Saya
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header"><i class="fas fa-info-circle me-2"></i> Informasi Peta</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6>Panduan Penggunaan:</h6>
                                            <ul class="mb-0">
                                                <li>Klik pada marker untuk melihat detail data penerima per desa</li>
                                                <li>Gunakan kontrol filter untuk menampilkan data spesifik</li>
                                                <li>Gunakan search box untuk mencari desa atau kecamatan tertentu</li>
                                                <li>Heatmap menunjukkan kerapatan distribusi bantuan</li>
                                                <li>Marker berwarna menunjukkan intensitas jumlah penerima</li>
                                                <li>Gunakan tombol "Lokasi Saya" untuk melihat posisi Anda di peta</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Keterangan Warna:</h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <span class="badge" style="background-color: #2ecc71;">Rendah</span>
                                                <span class="badge" style="background-color: #f1c40f;">Sedang</span>
                                                <span class="badge" style="background-color: #e67e22;">Tinggi</span>
                                                <span class="badge" style="background-color: #e74c3c;">Sangat Tinggi</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright text-center py-3">
                &copy; 2025 Dinas Peternakan dan Perikanan Kabupaten Situbondo - Bidang Pemberdayaan Nelayan.
            </div>
        </div>
        
        <button class="floating-action-btn" id="fabBtn" title="Buka Peta Statistik">
            <i class="fas fa-map-marked-alt"></i>
        </button>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast notification-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Detail Lokasi -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i> Detail Data Lokasi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="locationDetailContent">
                        <p class="text-center">Memuat data...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal About -->
    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i> Tentang Aplikasi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                             alt="Logo Garuda" class="logo-garuda mb-3">
                        <h5>Peta Statistik Data Nelayan</h5>
                        <p class="text-muted">Kabupaten Situbondo</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6><i class="fas fa-cogs me-2 text-primary"></i> Fitur Aplikasi:</h6>
                        <ul class="mb-0">
                            <li>Dashboard statistik lengkap</li>
                            <li>Database penerima bantuan nelayan</li>
                            <li>Visualisasi peta interaktif</li>
                            <li>Filter data berdasarkan kecamatan, tahun, dan jenis bantuan</li>
                            <li>Pencarian lokasi dan data</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-code me-2 text-primary"></i> Teknologi:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary">HTML5</span>
                            <span class="badge bg-success">CSS3</span>
                            <span class="badge bg-warning">JavaScript</span>
                            <span class="badge bg-info">Leaflet.js</span>
                            <span class="badge bg-danger">Chart.js</span>
                            <span class="badge bg-secondary">Bootstrap 5</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Versi:</strong> 3.0 | <strong>Update:</strong> Maret 2025
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        let appData = [];
        let appSettings = {
            itemsPerPage: 25,
            notifications: true,
            appName: 'PETA STATISTIK DATA NELAYAN',
            appSubtitle: 'Dinas Peternakan dan Perikanan Kab. Situbondo',
            defaultTahun: new Date().getFullYear(),
            privacyMode: true
        };
        let currentPage = 1;
        let filteredData = [];
        let isFilterActive = false;
        
        // Variables for map
        let map = null;
        let mapMarkers = [];
        let mapLayer = null;
        let heatmapLayer = null;
        let kecamatanLayer = null;
        let markerCluster = null;
        let currentMapType = 'roadmap';
        
        // Cache for coordinates
        let coordinatesCache = {};

        const kecamatanList = [
            "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", 
            "Bungatan", "Jangkar", "Jatibanteng", "Kapongan", "Kendit", 
            "Mangaran", "Mlandingan", "Panarukan", "Panji", "Situbondo", 
            "Suboh", "Sumbermalang"
        ];
        
        // ==================== DATABASE KOORDINAT YANG SANGAT AKURAT ====================
// Database koordinat kecamatan yang AKURAT untuk Kabupaten Situbondo
const koordinatKecamatan = {
    "Arjasa": { lat: -7.7069, lng: 113.6347 }, // BENAR
    "Asembagus": { lat: -7.7536, lng: 114.1561 },
    "Banyuglugur": { lat: -7.7211, lng: 113.8883 },
    "Banyuputih": { lat: -7.7608, lng: 114.0200 },
    "Besuki": { lat: -7.7333, lng: 113.7000 },
    "Bungatan": { lat: -7.6833, lng: 113.8833 }, // BENAR
    "Jangkar": { lat: -7.7500, lng: 114.0833 },
    "Jatibanteng": { lat: -7.7167, lng: 113.9833 },
    "Kapongan": { lat: -7.6833, lng: 114.0167 },
    "Kendit": { lat: -7.7333, lng: 113.9333 },
    "Mangaran": { lat: -7.6667, lng: 114.0667 },
    "Mlandingan": { lat: -7.6833, lng: 113.9500 },
    "Panarukan": { lat: -7.7000, lng: 113.9167 },
    "Panji": { lat: -7.7167, lng: 113.6667 }, // BENAR
    "Situbondo": { lat: -7.7062, lng: 113.9603 },
    "Suboh": { lat: -7.8000, lng: 113.8333 },
    "Sumbermalang": { lat: -7.7667, lng: 113.7833 }
};

// Database koordinat desa yang AKURAT untuk Kabupaten Situbondo
const koordinatDesa = {
    // ===== KECAMATAN ARJASA (DIPERBAIKI) =====
    "Arjasa, Arjasa": { lat: -7.7069, lng: 113.6347 }, // Kelurahan (Pusat Kecamatan)
    "Bayeman, Arjasa": { lat: -7.7150, lng: 113.6250 }, // DIPERBAIKI
    "Curah Tatal, Arjasa": { lat: -7.6900, lng: 113.6200 }, // DIPERBAIKI
    "Jatisari, Arjasa": { lat: -7.6980, lng: 113.6400 }, // DIPERBAIKI
    "Kayumas, Arjasa": { lat: -7.7100, lng: 113.6300 }, // DIPERBAIKI
    "Kedungdowo, Arjasa": { lat: -7.7000, lng: 113.6500 }, // DIPERBAIKI
    "Ketowan, Arjasa": { lat: -7.7050, lng: 113.6200 }, // DIPERBAIKI
    "Lamongan, Arjasa": { lat: -7.6950, lng: 113.6350 }, // DIPERBAIKI

    // ===== KECAMATAN ASEMBAGUS =====
    "Asembagus, Asembagus": { lat: -7.7536, lng: 114.1561 },
    "Banyuputih, Asembagus": { lat: -7.7600, lng: 114.1400 },
    "Banyuwulu, Asembagus": { lat: -7.7550, lng: 114.1650 },
    "Gudang, Asembagus": { lat: -7.7500, lng: 114.1500 },
    "Jangkar, Asembagus": { lat: -7.7450, lng: 114.1600 },
    "Kedunglo, Asembagus": { lat: -7.7450, lng: 114.1500 },
    "Kertosari, Asembagus": { lat: -7.7550, lng: 114.1600 },
    "Mojosari, Asembagus": { lat: -7.7480, lng: 114.1650 },
    "Perante, Asembagus": { lat: -7.7580, lng: 114.1550 },
    "Trigonco, Asembagus": { lat: -7.7650, lng: 114.1450 },
    "Wringinanom, Asembagus": { lat: -7.7400, lng: 114.1700 },

    // ===== KECAMATAN BANYUGLUGUR =====
    "Banyuglugur, Banyuglugur": { lat: -7.7211, lng: 113.8883 },
    "Kalianget, Banyuglugur": { lat: -7.7300, lng: 113.8800 },
    "Kepuh, Banyuglugur": { lat: -7.7150, lng: 113.8950 },
    "Bloro, Banyuglugur": { lat: -7.7100, lng: 113.9000 },
    "Tepos, Banyuglugur": { lat: -7.7250, lng: 113.9100 },

    // ===== KECAMATAN BANYUPUTIH =====
    "Sumberanyar, Banyuputih": { lat: -7.7608, lng: 114.0200 },
    "Sumberejo, Banyuputih": { lat: -7.7650, lng: 114.0250 },
    "Wonorejo, Banyuputih": { lat: -7.7500, lng: 114.0300 },

    // ===== KECAMATAN BESUKI =====
    "Besuki, Besuki": { lat: -7.7333, lng: 113.7000 }, // Kelurahan
    "Boro, Besuki": { lat: -7.7400, lng: 113.7100 },
    "Demung, Besuki": { lat: -7.7300, lng: 113.6900 },
    "Jetis, Besuki": { lat: -7.7200, lng: 113.7050 },
    "Langkap, Besuki": { lat: -7.7350, lng: 113.6950 },
    "Sambirampak Kidul, Besuki": { lat: -7.7250, lng: 113.7150 },
    "Tambak, Besuki": { lat: -7.7150, lng: 113.7000 },
    "Tangkilan, Besuki": { lat: -7.7100, lng: 113.6950 },

    // ===== KECAMATAN BUNGATAN (DIPERBAIKI) =====
    "Bungatan, Bungatan": { lat: -7.6833, lng: 113.8833 }, // Pusat Kecamatan
    "Bungcalok, Bungatan": { lat: -7.6900, lng: 113.8900 },
    "Cemara, Bungatan": { lat: -7.6750, lng: 113.8700 }, // DIPERBAIKI
    "Kembangsari, Bungatan": { lat: -7.6800, lng: 113.8750 }, // DIPERBAIKI
    "Kenep, Bungatan": { lat: -7.6850, lng: 113.8800 }, // DIPERBAIKI
    "Kompas, Bungatan": { lat: -7.6900, lng: 113.8950 },
    "Patemon, Bungatan": { lat: -7.6950, lng: 113.8850 },
    "Sokaan, Bungatan": { lat: -7.7000, lng: 113.9000 },
    "Tambak Ukir, Bungatan": { lat: -7.6700, lng: 113.8650 }, // DIPERBAIKI

    // ===== KECAMATAN JANGKAR =====
    "Jangkar, Jangkar": { lat: -7.7500, lng: 114.0833 },
    "Curah Tatal, Jangkar": { lat: -7.7450, lng: 114.0800 },
    "Gelung, Jangkar": { lat: -7.7550, lng: 114.0900 },
    "Karang Anyar, Jangkar": { lat: -7.7600, lng: 114.0850 },
    "Paowan, Jangkar": { lat: -7.7500, lng: 114.0950 },
    "Peleyan, Jangkar": { lat: -7.7400, lng: 114.0750 },
    "Semboropon, Jangkar": { lat: -7.7350, lng: 114.0700 },
    "Talang, Jangkar": { lat: -7.7650, lng: 114.1000 },
    "Tanjung Kamal, Jangkar": { lat: -7.7700, lng: 114.1050 },

    // ===== KECAMATAN JATIBANTENG =====
    "Curahsuri, Jatibanteng": { lat: -7.7200, lng: 113.9900 },
    "Jatibanteng, Jatibanteng": { lat: -7.7167, lng: 113.9833 },
    "Kalibagor, Jatibanteng": { lat: -7.7100, lng: 113.9800 },
    "Kembangsari, Jatibanteng": { lat: -7.7100, lng: 113.9800 },
    "Pakel, Jatibanteng": { lat: -7.7250, lng: 113.9850 },
    "Patemon, Jatibanteng": { lat: -7.7150, lng: 113.9750 },
    "Semambung, Jatibanteng": { lat: -7.7300, lng: 113.9950 },
    "Sumberanyar, Jatibanteng": { lat: -7.7250, lng: 113.9850 },
    "Wringinanom, Jatibanteng": { lat: -7.7300, lng: 113.9950 },

    // ===== KECAMATAN KAPONGAN =====
    "Batu Kapur, Kapongan": { lat: -7.6900, lng: 114.0200 },
    "Curah Cottok, Kapongan": { lat: -7.6800, lng: 114.0150 },
    "Gelung, Kapongan": { lat: -7.6750, lng: 114.0100 },
    "Kapongan, Kapongan": { lat: -7.6833, lng: 114.0167 },
    "Kesambirampak, Kapongan": { lat: -7.6850, lng: 114.0250 },
    "Landangan, Kapongan": { lat: -7.6950, lng: 114.0300 },
    "Palangan, Kapongan": { lat: -7.6700, lng: 114.0050 },
    "Pokaan, Kapongan": { lat: -7.7000, lng: 114.0350 },
    "Seletreng, Kapongan": { lat: -7.6650, lng: 114.0000 },
    "Sumberanyar, Kapongan": { lat: -7.7100, lng: 114.0400 },
    "Tanjung Pecinan, Kapongan": { lat: -7.7200, lng: 114.0450 },

    // ===== KECAMATAN KENDIT =====
    "Balung, Kendit": { lat: -7.7400, lng: 113.9400 },
    "Keding, Kendit": { lat: -7.7300, lng: 113.9350 },
    "Kendit, Kendit": { lat: -7.7333, lng: 113.9333 },
    "Kilensari, Kendit": { lat: -7.7350, lng: 113.9300 },
    "Kukusan, Kendit": { lat: -7.7250, lng: 113.9250 },
    "Paowan, Kendit": { lat: -7.7200, lng: 113.9200 },
    "Patokan, Kendit": { lat: -7.7100, lng: 113.9150 },
    "Semboropon, Kendit": { lat: -7.7150, lng: 113.9100 },
    "Tambak Ukir, Kendit": { lat: -7.7000, lng: 113.9050 },

    // ===== KECAMATAN MANGARAN =====
    "Mangaran, Mangaran": { lat: -7.6667, lng: 114.0667 },
    "Semiring, Mangaran": { lat: -7.6700, lng: 114.0700 },
    "Tanjung Kamal, Mangaran": { lat: -7.6750, lng: 114.0750 },
    "Tegal Barat, Mangaran": { lat: -7.6650, lng: 114.0650 },

    // ===== KECAMATAN MLANDINGAN =====
    "Besuki, Mlandingan": { lat: -7.6833, lng: 113.9500 },
    "Buniwangi, Mlandingan": { lat: -7.6850, lng: 113.9450 },
    "Campoan, Mlandingan": { lat: -7.6800, lng: 113.9550 },
    "Dusun Wali, Mlandingan": { lat: -7.6750, lng: 113.9600 },
    "Glingseran, Mlandingan": { lat: -7.6900, lng: 113.9400 },
    "Sumber Pinang, Mlandingan": { lat: -7.6900, lng: 113.9400 },
    "Sumberejo, Mlandingan": { lat: -7.6950, lng: 113.9650 },

    // ===== KECAMATAN PANARUKAN =====
    "Gelung, Panarukan": { lat: -7.7050, lng: 113.9200 },
    "Kilensari, Panarukan": { lat: -7.6950, lng: 113.9150 },
    "Paowan, Panarukan": { lat: -7.7100, lng: 113.9250 },
    "Peleyan, Panarukan": { lat: -7.7000, lng: 113.9100 },
    "Sumberkolak, Panarukan": { lat: -7.7150, lng: 113.9300 },
    "Wringinanom, Panarukan": { lat: -7.7200, lng: 113.9350 },

    // ===== KECAMATAN PANJI (DIPERBAIKI) =====
    "Ardirejo, Panji": { lat: -7.7100, lng: 113.6700 }, // DIPERBAIKI
    "Kemiri, Panji": { lat: -7.7200, lng: 113.6750 }, // DIPERBAIKI
    "Panji Kidul, Panji": { lat: -7.7180, lng: 113.6650 }, // DIPERBAIKI
    "Panji Lor, Panji": { lat: -7.7150, lng: 113.6600 }, // DIPERBAIKI
    "Tokelan, Panji": { lat: -7.7250, lng: 113.6800 }, // DIPERBAIKI

    // ===== KECAMATAN SITUBONDO (IBU KOTA) =====
    "Dawuhan, Situbondo": { lat: -7.7062, lng: 113.9603 }, // Kelurahan
    "Karang Anyar, Situbondo": { lat: -7.7000, lng: 113.9500 }, // Kelurahan
    "Karang Asem, Situbondo": { lat: -7.7100, lng: 113.9650 }, // Kelurahan
    "Patokan, Situbondo": { lat: -7.7000, lng: 113.9500 }, // Kelurahan
    "Sindet Lajuh, Situbondo": { lat: -7.7050, lng: 113.9550 }, // Kelurahan
    "Kalibagor, Situbondo": { lat: -7.7100, lng: 113.9650 }, // Desa
    "Kembangsari, Situbondo": { lat: -7.7150, lng: 113.9600 }, // Desa
    "Olean, Situbondo": { lat: -7.7200, lng: 113.9700 }, // Desa
    "Talkandang, Situbondo": { lat: -7.7200, lng: 113.9700 }, // Desa

    // ===== KECAMATAN SUBOH =====
    "Buduan, Suboh": { lat: -7.8050, lng: 113.8400 },
    "Dawuan, Suboh": { lat: -7.7950, lng: 113.8300 },
    "Gunung Malang, Suboh": { lat: -7.8100, lng: 113.8350 },
    "Gunung Putri, Suboh": { lat: -7.8000, lng: 113.8250 },
    "Suboh, Suboh": { lat: -7.8000, lng: 113.8333 },

    // ===== KECAMATAN SUMBERMALANG =====
    "Baderan, Sumbermalang": { lat: -7.7700, lng: 113.7900 },
    "Kalirejo, Sumbermalang": { lat: -7.7600, lng: 113.7800 },
    "Plalangan, Sumbermalang": { lat: -7.7750, lng: 113.7850 },
    "Sumber Anyar, Sumbermalang": { lat: -7.7650, lng: 113.7750 },
    "Sumberargo, Sumbermalang": { lat: -7.7650, lng: 113.7750 },
    "Tamankursi, Sumbermalang": { lat: -7.7800, lng: 113.7950 },
    "Tlogosari, Sumbermalang": { lat: -7.7850, lng: 113.8000 }
};
// ==================== AKHIR DATABASE KOORDINAT ====================
        
        // --- APPLICATION LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplikasi Peta Statistik Data Nelayan diinisialisasi');
            
            // Tampilkan welcome modal
            setTimeout(() => {
                try {
                    const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                    welcomeModal.show();
                    
                    // Sembunyikan modal setelah 2 detik
                    setTimeout(() => {
                        welcomeModal.hide();
                        initializeApp();
                    }, 2000);
                } catch (error) {
                    console.error('Error menampilkan welcome modal:', error);
                    initializeApp();
                }
            }, 500);
        });
        
        function initializeApp() {
            loadSettings();
            loadData();
            initializeCharts();
            updateDashboard();
            setupMapFilterOptions();
            setupEventListeners();
            
            // Tampilkan notifikasi selamat datang
            showNotification('Selamat datang di Sistem Peta Statistik Data Nelayan Kab. Situbondo', 'success');
        }

        function loadCoordinatesCache() {
            try {
                const cached = localStorage.getItem('situbondoCoordinatesCache');
                if (cached) {
                    coordinatesCache = JSON.parse(cached);
                    console.log('Koordinat cache dimuat:', Object.keys(coordinatesCache).length, 'entries');
                }
            } catch (e) {
                console.error('Gagal memuat cache koordinat:', e);
            }
        }
        
        function saveCoordinatesCache() {
            try {
                localStorage.setItem('situbondoCoordinatesCache', JSON.stringify(coordinatesCache));
            } catch (e) {
                console.error('Gagal menyimpan cache koordinat:', e);
            }
        }
        
        function getCoordinates(desa, kecamatan) {
            const key = `${desa}, ${kecamatan}`;
            
            // 1. Cek di database koordinat desa (paling akurat)
            if (koordinatDesa[key]) {
                return koordinatDesa[key];
            }
            
            // 2. Coba variasi nama (tanpa koma)
            const key2 = `${desa} ${kecamatan}`;
            if (koordinatDesa[key2]) {
                return koordinatDesa[key2];
            }
            
            // 3. Gunakan koordinat kecamatan sebagai fallback
            if (koordinatKecamatan[kecamatan]) {
                return koordinatKecamatan[kecamatan];
            }
            
            // 4. Default ke pusat Situbondo jika tidak ditemukan
            return { lat: -7.7062, lng: 113.9603 };
        }
        
        function setupEventListeners() {
            // Data Table Search
            const searchData = document.getElementById('searchData');
            if (searchData) {
                searchData.addEventListener('input', handleSearch);
            }
            
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            // Map Controls
            const mapFilterType = document.getElementById('mapFilterType');
            if (mapFilterType) {
                mapFilterType.addEventListener('change', handleMapFilterTypeChange);
            }
            
            const applyMapFilterBtn = document.getElementById('applyMapFilter');
            if (applyMapFilterBtn) {
                applyMapFilterBtn.addEventListener('click', applyMapFilter);
            }
            
            const resetMapFilterBtn = document.getElementById('resetMapFilter');
            if (resetMapFilterBtn) {
                resetMapFilterBtn.addEventListener('click', resetMapFilter);
            }
            
            // Map Layer Toggles
            const toggleHeatmap = document.getElementById('toggleHeatmap');
            if (toggleHeatmap) {
                toggleHeatmap.addEventListener('change', toggleHeatmapLayer);
            }
            
            const toggleMarkers = document.getElementById('toggleMarkers');
            if (toggleMarkers) {
                toggleMarkers.addEventListener('change', toggleMarkersLayer);
            }
            
            const toggleKecamatan = document.getElementById('toggleKecamatan');
            if (toggleKecamatan) {
                toggleKecamatan.addEventListener('change', toggleKecamatanLayer);
            }
            
            // Map Search
            const searchMapBtn = document.getElementById('searchMapBtn');
            if (searchMapBtn) {
                searchMapBtn.addEventListener('click', searchMapLocation);
            }
            
            const clearMapSearchBtn = document.getElementById('clearMapSearchBtn');
            if (clearMapSearchBtn) {
                clearMapSearchBtn.addEventListener('click', clearMapSearch);
            }
            
            const mapSearch = document.getElementById('mapSearch');
            if (mapSearch) {
                mapSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchMapLocation();
                    }
                });
            }
            
            // Map Type Controls
            const btnMapRoad = document.getElementById('btnMapRoad');
            const btnMapSatellite = document.getElementById('btnMapSatellite');
            const btnMapHybrid = document.getElementById('btnMapHybrid');
            
            if (btnMapRoad) btnMapRoad.addEventListener('click', () => changeMapType('roadmap'));
            if (btnMapSatellite) btnMapSatellite.addEventListener('click', () => changeMapType('satellite'));
            if (btnMapHybrid) btnMapHybrid.addEventListener('click', () => changeMapType('hybrid'));
            
            // Locate Me Button
            const btnLocateMe = document.getElementById('btnLocateMe');
            if (btnLocateMe) {
                btnLocateMe.addEventListener('click', locateUser);
            }
            
            // System Management
            const reloadRepoBtn = document.getElementById('btn-reload-repo');
            if (reloadRepoBtn) {
                reloadRepoBtn.addEventListener('click', handleReloadFromRepo);
            }

            // About Button
            const aboutBtn = document.getElementById('btn-about');
            if (aboutBtn) {
                aboutBtn.addEventListener('click', () => {
                    new bootstrap.Modal(document.getElementById('aboutModal')).show();
                });
            }

            // UI Helpers
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleMobileMenu);
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992 && document.getElementById('sidebarMenu').classList.contains('mobile-show')) {
                        toggleMobileMenu();
                    }
                    
                    // Initialize map when map tab is shown
                    if (link.id === 'v-pills-map-tab') {
                        setTimeout(initializeMap, 300);
                    }
                });
            });

            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', () => {
                    const mapTab = document.getElementById('v-pills-map-tab');
                    if (mapTab) {
                        mapTab.click();
                        // Scroll to top when opening map via FAB
                        window.scrollTo(0, 0);
                    }
                });
            }
            
            // Load coordinates cache
            loadCoordinatesCache();
        }
        
        function setupMapFilterOptions() {
            const mapFilterType = document.getElementById('mapFilterType');
            if (!mapFilterType) return;
            
            mapFilterType.addEventListener('change', function() {
                const filterValueContainer = document.getElementById('mapFilterValueContainer');
                const filterValueSelect = document.getElementById('mapFilterValue');
                
                if (!filterValueContainer || !filterValueSelect) return;
                
                filterValueSelect.innerHTML = '';
                
                if (this.value === 'all') {
                    filterValueContainer.style.display = 'none';
                    return;
                }
                
                filterValueContainer.style.display = 'block';
                
                if (this.value === 'kecamatan') {
                    filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                    kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
                } else if (this.value === 'tahun') {
                    filterValueSelect.add(new Option('Pilih Tahun', ''));
                    const currentYear = new Date().getFullYear();
                    for (let year = 2020; year <= currentYear; year++) {
                        filterValueSelect.add(new Option(year, year));
                    }
                } else if (this.value === 'jenis') {
                    filterValueSelect.add(new Option('Pilih Jenis', ''));
                    filterValueSelect.add(new Option('Uang', 'Uang'));
                    filterValueSelect.add(new Option('Barang', 'Barang'));
                    filterValueSelect.add(new Option('Jasa', 'Jasa'));
                }
            });
        }
        
        function handleMapFilterTypeChange() {
            const filterValueContainer = document.getElementById('mapFilterValueContainer');
            const filterValueSelect = document.getElementById('mapFilterValue');
            
            if (!filterValueContainer || !filterValueSelect) return;
            
            filterValueSelect.innerHTML = '';
            
            if (this.value === 'all') {
                filterValueContainer.style.display = 'none';
                return;
            }
            
            filterValueContainer.style.display = 'block';
            
            if (this.value === 'kecamatan') {
                filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
            } else if (this.value === 'tahun') {
                filterValueSelect.add(new Option('Pilih Tahun', ''));
                const currentYear = new Date().getFullYear();
                for (let year = 2020; year <= currentYear; year++) {
                    filterValueSelect.add(new Option(year, year));
                }
            } else if (this.value === 'jenis') {
                filterValueSelect.add(new Option('Pilih Jenis', ''));
                filterValueSelect.add(new Option('Uang', 'Uang'));
                filterValueSelect.add(new Option('Barang', 'Barang'));
                filterValueSelect.add(new Option('Jasa', 'Jasa'));
            }
        }
        
        // --- DATA PERSISTENCE ---
        function loadData() {
            try {
                const savedData = localStorage.getItem('barjasData');
                appData = savedData ? JSON.parse(savedData) : [];
                
                // Jika tidak ada data, gunakan data contoh
                if (appData.length === 0) {
                    generateSampleData();
                }
            } catch (e) {
                console.error("Gagal memuat data:", e);
                appData = [];
                generateSampleData();
            }
            renderDataTable();
        }
        
        function generateSampleData() {
            console.log('Membuat data contoh...');
            
            // Data contoh untuk demo
            const sampleNames = [
                "Ahmad Santoso", "Budi Setiawan", "Cahyo Purnomo", "Dewi Lestari", "Eko Prasetyo",
                "Fitriani", "Gunawan", "Hendra Wijaya", "Indah Permata", "Joko Susilo",
                "Kartika Sari", "Lukman Hakim", "Mega Wati", "Nurhayati", "Oki Setiawan",
                "Putri Ayu", "Rudi Hartono", "Siti Fatimah", "Toni Gunawan", "Umar Said"
            ];
            
            const sampleKelompok = [
                "Nelayan Mandiri", "Kelompok Mina Jaya", "Nelayan Sejahtera", "Kelompok Bahari", 
                "Nelayan Makmur", "Kelompok Samudera", "Nelayan Berkah", "Kelompok Laut Indah"
            ];
            
            const jabatanList = ["Ketua", "Sekretaris", "Bendahara", "Anggota", "Koordinator"];
            
            const jenisBantuanList = ["Uang", "Barang", "Jasa"];
            const namaBantuanList = [
                "Bantuan Modal Usaha", "Alat Tangkap Ikan", "Pelatihan Nelayan", 
                "Bantuan Bibit Ikan", "Perbaikan Kapal", "Bantuan Pakan Ikan"
            ];
            
            const satuanList = ["Rp", "Unit", "Paket", "Kg", "Orang"];
            
            appData = [];
            
            // Generate data untuk setiap kecamatan
            kecamatanList.forEach((kecamatan, kecIndex) => {
                // Tentukan jumlah desa per kecamatan (3-6 desa)
                const jumlahDesa = 3 + Math.floor(Math.random() * 4);
                
                // Buat daftar desa untuk kecamatan ini
                const desaList = [];
                for (let d = 1; d <= jumlahDesa; d++) {
                    desaList.push(`Desa ${d} ${kecamatan}`);
                }
                
                // Generate data untuk setiap desa
                desaList.forEach((desa, desaIndex) => {
                    // Tentukan jumlah penerima per desa (5-20 orang)
                    const jumlahPenerima = 5 + Math.floor(Math.random() * 16);
                    
                    for (let i = 0; i < jumlahPenerima; i++) {
                        const nama = sampleNames[Math.floor(Math.random() * sampleNames.length)];
                        const nik = `35.${(kecIndex + 10).toString().padStart(2, '0')}.${(desaIndex + 1).toString().padStart(2, '0')}.${(i + 1000).toString().padStart(4, '0')}`;
                        const kelompok = sampleKelompok[Math.floor(Math.random() * sampleKelompok.length)];
                        const jabatan = jabatanList[Math.floor(Math.random() * jabatanList.length)];
                        const tahunAnggaran = 2022 + Math.floor(Math.random() * 4); // 2022-2025
                        const jenisBantuan = jenisBantuanList[Math.floor(Math.random() * jenisBantuanList.length)];
                        const namaBantuan = namaBantuanList[Math.floor(Math.random() * namaBantuanList.length)];
                        
                        let jumlahBantuan, satuanBantuan;
                        if (jenisBantuan === "Uang") {
                            jumlahBantuan = 500000 + Math.floor(Math.random() * 5000000);
                            satuanBantuan = "Rp";
                        } else if (jenisBantuan === "Barang") {
                            jumlahBantuan = 1 + Math.floor(Math.random() * 10);
                            satuanBantuan = "Unit";
                        } else {
                            jumlahBantuan = 1;
                            satuanBantuan = "Paket";
                        }
                        
                        const tanggalTerima = new Date(
                            tahunAnggaran,
                            Math.floor(Math.random() * 12),
                            1 + Math.floor(Math.random() * 28)
                        ).toISOString().split('T')[0];
                        
                        const tanggalInput = new Date().toISOString().split('T')[0];
                        const namaPetugas = ["Budi Santoso", "Siti Rahayu", "Joko Widodo", "Sri Mulyani"][Math.floor(Math.random() * 4)];
                        
                        appData.push({
                            id: `ID${kecIndex}${desaIndex}${i}${Date.now()}`,
                            nama: nama,
                            nik: nik,
                            namaKelompok: kelompok,
                            jabatan: jabatan,
                            tahunAnggaran: tahunAnggaran,
                            kecamatan: kecamatan,
                            desa: desa.replace(`Desa ${desaIndex + 1} ${kecamatan}`, `Desa ${desaIndex + 1}`),
                            jenisBantuan: jenisBantuan,
                            namaBantuan: namaBantuan,
                            jumlahBantuan: jumlahBantuan,
                            satuanBantuan: satuanBantuan,
                            tanggalTerima: tanggalTerima,
                            tanggalInput: tanggalInput,
                            namaPetugas: namaPetugas
                        });
                    }
                });
            });
            
            console.log(`Data contoh dibuat: ${appData.length} records`);
            saveData();
        }
        
        function saveData() {
            try {
                localStorage.setItem('barjasData', JSON.stringify(appData));
            } catch (e) {
                console.error("Gagal menyimpan data:", e);
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('barjasSettings');
            if (savedSettings) {
                try {
                    const loaded = JSON.parse(savedSettings);
                    Object.assign(appSettings, loaded);
                } catch(e) {
                    console.error("Gagal memuat pengaturan:", e);
                }
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('barjasSettings', JSON.stringify(appSettings));
            } catch (e) {
                console.error("Gagal menyimpan pengaturan:", e);
            }
        }
        
        // --- DATA TABLE ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const dataToRender = isFilterActive ? filteredData : appData;
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToRender.length);
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4">Tidak ada data</td></tr>`;
                
                const tableInfo = document.getElementById('tableInfo');
                if (tableInfo) tableInfo.textContent = 'Menampilkan 0 dari 0 data';
                
                const pagination = document.getElementById('pagination');
                if (pagination) pagination.innerHTML = '';
                
                return;
            }
            
            for (let i = startIndex; i < endIndex; i++) {
                const data = dataToRender[i];
                const row = document.createElement('tr');
                
                const nikDisplay = formatPrivacy(data.nik);
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold text-primary">${data.nama}</td>
                    <td class="${privacyClass}">${nikDisplay}</td>
                    <td>${data.namaKelompok || '-'}</td>
                    <td>${data.jabatan || '-'}</td>
                    <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td>
                    <td>${data.desa}</td>
                    <td><span class="badge bg-info">${data.jenisBantuan}</span></td>
                    <td>${data.namaBantuan || '-'}</td>
                    <td class="fw-bold">${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td>
                    <td>${data.namaPetugas || '-'}</td>
                `;
                tableBody.appendChild(row);
            }
            
            const tableInfo = document.getElementById('tableInfo');
            if (tableInfo) {
                tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${dataToRender.length} data`;
            }
            
            updatePagination(dataToRender.length);
        }
        
        function updatePagination(totalItems) {
            const paginationEl = document.getElementById('pagination');
            if (!paginationEl) return;
            
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationEl.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageItem = (page, text, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page}); return false;">${text}</a>`;
                return li;
            };

            paginationEl.appendChild(createPageItem(currentPage - 1, '<i class="fas fa-chevron-left"></i>', currentPage === 1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationEl.appendChild(createPageItem(i, i, false, i === currentPage));
            }

            paginationEl.appendChild(createPageItem(currentPage + 1, '<i class="fas fa-chevron-right"></i>', currentPage === totalPages));
        }
        
        function changePage(page) {
            const dataToRender = isFilterActive ? filteredData : appData;
            const totalPages = Math.ceil(dataToRender.length / (parseInt(appSettings.itemsPerPage) || 25));
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderDataTable();
            }
        }
        
        function handleSearch() {
            const searchTerm = document.getElementById('searchData').value.toLowerCase();
            
            isFilterActive = !!searchTerm;
            
            filteredData = appData.filter(d => {
                const matchesSearch = !searchTerm || Object.values(d).some(v => 
                    String(v).toLowerCase().includes(searchTerm)
                );
                
                return matchesSearch;
            });
            
            currentPage = 1;
            renderDataTable();
        }
        
        function clearSearch() {
            const searchData = document.getElementById('searchData');
            if (searchData) searchData.value = '';
            
            handleSearch();
        }
        
        // --- DASHBOARD ---
        function updateDashboard() {
            const totalPenerima = document.getElementById('totalPenerima');
            const totalBantuan = document.getElementById('totalBantuan');
            const tahunAktif = document.getElementById('tahunAktif');
            const rataBantuan = document.getElementById('rataBantuan');
            
            if (totalPenerima) totalPenerima.textContent = formatNumber(appData.length);
            
            const uangData = appData.filter(d => d.jenisBantuan === 'Uang');
            const totalBantuanValue = uangData.reduce((sum, d) => sum + (parseFloat(d.jumlahBantuan) || 0), 0);
            
            if (totalBantuan) totalBantuan.textContent = `Rp ${formatNumber(totalBantuanValue)}`;
            
            const tahunCount = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const tahunAktifValue = Object.keys(tahunCount).reduce((a, b) => tahunCount[a] > tahunCount[b] ? a : b, appSettings.defaultTahun);
            
            if (tahunAktif) tahunAktif.textContent = tahunAktifValue;
            
            const rataBantuanValue = uangData.length > 0 ? totalBantuanValue / uangData.length : 0;
            
            if (rataBantuan) rataBantuan.textContent = `Rp ${formatNumber(rataBantuanValue.toFixed(0))}`;
            
            updateCharts();
            updateRecentData();
        }
        
        function updateRecentData() {
            const recentDataContainer = document.getElementById('recentData');
            if (!recentDataContainer) return;
            
            recentDataContainer.innerHTML = '';
            const recent = [...appData].sort((a, b) => new Date(b.tanggalInput) - new Date(a.tanggalInput)).slice(0, 5);
            
            if (recent.length === 0) {
                recentDataContainer.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>`;
                return;
            }
            
            recent.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(d.tanggalInput)}</td> <td>${d.nama}</td> <td>${d.desa}</td>
                    <td>${d.jenisBantuan}</td> <td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td>
                `;
                recentDataContainer.appendChild(row);
            });
        }
        
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js tidak tersedia');
                return;
            }
            
            Chart.defaults.font.family = "'Inter', sans-serif";
            const pieCtx = document.getElementById('kecamatanChart')?.getContext('2d');
            if (pieCtx) {
                window.kecamatanChart = new Chart(pieCtx, { 
                    type: 'pie', 
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'right' 
                            } 
                        } 
                    } 
                });
            }
            
            const barCtx = document.getElementById('tahunChart')?.getContext('2d');
            if (barCtx) {
                window.tahunChart = new Chart(barCtx, { 
                    type: 'bar', 
                    options: { 
                        responsive: true, 
                        scales: { 
                            y: { 
                                beginAtZero: true 
                            } 
                        } 
                    } 
                });
            }
        }
        
        function updateCharts() {
            if (!appData || appData.length === 0) return;

            const kecamatanData = appData.reduce((acc, d) => ({...acc, [d.kecamatan]: (acc[d.kecamatan] || 0) + 1}), {});
            if (window.kecamatanChart) {
                window.kecamatanChart.data = {
                    labels: Object.keys(kecamatanData),
                    datasets: [{ 
                        data: Object.values(kecamatanData), 
                        backgroundColor: ['#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226'] 
                    }]
                };
                window.kecamatanChart.update();
            }
            
            const tahunData = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const sortedYears = Object.keys(tahunData).sort();
            if (window.tahunChart) {
                window.tahunChart.data = {
                    labels: sortedYears,
                    datasets: [{ 
                        label: 'Jumlah Penerima', 
                        data: sortedYears.map(year => tahunData[year]), 
                        backgroundColor: '#0a9396' 
                    }]
                };
                window.tahunChart.update();
            }
        }
        
        // --- MAP FUNCTIONALITY ---
        async function initializeMap() {
            if (!document.getElementById('map')) return;
            
            // Show loading overlay
            const mapLoading = document.getElementById('mapLoading');
            if (mapLoading) mapLoading.classList.remove('d-none');
            
            // Clear existing map
            if (map) {
                map.remove();
                map = null;
            }
            
            // Initialize map centered on Situbondo
            map = L.map('map').setView([-7.7062, 113.9603], 11);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Initialize marker cluster
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: 40,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 10) size = 'medium';
                    if (count > 50) size = 'large';
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster marker-cluster-' + size,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            
            // Add markers for data
            await updateMapWithData(appData);
            
            // Add kecamatan boundaries and labels
            addKecamatanBoundaries();
            
            // Add heatmap layer
            addHeatmapLayer();
            
            // Hide loading overlay
            if (mapLoading) mapLoading.classList.add('d-none');
            
            // Update layer controls
            updateLayerControls();
        }
        
        async function updateMapWithData(data) {
            if (!map) return;
            
            // Show loading
            showNotification('Memuat data peta...', 'info');
            
            // Clear existing markers
            if (markerCluster) {
                markerCluster.clearLayers();
            }
            
            mapMarkers = [];
            
            if (data.length === 0) {
                updateMapStatistics(0, 0);
                showNotification('Tidak ada data untuk ditampilkan di peta', 'warning');
                return;
            }
            
            // Group data by desa/kecamatan
            const dataByLocation = {};
            let topDesa = { name: '', count: 0 };
            
            data.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                if (!dataByLocation[key]) {
                    dataByLocation[key] = {
                        desa: item.desa,
                        kecamatan: item.kecamatan,
                        items: [],
                        totalValue: 0,
                        jenisCount: {
                            Uang: 0,
                            Barang: 0,
                            Jasa: 0
                        },
                        tahunCount: {}
                    };
                }
                
                dataByLocation[key].items.push(item);
                const jumlah = parseFloat(item.jumlahBantuan) || 0;
                dataByLocation[key].totalValue += jumlah;
                
                if (item.jenisBantuan in dataByLocation[key].jenisCount) {
                    dataByLocation[key].jenisCount[item.jenisBantuan]++;
                }
                
                // Count by year
                if (!dataByLocation[key].tahunCount[item.tahunAnggaran]) {
                    dataByLocation[key].tahunCount[item.tahunAnggaran] = 0;
                }
                dataByLocation[key].tahunCount[item.tahunAnggaran]++;
                
                // Update top desa
                if (dataByLocation[key].items.length > topDesa.count) {
                    topDesa = { name: key, count: dataByLocation[key].items.length };
                }
            });
            
            // Create markers for each location
            const markers = [];
            let totalRecipients = 0;
            let totalValue = 0;
            let locationCount = 0;
            
            // Process locations
            const locations = Object.keys(dataByLocation);
            
            for (let i = 0; i < locations.length; i++) {
                const key = locations[i];
                const locationData = dataByLocation[key];
                
                // Get coordinates
                const coordinates = getCoordinates(locationData.desa, locationData.kecamatan);
                
                if (!coordinates) {
                    continue;
                }
                
                // Determine marker color based on number of recipients
                let markerColor = '#2ecc71'; // Green for low
                const recipientCount = locationData.items.length;
                
                if (recipientCount <= 5) markerColor = '#2ecc71'; // Green
                else if (recipientCount <= 15) markerColor = '#f1c40f'; // Yellow
                else if (recipientCount <= 30) markerColor = '#e67e22'; // Orange
                else markerColor = '#e74c3c'; // Red
                
                // Calculate marker size based on recipients
                const markerSize = Math.min(30, Math.max(15, 15 + recipientCount));
                
                // Create custom icon
                const icon = L.divIcon({
                    className: 'pulse-marker',
                    html: `
                        <div style="
                            background-color: ${markerColor};
                            width: ${markerSize}px;
                            height: ${markerSize}px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: ${Math.max(10, Math.min(14, markerSize/2))}px;
                        ">
                            ${recipientCount}
                        </div>
                    `,
                    iconSize: [markerSize + 6, markerSize + 6],
                    iconAnchor: [(markerSize + 6) / 2, (markerSize + 6) / 2]
                });
                
                // Format tahun distribusi for popup
                const tahunList = Object.keys(locationData.tahunCount)
                    .sort()
                    .map(tahun => `${tahun}: ${locationData.tahunCount[tahun]} penerima`)
                    .join('<br>');
                
                // Create popup content
                const popupContent = `
                    <div style="min-width: 300px;">
                        <h4>${locationData.desa}</h4>
                        <p class="text-muted mb-3">${locationData.kecamatan}</p>
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Total Penerima:</strong><br>
                                <span class="badge bg-primary">${recipientCount} orang</span>
                            </div>
                            <div class="col-6">
                                <strong>Total Nilai:</strong><br>
                                <span class="text-success fw-bold">Rp ${formatNumber(locationData.totalValue)}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Distribusi Jenis:</strong><br>
                            <div class="d-flex gap-2 mt-1">
                                <span class="badge bg-success">Uang: ${locationData.jenisCount.Uang}</span>
                                <span class="badge bg-warning">Barang: ${locationData.jenisCount.Barang}</span>
                                <span class="badge bg-info">Jasa: ${locationData.jenisCount.Jasa}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Distribusi Tahun:</strong><br>
                            <small>${tahunList || 'Tidak ada data tahun'}</small>
                        </div>
                        
                        <button class="btn btn-primary btn-sm w-100" onclick="showLocationDetail('${locationData.desa}', '${locationData.kecamatan}')">
                            <i class="fas fa-list me-1"></i> Lihat Detail Penerima
                        </button>
                    </div>
                `;
                
                // Create marker
                const marker = L.marker([coordinates.lat, coordinates.lng], { icon: icon })
                    .bindPopup(popupContent);
                
                markers.push(marker);
                mapMarkers.push(marker);
                
                totalRecipients += recipientCount;
                totalValue += locationData.totalValue;
                locationCount++;
            }
            
            // Add markers to cluster group
            markerCluster.addLayers(markers);
            map.addLayer(markerCluster);
            
            // Update map statistics
            updateMapStatistics(locationCount, totalRecipients, totalValue, topDesa.name);
            
            // Fit bounds to show all markers with padding
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.15));
            }
            
            // Update heatmap
            updateHeatmapLayer(data);
            
            showNotification(`Peta berhasil dimuat: ${locationCount} lokasi ditampilkan`, 'success');
        }
        
        function addKecamatanBoundaries() {
            if (!map) return;
            
            // Add kecamatan center markers
            Object.keys(koordinatKecamatan).forEach(kecamatan => {
                const coords = koordinatKecamatan[kecamatan];
                
                const kecamatanIcon = L.divIcon({
                    className: 'kecamatan-marker',
                    html: `<div style="
                        background-color: #005f73; 
                        width: 20px; 
                        height: 20px; 
                        border-radius: 50%; 
                        border: 3px solid #001219;
                        box-shadow: 0 0 8px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                
                const marker = L.marker([coords.lat, coords.lng], { 
                    icon: kecamatanIcon,
                    title: kecamatan 
                }).addTo(map);
                
                marker.bindTooltip(`<strong>${kecamatan}</strong>`, {
                    permanent: false,
                    direction: 'top',
                    className: 'kecamatan-tooltip'
                });
                
                mapMarkers.push(marker);
            });
            
            kecamatanLayer = L.layerGroup(mapMarkers.filter(m => m.options.icon?.options.className === 'kecamatan-marker'));
        }
        
        function addHeatmapLayer() {
            if (!map) return;
            
            // Create heatmap layer
            heatmapLayer = L.layerGroup().addTo(map);
        }
        
        function updateHeatmapLayer(data) {
            if (!heatmapLayer || !map) return;
            
            // Clear existing heatmap
            heatmapLayer.clearLayers();
            
            if (data.length === 0) return;
            
            // Create heatmap points
            const heatPoints = [];
            
            data.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                const coordinates = koordinatDesa[key] || koordinatKecamatan[item.kecamatan];
                
                if (coordinates) {
                    // Weight based on jumlah bantuan
                    const weight = parseFloat(item.jumlahBantuan) || 1;
                    heatPoints.push([coordinates.lat, coordinates.lng, Math.min(weight / 1000000, 1)]);
                }
            });
            
            // Create heatmap using circle markers
            heatPoints.forEach(point => {
                const [lat, lng, intensity] = point;
                const radius = 30 + (intensity * 70);
                const opacity = 0.3 + (intensity * 0.3);
                
                L.circle([lat, lng], {
                    radius: radius,
                    fillColor: '#ff7800',
                    color: '#ff5500',
                    weight: 0,
                    fillOpacity: opacity
                }).addTo(heatmapLayer);
            });
        }
        
        function toggleHeatmapLayer() {
            const toggle = document.getElementById('toggleHeatmap');
            if (!heatmapLayer || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(heatmapLayer);
            } else {
                map.removeLayer(heatmapLayer);
            }
        }
        
        function toggleMarkersLayer() {
            const toggle = document.getElementById('toggleMarkers');
            if (!markerCluster || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(markerCluster);
            } else {
                map.removeLayer(markerCluster);
            }
        }
        
        function toggleKecamatanLayer() {
            const toggle = document.getElementById('toggleKecamatan');
            if (!kecamatanLayer || !toggle) return;
            
            if (toggle.checked) {
                map.addLayer(kecamatanLayer);
            } else {
                map.removeLayer(kecamatanLayer);
            }
        }
        
        function changeMapType(type) {
            currentMapType = type;
            
            // Update button states
            document.getElementById('btnMapRoad').classList.remove('active');
            document.getElementById('btnMapSatellite').classList.remove('active');
            document.getElementById('btnMapHybrid').classList.remove('active');
            
            if (type === 'roadmap') {
                document.getElementById('btnMapRoad').classList.add('active');
                // Update tile layer to OpenStreetMap
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(map);
                
            } else if (type === 'satellite') {
                document.getElementById('btnMapSatellite').classList.add('active');
                // Update tile layer to Satellite
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                }).addTo(map);
                
            } else if (type === 'hybrid') {
                document.getElementById('btnMapHybrid').classList.add('active');
                // Update tile layer to Hybrid
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(map);
            }
            
            // Re-add other layers
            if (markerCluster) map.addLayer(markerCluster);
            if (heatmapLayer && document.getElementById('toggleHeatmap').checked) map.addLayer(heatmapLayer);
            if (kecamatanLayer && document.getElementById('toggleKecamatan').checked) map.addLayer(kecamatanLayer);
        }
        
        function updateLayerControls() {
            // Initialize layer controls based on current state
            const toggleHeatmap = document.getElementById('toggleHeatmap');
            const toggleMarkers = document.getElementById('toggleMarkers');
            const toggleKecamatan = document.getElementById('toggleKecamatan');
            
            if (toggleHeatmap && heatmapLayer) {
                toggleHeatmap.checked = map.hasLayer(heatmapLayer);
            }
            
            if (toggleMarkers && markerCluster) {
                toggleMarkers.checked = map.hasLayer(markerCluster);
            }
            
            if (toggleKecamatan && kecamatanLayer) {
                toggleKecamatan.checked = map.hasLayer(kecamatanLayer);
            }
        }
        
        function locateUser() {
            if (!map) return;
            
            if (!navigator.geolocation) {
                showNotification('Geolocation tidak didukung oleh browser Anda', 'error');
                return;
            }
            
            showNotification('Mendeteksi lokasi Anda...', 'info');
            
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Add marker for user location
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: `<div style="
                        background-color: #005f73;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                    ">
                        <i class="fas fa-user"></i>
                    </div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });
                
                // Remove existing user marker if any
                map.eachLayer(function(layer) {
                    if (layer.options && layer.options.icon === userIcon) {
                        map.removeLayer(layer);
                    }
                });
                
                // Add new marker
                L.marker([lat, lng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<strong>Lokasi Anda</strong>')
                    .openPopup();
                
                // Pan to user location
                map.setView([lat, lng], 13);
                
                showNotification('Lokasi Anda berhasil ditampilkan', 'success');
            }, function(error) {
                let errorMessage = 'Gagal mendapatkan lokasi Anda';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Akses lokasi ditolak. Izinkan akses lokasi di pengaturan browser.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Informasi lokasi tidak tersedia.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Permintaan lokasi waktu habis.';
                        break;
                }
                showNotification(errorMessage, 'error');
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
        
        function updateMapStatistics(pointCount, recipients, value, topDesaName) {
            document.getElementById('mapPointCount').textContent = pointCount;
            document.getElementById('mapTotalRecipients').textContent = recipients;
            document.getElementById('mapTotalValue').textContent = `Rp ${formatNumber(value)}`;
            
            if (topDesaName) {
                const desaName = topDesaName.split(',')[0];
                document.getElementById('topDesa').textContent = desaName;
            }
        }
        
        function showLocationDetail(desa, kecamatan) {
            // Filter data for this location
            const locationData = appData.filter(item => 
                item.desa === desa && item.kecamatan === kecamatan
            );
            
            if (locationData.length === 0) return;
            
            // Create detail content
            let detailContent = `
                <div class="p-3">
                    <h4 class="fw-bold text-primary">${desa}, ${kecamatan}</h4>
                    <p class="text-muted mb-4">Total ${locationData.length} penerima bantuan</p>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Kelompok</th>
                                    <th>Jenis</th>
                                    <th>Bantuan</th>
                                    <th>Jumlah</th>
                                    <th>Tahun</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            locationData.forEach((item, index) => {
                detailContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold">${item.nama}</td>
                        <td>${item.namaKelompok || '-'}</td>
                        <td><span class="badge bg-info">${item.jenisBantuan}</span></td>
                        <td>${item.namaBantuan}</td>
                        <td>${formatNumber(item.jumlahBantuan)} ${item.satuanBantuan}</td>
                        <td>${item.tahunAnggaran}</td>
                    </tr>
                `;
            });
            
            detailContent += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="fw-bold">Ringkasan Statistik:</h6>
                        <div class="row">
                            <div class="col-6">
                                <small>Total Nilai Bantuan:</small><br>
                                <strong class="text-success">
                                    Rp ${formatNumber(locationData.reduce((sum, item) => sum + (parseFloat(item.jumlahBantuan) || 0), 0))}
                                </strong>
                            </div>
                            <div class="col-6">
                                <small>Rata-rata per Penerima:</small><br>
                                <strong>
                                    Rp ${formatNumber(Math.round(locationData.reduce((sum, item) => sum + (parseFloat(item.jumlahBantuan) || 0), 0) / locationData.length))}
                                </strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update modal content and show
            const locationDetailContent = document.getElementById('locationDetailContent');
            if (locationDetailContent) {
                locationDetailContent.innerHTML = detailContent;
                new bootstrap.Modal(document.getElementById('locationDetailModal')).show();
            }
        }
        
        async function applyMapFilter() {
            const filterType = document.getElementById('mapFilterType').value;
            const filterValue = document.getElementById('mapFilterValue').value;
            
            if (filterType === 'all') {
                // Show all data
                await updateMapWithData(appData);
            } else {
                // Filter data
                let filteredMapData = [];
                
                if (filterType === 'kecamatan' && filterValue) {
                    filteredMapData = appData.filter(item => item.kecamatan === filterValue);
                } else if (filterType === 'tahun' && filterValue) {
                    filteredMapData = appData.filter(item => item.tahunAnggaran == filterValue);
                } else if (filterType === 'jenis' && filterValue) {
                    filteredMapData = appData.filter(item => item.jenisBantuan === filterValue);
                } else {
                    filteredMapData = appData;
                }
                
                await updateMapWithData(filteredMapData);
                showNotification(`Filter diterapkan: ${filteredMapData.length} data ditampilkan`, 'success');
            }
        }
        
        async function resetMapFilter() {
            document.getElementById('mapFilterType').value = 'all';
            document.getElementById('mapFilterValueContainer').style.display = 'none';
            await updateMapWithData(appData);
            showNotification('Filter peta direset', 'info');
        }
        
        function searchMapLocation() {
            const searchTerm = document.getElementById('mapSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                showNotification('Masukkan nama desa atau kecamatan untuk dicari', 'warning');
                return;
            }
            
            // Search in coordinates database
            let foundLocation = null;
            let foundKey = null;
            
            // Search in all possible keys
            const allKeys = [...Object.keys(koordinatDesa), ...Object.keys(koordinatKecamatan), ...Object.keys(coordinatesCache)];
            
            for (const key of allKeys) {
                if (key.toLowerCase().includes(searchTerm)) {
                    foundKey = key;
                    break;
                }
            }
            
            if (foundKey) {
                // Get coordinates from the appropriate source
                if (koordinatDesa[foundKey]) {
                    foundLocation = { key: foundKey, coords: koordinatDesa[foundKey] };
                } else if (coordinatesCache[foundKey]) {
                    foundLocation = { key: foundKey, coords: coordinatesCache[foundKey] };
                } else if (koordinatKecamatan[foundKey]) {
                    foundLocation = { key: foundKey, coords: koordinatKecamatan[foundKey] };
                }
            }
            
            if (foundLocation) {
                // Zoom to location
                map.setView([foundLocation.coords.lat, foundLocation.coords.lng], 14);
                
                // Open popup if there's data for this location
                const dataForLocation = appData.filter(item => {
                    const itemKey = `${item.desa}, ${item.kecamatan}`;
                    return itemKey.includes(foundLocation.key) || item.kecamatan === foundLocation.key;
                });
                
                if (dataForLocation.length > 0) {
                    // Find and open marker popup
                    mapMarkers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (markerLatLng.lat.toFixed(4) === foundLocation.coords.lat.toFixed(4) &&
                            markerLatLng.lng.toFixed(4) === foundLocation.coords.lng.toFixed(4)) {
                            marker.openPopup();
                        }
                    });
                }
                
                showNotification(`Lokasi ditemukan: ${foundLocation.key}`, 'success');
            } else {
                showNotification('Lokasi tidak ditemukan', 'error');
            }
        }
        
        function clearMapSearch() {
            document.getElementById('mapSearch').value = '';
        }
        
        // --- RELOAD DATA ---
        function handleReloadFromRepo(callback) {
            const btn = document.getElementById('btn-reload-repo');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin feature-icon"></i> Loading...';
            btn.disabled = true;

            const oldScript = document.querySelector('#reload-script');
            if(oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'reload-script';
            script.src = './reload.js?v=' + new Date().getTime(); 

            script.onload = function() {
                try {
                    if (window.BARJAS_BACKUP_ENCRYPTED) {
                        const rawContent = window.BARJAS_BACKUP_ENCRYPTED;
                        let restored;
                        try {
                            if (typeof rawContent === 'string') {
                                restored = JSON.parse(decodeURIComponent(escape(atob(rawContent))));
                            } else {
                                restored = rawContent;
                            }
                        } catch (decryptionError) {
                            throw new Error("Gagal mendekripsi data.");
                        }
                        
                        if(restored && restored.appData && Array.isArray(restored.appData)) {
                            
                            const existingIds = new Set(appData.map(item => item.id));
                            let addedCount = 0;

                            restored.appData.forEach(newItem => {
                                if (!existingIds.has(newItem.id)) {
                                    appData.push(newItem);
                                    existingIds.add(newItem.id); 
                                    addedCount++;
                                }
                            });

                            saveData();
                            updateDashboard();
                            renderDataTable();
                            
                            // Update map if it's currently visible
                            if (document.getElementById('v-pills-map').classList.contains('active')) {
                                updateMapWithData(appData);
                            }
                            
                            if (addedCount > 0) {
                                showNotification(`Berhasil reload! ${addedCount} data baru ditambahkan.`, 'success');
                            } else {
                                showNotification('Reload selesai. Tidak ada data baru yang ditemukan.', 'info');
                            }

                        } else {
                            throw new Error('Format data tidak valid.');
                        }
                    } else {
                        throw new Error('Variabel backup tidak ditemukan di reload.js.');
                    }
                } catch (e) {
                    showNotification('Error: ' + e.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    delete window.BARJAS_BACKUP_ENCRYPTED;
                    
                    if (callback) callback();
                }
            };

            script.onerror = function() {
                showNotification('Gagal memuat file reload.js. Pastikan file ada di folder yang sama.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (callback) callback();
            };
            document.body.appendChild(script);
        }

        // --- UTILS ---
        function toggleMobileMenu() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarMenu) sidebarMenu.classList.toggle('mobile-show');
            if (sidebarOverlay) sidebarOverlay.classList.toggle('mobile-show');
        }
        
        function showNotification(message, type = 'info') {
            if (!appSettings.notifications) return;
            
            const toastEl = document.querySelector('.notification-toast');
            if (!toastEl) return;
            
            const toastHeader = toastEl.querySelector('.toast-header');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toastMessage) return;
            
            toastMessage.textContent = message;
            
            const styles = {
                success: { bg: 'bg-success-subtle', text: 'text-success-emphasis', title: 'Berhasil' },
                error: { bg: 'bg-danger-subtle', text: 'text-danger-emphasis', title: 'Gagal' },
                warning: { bg: 'bg-warning-subtle', text: 'text-warning-emphasis', title: 'Peringatan' },
                info: { bg: 'bg-primary-subtle', text: 'text-primary-emphasis', title: 'Informasi' }
            };
            
            if (toastHeader) {
                toastHeader.className = `toast-header ${styles[type].bg} ${styles[type].text}`;
            }
            
            if (toastTitle) {
                toastTitle.textContent = styles[type].title;
            }
            
            try {
                new bootstrap.Toast(toastEl).show();
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function formatNumber(num) {
            if (isNaN(num) || num === undefined || num === null) return num; 
            try {
                return new Intl.NumberFormat('id-ID').format(num);
            } catch (error) {
                return num;
            }
        }
        
        function formatPrivacy(value) {
            if (!appSettings.privacyMode) return value;
            if (!value) return '-';
            const str = String(value);
            if (str.length <= 4) return '****';
            return str.slice(0, -4) + '****';
        }

        // Ekspor fungsi ke global scope
        window.showLocationDetail = showLocationDetail;
        window.changePage = changePage;
    </script>
</body>
</html>
