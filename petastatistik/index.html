<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETA STATISTIK DATA NELAYAN - KAB. SITUBONDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            /* Palette: Blue, Green, Gold */
            --primary-color: #005f73; /* Deep Teal Blue */
            --secondary-color: #0a9396; /* Emerald Green */
            --accent-color: #ca6702; /* Burnt Orange/Gold */
            
            --dark-blue: #001219;
            --light-bg: #f0f4f8;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            --gradient-header: linear-gradient(120deg, #003049 0%, #005f73 40%, #0a9396 70%, #ca6702 100%);
            --gradient-secondary: linear-gradient(135deg, #0a9396, #94d2bd);
            --gradient-accent: linear-gradient(135deg, #ca6702, #ee9b00);
            
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.15);
            
            --glass-effect: rgba(255, 255, 255, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Layout Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-effect);
            box-shadow: var(--shadow-lg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Header - Modified */
        .app-header {
            background: var(--gradient-header);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #ee9b00;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .app-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .app-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: #ffecd1;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: inline-block;
            padding-top: 10px;
        }
        
        /* Navigation */
        .col-md-3.col-lg-2.bg-light {
            background-color: #f8f9fa !important;
            border-right: 1px solid #e9ecef;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 14px 20px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #e3f2fd;
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-left: 4px solid #ee9b00;
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
            color: white;
        }

        /* Content Styling */
        .section-title {
            font-family: 'Montserrat', sans-serif;
            border-left: 5px solid #ee9b00;
            padding-left: 15px;
            margin: 25px 0;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 1.6rem;
            position: relative;
            background: linear-gradient(to right, rgba(238, 155, 0, 0.1), transparent);
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            padding: 10px 20px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 95, 115, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #001219 0%, #004d40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 95, 115, 0.4);
        }
        
        .btn-success {
            background: var(--gradient-secondary);
            border: none;
        }
        
        .btn-warning {
            background: var(--gradient-accent);
            color: white;
            border: none;
        }

        /* Forms */
        .form-label {
            font-weight: 600;
            color: #2b2d42;
            font-size: 0.9rem;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            font-size: 0.95rem;
            background-color: #fdfdfd;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(10, 147, 150, 0.2);
            background-color: white;
        }
        
        /* Tables */
        .data-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: none;
            white-space: nowrap;
        }
        
        .data-table th {
            background: var(--primary-color) !important; 
            background: linear-gradient(90deg, #005f73, #0a9396) !important;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
        }
        
        .data-table td {
            border-bottom: 1px solid #e9ecef;
            padding: 12px 10px;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: #e0f2f1;
        }
        
        /* Cards & Stats */
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-sm);
            background: white;
        }
        
        .card-header {
            background: linear-gradient(90deg, #005f73, #001219);
            color: white;
            font-weight: 600;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        
        .stats-box {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border-left: 5px solid var(--accent-color);
            transition: transform 0.3s;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Login Modal */
        .login-header {
            background: var(--gradient-header);
            border-bottom: 4px solid #ee9b00;
            padding-bottom: 20px;
            padding-top: 20px;
        }
        
        .login-header .fa-ship {
            padding: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .btn-login {
            background: linear-gradient(90deg, #005f73, #0a9396, #ee9b00);
            background-size: 200% auto;
            transition: 0.5s;
        }
        
        .btn-login:hover {
            background-position: right center;
        }

        /* Footer */
        .copyright {
            background-color: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }
        
        .feature-icon {
            width: 25px;
            text-align: center;
        }

        /* Utils */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1050; min-width: 280px; }
        .input-error { border-color: #dc3545 !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important; }
        .error-message { color: #dc3545; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: 500; }
        .watermark { position: absolute; bottom: 10px; right: 15px; opacity: 0.8; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-weight: 300; letter-spacing: 1px;}
        
        /* Floating Buttons */
        .floating-action-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1045;
            transition: all 0.4s;
            font-size: 1.4rem;
            border: none;
            box-shadow: 0 5px 15px rgba(202, 103, 2, 0.4);
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            background: #ee9b00;
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.4);
        }

        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1050; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; box-shadow: var(--shadow-lg); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        /* Map Styling */
        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }
        
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            max-width: 300px;
        }
        
        .leaflet-popup-content h4 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .map-legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 250px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            max-width: 300px;
        }
        
        .cluster-marker {
            background: var(--primary-color);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.3);
        }
        
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; }
            .col-md-3.col-lg-2 { position: fixed; left: -300px; top: 0; bottom: 0; z-index: 1050; width: 280px; transition: left 0.3s ease; overflow-y: auto; padding-top: 60px; background: white; }
            .col-md-3.col-lg-2.mobile-show { left: 0; }
            .col-md-9.col-lg-10 { width: 100%; flex: 0 0 100%; max-width: 100%; }
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar-overlay.mobile-show { display: block; }
            .app-title { font-size: 1.3rem; line-height: 1.3; }
            .app-logo { font-size: 2.5rem; margin-bottom: 10px; }
            .app-header { padding: 70px 15px 30px 15px; }
            .col-md-9.col-lg-10.p-5 { padding: 1.5rem !important; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .floating-action-btn { bottom: 20px; right: 20px; }
            #map { height: 400px; }
            .map-controls, .map-legend { position: relative; top: auto; bottom: auto; right: auto; margin-bottom: 15px; max-width: 100%; }
        }

        @media print {
            @page { size: landscape; margin: 0.5cm; }
            body * { visibility: hidden; }
            .app-container, .app-container * { visibility: visible; }
            .app-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .nav-pills, .mobile-menu-btn, .sidebar-overlay, .floating-action-btn, .btn-group, .filter-section, .toast, .col-md-3.col-lg-2 { display: none !important; }
            .col-md-9.col-lg-10 { width: 100%; flex: 0 0 100%; max-width: 100%; padding: 0 !important; }
            .data-table th:last-child, .data-table td:last-child { display: none !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 15px; }
        }

        .spinner-border-sm { width: 1rem; height: 1rem; }
        .app-content-unauthenticated { display: none; }
        
        /* New Info Style */
        .info-pill {
            background: rgba(0, 95, 115, 0.05);
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        /* Detail Modal */
        .detail-modal-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .detail-modal-value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--secondary-color);
            margin-bottom: 15px;
        }
        
        /* Welcome Modal */
        .welcome-modal {
            background: linear-gradient(135deg, #001219 0%, #005f73 50%, #0a9396 100%);
            color: white;
        }
        
        .welcome-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ee9b00;
        }
        
        .welcome-modal .btn-welcome {
            background: linear-gradient(90deg, #ee9b00, #ca6702);
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .welcome-modal .btn-welcome:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(238, 155, 0, 0.3);
        }

        /* Logo */
        .logo-garuda {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .logo-garuda-sm {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        /* Filter Container */
        .filter-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="modal fade login-modal" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: none;">
                <div class="login-header">
                    <div class="text-center mb-2">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                             alt="Logo Garuda" class="logo-garuda">
                    </div>
                    <h2 class="text-center text-white fw-bold mb-0" style="font-family: 'Montserrat'; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">AUTHENTICATION</h2>
                    <p class="text-center text-white-50 mb-0 small">Peta Statistik Data Nelayan Kab. Situbondo</p>
                </div>
                <div class="login-body p-4">
                    <form id="loginForm">
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-key me-2 text-primary"></i> Kode Keamanan
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="securityCode" placeholder="Masukkan kode akses..." style="padding: 12px;">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text text-danger mt-2 fw-bold text-center" id="attemptsCount" style="display:none;"></div>
                            
                            <div class="info-pill mt-4">
                                <div class="small text-uppercase fw-bold text-primary mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">
                                    <i class="fas fa-shield-alt me-1"></i> System Information
                                </div>
                                <div class="fw-bold text-dark" style="font-size: 0.9rem;">
                                    BIDANG PEMBERDAYAAN NELAYAN
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-login text-white w-100 py-3 fw-bold shadow-sm" id="loginButton">
                                    <span class="login-button-text">MASUK SISTEM</span>
                                    <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="login-blocked-message d-none mt-3 p-3 rounded bg-danger bg-opacity-10 text-danger text-center" id="blockedMessage">
                            <i class="fas fa-ban me-2"></i>
                            <span id="blockedText">Akses diblokir sementara karena terlalu banyak percobaan. </span>
                            <span class="fw-bold" id="countdown">30</span> detik.
                        </div>
                        
                        <div class="text-center mt-4 small text-muted">
                            &copy; 2025 Dinas Peternakan dan Perikanan
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda mb-4">
                    <h3 class="fw-bold mb-3">Memuat Data...</h3>
                    <p id="welcomeMessage">Sistem sedang memuat data dari repository. Harap tunggu sebentar.</p>
                    
                    <div class="spinner-border text-primary mt-4" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    
                    <div class="mt-4 small text-white-50">
                        <i class="fas fa-info-circle me-1"></i>
                        Proses ini mungkin memakan waktu beberapa detik
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-content-unauthenticated" id="appContent">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/garuda.png" 
                         alt="Logo Garuda" class="logo-garuda">
                </div>
                <h1 class="app-title">PETA STATISTIK DATA NELAYAN<br>KABUPATEN SITUBONDO</h1>
                <p class="app-subtitle">Dinas Peternakan dan Perikanan Kabupaten Situbondo</p>
                <div class="watermark">Visualization Edition v2.0</div>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 p-4 bg-light" id="sidebarMenu">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button" role="tab">
                            <i class="fas fa-tachometer-alt feature-icon"></i> Dashboard
                        </button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button" role="tab">
                            <i class="fas fa-database feature-icon"></i> Data Bantuan
                        </button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button" role="tab">
                            <i class="fas fa-filter feature-icon"></i> Filter Data
                        </button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button" role="tab">
                            <i class="fas fa-print feature-icon"></i> Cetak Laporan
                        </button>
                        <button class="nav-link" id="v-pills-map-tab" data-bs-toggle="pill" data-bs-target="#v-pills-map" type="button" role="tab">
                            <i class="fas fa-map-marked-alt feature-icon"></i> Visual Peta
                        </button>
                        <button class="nav-link" id="btn-reload-repo" type="button">
                            <i class="fas fa-sync-alt feature-icon"></i> Reload Data
                        </button>
                        <button class="nav-link text-danger mt-3" id="v-pills-logout-tab" type="button" style="border: 1px solid #dc3545;">
                            <i class="fas fa-sign-out-alt feature-icon"></i> Keluar
                        </button>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-5">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                            <h3 class="section-title">Dashboard Overview</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Penerima</div>
                                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold" id="totalPenerima">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: var(--secondary-color);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Total Bantuan (Rp)</div>
                                            <i class="fas fa-money-bill-wave fa-2x text-success opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-success" id="totalBantuan">0</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #ffc107;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Tahun Aktif</div>
                                            <i class="fas fa-calendar-alt fa-2x text-warning opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-warning" id="tahunAktif">2025</div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-4">
                                    <div class="stats-box p-4" style="border-left-color: #17a2b8;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="stats-label text-muted">Rata-rata</div>
                                            <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                                        </div>
                                        <div class="stats-number h2 fw-bold text-info" id="rataBantuan">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-pie me-2"></i> Distribusi per Kecamatan</div>
                                        <div class="card-body"><canvas id="kecamatanChart" height="250"></canvas></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header"><i class="fas fa-chart-bar me-2"></i> Tren Bantuan Tahunan</div>
                                        <div class="card-body"><canvas id="tahunChart" height="250"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-history me-2"></i> Transaksi Terbaru</div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover data-table mb-0">
                                                    <thead><tr><th>Tanggal</th><th>Nama Penerima</th><th>Desa</th><th>Jenis Bantuan</th><th>Jumlah</th></tr></thead>
                                                    <tbody id="recentData"><tr><td colspan="5" class="text-center p-4">Tidak ada data</td></tr></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-data" role="tabpanel">
                            <h3 class="section-title">Database Bantuan</h3>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <span><i class="fas fa-database me-2"></i> Daftar Penerima (View Only)</span>
                                    <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
                                        <select class="form-select form-select-sm" id="filterKecamatanData" style="width: auto;">
                                            <option value="">Semua Kecamatan</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="filterDesaData" style="width: auto;">
                                            <option value="">Semua Desa</option>
                                        </select>
                                        <div class="input-group" style="max-width: 300px;">
                                            <input type="text" class="form-control form-control-sm" id="searchData" placeholder="Cari data...">
                                            <button class="btn btn-sm btn-light border" id="clearSearchBtn"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>WhatsApp</th><th>Kelompok</th>
                                                    <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                                    <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th><th>Dokumen</th>
                                                    <th>Validasi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                                <tr><td colspan="16" class="text-center py-4">Memuat data...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                                        <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                        <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-filter" role="tabpanel">
                            <h3 class="section-title">Filter Lanjutan</h3>
                            <div class="card mb-4">
                                <div class="card-header"><i class="fas fa-filter me-2"></i> Parameter Filter</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Tahun</label>
                                            <select class="form-select" id="filterTahun"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Kecamatan</label>
                                            <select class="form-select" id="filterKecamatan"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Desa</label>
                                            <select class="form-select" id="filterDesa"></select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Jenis Bantuan</label>
                                            <select class="form-select" id="filterJenis">
                                                <option value="">Semua Jenis</option>
                                                <option value="Uang">Uang</option>
                                                <option value="Barang">Barang</option>
                                                <option value="Jasa">Jasa</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <button class="btn btn-secondary me-2" id="resetFilterBtn"><i class="fas fa-undo me-1"></i> Reset</button>
                                        <button class="btn btn-primary" id="applyFilterBtn"><i class="fas fa-check me-1"></i> Terapkan</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list me-2"></i> Hasil Filter</span>
                                    <span class="badge bg-warning text-dark" id="filterResultCount">0 Data</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table mb-0" id="filterTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th><th>Nama</th><th>NIK</th><th>WhatsApp</th><th>Kelompok</th>
                                                    <th>Jabatan</th><th>Tahun</th><th>Kecamatan</th><th>Desa</th><th>Jenis</th>
                                                    <th>Bantuan</th><th>Jumlah</th><th>Tanggal</th><th>Petugas</th><th>Dokumen</th><th>Validasi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="filterTableBody">
                                                <tr><td colspan="16" class="text-center py-4">Silakan terapkan filter</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="v-pills-print" role="tabpanel">
                            <h3 class="section-title">Cetak Laporan</h3>
                            <div class="card">
                                <div class="card-header"><i class="fas fa-print me-2"></i> Konfigurasi Cetak</div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <label class="form-label">Tahun</label>
                                            <select class="form-select" id="printTahun"></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Kecamatan</label>
                                            <select class="form-select" id="printKecamatan"></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Jenis Bantuan</label>
                                            <select class="form-select" id="printJenis">
                                                <option value="">Semua Jenis</option>
                                                <option value="Uang">Uang</option>
                                                <option value="Barang">Barang</option>
                                                <option value="Jasa">Jasa</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="p-4 border rounded bg-light text-center h-100">
                                                <i class="fas fa-eye fa-3x text-info mb-3"></i>
                                                <h5>Pratinjau Layar</h5>
                                                <button class="btn btn-info text-white mt-2 w-100" id="previewBtn">Buka Pratinjau</button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="p-4 border rounded bg-light text-center h-100">
                                                <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                                <h5>Unduh PDF</h5>
                                                <button class="btn btn-danger mt-2 w-100" id="printPdfBtn">Download Laporan PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TAB PANEL BARU: Visual Peta -->
                        <div class="tab-pane fade" id="v-pills-map" role="tabpanel">
                            <h3 class="section-title">Visualisasi Peta Statistik Data Nelayan</h3>
                            <div class="card mb-4">
                                <div class="card-header"><i class="fas fa-map-marked-alt me-2"></i> Peta Sebaran Data Bantuan</div>
                                <div class="card-body p-0 position-relative">
                                    <div id="map"></div>
                                    
                                    <div class="map-controls">
                                        <h6 class="fw-bold mb-3">Kontrol Peta</h6>
                                        <div class="mb-3">
                                            <label class="form-label small">Tampilkan berdasarkan:</label>
                                            <select class="form-select form-select-sm" id="mapFilterType">
                                                <option value="all">Semua Data</option>
                                                <option value="kecamatan">Kecamatan</option>
                                                <option value="tahun">Tahun</option>
                                                <option value="jenis">Jenis Bantuan</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="mapFilterValueContainer" style="display: none;">
                                            <select class="form-select form-select-sm" id="mapFilterValue"></select>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100" id="applyMapFilter">
                                            <i class="fas fa-filter me-1"></i> Terapkan Filter
                                        </button>
                                    </div>
                                    
                                    <div class="map-legend">
                                        <h6 class="fw-bold mb-3">Legenda Peta</h6>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #005f73;"></div>
                                            <span>1-10 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #0a9396;"></div>
                                            <span>11-50 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #94d2bd;"></div>
                                            <span>51-100 Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #ee9b00;"></div>
                                            <span>100+ Penerima</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #ca6702; border: 2px solid #001219;"></div>
                                            <span>Pusat Kecamatan</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-info-circle me-2"></i> Informasi Peta</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Statistik Peta:</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-map-marker-alt text-primary me-2"></i> Titik Data: <span id="mapPointCount">0</span></li>
                                                <li><i class="fas fa-users text-success me-2"></i> Total Penerima: <span id="mapTotalRecipients">0</span></li>
                                                <li><i class="fas fa-money-bill-wave text-warning me-2"></i> Total Nilai Bantuan: <span id="mapTotalValue">Rp 0</span></li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Keterangan:</h6>
                                            <p class="small text-muted">
                                                Peta ini menampilkan sebaran data penerima bantuan nelayan di Kabupaten Situbondo. 
                                                Setiap titik mewakili lokasi desa dengan informasi detail penerima bantuan.
                                                Klik pada titik untuk melihat detail data.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright text-center py-3">
                &copy; 2025 Dinas Peternakan dan Perikanan Kabupaten Situbondo - Bidang Pemberdayaan Nelayan.
            </div>
        </div>
        
        <button class="floating-action-btn" id="fabBtn" title="Buka Peta Statistik">
            <i class="fas fa-map-marked-alt"></i>
        </button>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast notification-toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Detail Data -->
    <div class="modal fade" id="detailDataModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i> Detail Data Bantuan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-modal-label">Nama Penerima</div>
                            <div class="detail-modal-value" id="detailNama">-</div>
                            
                            <div class="detail-modal-label">NIK</div>
                            <div class="detail-modal-value" id="detailNik">-</div>
                            
                            <div class="detail-modal-label">WhatsApp</div>
                            <div class="detail-modal-value" id="detailWhatsapp">-</div>
                            
                            <div class="detail-modal-label">Kelompok</div>
                            <div class="detail-modal-value" id="detailKelompok">-</div>
                            
                            <div class="detail-modal-label">Jabatan</div>
                            <div class="detail-modal-value" id="detailJabatan">-</div>
                            
                            <div class="detail-modal-label">Tahun Anggaran</div>
                            <div class="detail-modal-value" id="detailTahun">-</div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-modal-label">Kecamatan</div>
                            <div class="detail-modal-value" id="detailKecamatan">-</div>
                            
                            <div class="detail-modal-label">Desa</div>
                            <div class="detail-modal-value" id="detailDesa">-</div>
                            
                            <div class="detail-modal-label">Alamat</div>
                            <div class="detail-modal-value" id="detailAlamat">-</div>
                            
                            <div class="detail-modal-label">Jenis Bantuan</div>
                            <div class="detail-modal-value" id="detailJenisBantuan">-</div>
                            
                            <div class="detail-modal-label">Nama Bantuan</div>
                            <div class="detail-modal-value" id="detailNamaBantuan">-</div>
                            
                            <div class="detail-modal-label">Jumlah Bantuan</div>
                            <div class="detail-modal-value" id="detailJumlahBantuan">-</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="detail-modal-label">Tanggal Menerima</div>
                            <div class="detail-modal-value" id="detailTanggal">-</div>
                            
                            <div class="detail-modal-label">Nama Petugas</div>
                            <div class="detail-modal-value" id="detailPetugas">-</div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-modal-label">Link Google Drive</div>
                            <div class="detail-modal-value" id="detailDriveLink">-</div>
                            
                            <div class="detail-modal-label">Kode Validasi</div>
                            <div class="detail-modal-value" id="detailKodeValidasi">-</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="detail-modal-label">Keterangan</div>
                            <div class="detail-modal-value" id="detailKeterangan">-</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalTitle">Pratinjau Dokumen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printFromPreviewBtn"><i class="fas fa-print me-1"></i> Cetak Sekarang</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        let appData = [];
        let appSettings = {
            securityCode: 'BidangPN1945',
            itemsPerPage: 25,
            notifications: true,
            appName: 'PETA STATISTIK DATA NELAYAN',
            appSubtitle: 'Dinas Peternakan dan Perikanan Kab. Situbondo',
            defaultTahun: new Date().getFullYear(),
            lastBackupDate: '-',
            privacyMode: true
        };
        let currentPage = 1;
        let filteredData = [];
        let isFilterActive = false;
        let loginAttempts = 0;
        let isBlocked = false;
        let blockTimeout;
        let generatedCodes = {};
        
        // Variables for map
        let map = null;
        let mapMarkers = [];
        let mapLayer = null;
        
        const SECURITY_CONSTANTS = {
            PIN: '17081945',
            DEFAULT_PASS: 'BidangPN1945'
        };

        const kecamatanList = [
            "Arjasa", "Asembagus", "Banyuglugur", "Banyuputih", "Besuki", 
            "Bungatan", "Jangkar", "Jatibanteng", "Kapongan", "Kendit", 
            "Mangaran", "Mlandingan", "Panarukan", "Panji", "Situbondo", 
            "Suboh", "Sumbermalang"
        ];
        
        const desaList = [
            "Agel", "Alas Bayur", "Alasmalang", "Alastengah", "Arjasa", "Ardirejo", "Asembagus", 
            "Awar-awar", "Awang-awang", "Baderan", "Balung", "Bantal", "Battal", "Bayeman", "Besuki", "Bletok", "Blimbing", "Bloro", "Buduan", "Bugeman", "Bungatan", 
            "Campoan", "Cemara", "Curah Cottok", "Curah Jeru", "Curah Kalak", "Curah Suri", "Curah Tatal", "Dawuhan", "Demung", "Duwet", "Gadingan", "Gebangan", 
            "Gelung", "Gudang", "Gunung Malang", "Gunung Putri", "Jangkar", "Jatisari", "Jatibanteng", "Jetis", "Juglangan", "Kalianget", "Kalibagor", "Kalimas", 
            "Kalirejo", "Kalisari", "Kandang", "Kayu Putih", "Kayumas", "Kedungdowo", "Kedunglo", "Kembangsari", "Ketah", "Ketawan", "Kilensari", "Klampokan", 
            "Klatakan", "Kotakan", "Kumbangsari", "Kukusan", "Lamongan", "Landangan", "Langkap", "Lebeng", "Lubawang", "Mangaran", "Mimbaan", "Mlandingan Kulon", 
            "Mlandingan Wetan", "Mojodungkol", "Mojosari", "Olean", "Palangan", "Panarukan", "Panji Kidul", "Panji Lor", "Parante", "Pasir Putih", "Patemon", 
            "Patokan", "Paowan", "Peleyan", "Pesisir", "Pesanggrahan", "Pategalan", "Plalangan", "Pokaan", "Rajekwesi", "Seletreng", "Selobanteng", 
            "Selomukti", "Selowogo", "Semambung", "Semiring", "Sliwung", "Sopet", "Sumber Pinang", "Sumberanyar", "Sumberargo", "Sumberkolak", "Sumberejo", 
            "Sumbertengah", "Sumberwaru", "Tamankursi", "Tamansari", "Taman", "Talkandang", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Tambak Ukir", 
            "Telempong", "Tenggir", "Tepos", "Tokelan", "Tlogosari", "Trigonco", "Trebungan", "Widoropayung", "Wonokoyo", "Wonorejo", "Wringinanom"
        ].sort();
        
        // Database koordinat desa Situbondo
        const koordinatDesa = {
            // Kecamatan Arjasa
            "Arjasa, Arjasa": { lat: -7.7069, lng: 113.6347 },
            "Biting, Arjasa": { lat: -7.7200, lng: 113.6430 },
            "Candijati, Arjasa": { lat: -7.7120, lng: 113.6280 },
            "Darsono, Arjasa": { lat: -7.6980, lng: 113.6200 },
            "Jatisari, Arjasa": { lat: -7.7150, lng: 113.6150 },
            "Kamal, Arjasa": { lat: -7.7020, lng: 113.6300 },
            "Lamongan, Arjasa": { lat: -7.6856, lng: 113.6189 },
            
            // Kecamatan Asembagus
            "Asembagus, Asembagus": { lat: -7.7536, lng: 114.1561 },
            "Banyuputih, Asembagus": { lat: -7.7600, lng: 114.1400 },
            "Kedunglo, Asembagus": { lat: -7.7450, lng: 114.1500 },
            "Kertosari, Asembagus": { lat: -7.7550, lng: 114.1600 },
            "Mojosari, Asembagus": { lat: -7.7480, lng: 114.1650 },
            "Trigonco, Asembagus": { lat: -7.7580, lng: 114.1550 },
            
            // Kecamatan Banyuglugur
            "Banyuglugur, Banyuglugur": { lat: -7.7211, lng: 113.8883 },
            "Kalianget, Banyuglugur": { lat: -7.7300, lng: 113.8800 },
            "Kalisari, Banyuglugur": { lat: -7.7150, lng: 113.8950 },
            "Sumberanyar, Banyuglugur": { lat: -7.7100, lng: 113.9000 },
            "Tlogosari, Banyuglugur": { lat: -7.7250, lng: 113.9100 },
            "Wonorejo, Banyuglugur": { lat: -7.7200, lng: 113.8850 },
            
            // Kecamatan Banyuputih
            "Banyuputih, Banyuputih": { lat: -7.7608, lng: 114.0200 },
            "Sumberargo, Banyuputih": { lat: -7.7550, lng: 114.0150 },
            "Sumberejo, Banyuputih": { lat: -7.7650, lng: 114.0250 },
            "Wonorejo, Banyuputih": { lat: -7.7500, lng: 114.0300 },
            "Wringinanom, Banyuputih": { lat: -7.7400, lng: 114.0100 },
            "Kalirejo, Banyuputih": { lat: -7.7450, lng: 114.0200 },
            
            // Kecamatan Besuki
            "Besuki, Besuki": { lat: -7.7333, lng: 113.7000 },
            "Blimbing, Besuki": { lat: -7.7400, lng: 113.7100 },
            "Demung, Besuki": { lat: -7.7300, lng: 113.6900 },
            "Jetis, Besuki": { lat: -7.7200, lng: 113.7050 },
            "Kayu Putih, Besuki": { lat: -7.7250, lng: 113.7150 },
            "Langkap, Besuki": { lat: -7.7350, lng: 113.6950 },
            
            // Kecamatan Bungatan
            "Bungatan, Bungatan": { lat: -7.6833, lng: 113.8833 },
            "Cemara, Bungatan": { lat: -7.6900, lng: 113.8900 },
            "Kesambirampak, Bungatan": { lat: -7.6800, lng: 113.8750 },
            "Patemon, Bungatan": { lat: -7.6950, lng: 113.8850 },
            "Sliwung, Bungatan": { lat: -7.6850, lng: 113.8800 },
            "Talkandang, Bungatan": { lat: -7.6750, lng: 113.8900 },
            
            // Kecamatan Jangkar
            "Jangkar, Jangkar": { lat: -7.7500, lng: 114.0833 },
            "Curah Kalak, Jangkar": { lat: -7.7550, lng: 114.0900 },
            "Curah Tatal, Jangkar": { lat: -7.7450, lng: 114.0800 },
            "Pategalan, Jangkar": { lat: -7.7600, lng: 114.0850 },
            "Pokaan, Jangkar": { lat: -7.7500, lng: 114.0950 },
            "Widoropayung, Jangkar": { lat: -7.7450, lng: 114.0900 },
            
            // Kecamatan Jatibanteng
            "Jatibanteng, Jatibanteng": { lat: -7.7167, lng: 113.9833 },
            "Curah Cottok, Jatibanteng": { lat: -7.7200, lng: 113.9900 },
            "Kembangsari, Jatibanteng": { lat: -7.7100, lng: 113.9800 },
            "Ketah, Jatibanteng": { lat: -7.7150, lng: 113.9750 },
            "Sumberanyar, Jatibanteng": { lat: -7.7250, lng: 113.9850 },
            "Wringinanom, Jatibanteng": { lat: -7.7100, lng: 113.9900 },
            
            // Kecamatan Kapongan
            "Kapongan, Kapongan": { lat: -7.6833, lng: 114.0167 },
            "Curah Jeru, Kapongan": { lat: -7.6900, lng: 114.0200 },
            "Kedungdowo, Kapongan": { lat: -7.6800, lng: 114.0150 },
            "Peleyan, Kapongan": { lat: -7.6750, lng: 114.0100 },
            "Wonokoyo, Kapongan": { lat: -7.6850, lng: 114.0250 },
            "Klabang, Kapongan": { lat: -7.6900, lng: 114.0150 },
            
            // Kecamatan Kendit
            "Kendit, Kendit": { lat: -7.7333, lng: 113.9333 },
            "Balung, Kendit": { lat: -7.7400, lng: 113.9400 },
            "Klatakan, Kendit": { lat: -7.7300, lng: 113.9350 },
            "Kotakan, Kendit": { lat: -7.7350, lng: 113.9300 },
            "Rajekwesi, Kendit": { lat: -7.7250, lng: 113.9250 },
            "Semambung, Kendit": { lat: -7.7380, lng: 113.9280 },
            
            // Kecamatan Mangaran
            "Mangaran, Mangaran": { lat: -7.6667, lng: 114.0667 },
            "Gudang, Mangaran": { lat: -7.6700, lng: 114.0700 },
            "Ketawan, Mangaran": { lat: -7.6600, lng: 114.0600 },
            "Semiring, Mangaran": { lat: -7.6650, lng: 114.0650 },
            "Tamankursi, Mangaran": { lat: -7.6750, lng: 114.0750 },
            "Tanjung Pecinan, Mangaran": { lat: -7.6680, lng: 114.0680 },
            
            // Kecamatan Mlandingan
            "Mlandingan Kulon, Mlandingan": { lat: -7.6833, lng: 113.9500 },
            "Mlandingan Wetan, Mlandingan": { lat: -7.6800, lng: 113.9550 },
            "Sumber Pinang, Mlandingan": { lat: -7.6900, lng: 113.9450 },
            "Sumberwaru, Mlandingan": { lat: -7.6850, lng: 113.9600 },
            "Tamansari, Mlandingan": { lat: -7.6750, lng: 113.9500 },
            
            // Kecamatan Panarukan
            "Panarukan, Panarukan": { lat: -7.7000, lng: 113.9167 },
            "Duwet, Panarukan": { lat: -7.7050, lng: 113.9200 },
            "Kebonagung, Panarukan": { lat: -7.6950, lng: 113.9150 },
            "Kedunglo, Panarukan": { lat: -7.7100, lng: 113.9250 },
            "Patokan, Panarukan": { lat: -7.7000, lng: 113.9100 },
            "Peleyan, Panarukan": { lat: -7.6950, lng: 113.9200 },
            
            // Kecamatan Panji
            "Panji Kidul, Panji": { lat: -7.7167, lng: 113.6667 },
            "Panji Lor, Panji": { lat: -7.7100, lng: 113.6700 },
            "Curah Jeru, Panji": { lat: -7.7200, lng: 113.6750 },
            "Kampung Anyar, Panji": { lat: -7.7150, lng: 113.6650 },
            "Karanganyar, Panji": { lat: -7.7050, lng: 113.6600 },
            "Kebonagung, Panji": { lat: -7.7120, lng: 113.6680 },
            
            // Kecamatan Situbondo
            "Situbondo, Situbondo": { lat: -7.7062, lng: 113.9603 },
            "Kalibagor, Situbondo": { lat: -7.7100, lng: 113.9650 },
            "Kembang, Situbondo": { lat: -7.7050, lng: 113.9550 },
            "Patokan, Situbondo": { lat: -7.7000, lng: 113.9500 },
            "Sembungan, Situbondo": { lat: -7.7150, lng: 113.9600 },
            "Taman, Situbondo": { lat: -7.7080, lng: 113.9580 },
            
            // Kecamatan Suboh
            "Suboh, Suboh": { lat: -7.8000, lng: 113.8333 },
            "Buduan, Suboh": { lat: -7.8050, lng: 113.8400 },
            "Ketah, Suboh": { lat: -7.7950, lng: 113.8300 },
            "Klatakan, Suboh": { lat: -7.8100, lng: 113.8350 },
            "Selomukti, Suboh": { lat: -7.8000, lng: 113.8250 },
            "Sumberwaru, Suboh": { lat: -7.7950, lng: 113.8380 },
            
            // Kecamatan Sumbermalang
            "Sumbermalang, Sumbermalang": { lat: -7.7667, lng: 113.7833 },
            "Alas Bayur, Sumbermalang": { lat: -7.7700, lng: 113.7900 },
            "Alasmalang, Sumbermalang": { lat: -7.7600, lng: 113.7800 },
            "Banyuputih, Sumbermalang": { lat: -7.7750, lng: 113.7850 },
            "Sumberargo, Sumbermalang": { lat: -7.7650, lng: 113.7750 },
            "Tepos, Sumbermalang": { lat: -7.7680, lng: 113.7880 }
        };

        // Database koordinat kecamatan untuk fallback
        const koordinatKecamatan = {
            "Arjasa": { lat: -7.7069, lng: 113.6347 },
            "Asembagus": { lat: -7.7536, lng: 114.1561 },
            "Banyuglugur": { lat: -7.7211, lng: 113.8883 },
            "Banyuputih": { lat: -7.7608, lng: 114.0200 },
            "Besuki": { lat: -7.7333, lng: 113.7000 },
            "Bungatan": { lat: -7.6833, lng: 113.8833 },
            "Jangkar": { lat: -7.7500, lng: 114.0833 },
            "Jatibanteng": { lat: -7.7167, lng: 113.9833 },
            "Kapongan": { lat: -7.6833, lng: 114.0167 },
            "Kendit": { lat: -7.7333, lng: 113.9333 },
            "Mangaran": { lat: -7.6667, lng: 114.0667 },
            "Mlandingan": { lat: -7.6833, lng: 113.9500 },
            "Panarukan": { lat: -7.7000, lng: 113.9167 },
            "Panji": { lat: -7.7167, lng: 113.6667 },
            "Situbondo": { lat: -7.7062, lng: 113.9603 },
            "Suboh": { lat: -7.8000, lng: 113.8333 },
            "Sumbermalang": { lat: -7.7667, lng: 113.7833 }
        };
        
        // --- APPLICATION LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplikasi Peta Statistik Data Nelayan diinisialisasi');
            
            initializeApp();
            setupEventListeners();
            
            // Tampilkan modal login
            try {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            } catch (error) {
                console.error('Error menampilkan modal login:', error);
            }
        });
        
        function initializeApp() {
            loadSettings();
            loadData();
            
            fillYearDropdowns();
            fillKecamatanDropdown();
            fillDesaDropdown();
            
            // Fill filter dropdowns for data table
            fillFilterDropdownsForDataTable();
            
            initializeCharts();
            updateDashboard();
            
            // Setup map filter options
            setupMapFilterOptions();
        }

        function setupEventListeners() {
            // Login & Auth
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Password Visibility Toggles
            const togglePasswordBtn = document.querySelector('.toggle-password');
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', function() {
                    togglePasswordVisibility(this, 'securityCode');
                });
            }
            
            // Data Table & Search
            const searchData = document.getElementById('searchData');
            if (searchData) {
                searchData.addEventListener('input', handleSearch);
            }
            
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            // Filter for Data Table
            const filterKecamatanData = document.getElementById('filterKecamatanData');
            if (filterKecamatanData) {
                filterKecamatanData.addEventListener('change', handleDataTableFilter);
            }
            
            const filterDesaData = document.getElementById('filterDesaData');
            if (filterDesaData) {
                filterDesaData.addEventListener('change', handleDataTableFilter);
            }
            
            // Advanced Filter
            const applyFilterBtn = document.getElementById('applyFilterBtn');
            if (applyFilterBtn) {
                applyFilterBtn.addEventListener('click', applyFilter);
            }
            
            const resetFilterBtn = document.getElementById('resetFilterBtn');
            if (resetFilterBtn) {
                resetFilterBtn.addEventListener('click', resetFilter);
            }
            
            // Print Actions
            const printPdfBtn = document.getElementById('printPdfBtn');
            if (printPdfBtn) {
                printPdfBtn.addEventListener('click', printToPdf);
            }
            
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', showPreview);
            }
            
            // Map Filter
            const mapFilterType = document.getElementById('mapFilterType');
            if (mapFilterType) {
                mapFilterType.addEventListener('change', handleMapFilterTypeChange);
            }
            
            const applyMapFilterBtn = document.getElementById('applyMapFilter');
            if (applyMapFilterBtn) {
                applyMapFilterBtn.addEventListener('click', applyMapFilter);
            }
            
            // System Management
            const logoutTab = document.getElementById('v-pills-logout-tab');
            if (logoutTab) {
                logoutTab.addEventListener('click', logout);
            }
            
            const reloadRepoBtn = document.getElementById('btn-reload-repo');
            if (reloadRepoBtn) {
                reloadRepoBtn.addEventListener('click', handleReloadFromRepo);
            }

            // UI Helpers
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleMobileMenu);
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992 && document.getElementById('sidebarMenu').classList.contains('mobile-show')) {
                        toggleMobileMenu();
                    }
                    
                    // Initialize map when map tab is shown
                    if (link.id === 'v-pills-map-tab') {
                        setTimeout(initializeMap, 300);
                    }
                });
            });

            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', () => {
                    const mapTab = document.getElementById('v-pills-map-tab');
                    if (mapTab) mapTab.click();
                });
            }
            
            const printFromPreviewBtn = document.getElementById('printFromPreviewBtn');
            if (printFromPreviewBtn) {
                printFromPreviewBtn.addEventListener('click', () => window.print());
            }
        }
        
        function fillYearDropdowns() {
            const yearSelects = ['filterTahun', 'printTahun'];
            const currentYear = new Date().getFullYear();

            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                select.add(new Option('Semua Tahun', ''));
                
                for (let year = 2020; year <= currentYear; year++) {
                    select.add(new Option(year, year));
                }
            });
        }
        
        function fillKecamatanDropdown() {
            ['filterKecamatan', 'printKecamatan'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                select.add(new Option('Semua Kecamatan', ''));
                kecamatanList.forEach(kec => select.add(new Option(kec, kec)));
            });
        }
        
        function fillDesaDropdown() {
            const select = document.getElementById('filterDesa');
            if (!select) return;
            
            select.innerHTML = '';
            select.add(new Option('Semua Desa', ''));
            desaList.forEach(desa => select.add(new Option(desa, desa)));
        }
        
        function fillFilterDropdownsForDataTable() {
            // Fill kecamatan filter for data table
            const kecFilter = document.getElementById('filterKecamatanData');
            if (kecFilter) {
                kecFilter.innerHTML = '';
                kecFilter.add(new Option('Semua Kecamatan', ''));
                kecamatanList.forEach(kec => kecFilter.add(new Option(kec, kec)));
            }
            
            // Fill desa filter for data table
            const desaFilter = document.getElementById('filterDesaData');
            if (desaFilter) {
                desaFilter.innerHTML = '';
                desaFilter.add(new Option('Semua Desa', ''));
                desaList.forEach(desa => desaFilter.add(new Option(desa, desa)));
            }
        }
        
        function setupMapFilterOptions() {
            const mapFilterType = document.getElementById('mapFilterType');
            if (!mapFilterType) return;
            
            mapFilterType.addEventListener('change', function() {
                const filterValueContainer = document.getElementById('mapFilterValueContainer');
                const filterValueSelect = document.getElementById('mapFilterValue');
                
                if (!filterValueContainer || !filterValueSelect) return;
                
                filterValueSelect.innerHTML = '';
                
                if (this.value === 'all') {
                    filterValueContainer.style.display = 'none';
                    return;
                }
                
                filterValueContainer.style.display = 'block';
                
                if (this.value === 'kecamatan') {
                    filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                    kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
                } else if (this.value === 'tahun') {
                    filterValueSelect.add(new Option('Pilih Tahun', ''));
                    const currentYear = new Date().getFullYear();
                    for (let year = 2020; year <= currentYear; year++) {
                        filterValueSelect.add(new Option(year, year));
                    }
                } else if (this.value === 'jenis') {
                    filterValueSelect.add(new Option('Pilih Jenis', ''));
                    filterValueSelect.add(new Option('Uang', 'Uang'));
                    filterValueSelect.add(new Option('Barang', 'Barang'));
                    filterValueSelect.add(new Option('Jasa', 'Jasa'));
                }
            });
        }
        
        function handleMapFilterTypeChange() {
            const filterValueContainer = document.getElementById('mapFilterValueContainer');
            const filterValueSelect = document.getElementById('mapFilterValue');
            
            if (!filterValueContainer || !filterValueSelect) return;
            
            filterValueSelect.innerHTML = '';
            
            if (this.value === 'all') {
                filterValueContainer.style.display = 'none';
                return;
            }
            
            filterValueContainer.style.display = 'block';
            
            if (this.value === 'kecamatan') {
                filterValueSelect.add(new Option('Pilih Kecamatan', ''));
                kecamatanList.forEach(kec => filterValueSelect.add(new Option(kec, kec)));
            } else if (this.value === 'tahun') {
                filterValueSelect.add(new Option('Pilih Tahun', ''));
                const currentYear = new Date().getFullYear();
                for (let year = 2020; year <= currentYear; year++) {
                    filterValueSelect.add(new Option(year, year));
                }
            } else if (this.value === 'jenis') {
                filterValueSelect.add(new Option('Pilih Jenis', ''));
                filterValueSelect.add(new Option('Uang', 'Uang'));
                filterValueSelect.add(new Option('Barang', 'Barang'));
                filterValueSelect.add(new Option('Jasa', 'Jasa'));
            }
        }
        
        function applyMapFilter() {
            const filterType = document.getElementById('mapFilterType').value;
            const filterValue = document.getElementById('mapFilterValue').value;
            
            if (filterType === 'all') {
                // Show all data
                updateMapWithData(appData);
            } else {
                // Filter data
                let filteredMapData = [];
                
                if (filterType === 'kecamatan' && filterValue) {
                    filteredMapData = appData.filter(item => item.kecamatan === filterValue);
                } else if (filterType === 'tahun' && filterValue) {
                    filteredMapData = appData.filter(item => item.tahunAnggaran == filterValue);
                } else if (filterType === 'jenis' && filterValue) {
                    filteredMapData = appData.filter(item => item.jenisBantuan === filterValue);
                } else {
                    filteredMapData = appData;
                }
                
                updateMapWithData(filteredMapData);
            }
        }

        // --- AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            if (isBlocked) return showNotification('Akses diblokir sementara karena terlalu banyak percobaan.', 'error');
            
            const securityCodeInput = document.getElementById('securityCode').value;
            const loginButton = document.getElementById('loginButton');
            
            if (!loginButton) return;
            
            loginButton.disabled = true;
            const loginSpinner = document.getElementById('loginSpinner');
            if (loginSpinner) loginSpinner.classList.remove('d-none');
            
            const loginButtonText = document.querySelector('.login-button-text');
            if (loginButtonText) loginButtonText.textContent = 'Memverifikasi...';
            
            setTimeout(() => {
                if (securityCodeInput === appSettings.securityCode) {
                    try {
                        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        if (loginModal) loginModal.hide();
                        
                        // Show welcome modal and auto reload data
                        showWelcomeMessageAndReload();
                    } catch (error) {
                        console.error('Error hiding login modal:', error);
                    }
                } else {
                    loginAttempts++;
                    updateAttemptsCount();
                    
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.classList.add('login-shake');
                        setTimeout(() => loginForm.classList.remove('login-shake'), 600);
                    }
                    
                    if (loginAttempts >= 3) {
                        blockAccess();
                    } else {
                        showNotification(`Kode keamanan salah. Sisa percobaan: ${3 - loginAttempts}.`, 'error');
                    }
                }

                loginButton.disabled = false;
                if (loginSpinner) loginSpinner.classList.add('d-none');
                if (loginButtonText) loginButtonText.textContent = 'MASUK SISTEM';
            }, 500);
        }
        
        function showWelcomeMessageAndReload() {
            try {
                const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                if (!welcomeMessage) return;
                
                const hours = new Date().getHours();
                let greeting = '';
                if (hours < 11) greeting = 'Pagi';
                else if (hours < 15) greeting = 'Siang';
                else if (hours < 19) greeting = 'Sore';
                else greeting = 'Malam';
                
                welcomeMessage.innerHTML = `
                    <strong>Selamat ${greeting}!</strong><br>
                    Sistem Peta Statistik Data Nelayan Kabupaten Situbondo.<br>
                    <small class="text-white-75">Login sebagai Administrator - Akses penuh</small>
                `;
                
                welcomeModal.show();
                
                // Auto reload data after showing modal
                setTimeout(() => {
                    handleReloadFromRepo(() => {
                        // After reload, hide welcome modal and show app content
                        welcomeModal.hide();
                        document.getElementById('appContent').style.display = 'block';
                        showNotification('Selamat datang! Data berhasil dimuat.', 'success');
                    });
                }, 1500);
                
            } catch (error) {
                console.error('Error showing welcome modal:', error);
            }
        }
        
        function togglePasswordVisibility(btn, inputId) {
            const passwordInput = document.getElementById(inputId);
            if (!passwordInput) return;
            
            const icon = btn.querySelector('i');
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            icon.classList.toggle('fa-eye', !isPassword);
            icon.classList.toggle('fa-eye-slash', isPassword);
        }
        
        function updateAttemptsCount() {
            const attemptsEl = document.getElementById('attemptsCount');
            const blockedMessage = document.getElementById('blockedMessage');
            
            if (attemptsEl) {
                attemptsEl.style.display = loginAttempts > 0 && !isBlocked ? 'block' : 'none';
                attemptsEl.textContent = `Percobaan gagal: ${loginAttempts}/3`;
            }
            
            if (blockedMessage) {
                blockedMessage.classList.toggle('d-none', !isBlocked);
            }
        }
        
        function blockAccess() {
            isBlocked = true;
            updateAttemptsCount();
            showNotification('Akses diblokir selama 30 detik.', 'error');
            
            let countdown = 30;
            const countdownElement = document.getElementById('countdown');
            
            blockTimeout = setInterval(() => {
                countdown--;
                if (countdownElement) countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(blockTimeout);
                    isBlocked = false;
                    loginAttempts = 0;
                    updateAttemptsCount();
                }
            }, 1000);
        }
        
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                document.getElementById('appContent').style.display = 'none';
                const securityCodeInput = document.getElementById('securityCode');
                if (securityCodeInput) securityCodeInput.value = '';
                
                try {
                    new bootstrap.Modal(document.getElementById('loginModal')).show();
                } catch (error) {
                    console.error('Error showing login modal:', error);
                }
                
                showNotification('Anda telah berhasil logout.', 'info');
            }
        }
        
        // --- DATA PERSISTENCE ---
        function loadData() {
            try {
                const savedData = localStorage.getItem('barjasData');
                appData = savedData ? JSON.parse(savedData) : [];
                const savedCodes = localStorage.getItem('barjasGeneratedCodes');
                generatedCodes = savedCodes ? JSON.parse(savedCodes) : {};
            } catch (e) {
                console.error("Gagal memuat data:", e);
                appData = [];
                generatedCodes = {};
            }
            renderDataTable();
        }
        
        function saveData() {
            try {
                localStorage.setItem('barjasData', JSON.stringify(appData));
                localStorage.setItem('barjasGeneratedCodes', JSON.stringify(generatedCodes));
            } catch (e) {
                console.error("Gagal menyimpan data:", e);
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('barjasSettings');
            if (savedSettings) {
                try {
                    const loaded = JSON.parse(savedSettings);
                    Object.assign(appSettings, loaded);
                    if (!appSettings.securityCode || appSettings.securityCode.trim() === '') {
                        appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
                    }
                } catch(e) {
                     appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
                }
            } else {
                 appSettings.securityCode = SECURITY_CONSTANTS.DEFAULT_PASS;
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('barjasSettings', JSON.stringify(appSettings));
            } catch (e) {
                console.error("Gagal menyimpan pengaturan:", e);
            }
        }
        
        // --- DATA TABLE ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const dataToRender = isFilterActive ? filteredData : appData;
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToRender.length);
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" class="text-center py-4">Tidak ada data</td></tr>`;
                
                const tableInfo = document.getElementById('tableInfo');
                if (tableInfo) tableInfo.textContent = 'Menampilkan 0 dari 0 data';
                
                const pagination = document.getElementById('pagination');
                if (pagination) pagination.innerHTML = '';
                
                return;
            }
            
            for (let i = startIndex; i < endIndex; i++) {
                const data = dataToRender[i];
                const row = document.createElement('tr');
                
                const nikDisplay = formatPrivacy(data.nik);
                const whatsappRaw = data.whatsapp ? `0${data.whatsapp}` : '-';
                const whatsappDisplay = formatPrivacy(whatsappRaw);
                
                const whatsappLink = appSettings.privacyMode ? 'javascript:void(0)' : `https://wa.me/62${data.whatsapp}`;
                const whatsappClass = appSettings.privacyMode ? 'text-muted text-decoration-none' : 'whatsapp-number';
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="fw-bold text-primary">${data.nama}</td>
                    <td class="${privacyClass}">${nikDisplay}</td>
                    <td><a href="${whatsappLink}" target="${appSettings.privacyMode ? '_self' : '_blank'}" class="${whatsappClass}">${whatsappDisplay}</a></td>
                    <td>${data.namaKelompok || '-'}</td>
                    <td>${data.jabatan || '-'}</td>
                    <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td>
                    <td>${data.desa}</td>
                    <td><span class="badge bg-info">${data.jenisBantuan}</span></td>
                    <td>${data.namaBantuan || '-'}</td>
                    <td class="fw-bold">${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td>
                    <td>${data.namaPetugas || '-'}</td>
                    <td>${data.driveLink ? `<a href="${data.driveLink}" class="drive-link" target="_blank"><i class="fas fa-external-link-alt"></i> Buka</a>` : '-'}</td>
                    <td><span class="badge bg-secondary">${data.kodeValidasi}</span></td>
                `;
                tableBody.appendChild(row);
            }
            
            const tableInfo = document.getElementById('tableInfo');
            if (tableInfo) {
                tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${dataToRender.length} data`;
            }
            
            updatePagination(dataToRender.length);
        }
        
        function updatePagination(totalItems) {
            const paginationEl = document.getElementById('pagination');
            if (!paginationEl) return;
            
            const itemsPerPage = parseInt(appSettings.itemsPerPage) || 25;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationEl.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageItem = (page, text, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page}); return false;">${text}</a>`;
                return li;
            };

            paginationEl.appendChild(createPageItem(currentPage - 1, '<i class="fas fa-chevron-left"></i>', currentPage === 1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationEl.appendChild(createPageItem(i, i, false, i === currentPage));
            }

            paginationEl.appendChild(createPageItem(currentPage + 1, '<i class="fas fa-chevron-right"></i>', currentPage === totalPages));
        }
        
        function changePage(page) {
            const dataToRender = isFilterActive ? filteredData : appData;
            const totalPages = Math.ceil(dataToRender.length / (parseInt(appSettings.itemsPerPage) || 25));
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderDataTable();
            }
        }
        
        function handleSearch() {
            const searchTerm = document.getElementById('searchData').value.toLowerCase();
            const filterKecamatan = document.getElementById('filterKecamatanData').value;
            const filterDesa = document.getElementById('filterDesaData').value;
            
            isFilterActive = !!searchTerm || !!filterKecamatan || !!filterDesa;
            
            filteredData = appData.filter(d => {
                const matchesSearch = !searchTerm || Object.values(d).some(v => 
                    String(v).toLowerCase().includes(searchTerm)
                );
                const matchesKecamatan = !filterKecamatan || d.kecamatan === filterKecamatan;
                const matchesDesa = !filterDesa || d.desa === filterDesa;
                
                return matchesSearch && matchesKecamatan && matchesDesa;
            });
            
            currentPage = 1;
            renderDataTable();
        }
        
        function handleDataTableFilter() {
            handleSearch();
        }
        
        function clearSearch() {
            const searchData = document.getElementById('searchData');
            const filterKecamatanData = document.getElementById('filterKecamatanData');
            const filterDesaData = document.getElementById('filterDesaData');
            
            if (searchData) searchData.value = '';
            if (filterKecamatanData) filterKecamatanData.value = '';
            if (filterDesaData) filterDesaData.value = '';
            
            handleSearch();
        }
        
        // --- FILTER ---
        function applyFilter() {
            const filters = {
                tahun: document.getElementById('filterTahun')?.value || '',
                kecamatan: document.getElementById('filterKecamatan')?.value || '',
                desa: document.getElementById('filterDesa')?.value || '',
                jenis: document.getElementById('filterJenis')?.value || '',
            };
            
            filteredData = appData.filter(d => 
                (!filters.tahun || d.tahunAnggaran == filters.tahun) &&
                (!filters.kecamatan || d.kecamatan === filters.kecamatan) &&
                (!filters.desa || d.desa === filters.desa) &&
                (!filters.jenis || d.jenisBantuan === filters.jenis)
            );
            
            renderFilterTable();
            
            const filterResultCount = document.getElementById('filterResultCount');
            if (filterResultCount) {
                filterResultCount.textContent = `${filteredData.length} Data`;
            }
            
            showNotification(`Filter diterapkan. Ditemukan ${filteredData.length} data.`, 'success');
        }
        
        function resetFilter() {
            ['filterTahun', 'filterKecamatan', 'filterDesa', 'filterJenis'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            filteredData = [];
            renderFilterTable();
            
            const filterResultCount = document.getElementById('filterResultCount');
            if (filterResultCount) {
                filterResultCount.textContent = '0 Data';
            }
            
            showNotification('Filter direset.', 'info');
        }
        
        function renderFilterTable() {
            const tableBody = document.getElementById('filterTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" class="text-center py-4">Tidak ada data yang sesuai</td></tr>`;
                return;
            }
            
            filteredData.forEach((data, i) => {
                const nikDisplay = formatPrivacy(data.nik);
                const whatsappRaw = data.whatsapp ? `0${data.whatsapp}` : '-';
                const whatsappDisplay = formatPrivacy(whatsappRaw);
                const privacyClass = appSettings.privacyMode ? 'privacy-blurred' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td> <td>${data.nama}</td> 
                    <td class="${privacyClass}">${nikDisplay}</td> 
                    <td>${whatsappDisplay}</td>
                    <td>${data.namaKelompok || '-'}</td> <td>${data.jabatan || '-'}</td> <td>${data.tahunAnggaran}</td>
                    <td>${data.kecamatan}</td> <td>${data.desa}</td> <td>${data.jenisBantuan}</td>
                    <td>${data.namaBantuan || '-'}</td> <td>${formatNumber(data.jumlahBantuan)} ${data.satuanBantuan}</td>
                    <td>${formatDate(data.tanggalTerima)}</td> <td>${data.namaPetugas || '-'}</td>
                    <td>${data.driveLink ? 'Ya' : 'Tidak'}</td> <td>${data.kodeValidasi}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- DASHBOARD ---
        function updateDashboard() {
            const totalPenerima = document.getElementById('totalPenerima');
            const totalBantuan = document.getElementById('totalBantuan');
            const tahunAktif = document.getElementById('tahunAktif');
            const rataBantuan = document.getElementById('rataBantuan');
            
            if (totalPenerima) totalPenerima.textContent = formatNumber(appData.length);
            
            const uangData = appData.filter(d => d.jenisBantuan === 'Uang');
            const totalBantuanValue = uangData.reduce((sum, d) => sum + (parseFloat(d.jumlahBantuan) || 0), 0);
            
            if (totalBantuan) totalBantuan.textContent = `Rp ${formatNumber(totalBantuanValue)}`;
            
            const tahunCount = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const tahunAktifValue = Object.keys(tahunCount).reduce((a, b) => tahunCount[a] > tahunCount[b] ? a : b, appSettings.defaultTahun);
            
            if (tahunAktif) tahunAktif.textContent = tahunAktifValue;
            
            const rataBantuanValue = uangData.length > 0 ? totalBantuanValue / uangData.length : 0;
            
            if (rataBantuan) rataBantuan.textContent = `Rp ${formatNumber(rataBantuanValue.toFixed(0))}`;
            
            updateCharts();
            updateRecentData();
        }
        
        function updateRecentData() {
            const recentDataContainer = document.getElementById('recentData');
            if (!recentDataContainer) return;
            
            recentDataContainer.innerHTML = '';
            const recent = [...appData].sort((a, b) => new Date(b.tanggalInput) - new Date(a.tanggalInput)).slice(0, 5);
            
            if (recent.length === 0) {
                recentDataContainer.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>`;
                return;
            }
            
            recent.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(d.tanggalInput)}</td> <td>${d.nama}</td> <td>${d.desa}</td>
                    <td>${d.jenisBantuan}</td> <td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td>
                `;
                recentDataContainer.appendChild(row);
            });
        }
        
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js tidak tersedia');
                return;
            }
            
            Chart.defaults.font.family = "'Inter', sans-serif";
            const pieCtx = document.getElementById('kecamatanChart')?.getContext('2d');
            if (pieCtx) {
                window.kecamatanChart = new Chart(pieCtx, { 
                    type: 'pie', 
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'right' 
                            } 
                        } 
                    } 
                });
            }
            
            const barCtx = document.getElementById('tahunChart')?.getContext('2d');
            if (barCtx) {
                window.tahunChart = new Chart(barCtx, { 
                    type: 'bar', 
                    options: { 
                        responsive: true, 
                        scales: { 
                            y: { 
                                beginAtZero: true 
                            } 
                        } 
                    } 
                });
            }
        }
        
        function updateCharts() {
            if (!appData || appData.length === 0) return;

            const kecamatanData = appData.reduce((acc, d) => ({...acc, [d.kecamatan]: (acc[d.kecamatan] || 0) + 1}), {});
            if (window.kecamatanChart) {
                window.kecamatanChart.data = {
                    labels: Object.keys(kecamatanData),
                    datasets: [{ 
                        data: Object.values(kecamatanData), 
                        backgroundColor: ['#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226'] 
                    }]
                };
                window.kecamatanChart.update();
            }
            
            const tahunData = appData.reduce((acc, d) => ({...acc, [d.tahunAnggaran]: (acc[d.tahunAnggaran] || 0) + 1}), {});
            const sortedYears = Object.keys(tahunData).sort();
            if (window.tahunChart) {
                window.tahunChart.data = {
                    labels: sortedYears,
                    datasets: [{ 
                        label: 'Jumlah Penerima', 
                        data: sortedYears.map(year => tahunData[year]), 
                        backgroundColor: '#0a9396' 
                    }]
                };
                window.tahunChart.update();
            }
        }
        
        // --- MAP FUNCTIONALITY ---
        function initializeMap() {
            if (!document.getElementById('map')) return;
            
            // Clear existing map
            if (map) {
                map.remove();
                map = null;
            }
            
            // Initialize map centered on Situbondo
            map = L.map('map').setView([-7.7062, 113.9603], 11);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Add markers for data
            updateMapWithData(appData);
            
            // Add kecamatan boundaries and labels
            addKecamatanBoundaries();
        }
        
        function updateMapWithData(data) {
            if (!map) return;
            
            // Clear existing markers
            if (mapLayer) {
                map.removeLayer(mapLayer);
            }
            
            mapMarkers = [];
            
            if (data.length === 0) {
                updateMapStatistics(0, 0);
                return;
            }
            
            // Group data by desa/kecamatan
            const dataByLocation = {};
            
            data.forEach(item => {
                const key = `${item.desa}, ${item.kecamatan}`;
                if (!dataByLocation[key]) {
                    dataByLocation[key] = {
                        desa: item.desa,
                        kecamatan: item.kecamatan,
                        items: [],
                        totalValue: 0,
                        jenisCount: {
                            Uang: 0,
                            Barang: 0,
                            Jasa: 0
                        }
                    };
                }
                
                dataByLocation[key].items.push(item);
                const jumlah = parseFloat(item.jumlahBantuan) || 0;
                dataByLocation[key].totalValue += jumlah;
                
                if (item.jenisBantuan in dataByLocation[key].jenisCount) {
                    dataByLocation[key].jenisCount[item.jenisBantuan]++;
                }
            });
            
            // Create markers for each location
            const markers = [];
            let totalRecipients = 0;
            let totalValue = 0;
            
            Object.keys(dataByLocation).forEach(key => {
                const locationData = dataByLocation[key];
                const locationKey = `${locationData.desa}, ${locationData.kecamatan}`;
                
                // Get coordinates
                let coordinates = koordinatDesa[locationKey];
                if (!coordinates) {
                    coordinates = koordinatKecamatan[locationData.kecamatan];
                    if (!coordinates) {
                        return; // Skip if no coordinates
                    }
                }
                
                // Determine marker color based on number of recipients
                let markerColor = '#005f73'; // Default
                const recipientCount = locationData.items.length;
                
                if (recipientCount <= 10) markerColor = '#005f73';
                else if (recipientCount <= 50) markerColor = '#0a9396';
                else if (recipientCount <= 100) markerColor = '#94d2bd';
                else markerColor = '#ee9b00';
                
                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                
                // Create popup content
                const popupContent = `
                    <div style="min-width: 250px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">${locationData.desa}</h4>
                        <p><strong>Kecamatan:</strong> ${locationData.kecamatan}</p>
                        <p><strong>Jumlah Penerima:</strong> ${recipientCount}</p>
                        <p><strong>Total Nilai Bantuan:</strong> Rp ${formatNumber(locationData.totalValue)}</p>
                        <p><strong>Distribusi Jenis:</strong></p>
                        <ul style="padding-left: 20px; margin-bottom: 10px;">
                            <li>Uang: ${locationData.jenisCount.Uang} penerima</li>
                            <li>Barang: ${locationData.jenisCount.Barang} penerima</li>
                            <li>Jasa: ${locationData.jenisCount.Jasa} penerima</li>
                        </ul>
                        <button class="btn btn-sm btn-primary w-100" onclick="showLocationDetails('${locationData.desa}', '${locationData.kecamatan}')">
                            Lihat Detail Penerima
                        </button>
                    </div>
                `;
                
                // Create marker
                const marker = L.marker([coordinates.lat, coordinates.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(popupContent);
                
                markers.push(marker);
                mapMarkers.push(marker);
                
                totalRecipients += recipientCount;
                totalValue += locationData.totalValue;
            });
            
            // Create layer group
            mapLayer = L.layerGroup(markers).addTo(map);
            
            // Update map statistics
            updateMapStatistics(totalRecipients, totalValue);
            
            // Fit bounds to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        function addKecamatanBoundaries() {
            // Add kecamatan center markers
            Object.keys(koordinatKecamatan).forEach(kecamatan => {
                const coords = koordinatKecamatan[kecamatan];
                
                const kecamatanIcon = L.divIcon({
                    className: 'kecamatan-marker',
                    html: `<div style="background-color: #ca6702; width: 15px; height: 15px; border-radius: 50%; border: 2px solid #001219;"></div>`,
                    iconSize: [19, 19],
                    iconAnchor: [9, 9]
                });
                
                L.marker([coords.lat, coords.lng], { icon: kecamatanIcon })
                    .addTo(map)
                    .bindTooltip(kecamatan, { permanent: false, direction: 'top' });
            });
        }
        
        function updateMapStatistics(recipients, value) {
            const pointCount = mapMarkers.length;
            document.getElementById('mapPointCount').textContent = pointCount;
            document.getElementById('mapTotalRecipients').textContent = recipients;
            document.getElementById('mapTotalValue').textContent = `Rp ${formatNumber(value)}`;
        }
        
        function showLocationDetails(desa, kecamatan) {
            // Filter data for this location
            const locationData = appData.filter(item => 
                item.desa === desa && item.kecamatan === kecamatan
            );
            
            if (locationData.length === 0) return;
            
            // Create detail content
            let detailContent = `
                <div class="p-3">
                    <h4 class="fw-bold text-primary">${desa}, ${kecamatan}</h4>
                    <p class="text-muted">Total ${locationData.length} penerima bantuan</p>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Jenis Bantuan</th>
                                    <th>Nama Bantuan</th>
                                    <th>Jumlah</th>
                                    <th>Tahun</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            locationData.forEach((item, index) => {
                detailContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nama}</td>
                        <td>${item.jenisBantuan}</td>
                        <td>${item.namaBantuan}</td>
                        <td>${formatNumber(item.jumlahBantuan)} ${item.satuanBantuan}</td>
                        <td>${item.tahunAnggaran}</td>
                    </tr>
                `;
            });
            
            detailContent += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Show in modal
            const previewContent = document.getElementById('previewContent');
            const previewModalTitle = document.getElementById('previewModalTitle');
            
            if (previewContent && previewModalTitle) {
                previewModalTitle.textContent = `Detail Penerima di ${desa}, ${kecamatan}`;
                previewContent.innerHTML = detailContent;
                
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            }
        }
        
        // --- PRINT & EXPORT ---
        function getFilteredDataForExport(prefix) {
            const filters = {
                tahun: document.getElementById(`${prefix}Tahun`)?.value || '',
                kecamatan: document.getElementById(`${prefix}Kecamatan`)?.value || '',
                jenis: document.getElementById(`${prefix}Jenis`)?.value || '',
            };
            
            if (!filters.tahun && !filters.kecamatan && !filters.jenis) return appData;

            return appData.filter(d => 
                (!filters.tahun || d.tahunAnggaran == filters.tahun) &&
                (!filters.kecamatan || d.kecamatan === filters.kecamatan) &&
                (!filters.jenis || d.jenisBantuan === filters.jenis)
            );
        }

        function printToPdf() {
            const dataToPrint = getFilteredDataForExport('print');
            if (dataToPrint.length === 0) return showNotification('Tidak ada data untuk dicetak sesuai filter.', 'warning');
            
            if (typeof window.jspdf === 'undefined') {
                showNotification('Library jsPDF tidak tersedia.', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'pt', 'a4');
            
            doc.setFontSize(16);
            doc.text(appSettings.appName, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            doc.setFontSize(12);
            doc.text(appSettings.appSubtitle, doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });
            
            const cols = ["No", "Nama", "NIK", "Desa", "Kecamatan", "Nama Bantuan", "Jumlah", "Tanggal"];
            const rows = dataToPrint.map((d, i) => [
                i + 1, d.nama, 
                formatPrivacy(d.nik), 
                d.desa, d.kecamatan, d.namaBantuan || '-',
                `${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}`, formatDate(d.tanggalTerima)
            ]);
            
            doc.autoTable({ 
                head: [cols], 
                body: rows, 
                startY: 80, 
                theme: 'grid', 
                headStyles: { 
                    fillColor: [0, 95, 115] 
                } 
            });
            
            doc.save(`laporan_nelayan_${new Date().toISOString().slice(0,10)}.pdf`);
            showNotification('Laporan PDF berhasil diunduh.', 'success');
        }
        
        function showPreview() {
            const dataToPreview = getFilteredDataForExport('print');
            if (dataToPreview.length === 0) return showNotification('Tidak ada data untuk pratinjau sesuai filter.', 'warning');

            const previewModalTitle = document.getElementById('previewModalTitle');
            const previewContent = document.getElementById('previewContent');
            
            if (!previewModalTitle || !previewContent) return;
            
            previewModalTitle.textContent = `Pratinjau Laporan (${dataToPreview.length} data)`;
            
            let content = `
                <div class="print-header text-center mb-4">
                    <h4>${appSettings.appName}</h4>
                    <p class="mb-1">${appSettings.appSubtitle}</p>
                    <p class="text-muted">Tanggal: ${formatDate(new Date().toISOString())}</p>
                </div>
                <table class="preview-table"><thead><tr>
                    <th>No</th><th>Nama</th><th>NIK</th><th>Desa</th><th>Nama Bantuan</th><th>Jumlah</th><th>Tanggal</th>
                </tr></thead><tbody>`;

            dataToPreview.forEach((d, i) => {
                content += `<tr>
                    <td>${i + 1}</td><td>${d.nama}</td><td>${formatPrivacy(d.nik)}</td><td>${d.desa}</td>
                    <td>${d.namaBantuan}</td><td>${formatNumber(d.jumlahBantuan)} ${d.satuanBantuan}</td><td>${formatDate(d.tanggalTerima)}</td>
                </tr>`;
            });

            content += `</tbody></table>`;
            previewContent.innerHTML = content;
            
            try {
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            } catch (error) {
                console.error('Error showing preview modal:', error);
            }
        }
        
        // --- RELOAD DATA ---
        function handleReloadFromRepo(callback) {
            const btn = document.getElementById('btn-reload-repo');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin feature-icon"></i> Loading...';
            btn.disabled = true;

            const oldScript = document.querySelector('#reload-script');
            if(oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'reload-script';
            script.src = './reload.js?v=' + new Date().getTime(); 

            script.onload = function() {
                try {
                    if (window.BARJAS_BACKUP_ENCRYPTED) {
                        const rawContent = window.BARJAS_BACKUP_ENCRYPTED;
                        let restored;
                        try {
                            if (typeof rawContent === 'string') {
                                restored = JSON.parse(decodeURIComponent(escape(atob(rawContent))));
                            } else {
                                restored = rawContent;
                            }
                        } catch (decryptionError) {
                            throw new Error("Gagal mendekripsi data.");
                        }
                        
                        if(restored && restored.appData && Array.isArray(restored.appData)) {
                            
                            const existingIds = new Set(appData.map(item => item.id));
                            let addedCount = 0;

                            restored.appData.forEach(newItem => {
                                if (!existingIds.has(newItem.id)) {
                                    appData.push(newItem);
                                    existingIds.add(newItem.id); 
                                    addedCount++;
                                }
                            });

                            if(restored.generatedCodes) {
                                generatedCodes = { ...restored.generatedCodes, ...generatedCodes }; 
                            }
                            
                            if(restored.koordinatDesa) {
                                Object.assign(koordinatDesa, restored.koordinatDesa);
                            }
                            
                            if(restored.koordinatKecamatan) {
                                Object.assign(koordinatKecamatan, restored.koordinatKecamatan);
                            }

                            saveData();
                            saveSettings();
                            updateDashboard();
                            renderDataTable();
                            
                            if (addedCount > 0) {
                                showNotification(`Berhasil reload! ${addedCount} data baru ditambahkan.`, 'success');
                            } else {
                                showNotification('Reload selesai. Tidak ada data baru yang ditemukan.', 'info');
                            }

                        } else {
                            throw new Error('Format data tidak valid.');
                        }
                    } else {
                        throw new Error('Variabel backup tidak ditemukan di reload.js.');
                    }
                } catch (e) {
                    showNotification('Error: ' + e.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    delete window.BARJAS_BACKUP_ENCRYPTED;
                    
                    if (callback) callback();
                }
            };

            script.onerror = function() {
                showNotification('Gagal memuat file reload.js. Pastikan file ada di folder yang sama.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (callback) callback();
            };
            document.body.appendChild(script);
        }

        // --- UTILS ---
        function toggleMobileMenu() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarMenu) sidebarMenu.classList.toggle('mobile-show');
            if (sidebarOverlay) sidebarOverlay.classList.toggle('mobile-show');
        }
        
        function showNotification(message, type = 'info') {
            if (!appSettings.notifications) return;
            
            const toastEl = document.querySelector('.notification-toast');
            if (!toastEl) return;
            
            const toastHeader = toastEl.querySelector('.toast-header');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toastMessage) return;
            
            toastMessage.textContent = message;
            
            const styles = {
                success: { bg: 'bg-success-subtle', text: 'text-success-emphasis', title: 'Berhasil' },
                error: { bg: 'bg-danger-subtle', text: 'text-danger-emphasis', title: 'Gagal' },
                warning: { bg: 'bg-warning-subtle', text: 'text-warning-emphasis', title: 'Peringatan' },
                info: { bg: 'bg-primary-subtle', text: 'text-primary-emphasis', title: 'Informasi' }
            };
            
            if (toastHeader) {
                toastHeader.className = `toast-header ${styles[type].bg} ${styles[type].text}`;
            }
            
            if (toastTitle) {
                toastTitle.textContent = styles[type].title;
            }
            
            try {
                new bootstrap.Toast(toastEl).show();
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function formatNumber(num) {
            if (isNaN(num) || num === undefined || num === null) return num; 
            try {
                return new Intl.NumberFormat('id-ID').format(num);
            } catch (error) {
                return num;
            }
        }
        
        function formatPrivacy(value) {
            if (!appSettings.privacyMode) return value;
            if (!value) return '-';
            const str = String(value);
            if (str.length <= 4) return '****';
            return str.slice(0, -4) + '****';
        }

        // Ekspor fungsi ke global scope
        window.showLocationDetails = showLocationDetails;
        window.changePage = changePage;
    </script>
</body>
</html>
