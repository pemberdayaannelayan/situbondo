<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIMATA - SISTEM PEMETAAN NELAYAN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS untuk peta -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Load reload.js jika ada di server -->
    <script src="reload.js" onerror="console.log('File reload.js belum tersedia di server, menggunakan database lokal.')"></script>

    <style>
        :root {
            /* Palette: DEEP OCEAN PROFESSIONAL THEME */
            --primary-color: #0c2461; 
            --primary-gradient: linear-gradient(135deg, #0c2461 0%, #1e3799 100%); 
            --secondary-color: #4a69bd; 
            --accent-color: #f6b93b; 
            --orange-signature: #e67e22; 
            
            --sidebar-active: #eaf0f9; 
            --bg-body: #f1f2f6;
            --shadow-soft: 0 10px 30px rgba(12, 36, 97, 0.15);
            
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;

            /* LOGIN PALETTE */
            --login-bg: linear-gradient(135deg, #d1f2eb 0%, #ffeaa7 50%, #74b9ff 100%);
            --simata-text: #0c2461;
        }
        
        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
            font-size: 14px;
        }
        
        /* Custom Badge Colors */
        .badge-profesi-penuh { background-color: #0c2461 !important; color: white; }
        .badge-profesi-sambilan-utama { background-color: #e58e26 !important; color: white; }
        .badge-profesi-sambilan-tambahan { background-color: #27ae60 !important; color: white; }
        
        /* Tooltip untuk informasi API dan Kapal */
        .info-tooltip {
            cursor: help;
            border-bottom: 1px dotted #0984e3;
            color: #0984e3;
        }
        .api-info-box {
            background: #f8f9fa;
            border-left: 4px solid #0984e3;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .kapal-info-box {
            background: #eaf0f9;
            border-left: 4px solid #4a69bd;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* --- LOGIN REDESIGN --- */
        .login-overlay {
            background: var(--login-bg);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; z-index: 0; }
        .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.4); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
        .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            width: 90%; max-width: 480px; border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15); overflow: hidden; z-index: 10; position: relative;
            animation: slideUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid rgba(255,255,255,0.8);
        }
        .login-header-new { background: transparent; padding: 40px 30px 10px 30px; text-align: center; color: var(--simata-text); }
        
        .simata-logo-container { margin-bottom: 20px; position: relative; display: inline-block; }
        .simata-icon-box { 
            width: 180px; 
            height: 180px; 
            background: transparent; 
            border-radius: 0; 
            display: inline-flex; align-items: center; justify-content: center; 
            color: #0984e3; 
            box-shadow: none;
            border: none;
            overflow: hidden;
        }
        .simata-icon-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .simata-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 3.5rem;
            letter-spacing: 2px;
            background: -webkit-linear-gradient(#0c2461, #0984e3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
            line-height: 1;
        }
        .simata-subtitle { font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: 1px; font-size: 0.9rem; color: #636e72; margin-top: 5px; }
        .simata-slogan { font-family: 'Dancing Script', cursive; font-size: 2rem; color: #e67e22; margin-top: 10px; text-shadow: 1px 1px 0px rgba(255,255,255,1); font-weight: 700; }

        /* --- HEADER DESIGN --- */
        .app-header { 
            background: linear-gradient(120deg, #0a3d62, #3c6382), url('https://images.unsplash.com/photo-1503756234508-e32369269deb?q=80&w=2000&auto=format&fit=crop');
            background-blend-mode: multiply;
            background-size: cover;
            background-position: center;
            color: white; 
            padding: 15px 20px 30px 20px;
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            border-bottom: 5px solid var(--accent-color);
            overflow: hidden; 
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* LOGO HEADER - UKURAN FULL & BESAR */
        .app-logo-icon { 
            background: transparent; 
            width: 180px;
            height: 180px;
            border-radius: 0;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 15px; 
            box-shadow: none;
            border: none; 
            transition: transform 0.3s;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }
        .app-logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        .app-logo-icon:hover { transform: scale(1.05); }
        
        .app-title { font-family: 'Montserrat', sans-serif; font-size: 1.8rem; font-weight: 800; margin: 0; letter-spacing: 1px; color: #fff; text-shadow: 0 4px 10px rgba(0,0,0,0.3); text-transform: uppercase; }
        .app-subtitle { font-size: 0.9rem; color: #fff; margin-top: 5px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
        .app-slogan { font-family: 'Dancing Script', cursive; font-size: 2rem; color: var(--orange-signature); text-shadow: 2px 2px 0px rgba(0,0,0,0.5); margin-top: 10px; font-weight: 700; transform: rotate(-2deg); display: inline-block; }
        
        .app-container { max-width: 1600px; margin: 20px auto; background: white; box-shadow: var(--shadow-soft); border-radius: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column; min-height: 90vh; }

        /* Sidebar */
        .nav-pills { padding: 10px; }
        .nav-pills .nav-link { border-radius: 8px; margin: 4px 0; padding: 12px 16px; font-weight: 600; color: #636e72; transition: all 0.2s ease; font-size: 0.9rem; display: flex; align-items: center; width: 100%; text-align: left; }
        .nav-pills .nav-link i { width: 24px; text-align: center; margin-right: 12px !important; font-size: 1.1em; }
        .nav-pills .nav-link:hover { background-color: #dfe6e9; color: var(--primary-color); transform: translateX(3px); }
        .nav-pills .nav-link.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(12, 36, 97, 0.2); }
        .nav-pills .nav-link.active i { color: white; }

        /* Chart */
        .chart-container-fixed { position: relative; height: 300px; width: 100%; }
        .section-title { font-family: 'Montserrat', sans-serif; margin: 10px 0 20px 0; font-weight: 700; color: #0c2461; font-size: 1.3rem; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 6px; height: 24px; background: var(--accent-color); margin-right: 10px; border-radius: 10px; }

        /* TABLE DESIGN - REPAIRED */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid #f1f2f6; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table thead th { background: #dfe6e9 !important; color: #2d3436; font-weight: 800; border-bottom: 3px solid var(--primary-color); padding: 12px 10px; vertical-align: middle; white-space: nowrap; font-size: 0.85rem; }
        .data-table tbody td { padding: 12px 10px; vertical-align: top; border-bottom: 1px solid #f1f2f6; font-size: 0.85rem; }
        .data-table tbody tr:hover td { background-color: #eaf0f9; cursor: pointer; }
        
        /* Fixed Column Widths & Spacing */
        .col-id-cell { min-width: 250px; max-width: 300px; white-space: normal; word-wrap: break-word; } 
        .col-contact-cell { min-width: 160px; white-space: nowrap; }
        .col-status-cell { min-width: 140px; white-space: nowrap; }
        .col-action { width: 130px; min-width: 130px; text-align: center; background: #fff; z-index: 5; }
        
        /* Sticky Right Column with better shadow and border */
        .sticky-col-right { position: sticky; right: 0; box-shadow: -4px 0 10px rgba(0,0,0,0.05); background-color: #fff; border-left: 1px solid #f1f2f6; }
        .text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; line-height: 1.4; }

        /* Modal & FAB */
        .modal-header-custom { background: var(--primary-gradient); color: white; border-bottom: none; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #b2bec3; margin-bottom: 2px; }
        .detail-value { font-size: 1rem; font-weight: 600; color: #2d3436; margin-bottom: 10px; border-bottom: 1px solid #dfe6e9; padding-bottom: 5px; }

        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; display: flex; flex-direction: column-reverse; gap: 10px; align-items: center; }
        .fab-main { width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); color: #0c2461; border: none; box-shadow: 0 10px 25px rgba(246, 185, 59, 0.4); font-size: 1.4rem; cursor: pointer; transition: transform 0.3s; }
        .fab-main:hover { transform: scale(1.1) rotate(90deg); background: #e58e26; color: white; }
        .fab-item { width: 45px; height: 45px; border-radius: 50%; background: white; color: var(--primary-color); border: 2px solid var(--primary-color); display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none; font-size: 1rem;}
        .fab-container.open .fab-item { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-item:hover { background: var(--primary-color); color: white; }

        /* Warning & Footer */
        .sticky-warning { position: fixed; top: 20px; right: 20px; z-index: 1080; background: white; border-left: 5px solid var(--danger-color); box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 15px; border-radius: 8px; width: 90%; max-width: 320px; display: none; animation: slideInLeft 0.5s; }
        
        .main-footer { background: #0c2461; border-top: 4px solid var(--accent-color); padding: 20px 0 10px 0; margin-top: auto; text-align: center; color: white; position: relative; }
        .footer-brand { font-family: 'Montserrat', sans-serif; font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; color: #fff; font-size: 1rem; }
        .footer-text { font-size: 0.8rem; color: #dfe6e9; margin-bottom: 10px; }
        .footer-links a { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.3s; font-size: 0.8rem; }
        .footer-links a:hover { color: #fff; text-decoration: underline; }
        .footer-divider { margin: 0 5px; color: rgba(255,255,255,0.3); }

        /* Welcome Notification Modal - IMPROVED */
        .welcome-modal-content { border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .welcome-header { background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--accent-color); }
        .welcome-body { padding: 30px 20px; text-align: center; background: #fff; }
        .welcome-btn-reload { background: var(--success-color); color: white; font-weight: bold; padding: 10px 20px; border-radius: 50px; border: none; box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3); transition: all 0.3s; width: 100%; max-width: 250px; }
        .welcome-btn-reload:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(46, 204, 113, 0.4); background: #27ae60; color: white; }

        /* NEW: Login Success Modal - PERBAIKAN UKURAN */
        .login-success-modal .modal-dialog {
            max-width: 500px; /* Lebar maksimum modal */
            width: 90%; /* Responsif */
            margin: 1.75rem auto;
        }
        
        .login-success-modal .modal-content {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 30px 60px rgba(12, 36, 97, 0.3);
            border: 2px solid rgba(246, 185, 59, 0.5);
            max-height: 95vh; /* Mencegah overflow */
            overflow-y: auto; /* Scroll jika konten terlalu panjang */
        }
        
        .login-success-modal .modal-header {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid var(--accent-color);
        }
        
        .login-success-modal .modal-body {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .login-success-icon {
            font-size: 3.5rem; /* Sedikit diperkecil */
            background: linear-gradient(135deg, #0c2461, #0984e3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .welcome-message {
            font-size: 1rem; /* Sedikit diperkecil */
            color: #2d3436;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .welcome-highlight {
            color: #0c2461;
            font-weight: 600;
            background: linear-gradient(135deg, #eaf0f9 0%, #ffffff 100%);
            padding: 8px 12px;
            border-radius: 8px;
            display: block;
            margin: 8px 0;
            border-left: 4px solid var(--accent-color);
            font-size: 0.95rem;
        }

        /* Hidden Div for QR Code Generation */
        #qr-code-generator { position: absolute; top: -9999px; left: -9999px; }

        @keyframes slideInLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: slideUp 0.6s ease-out; }

        /* STYLE UNTUK PETA */
        #map-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e6f0;
            margin-top: 20px;
            position: relative;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 200px;
        }
        
        .map-legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            max-width: 220px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .map-statistics {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-box {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0c2461;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .leaflet-popup-content {
            min-width: 200px;
            font-family: 'Inter', sans-serif;
        }
        
        .leaflet-popup-content h4 {
            color: #0c2461;
            font-size: 1rem;
            margin-bottom: 8px;
            border-bottom: 2px solid #f6b93b;
            padding-bottom: 5px;
        }
        
        .popup-detail {
            margin: 5px 0;
            font-size: 0.85rem;
        }
        
        .popup-label {
            font-weight: 600;
            color: #4a69bd;
        }
        
        .popup-value {
            color: #2d3436;
        }
        
        /* Custom marker icons */
        .marker-penuh {
            background-color: #0c2461;
            border-color: #0c2461;
        }
        
        .marker-sambilan-utama {
            background-color: #e58e26;
            border-color: #e58e26;
        }
        
        .marker-sambilan-tambahan {
            background-color: #27ae60;
            border-color: #27ae60;
        }
        
        .marker-pemilik {
            background-color: #0984e3;
            border-color: #0984e3;
        }
        
        .marker-abk {
            background-color: #a55eea;
            border-color: #a55eea;
        }
        
        @media (max-width: 991.98px) {
            .app-container { margin: 0; border-radius: 0; border: none; min-height: 100vh; }
            .col-md-3.col-lg-2 { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; z-index: 1050; background: white; transition: left 0.3s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: block; overflow-y: auto; }
            .mobile-show { left: 0 !important; }
            .mobile-menu-btn { display: block; position: fixed; top: 15px; left: 15px; z-index: 1060; background: var(--accent-color); color: #0c2461; padding: 8px 12px; border-radius: 6px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
            .app-header { padding: 30px 15px; }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; }
            .sidebar-overlay.active { display: block; }
            
            /* Responsive untuk modal login success di mobile */
            .login-success-modal .modal-dialog {
                margin: 10px;
                width: calc(100% - 20px);
            }
            
            .login-success-modal .modal-body {
                padding: 20px;
                max-height: 70vh;
            }
            
            /* Responsive untuk peta di mobile */
            #map {
                height: 400px;
            }
            
            .map-controls {
                top: 10px;
                right: 10px;
                padding: 8px;
                max-width: 160px;
            }
            
            .map-legend {
                bottom: 10px;
                right: 10px;
                padding: 8px;
                max-width: 180px;
            }
            
            .map-statistics {
                flex-direction: column;
                gap: 8px;
            }
            
            .stat-box {
                min-width: 100%;
            }
            
            /* Responsive untuk card dashboard */
            .dashboard-row .col-6 {
                margin-bottom: 10px;
            }
        }
        
        @media (min-width: 992px) { 
            .mobile-menu-btn, .sidebar-overlay { display: none; } 
            
            /* Responsive untuk modal login success di desktop */
            .login-success-modal .modal-dialog {
                max-width: 500px;
            }
        }

        /* Password Toggle Style */
        .password-toggle-btn {
            background: transparent;
            border: none;
            color: #636e72;
            cursor: pointer;
            padding: 0 10px;
        }
        .password-toggle-btn:hover {
            color: var(--primary-color);
        }
        
        /* Fish checkbox styling */
        .fish-option-box {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .fish-option-box:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .fish-option-box input[type="checkbox"] {
            margin-right: 5px;
        }
        
        /* Tab untuk peta */
        .map-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        
        .map-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .map-tab.active {
            color: #0c2461;
            border-bottom: 3px solid #0c2461;
        }
        
        .map-tab:hover {
            color: #0c2461;
        }
        
        .map-tab-content {
            display: none;
        }
        
        .map-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>

    <div id="qr-code-generator">
        <div id="qr-right"></div> 
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMATA" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-eye fa-4x\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMATA</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode keamanan untuk mengakses sistem.</p>
                        <p class="small text-primary fw-bold mb-2" id="currentDateDisplay"></p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" placeholder="Masukkan kode keamanan" required>
                            <button type="button" class="input-group-text bg-light border-0 password-toggle-btn" id="passwordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="passwordHint">Kode Keamanan Berubah Setiap Hari</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notifikasi Login Berhasil - TELAH DIPERBAIKI UKURANNYA -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Akses Diotorisasi</h4>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMATA</h5>
                    
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Sistem ini menggunakan teknologi keamanan dinamis untuk melindungi data sensitif
                    </p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-filter-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku2.png" alt="Logo SIMATA" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="position-absolute top-0 end-0 p-3 d-none d-md-block">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill"><i class="fas fa-circle text-success me-2 small"></i>Online v5.1 (Encrypted)</span>
                </div>
            </div>
            
            <div class="row g-0 flex-grow-1">
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-3 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important; padding-left: 15px;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter"></i> Filter & Validasi</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-3 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-3 dashboard-row">
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100 text-white" style="background: var(--primary-gradient);">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="small fw-bold text-uppercase opacity-75">Total</span>
                                                    <i class="fas fa-users opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold mb-0" id="totalPenerima">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Penuh Waktu</span>
                                                    <i class="fas fa-user-tie text-primary opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPenuhWaktu">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Kapal</span>
                                                    <i class="fas fa-ship text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Avg Usia</span>
                                                    <i class="fas fa-user-clock text-secondary opacity-25 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="rataUsia">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- TAMBAHAN FITUR RINGKASAN EKSEKUTIF -->
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Sambilan Utama</span>
                                                    <i class="fas fa-user-clock text-warning opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanUtama">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Sambilan Tambahan</span>
                                                    <i class="fas fa-user-clock text-success opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanTambahan">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">ABK</span>
                                                    <i class="fas fa-users text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalABK">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4 g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- FITUR PETA BARU -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-map-marked-alt me-2 text-primary"></i> Peta Sebaran Nelayan Kabupaten Situbondo
                                                </div>
                                                <div class="map-tabs">
                                                    <div class="map-tab active" onclick="switchMapView('all')">Semua Data</div>
                                                    <div class="map-tab" onclick="switchMapView('profesi')">Berdasarkan Profesi</div>
                                                    <div class="map-tab" onclick="switchMapView('kecamatan')">Berdasarkan Kecamatan</div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="map-statistics">
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-points">0</div>
                                                        <div class="stat-label">Total Titik</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-kecamatan">0</div>
                                                        <div class="stat-label">Kecamatan</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-desa">0</div>
                                                        <div class="stat-label">Desa</div>
                                                    </div>
                                                    <div class="stat-box">
                                                        <div class="stat-value" id="map-total-kapal">0</div>
                                                        <div class="stat-label">Pemilik Kapal</div>
                                                    </div>
                                                </div>
                                                <div id="map-container">
                                                    <div id="map"></div>
                                                    <div class="map-controls">
                                                        <button class="btn btn-sm btn-primary w-100 mb-2" onclick="resetMapView()">
                                                            <i class="fas fa-sync-alt me-1"></i> Reset Peta
                                                        </button>
                                                        <button class="btn btn-sm btn-info w-100 mb-2" onclick="zoomToAllMarkers()">
                                                            <i class="fas fa-search-location me-1"></i> Zoom Semua
                                                        </button>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="showCluster" checked onchange="toggleCluster()">
                                                            <label class="form-check-label small" for="showCluster">Grup Marker</label>
                                                        </div>
                                                    </div>
                                                    <div class="map-legend">
                                                        <h6 class="fw-bold mb-2">Legenda</h6>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #0c2461;"></div>
                                                            <span>Penuh Waktu</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #e58e26;"></div>
                                                            <span>Sambilan Utama</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #27ae60;"></div>
                                                            <span>Sambilan Tambahan</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #0984e3;"></div>
                                                            <span>Pemilik Kapal</span>
                                                        </div>
                                                        <div class="legend-item">
                                                            <div class="legend-color" style="background-color: #a55eea;"></div>
                                                            <span>Anak Buah Kapal</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-input">
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <div class="alert alert-info small mb-4 border-0 bg-light-info text-primary"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Semua kolom WAJIB DIISI kecuali Keterangan, Usaha Sampingan, dan Link Drive.</div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan) <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="whatsapp" class="form-label">Nomor Handphone Aktif <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">+62</span>
                                                        <input type="tel" class="form-control" id="whatsapp" required placeholder="8123xxxx">
                                                        <button class="btn btn-outline-secondary" type="button" id="btnNoWA" title="Tidak Punya WA">Tidak Ada</button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profesi" class="form-label">Kategori Profesi <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="profesi" required>
                                                        <option value="">Pilih Profesi...</option>
                                                        <option value="Penuh Waktu">Penuh Waktu</option>
                                                        <option value="Sambilan Utama">Sambilan Utama</option>
                                                        <option value="Sambilan Tambahan">Sambilan Tambahan</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="statusNelayan" class="form-label">Status Pekerjaan <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="statusNelayan" required>
                                                        <option value="">Pilih Status...</option>
                                                        <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                        <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tahunLahir" class="form-label">Tahun Kelahiran <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="kecamatan" class="form-label fw-bold text-primary">Kecamatan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="kecamatan" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                    <input type="text" class="form-control bg-light" id="usia" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="desa" class="form-label fw-bold text-primary">Desa / Kelurahan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="desa" required disabled>
                                                        <option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- ALAT PENANGKAPAN IKAN (API) - Dipindah ke menu utama -->
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label fw-bold">Alat Penangkapan Ikan (API) <span class="text-danger">*</span></label>
                                                    <div class="card p-3 bg-light border">
                                                        <select class="form-select" id="alatTangkap" required>
                                                            <option value="">Pilih Alat Penangkapan Ikan...</option>
                                                            <option value="Pukat Cincin">Pukat Cincin</option>
                                                            <option value="Pukat Tarik">Pukat Tarik</option>
                                                            <option value="Pancing Ulur">Pancing Ulur</option>
                                                            <option value="Jaring Insang (gill net)">Jaring Insang (gill net)</option>
                                                            <option value="Jaring Angkat (lift net)">Jaring Angkat (lift net)</option>
                                                            <option value="Pancing">Pancing</option>
                                                            <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                            <option value="Lainnya">Lainnya</option>
                                                        </select>
                                                        <div id="apiInfo" class="api-info-box mt-2" style="display:none;"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="ownerFields" style="display:none;" class="bg-light p-4 rounded-3 mb-3 border">
                                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3"><i class="fas fa-ship me-2"></i>Detail Aset Kapal (Wajib bagi Pemilik Kapal)</h6>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Nama Kapal</label>
                                                        <input type="text" class="form-control" id="namaKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Jenis Kapal</label>
                                                        <select class="form-select" id="jenisKapal">
                                                            <option value="">Pilih Jenis...</option>
                                                            <option value="Perahu Jukung">Perahu Jukung</option>
                                                            <option value="Perahu Mayang">Perahu Mayang</option>
                                                            <option value="Perahu Slerek">Perahu Slerek</option>
                                                            <option value="Perahu Insang">Perahu Insang</option>
                                                            <option value="Perahu Jaring Angkat">Perahu Jaring Angkat</option>
                                                            <option value="Perahu Pancing">Perahu Pancing</option>
                                                            <option value="Lainnya">Lainnya</option>
                                                        </select>
                                                        <div id="kapalInfo" class="kapal-info-box mt-2" style="display:none;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Jenis Ikan Tangkapan Utama <span class="text-danger">*</span></label>
                                                    <div class="card p-3 bg-light border">
                                                        <div id="fishCheckboxContainer" style="max-height: 200px; overflow-y: auto;">
                                                            </div>
                                                        <input type="text" class="form-control form-control-sm mt-2" id="jenisIkanLainnya" placeholder="Sebutkan jenis lainnya..." style="display:none;">
                                                    </div>
                                                    <small class="text-muted fst-italic">*Pilih minimal satu</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="usahaSampingan" class="form-label">Usaha Sampingan (Opsional)</label>
                                                    <input type="text" class="form-control" id="usahaSampingan" placeholder="Contoh: Ternak, Warung">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="tanggalValidasi" class="form-label">Tanggal Validasi <span class="text-danger">*</span></label>
                                                    <input type="date" class="form-control" id="tanggalValidasi" required readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="validator" class="form-label">Petugas Validator <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="validator" required>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="driveLink" class="form-label">Link Dokumen (Google Drive) <span class="text-muted">(Opsional)</span></label>
                                                    <input type="url" class="form-control" id="driveLink">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="kodeValidasi" class="form-label fw-bold text-danger">Kode Validasi (Wajib Generate) <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control bg-light" id="kodeValidasi" readonly required placeholder="Klik Generate...">
                                                        <button type="button" class="btn btn-warning fw-bold" id="generateKodeBtn">GENERATE ID</button>
                                                    </div>
                                                    <small class="text-muted" style="font-size: 0.75rem;">*Kode validasi bersifat permanen dan tidak dapat diubah.</small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <label for="keterangan" class="form-label">Keterangan Tambahan <span class="text-muted">(Opsional)</span></label>
                                                <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                            </div>
                                            
                                            <div class="d-flex justify-content-end border-top pt-3">
                                                <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                                <button type="submit" class="btn btn-primary px-4 fw-bold shadow"><i class="fas fa-save me-2"></i>SIMPAN DATA</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-data">
                                <h3 class="section-title">Database Nelayan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3">
                                        <div class="row align-items-center g-2">
                                            <div class="col-12 col-md-4">
                                                <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Data Terdaftar</h6>
                                            </div>
                                            <div class="col-12 col-md-8 d-flex justify-content-md-end gap-2 flex-wrap">
                                                <div class="input-group flex-grow-1 flex-md-grow-0" style="max-width: 100%; width: 300px;">
                                                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                                    <input type="text" class="form-control border-start-0" id="searchData" placeholder="Cari cerdas (Nama, NIK, Kapal)...">
                                                </div>
                                                <button class="btn btn-danger btn-sm d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-1"></i> Hapus Terpilih</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover data-table mb-0" id="dataTable">
                                                <thead>
                                                    <tr>
                                                        <th width="40" class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                        <th width="50" class="text-center">No</th>
                                                        <th class="col-id-cell">Identitas Nelayan</th>
                                                        <th class="col-contact-cell">Kontak</th>
                                                        <th class="col-status-cell">Profesi & Status</th>
                                                        <th class="col-status-cell">Aset Kapal</th>
                                                        <th style="white-space: nowrap;">API</th>
                                                        <th class="col-action sticky-col-right text-center">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dataTableBody">
                                                    <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data database...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light flex-wrap gap-2">
                                            <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                            <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                        </div>
                                        <div class="p-2 small text-muted fst-italic text-end border-top">
                                            <span id="sensorStatusText" class="badge bg-secondary me-2">Sensor: ON</span>
                                            <i class="fas fa-info-circle text-danger me-1"></i> Baris <span class="badge bg-danger">Merah</span> = duplikasi NIK.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-filter">
                                 <h3 class="section-title">Filter & Validasi Data</h3>
                                 <div class="card mb-4 border-0 shadow-sm">
                                    <div class="card-body bg-light rounded">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Desa</label>
                                                <select class="form-select form-select-sm" id="filterDesa"></select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Profesi</label>
                                                <select class="form-select form-select-sm" id="filterProfesi">
                                                    <option value="">Semua</option>
                                                    <option value="Penuh Waktu">Penuh Waktu</option>
                                                    <option value="Sambilan Utama">Sambilan Utama</option>
                                                    <option value="Sambilan Tambahan">Sambilan Tambahan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Status Kepemilikan</label>
                                                <select class="form-select form-select-sm" id="filterStatus">
                                                    <option value="">Semua</option>
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Jenis Kapal</label>
                                                <select class="form-select form-select-sm" id="filterJenisKapal">
                                                    <option value="">Semua</option>
                                                    <option value="Perahu Jukung">Perahu Jukung</option>
                                                    <option value="Perahu Mayang">Perahu Mayang</option>
                                                    <option value="Perahu Slerek">Perahu Slerek</option>
                                                    <option value="Perahu Insang">Perahu Insang</option>
                                                    <option value="Perahu Jaring Angkat">Perahu Jaring Angkat</option>
                                                    <option value="Perahu Pancing">Perahu Pancing</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Alat Tangkap (API)</label>
                                                <select class="form-select form-select-sm" id="filterAlatTangkap">
                                                    <option value="">Semua</option>
                                                    <option value="Pukat Cincin">Pukat Cincin</option>
                                                    <option value="Pukat Tarik">Pukat Tarik</option>
                                                    <option value="Pancing Ulur">Pancing Ulur</option>
                                                    <option value="Jaring Insang">Jaring Insang</option>
                                                    <option value="Jaring Angkat">Jaring Angkat</option>
                                                    <option value="Pancing">Pancing</option>
                                                    <option value="Perangkap Bubu">Perangkap Bubu</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Usaha Sampingan</label>
                                                <select class="form-select form-select-sm" id="filterUsaha">
                                                    <option value="">Semua</option>
                                                    <option value="Ada">Ada Usaha Sampingan</option>
                                                    <option value="Tidak">Tidak Ada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100 btn-sm" id="applyFilterBtn"><i class="fas fa-search me-2"></i> Terapkan Filter</button>
                                            </div>
                                            <div class="col-md-12">
                                                 <button class="btn btn-danger btn-sm shadow-sm float-end" id="btnCekGanda"><i class="fas fa-exclamation-triangle me-2"></i> Cek Data Ganda</button>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                                 <div class="card border-0 shadow-sm">
                                     <div class="card-body p-0">
                                         <div class="table-responsive">
                                            <table class="table table-hover data-table mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="col-no">No</th>
                                                        <th class="col-id">NIK</th>
                                                        <th class="col-id">Nama & Identitas</th>
                                                        <th class="col-prof">Status</th>
                                                        <th class="col-asset">API</th>
                                                        <th class="col-income">Profesi</th>
                                                        <th class="col-action">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="filterTableBody"><tr><td colspan="7" class="text-center py-4">Silakan terapkan filter untuk melihat hasil</td></tr></tbody>
                                            </table>
                                         </div>
                                     </div>
                                 </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-print">
                                <h3 class="section-title">Cetak Laporan</h3>
                                <div class="card p-5 text-center shadow-sm border-0">
                                    <div class="mb-3"><i class="fas fa-file-pdf fa-4x text-danger opacity-50"></i></div>
                                    <h5>Cetak Laporan Data Terfilter</h5>
                                    <p class="text-muted">Fitur ini akan mencetak data rekapitulasi lengkap sesuai data yang tersedia dalam format PDF Resmi.</p>
                                    <button class="btn btn-danger px-5 mt-3 shadow" id="printPdfBtn"><i class="fas fa-download me-2"></i> Download PDF Laporan Resmi</button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-export">
                                <h3 class="section-title">Ekspor & Pelaporan Data</h3>
                                <div class="row g-4">
                                    <div class="col-md-12">
                                        <div class="card p-4 border-success bg-white shadow-sm" style="border-left: 5px solid #25D366;">
                                            <div class="d-flex align-items-start flex-column flex-md-row">
                                                <div class="me-md-4 mb-3 mb-md-0 text-success"><i class="fab fa-whatsapp fa-3x"></i></div>
                                                <div>
                                                    <h5 class="fw-bold text-dark mb-2">Lapor Cepat via WhatsApp Center</h5>
                                                    <p class="mb-2 text-muted" style="line-height: 1.6;">
                                                        Silakan unduh <strong>File Sinkronisasi (reload.js)</strong> melalui tombol di bawah.
                                                        Selanjutnya, klik tombol <strong>"Kirim Laporan"</strong> untuk terhubung ke WhatsApp Administrator Dinas Perikanan Kabupaten Situbondo.
                                                        <br><span class="text-danger small">*Harap lampirkan file <b>reload.js</b> yang telah diunduh pada chat WhatsApp tersebut sebagai bukti sinkronisasi data.</span>
                                                    </p>
                                                    <button class="btn btn-success mt-2 px-4" id="sendWaBtn"><i class="fas fa-paper-plane me-2"></i> Kirim Laporan ke Pusat</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6"><button class="btn btn-outline-success w-100 py-4 h-100 shadow-sm" id="exportExcelBtn"><i class="fas fa-file-excel fa-2x mb-2 d-block"></i>Download Excel</button></div>
                                    <div class="col-md-6"><button class="btn btn-outline-warning w-100 py-4 h-100 shadow-sm" id="exportReloadJsBtn"><i class="fas fa-file-code fa-2x mb-2 d-block"></i>Download File Sinkronisasi Data</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-backup">
                                <h3 class="section-title">Backup & Restore</h3>
                                <div class="alert alert-warning small"><i class="fas fa-exclamation-triangle me-2"></i> <strong>Sistem Smart Restore:</strong> Data yang direstore akan <strong>DIGABUNGKAN</strong> dengan data yang ada (Merge), tidak menghapus data lama. Duplikasi NIK akan ditandai Merah.</div>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-download-alt fa-3x text-primary"></i></div>
                                            <h5>Download Backup Encrypted</h5>
                                            <p class="small text-muted mb-4">Unduh file backup terenkripsi yang aman.</p>
                                            <button class="btn btn-primary w-100" id="backupDataBtn">Unduh Database Lengkap</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-warning shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-upload-alt fa-3x text-warning"></i></div>
                                            <h5>Restore Data Encrypted</h5>
                                            <p class="small text-muted mb-0">Upload file reload.js untuk mengembalikan data.</p>
                                            <input type="file" class="form-control my-3" id="restoreFileInput" accept=".js,.json,.txt">
                                            <button class="btn btn-warning w-100 text-white" id="restoreDataBtn" disabled>Proses Restore & Merge</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-settings">
                                <h3 class="section-title">Pengaturan Sistem</h3>
                                <div class="card p-4 border-0 shadow-sm mb-4">
                                    <h6 class="fw-bold mb-3 border-bottom pb-2">Identitas Aplikasi</h6>
                                    <form id="settingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Aplikasi</label>
                                                <input type="text" class="form-control" id="appName" value="SISTEM PEMETAAN DATA NELAYAN">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Instansi</label>
                                                <input type="text" class="form-control" id="appSubtitle" value="PEMERINTAH KABUPATEN SITUBONDO">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Tampilkan Baris Per Halaman</label>
                                                <select class="form-select" id="itemsPerPageSelect">
                                                    <option value="10">10 Baris (Default)</option>
                                                    <option value="25">25 Baris</option>
                                                    <option value="50">50 Baris</option>
                                                    <option value="75">75 Baris</option>
                                                    <option value="100">100 Baris</option>
                                                </select>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                    </form>
                                </div>
                                
                                <div class="card p-4 border-0 shadow-sm border-start border-4 border-danger">
                                    <h6 class="fw-bold mb-3 text-danger"><i class="fas fa-user-shield me-2"></i>Privasi & Keamanan Data</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="d-block">Sensor Data Pribadi (NIK & No. HP)</strong>
                                            <small class="text-muted">Menyensor 4 digit terakhir dengan tanda bintang (*) pada tabel dan hasil unduhan.</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="privacyToggle" style="width: 3em; height: 1.5em; cursor: pointer;" checked>
                                        </div>
                                    </div>
                                    <div id="privacyStatus" class="mt-2 small text-success fw-bold">Status: Sensor Aktif (Aman)</div>
                                </div>
                            </div>

                        </div>
                        
                        <footer class="main-footer">
                            <div class="container">
                                <h5 class="footer-brand">SISTEM PEMETAAN DATA NELAYAN</h5>
                                <div class="footer-text">
                                    &copy; 2025 Bidang Pemberdayaan Nelayan <span class="footer-divider">|</span> Dinas Perikanan Kabupaten Situbondo
                                </div>
                                <div class="footer-links">
                                    <a href="#" style="pointer-events: none;">
                                        <i class="fas fa-phone-alt me-1"></i> Contact Center: 0878-6561-4222
                                    </a>
                                    <span class="footer-divider">|</span>
                                    <a href="mailto:info@dinasperikanansitubondo.com">
                                        <i class="fas fa-envelope me-1"></i> info@dinasperikanansitubondo.com
                                    </a>
                                </div>
                            </div>
                        </footer>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header modal-header-custom">
                        <h5 class="modal-title fw-bold"><i class="fas fa-id-card me-2"></i>DETAIL LENGKAP NELAYAN</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4 bg-light">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <h6 class="text-primary fw-bold mb-3">IDENTITAS PRIBADI</h6>
                                        <div class="detail-label">Nama Lengkap</div>
                                        <div class="detail-value" id="d_nama">-</div>
                                        <div class="detail-label">NIK (Nomor Induk Kependudukan)</div>
                                        <div class="detail-value font-monospace" id="d_nik">-</div>
                                        <div class="detail-label">Usia / Tahun Lahir</div>
                                        <div class="detail-value" id="d_usia">-</div>
                                        <div class="detail-label">Kontak (WhatsApp/Telp)</div>
                                        <div class="detail-value font-monospace" id="d_wa">-</div>
                                        <div class="detail-label">Domisili</div>
                                        <div class="detail-value" id="d_domisili">-</div>
                                    </div>
                                    <div class="col-md-6 ps-md-4 mt-3 mt-md-0">
                                        <h6 class="text-primary fw-bold mb-3">PROFESI & KEPEMILIKAN</h6>
                                        <div class="detail-label">Profesi</div>
                                        <div class="detail-value"><span id="d_profesi" class="badge bg-primary"></span></div>
                                        <div class="detail-label">Status</div>
                                        <div class="detail-value" id="d_status">-</div>
                                        <div class="detail-label">Alat Penangkapan Ikan (API)</div>
                                        <div class="detail-value" id="d_alatTangkap">-</div>
                                        <div class="detail-label">Usaha Sampingan</div>
                                        <div class="detail-value" id="d_usaha">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3" id="d_kapal_card" style="display:none;">
                            <div class="card-body bg-white border-start border-4 border-info">
                                <h6 class="text-info fw-bold mb-3"><i class="fas fa-ship me-2"></i>DATA KAPAL DIMILIKI</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="detail-label">Nama Kapal</div>
                                        <div class="fw-bold" id="d_namaKapal">-</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Jenis Kapal</div>
                                        <div class="fw-bold"><span id="d_jenisKapal">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body bg-white border-start border-4 border-success">
                                <h6 class="text-success fw-bold mb-3"><i class="fas fa-fish me-2"></i>JENIS IKAN TANGKAPAN</h6>
                                <div id="d_ikan"></div>
                            </div>
                        </div>

                        <div class="text-end text-muted small fst-italic">
                            Terakhir divalidasi: <span id="d_tgl_valid">-</span> oleh <span id="d_validator">-</span>
                        </div>
                    </div>
                    <div class="modal-footer bg-white">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" class="btn btn-danger" id="btnDownloadDetailPdf"><i class="fas fa-file-pdf me-2"></i>UNDUH DOKUMEN (PDF)</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <a href="#" class="fab-item" id="fabInput" title="Input Data"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" title="Filter"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabExport" title="Ekspor"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" title="Backup"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" title="Pengaturan"><i class="fas fa-cog"></i></a>
            <a href="#" class="fab-item" id="fabReload" title="Reload Repo"><i class="fas fa-sync"></i></a>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast notification-toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS untuk peta -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        // --- DATA CONSTANTS - TELAH DIPERBAIKI SESUAI DATA YANG DIBERIKAN ---
        const SITUBONDO_DATA = {
            "Arjasa": [
                "Arjasa", "Bayeman", "Curah Tatal", "Jatisari", "Kayumas", "Kedungdowo", "Ketowan", "Lamongan"
            ],
            "Asembagus": [
                "Asembagus", "Awar-awar", "Bantal", "Gudang", "Kedunglo", "Kertosari", "Mojosari", "Parante", "Trigonco", "Wringin Anom"
            ],
            "Banyuglugur": [
                "Banyuglugur", "Kalianget", "Kalisari", "Lubawang", "Selobanteng", "Telempong", "Tepos"
            ],
            "Banyuputih": [
                "Banyuputih", "Sumberanyar", "Sumberejo", "Sumberwaru", "Wonorejo"
            ],
            "Besuki": [
                "Besuki", "Blimbing", "Bloro", "Demung", "Jetis", "Kalimas", "Langkap", "Pesisir", "Sumberejo", "Widoropayung"
            ],
            "Bungatan": [
                "Bletok", "Bungatan", "Mlandingan Wetan", "Pasir Putih", "Patemon", "Selowogo", "Sumbertengah"
            ],
            "Jangkar": [
                "Agel", "Curah Kalak", "Gadingan", "Jangkar", "Kumbangsari", "Palangan", "Pesanggrahan", "Sopet"
            ],
            "Jatibanteng": [
                "Curahsuri", "Jatibanteng", "Kembangsari", "Pategalan", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"
            ],
            "Kapongan": [
                "Curah Cottok Gebangan", "Kandang", "Kapongan", "Kesambi Rampak", "Landangan", "Peleyan", "Pokaan", "Seletreng", "Wonokoyo"
            ],
            "Kendit": [
                "Balung", "Bugeman", "Kendit", "Klatakan", "Kukusan", "Rajekwesi", "Tambak Ukir"
            ],
            "Mangaran": [
                "Mangaran", "Semiring", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Trebungan"
            ],
            "Mlandingan": [
                "Alas Bayur", "Campoan", "Mlandingan Kulon", "Selomukti", "Sumberanyar", "Sumber Pinang", "Trebungan"
            ],
            "Panarukan": [
                "Alasmalang", "Duwet", "Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"
            ],
            "Panji": [
                "Ardirejo", "Mimbaan", // Kelurahan
                "Battal", "Curah Jeru", "Juglangan", "Kayu Putih", "Klampokan", "Panji Kidul", "Panji Lor", "Sliwung", "Tenggir", "Tokelan"
            ],
            "Situbondo": [
                "Dawuhan", "Patokan", // Kelurahan
                "Kalibagor", "Kotakan", "Olean", "Talkandang"
            ],
            "Suboh": [
                "Buduan", "Cemara", "Dawuan", "Gunung Malang", "Gunung Putri", "Ketah", "Mojodungkol", "Suboh"
            ],
            "Sumbermalang": [
                "Alastengah", "Baderan", "Kalirejo", "Plalangan", "Sumberargo", "Taman", "Tamankursi", "Tamansari", "Tlogosari"
            ]
        };

        // DATA KOORDINAT DESA/KELURAHAN
        const COORDINATES_DATA = {
            // Kecamatan Panarukan
            "Panarukan, Alasmalang": [-7.6970, 113.7687],
            "Panarukan, Duwet": [-7.6977, 113.7882],
            "Panarukan, Gelung": [-7.7134, 113.8028],
            "Panarukan, Kilensari": [-7.6843, 113.7656],
            "Panarukan, Paowan": [-7.7298, 113.7800],
            "Panarukan, Peleyan": [-7.6950, 113.8071],
            "Panarukan, Sumberkolak": [-7.7118, 113.7618],
            "Panarukan, Wringinanom": [-7.7061, 113.8256],
            
            // Kecamatan Panji
            "Panji, Battal": [-7.7099, 113.6780],
            "Panji, Curah Jeru": [-7.6941, 113.6958],
            "Panji, Juglangan": [-7.6946, 113.6653],
            "Panji, Kayu Putih": [-7.7025, 113.6737],
            "Panji, Klampokan": [-7.7272, 113.6482],
            "Panji, Panji Kidul": [-7.7126, 113.7038],
            "Panji, Panji Lor": [-7.7019, 113.7059],
            "Panji, Sliwung": [-7.7188, 113.6806],
            "Panji, Tenggir": [-7.7163, 113.6579],
            "Panji, Tokelan": [-7.7320, 113.6703],
            "Panji, Ardirejo": [-7.7155, 113.6944],
            "Panji, Mimbaan": [-7.7091, 113.6952],
            
            // Kecamatan Situbondo
            "Situbondo, Kalibagor": [-7.7082, 114.0061],
            "Situbondo, Kotakan": [-7.6814, 114.0225],
            "Situbondo, Olean": [-7.6819, 114.0367],
            "Situbondo, Talkandang": [-7.6681, 114.0475],
            "Situbondo, Dawuhan": [-7.6926, 113.9937],
            "Situbondo, Patokan": [-7.6729, 113.9771],
            
            // Kecamatan Suboh
            "Suboh, Buduan": [-7.8523, 113.7659],
            "Suboh, Cemara": [-7.8267, 113.7425],
            "Suboh, Dawuan": [-7.8398, 113.7719],
            "Suboh, Gunung Malang": [-7.8708, 113.7489],
            "Suboh, Gunung Putri": [-7.8647, 113.7325],
            "Suboh, Ketah": [-7.8614, 113.7894],
            "Suboh, Mojodungkol": [-7.8360, 113.7829],
            "Suboh, Suboh": [-7.8475, 113.7580],
            
            // Kecamatan Sumbermalang
            "Sumbermalang, Alastengah": [-7.8771, 113.8437],
            "Sumbermalang, Baderan": [-7.8318, 113.8214],
            "Sumbermalang, Kalirejo": [-7.8203, 113.8525],
            "Sumbermalang, Plalangan": [-7.8630, 113.8629],
            "Sumbermalang, Sumberargo": [-7.8405, 113.8077],
            "Sumbermalang, Taman": [-7.8482, 113.8374],
            "Sumbermalang, Tamankursi": [-7.8641, 113.8256],
            "Sumbermalang, Tamansari": [-7.8618, 113.8125],
            "Sumbermalang, Tlogosari": [-7.8816, 113.8243]
        };

        // Koordinat default untuk wilayah yang tidak ada dalam data
        const DEFAULT_COORDINATES = {
            "Arjasa": [-7.7825, 113.7900],
            "Asembagus": [-7.7533, 114.2500],
            "Banyuglugur": [-7.8000, 113.8667],
            "Banyuputih": [-7.7167, 114.0833],
            "Besuki": [-7.7333, 113.7000],
            "Bungatan": [-7.6500, 113.8833],
            "Jangkar": [-7.7667, 114.1667],
            "Jatibanteng": [-7.8000, 113.9333],
            "Kapongan": [-7.6833, 114.0667],
            "Kendit": [-7.7167, 113.9167],
            "Mangaran": [-7.6667, 114.0500],
            "Mlandingan": [-7.6667, 113.8667]
        };

        const FISH_TYPES = [
            "Lainnya", 
            "Ikan Tongkol", "Ikan Kembung", "Ikan Selar", "Ikan Tenggiri", "Ikan Layang", 
            "Cumi-cumi", "Ikan Teri", "Kakap Merah", "Ikan Barakuda", "Kepiting",
            "Ikan Layur", "Ikan Mangla", "Ikan Kurisi", "Ikan Cakalang", "Ikan Kerapu", "Ikan Lemuru"
        ];

        // Informasi untuk API dan Jenis Kapal
        const API_INFO = {
            "Pukat Cincin": "Alat tangkap berupa jaring besar berbentuk cincin yang ditarik mengelilingi gerombolan ikan. Efektif untuk menangkap ikan pelagis seperti tuna dan cakalang.",
            "Pukat Tarik": "Jaring yang ditarik oleh kapal untuk menangkap ikan di permukaan atau pertengahan air. Cocok untuk ikan pelagis kecil seperti teri dan lemuru.",
            "Pancing Ulur": "Pancing dengan sistem ulur (handline) yang dioperasikan secara manual. Digunakan untuk menangkap ikan dasar seperti kerapu dan kakap.",
            "Jaring Insang (gill net)": "Jaring yang dipasang diam di air, ikan yang berenang akan tersangkut insangnya. Cocok untuk berbagai jenis ikan.",
            "Jaring Angkat (lift net)": "Jaring berbentuk persegi yang diturunkan ke air lalu diangkat cepat. Efektif untuk ikan permukaan.",
            "Pancing": "Alat tangkap tradisional menggunakan mata pancing dan umpan. Fleksibel untuk berbagai jenis ikan.",
            "Perangkap Bubu": "Perangkap berbentuk kurungan untuk menjebak ikan. Umum untuk menangkap ikan karang dan udang.",
            "Lainnya": "Alat tangkap lain yang tidak termasuk dalam kategori di atas."
        };

        const KAPAL_INFO = {
            "Perahu Jukung": "Perahu tradisional kayu kecil, umumnya tanpa mesin atau bermesin kecil. Cocok untuk perairan tenang dan dekat pantai.",
            "Perahu Mayang": "Perahu tradisional yang lebih besar dari jukung, biasanya bermesin tempel. Untuk penangkapan di perairan sedang.",
            "Perahu Slerek": "Perahu khas Situbondo dengan bentuk ramping, biasanya menggunakan layar atau mesin kecil. Untuk operasi dekat pantai.",
            "Perahu Insang": "Perahu khusus untuk operasi jaring insang (gill net), dilengkapi dengan sistem pemasangan jaring.",
            "Perahu Jaring Angkat": "Perahu dengan sistem derek untuk mengoperasikan jaring angkat (lift net).",
            "Perahu Pancing": "Perahu yang didesain khusus untuk operasi pancing, baik handline maupun rawai.",
            "Lainnya": "Jenis kapal lain yang tidak termasuk dalam kategori di atas."
        };

        // --- GLOBAL VARIABLES ---
        let appData = [];
        let appSettings = {
            appName: 'SISTEM PEMETAAN DATA NELAYAN',
            appSubtitle: 'DINAS PERIKANAN KABUPATEN SITUBONDO',
            itemsPerPage: 10,
            privacyMode: true 
        };
        let currentPage = 1;
        let duplicateCheckInterval = null;
        let currentDetailId = null; 
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
        const loginSuccessModal = new bootstrap.Modal(document.getElementById('loginSuccessModal'));
        
        // Variabel untuk peta
        let map = null;
        let markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            disableClusteringAtZoom: 15
        });
        let currentMarkers = [];
        let mapView = 'all';
        
        // --- FUNGSI GENERATE KODE KEAMANAN DINAMIS ---
        function generateSecurityCode() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // 01-12
            const day = String(now.getDate()).padStart(2, '0'); // 01-31
            
            // Format: YYYYMMDD (8 digit)
            return `${year}${month}${day}`;
        }
        
        // --- FUNGSI UNTUK MENAMPILKAN TANGGAL SEKARANG ---
        function displayCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('id-ID', options);
            document.getElementById('currentDateDisplay').innerHTML = `<i class="fas fa-calendar-day me-2"></i>${dateString}`;
            
            // Tampilkan hint untuk kode keamanan (TIDAK MENAMPILKAN KODE)
            document.getElementById('passwordHint').innerHTML = `Kode keamanan berubah setiap hari berdasarkan tanggal.`;
        }

        // --- FUNGSI UNTUK MENDAPATKAN KOORDINAT BERDASARKAN DESA ---
        function getCoordinatesForLocation(kecamatan, desa) {
            const key = `${kecamatan}, ${desa}`;
            
            // Cari koordinat spesifik untuk desa
            if (COORDINATES_DATA[key]) {
                return COORDINATES_DATA[key];
            }
            
            // Jika tidak ditemukan, cari koordinat default untuk kecamatan
            if (DEFAULT_COORDINATES[kecamatan]) {
                return DEFAULT_COORDINATES[kecamatan];
            }
            
            // Jika tidak ditemukan sama sekali, gunakan koordinat default Kabupaten Situbondo
            return [-7.7068, 113.9142]; // Koordinat Kabupaten Situbondo
        }

        // --- FUNGSI UNTUK INISIALISASI PETA ---
        function initializeMap() {
            if (map) {
                map.remove();
                markers.clearLayers();
                currentMarkers = [];
            }
            
            // Inisialisasi peta dengan view ke Kabupaten Situbondo
            map = L.map('map').setView([-7.7068, 113.9142], 11);
            
            // Tambahkan tile layer dari OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Tambahkan marker cluster group ke peta
            markers.addTo(map);
            
            // Render marker untuk data yang ada
            renderMapMarkers();
            
            // Update statistik peta
            updateMapStatistics();
        }
        
        // --- FUNGSI UNTUK RENDER MARKER PADA PETA ---
        function renderMapMarkers() {
            if (!map || !markers) return;
            
            // Hapus marker sebelumnya
            markers.clearLayers();
            currentMarkers = [];
            
            // Kelompokkan data berdasarkan kecamatan untuk statistik
            const kecamatanCount = {};
            const desaCount = {};
            let pemilikKapalCount = 0;
            
            appData.forEach((nelayan, index) => {
                // Hitung statistik
                kecamatanCount[nelayan.kecamatan] = (kecamatanCount[nelayan.kecamatan] || 0) + 1;
                desaCount[nelayan.desa] = (desaCount[nelayan.desa] || 0) + 1;
                if (nelayan.status === 'Pemilik Kapal') pemilikKapalCount++;
                
                // Dapatkan koordinat untuk desa
                const coordinates = getCoordinatesForLocation(nelayan.kecamatan, nelayan.desa);
                
                // Tentukan warna marker berdasarkan profesi
                let markerColor = '#0c2461'; // Default: Penuh Waktu
                let markerClass = 'marker-penuh';
                
                if (nelayan.profesi === 'Sambilan Utama') {
                    markerColor = '#e58e26';
                    markerClass = 'marker-sambilan-utama';
                } else if (nelayan.profesi === 'Sambilan Tambahan') {
                    markerColor = '#27ae60';
                    markerClass = 'marker-sambilan-tambahan';
                }
                
                // Tentukan ikon berdasarkan status
                let iconClass = 'fa-user';
                if (nelayan.status === 'Pemilik Kapal') {
                    markerColor = '#0984e3';
                    markerClass = 'marker-pemilik';
                    iconClass = 'fa-ship';
                } else if (nelayan.status === 'Anak Buah Kapal') {
                    markerColor = '#a55eea';
                    markerClass = 'marker-abk';
                    iconClass = 'fa-users';
                }
                
                // Buat custom icon
                const customIcon = L.divIcon({
                    html: `<div class="marker-icon ${markerClass}" style="
                        background-color: ${markerColor};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                    ">
                        <i class="fas ${iconClass}"></i>
                    </div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15]
                });
                
                // Buat konten popup
                const popupContent = `
                    <div class="leaflet-popup-content">
                        <h4>${nelayan.nama}</h4>
                        <div class="popup-detail">
                            <span class="popup-label">NIK:</span>
                            <span class="popup-value">${maskData(nelayan.nik)}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Usia:</span>
                            <span class="popup-value">${nelayan.usia} Tahun</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Profesi:</span>
                            <span class="popup-value">${nelayan.profesi}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Status:</span>
                            <span class="popup-value">${nelayan.status}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Domisili:</span>
                            <span class="popup-value">${nelayan.desa}, ${nelayan.kecamatan}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Alat Tangkap:</span>
                            <span class="popup-value">${nelayan.alatTangkap}</span>
                        </div>
                        <div class="popup-detail">
                            <button class="btn btn-sm btn-primary w-100 mt-2" onclick="viewDetail('${nelayan.id}')">
                                <i class="fas fa-info-circle me-1"></i> Lihat Detail
                            </button>
                        </div>
                    </div>
                `;
                
                // Buat marker
                const marker = L.marker(coordinates, { icon: customIcon })
                    .bindPopup(popupContent)
                    .on('click', function() {
                        // Tambahkan efek saat marker diklik
                        this.openPopup();
                    });
                
                // Tambahkan marker ke cluster
                markers.addLayer(marker);
                currentMarkers.push(marker);
            });
            
            // Update statistik peta
            document.getElementById('map-total-points').textContent = appData.length;
            document.getElementById('map-total-kecamatan').textContent = Object.keys(kecamatanCount).length;
            document.getElementById('map-total-desa').textContent = Object.keys(desaCount).length;
            document.getElementById('map-total-kapal').textContent = pemilikKapalCount;
        }
        
        // --- FUNGSI UNTUK UPDATE STATISTIK PETA ---
        function updateMapStatistics() {
            if (appData.length === 0) return;
            
            const kecamatanCount = {};
            const desaCount = {};
            let pemilikKapalCount = 0;
            
            appData.forEach(nelayan => {
                kecamatanCount[nelayan.kecamatan] = (kecamatanCount[nelayan.kecamatan] || 0) + 1;
                desaCount[nelayan.desa] = (desaCount[nelayan.desa] || 0) + 1;
                if (nelayan.status === 'Pemilik Kapal') pemilikKapalCount++;
            });
            
            document.getElementById('map-total-points').textContent = appData.length;
            document.getElementById('map-total-kecamatan').textContent = Object.keys(kecamatanCount).length;
            document.getElementById('map-total-desa').textContent = Object.keys(desaCount).length;
            document.getElementById('map-total-kapal').textContent = pemilikKapalCount;
        }
        
        // --- FUNGSI UNTUK SWITCH VIEW PETA ---
        function switchMapView(view) {
            mapView = view;
            
            // Update tab aktif
            document.querySelectorAll('.map-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Render ulang marker sesuai view
            renderMapMarkers();
            
            // Tampilkan notifikasi
            let viewName = 'Semua Data';
            if (view === 'profesi') viewName = 'Berdasarkan Profesi';
            else if (view === 'kecamatan') viewName = 'Berdasarkan Kecamatan';
            
            showNotification(`Peta ditampilkan dengan view: ${viewName}`, 'info');
        }
        
        // --- FUNGSI UNTUK RESET VIEW PETA ---
        function resetMapView() {
            if (map) {
                map.setView([-7.7068, 113.9142], 11);
                showNotification('Peta direset ke view awal', 'info');
            }
        }
        
        // --- FUNGSI UNTUK ZOOM KE SEMUA MARKER ---
        function zoomToAllMarkers() {
            if (map && currentMarkers.length > 0) {
                const group = L.featureGroup(currentMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
                showNotification('Zoom ke semua marker', 'info');
            }
        }
        
        // --- FUNGSI UNTUK TOGGLE CLUSTER MARKER ---
        function toggleCluster() {
            const showCluster = document.getElementById('showCluster').checked;
            
            if (showCluster) {
                markers.addTo(map);
                showNotification('Mode grup marker diaktifkan', 'info');
            } else {
                map.removeLayer(markers);
                // Tambahkan marker langsung ke peta
                currentMarkers.forEach(marker => {
                    marker.addTo(map);
                });
                showNotification('Mode grup marker dinonaktifkan', 'info');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                setupEventListeners();
                initFishOptions();
                
                // Tampilkan tanggal sekarang di form login
                displayCurrentDate();
                
                // Set tanggal validasi otomatis ke hari ini
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalValidasi').value = today;
                
                // Session Check for Persistence (Fix Reload Malfunction)
                const isSessionActive = sessionStorage.getItem('simata_session') === 'active';
                if (isSessionActive) {
                    // Skip Login, go directly to Dashboard
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                    // Inisialisasi peta
                    setTimeout(() => {
                        initializeMap();
                    }, 500);
                    // Don't show welcome modal on simple reload
                } else {
                    // Show Login Modal normally
                    setTimeout(() => {
                        document.getElementById('loginModal').style.display = 'flex';
                    }, 100);
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                alert("Terjadi kesalahan sistem saat memuat. Silakan refresh.");
            }
        });

        function initializeApp() {
            loadData();
            loadSettings();
            
            // Check if reload.js is loaded and use it if appData is empty or user requests
            if (typeof window.SIMATA_BACKUP_ENCRYPTED !== 'undefined' && window.SIMATA_BACKUP_ENCRYPTED) {
                 console.log("Reload Repository detected. Ready to merge/sync.");
            }

            const kecSelect = document.getElementById('kecamatan');
            kecSelect.innerHTML = `<option value="">Pilih Kecamatan</option>`;
            Object.keys(SITUBONDO_DATA).sort().forEach(kec => kecSelect.add(new Option(kec, kec)));
            
            const allDesas = new Set();
            Object.values(SITUBONDO_DATA).forEach(list => list.forEach(d => allDesas.add(d)));
            const filterDesaSelect = document.getElementById('filterDesa');
            filterDesaSelect.innerHTML = `<option value="">Semua Desa</option>`;
            [...allDesas].sort().forEach(d => filterDesaSelect.add(new Option(d, d)));
            
            // Filter Alat Tangkap
            const filterAlatTangkap = document.getElementById('filterAlatTangkap');
            filterAlatTangkap.innerHTML = `<option value="">Semua</option>`;
            Object.keys(API_INFO).forEach(api => filterAlatTangkap.add(new Option(api, api)));
            
            updateAppIdentity();
            updatePrivacyUI();
            
            startDuplicateChecker();
            
            // Setup informasi API dan Kapal
            setupInfoTooltips();
        }

        function initFishOptions() {
            const container = document.getElementById('fishCheckboxContainer');
            container.innerHTML = '';
            FISH_TYPES.forEach(fish => {
                const id = 'fish_' + fish.replace(/\s/g, '');
                const html = `
                <label class="fish-option-box">
                    <input type="checkbox" class="form-check-input me-2 fish-checkbox" value="${fish}" id="${id}">
                    <span>${fish}</span>
                </label>`;
                container.innerHTML += html;
            });

            document.getElementById('fish_Lainnya').addEventListener('change', function() {
                const inputLain = document.getElementById('jenisIkanLainnya');
                if(this.checked) {
                    inputLain.style.display = 'block';
                    inputLain.setAttribute('required', 'required');
                } else {
                    inputLain.style.display = 'none';
                    inputLain.value = '';
                    inputLain.removeAttribute('required');
                }
            });
        }

        function setupInfoTooltips() {
            // API Info
            const alatTangkapSelect = document.getElementById('alatTangkap');
            const apiInfoDiv = document.getElementById('apiInfo');
            
            alatTangkapSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && API_INFO[selected]) {
                    apiInfoDiv.style.display = 'block';
                    apiInfoDiv.innerHTML = `<strong>${selected}:</strong> ${API_INFO[selected]}`;
                } else {
                    apiInfoDiv.style.display = 'none';
                }
            });

            // Kapal Info
            const jenisKapalSelect = document.getElementById('jenisKapal');
            const kapalInfoDiv = document.getElementById('kapalInfo');
            
            jenisKapalSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && KAPAL_INFO[selected]) {
                    kapalInfoDiv.style.display = 'block';
                    kapalInfoDiv.innerHTML = `<strong>${selected}:</strong> ${KAPAL_INFO[selected]}`;
                } else {
                    kapalInfoDiv.style.display = 'none';
                }
            });
        }

        function updateAppIdentity() {
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.querySelector('.app-subtitle').textContent = appSettings.appSubtitle;
            document.getElementById('itemsPerPageSelect').value = appSettings.itemsPerPage;
        }

        function updatePrivacyUI() {
            const toggle = document.getElementById('privacyToggle');
            const status = document.getElementById('privacyStatus');
            const sensorText = document.getElementById('sensorStatusText');
            
            toggle.checked = appSettings.privacyMode;
            if(appSettings.privacyMode) {
                status.innerHTML = "Status: <span class='text-success'>Sensor Aktif (Aman)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: ON";
                sensorText.className = "badge bg-success me-2";
            } else {
                status.innerHTML = "Status: <span class='text-danger'>Sensor Non-Aktif (Terbuka)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: OFF";
                sensorText.className = "badge bg-danger me-2";
            }
        }

        function maskData(data, force = false) {
            if (!data) return "-";
            if (data === '00000000') return "Tidak Ada";
            if (!appSettings.privacyMode && !force) return data;
            
            let str = data.toString();
            if (str.length <= 4) return str;
            return str.slice(0, -4) + "****";
        }

        function getFishIconClass(fishName) {
            const lower = fishName.toLowerCase();
            if (lower.includes('cumi')) return 'fa-ghost'; 
            if (lower.includes('kepiting')) return 'fa-spider'; 
            return 'fa-fish';
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Password toggle for login form
            const passwordToggle = document.getElementById('passwordToggle');
            if (passwordToggle) {
                passwordToggle.addEventListener('click', function() {
                    const passwordInput = document.getElementById('securityCode');
                    const icon = document.getElementById('passwordToggleIcon');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        this.title = "Sembunyikan kode";
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        this.title = "Lihat kode";
                    }
                });
            }

            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginButton');
                const spinner = document.getElementById('loginSpinner');
                const inputCode = document.getElementById('securityCode').value;
                const correctCode = generateSecurityCode();
                
                if (inputCode !== correctCode) {
                    showNotification('Kode keamanan salah! Periksa kembali atau hubungi administrator.', 'error');
                    return;
                }
                
                btn.disabled = true;
                spinner.classList.remove('d-none');
                btn.innerHTML = 'MEMBUKA SISTEM... <span class="spinner-border spinner-border-sm ms-2"></span>';
                
                setTimeout(() => {
                    // SET SESSION PERSISTENCE
                    sessionStorage.setItem('simata_session', 'active');

                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                    // Inisialisasi peta
                    setTimeout(() => {
                        initializeMap();
                    }, 500);
                    
                    // Tampilkan modal notifikasi login berhasil
                    loginSuccessModal.show();
                    
                    btn.disabled = false;
                    spinner.classList.add('d-none');
                    btn.innerHTML = 'BUKA DASHBOARD';
                }, 1200);
            });

            // Event listener untuk tombol lanjut ke dashboard
            document.getElementById('btnContinueDashboard').addEventListener('click', function() {
                // Tutup modal login success dan tampilkan welcome modal
                loginSuccessModal.hide();
                setTimeout(() => {
                    welcomeModal.show();
                }, 300);
            });

            document.getElementById('btnWelcomeReload').addEventListener('click', function() {
                welcomeModal.hide();
                handleReloadRepo();
            });

            document.getElementById('btnNoWA').addEventListener('click', function() {
                const input = document.getElementById('whatsapp');
                if (input.hasAttribute('readonly')) {
                    input.removeAttribute('readonly');
                    input.value = '';
                    input.setAttribute('required', 'required');
                    this.classList.remove('active', 'btn-secondary');
                    this.classList.add('btn-outline-secondary');
                    this.textContent = "Tidak Ada";
                } else {
                    input.value = '00000000';
                    input.setAttribute('readonly', true);
                    input.removeAttribute('required'); 
                    this.classList.add('active', 'btn-secondary');
                    this.classList.remove('btn-outline-secondary');
                    this.textContent = "Batal";
                }
            });

            document.getElementById('privacyToggle').addEventListener('click', function(e) {
                e.preventDefault();
                const currentStatus = appSettings.privacyMode;
                const currentCode = generateSecurityCode();
                if (currentStatus === true) {
                    const code = prompt("MASUKKAN KODE KEAMANAN untuk menonaktifkan sensor (kode hari ini):");
                    if (code === currentCode) {
                        appSettings.privacyMode = false;
                        saveSettings(); updatePrivacyUI(); renderDataTable();
                        showNotification('Sensor Data dinonaktifkan.', 'warning');
                    } else { 
                        alert("Kode Keamanan Salah! Kode hari ini: " + currentCode); 
                        this.checked = true; // Kembalikan toggle ke posisi aktif
                    }
                } else {
                    appSettings.privacyMode = true;
                    saveSettings(); updatePrivacyUI(); renderDataTable();
                    showNotification('Sensor Data diaktifkan.', 'success');
                }
            });

            document.getElementById('kecamatan').addEventListener('change', function() {
                const selectedKec = this.value;
                const desaSelect = document.getElementById('desa');
                desaSelect.innerHTML = `<option value="">Pilih Desa / Kelurahan</option>`;
                if (selectedKec && SITUBONDO_DATA[selectedKec]) {
                    desaSelect.disabled = false;
                    SITUBONDO_DATA[selectedKec].sort().forEach(desa => desaSelect.add(new Option(desa, desa)));
                } else {
                    desaSelect.disabled = true;
                    desaSelect.innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
                }
            });

            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('inputForm').addEventListener('reset', () => {
                setTimeout(() => {
                    document.getElementById('ownerFields').style.display = 'none';
                    document.getElementById('usia').value = '';
                    document.getElementById('desa').disabled = true;
                    document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
                    document.getElementById('inputForm').removeAttribute('data-edit-id');
                    document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('jenisIkanLainnya').style.display = 'none';
                    const kv = document.getElementById('kodeValidasi');
                    kv.value = '';
                    kv.removeAttribute('readonly'); 
                    const waInput = document.getElementById('whatsapp');
                    waInput.removeAttribute('readonly');
                    const btnWa = document.getElementById('btnNoWA');
                    btnWa.classList.remove('active', 'btn-secondary');
                    btnWa.classList.add('btn-outline-secondary');
                    btnWa.textContent = "Tidak Ada";
                    // Reset API info
                    document.getElementById('apiInfo').style.display = 'none';
                    // Reset Kapal info
                    document.getElementById('kapalInfo').style.display = 'none';
                }, 100);
            });
            
            document.getElementById('statusNelayan').addEventListener('change', function() {
                const isOwner = this.value === 'Pemilik Kapal';
                const ownerFields = document.getElementById('ownerFields');
                ownerFields.style.display = isOwner ? 'block' : 'none';
                if(!isOwner) {
                    document.getElementById('namaKapal').value = '';
                    document.getElementById('jenisKapal').value = '';
                    document.getElementById('kapalInfo').style.display = 'none';
                }
            });

            document.getElementById('tahunLahir').addEventListener('input', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                if(year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                    document.getElementById('usia').value = currentYear - year;
                }
            });

            document.getElementById('generateKodeBtn').addEventListener('click', function() {
                const nik = document.getElementById('nik').value;
                const kodeInput = document.getElementById('kodeValidasi');
                if (kodeInput.value && kodeInput.value.trim() !== '') {
                    showNotification('Kode Validasi sudah digenerate dan bersifat permanen!', 'warning');
                    return;
                }
                if(nik.length !== 16) {
                    return showNotification('Isi NIK 16 digit terlebih dahulu!', 'error');
                }
                const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
                kodeInput.value = 'VLD-' + randomPart;
                showNotification('Kode Validasi berhasil dibuat dan terkunci.', 'success');
            });

            const overlay = document.getElementById('sidebarOverlay');
            const sidebar = document.getElementById('sidebarMenu');
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                sidebar.classList.add('mobile-show');
                overlay.classList.add('active');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('mobile-show');
                overlay.classList.remove('active');
            });
            document.querySelectorAll('#sidebarMenu .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('mobile-show');
                        overlay.classList.remove('active');
                    }
                });
            });
            
            document.getElementById('v-pills-logout-tab').addEventListener('click', () => {
                if(confirm('Apakah Anda yakin ingin keluar? Sistem akan mengunduh data (reload.js) secara otomatis.')) {
                    sessionStorage.removeItem('simata_session'); // Clear session
                    backupData('reload.js');
                    setTimeout(() => location.reload(), 2000);
                }
            });

            document.getElementById('searchData').addEventListener('input', renderDataTable);
            document.getElementById('applyFilterBtn').addEventListener('click', renderFilterTable);
            document.getElementById('btnCekGanda').addEventListener('click', showDuplicateDataInFilter);
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                toggleBulkDeleteBtn();
            });
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteData);

            document.getElementById('printPdfBtn').addEventListener('click', printData);
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('xlsx'));
            document.getElementById('exportReloadJsBtn').addEventListener('click', () => backupData('reload.js'));
            document.getElementById('sendWaBtn').addEventListener('click', sendDataToWhatsapp);
            document.getElementById('backupDataBtn').addEventListener('click', () => backupData());
            document.getElementById('restoreFileInput').addEventListener('change', function() {
                document.getElementById('restoreDataBtn').disabled = !this.files.length;
            });
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
            document.getElementById('btn-reload-repo').addEventListener('click', handleReloadRepo);
            
            document.getElementById('btnDownloadDetailPdf').addEventListener('click', () => {
                downloadSinglePdf(currentDetailId);
            });

            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                appSettings.appName = document.getElementById('appName').value;
                appSettings.appSubtitle = document.getElementById('appSubtitle').value;
                appSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value);
                saveSettings(); updateAppIdentity(); renderDataTable();
                showNotification('Pengaturan tersimpan!', 'success');
            });

            setupFloatingMenu();
        }

        function setupFloatingMenu() {
            const fabMain = document.getElementById('fabMainBtn');
            const container = document.getElementById('fabMenu');
            fabMain.addEventListener('click', () => {
                container.classList.toggle('open');
                const icon = fabMain.querySelector('i');
                if(container.classList.contains('open')){
                    icon.classList.remove('fa-plus'); icon.classList.add('fa-times');
                    fabMain.style.transform = "rotate(90deg)";
                } else {
                    icon.classList.add('fa-plus'); icon.classList.remove('fa-times');
                    fabMain.style.transform = "rotate(0deg)";
                }
            });
            const shortcuts = {'fabInput': 'v-pills-input-tab', 'fabFilter': 'v-pills-filter-tab', 'fabExport': 'v-pills-export-tab', 'fabBackup': 'v-pills-backup-tab', 'fabSettings': 'v-pills-settings-tab'};
            for (const [id, tabId] of Object.entries(shortcuts)) {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault(); document.getElementById(tabId).click(); container.classList.remove('open');
                });
            }
            document.getElementById('fabReload').addEventListener('click', (e) => {
                e.preventDefault(); handleReloadRepo();
            });
        }

        // --- CORE LOGIC ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('inputForm');
            const kodeVal = document.getElementById('kodeValidasi').value;
            if (!kodeVal || kodeVal.trim() === '') {
                showNotification('Anda WAJIB melakukan GENERATE KODE VALIDASI terlebih dahulu!', 'error');
                document.getElementById('generateKodeBtn').focus();
                return;
            }
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.reportValidity(); 
                return;
            }

            const nik = document.getElementById('nik').value;
            const whatsapp = document.getElementById('whatsapp').value;
            if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
            if(!whatsapp.match(/^\d+$/)) return showNotification('WhatsApp hanya angka', 'error');

            let selectedFish = [];
            document.querySelectorAll('.fish-checkbox:checked').forEach(cb => {
                if(cb.value === "Lainnya") {
                    const otherVal = document.getElementById('jenisIkanLainnya').value.trim();
                    if(otherVal) selectedFish.push(otherVal);
                } else {
                    selectedFish.push(cb.value);
                }
            });
            if(selectedFish.length === 0) return showNotification('Pilih minimal satu jenis ikan!', 'error');

            const editId = form.getAttribute('data-edit-id');
            const duplicateCheck = appData.find(d => d.nik === nik);
            if (duplicateCheck && (!editId || duplicateCheck.id != editId)) {
                return showNotification('GAGAL: NIK sudah terdaftar dalam sistem!', 'error');
            }

            const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
            const formData = {
                id: editId || Date.now(),
                nama: document.getElementById('nama').value,
                nik: nik,
                whatsapp: whatsapp,
                profesi: document.getElementById('profesi').value,
                status: document.getElementById('statusNelayan').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                usia: document.getElementById('usia').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alatTangkap: document.getElementById('alatTangkap').value,
                namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                jenisIkan: selectedFish.join(", "),
                usahaSampingan: document.getElementById('usahaSampingan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value
            };

            if (editId) {
                const index = appData.findIndex(item => item.id == editId);
                appData[index] = formData;
                form.removeAttribute('data-edit-id');
                showNotification('Data berhasil diperbarui', 'success');
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan', 'success');
            }

            saveData();
            form.reset();
            document.getElementById('ownerFields').style.display = 'none';
            document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
            document.getElementById('desa').disabled = true;
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            
            // Reset API dan Kapal info
            document.getElementById('apiInfo').style.display = 'none';
            document.getElementById('kapalInfo').style.display = 'none';

            updateDashboard(); 
            renderDataTable();
            // Update peta
            if (map) {
                renderMapMarkers();
                updateMapStatistics();
            }
            document.getElementById('v-pills-data-tab').click();
            checkGlobalDuplicates();
        }

        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const search = document.getElementById('searchData').value.toLowerCase();
            let filtered = appData.filter(d => JSON.stringify(d).toLowerCase().includes(search));
            const nikCounts = {};
            appData.forEach(d => nikCounts[d.nik] = (nikCounts[d.nik] || 0) + 1);

            const totalItems = filtered.length;
            const start = (currentPage - 1) * appSettings.itemsPerPage;
            const pageData = filtered.slice(start, start + appSettings.itemsPerPage);

            tableBody.innerHTML = '';
            if(pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Data tidak ditemukan</td></tr>`;
                toggleBulkDeleteBtn();
                return;
            }

            pageData.forEach((d, i) => {
                const kapalInfo = d.status === 'Pemilik Kapal' ? `<div class="text-truncate-2 small fw-bold text-primary">${d.namaKapal}</div><div class="small text-muted">${d.jenisKapal}</div>` : '-';
                const isDuplicate = nikCounts[d.nik] > 1;
                const rowClass = isDuplicate ? 'table-danger' : '';
                
                let badgeClass = 'bg-secondary';
                if(d.profesi === 'Penuh Waktu') badgeClass = 'badge-profesi-penuh';
                else if(d.profesi === 'Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
                else if(d.profesi === 'Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
                
                const displayNik = maskData(d.nik);
                const displayWaRaw = maskData(d.whatsapp);
                
                let contactDisplay = '';
                if(displayWaRaw === "Tidak Ada") {
                    contactDisplay = `<span class="badge bg-light text-muted border">Tidak Ada</span>`;
                } else {
                    if (appSettings.privacyMode) {
                        contactDisplay = `<div class="small"><i class="fas fa-phone-alt text-secondary me-1"></i> ${displayWaRaw}</div>`;
                    } else {
                        let cleanNum = d.whatsapp;
                        if(cleanNum.startsWith('0')) cleanNum = '62' + cleanNum.substring(1);
                        contactDisplay = `<div class="d-flex align-items-center gap-1"><a href="https://wa.me/${cleanNum}" target="_blank" class="btn btn-sm btn-success py-0 px-1" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a><span class="small font-monospace ms-1">${d.whatsapp}</span></div>`;
                    }
                }

                const row = `<tr class="${rowClass}">
                    <td class="text-center"><input type="checkbox" class="row-checkbox" value="${d.id}" onchange="toggleBulkDeleteBtn()"></td>
                    <td class="text-center">${start + i + 1}</td>
                    <td onclick="viewDetail('${d.id}')" class="clickable-name col-id-cell">
                        <div class="fw-bold text-dark text-wrap">${d.nama}</div>
                        <div class="small font-monospace text-muted">${displayNik} ${isDuplicate ? '<span class="text-danger fw-bold ms-1">(!)</span>' : ''}</div>
                        <div class="small text-muted text-wrap mt-1"><i class="fas fa-map-marker-alt me-1"></i>${d.kecamatan}, ${d.desa}</div>
                    </td>
                    <td class="col-contact-cell">${contactDisplay}</td>
                    <td class="col-status-cell"><span class="badge ${badgeClass} border">${d.profesi}</span><br><small class="text-muted">${d.status}</small></td>
                    <td class="col-status-cell">${kapalInfo}</td>
                    <td style="white-space:nowrap;"><span class="badge bg-info text-white">${d.alatTangkap}</span></td>
                    <td class="col-action sticky-col-right"><div class="btn-group shadow-sm" role="group"><button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Lihat Detail"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-warning text-white" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button></div></td>
                </tr>`;
                tableBody.appendChild(document.createElement('tbody')).innerHTML = row;
            });
            document.getElementById('tableInfo').textContent = `Menampilkan ${pageData.length} dari ${totalItems} data (Limit: ${appSettings.itemsPerPage})`;
            updatePagination(totalItems);
            toggleBulkDeleteBtn();
        }

        function viewDetail(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;
            currentDetailId = id;
            document.getElementById('d_nama').innerText = d.nama;
            document.getElementById('d_nik').innerText = d.nik; 
            document.getElementById('d_usia').innerText = `${d.usia} Tahun (${d.tahunLahir})`;
            document.getElementById('d_wa').innerText = d.whatsapp;
            document.getElementById('d_domisili').innerText = `${d.desa}, ${d.kecamatan}`;
            
            const profBadge = document.getElementById('d_profesi');
            profBadge.innerText = d.profesi;
            
            // Set badge color based on profesi
            let badgeClass = 'bg-primary';
            if(d.profesi === 'Penuh Waktu') badgeClass = 'badge-profesi-penuh';
            else if(d.profesi === 'Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
            else if(d.profesi === 'Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
            profBadge.className = `badge ${badgeClass}`;

            document.getElementById('d_status').innerText = d.status;
            document.getElementById('d_alatTangkap').innerText = d.alatTangkap;
            document.getElementById('d_usaha').innerText = d.usahaSampingan || '-';
            
            const fishContainer = document.getElementById('d_ikan');
            fishContainer.innerHTML = '';
            if(d.jenisIkan) {
                d.jenisIkan.split(', ').forEach(fish => {
                    const iconClass = getFishIconClass(fish);
                    fishContainer.innerHTML += `<span class="badge bg-light text-dark border me-1 mb-1"><i class="fas ${iconClass} me-1"></i>${fish}</span>`;
                });
            }
            if(d.status === 'Pemilik Kapal') {
                document.getElementById('d_kapal_card').style.display = 'block';
                document.getElementById('d_namaKapal').innerText = d.namaKapal;
                document.getElementById('d_jenisKapal').innerText = d.jenisKapal;
            } else {
                document.getElementById('d_kapal_card').style.display = 'none';
            }
            document.getElementById('d_tgl_valid').innerText = d.tanggalValidasi;
            document.getElementById('d_validator').innerText = d.validator;
            detailModal.show();
        }

        // --- PDF GENERATION - IMPROVED ---
        function downloadSinglePdf(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            // Generate Right Signature QR (Blue)
            document.getElementById('qr-right').innerHTML = "";
            const signatureText = `DOKUMEN SAH\nNama: SUGENG PURWO PRIYANTO, S.E, M.M\nJabatan: Kabid Pemberdayaan Nelayan\nRef: ${d.kodeValidasi || 'N/A'}`;
            new QRCode(document.getElementById("qr-right"), { 
                text: signatureText, width: 256, height: 256,
                colorDark: "#0984e3", // BLUE COLOR
                colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.M
            });

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'a4' });
                
                // Border
                doc.setDrawColor(12, 36, 97);
                doc.setLineWidth(1);
                doc.rect(10, 10, 190, 277);

                // --- Header ---
                doc.setFillColor(12, 36, 97);
                doc.rect(10, 10, 190, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text('PEMERINTAH KABUPATEN SITUBONDO', 105, 22, { align: 'center' });
                doc.setFontSize(16);
                doc.text('DINAS PERIKANAN', 105, 29, { align: 'center' });
                doc.setTextColor(246, 185, 59);
                doc.setFont('times', 'italic'); doc.setFontSize(12);
                doc.text('"Situbondo Naik Kelas"', 105, 37, { align: 'center' });
                
                // Title
                doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
                doc.text('BIODATA NELAYAN TERDAFTAR', 105, 65, { align: 'center' });
                doc.setLineWidth(0.5); doc.line(70, 68, 140, 68);

                let y = 80;
                const lineHeight = 7;
                
                const checkPage = (heightNeeded) => {
                    if (y + heightNeeded > 250) { 
                        doc.addPage();
                        doc.setDrawColor(12, 36, 97); doc.setLineWidth(1); doc.rect(10, 10, 190, 277); // Re-draw border
                        y = 30; 
                    }
                };

                const printLine = (label, value) => {
                    checkPage(lineHeight);
                    doc.setFont('helvetica', 'normal'); doc.text(label, 25, y);
                    doc.setFont('helvetica', 'bold'); 
                    
                    if (label === 'Domisili' || value.length > 50) {
                        const splitText = doc.splitTextToSize(': ' + value, 110);
                        doc.text(splitText, 80, y);
                        y += (splitText.length * 6);
                    } else {
                        doc.text(': ' + value, 80, y);
                        y += lineHeight;
                    }
                };

                // Section 1
                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('I. IDENTITAS PRIBADI', 22, y); y += 12;
                
                doc.setFontSize(10);
                printLine('Nama Lengkap', d.nama);
                printLine('NIK', d.nik);
                printLine('Tempat / Tgl Lahir', `${d.tahunLahir} (Usia: ${d.usia} Thn)`);
                printLine('Domisili', `${d.desa}, ${d.kecamatan}`);
                printLine('No. Handphone', d.whatsapp);
                y += 8;

                // Section 2
                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('II. PROFESI & EKONOMI', 22, y); y += 12;

                doc.setFontSize(10);
                printLine('Status Profesi', d.profesi);
                printLine('Posisi Kerja', d.status);
                printLine('Alat Penangkapan Ikan (API)', d.alatTangkap);
                printLine('Usaha Sampingan', d.usahaSampingan || '-');
                y += 8;

                // Section 3 - Jenis Ikan
                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('III. JENIS IKAN TANGKAPAN UTAMA', 22, y); y += 12;

                doc.setFontSize(10);
                const fishList = d.jenisIkan ? d.jenisIkan.split(', ') : [];
                fishList.forEach((fish, idx) => {
                    printLine(`Ikan ${idx + 1}`, fish);
                });
                y += 8;

                // Section 4 (Optional)
                if(d.status === 'Pemilik Kapal') {
                    checkPage(30);
                    doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                    doc.rect(20, y-4, 170, 6, 'F');
                    doc.text('IV. DATA ASET KAPAL', 22, y); y += 12;

                    doc.setFontSize(10);
                    printLine('Nama Kapal', d.namaKapal);
                    printLine('Jenis Kapal', d.jenisKapal);
                }

                // --- FOOTER BLOCK ---
                if(y > 210) doc.addPage();

                const footerY = 230; 
                const sigCenterX = 150; 
                const leftX = 25;

                // --- VALIDATION STAMP TEXT (REPLACEMENT FOR LEFT QR) ---
                doc.setDrawColor(150);
                doc.setLineWidth(0.5);
                doc.rect(leftX, footerY, 70, 30); // Box for text
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text("DOKUMEN INI TELAH DIVALIDASI", leftX + 35, footerY + 6, {align: 'center'});
                doc.text("SECARA ELEKTRONIK OLEH", leftX + 35, footerY + 10, {align: 'center'});
                doc.text("SISTEM SATU DATA (SIMATA)", leftX + 35, footerY + 14, {align: 'center'});
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text("Dinas Perikanan Kabupaten Situbondo", leftX + 35, footerY + 20, {align: 'center'});
                doc.setTextColor(0, 0, 255);
                doc.text("www.disnakansitubondo.com/simata", leftX + 35, footerY + 25, {align: 'center'});

                // Right Block: Signature
                doc.setFontSize(10); doc.setTextColor(0,0,0); doc.setFont('helvetica', 'normal');
                const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                doc.text(`Situbondo, ${dateStr}`, sigCenterX, footerY - 5, {align: 'center'});
                doc.text('Diketahui Oleh :', sigCenterX, footerY, {align: 'center'});
                doc.setFont('helvetica', 'bold');
                doc.text('Kepala Bidang Pemberdayaan Nelayan', sigCenterX, footerY + 5, {align: 'center'});

                // Signature QR (Blue)
                const qrRightCanvas = document.querySelector('#qr-right canvas');
                if(qrRightCanvas) {
                    const imgRight = qrRightCanvas.toDataURL("image/png");
                    doc.addImage(imgRight, 'PNG', sigCenterX - 12.5, footerY + 8, 25, 25); 
                }

                const nameY = footerY + 38; 
                doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', sigCenterX, nameY, {align: 'center'});
                doc.setFont('helvetica', 'normal');
                doc.text('NIP. 19761103 200903 1 002', sigCenterX, nameY + 5, {align: 'center'});

                // Footer Reference
                doc.setFontSize(7); doc.setTextColor(150);
                doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')} | Ref ID: ${d.kodeValidasi || '-'}`, 105, 285, {align:'center'});

                // ** ADDED: Page Numbering and Relation Text **
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    // Add Page Numbering at bottom
                    doc.text(`Dokumen ini saling berhubungan - Halaman ${i} dari ${totalPages}`, 105, 292, { align: 'center' });
                }

                doc.save(`${d.nama}_${d.nik}.pdf`);
                document.getElementById('qr-right').innerHTML = ""; // Cleanup

            }, 500);
        }

        function updatePagination(total) {
            const pages = Math.ceil(total / appSettings.itemsPerPage);
            const ul = document.getElementById('pagination');
            ul.innerHTML = '';
            for(let i=1; i<=pages; i++) {
                ul.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" onclick="currentPage=${i};renderDataTable()">${i}</a></li>`;
            }
        }

        function toggleBulkDeleteBtn() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length > 0;
            const btn = document.getElementById('bulkDeleteBtn');
            if(checked) btn.classList.remove('d-none'); else btn.classList.add('d-none');
        }

        function bulkDeleteData() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if(checkedBoxes.length === 0) return;
            const currentCode = generateSecurityCode();
            const userCode = prompt(`Anda akan menghapus ${checkedBoxes.length} data.\nMasukkan KODE KEAMANAN (kode hari ini):`);
            if(userCode === currentCode) {
                const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
                appData = appData.filter(d => !idsToDelete.includes(d.id.toString()));
                saveData(); renderDataTable(); updateDashboard();
                // Update peta
                if (map) {
                    renderMapMarkers();
                    updateMapStatistics();
                }
                showNotification(`${idsToDelete.length} data berhasil dihapus`, 'success');
                document.getElementById('selectAllCheckbox').checked = false;
                checkGlobalDuplicates();
            } else if (userCode !== null) alert("Kode keamanan SALAH! Kode hari ini: " + currentCode);
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;
            const form = document.getElementById('inputForm');
            form.setAttribute('data-edit-id', id);
            
            ['nama', 'nik', 'whatsapp', 'profesi', 'tahunLahir', 'usia', 'alatTangkap', 'usahaSampingan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan']
             .forEach(key => document.getElementById(key).value = d[key] || '');

            const waInput = document.getElementById('whatsapp');
            const btnWa = document.getElementById('btnNoWA');
            if(d.whatsapp === '00000000') {
                waInput.setAttribute('readonly', true);
                waInput.removeAttribute('required');
                btnWa.classList.add('active', 'btn-secondary');
                btnWa.textContent = "Batal";
            } else {
                waInput.removeAttribute('readonly');
                waInput.setAttribute('required', 'required');
                btnWa.classList.remove('active', 'btn-secondary');
                btnWa.textContent = "Tidak Ada";
            }

            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('jenisIkanLainnya').value = '';
            
            if(d.jenisIkan) {
                const savedFish = d.jenisIkan.split(', ');
                savedFish.forEach(fish => {
                    let found = false;
                    document.querySelectorAll('.fish-checkbox').forEach(cb => {
                        if(cb.value === fish) { cb.checked = true; found = true; }
                    });
                    if(!found) {
                        const cbLain = document.getElementById('fish_Lainnya');
                        cbLain.checked = true;
                        const inputLain = document.getElementById('jenisIkanLainnya');
                        inputLain.style.display = 'block';
                        inputLain.value = fish;
                    }
                });
            }

            const kecSelect = document.getElementById('kecamatan');
            kecSelect.value = d.kecamatan;
            kecSelect.dispatchEvent(new Event('change'));
            document.getElementById('desa').value = d.desa;

            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = d.status;
            statusSelect.dispatchEvent(new Event('change'));

            if(d.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal'].forEach(key => {
                    document.getElementById(key).value = d[key] || '';
                });
                
                // Show kapal info jika ada
                if(d.jenisKapal && KAPAL_INFO[d.jenisKapal]) {
                    document.getElementById('kapalInfo').style.display = 'block';
                    document.getElementById('kapalInfo').innerHTML = `<strong>${d.jenisKapal}:</strong> ${KAPAL_INFO[d.jenisKapal]}`;
                }
            }

            // Show API info jika ada
            if(d.alatTangkap && API_INFO[d.alatTangkap]) {
                document.getElementById('apiInfo').style.display = 'block';
                document.getElementById('apiInfo').innerHTML = `<strong>${d.alatTangkap}:</strong> ${API_INFO[d.alatTangkap]}`;
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0,0);
        }

        function deleteData(id) {
            const currentCode = generateSecurityCode();
            const userCode = prompt("Masukkan KODE KEAMANAN (kode hari ini) untuk menghapus data:");
            if(userCode === currentCode) {
                if(confirm('Yakin menghapus data ini secara permanen?')) {
                    appData = appData.filter(d => d.id != id);
                    saveData(); renderDataTable(); updateDashboard();
                    // Update peta
                    if (map) {
                        renderMapMarkers();
                        updateMapStatistics();
                    }
                    showNotification('Data berhasil dihapus', 'success');
                    checkGlobalDuplicates();
                }
            } else if (userCode !== null) alert("Kode keamanan SALAH! Kode hari ini: " + currentCode);
        }

        function renderFilterTable() {
            const filters = {
                desa: document.getElementById('filterDesa').value,
                profesi: document.getElementById('filterProfesi').value,
                status: document.getElementById('filterStatus').value,
                jenisKapal: document.getElementById('filterJenisKapal').value,
                alatTangkap: document.getElementById('filterAlatTangkap').value,
                usaha: document.getElementById('filterUsaha').value
            };

            const filtered = appData.filter(d => {
                const matchDesa = !filters.desa || d.desa === filters.desa;
                const matchProfesi = !filters.profesi || d.profesi === filters.profesi;
                const matchStatus = !filters.status || d.status === filters.status;
                const matchJenis = !filters.jenisKapal || (d.status === 'Pemilik Kapal' && d.jenisKapal === filters.jenisKapal);
                const matchAlatTangkap = !filters.alatTangkap || d.alatTangkap === filters.alatTangkap;
                const matchUsaha = !filters.usaha || (filters.usaha === 'Ada' ? (d.usahaSampingan && d.usahaSampingan.length > 2) : (!d.usahaSampingan || d.usahaSampingan.length < 2));
                return matchDesa && matchProfesi && matchStatus && matchJenis && matchAlatTangkap && matchUsaha;
            });

            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';
            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tidak ada data yang cocok dengan filter</td></tr>`;
                return;
            }

            filtered.forEach((d, i) => {
                const displayNik = maskData(d.nik);
                let profesiBadge = 'bg-secondary';
                if(d.profesi === 'Penuh Waktu') profesiBadge = 'badge-profesi-penuh';
                else if(d.profesi === 'Sambilan Utama') profesiBadge = 'badge-profesi-sambilan-utama';
                else if(d.profesi === 'Sambilan Tambahan') profesiBadge = 'badge-profesi-sambilan-tambahan';
                
                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td class="font-monospace small">${displayNik}</td>
                    <td><div class="fw-bold text-truncate" style="max-width:200px;">${d.nama}</div><div class="small text-muted"><i class="fas fa-map-marker-alt me-1"></i>${d.kecamatan}, ${d.desa}</div></td>
                    <td><span class="badge ${d.status === 'Pemilik Kapal' ? 'bg-info' : 'bg-secondary'}">${d.status}</span></td>
                    <td><span class="badge bg-warning text-dark">${d.alatTangkap}</span></td>
                    <td><span class="badge ${profesiBadge}">${d.profesi}</span></td>
                    <td><div class="btn-group"><button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Detail"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-warning" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button></div></td>
                </tr>`;
            });
            showNotification(`Filter berhasil: ${filtered.length} data ditemukan`, 'success');
        }

        function showDuplicateDataInFilter() {
            const counts = {};
            appData.forEach(d => counts[d.nik] = (counts[d.nik] || 0) + 1);
            const filtered = appData.filter(d => counts[d.nik] > 1);
            const tbody = document.getElementById('filterTableBody');
            tbody.innerHTML = '';
            
            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-success"><i class="fas fa-check-circle me-2"></i>Hebat! Tidak ditemukan data NIK ganda.</td></tr>`;
                return;
            }
            filtered.sort((a,b) => a.nik.localeCompare(b.nik));
            filtered.forEach((d, i) => {
                const displayNik = maskData(d.nik);
                tbody.innerHTML += `<tr class="table-danger"><td>${i+1}</td><td class="fw-bold text-danger">${displayNik}</td><td><strong>${d.nama}</strong><br><small>${d.desa}</small></td><td>${d.status}</td><td>${d.alatTangkap}</td><td>${d.profesi}</td><td><div class="btn-group"><button class="btn btn-sm btn-warning" onclick="editData('${d.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`;
            });
            showNotification(`PERINGATAN: Ditemukan ${filtered.length} baris data ganda!`, 'error');
        }

        function startDuplicateChecker() {
            checkGlobalDuplicates();
            duplicateCheckInterval = setInterval(checkGlobalDuplicates, 15000);
        }

        function checkGlobalDuplicates() {
            const counts = {};
            let hasDuplicate = false;
            for (const d of appData) {
                counts[d.nik] = (counts[d.nik] || 0) + 1;
                if (counts[d.nik] > 1) { hasDuplicate = true; break; }
            }
            document.getElementById('duplicateWarning').style.display = hasDuplicate ? 'block' : 'none';
        }

        function initializeCharts() {
            const profesiCtx = document.getElementById('profesiChart').getContext('2d');
            const kapalCtx = document.getElementById('kapalChart').getContext('2d');

            if (window.profesiChart instanceof Chart) window.profesiChart.destroy();
            if (window.kapalChart instanceof Chart) window.kapalChart.destroy();

            window.profesiChart = new Chart(profesiCtx, {
                type: 'doughnut', 
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
            });

            window.kapalChart = new Chart(kapalCtx, {
                type: 'bar', 
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });
            
            updateDashboard();
        }

        function updateDashboard() {
            if (!window.profesiChart || !window.kapalChart) return; 

            document.getElementById('totalPenerima').textContent = appData.length;
            const penuhWaktuCount = appData.filter(d => d.profesi === 'Penuh Waktu').length;
            document.getElementById('totalPenuhWaktu').textContent = penuhWaktuCount;
            document.getElementById('totalPemilik').textContent = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const avgAge = appData.length ? Math.round(appData.reduce((acc, c) => acc + (parseInt(c.usia)||0), 0) / appData.length) : 0;
            document.getElementById('rataUsia').textContent = avgAge + " Thn";
            
            // TAMBAHAN: Hitung statistik baru
            const sambilanUtamaCount = appData.filter(d => d.profesi === 'Sambilan Utama').length;
            document.getElementById('totalSambilanUtama').textContent = sambilanUtamaCount;
            
            const sambilanTambahanCount = appData.filter(d => d.profesi === 'Sambilan Tambahan').length;
            document.getElementById('totalSambilanTambahan').textContent = sambilanTambahanCount;
            
            const abkCount = appData.filter(d => d.status === 'Anak Buah Kapal').length;
            document.getElementById('totalABK').textContent = abkCount;

            const pData = {};
            appData.forEach(d => pData[d.profesi] = (pData[d.profesi] || 0) + 1);
            window.profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{ 
                    data: Object.values(pData), 
                    backgroundColor: ['#0c2461', '#e58e26', '#27ae60', '#4a69bd', '#f6b93b'] 
                }] 
            };
            window.profesiChart.update();

            const kData = {};
            appData.filter(d => d.status === 'Pemilik Kapal').forEach(d => kData[d.jenisKapal] = (kData[d.jenisKapal] || 0) + 1);
            window.kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{ label: 'Unit', data: Object.values(kData), backgroundColor: '#4a69bd' }]
            };
            window.kapalChart.update();
        }

        function saveData() { localStorage.setItem('nelayanData', JSON.stringify(appData)); }
        function saveSettings() { localStorage.setItem('nelayanSettings', JSON.stringify(appSettings)); }
        function loadData() { const d = localStorage.getItem('nelayanData'); if(d) appData = JSON.parse(d); }
        function loadSettings() { const s = localStorage.getItem('nelayanSettings'); if(s) Object.assign(appSettings, JSON.parse(s)); }

        function exportData(type) {
            if(appData.length === 0) return showNotification('Tidak ada data', 'error');
            const dataToExport = appData.map(d => ({
                ...d, nik: maskData(d.nik), whatsapp: maskData(d.whatsapp)
            }));
            const finalData = dataToExport.map(d => ({ ...d, NIK: `'${d.nik}`, WhatsApp: `'${d.whatsapp}` }));
            if(type === 'xlsx') {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalData), "Data Nelayan");
                XLSX.writeFile(wb, `Nelayan_${appSettings.appSubtitle.slice(0,10)}_${Date.now()}.xlsx`);
                showNotification('Ekspor Excel berhasil.', 'success');
            }
        }

        function sendDataToWhatsapp() {
            const message = `Yth. Administrator Dinas Perikanan Kabupaten Situbondo,\n\nBerikut kami lampirkan data pembaruan Sistem Satu Data Nelayan dari:\n*${appSettings.appSubtitle}*\n\nTanggal Laporan: ${new Date().toLocaleDateString('id-ID')}\nTotal Data: ${appData.length} Records\n\nFile lampiran (reload.js) telah kami sertakan pada pesan ini untuk proses sinkronisasi data.\n\nTerima Kasih.`;
            const url = `https://wa.me/6287865614222?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- PRINT RECAPITULATION (Recap PDF) ---
        function printData() {
            const desaStats = {};
            appData.forEach(d => {
                const desa = d.desa || "Tidak Diketahui";
                if (!desaStats[desa]) {
                    desaStats[desa] = { count: 0, owner: 0, abk: 0, penuhWaktu: 0, sambilanUtama: 0, sambilanTambahan: 0 };
                }
                desaStats[desa].count++;
                if(d.status === 'Pemilik Kapal') desaStats[desa].owner++; else desaStats[desa].abk++;
                if(d.profesi === 'Penuh Waktu') desaStats[desa].penuhWaktu++;
                else if(d.profesi === 'Sambilan Utama') desaStats[desa].sambilanUtama++;
                else if(d.profesi === 'Sambilan Tambahan') desaStats[desa].sambilanTambahan++;
            });

            const tableRows = Object.keys(desaStats).sort().map((desa, index) => [
                index + 1, desa, desaStats[desa].count, desaStats[desa].owner,
                desaStats[desa].abk, desaStats[desa].penuhWaktu, desaStats[desa].sambilanUtama,
                desaStats[desa].sambilanTambahan
            ]);

            const totalNelayan = appData.length;
            const totalPenuhWaktu = appData.filter(d => d.profesi === 'Penuh Waktu').length;
            const totalSambilanUtama = appData.filter(d => d.profesi === 'Sambilan Utama').length;
            const totalSambilanTambahan = appData.filter(d => d.profesi === 'Sambilan Tambahan').length;
            
            // Generate Right Signature QR (Blue)
            document.getElementById('qr-right').innerHTML = "";
            const signText = `DOKUMEN REKAPITULASI RESMI\nDINAS PERIKANAN KAB. SITUBONDO\nTotal Data: ${totalNelayan}\nTimestamp: ${new Date().toISOString()}`;
            new QRCode(document.getElementById("qr-right"), { 
                text: signText, width: 256, height: 256,
                colorDark: "#0984e3", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.M
            });

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

                // --- HEADER ---
                doc.setFillColor(12, 36, 97);
                doc.rect(0, 0, 297, 35, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16); doc.setFont('helvetica', 'bold');
                doc.text('PEMERINTAH KABUPATEN SITUBONDO', 148.5, 12, { align: 'center' });
                doc.setFontSize(18);
                doc.text('DINAS PERIKANAN', 148.5, 20, { align: 'center' });
                doc.setFont('times', 'italic'); doc.setFontSize(11); doc.setTextColor(246, 185, 59);
                doc.text('"Situbondo Naik Kelas - Sistem Satu Data Kelautan & Perikanan"', 148.5, 28, { align: 'center' });

                // --- INFO BAR ---
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
                doc.text(`LAPORAN REKAPITULASI DATA NELAYAN PER DESA`, 148.5, 45, { align: 'center' });
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Per Tanggal: ${new Date().toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric'})}`, 148.5, 50, { align: 'center' });

                // --- TABLE ---
                doc.autoTable({
                    head: [['No', 'Desa / Kelurahan', 'Jml Nelayan', 'Pemilik Kapal', 'ABK', 'Penuh Waktu', 'Sambilan Utama', 'Sambilan Tambahan']],
                    body: tableRows,
                    startY: 55,
                    theme: 'grid',
                    headStyles: { fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' },
                    columnStyles: {
                        0: { halign: 'center' },
                        2: { halign: 'center' }, 3: { halign: 'center' }, 4: { halign: 'center' },
                        5: { halign: 'center' }, 6: { halign: 'center' }, 7: { halign: 'center' }
                    },
                    foot: [['', 'TOTAL KESELURUHAN', totalNelayan, '', '', totalPenuhWaktu, totalSambilanUtama, totalSambilanTambahan]],
                    footStyles: { fillColor: [246, 185, 59], textColor: [0, 0, 0], fontStyle: 'bold' }
                });

                // --- FOOTER SIGNATURE ---
                let finalY = doc.lastAutoTable.finalY + 10;
                if (finalY > 150) { doc.addPage(); finalY = 20; }

                const footerY = finalY + 10;
                const sigCenterX = 230; 
                const leftX = 20;

                // --- VALIDATION STAMP TEXT (REPLACEMENT FOR LEFT QR) ---
                doc.setDrawColor(150);
                doc.setLineWidth(0.5);
                doc.rect(leftX, footerY, 70, 30); // Box
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text("DOKUMEN REKAP INI TERVALIDASI", leftX + 35, footerY + 6, {align: 'center'});
                doc.text("OLEH SISTEM SATU DATA (SIMATA)", leftX + 35, footerY + 10, {align: 'center'});
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text("Dinas Perikanan Kabupaten Situbondo", leftX + 35, footerY + 20, {align: 'center'});
                doc.setTextColor(0, 0, 255);
                doc.text("www.disnakansitubondo.com/simata", leftX + 35, footerY + 25, {align: 'center'});

                // Right Signature
                doc.setFontSize(10); doc.setTextColor(0,0,0); doc.setFont('helvetica', 'normal');
                doc.text(`Situbondo, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`, sigCenterX, footerY, {align: 'center'});
                doc.text('Kepala Bidang Pemberdayaan Nelayan', sigCenterX, footerY + 5, {align: 'center'});
                
                const qrRightCanvas = document.querySelector('#qr-right canvas');
                if(qrRightCanvas) {
                    const imgRight = qrRightCanvas.toDataURL("image/png");
                    doc.addImage(imgRight, 'PNG', sigCenterX - 12.5, footerY + 8, 25, 25);
                }

                doc.setFont('helvetica', 'bold');
                doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', sigCenterX, footerY + 38, {align: 'center'});
                doc.setFont('helvetica', 'normal');
                doc.text('NIP. 19761103 200903 1 002', sigCenterX, footerY + 43, {align: 'center'});

                // ** ADDED: Page Numbering for Recap PDF **
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`Halaman ${i} dari ${totalPages} - Rekapitulasi Resmi`, 148.5, 205, { align: 'center' }); // For landscape
                }

                doc.save(`Laporan_Rekapitulasi_Nelayan_${Date.now()}.pdf`);
                document.getElementById('qr-right').innerHTML = ""; 

            }, 800);
        }

        // --- BACKUP & RESTORE ENCRYPTED ---
        function backupData(filename = null) {
            if(appData.length === 0) return showNotification('Tidak ada data untuk dibackup', 'warning');
            
            // 1. Convert Data to JSON String
            const jsonStr = JSON.stringify(appData);
            
            // 2. Encrypt/Encode Data (Base64) to look like random letters
            // Using btoa(unescape(encodeURIComponent(str))) handles UTF-8 characters properly
            const encryptedData = btoa(unescape(encodeURIComponent(jsonStr)));

            const dateStr = new Date().toLocaleString('id-ID');
            
            // 3. Format dengan menggunakan nama instansi dari pengaturan
            const content = `/* PETUNJUK PENGGUNAAN RELOAD REPO:
    1. Ini adalah file backup otomatis dari Aplikasi.
    2. Jangan ubah kode di dalam tanda petik dua ("...") di bawah.
    3. Upload file ini ke hosting tempat aplikasi berjalan untuk fitur Reload Data.
    
    APP NAME : ${appSettings.appSubtitle}
    TANGGAL  : ${dateStr}
*/


window.SIMATA_BACKUP_ENCRYPTED = "${encryptedData}";`;
            
            const blob = new Blob([content], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename || `reload.js`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Database terenkripsi (reload.js) berhasil diunduh.', 'success');
        }

        function restoreData() {
            const input = document.getElementById('restoreFileInput');
            if(!input.files.length) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let newData = [];
                    let isEncrypted = false;

                    // 1. Check for Encrypted Format (Priority)
                    if (content.includes('window.SIMATA_BACKUP_ENCRYPTED')) {
                        const regex = /window\.SIMATA_BACKUP_ENCRYPTED\s*=\s*"([^"]+)"/;
                        const match = content.match(regex);
                        if (match && match[1]) {
                            const encrypted = match[1];
                            // Decrypt/Decode
                            const decrypted = decodeURIComponent(escape(window.atob(encrypted)));
                            newData = JSON.parse(decrypted);
                            isEncrypted = true;
                        }
                    } 
                    // 2. Fallback for Old Format (Backward Compatibility)
                    else {
                        let jsonStr = content;
                        if(content.includes('=')) {
                            jsonStr = content.substring(content.indexOf('=') + 1);
                            jsonStr = jsonStr.split(';')[0]; 
                        }
                        newData = JSON.parse(jsonStr);
                    }
                    
                    if(!Array.isArray(newData)) throw new Error("Format data tidak valid");

                    let addedCount = 0;
                    newData.forEach(newItem => {
                        const existingIndex = appData.findIndex(d => d.nik === newItem.nik);
                        if(existingIndex <= -1) {
                            appData.push(newItem);
                            addedCount++;
                        }
                    });

                    saveData();
                    renderDataTable();
                    updateDashboard();
                    // Update peta
                    if (map) {
                        renderMapMarkers();
                        updateMapStatistics();
                    }
                    checkGlobalDuplicates();
                    
                    const msgType = isEncrypted ? 'Database Terenkripsi' : 'Database Lama';
                    showNotification(`Restore Sukses (${msgType}): ${addedCount} data baru ditambahkan.`, 'success');
                    input.value = ''; 
                    document.getElementById('restoreDataBtn').disabled = true;
                    
                } catch(err) {
                    console.error(err);
                    showNotification('Gagal memproses file. Pastikan file adalah reload.js yang valid.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function handleReloadRepo() {
            const btn = document.getElementById('btn-reload-repo');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            
            // Logic: Check if window.SIMATA_BACKUP_ENCRYPTED exists (loaded from <script src="reload.js">)
            if (typeof window.SIMATA_BACKUP_ENCRYPTED !== 'undefined' && window.SIMATA_BACKUP_ENCRYPTED) {
                try {
                    const encrypted = window.SIMATA_BACKUP_ENCRYPTED;
                    const decrypted = decodeURIComponent(escape(window.atob(encrypted)));
                    const newData = JSON.parse(decrypted);

                    if(Array.isArray(newData)) {
                        let count = 0;
                        newData.forEach(newItem => {
                            if (!appData.some(d => d.nik === newItem.nik)) {
                                appData.push(newItem);
                                count++;
                            }
                        });
                        saveData();
                        // Update peta
                        if (map) {
                            renderMapMarkers();
                            updateMapStatistics();
                        }
                        showNotification(`Sinkronisasi Berhasil: ${count} data baru dimuat dari Server.`, 'success');
                        setTimeout(() => location.reload(), 1500);
                        return;
                    }
                } catch (e) {
                    console.error("Decrypt error", e);
                }
            }

            // Fallback default reload behavior
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                if (typeof window.SIMATA_BACKUP_ENCRYPTED === 'undefined') {
                    showNotification('File reload.js belum terdeteksi di server hosting.', 'warning');
                } else {
                    window.location.reload(); 
                }
            }, 1000);
        }

        // --- UTILITIES ---
        function showNotification(message, type = 'info') {
            const toastEl = document.querySelector('.notification-toast');
            const toastBody = document.getElementById('toastMessage');
            const toastTitle = document.getElementById('toastTitle');
            const bsToast = new bootstrap.Toast(toastEl);
            
            toastBody.textContent = message;
            
            if(type === 'success') {
                toastEl.classList.remove('bg-danger', 'bg-warning', 'text-white');
                toastEl.classList.add('bg-success', 'text-white');
                toastTitle.className = 'me-auto text-white';
                toastTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>Berhasil';
            } else if(type === 'error') {
                toastEl.classList.remove('bg-success', 'bg-warning', 'text-white');
                toastEl.classList.add('bg-danger', 'text-white');
                toastTitle.className = 'me-auto text-white';
                toastTitle.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Gagal';
            } else if(type === 'warning') {
                toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
                toastEl.classList.add('bg-warning', 'text-dark');
                toastTitle.className = 'me-auto text-dark';
                toastTitle.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Peringatan';
            } else {
                toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white');
                toastTitle.className = 'me-auto';
                toastTitle.textContent = 'Notifikasi';
            }
            
            bsToast.show();
        }

    </script>
</body>
</html>
