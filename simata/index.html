<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SIMATA - SISTEM PEMETAAN NELAYAN</title>
    
    <!-- LOAD SEMUA CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- LOAD SEMUA JAVASCRIPT LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- LOAD FILE JAVASCRIPT YANG DIPISAHKAN -->
    <script src="idcard.js"></script>
    <script src="reload.js" onerror="console.log('File reload.js belum tersedia di server, menggunakan database lokal.')"></script>
    <script src="convert.js"></script>
     
</head>
<body>

    <div id="qr-code-generator">
        <div id="qr-right"></div> 
    </div>
    
    <!-- Container untuk tabel PDF (hidden) -->
    <div class="pdf-table-container" id="pdfTableContainer"></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMATA" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-eye fa-4x\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMATA</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode keamanan untuk mengakses sistem.</p>
                        <p class="small text-primary fw-bold mb-2" id="currentDateDisplay"></p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" placeholder="Masukkan kode keamanan" required>
                            <button type="button" class="input-group-text bg-light border-0 password-toggle-btn" id="passwordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="passwordHint">Kode Keamanan Berubah Setiap Hari</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notifikasi Login Berhasil -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="w-100 d-flex flex-column align-items-center justify-content-center">
                        <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                        <h4 class="fw-bold mb-0 text-center">Akses Diotorisasi</h4>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon d-flex justify-content-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMATA</h5>
                    
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                    
                    <p class="text-muted small mt-4 text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Sistem ini menggunakan teknologi keamanan dinamis untuk melindungi data sensitif
                    </p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-warning" id="duplicateWarning">
        <div class="d-flex align-items-start">
            <div class="me-3 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
            <div>
                <h6 class="fw-bold text-danger mb-1">PERHATIAN: Data Ganda!</h6>
                <p class="small text-muted mb-2">Sistem mendeteksi adanya NIK ganda yang belum diperbaiki.</p>
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('v-pills-data-tab').click(); setTimeout(() => document.getElementById('btnCekGanda').click(), 200);">Periksa Sekarang</button>
                <button class="btn btn-sm btn-link text-muted text-decoration-none ms-2" onclick="document.getElementById('duplicateWarning').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="app-content-unauthenticated" id="appContent" style="display:none;">
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        
        <div class="app-container animate-fadeIn">
            <div class="app-header">
                <div class="app-logo-icon">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku2.png" alt="Logo SIMATA" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle" id="dynamicSubtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="app-origin" id="appOrigin">App System Bidang Pemberdayaan Nelayan</div>
                <div class="position-absolute top-0 end-0 p-3 d-none d-md-block">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill"><i class="fas fa-circle text-success me-2 small"></i>Online v5.5</span>
                </div>
            </div>
            
            <div class="row g-0 flex-grow-1">
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-3 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important; padding-left: 15px;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-verify-tab" data-bs-toggle="pill" data-bs-target="#v-pills-verify" type="button"><i class="fas fa-check-circle"></i> Verifikasi KIN</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog"></i> Pengaturan</button>
                        <!-- Tombol Reload Data dengan spinner -->
                        <button class="nav-link" id="btn-reload-repo" type="button">
                            <i class="fas fa-sync"></i> Reload Data
                            <span class="spinner-border spinner-border-sm reload-spinner" id="reloadSpinner"></span>
                        </button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-3 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-3 dashboard-row">
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100 text-white" style="background: var(--primary-gradient);">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="small fw-bold text-uppercase opacity-75">Total</span>
                                                    <i class="fas fa-users opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold mb-0" id="totalPenerima">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Penuh Waktu</span>
                                                    <i class="fas fa-user-tie text-primary opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPenuhWaktu">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Kapal</span>
                                                    <i class="fas fa-ship text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalPemilik">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- TAMBAHAN FITUR RINGKASAN EKSEKUTIF -->
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Sambilan Utama</span>
                                                    <i class="fas fa-user-clock text-warning opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanUtama">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">Nelayan Sambilan Tambahan</span>
                                                    <i class="fas fa-user-clock text-success opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalSambilanTambahan">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-lg-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small fw-bold text-uppercase">ABK</span>
                                                    <i class="fas fa-users text-info opacity-50 fa-2x"></i>
                                                </div>
                                                <h2 class="fw-bold text-dark mb-0" id="totalABK">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4 g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-input">
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <div class="alert alert-info small mb-4 border-0 bg-light-info text-primary"><i class="fas fa-info-circle me-2"></i>NIK digunakan sebagai validasi utama. Semua kolom WAJIB DIISI kecuali Keterangan, Usaha Sampingan, dan Link Drive.</div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomori Induk Kependudukan) <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="whatsapp" class="form-label">Nomor Handphone Aktif <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">+62</span>
                                                        <input type="tel" class="form-control" id="whatsapp" required placeholder="8123xxxx">
                                                        <button class="btn btn-outline-secondary" type="button" id="btnNoWA" title="Tidak Punya WA">Tidak Ada</button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profesi" class="form-label">Kategori Profesi <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="profesi" required>
                                                        <option value="">Pilih Profesi...</option>
                                                        <option value="Nelayan Penuh Waktu">Nelayan Penuh Waktu</option>
                                                        <option value="Nelayan Sambilan Utama">Nelayan Sambilan Utama</option>
                                                        <option value="Nelayan Sambilan Tambahan">Nelayan Sambilan Tambahan</option>
                                                    </select>
                                                    <div id="profesiHelp" class="form-text small text-muted mt-1"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label for="statusNelayan" class="form-label">Status Pekerjaan <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="statusNelayan" required>
                                                        <option value="">Pilih Status...</option>
                                                        <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                        <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="tahunLahir" class="form-label">Tahun Kelahiran <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="tahunLahir" placeholder="YYYY" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="kecamatan" class="form-label fw-bold text-primary">Kecamatan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="kecamatan" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="usia" class="form-label">Usia (Otomatis)</label>
                                                    <input type="text" class="form-control bg-light" id="usia" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="desa" class="form-label fw-bold text-primary">Desa / Kelurahan <span class="text-danger">*</span></label>
                                                    <select class="form-select border-primary" id="desa" required disabled>
                                                        <option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- ALAT PENANGKAPAN IKAN (API) -->
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label fw-bold">Alat Penangkapan Ikan (API) <span class="text-danger">*</span></label>
                                                    <div class="card p-3 bg-light border">
                                                        <select class="form-select" id="alatTangkap" required>
                                                            <option value="">Pilih Alat Penangkapan Ikan...</option>
                                                        </select>
                                                        <div id="apiInfo" class="api-info-box mt-2" style="display:none;"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="ownerFields" style="display:none;" class="bg-light p-4 rounded-3 mb-3 border">
                                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3"><i class="fas fa-ship me-2"></i>Detail Aset Kapal (Wajib bagi Pemilik Kapal)</h6>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Nama Kapal</label>
                                                        <input type="text" class="form-control" id="namaKapal">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Jenis Kapal</label>
                                                        <select class="form-select" id="jenisKapal">
                                                            <option value="">Pilih Jenis...</option>
                                                        </select>
                                                        <div id="kapalInfo" class="kapal-info-box mt-2" style="display:none;"></div>
                                                        <div id="apiMappingInfo" class="api-mapping-info mt-2" style="display:none;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Jenis Ikan Tangkapan Utama <span class="text-danger">*</span>
                                                        <button type="button" class="fish-info-btn" onclick="showFishInfoModal()" title="Lihat Referensi Jenis Ikan">
                                                            <i class="fas fa-info"></i>
                                                        </button>
                                                    </label>
                                                    <div class="card p-3 bg-light border">
                                                        <div id="fishCheckboxContainer" style="max-height: 200px; overflow-y: auto;">
                                                            <!-- Daftar ikan akan dimuat secara dinamis berdasarkan alat tangkap -->
                                                        </div>
                                                        <input type="text" class="form-control form-control-sm mt-2" id="jenisIkanLainnya" placeholder="Sebutkan jenis lainnya..." style="display:none;">
                                                    </div>
                                                    <small class="text-muted fst-italic">*Pilih minimal satu</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="usahaSampingan" class="form-label">Usaha Sampingan (Opsional)</label>
                                                    <input type="text" class="form-control" id="usahaSampingan" placeholder="Contoh: Ternak, Warung">
                                                </div>
                                            </div>
                                            
                                            <!-- PERIODE TANGGAL VALIDASI OTOMATIS DAN TERKUNCI -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="tanggalValidasi" class="form-label">Tanggal Validasi <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="date" class="form-control" id="tanggalValidasi" required readonly style="background-color: #f8f9fa;">
                                                        <span class="input-group-text bg-light">
                                                            <i class="fas fa-calendar-check text-primary" title="Tanggal validasi terkunci secara otomatis"></i>
                                                        </span>
                                                    </div>
                                                    <small class="text-muted mt-1">Tanggal validasi terkunci otomatis sesuai periode saat ini</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="validator" class="form-label">Petugas Validator <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="validator" required>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="driveLink" class="form-label">Link Dokumen (Google Drive) <span class="text-muted">(Opsional)</span></label>
                                                    <input type="url" class="form-control" id="driveLink">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="kodeValidasi" class="form-label fw-bold text-danger">Kode Validasi (Wajib Generate) <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control bg-light" id="kodeValidasi" readonly required placeholder="Klik Generate...">
                                                        <button type="button" class="btn btn-warning fw-bold" id="generateKodeBtn">GENERATE ID</button>
                                                    </div>
                                                    <small class="text-muted" style="font-size: 0.75rem;">*Kode validasi bersifat permanen dan tidak dapat diubah.</small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <label for="keterangan" class="form-label">Keterangan Tambahan <span class="text-muted">(Opsional)</span></label>
                                                <textarea class="form-control" id="keterangan" rows="2"></textarea>
                                            </div>
                                            
                                            <div class="d-flex justify-content-end border-top pt-3">
                                                <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                                <button type="submit" class="btn btn-primary px-4 fw-bold shadow"><i class="fas fa-save me-2"></i>SIMPAN DATA</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="v-pills-data">
                                <h3 class="section-title">Database Nelayan</h3>
                                
                                <!-- FITUR FILTER & VALIDASI DATA YANG DIPINDAHKAN -->
                                <div class="card mb-4 border-0 shadow-sm filter-section">
                                    <div class="card-header bg-white py-3 border-bottom">
                                        <h6 class="mb-0 fw-bold"><i class="fas fa-filter me-2 text-primary"></i>Filter & Validasi Data</h6>
                                    </div>
                                    <div class="card-body bg-light rounded">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Desa</label>
                                                <select class="form-select form-select-sm" id="filterDesa">
                                                    <option value="">Semua Desa</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Profesi</label>
                                                <select class="form-select form-select-sm" id="filterProfesi">
                                                    <option value="">Semua</option>
                                                    <option value="Nelayan Penuh Waktu">Nelayan Penuh Waktu</option>
                                                    <option value="Nelayan Sambilan Utama">Nelayan Sambilan Utama</option>
                                                    <option value="Nelayan Sambilan Tambahan">Nelayan Sambilan Tambahan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Status Kepemilikan</label>
                                                <select class="form-select form-select-sm" id="filterStatus">
                                                    <option value="">Semua</option>
                                                    <option value="Anak Buah Kapal">Anak Buah Kapal</option>
                                                    <option value="Pemilik Kapal">Pemilik Kapal</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Jenis Kapal</label>
                                                <select class="form-select form-select-sm" id="filterJenisKapal">
                                                    <option value="">Semua</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Alat Tangkap (API)</label>
                                                <select class="form-select form-select-sm" id="filterAlatTangkap">
                                                    <option value="">Semua</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Usaha Sampingan</label>
                                                <select class="form-select form-select-sm" id="filterUsaha">
                                                    <option value="">Semua</option>
                                                    <option value="Ada">Ada Usaha Sampingan</option>
                                                    <option value="Tidak">Tidak Ada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100 btn-sm" id="applyFilterBtn"><i class="fas fa-search me-2"></i> Terapkan Filter</button>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-outline-secondary w-100 btn-sm" id="resetFilterBtn"><i class="fas fa-redo me-2"></i> Reset Filter</button>
                                            </div>
                                            <div class="col-md-12 mt-2">
                                                <div class="d-flex justify-content-end gap-2">
                                                    <button class="btn btn-download-filtered-pdf btn-sm shadow-sm" id="btnUnduhFilteredPdf"><i class="fas fa-file-pdf me-2"></i> Unduh PDF (Filter)</button>
                                                    <button class="btn btn-download-table-pdf btn-sm shadow-sm" id="btnUnduhTablePdf"><i class="fas fa-table me-2"></i> Unduh PDF Tabel Data</button>
                                                    <button class="btn btn-danger btn-sm shadow-sm" id="btnCekGanda"><i class="fas fa-exclamation-triangle me-2"></i> Cek Data Ganda</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                                 
                                <!-- TABEL DATA NELAYAN -->
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3">
                                        <div class="row align-items-center g-2">
                                            <div class="col-12 col-md-4">
                                                <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Data Terdaftar</h6>
                                            </div>
                                            <div class="col-12 col-md-8 d-flex justify-content-md-end gap-2 flex-wrap">
                                                <div class="input-group flex-grow-1 flex-md-grow-0" style="max-width: 100%; width: 300px;">
                                                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                                    <input type="text" class="form-control border-start-0" id="searchData" placeholder="Cari cerdas (Nama, NIK, Kapal)...">
                                                </div>
                                                <button class="btn btn-danger btn-sm d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-1"></i> Hapus Terpilih</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover data-table mb-0" id="dataTable">
                                                <thead>
                                                    <tr>
                                                        <th width="40" class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                        <th width="50" class="text-center">No</th>
                                                        <th class="col-id-cell">Identitas Nelayan</th>
                                                        <th class="col-contact-cell">Kontak</th>
                                                        <th class="col-status-cell">Profesi & Status</th>
                                                        <th class="col-status-cell">Aset Kapal</th>
                                                        <th style="white-space: nowrap;">API</th>
                                                        <th class="col-action sticky-col-right text-center">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dataTableBody">
                                                    <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data database...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light flex-wrap gap-2">
                                            <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                            <div class="pagination-container">
                                                <span class="pagination-info" id="paginationInfo">Halaman 1</span>
                                                <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                            </div>
                                        </div>
                                        <div class="p-2 small text-muted fst-italic text-end border-top">
                                            <span id="sensorStatusText" class="badge bg-secondary me-2">Sensor: ON</span>
                                            <i class="fas fa-info-circle text-danger me-1"></i> Baris <span class="badge bg-danger">Merah</span> = duplikasi NIK.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB FILTER & VALIDASI YANG DIBIARKAN KOSONG -->
                            <div class="tab-pane fade" id="v-pills-filter">
                                 <h3 class="section-title">Filter & Validasi Data</h3>
                                 <div class="alert alert-info mt-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Fitur Filter & Validasi Data telah dipindahkan ke menu <u>Database Nelayan</u>.</strong>
                                    <p class="mb-0 mt-2">Silakan gunakan menu Database Nelayan untuk mengakses semua fitur filter dan validasi data yang telah disempurnakan.</p>
                                 </div>
                                 <div class="text-center mt-4">
                                    <button class="btn btn-primary" onclick="document.getElementById('v-pills-data-tab').click()">
                                        <i class="fas fa-database me-2"></i>Buka Menu Database Nelayan
                                    </button>
                                 </div>
                            </div>

                            <!-- TAB VERIFIKASI KIN BARU - DIREVISI DAN DISEMPURNAKAN -->
                            <div class="tab-pane fade" id="v-pills-verify">
                                <h3 class="section-title">Verifikasi KIN (Kode Identifikasi Nelayan)</h3>
                                
                                <div class="row mb-4">
                                    <div class="col-md-10 mx-auto">
                                        <div class="card verify-card shadow-sm">
                                            <div class="verify-header">
                                                <div class="verify-icon-container">
                                                    <i class="fas fa-id-card"></i>
                                                </div>
                                                <h4 class="fw-bold mb-2">Verifikasi Data Nelayan</h4>
                                                <p class="mb-0 opacity-75">Masukkan Kode Validasi (KIN) atau NIK untuk memverifikasi keabsahan data nelayan</p>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="row mb-4">
                                                    <div class="col-md-12">
                                                        <div class="input-group verify-input-group">
                                                            <span class="input-group-text bg-primary text-white border-0"><i class="fas fa-search"></i></span>
                                                            <input type="text" class="form-control border-0 py-3" id="verifyInput" placeholder="Masukkan Kode Validasi (contoh: VLD-ABC123) atau NIK 16 digit" autocomplete="off">
                                                            <button class="btn btn-primary px-4 fw-bold border-0" type="button" id="verifyBtn">Verifikasi</button>
                                                        </div>
                                                        <div class="form-text mt-3 text-center">
                                                            <i class="fas fa-info-circle text-primary me-1"></i>
                                                            Kode Validasi (KIN) dapat ditemukan di ID Card atau kolom "Kode Validasi" pada data nelayan
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="verify-breadcrumb">
                                                            <div class="verify-breadcrumb-item active" onclick="setVerifyExample('kin')">
                                                                <i class="fas fa-id-card me-2"></i>Cek dengan KIN
                                                            </div>
                                                            <div class="verify-breadcrumb-item" onclick="setVerifyExample('nik')">
                                                                <i class="fas fa-address-card me-2"></i>Cek dengan NIK
                                                            </div>
                                                            <div class="verify-breadcrumb-item" onclick="setVerifyExample('all')">
                                                                <i class="fas fa-list me-2"></i>Tampilkan Semua KIN
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- HASIL VERIFIKASI -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="card shadow-sm border-0 mb-4" id="verifyResultCard" style="display: none;">
                                            <div class="card-body p-0">
                                                <div class="verify-result-header" id="verifyResultHeader">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3" id="verifyResultIcon"></div>
                                                        <div>
                                                            <h5 class="fw-bold mb-1" id="verifyResultTitle"></h5>
                                                            <p class="mb-0 opacity-75" id="verifyResultSubtitle"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="verify-result-content" id="verifyResultBody">
                                                    <div class="row" id="verifyResultContent"></div>
                                                </div>
                                                
                                                <div class="verify-actions" id="verifyResultActions">
                                                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                                                        <button class="btn btn-outline-secondary px-4" onclick="resetVerifyForm()">
                                                            <i class="fas fa-redo me-2"></i>Cari Lagi
                                                        </button>
                                                        <button class="btn btn-primary px-4" id="verifyDetailBtn" style="display: none;">
                                                            <i class="fas fa-eye me-2"></i>Lihat Detail Lengkap
                                                        </button>
                                                        <button class="btn btn-success px-4" id="verifyIdCardBtn" style="display: none;">
                                                            <i class="fas fa-id-card me-2"></i>Cetak ID Card
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- DAFTAR SEMUA KIN -->
                                        <div class="card shadow-sm border-0" id="allKinCard" style="display: none;">
                                            <div class="verify-result-header">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-list-check me-2"></i> 
                                                    <div>
                                                        <h5 class="fw-bold mb-0">Daftar Semua Kode Validasi (KIN) Terdaftar</h5>
                                                        <p class="mb-0 opacity-75">Total: <span class="badge bg-warning ms-1" id="totalKinCount">0</span> KIN terdaftar</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th width="50">No</th>
                                                                <th>Kode Validasi (KIN)</th>
                                                                <th>Nama Nelayan</th>
                                                                <th>NIK</th>
                                                                <th>Desa/Kecamatan</th>
                                                                <th>Status Validasi</th>
                                                                <th>Aksi</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="allKinTableBody">
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4 text-muted">
                                                                    <i class="fas fa-spinner fa-spin me-2"></i>Memuat data KIN...
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-print">
                                <h3 class="section-title">Cetak Laporan</h3>
                                <div class="card p-5 text-center shadow-sm border-0">
                                    <div class="mb-3"><i class="fas fa-file-pdf fa-4x text-danger opacity-50"></i></div>
                                    <h5>Cetak Laporan Data Terfilter</h5>
                                    <p class="text-muted">Fitur ini akan mencetak data rekapitulasi lengkap sesuai data yang tersedia dalam format PDF Resmi.</p>
                                    <button class="btn btn-danger px-5 mt-3 shadow" id="printPdfBtn"><i class="fas fa-download me-2"></i> Download PDF Laporan Resmi</button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-export">
                                <h3 class="section-title">Ekspor & Pelaporan Data</h3>
                                <div class="row g-4">
                                    <div class="col-md-12">
                                        <div class="card p-4 border-success bg-white shadow-sm" style="border-left: 5px solid #25D366;">
                                            <div class="d-flex align-items-start flex-column flex-md-row">
                                                <div class="me-md-4 mb-3 mb-md-0 text-success"><i class="fab fa-whatsapp fa-3x"></i></div>
                                                <div>
                                                    <h5 class="fw-bold text-dark mb-2">Lapor Cepat via WhatsApp Center</h5>
                                                    <p class="mb-2 text-muted" style="line-height: 1.6;">
                                                        Silakan unduh <strong>File Sinkronisasi (reload.js)</strong> melalui tombol di bawah.
                                                        Selanjutnya, klik tombol <strong>"Kirim Laporan"</strong> untuk terhubung ke WhatsApp Administrator Dinas Perikanan Kabupaten Situbondo.
                                                        <br><span class="text-danger small">*Harap lampirkan file <b>reload.js</b> yang telah diunduh pada chat WhatsApp tersebut sebagai bukti sinkronisasi data.</span>
                                                    </p>
                                                    <button class="btn btn-success mt-2 px-4" id="sendWaBtn"><i class="fas fa-paper-plane me-2"></i> Kirim Laporan ke Pusat</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6"><button class="btn btn-outline-success w-100 py-4 h-100 shadow-sm" id="exportExcelBtn"><i class="fas fa-file-excel fa-2x mb-2 d-block"></i>Download Excel</button></div>
                                    <div class="col-md-6"><button class="btn btn-outline-warning w-100 py-4 h-100 shadow-sm" id="exportReloadJsBtn"><i class="fas fa-file-code fa-2x mb-2 d-block"></i>Download File Sinkronisasi Data</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-backup">
                                <h3 class="section-title">Backup & Restore</h3>
                                <div class="alert alert-warning small"><i class="fas fa-exclamation-triangle me-2"></i> <strong>Sistem Smart Restore:</strong> Data yang direstore akan <strong>DIGABUNGKAN</strong> dengan data yang ada (Merge), tidak menghapus data lama. Duplikasi NIK akan ditandai Merah.</div>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-primary shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-download-alt fa-3x text-primary"></i></div>
                                            <h5>Download Backup Encrypted</h5>
                                            <p class="small text-muted mb-4">Unduh file backup terenkripsi yang aman.</p>
                                            <button class="btn btn-primary w-100" id="backupDataBtn">Unduh Database Lengkap</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card p-4 h-100 text-center border-warning shadow-sm">
                                            <div class="mb-3"><i class="fas fa-cloud-upload-alt fa-3x text-warning"></i></div>
                                            <h5>Restore Data Encrypted</h5>
                                            <p class="small text-muted mb-0">Upload file reload.js untuk mengembalikan data.</p>
                                            <input type="file" class="form-control my-3" id="restoreFileInput" accept=".js,.json,.txt">
                                            <button class="btn btn-warning w-100 text-white" id="restoreDataBtn" disabled>Proses Restore & Merge</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="v-pills-settings">
                                <h3 class="section-title">Pengaturan Sistem</h3>
                                <div class="card p-4 border-0 shadow-sm mb-4">
                                    <h6 class="fw-bold mb-3 border-bottom pb-2">Identitas Aplikasi</h6>
                                    <form id="settingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Aplikasi (Tetap)</label>
                                                <input type="text" class="form-control" id="appName" value="SISTEM PEMETAAN DATA NELAYAN" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                                <small class="text-muted">Nama aplikasi tetap tidak dapat diubah</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nama Instansi (Dapat Disesuaikan)</label>
                                                <input type="text" class="form-control" id="appSubtitle" value="DINAS PERIKANAN SITUBONDO" placeholder="Masukkan nama instansi/desa">
                                                <small class="text-muted">Nama instansi akan muncul di header aplikasi</small>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Tampilkan Baris Per Halaman</label>
                                                <select class="form-select" id="itemsPerPageSelect">
                                                    <option value="10">10 Baris (Default)</option>
                                                    <option value="25">25 Baris</option>
                                                    <option value="50">50 Baris</option>
                                                    <option value="75">75 Baris</option>
                                                    <option value="100">100 Baris</option>
                                                </select>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                    </form>
                                </div>
                                
                                <!-- Kode Keamanan Sensor Data -->
                                <div class="card p-4 border-0 shadow-sm mb-4">
                                    <h6 class="fw-bold mb-3 border-bottom pb-2">Kode Keamanan Sensor Data</h6>
                                    <form id="sensorCodeForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Kode Keamanan Sensor Saat Ini</label>
                                                <input type="password" class="form-control" id="currentSensorCode" placeholder="Masukkan kode saat ini" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Kode Keamanan Sensor Baru</label>
                                                <input type="password" class="form-control" id="newSensorCode" placeholder="Kode baru (min. 6 digit)" required minlength="6">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Konfirmasi Kode Baru</label>
                                                <input type="password" class="form-control" id="confirmSensorCode" placeholder="Ulangi kode baru" required minlength="6">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Perbarui Kode Keamanan Sensor</button>
                                        <small class="text-muted d-block mt-2">*Kode ini digunakan untuk menonaktifkan sensor dan reset data</small>
                                    </form>
                                </div>
                                
                                <div class="card p-4 border-0 shadow-sm border-left border-4 border-danger">
                                    <h6 class="fw-bold mb-3 text-danger"><i class="fas fa-user-shield me-2"></i>Privasi & Keamanan Data</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="d-block">Sensor Data Pribadi (NIK & No. HP)</strong>
                                            <small class="text-muted">Menyensor 4 digit terakhir dengan tanda bintang (*) pada tabel dan hasil unduhan.</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="privacyToggle" style="width: 3em; height: 1.5em; cursor: pointer;" checked>
                                        </div>
                                    </div>
                                    <div id="privacyStatus" class="mt-2 small text-success fw-bold">Status: Sensor Aktif (Aman)</div>
                                </div>
                            </div>

                        </div>
                        
                        <footer class="main-footer">
                            <div class="container">
                                <h5 class="footer-brand">SISTEM PEMETAAN DATA NELAYAN</h5>
                                <div class="footer-text">
                                    &copy; 2025 Bidang Pemberdayaan Nelayan <span class="footer-divider">|</span> Dinas Perikanan Kabupaten Situbondo
                                </div>
                                <div class="footer-links">
                                    <a href="#" style="pointer-events: none;">
                                        <i class="fas fa-phone-alt me-1"></i> Contact Center: 0878-6561-4222
                                    </a>
                                    <span class="footer-divider">|</span>
                                    <a href="mailto:info@dinasperikanansitubondo.com">
                                        <i class="fas fa-envelope me-1"></i> info@dinasperikanansitubondo.com
                                    </a>
                                </div>
                            </div>
                        </footer>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header modal-header-custom">
                        <h5 class="modal-title fw-bold"><i class="fas fa-id-card me-2"></i>DETAIL LENGKAP NELAYAN</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4 bg-light">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <h6 class="text-primary fw-bold mb-3">IDENTITAS PRIBADI</h6>
                                        <div class="detail-label">Nama Lengkap</div>
                                        <div class="detail-value" id="d_nama">-</div>
                                        <div class="detail-label">NIK (Nomori Induk Kependudukan)</div>
                                        <div class="detail-value font-monospace" id="d_nik">  </div>
                                        <div class="detail-label">Usia / Tahun Lahir</div>
                                        <div class="detail-value" id="d_usia">-</div>
                                        <div class="detail-label">Kontak (WhatsApp/Telp)</div>
                                        <div class="detail-value font-monospace" id="d_wa">-</div>
                                        <div class="detail-label">Domisili</div>
                                        <div class="detail-value" id="d_domisili">-</div>
                                    </div>
                                    <div class="col-md-6 ps-md-4 mt-3 mt-md-0">
                                        <h6 class="text-primary fw-bold mb-3">PROFESI & KEPEMILIKAN</h6>
                                        <div class="detail-label">Profesi</div>
                                        <div class="detail-value"><span id="d_profesi" class="badge bg-primary"></span></div>
                                        <div class="detail-label">Status</div>
                                        <div class="detail-value" id="d_status">-</div>
                                        <div class="detail-label">Alat Penangkapan Ikan (API)</div>
                                        <div class="detail-value" id="d_alatTangkap">-</div>
                                        <div class="detail-label">Usaha Sampingan</div>
                                        <div class="detail-value" id="d_usaha">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3" id="d_kapal_card" style="display:none;">
                            <div class="card-body bg-white border-left border-4 border-info">
                                <h6 class="text-info fw-bold mb-3"><i class="fas fa-ship me-2"></i>DATA KAPAL DIMILIKI</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="detail-label">Nama Kapal</div>
                                        <div class="fw-bold" id="d_namaKapal">.</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Jenis Kapal</div>
                                        <div class="fw-bold"><span id="d_jenisKapal"> -</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body bg-white border-left border-4 border-success">
                                <h6 class="text-success fw-bold mb-3"><i class="fas fa-fish me-2"></i>JENIS IKAN TANGKAPAN</h6>
                                <div id="d_ikan"></div>
                            </div>
                        </div>

                        <div class="text-end text-muted small fst-italic">
                            Terakhir divalidasi: <span id="d_tgl_valid">-</span> oleh <span id="d_validator">-</span>
                        </div>
                    </div>
                    <div class="modal-footer bg-white">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" class="btn btn-danger" id="btnDownloadDetailPdf"><i class="fas fa-file-pdf me-2"></i>UNDUH DOKUMEN (PDF)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Info Jenis Ikan -->
        <div class="modal fade" id="fishInfoModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title fw-bold"><i class="fas fa-fish me-2"></i>Referensi Jenis Ikan Tangkapan</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Berikut adalah referensi visual jenis ikan tangkapan yang umum ditemukan di perairan Situbondo.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <h6 class="fw-bold text-primary">Gambar Referensi 1</h6>
                                <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simata/info%20jenis%20ikan%20tangkapan%201.jpg" 
                                     alt="Referensi Jenis Ikan 1" class="fish-modal-img img-fluid">
                                <p class="small text-muted mt-2">Ilustrasi berbagai jenis ikan tangkapan yang umum ditemui.</p>
                            </div>
                            <div class="col-md-12 mb-4">
                                <h6 class="fw-bold text-primary">Gambar Referensi 2</h6>
                                <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simata/info%20jenis%20ikan%20tangkapan%202.jpg" 
                                     alt="Referensi Jenis Ikan 2" class="fish-modal-img img-fluid">
                                <p class="small text-muted mt-2">Klasifikasi dan ciri-ciri ikan tangkapan utama.</p>
                            </div>
                            <div class="col-md-12">
                                <h6 class="fw-bold text-primary">Gambar Referensi 3</h6>
                                <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/simata/info%20jenis%20ikan%20tangkapan%203.jpg" 
                                     alt="Referensi Jenis Ikan 3" class="fish-modal-img img-fluid">
                                <p class="small text-muted mt-2">Panduan identifikasi ikan tangkapan berdasarkan alat tangkap.</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-4">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>Tips:</strong> Gunakan referensi ini untuk memastikan ketepatan pemilihan jenis ikan tangkapan utama dalam pendataan nelayan.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <a href="#" class="fab-item" id="fabInput" title="Input Data"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" title="Filter"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabVerify" title="Verifikasi"><i class="fas fa-check-circle"></i></a>
            <a href="#" class="fab-item" id="fabExport" title="Ekspor"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" title="Backup"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" title="Pengaturan"><i class="fas fa-cog"></i></a>
            <a href="#" class="fab-item" id="fabReload" title="Reload Repo"><i class="fas fa-sync"></i></a>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast notification-toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <!-- Loading untuk ID Card -->
    <div class="idcard-loading" id="idcardLoading">
        <div class="idcard-loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h6>Membuat ID Card...</h6>
            <p class="small text-muted">Harap tunggu sebentar</p>
        </div>
    </div>

    <!-- KODE UTAMA APLIKASI TANPA FITUR PETA - VERSI DIPERBAIKI -->
    <script>
        // =====================================================
        // KODE UTAMA APLIKASI SIMATA - VERSI 5.5 DIPERBAIKI
        // =====================================================
        
        // Data ikan yang diperbarui dan dilengkapi - DITAMBAHKAN IKAN TOGEK
        const FISH_CATEGORIES = {
            "Demersal": [
                {name: "Ikan Mangla (Pomadasys spp.)", latin: "Pomadasys spp.", desc: "Ikan demersal yang hidup di dasar berpasir, sering ditemukan di perairan tropis. Dagingnya putih dan gurih."},
                {name: "Ikan Sebelah (Pleuronectiformes)", latin: "Pleuronectiformes", desc: "Ikan pipih dengan kedua mata di satu sisi tubuh. Hidup di dasar laut berpasir atau berlumpur."},
                {name: "Ikan Lidah (Cynoglossus spp.)", latin: "Cynoglossus spp.", desc: "Bentuk pipih memanjang seperti lidah, hidup di dasar berlumpur. Populer untuk konsumsi lokal."},
                {name: "Ikan Petek (Leiognathus spp.)", latin: "Leiognathus spp.", desc: "Ikan kecil berwarna keperakan, hidup di dasar perairan dangkal. Sering digunakan sebagai umpan."},
                {name: "Ikan Duri (Arius spp.)", latin: "Arius spp.", desc: "Memiliki duri tajam di siripnya. Hidup di dasar berlumpur, dagingnya lembut bertekstur."},
                {name: "Ikan Kerapu (Epinephelus spp.)", latin: "Epinephelus spp.", desc: "Ikan demersal yang hidup di karang. Bernilai ekonomi tinggi dengan daging padat."},
                {name: "Ikan Kakap Merah (Lutjanus spp.)", latin: "Lutjanus spp.", desc: "Ikan demersal berwarna merah, hidup di karang. Salah satu ikan komersial penting."},
                {name: "Ikan Sembilang (Plotosus canius)", latin: "Plotosus canius", desc: "Ikan demersal bertubuh panjang, hidup di dasar berlumpur. Memiliki bisa pada duri siripnya."},
                {name: "Ikan Biji Nangka (Upeneus spp.)", latin: "Upeneus spp.", desc: "Ikan demersal kecil dengan sungut di mulut. Hidup di dasar berpasir."},
                {name: "Ikan Kurisi (Nemipterus spp.)", latin: "Nemipterus spp.", desc: "Ikan demersal dengan ekor bercabang, hidup di dasar berpasir. Warna tubuh merah muda."},
                {name: "Ikan Togek / Mendut (Star Triggerfish)", latin: "Abalistes stellaris", desc: "Ikan demersal dengan tubuh pipih dan sirip punggung yang khas. Hidup di dasar berpasir atau berlumpur, sering ditemukan di perairan tropis. Dikenal dengan pola bintang di tubuhnya."}
            ],
            "Pelagis Kecil": [
                {name: "Ikan Tembang (Sardinella gibbosa)", latin: "Sardinella gibbosa", desc: "Ikan pelagis kecil yang hidup dalam kawanan besar. Tubuh ramping, sering diawetkan."},
                {name: "Ikan Kembung Lelaki & Perempuan (Rastrelliger spp.)", latin: "Rastrelliger spp.", desc: "Ikan pelagis kecil dengan tubuh pipih. Salah satu ikan ekonomis penting di Indonesia."},
                {name: "Ikan Selar Kuning (Selaroides leptolepis)", latin: "Selaroides leptolepis", desc: "Ikan kecil berwarna kuning keperakan. Hidup dalam gerombolan di perairan pantai."},
                {name: "Ikan Layang (Decapterus spp.)", latin: "Decapterus spp.", desc: "Ikan pelagis kecil dengan tubuh memanjang. Sering digunakan untuk pindang dan kalengan."},
                {name: "Ikan Teri (Stolephorus spp.)", latin: "Stolephorus spp.", desc: "Ikan terkecil dalam kelompok pelagis. Biasanya dikeringkan atau diolah menjadi terasi."},
                {name: "Ikan Japuh (Caranx spp.)", latin: "Caranx spp.", desc: "Ikan pelagis kecil dengan tubuh agak tinggi. Hidup dalam kawanan di perairan pantai."},
                {name: "Ikan Lemuru (Sardinella lemuru)", latin: "Sardinella lemuru", desc: "Ikan pelagis kecil khusus di Selat Bali. Bahan utama industri pengalengan."},
                {name: "Ikan Bentong (Megalaspis cordyla)", latin: "Megalaspis cordyla", desc: "Ikan pelagis kecil dengan tubuh pipih. Cepat berenang dalam kawanan besar."},
                {name: "Ikan Banyar (Carangoides spp.)", latin: "Carangoides spp.", desc: "Ikan pelagis kecil dengan bentuk tubuh ramping. Hidup di perairan pantai."},
                {name: "Ikan Banyar Mata Besar (Megalaspis cordyla)", latin: "Megalaspis cordyla", desc: "Ikan pelagis kecil dengan mata besar. Aktif pada malam hari."}
            ],
            "Pelagis Besar": [
                {name: "Ikan Tongkol (Euthynnus affinis)", latin: "Euthynnus affinis", desc: "Ikan pelagis besar yang bermigrasi. Dagingnya padat, sering dibuat abon atau pindang."},
                {name: "Ikan Cakalang (Katsuwonus pelamis)", latin: "Katsuwonus pelamis", desc: "Ikan pelagis besar berwarna biru metalik. Bahan utama tuna kalengan."},
                {name: "Ikan Tenggiri (Scomberomorus commerson)", latin: "Scomberomorus commerson", desc: "Ikan pelagis besar dengan tubuh memanjang. Dagingnya lembut untuk pempek."},
                {name: "Ikan Tuna Sirip Kuning (Thunnus albacares)", latin: "Thunnus albacares", desc: "Ikan pelagis besar bernilai tinggi. Siripnya berwarna kuning cerah."},
                {name: "Ikan Tuna Mata Besar (Thunnus obesus)", latin: "Thunnus obesus", desc: "Ikan pelagis besar dengan mata besar. Hidup di perairan dalam."},
                {name: "Ikan Layur (Trichiurus lepturus)", latin: "Trichiurus lepturus", desc: "Ikan pelagis besar bertubuh panjang seperti pita. Dagingnya renyah."},
                {name: "Ikan Todak (Xiphias gladius)", latin: "Xiphias gladius", desc: "Ikan pelagis besar dengan moncong panjang seperti pedang. Perenang cepat."},
                {name: "Ikan Lemadang (Coryphaena hippurus)", latin: "Coryphaena hippurus", desc: "Ikan pelagis besar dengan warna tubuh cerah. Sering ditemukan di perairan hangat."},
                {name: "Ikan Marlin (Makaira spp.)", latin: "Makaira spp.", desc: "Ikan pelagis besar dengan moncong panjang. Target favorit pemancing olahraga."},
                {name: "Ikan Cucut (Carcharhinus limbatus)", latin: "Carcharhinus limbatus", desc: "Hiu permukaan dengan sirip hitam. Hidup di perairan pantai."}
            ]
        };

        // Array untuk kompatibilitas
        const FISH_TYPES = [];
        const FISH_DETAILS = {};
        
        // Isi array FISH_TYPES dan objek FISH_DETAILS
        for (const category in FISH_CATEGORIES) {
            FISH_CATEGORIES[category].forEach(fish => {
                FISH_TYPES.push(fish.name);
                FISH_DETAILS[fish.name] = {
                    latin: fish.latin,
                    desc: fish.desc,
                    category: category
                };
            });
        }
        FISH_TYPES.push("Lainnya");

        // Mapping antara Jenis Kapal dan Alat Tangkap yang sesuai
        const KAPAL_API_MAPPING = {
            "Perahu Jukung": ["Pancing", "Pancing Ulur", "Perangkap Bubu", "Jaring Insang (gill net)"],
            "Perahu Mayang": ["Pukat Tarik", "Pancing", "Jaring Insang (gill net)", "Jaring Angkat (lift net)"],
            "Perahu Slerek": ["Pukat Cincin", "Pukat Tarik", "Jaring Angkat (lift net)"],
            "Perahu Insang": ["Jaring Insang (gill net)"],
            "Perahu Jaring Angkat": ["Jaring Angkat (lift net)"],
            "Perahu Pancing": ["Pancing", "Pancing Ulur"],
            "Perahu Pukat Tarik": ["Pukat Tarik", "Pancing", "Jaring Insang (gill net)", "Jaring Angkat (lift net)"],
            "Lainnya": ["Pukat Cincin", "Pukat Tarik", "Pancing Ulur", "Jaring Insang (gill net)", "Jaring Angkat (lift net)", "Pancing", "Perangkap Bubu", "Lainnya"]
        };

        // Mapping antara Alat Tangkap dan Kategori Ikan yang bisa ditangkap
        const API_FISH_MAPPING = {
            "Pukat Cincin": ["Pelagis Besar", "Pelagis Kecil"],
            "Pukat Tarik": ["Pelagis Kecil", "Pelagis Besar", "Demersal"],
            "Pancing Ulur": ["Demersal", "Pelagis Besar"],
            "Jaring Insang (gill net)": ["Demersal", "Pelagis Kecil", "Pelagis Besar"],
            "Jaring Angkat (lift net)": ["Pelagis Kecil", "Demersal"],
            "Pancing": ["Demersal", "Pelagis Kecil", "Pelagis Besar"],
            "Perangkap Bubu": ["Demersal", "Pelagis Kecil"],
            "Lainnya": ["Demersal", "Pelagis Kecil", "Pelagis Besar"]
        };

        // Mapping informasi alat tangkap - DIPERBAIKI DAN DILENGKAPI
        const API_INFO = {
            "Pukat Cincin": "Alat tangkap berupa jaring besar berbentuk cincin yang ditarik mengelilingi gerombolan ikan. Efektif untuk menangkap ikan pelagis besar seperti tuna, cakalang, dan tongkol. Biasanya dioperasikan oleh kapal berukuran sedang hingga besar.",
            "Pukat Tarik": "Jaring berbentuk kerucut yang ditarik oleh kapal di permukaan atau pertengahan air. Cocok untuk menangkap ikan pelagis kecil seperti teri, lemuru, dan kembung. Memerlukan kapal dengan mesin yang kuat.",
            "Pancing Ulur": "Pancing dengan sistem ulur (handline) yang dioperasikan secara manual. Digunakan untuk menangkap ikan dasar seperti kerapu, kakap, dan ikan demersal lainnya. Cocok untuk perairan karang.",
            "Jaring Insang (gill net)": "Jaring yang dipasang diam di air, ikan yang berenang akan tersangkut insangnya. Cocok untuk berbagai jenis ikan mulai dari demersal hingga pelagis kecil. Efektif di perairan tenang.",
            "Jaring Angkat (lift net)": "Jaring berbentuk persegi yang diturunkan ke air lalu diangkat cepat. Efektif untuk ikan permukaan seperti teri dan ikan pelagis kecil. Biasanya menggunakan lampu untuk menarik ikan.",
            "Pancing": "Alat tangkap tradisional menggunakan mata pancing dan umpan. Fleksibel untuk berbagai jenis ikan. Termasuk pancing tonda, pancing rawai, dan pancing tangan.",
            "Perangkap Bubu": "Perangkap berbentuk kurungan untuk menjebak ikan. Umum untuk menangkap ikan karang, udang, dan kepiting. Terbuat dari bambu atau jaring.",
            "Lainnya": "Alat tangkap lain yang tidak termasuk dalam kategori di atas seperti sero, jermal, atau alat tradisional setempat."
        };

        // Mapping informasi perahu - DIPERBAIKI DAN DITAMBAH PERAHU PUKAT TARIK
        const KAPAL_INFO = {
            "Perahu Jukung": "Perahu tradisional kayu kecil, umumnya tanpa mesin atau bermesin kecil (5-15 PK). Cocok untuk perairan tenang dan dekat pantai (0-5 mil). Biasanya digunakan untuk pancing, perangkap bubu, dan jaring insang. Kapasitas 1-3 orang.",
            "Perahu Mayang": "Perahu tradisional yang lebih besar dari jukung, biasanya bermesin tempel (15-40 PK). Untuk penangkapan di perairan sedang (5-12 mil). Cocok untuk pukat tarik, jaring insang, dan jaring angkat. Kapasitas 3-5 orang.",
            "Perahu Slerek": "Perahu khas Situbondo dengan bentuk ramping, biasanya menggunakan layar atau mesin kecil (10-30 PK). Untuk operasi dekat pantai (0-8 mil). Cocok untuk pukat cincin dan jaring angkat. Kapasitas 2-4 orang.",
            "Perahu Insang": "Perahu khusus untuk operasi jaring insang (gill net), dilengkapi dengan sistem pemasangan jaring. Mesin 20-50 PK. Untuk perairan pantai hingga sedang (5-15 mil). Kapasitas 2-3 orang.",
            "Perahu Jaring Angkat": "Perahu dengan sistem derek untuk mengoperasikan jaring angkat (lift net). Biasanya memiliki lampu untuk menarik ikan. Mesin 30-60 PK. Untuk perairan pantai (0-10 mil). Kapasitas 3-6 orang.",
            "Perahu Pancing": "Perahu yang didesain khusus untuk operasi pancing, baik handline maupun rawai. Dilengkapi dengan tempat pancing dan penyimpanan hasil. Mesin 15-40 PK. Untuk berbagai jenis perairan. Kapasitas 2-4 orang.",
            "Perahu Pukat Tarik": "Perahu yang dilengkapi dengan sistem penarik pukat (trawl net) untuk menangkap ikan di dasar laut. Biasanya berukuran sedang hingga besar dengan mesin yang kuat (40-100 PK). Untuk perairan sedang hingga lepas pantai (10-30 mil). Kapasitas 4-8 orang.",
            "Lainnya": "Jenis kapal lain yang tidak termasuk dalam kategori di atas seperti kapal motor besar, perahu fiberglass modern, atau kapal dengan spesifikasi khusus."
        };

        const PROFESI_INFO = {
            "Nelayan Penuh Waktu": "Nelayan yang bekerja sebagai penangkap ikan sebagai mata pencaharian utama dan tidak memiliki pekerjaan lain. Biasanya melaut setiap hari atau sesuai musim tangkap.",
            "Nelayan Sambilan Utama": "Nelayan yang bekerja sebagai penangkap ikan sebagai pekerjaan sampingan namun memberikan kontribusi pendapatan yang signifikan (lebih dari 50% pendapatan).",
            "Nelayan Sambilan Tambahan": "Nelayan yang bekerja sebagai penangkap ikan hanya pada musim tertentu atau sebagai pekerjaan tambahan (kurang dari 50% pendapatan)."
        };

        // Data wilayah Situbondo untuk dropdown (tetap diperlukan untuk form input)
        const SITUBONDO_DATA = {
            "Arjasa": ["Arjasa", "Bayeman", "Curah Tatal", "Jatisari", "Kayumas", "Kedungdowo", "Ketowan", "Lamongan"],
            "Asembagus": ["Asembagus", "Awar-awar", "Bantal", "Gudang", "Kedunglo", "Kertosari", "Mojosari", "Parante", "Trigonco", "Wringin Anom"],
            "Banyuglugur": ["Banyuglugur", "Kalianget", "Kalisari", "Lubawang", "Selobanteng", "Telempong", "Tepos"],
            "Banyuputih": ["Banyuputih", "Sumberanyar", "Sumberejo", "Sumberwaru", "Wonorejo"],
            "Besuki": ["Besuki", "Blimbing", "Bloro", "Demung", "Jetis", "Kalimas", "Langkap", "Pesisir", "Sumberejo", "Widoropayung"],
            "Bungatan": ["Bletok", "Bungatan", "Mlandingan Wetan", "Pasir Putih", "Patemon", "Selowogo", "Sumbertengah"],
            "Jangkar": ["Agel", "Curah Kalak", "Gadingan", "Jangkar", "Kumbangsari", "Palangan", "Pesanggrahan", "Sopet"],
            "Jatibanteng": ["Curahsuri", "Jatibanteng", "Kembangsari", "Pategalan", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"],
            "Kapongan": ["Curah Cottok Gebangan", "Kandang", "Kapongan", "Kesambi Rampak", "Landangan", "Peleyan", "Pokaan", "Seletreng", "Wonokoyo"],
            "Kendit": ["Balung", "Bugeman", "Kendit", "Klatakan", "Kukusan", "Rajekwesi", "Tambak Ukir"],
            "Mangaran": ["Mangaran", "Semiring", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Trebungan"],
            "Mlandingan": ["Alas Bayur", "Campoan", "Mlandingan Kulon", "Selomukti", "Sumberanyar", "Sumber Pinang", "Trebungan"],
            "Panarukan": ["Alasmalang", "Duwet", "Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"],
            "Panji": ["Ardirejo", "Mimbaan", "Battal", "Curah Jeru", "Juglangan", "Kayu Putih", "Klampokan", "Panji Kidul", "Panji Lor", "Sliwung", "Tenggir", "Tokelan"],
            "Situbondo": ["Dawuhan", "Patokan", "Kalibagor", "Kotakan", "Olean", "Talkandang"],
            "Suboh": ["Buduan", "Cemara", "Dawuan", "Gunung Malang", "Gunung Putri", "Ketah", "Mojodungkol", "Suboh"],
            "Sumbermalang": ["Alastengah", "Baderan", "Kalirejo", "Plalangan", "Sumberargo", "Taman", "Tamankursi", "Tamansari", "Tlogosari"]
        };

        // --- GLOBAL VARIABLES ---
        let appData = [];
        let appSettings = {
            appName: 'SISTEM PEMETAAN DATA NELAYAN',
            appSubtitle: 'DINAS PERIKANAN KABUPATEN SITUBONDO',
            itemsPerPage: 10,
            privacyMode: true,
            securityCodeSensor: '987654321'
        };
        let currentPage = 1;
        let duplicateCheckInterval = null;
        let currentDetailId = null; 
        let verifyDataResult = null;
        let currentFilter = {}; // Variabel untuk menyimpan filter aktif
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
        const loginSuccessModal = new bootstrap.Modal(document.getElementById('loginSuccessModal'));
        const fishInfoModal = new bootstrap.Modal(document.getElementById('fishInfoModal'));
        
        const PROFESI_MAPPING = {
            "Penuh Waktu": "Nelayan Penuh Waktu",
            "Sambilan Utama": "Nelayan Sambilan Utama",
            "Sambilan Tambahan": "Nelayan Sambilan Tambahan"
        };
        
        // Ekspos variabel ke window untuk akses dari file lain
        window.appData = appData;
        window.appSettings = appSettings;
        
        // --- FUNGSI UTAMA ---
        function getProfesiLabel(profesi) {
            return PROFESI_MAPPING[profesi] || profesi;
        }
        
        function migrateOldData() {
            appData.forEach(item => {
                if (PROFESI_MAPPING[item.profesi]) {
                    item.profesi = PROFESI_MAPPING[item.profesi];
                }
            });
            saveData();
        }
        
        function generateSecurityCode() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function displayCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('id-ID', options);
            document.getElementById('currentDateDisplay').innerHTML = `<i class="fas fa-calendar-day me-2"></i>${dateString}`;
            document.getElementById('passwordHint').innerHTML = `Kode keamanan berubah setiap hari berdasarkan tanggal.`;
        }

        function maskData(data, force = false) {
            if (!data) return "-";
            if (data === '00000000') return "Tidak Ada";
            if (!appSettings.privacyMode && !force) return data.toString();
            
            let str = data.toString();
            if (str.length <= 4) return str;
            
            const maskedLength = Math.min(4, str.length);
            const visiblePart = str.slice(0, -maskedLength);
            const maskedPart = '*'.repeat(maskedLength);
            return visiblePart + maskedPart;
        }

        function getFishIconClass(fishName) {
            const lower = fishName.toLowerCase();
            if (lower.includes('cumi')) return 'fa-ghost'; 
            if (lower.includes('kepiting')) return 'fa-spider'; 
            if (lower.includes('togek') || lower.includes('mendut')) return 'fa-star'; 
            return 'fa-fish';
        }

        // --- FUNGSI BARU: MAPPING KAPAL DAN ALAT TANGKAP ---
        function updateAlatTangkapByKapal() {
            const jenisKapal = document.getElementById('jenisKapal').value;
            const alatTangkapSelect = document.getElementById('alatTangkap');
            const apiMappingInfo = document.getElementById('apiMappingInfo');
            
            if (!jenisKapal) {
                apiMappingInfo.style.display = 'none';
                return;
            }
            
            const availableAPIs = KAPAL_API_MAPPING[jenisKapal] || Object.keys(API_INFO);
            const currentAPI = alatTangkapSelect.value;
            
            // Update opsi alat tangkap
            alatTangkapSelect.innerHTML = '<option value="">Pilih Alat Penangkapan Ikan...</option>';
            availableAPIs.forEach(api => {
                const option = document.createElement('option');
                option.value = api;
                option.textContent = api;
                if (api === currentAPI) option.selected = true;
                alatTangkapSelect.appendChild(option);
            });
            
            // Tampilkan informasi mapping
            apiMappingInfo.innerHTML = `<strong>${jenisKapal}</strong> biasanya digunakan untuk: ${availableAPIs.join(', ')}`;
            apiMappingInfo.style.display = 'block';
            
            // Update daftar ikan jika alat tangkap sudah dipilih
            if (currentAPI && availableAPIs.includes(currentAPI)) {
                updateFishOptionsByAPI(currentAPI);
            } else {
                updateFishOptionsByAPI('');
            }
        }
        
        function updateFishOptionsByAPI(api) {
            const fishContainer = document.getElementById('fishCheckboxContainer');
            if (!fishContainer) return;
            
            fishContainer.innerHTML = '';
            
            let fishList = [];
            if (api && API_FISH_MAPPING[api]) {
                // Ambil ikan berdasarkan kategori yang sesuai
                API_FISH_MAPPING[api].forEach(category => {
                    if (FISH_CATEGORIES[category]) {
                        FISH_CATEGORIES[category].forEach(fish => {
                            fishList.push(fish.name);
                        });
                    }
                });
            } else {
                // Jika tidak ada API yang dipilih, tampilkan semua ikan
                for (const category in FISH_CATEGORIES) {
                    FISH_CATEGORIES[category].forEach(fish => {
                        fishList.push(fish.name);
                    });
                }
            }
            
            // Tambahkan opsi "Lainnya"
            fishList.push("Lainnya");
            
            // Tampilkan checklist dengan informasi
            fishList.forEach(fish => {
                const id = 'fish_' + fish.replace(/\s/g, '');
                const fishInfo = FISH_DETAILS[fish] || {};
                const html = `
                <label class="fish-option-box">
                    <input type="checkbox" class="form-check-input me-2 fish-checkbox" value="${fish}" id="${id}">
                    <span>${fish}</span>
                    ${fishInfo.latin ? `
                    <div class="fish-info-box">
                        <div class="fish-info-title">${fish}</div>
                        <div class="fish-info-latin">${fishInfo.latin}</div>
                        <div class="fish-info-desc">${fishInfo.desc || ''}</div>
                    </div>
                    ` : ''}
                </label>`;
                fishContainer.innerHTML += html;
            });
            
            // Event listener untuk "Lainnya"
            const lainCheckbox = document.getElementById('fish_Lainnya');
            if (lainCheckbox) {
                lainCheckbox.addEventListener('change', function() {
                    const inputLain = document.getElementById('jenisIkanLainnya');
                    if(this.checked) {
                        inputLain.style.display = 'block';
                        inputLain.setAttribute('required', 'required');
                    } else {
                        inputLain.style.display = 'none';
                        inputLain.value = '';
                        inputLain.removeAttribute('required');
                    }
                });
            }
        }

        // --- FUNGSI VERIFIKASI KIN YANG DISEMPURNAKAN ---
        function verifyKIN(input) {
            if (!input || input.trim() === '') {
                return { success: false, message: "Masukkan Kode Validasi (KIN) atau NIK untuk verifikasi" };
            }
            
            const cleanInput = input.trim().toUpperCase();
            
            // Cari berdasarkan Kode Validasi (KIN)
            const byKodeValidasi = appData.find(d => d.kodeValidasi && d.kodeValidasi.toUpperCase() === cleanInput);
            if (byKodeValidasi) {
                return { 
                    success: true, 
                    data: byKodeValidasi,
                    type: 'kin',
                    message: "Data ditemukan berdasarkan Kode Validasi (KIN)"
                };
            }
            
            // Cari berdasarkan NIK
            const byNIK = appData.find(d => d.nik === cleanInput);
            if (byNIK) {
                return { 
                    success: true, 
                    data: byNIK,
                    type: 'nik',
                    message: "Data ditemukan berdasarkan NIK"
                };
            }
            
            // Coba tanpa prefix VLD-
            if (cleanInput.startsWith('VLD-')) {
                const withoutPrefix = cleanInput.substring(4);
                const byKodeWithoutPrefix = appData.find(d => d.kodeValidasi && d.kodeValidasi.toUpperCase().endsWith(withoutPrefix));
                if (byKodeWithoutPrefix) {
                    return { 
                        success: true, 
                        data: byKodeWithoutPrefix,
                        type: 'kin',
                        message: "Data ditemukan berdasarkan Kode Validasi (tanpa prefix VLD-)"
                    };
                }
            }
            
            return { 
                success: false, 
                message: "Data tidak ditemukan. Pastikan Kode Validasi (KIN) atau NIK yang dimasukkan benar."
            };
        }

        function displayVerifyResult(result) {
            const card = document.getElementById('verifyResultCard');
            const header = document.getElementById('verifyResultHeader');
            const icon = document.getElementById('verifyResultIcon');
            const title = document.getElementById('verifyResultTitle');
            const subtitle = document.getElementById('verifyResultSubtitle');
            const content = document.getElementById('verifyResultContent');
            const detailBtn = document.getElementById('verifyDetailBtn');
            const idCardBtn = document.getElementById('verifyIdCardBtn');
            const allKinCard = document.getElementById('allKinCard');
            
            // Sembunyikan daftar semua KIN jika sedang ditampilkan
            if (allKinCard) allKinCard.style.display = 'none';
            
            if (result.success) {
                const data = result.data;
                verifyDataResult = data;
                
                // Update UI untuk hasil sukses
                card.className = 'card shadow-sm border-0 mb-4 verify-success';
                header.className = 'verify-result-header p-4 bg-success text-white';
                icon.innerHTML = '<i class="fas fa-check-circle fa-3x"></i>';
                title.textContent = 'VERIFIKASI BERHASIL';
                subtitle.textContent = result.message;
                
                // Isi konten
                content.innerHTML = `
                    <div class="col-md-6">
                        <div class="verify-result-item">
                            <div class="verify-result-label">Nama Lengkap</div>
                            <div class="verify-result-value fw-bold">${data.nama}</div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">NIK</div>
                            <div class="verify-result-value font-monospace">${maskData(data.nik)}</div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">Kode Validasi (KIN)</div>
                            <div class="verify-result-value">
                                <span class="kin-badge">${data.kodeValidasi || 'Tidak Ada'}</span>
                            </div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">Domisili</div>
                            <div class="verify-result-value">${data.desa}, ${data.kecamatan}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="verify-result-item">
                            <div class="verify-result-label">Profesi</div>
                            <div class="verify-result-value">
                                <span class="badge ${data.profesi === 'Nelayan Penuh Waktu' ? 'badge-profesi-penuh' : data.profesi === 'Nelayan Sambilan Utama' ? 'badge-profesi-sambilan-utama' : 'badge-profesi-sambilan-tambahan'}">
                                    ${data.profesi}
                                </span>
                            </div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">Status</div>
                            <div class="verify-result-value">
                                <span class="badge ${data.status === 'Pemilik Kapal' ? 'bg-info' : 'bg-secondary'}">
                                    ${data.status}
                                </span>
                            </div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">Alat Tangkap (API)</div>
                            <div class="verify-result-value">${data.alatTangkap}</div>
                        </div>
                        <div class="verify-result-item">
                            <div class="verify-result-label">Tanggal Validasi</div>
                            <div class="verify-result-value">${data.tanggalValidasi} oleh ${data.validator}</div>
                        </div>
                    </div>
                `;
                
                // Tampilkan tombol aksi
                detailBtn.style.display = 'inline-block';
                detailBtn.onclick = () => {
                    viewDetail(data.id);
                    detailModal.show();
                };
                
                idCardBtn.style.display = 'inline-block';
                idCardBtn.onclick = () => {
                    safeGenerateIDCard(data.id);
                };
                
            } else {
                // Update UI untuk hasil gagal
                card.className = 'card shadow-sm border-0 mb-4 verify-error';
                header.className = 'verify-result-header p-4 bg-danger text-white';
                icon.innerHTML = '<i class="fas fa-times-circle fa-3x"></i>';
                title.textContent = 'VERIFIKASI GAGAL';
                subtitle.textContent = result.message;
                
                // Isi konten
                content.innerHTML = `
                    <div class="col-md-12 text-center py-4">
                        <i class="fas fa-search fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Data Tidak Ditemukan</h5>
                        <p class="text-muted">Kode Validasi (KIN) atau NIK yang dimasukkan tidak terdaftar dalam database.</p>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>Saran:</strong> Periksa kembali ketikan atau gunakan fitur "Tampilkan Semua KIN" untuk melihat daftar kode validasi yang terdaftar.
                        </div>
                    </div>
                `;
                
                // Sembunyikan tombol aksi
                detailBtn.style.display = 'none';
                idCardBtn.style.display = 'none';
            }
            
            // Tampilkan kartu hasil
            card.style.display = 'block';
            
            // Scroll ke hasil dengan animasi smooth
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function setVerifyExample(type) {
            const input = document.getElementById('verifyInput');
            const breadcrumbItems = document.querySelectorAll('.verify-breadcrumb-item');
            
            // Reset semua breadcrumb
            breadcrumbItems.forEach(item => item.classList.remove('active'));
            
            if (type === 'kin') {
                input.value = 'VLD-';
                input.placeholder = 'Masukkan Kode Validasi (contoh: VLD-ABC123)';
                input.focus();
                breadcrumbItems[0].classList.add('active');
            } else if (type === 'nik') {
                input.value = '';
                input.placeholder = 'Masukkan NIK 16 digit';
                input.focus();
                breadcrumbItems[1].classList.add('active');
            } else if (type === 'all') {
                breadcrumbItems[2].classList.add('active');
                showAllKIN();
            }
        }

        function showAllKIN() {
            const allKinCard = document.getElementById('allKinCard');
            const tbody = document.getElementById('allKinTableBody');
            const totalKinCount = document.getElementById('totalKinCount');
            const verifyResultCard = document.getElementById('verifyResultCard');
            
            // Sembunyikan hasil verifikasi individual
            if (verifyResultCard) verifyResultCard.style.display = 'none';
            
            // Filter data yang memiliki kode validasi
            const dataWithKIN = appData.filter(d => d.kodeValidasi && d.kodeValidasi.trim() !== '');
            
            // Update count
            totalKinCount.textContent = dataWithKIN.length;
            
            if (dataWithKIN.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Tidak ada data dengan Kode Validasi (KIN) yang terdaftar
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = '';
                dataWithKIN.sort((a, b) => a.kodeValidasi.localeCompare(b.kodeValidasi)).forEach((d, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <span class="kin-badge">${d.kodeValidasi}</span>
                            </td>
                            <td>
                                <div class="fw-bold">${d.nama}</div>
                                <small class="text-muted">${d.usia} Tahun</small>
                            </td>
                            <td class="font-monospace">${maskData(d.nik)}</td>
                            <td>
                                <div class="small">${d.desa}</div>
                                <div class="small text-muted">${d.kecamatan}</div>
                            </td>
                            <td>
                                <span class="badge ${d.status === 'Pemilik Kapal' ? 'bg-info' : 'bg-secondary'}">
                                    ${d.status}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="verifyKINAndShow('${d.kodeValidasi}')" title="Verifikasi">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewDetail('${d.id}')" title="Detail">
                                        <i class="fas fa-eye"></i></button>
                                    <button class="btn btn-outline-success" onclick="safeGenerateIDCard('${d.id}')" title="ID Card">
                                        <i class="fas fa-id-card"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            // Tampilkan kartu
            allKinCard.style.display = 'block';
            allKinCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function verifyKINAndShow(input) {
            const result = verifyKIN(input);
            displayVerifyResult(result);
            
            // Update input field
            document.getElementById('verifyInput').value = input;
        }

        function resetVerifyForm() {
            document.getElementById('verifyInput').value = '';
            document.getElementById('verifyInput').focus();
            document.getElementById('verifyResultCard').style.display = 'none';
            document.getElementById('allKinCard').style.display = 'none';
            
            // Reset breadcrumb ke pertama
            setVerifyExample('kin');
        }

        // Fungsi untuk menampilkan modal info ikan
        function showFishInfoModal() {
            fishInfoModal.show();
        }

        // --- FUNGSI BACKUP DATA YANG DIPERBAIKI ---
        function backupData(filename = 'reload.js') {
            try {
                const encryptedData = btoa(JSON.stringify(appData));
                const now = new Date();
                const dateStr = now.toLocaleDateString('id-ID');
                const timeStr = now.toLocaleTimeString('id-ID');
                
                const backupContent = `/* PETUNJUK PENGGUNAAN RELOAD REPO:
    1. Ini adalah file backup otomatis dari Aplikasi.
    2. Jangan ubah kode di dalam tanda petik dua ("...") di bawah.
    3. Upload file ini ke hosting tempat aplikasi berjalan untuk fitur Reload Data.
    
    APP NAME : SISTEM PEMETAAN DATA NELAYAN
    INSTANSI : DINAS PERIKANAN KABUPATEN SITUBONDO
    TANGGAL  : ${dateStr}, ${timeStr}
*/

window.SIMATA_BACKUP_ENCRYPTED = '${encryptedData}';`;
                
                const blob = new Blob([backupContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Backup berhasil: ${filename}`, 'success');
            } catch (error) {
                console.error('Backup error:', error);
                showNotification('Gagal membuat backup. Silakan coba lagi.', 'error');
            }
        }

        // --- FUNGSI MERGE DATA UNTUK MENGHINDARI DUPLIKASI ---
        function mergeData(existingData, newData) {
            // Buat map untuk data yang sudah ada dengan NIK sebagai key
            const dataMap = new Map();
            
            // Tambahkan data yang sudah ada ke map
            existingData.forEach(item => {
                dataMap.set(item.nik, item);
            });
            
            // Tambahkan atau timpa data baru (data baru akan menimpa data lama dengan NIK yang sama)
            newData.forEach(item => {
                dataMap.set(item.nik, item);
            });
            
            // Kembalikan sebagai array
            return Array.from(dataMap.values());
        }

        // --- FUNGSI RELOAD DATA YANG DIPERBAIKI ---
        function handleReloadRepo() {
            const reloadBtn = document.getElementById('btn-reload-repo');
            const spinner = document.getElementById('reloadSpinner');
            
            // Tampilkan spinner dan nonaktifkan tombol
            spinner.classList.add('active');
            reloadBtn.disabled = true;
            reloadBtn.innerHTML = '<i class="fas fa-sync"></i> Memuat Data... <span class="spinner-border spinner-border-sm reload-spinner active" id="reloadSpinner"></span>';
            
            showNotification('Memulai sinkronisasi data dari server...', 'info');
            
            // Coba load ulang file reload.js
            const script = document.createElement('script');
            script.src = 'reload.js?t=' + new Date().getTime(); // Tambahkan timestamp untuk cache busting
            script.onload = function() {
                console.log('File reload.js berhasil dimuat ulang');
                
                // Beri waktu untuk pemrosesan
                setTimeout(() => {
                    if (typeof window.SIMATA_BACKUP_ENCRYPTED !== 'undefined' && window.SIMATA_BACKUP_ENCRYPTED) {
                        try {
                            const restoredData = JSON.parse(atob(window.SIMATA_BACKUP_ENCRYPTED));
                            
                            // Merge data lama dengan data baru (data baru menimpa data lama dengan NIK yang sama)
                            const existingData = appData;
                            const mergedData = mergeData(existingData, restoredData);
                            
                            // Hitung perubahan
                            const newCount = restoredData.length;
                            const existingCount = existingData.length;
                            const mergedCount = mergedData.length;
                            const replacedCount = existingCount + newCount - mergedCount;
                            const addedCount = mergedCount - existingCount;
                            
                            // Update data aplikasi
                            appData = mergedData;
                            saveData();
                            renderDataTable();
                            updateDashboard();
                            
                            // Tampilkan notifikasi yang informatif
                            let message = '';
                            if (replacedCount > 0 && addedCount > 0) {
                                message = `Data berhasil disinkronisasi: ${replacedCount} data diperbarui, ${addedCount} data baru ditambahkan`;
                            } else if (replacedCount > 0) {
                                message = `Data berhasil disinkronisasi: ${replacedCount} data diperbarui`;
                            } else if (addedCount > 0) {
                                message = `Data berhasil disinkronisasi: ${addedCount} data baru ditambahkan`;
                            } else {
                                message = 'Data sudah up-to-date. Tidak ada perubahan.';
                            }
                            
                            showNotification(message, 'success');
                            
                        } catch (error) {
                            console.error('Reload error:', error);
                            showNotification('Gagal memuat data dari repository. Format data tidak valid.', 'error');
                        }
                    } else {
                        showNotification('Tidak ada data repository yang tersedia untuk dimuat', 'warning');
                    }
                    
                    // Reset tombol
                    spinner.classList.remove('active');
                    reloadBtn.disabled = false;
                    reloadBtn.innerHTML = '<i class="fas fa-sync"></i> Reload Data <span class="spinner-border spinner-border-sm reload-spinner" id="reloadSpinner"></span>';
                }, 500);
            };
            
            script.onerror = function() {
                console.error('Gagal memuat file reload.js');
                showNotification('Gagal memuat data dari server. Pastikan koneksi internet aktif.', 'error');
                
                // Reset tombol
                spinner.classList.remove('active');
                reloadBtn.disabled = false;
                reloadBtn.innerHTML = '<i class="fas fa-sync"></i> Reload Data <span class="spinner-border spinner-border-sm reload-spinner" id="reloadSpinner"></span>';
            };
            
            document.head.appendChild(script);
        }

        // --- FUNGSI RESTORE DATA YANG DIPERBAIKI ---
        function restoreData() {
            const fileInput = document.getElementById('restoreFileInput');
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Coba ekstrak data dari file JS
                    let encryptedData = '';
                    if (content.includes('SIMATA_BACKUP_ENCRYPTED')) {
                        const match = content.match(/window\.SIMATA_BACKUP_ENCRYPTED\s*=\s*'([^']+)'/);
                        if (match) encryptedData = match[1];
                    } else if (content.startsWith('window.SIMATA_BACKUP_ENCRYPTED')) {
                        const match = content.match(/='([^']+)'/);
                        if (match) encryptedData = match[1];
                    } else {
                        // Coba parse sebagai JSON langsung
                        try {
                            const restoredData = JSON.parse(content);
                            // Merge data lama dengan data baru
                            const existingData = appData;
                            const mergedData = mergeData(existingData, restoredData);
                            
                            const newCount = restoredData.length;
                            const existingCount = existingData.length;
                            const mergedCount = mergedData.length;
                            const replacedCount = existingCount + newCount - mergedCount;
                            const addedCount = mergedCount - existingCount;
                            
                            appData = mergedData;
                            saveData();
                            renderDataTable();
                            updateDashboard();
                            
                            let message = '';
                            if (replacedCount > 0 && addedCount > 0) {
                                message = `Restore berhasil: ${replacedCount} data diperbarui, ${addedCount} data baru ditambahkan`;
                            } else if (replacedCount > 0) {
                                message = `Restore berhasil: ${replacedCount} data diperbarui`;
                            } else if (addedCount > 0) {
                                message = `Restore berhasil: ${addedCount} data baru ditambahkan`;
                            } else {
                                message = 'Tidak ada data baru untuk di-restore';
                            }
                            
                            showNotification(message, 'success');
                            fileInput.value = '';
                            document.getElementById('restoreDataBtn').disabled = true;
                            return;
                        } catch (jsonError) {
                            throw new Error('Format file tidak dikenali');
                        }
                    }
                    
                    if (!encryptedData) throw new Error('Data terenkripsi tidak ditemukan');
                    
                    const restoredData = JSON.parse(atob(encryptedData));
                    
                    // Merge data lama dengan data baru
                    const existingData = appData;
                    const mergedData = mergeData(existingData, restoredData);
                    
                    const newCount = restoredData.length;
                    const existingCount = existingData.length;
                    const mergedCount = mergedData.length;
                    const replacedCount = existingCount + newCount - mergedCount;
                    const addedCount = mergedCount - existingCount;
                    
                    if (newCount === 0) {
                        showNotification('Tidak ada data baru untuk di-restore', 'warning');
                        return;
                    }
                    
                    appData = mergedData;
                    saveData();
                    renderDataTable();
                    updateDashboard();
                    
                    let message = '';
                    if (replacedCount > 0 && addedCount > 0) {
                        message = `Restore berhasil: ${replacedCount} data diperbarui, ${addedCount} data baru ditambahkan`;
                    } else if (replacedCount > 0) {
                        message = `Restore berhasil: ${replacedCount} data diperbarui`;
                    } else if (addedCount > 0) {
                        message = `Restore berhasil: ${addedCount} data baru ditambahkan`;
                    } else {
                        message = 'Tidak ada data baru untuk di-restore';
                    }
                    
                    showNotification(message, 'success');
                    fileInput.value = '';
                    document.getElementById('restoreDataBtn').disabled = true;
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showNotification(`Gagal restore: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Gagal membaca file', 'error');
            };
            
            reader.readAsText(file);
        }

        // --- FUNGSI PAGINATION YANG DISEMPURNAKAN ---
        function updatePagination(totalItems) {
            const totalPages = Math.max(1, Math.ceil(totalItems / appSettings.itemsPerPage));
            const ul = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // Validasi currentPage
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            ul.innerHTML = '';
            
            if (totalPages <= 1) {
                paginationInfo.textContent = `Halaman 1 dari 1 (Total: ${totalItems} data)`;
                return;
            }
            
            paginationInfo.textContent = `Halaman ${currentPage} dari ${totalPages} (Total: ${totalItems} data)`;
            
            // Tombol pertama
            const first = document.createElement('li');
            first.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            first.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1); return false;" title="Halaman Pertama">&laquo;</a>`;
            ul.appendChild(first);
            
            // Tombol sebelumnya
            const prev = document.createElement('li');
            prev.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prev.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage-1}); return false;" title="Halaman Sebelumnya">&lt;</a>`;
            ul.appendChild(prev);
            
            // Tampilkan beberapa halaman sekitar currentPage
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Pastikan kita selalu menampilkan 5 halaman jika memungkini
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            // Tambahkan ellipsis di awal jika diperlukan
            if (startPage > 1) {
                const ellipsis1 = document.createElement('li');
                ellipsis1.className = 'page-item disabled';
                ellipsis1.innerHTML = `<span class="page-link">...</span>`;
                ul.appendChild(ellipsis1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
                ul.appendChild(li);
            }
            
            // Tambahkan ellipsis di akhir jika diperlukan
            if (endPage < totalPages) {
                const ellipsis2 = document.createElement('li');
                ellipsis2.className = 'page-item disabled';
                ellipsis2.innerHTML = `<span class="page-link">...</span>`;
                ul.appendChild(ellipsis2);
            }
            
            // Tombol berikutnya
            const next = document.createElement('li');
            next.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            next.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage+1}); return false;" title="Halaman Berikutnya">&gt;</a>`;
            ul.appendChild(next);
            
            // Tombol terakhir
            const last = document.createElement('li');
            last.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            last.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;" title="Halaman Terakhir">&raquo;</a>`;
            ul.appendChild(last);
        }

        function goToPage(page) {
            currentPage = page;
            renderDataTable();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- FUNGSI GET FILTERED DATA UNTUK PDF ---
        function getFilteredData() {
            const search = document.getElementById('searchData').value.toLowerCase();
            
            // Filter data berdasarkan pencarian dan filter
            let filtered = appData;
            
            // Terapkan filter jika ada
            if (Object.keys(currentFilter).length > 0) {
                filtered = filtered.filter(d => {
                    const matchDesa = !currentFilter.desa || d.desa === currentFilter.desa;
                    const matchProfesi = !currentFilter.profesi || d.profesi === currentFilter.profesi;
                    const matchStatus = !currentFilter.status || d.status === currentFilter.status;
                    
                    // Filter jenis kapal hanya untuk pemilik kapal
                    let matchJenis = true;
                    if (currentFilter.jenisKapal) {
                        if (d.status === 'Pemilik Kapal') {
                            matchJenis = d.jenisKapal === currentFilter.jenisKapal;
                        } else {
                            matchJenis = false;
                        }
                    }
                    
                    const matchAlatTangkap = !currentFilter.alatTangkap || d.alatTangkap === currentFilter.alatTangkap;
                    const matchUsaha = !currentFilter.usaha || 
                        (currentFilter.usaha === 'Ada' ? 
                            (d.usahaSampingan && d.usahaSampingan.trim() !== '' && d.usahaSampingan !== '-') : 
                            (!d.usahaSampingan || d.usahaSampingan.trim() === '' || d.usahaSampingan === '-'));
                    
                    return matchDesa && matchProfesi && matchStatus && matchJenis && matchAlatTangkap && matchUsaha;
                });
            }
            
            // Terapkan pencarian jika ada
            if (search) {
                filtered = filtered.filter(d => 
                    d.nama.toLowerCase().includes(search) || 
                    d.nik.includes(search) || 
                    (d.namaKapal && d.namaKapal.toLowerCase().includes(search)) ||
                    d.desa.toLowerCase().includes(search) ||
                    d.kecamatan.toLowerCase().includes(search)
                );
            }
            
            return filtered;
        }

        // --- FUNGSI RENDER DATA TABLE YANG DISEMPURNAKAN ---
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const search = document.getElementById('searchData').value.toLowerCase();
            
            // Filter data berdasarkan pencarian dan filter
            let filtered = appData;
            
            // Terapkan filter jika ada
            if (Object.keys(currentFilter).length > 0) {
                filtered = filtered.filter(d => {
                    const matchDesa = !currentFilter.desa || d.desa === currentFilter.desa;
                    const matchProfesi = !currentFilter.profesi || d.profesi === currentFilter.profesi;
                    const matchStatus = !currentFilter.status || d.status === currentFilter.status;
                    
                    // Filter jenis kapal hanya untuk pemilik kapal
                    let matchJenis = true;
                    if (currentFilter.jenisKapal) {
                        if (d.status === 'Pemilik Kapal') {
                            matchJenis = d.jenisKapal === currentFilter.jenisKapal;
                        } else {
                            matchJenis = false;
                        }
                    }
                    
                    const matchAlatTangkap = !currentFilter.alatTangkap || d.alatTangkap === currentFilter.alatTangkap;
                    const matchUsaha = !currentFilter.usaha || 
                        (currentFilter.usaha === 'Ada' ? 
                            (d.usahaSampingan && d.usahaSampingan.trim() !== '' && d.usahaSampingan !== '-') : 
                            (!d.usahaSampingan || d.usahaSampingan.trim() === '' || d.usahaSampingan === '-'));
                    
                    return matchDesa && matchProfesi && matchStatus && matchJenis && matchAlatTangkap && matchUsaha;
                });
            }
            
            // Terapkan pencarian jika ada
            if (search) {
                filtered = filtered.filter(d => 
                    d.nama.toLowerCase().includes(search) || 
                    d.nik.includes(search) || 
                    (d.namaKapal && d.namaKapal.toLowerCase().includes(search)) ||
                    d.desa.toLowerCase().includes(search) ||
                    d.kecamatan.toLowerCase().includes(search)
                );
            }
            
            const nikCounts = {};
            appData.forEach(d => nikCounts[d.nik] = (nikCounts[d.nik] || 0) + 1);

            const totalItems = filtered.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / appSettings.itemsPerPage));
            
            // Validasi currentPage
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalItems === 0) {
                currentPage = 1;
            }
            
            const start = (currentPage - 1) * appSettings.itemsPerPage;
            const end = start + appSettings.itemsPerPage;
            const pageData = filtered.slice(start, end);

            tableBody.innerHTML = '';
            
            if (totalItems === 0) {
                const row = `<tr>
                    <td colspan="8" class="text-center py-5 text-muted">
                        <i class="fas fa-database fa-2x mb-3"></i>
                        <p>Tidak ada data ditemukan</p>
                        ${search || Object.keys(currentFilter).length > 0 ? '<small>Coba dengan kata kunci pencarian atau filter yang berbeda</small>' : ''}
                    </td>
                </tr>`;
                tableBody.innerHTML = row;
            } else if (pageData.length === 0) {
                const row = `<tr>
                    <td colspan="8" class="text-center py-5 text-muted">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>Data untuk halaman ini tidak ditemukan</p>
                    </td>
                </tr>`;
                tableBody.innerHTML = row;
            } else {
                pageData.forEach((d, i) => {
                    const kapalInfo = d.status === 'Pemilik Kapal' ? 
                        `<div class="text-truncate-2 small fw-bold text-primary">${d.namaKapal}</div><div class="small text-muted">${d.jenisKapal}</div>` : 
                        '-';
                    
                    const isDuplicate = nikCounts[d.nik] > 1;
                    const rowClass = isDuplicate ? 'table-danger' : '';
                    
                    let badgeClass = 'bg-secondary';
                    if(d.profesi === 'Nelayan Penuh Waktu') badgeClass = 'badge-profesi-penuh';
                    else if(d.profesi === 'Nelayan Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
                    else if(d.profesi === 'Nelayan Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
                    
                    const displayNik = maskData(d.nik);
                    const displayWaRaw = maskData(d.whatsapp);
                    
                    let contactDisplay = '';
                    if(displayWaRaw === "Tidak Ada") {
                        contactDisplay = `<span class="badge bg-light text-muted border">Tidak Ada</span>`;
                    } else {
                        if (appSettings.privacyMode) {
                            contactDisplay = `<div class="small"><i class="fas fa-phone-alt text-secondary me-1"></i> ${displayWaRaw}</div>`;
                        } else {
                            let cleanNum = d.whatsapp;
                            if(cleanNum.startsWith('0')) cleanNum = '62' + cleanNum.substring(1);
                            contactDisplay = `<div class="d-flex align-items-center gap-1"><a href="https://wa.me/${cleanNum}" target="_blank" class="btn btn-sm btn-success py-0 px-1" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a><span class="small font-monospace ms-1">${d.whatsapp}</span></div>`;
                        }
                    }

                    const row = `<tr class="${rowClass}">
                        <td class="text-center"><input type="checkbox" class="row-checkbox" value="${d.id}" onchange="toggleBulkDeleteBtn()"></td>
                        <td class="text-center">${start + i + 1}</td>
                        <td onclick="viewDetail('${d.id}')" class="clickable-name col-id-cell">
                            <div class="fw-bold text-dark text-wrap">${d.nama}</div>
                            <div class="small font-monospace text-muted">${displayNik} ${isDuplicate ? '<span class="text-danger fw-bold ms-1">(!)</span>' : ''}</div>
                            <div class="small text-muted text-wrap mt-1"><i class="fas fa-map-marker-alt me-1"></i>${d.kecamatan}, ${d.desa}</div>
                        </td>
                        <td class="col-contact-cell">${contactDisplay}</td>
                        <td class="col-status-cell"><span class="badge ${badgeClass} border">${d.profesi}</span><br><small class="text-muted">${d.status}</small></td>
                        <td class="col-status-cell">${kapalInfo}</td>
                        <td style="white-space:nowrap;"><span class="badge bg-info text-white">${d.alatTangkap}</span></td>
                        <td class="col-action sticky-col-right">
                            <div class="btn-group shadow-sm" role="group">
                                <button class="btn btn-sm btn-info text-white" onclick="viewDetail('${d.id}')" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-warning text-white" onclick="editData('${d.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-sm btn-idcard" onclick="safeGenerateIDCard('${d.id}')" title="Cetak ID Card"><i class="fas fa-id-card"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteData('${d.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            }
            
            // Update informasi tabel
            const startItem = totalItems > 0 ? start + 1 : 0;
            const endItem = Math.min(start + appSettings.itemsPerPage, totalItems);
            document.getElementById('tableInfo').textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;
            
            // Update pagination
            updatePagination(totalItems);
            
            // Update tombol bulk delete
            toggleBulkDeleteBtn();
        }

        // --- FUNGSI FILTER YANG DISEMPURNAKAN ---
        function applyFilter() {
            currentFilter = {
                desa: document.getElementById('filterDesa').value,
                profesi: document.getElementById('filterProfesi').value,
                status: document.getElementById('filterStatus').value,
                jenisKapal: document.getElementById('filterJenisKapal').value,
                alatTangkap: document.getElementById('filterAlatTangkap').value,
                usaha: document.getElementById('filterUsaha').value
            };
            
            currentPage = 1; // Reset ke halaman pertama saat filter diterapkan
            renderDataTable();
            
            // Hitung jumlah data yang difilter
            const filteredCount = appData.filter(d => {
                const matchDesa = !currentFilter.desa || d.desa === currentFilter.desa;
                const matchProfesi = !currentFilter.profesi || d.profesi === currentFilter.profesi;
                const matchStatus = !currentFilter.status || d.status === currentFilter.status;
                
                let matchJenis = true;
                if (currentFilter.jenisKapal) {
                    if (d.status === 'Pemilik Kapal') {
                        matchJenis = d.jenisKapal === currentFilter.jenisKapal;
                    } else {
                        matchJenis = false;
                    }
                }
                
                const matchAlatTangkap = !currentFilter.alatTangkap || d.alatTangkap === currentFilter.alatTangkap;
                const matchUsaha = !currentFilter.usaha || 
                    (currentFilter.usaha === 'Ada' ? 
                        (d.usahaSampingan && d.usahaSampingan.trim() !== '' && d.usahaSampingan !== '-') : 
                        (!d.usahaSampingan || d.usahaSampingan.trim() === '' || d.usahaSampingan === '-'));
                
                return matchDesa && matchProfesi && matchStatus && matchJenis && matchAlatTangkap && matchUsaha;
            }).length;
            
            showNotification(`Filter diterapkan: ${filteredCount} data ditemukan`, 'success');
        }

        function resetFilter() {
            // Reset semua dropdown filter
            document.getElementById('filterDesa').value = '';
            document.getElementById('filterProfesi').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterJenisKapal').value = '';
            document.getElementById('filterAlatTangkap').value = '';
            document.getElementById('filterUsaha').value = '';
            
            // Reset filter aktif
            currentFilter = {};
            currentPage = 1;
            
            // Render ulang tabel
            renderDataTable();
            
            showNotification('Filter direset, menampilkan semua data', 'info');
        }

        function showDuplicateDataInFilter() {
            // Hitung data duplikat
            const counts = {};
            appData.forEach(d => counts[d.nik] = (counts[d.nik] || 0) + 1);
            const duplicateData = appData.filter(d => counts[d.nik] > 1);
            
            if (duplicateData.length === 0) {
                showNotification('Tidak ditemukan data NIK ganda. Data sudah bersih!', 'success');
                return;
            }
            
            // Set filter untuk menampilkan hanya data duplikat
            currentFilter = { duplicate: true };
            currentPage = 1;
            
            // Render ulang tabel
            renderDataTable();
            
            showNotification(`Ditemukan ${duplicateData.length} data dengan NIK ganda`, 'warning');
        }

        // --- FUNGSI GENERATE PDF UNTUK DATA TERFILTER ---
        function generateFilteredPdf() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                showNotification('Tidak ada data untuk dicetak!', 'error');
                return;
            }
            
            // Hitung statistik per desa dari data terfilter
            const desaStats = {};
            filteredData.forEach(d => {
                const desa = d.desa || "Tidak Diketahui";
                if (!desaStats[desa]) {
                    desaStats[desa] = { 
                        count: 0, 
                        owner: 0, 
                        abk: 0, 
                        penuhWaktu: 0, 
                        sambilanUtama: 0, 
                        sambilanTambahan: 0 
                    };
                }
                desaStats[desa].count++;
                if(d.status === 'Pemilik Kapal') desaStats[desa].owner++; 
                else desaStats[desa].abk++;
                
                if(d.profesi === 'Nelayan Penuh Waktu') desaStats[desa].penuhWaktu++;
                else if(d.profesi === 'Nelayan Sambilan Utama') desaStats[desa].sambilanUtama++;
                else if(d.profesi === 'Nelayan Sambilan Tambahan') desaStats[desa].sambilanTambahan++;
            });

            // Siapkan data untuk tabel
            const tableRows = Object.keys(desaStats).sort().map((desa, index) => [
                index + 1, 
                desa, 
                desaStats[desa].count, 
                desaStats[desa].owner,
                desaStats[desa].abk, 
                desaStats[desa].penuhWaktu, 
                desaStats[desa].sambilanUtama,
                desaStats[desa].sambilanTambahan
            ]);

            // Hitung total dari data terfilter
            const totalCount = tableRows.reduce((sum, row) => sum + row[2], 0);
            const totalOwner = tableRows.reduce((sum, row) => sum + row[3], 0);
            const totalAbk = tableRows.reduce((sum, row) => sum + row[4], 0);
            const totalPenuhWaktu = tableRows.reduce((sum, row) => sum + row[5], 0);
            const totalSambilanUtama = tableRows.reduce((sum, row) => sum + row[6], 0);
            const totalSambilanTambahan = tableRows.reduce((sum, row) => sum + row[7], 0);

            // Tambahkan baris total
            tableRows.push([
                "",
                "TOTAL KESELURUHAN",
                totalCount,
                totalOwner,
                totalAbk,
                totalPenuhWaktu,
                totalSambilanUtama,
                totalSambilanTambahan
            ]);

            // Generate kode unik untuk setiap cetakan
            const printId = 'SIMATA-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();

            // Generate QR Code untuk tanda tangan dengan warna biru muda (#4a69bd)
            document.getElementById('qr-right').innerHTML = "";
            const signatureText = `Dokumen Sah - Dinas Perikanan Kabupaten Situbondo\nNama: SUGENG PURWO PRIYANTO, S.E, M.M\nJabatan: Kabid Pemberdayaan Nelayan\nNIP: 19761103 200903 1 001\nTanggal: ${new Date().toLocaleDateString('id-ID')}\nID Dokumen: ${printId}`;
            
            try {
                new QRCode(document.getElementById("qr-right"), { 
                    text: signatureText, 
                    width: 120, 
                    height: 120,
                    colorDark: "#4a69bd", // Biru muda
                    colorLight: "#ffffff", 
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (error) {
                console.error("Error generating QR code:", error);
            }

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    
                    if (typeof jsPDF.API.autoTable !== 'function') {
                        showNotification('Library PDF tidak lengkap. Silakan refresh halaman.', 'error');
                        return;
                    }

                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;

                    // Header
                    doc.setFillColor(12, 36, 97);
                    doc.rect(10, 10, pageWidth - 20, 28, 'F');
                    
                    // Judul utama
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('SISTEM INFORMASI PEMETAAN NELAYAN (SIMATA)', pageWidth/2, 20, { align: 'center' });
                    
                    // Subjudul
                    doc.setFontSize(12);
                    doc.text('DINAS PERIKANAN KABUPATEN SITUBONDO', pageWidth/2, 26, { align: 'center' });

                    // Slogan dengan warna oranye
                    doc.setTextColor(246, 185, 59);
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(10);
                    doc.text('"Situbondo Naik Kelas"', pageWidth/2, 32, { align: 'center' });

                    // Garis bawah header dengan warna aksen
                    doc.setDrawColor(246, 185, 59);
                    doc.setLineWidth(1.5);
                    doc.line(20, 38, pageWidth - 20, 38);

                    // Judul Laporan dengan informasi filter
                    doc.setTextColor(12, 36, 97);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.text('LAPORAN DATA NELAYAN TERFILTER', pageWidth/2, 48, { align: 'center' });
                    
                    // Informasi filter yang aktif
                    let filterInfo = "Semua Data";
                    if (Object.keys(currentFilter).length > 0 || document.getElementById('searchData').value) {
                        filterInfo = "Data Terfilter: ";
                        const filterParts = [];
                        
                        if (currentFilter.desa) filterParts.push(`Desa: ${currentFilter.desa}`);
                        if (currentFilter.profesi) filterParts.push(`Profesi: ${currentFilter.profesi}`);
                        if (currentFilter.status) filterParts.push(`Status: ${currentFilter.status}`);
                        if (currentFilter.jenisKapal) filterParts.push(`Jenis Kapal: ${currentFilter.jenisKapal}`);
                        if (currentFilter.alatTangkap) filterParts.push(`Alat Tangkap: ${currentFilter.alatTangkap}`);
                        if (currentFilter.usaha) filterParts.push(`Usaha: ${currentFilter.usaha === 'Ada' ? 'Ada Usaha Sampingan' : 'Tidak Ada Usaha'}`);
                        if (document.getElementById('searchData').value) filterParts.push(`Pencarian: "${document.getElementById('searchData').value}"`);
                        
                        filterInfo += filterParts.join(', ');
                    }
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(filterInfo, pageWidth/2, 54, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PER DESA / KELURAHAN', pageWidth/2, 60, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const now = new Date();
                    const dateString = now.toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric'});
                    doc.text(`Dicetak pada: ${dateString}`, pageWidth/2, 66, { align: 'center' });

                    // Tabel Data
                    const tableWidth = pageWidth - 40;
                    const tableStartX = (pageWidth - tableWidth) / 2;

                    doc.autoTable({
                        head: [[
                            {content: 'No', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 20}},
                            {content: 'Desa / Kelurahan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 60}},
                            {content: 'Jumlah Nelayan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Pemilik Kapal', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'ABK', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 25}},
                            {content: 'Penuh Waktu', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Sambilan Utama', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Sambilan Tambahan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 35}}
                        ]],
                        body: tableRows,
                        startY: 72,
                        theme: 'grid',
                        tableWidth: tableWidth,
                        margin: { left: tableStartX, right: tableStartX },
                        headStyles: { 
                            fillColor: [12, 36, 97],
                            textColor: [255, 255, 255], 
                            fontStyle: 'bold', 
                            halign: 'center',
                            fontSize: 9,
                            cellPadding: 4,
                            lineWidth: 0.5,
                            lineColor: [255, 255, 255]
                        },
                        bodyStyles: {
                            textColor: [0, 0, 0],
                            fontSize: 9,
                            fillColor: [255, 255, 255],
                            cellPadding: 4,
                            lineWidth: 0.1,
                            lineColor: [200, 200, 200]
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        styles: {
                            overflow: 'linebreak',
                            cellPadding: 4,
                            fontSize: 9,
                            valign: 'middle',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: {cellWidth: 20, halign: 'center'},
                            1: {cellWidth: 60, halign: 'left'},
                            2: {cellWidth: 30, halign: 'center'},
                            3: {cellWidth: 30, halign: 'center'},
                            4: {cellWidth: 25, halign: 'center'},
                            5: {cellWidth: 30, halign: 'center'},
                            6: {cellWidth: 30, halign: 'center'},
                            7: {cellWidth: 35, halign: 'center'}
                        },
                        willDrawCell: function(data) {
                            // Baris total dengan warna kuning
                            if (data.row.index === tableRows.length - 1) {
                                data.cell.styles.fillColor = [255, 235, 59];
                                data.cell.styles.textColor = [0, 0, 0];
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.lineWidth = 0.5;
                                data.cell.styles.lineColor = [12, 36, 97];
                            }
                        }
                    });

                    // Footer
                    const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 150;
                    const footerY = Math.min(finalY + 15, pageHeight - 50);
                    
                    // Garis pemisah
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(20, footerY, pageWidth - 20, footerY);
                    
                    // Bagian kiri: Validasi elektronik
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.setTextColor(12, 36, 97);
                    
                    const leftX = 25;
                    const leftY = footerY + 8;
                    
                    doc.text("DOKUMEN INI TELAH DIVALIDASI", leftX, leftY);
                    doc.text("SECARA ELEKTRONIK OLEH", leftX, leftY + 4);
                    doc.text("SISTEM SATU DATA NELAYAN (SIMATA)", leftX, leftY + 8);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text("Dinas Perikanan Kabupaten Situbondo", leftX, leftY + 14);
                    doc.setTextColor(230, 126, 34);
                    doc.text("www.dinasperikanansitubondo.com/simata", leftX, leftY + 18);
                    
                    // Bagian kanan: Tanda tangan dan QR Code
                    const rightX = pageWidth - 85;
                    const rightY = footerY + 5;
                    
                    // Tanggal
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    const currentDate = new Date();
                    const formattedDate = currentDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year:'numeric'});
                    doc.text(`Situbondo, ${formattedDate}`, rightX + 32, rightY, {align: 'center'});
                    
                    // Jabatan
                    doc.text('Kepala Bidang Pemberdayaan Nelayan', rightX + 32, rightY + 6, {align: 'center'});
                    
                    // QR Code dengan warna biru muda
                    const qrRightCanvas = document.querySelector('#qr-right canvas');
                    if(qrRightCanvas) {
                        try {
                            const imgRight = qrRightCanvas.toDataURL("image/png");
                            // QR code 25x25 mm
                            doc.addImage(imgRight, 'PNG', rightX + 19, rightY + 10, 25, 25);
                        } catch (error) {
                            console.error("Error adding QR code image:", error);
                        }
                    }
                    
                    // Garis tanda tangan
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.line(rightX + 5, rightY + 40, rightX + 60, rightY + 40);
                    
                    // Nama dan NIP
                    const nameY = rightY + 45;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', rightX + 32, nameY, {align: 'center'});
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text('NIP. 19761103 200903 1 001', rightX + 32, nameY + 5, {align: 'center'});

                    // Footer dengan kode unik
                    const totalPages = doc.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(`Halaman ${i} dari ${totalPages}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
                        
                        // Informasi sistem di footer dengan kode unik
                        doc.setFontSize(7);
                        const printTime = new Date().toLocaleString('id-ID');
                        doc.text(`Dicetak dari SIMATA v5.5 - ${printTime} | ID Dokumen: ${printId}`, pageWidth / 2, pageHeight - 7, { align: 'center' });
                        doc.text(`Total Data Terfilter: ${filteredData.length} records`, pageWidth / 2, pageHeight - 2, { align: 'center' });
                    }

                    // Simpan file PDF
                    const fileName = `Laporan_Nelayan_Terfilter_${appSettings.appSubtitle.replace(/\s+/g, '_').slice(0,15)}_${Date.now()}.pdf`;
                    doc.save(fileName);
                    document.getElementById('qr-right').innerHTML = "";
                    
                    showNotification(`Laporan PDF terfilter berhasil dibuat (${filteredData.length} data)`, 'success');
                    
                } catch (error) {
                    console.error("Error generating filtered PDF:", error);
                    showNotification('Gagal membuat PDF. Silakan coba lagi atau periksa konsol browser.', 'error');
                }
            }, 800);
        }

        // --- FUNGSI BARU: GENERATE PDF TABEL DATA NELAYAN ---
        function generateTablePdf() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                showNotification('Tidak ada data untuk dicetak!', 'error');
                return;
            }
            
            // Siapkan data untuk tabel
            const tableRows = filteredData.map((d, index) => [
                index + 1, 
                d.nama,
                d.whatsapp === '00000000' || !d.whatsapp ? '-' : d.whatsapp,
                d.nik,
                d.desa,
                d.kecamatan,
                d.status,
                d.status === 'Pemilik Kapal' ? (d.namaKapal || '-') : '-',
                d.tanggalValidasi,
                d.kodeValidasi || '-',
                d.keterangan || ''
            ]);

            // Generate kode unik untuk setiap cetakan
            const printId = 'SIMATA-TABLE-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();

            // Generate QR Code untuk tanda tangan dengan warna biru muda (#4a69bd)
            document.getElementById('qr-right').innerHTML = "";
            const signatureText = `Dokumen Sah - Dinas Perikanan Kabupaten Situbondo\nNama: SUGENG PURWO PRIYANTO, S.E, M.M\nJabatan: Kabid Pemberdayaan Nelayan\nNIP: 19761103 200903 1 001\nTanggal: ${new Date().toLocaleDateString('id-ID')}\nID Dokumen: ${printId}`;
            
            try {
                new QRCode(document.getElementById("qr-right"), { 
                    text: signatureText, 
                    width: 120, 
                    height: 120,
                    colorDark: "#4a69bd", // Biru muda
                    colorLight: "#ffffff", 
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (error) {
                console.error("Error generating QR code:", error);
            }

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    
                    if (typeof jsPDF.API.autoTable !== 'function') {
                        showNotification('Library PDF tidak lengkap. Silakan refresh halaman.', 'error');
                        return;
                    }

                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;

                    // Header
                    doc.setFillColor(12, 36, 97);
                    doc.rect(10, 10, pageWidth - 20, 28, 'F');
                    
                    // Judul utama
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('SISTEM INFORMASI PEMETAAN NELAYAN (SIMATA)', pageWidth/2, 20, { align: 'center' });
                    
                    // Subjudul
                    doc.setFontSize(12);
                    doc.text('DINAS PERIKANAN KABUPATEN SITUBONDO', pageWidth/2, 26, { align: 'center' });

                    // Slogan dengan warna oranye
                    doc.setTextColor(246, 185, 59);
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(10);
                    doc.text('"Situbondo Naik Kelas"', pageWidth/2, 32, { align: 'center' });

                    // Garis bawah header dengan warna aksen
                    doc.setDrawColor(246, 185, 59);
                    doc.setLineWidth(1.5);
                    doc.line(20, 38, pageWidth - 20, 38);

                    // Judul Laporan dengan informasi filter
                    doc.setTextColor(12, 36, 97);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.text('TABEL DATA NELAYAN TERFILTER', pageWidth/2, 48, { align: 'center' });
                    
                    // Informasi filter yang aktif
                    let filterInfo = "Semua Data";
                    if (Object.keys(currentFilter).length > 0 || document.getElementById('searchData').value) {
                        filterInfo = "Data Terfilter: ";
                        const filterParts = [];
                        
                        if (currentFilter.desa) filterParts.push(`Desa: ${currentFilter.desa}`);
                        if (currentFilter.profesi) filterParts.push(`Profesi: ${currentFilter.profesi}`);
                        if (currentFilter.status) filterParts.push(`Status: ${currentFilter.status}`);
                        if (currentFilter.jenisKapal) filterParts.push(`Jenis Kapal: ${currentFilter.jenisKapal}`);
                        if (currentFilter.alatTangkap) filterParts.push(`Alat Tangkap: ${currentFilter.alatTangkap}`);
                        if (currentFilter.usaha) filterParts.push(`Usaha: ${currentFilter.usaha === 'Ada' ? 'Ada Usaha Sampingan' : 'Tidak Ada Usaha'}`);
                        if (document.getElementById('searchData').value) filterParts.push(`Pencarian: "${document.getElementById('searchData').value}"`);
                        
                        filterInfo += filterParts.join(', ');
                    }
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(filterInfo, pageWidth/2, 54, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DETAIL DATA NELAYAN', pageWidth/2, 60, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const now = new Date();
                    const dateString = now.toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric'});
                    doc.text(`Dicetak pada: ${dateString}`, pageWidth/2, 66, { align: 'center' });

                    // Tabel Data dengan kolom sesuai permintaan
                    const tableWidth = pageWidth - 40;
                    const tableStartX = (pageWidth - tableWidth) / 2;

                    doc.autoTable({
                        head: [[
                            {content: 'No', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 15}},
                            {content: 'Nama', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 40}},
                            {content: 'Nomor HP', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'NIK', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 40}},
                            {content: 'Desa', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Kecamatan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Status', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 25}},
                            {content: 'Nama Perahu', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Tanggal Validasi', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Kode Validasi', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 35}},
                            {content: 'Keterangan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 40}}
                        ]],
                        body: tableRows,
                        startY: 72,
                        theme: 'grid',
                        tableWidth: tableWidth,
                        margin: { left: tableStartX, right: tableStartX },
                        headStyles: { 
                            fillColor: [12, 36, 97],
                            textColor: [255, 255, 255], 
                            fontStyle: 'bold', 
                            halign: 'center',
                            fontSize: 8,
                            cellPadding: 3,
                            lineWidth: 0.5,
                            lineColor: [255, 255, 255]
                        },
                        bodyStyles: {
                            textColor: [0, 0, 0],
                            fontSize: 7,
                            fillColor: [255, 255, 255],
                            cellPadding: 3,
                            lineWidth: 0.1,
                            lineColor: [200, 200, 200]
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        styles: {
                            overflow: 'linebreak',
                            cellPadding: 3,
                            fontSize: 7,
                            valign: 'middle',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: {cellWidth: 15, halign: 'center'},
                            1: {cellWidth: 40, halign: 'left'},
                            2: {cellWidth: 30, halign: 'center'},
                            3: {cellWidth: 40, halign: 'center'},
                            4: {cellWidth: 30, halign: 'center'},
                            5: {cellWidth: 30, halign: 'center'},
                            6: {cellWidth: 25, halign: 'center'},
                            7: {cellWidth: 30, halign: 'center'},
                            8: {cellWidth: 30, halign: 'center'},
                            9: {cellWidth: 35, halign: 'center'},
                            10: {cellWidth: 40, halign: 'left'}
                        }
                    });

                    // Footer
                    const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 150;
                    const footerY = Math.min(finalY + 15, pageHeight - 50);
                    
                    // Garis pemisah
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(20, footerY, pageWidth - 20, footerY);
                    
                    // Bagian kiri: Validasi elektronik
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.setTextColor(12, 36, 97);
                    
                    const leftX = 25;
                    const leftY = footerY + 8;
                    
                    doc.text("DOKUMEN INI TELAH DIVALIDASI", leftX, leftY);
                    doc.text("SECARA ELEKTRONIK OLEH", leftX, leftY + 4);
                    doc.text("SISTEM SATU DATA NELAYAN (SIMATA)", leftX, leftY + 8);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text("Dinas Perikanan Kabupaten Situbondo", leftX, leftY + 14);
                    doc.setTextColor(230, 126, 34);
                    doc.text("www.dinasperikanansitubondo.com/simata", leftX, leftY + 18);
                    
                    // Bagian kanan: Tanda tangan dan QR Code
                    const rightX = pageWidth - 85;
                    const rightY = footerY + 5;
                    
                    // Tanggal
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    const currentDate = new Date();
                    const formattedDate = currentDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year:'numeric'});
                    doc.text(`Situbondo, ${formattedDate}`, rightX + 32, rightY, {align: 'center'});
                    
                    // Jabatan
                    doc.text('Kepala Bidang Pemberdayaan Nelayan', rightX + 32, rightY + 6, {align: 'center'});
                    
                    // QR Code dengan warna biru muda
                    const qrRightCanvas = document.querySelector('#qr-right canvas');
                    if(qrRightCanvas) {
                        try {
                            const imgRight = qrRightCanvas.toDataURL("image/png");
                            // QR code 25x25 mm
                            doc.addImage(imgRight, 'PNG', rightX + 19, rightY + 10, 25, 25);
                        } catch (error) {
                            console.error("Error adding QR code image:", error);
                        }
                    }
                    
                    // Garis tanda tangan
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.line(rightX + 5, rightY + 40, rightX + 60, rightY + 40);
                    
                    // Nama dan NIP
                    const nameY = rightY + 45;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', rightX + 32, nameY, {align: 'center'});
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text('NIP. 19761103 200903 1 001', rightX + 32, nameY + 5, {align: 'center'});

                    // Footer dengan kode unik
                    const totalPages = doc.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(`Halaman ${i} dari ${totalPages}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
                        
                        // Informasi sistem di footer dengan kode unik
                        doc.setFontSize(7);
                        const printTime = new Date().toLocaleString('id-ID');
                        doc.text(`Dicetak dari SIMATA v5.5 - ${printTime} | ID Dokumen: ${printId}`, pageWidth / 2, pageHeight - 7, { align: 'center' });
                        doc.text(`Total Data Tabel: ${filteredData.length} records`, pageWidth / 2, pageHeight - 2, { align: 'center' });
                    }

                    // Simpan file PDF
                    const fileName = `Tabel_Data_Nelayan_${appSettings.appSubtitle.replace(/\s+/g, '_').slice(0,15)}_${Date.now()}.pdf`;
                    doc.save(fileName);
                    document.getElementById('qr-right').innerHTML = "";
                    
                    showNotification(`Tabel PDF data nelayan berhasil dibuat (${filteredData.length} data)`, 'success');
                    
                } catch (error) {
                    console.error("Error generating table PDF:", error);
                    showNotification('Gagal membuat tabel PDF. Silakan coba lagi atau periksa konsol browser.', 'error');
                }
            }, 800);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                setupEventListeners();
                
                displayCurrentDate();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalValidasi').value = today;
                
                const isSessionActive = sessionStorage.getItem('simata_session') === 'active';
                if (isSessionActive) {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                } else {
                    setTimeout(() => {
                        document.getElementById('loginModal').style.display = 'flex';
                    }, 100);
                }

                if (typeof window.handleHashRouting === 'function') {
                    window.handleHashRouting();
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                alert("Terjadi kesalahan sistem saat memuat. Silakan refresh.");
            }
        });

        function initializeApp() {
            loadData();
            loadSettings();
            migrateOldData();
            
            if (typeof window.SIMATA_BACKUP_ENCRYPTED !== 'undefined' && window.SIMATA_BACKUP_ENCRYPTED) {
                console.log("Reload Repository detected. Ready to merge/sync.");
            }

            // Inisialisasi dropdown kecamatan
            const kecSelect = document.getElementById('kecamatan');
            kecSelect.innerHTML = `<option value="">Pilih Kecamatan</option>`;
            if (typeof SITUBONDO_DATA !== 'undefined') {
                Object.keys(SITUBONDO_DATA).sort().forEach(kec => kecSelect.add(new Option(kec, kec)));
            }
            
            // Inisialisasi dropdown filter desa
            const allDesas = new Set();
            if (typeof SITUBONDO_DATA !== 'undefined') {
                Object.values(SITUBONDO_DATA).forEach(list => list.forEach(d => allDesas.add(d)));
            }
            const filterDesaSelect = document.getElementById('filterDesa');
            filterDesaSelect.innerHTML = `<option value="">Semua Desa</option>`;
            [...allDesas].sort().forEach(d => filterDesaSelect.add(new Option(d, d)));
            
            // Inisialisasi dropdown filter alat tangkap
            const filterAlatTangkap = document.getElementById('filterAlatTangkap');
            filterAlatTangkap.innerHTML = `<option value="">Semua</option>`;
            Object.keys(API_INFO).forEach(api => filterAlatTangkap.add(new Option(api, api)));
            
            // Inisialisasi dropdown filter jenis kapal
            const filterJenisKapal = document.getElementById('filterJenisKapal');
            filterJenisKapal.innerHTML = `<option value="">Semua</option>`;
            Object.keys(KAPAL_INFO).forEach(kapal => filterJenisKapal.add(new Option(kapal, kapal)));
            
            // Inisialisasi dropdown jenis kapal di form input
            const jenisKapalSelect = document.getElementById('jenisKapal');
            jenisKapalSelect.innerHTML = '<option value="">Pilih Jenis...</option>';
            Object.keys(KAPAL_INFO).forEach(kapal => {
                jenisKapalSelect.add(new Option(kapal, kapal));
            });
            
            // Inisialisasi dropdown alat tangkap di form input
            const alatTangkapSelect = document.getElementById('alatTangkap');
            alatTangkapSelect.innerHTML = '<option value="">Pilih Alat Penangkapan Ikan...</option>';
            Object.keys(API_INFO).forEach(api => {
                alatTangkapSelect.add(new Option(api, api));
            });
            
            updateAppIdentity();
            updatePrivacyUI();
            startDuplicateChecker();
            setupInfoTooltips();
            setupProfesiInfo();
            
            // Inisialisasi daftar ikan
            updateFishOptionsByAPI('');
        }

        function setupInfoTooltips() {
            const alatTangkapSelect = document.getElementById('alatTangkap');
            const apiInfoDiv = document.getElementById('apiInfo');
            
            alatTangkapSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && API_INFO[selected]) {
                    apiInfoDiv.style.display = 'block';
                    apiInfoDiv.innerHTML = `<strong>${selected}:</strong> ${API_INFO[selected]}`;
                    updateFishOptionsByAPI(selected);
                } else {
                    apiInfoDiv.style.display = 'none';
                    updateFishOptionsByAPI('');
                }
            });

            const jenisKapalSelect = document.getElementById('jenisKapal');
            const kapalInfoDiv = document.getElementById('kapalInfo');
            
            jenisKapalSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && KAPAL_INFO[selected]) {
                    kapalInfoDiv.style.display = 'block';
                    kapalInfoDiv.innerHTML = `<strong>${selected}:</strong> ${KAPAL_INFO[selected]}`;
                    updateAlatTangkapByKapal();
                } else {
                    kapalInfoDiv.style.display = 'none';
                    document.getElementById('apiMappingInfo').style.display = 'none';
                }
            });
        }

        function setupProfesiInfo() {
            const profesiSelect = document.getElementById('profesi');
            const profesiHelp = document.getElementById('profesiHelp');
            
            profesiSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && PROFESI_INFO[selected]) {
                    profesiHelp.innerHTML = `
                        <div class="profesi-info-box">
                            <div class="profesi-info-title">${selected}</div>
                            <div class="profesi-info-desc">${PROFESI_INFO[selected]}</div>
                        </div>
                    `;
                } else {
                    profesiHelp.innerHTML = '';
                }
            });
        }

        function updateAppIdentity() {
            appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.getElementById('dynamicSubtitle').textContent = appSettings.appSubtitle;
            document.getElementById('itemsPerPageSelect').value = appSettings.itemsPerPage;
            document.getElementById('appName').value = appSettings.appName;
            document.getElementById('appSubtitle').value = appSettings.appSubtitle;
        }

        function updatePrivacyUI() {
            const toggle = document.getElementById('privacyToggle');
            const status = document.getElementById('privacyStatus');
            const sensorText = document.getElementById('sensorStatusText');
            
            toggle.checked = appSettings.privacyMode;
            if(appSettings.privacyMode) {
                status.innerHTML = "Status: <span class='text-success'>Sensor Aktif (Aman)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: ON";
                sensorText.className = "badge bg-success me-2";
            } else {
                status.innerHTML = "Status: <span class='text-danger'>Sensor Non-Aktif (Terbuka)</span>";
                status.className = "mt-2 small fw-bold";
                sensorText.innerHTML = "Sensor: OFF";
                sensorText.className = "badge bg-danger me-2";
            }
        }

        // --- EVENT LISTENERS YANG DISEMPURNAKAN ---
        function setupEventListeners() {
            // Password Toggle
            const passwordToggle = document.getElementById('passwordToggle');
            if (passwordToggle) {
                passwordToggle.addEventListener('click', function() {
                    const passwordInput = document.getElementById('securityCode');
                    const icon = document.getElementById('passwordToggleIcon');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        this.title = "Sembunyikan kode";
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        this.title = "Lihat kode";
                    }
                });
            }

            // Login Form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginButton');
                const spinner = document.getElementById('loginSpinner');
                const inputCode = document.getElementById('securityCode').value;
                const correctCode = generateSecurityCode();
                
                if (inputCode !== correctCode) {
                    showNotification('Kode keamanan salah! Periksa kembali atau hubungi administrator.', 'error');
                    return;
                }
                
                btn.disabled = true;
                spinner.classList.remove('d-none');
                btn.innerHTML = 'MEMBUKA SISTEM... <span class="spinner-border spinner-border-sm ms-2"></span>';
                
                setTimeout(() => {
                    sessionStorage.setItem('simata_session', 'active');
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                    loginSuccessModal.show();
                    btn.disabled = false;
                    spinner.classList.add('d-none');
                    btn.innerHTML = 'BUKA DASHBOARD';
                }, 1200);
            });

            // Continue to Dashboard
            document.getElementById('btnContinueDashboard').addEventListener('click', function() {
                loginSuccessModal.hide();
                setTimeout(() => {
                    welcomeModal.show();
                }, 300);
            });

            // Welcome Modal Reload
            document.getElementById('btnWelcomeReload').addEventListener('click', function() {
                welcomeModal.hide();
                handleReloadRepo();
            });

            // No WhatsApp Button
            document.getElementById('btnNoWA').addEventListener('click', function() {
                const input = document.getElementById('whatsapp');
                if (input.hasAttribute('readonly')) {
                    input.removeAttribute('readonly');
                    input.value = '';
                    input.setAttribute('required', 'required');
                    this.classList.remove('active', 'btn-secondary');
                    this.classList.add('btn-outline-secondary');
                    this.textContent = "Tidak Ada";
                } else {
                    input.value = '00000000';
                    input.setAttribute('readonly', true);
                    input.removeAttribute('required'); 
                    this.classList.add('active', 'btn-secondary');
                    this.classList.remove('btn-outline-secondary');
                    this.textContent = "Batal";
                }
            });

            // Privacy Toggle
            document.getElementById('privacyToggle').addEventListener('click', function(e) {
                e.preventDefault();
                const currentStatus = appSettings.privacyMode;
                
                if (currentStatus === true) {
                    const code = prompt("MASUKKAN KODE KEAMANAN SENSOR untuk menonaktifkan sensor:");
                    if (code === appSettings.securityCodeSensor) {
                        appSettings.privacyMode = false;
                        saveSettings(); 
                        updatePrivacyUI(); 
                        renderDataTable();
                        showNotification('Sensor Data dinonaktifkan.', 'warning');
                    } else { 
                        alert("Kode Keamanan Sensor Salah!"); 
                        this.checked = true;
                    }
                } else {
                    appSettings.privacyMode = true;
                    saveSettings(); 
                    updatePrivacyUI(); 
                    renderDataTable();
                    showNotification('Sensor Data diaktifkan.', 'success');
                }
            });

            // Kecamatan Change
            document.getElementById('kecamatan').addEventListener('change', function() {
                const selectedKec = this.value;
                const desaSelect = document.getElementById('desa');
                desaSelect.innerHTML = `<option value="">Pilih Desa / Kelurahan</option>`;
                if (selectedKec && SITUBONDO_DATA && SITUBONDO_DATA[selectedKec]) {
                    desaSelect.disabled = false;
                    SITUBONDO_DATA[selectedKec].sort().forEach(desa => desaSelect.add(new Option(desa, desa)));
                } else {
                    desaSelect.disabled = true;
                    desaSelect.innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
                }
            });

            // Form Submit
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            
            // Form Reset
            document.getElementById('inputForm').addEventListener('reset', () => {
                setTimeout(() => {
                    document.getElementById('ownerFields').style.display = 'none';
                    document.getElementById('usia').value = '';
                    document.getElementById('desa').disabled = true;
                    document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
                    document.getElementById('inputForm').removeAttribute('data-edit-id');
                    document.getElementById('jenisIkanLainnya').style.display = 'none';
                    const kv = document.getElementById('kodeValidasi');
                    kv.value = '';
                    kv.removeAttribute('readonly'); 
                    const waInput = document.getElementById('whatsapp');
                    waInput.removeAttribute('readonly');
                    const btnWa = document.getElementById('btnNoWA');
                    btnWa.classList.remove('active', 'btn-secondary');
                    btnWa.classList.add('btn-outline-secondary');
                    btnWa.textContent = "Tidak Ada";
                    document.getElementById('apiInfo').style.display = 'none';
                    document.getElementById('kapalInfo').style.display = 'none';
                    document.getElementById('profesiHelp').innerHTML = '';
                    document.getElementById('apiMappingInfo').style.display = 'none';
                    
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('tanggalValidasi').value = today;
                    
                    // Reset daftar ikan ke semua opsi
                    updateFishOptionsByAPI('');
                }, 100);
            });
            
            // Status Nelayan Change
            document.getElementById('statusNelayan').addEventListener('change', function() {
                const isOwner = this.value === 'Pemilik Kapal';
                const ownerFields = document.getElementById('ownerFields');
                ownerFields.style.display = isOwner ? 'block' : 'none';
                if(!isOwner) {
                    document.getElementById('namaKapal').value = '';
                    document.getElementById('jenisKapal').value = '';
                    document.getElementById('kapalInfo').style.display = 'none';
                    document.getElementById('apiMappingInfo').style.display = 'none';
                }
            });

            // Tahun Lahir Input
            document.getElementById('tahunLahir').addEventListener('input', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                if(year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                    document.getElementById('usia').value = currentYear - year;
                }
            });

            // Generate Kode Button
            document.getElementById('generateKodeBtn').addEventListener('click', function() {
                const nik = document.getElementById('nik').value;
                const kodeInput = document.getElementById('kodeValidasi');
                if (kodeInput.value && kodeInput.value.trim() !== '') {
                    showNotification('Kode Validasi sudah digenerate dan bersifat permanen!', 'warning');
                    return;
                }
                if(nik.length !== 16) {
                    return showNotification('Isi NIK 16 digit terlebih dahulu!', 'error');
                }
                const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
                kodeInput.value = 'VLD-' + randomPart;
                showNotification('Kode Validasi berhasil dibuat dan terkunci.', 'success');
            });

            // Verifikasi KIN
            document.getElementById('verifyBtn').addEventListener('click', function() {
                const input = document.getElementById('verifyInput').value;
                if (!input || input.trim() === '') {
                    showNotification('Masukkan Kode Validasi (KIN) atau NIK untuk verifikasi', 'warning');
                    return;
                }
                
                const result = verifyKIN(input);
                displayVerifyResult(result);
            });

            // Mobile Menu
            const overlay = document.getElementById('sidebarOverlay');
            const sidebar = document.getElementById('sidebarMenu');
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                sidebar.classList.add('mobile-show');
                overlay.classList.add('active');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('mobile-show');
                overlay.classList.remove('active');
            });
            document.querySelectorAll('#sidebarMenu .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('mobile-show');
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // Logout
            document.getElementById('v-pills-logout-tab').addEventListener('click', () => {
                if(confirm('Apakah Anda yakin ingin keluar? Sistem akan mengunduh data (reload.js) secara otomatis.')) {
                    sessionStorage.removeItem('simata_session');
                    backupData('reload.js');
                    setTimeout(() => location.reload(), 2000);
                }
            });

            // Search and Filter
            document.getElementById('searchData').addEventListener('input', function() {
                currentPage = 1; // Reset ke halaman pertama saat mencari
                renderDataTable();
            });
            
            // Filter & Validasi Data - DIPERBAIKI DAN DIPINDAHKAN
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            document.getElementById('resetFilterBtn').addEventListener('click', resetFilter);
            document.getElementById('btnCekGanda').addEventListener('click', showDuplicateDataInFilter);
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                toggleBulkDeleteBtn();
            });
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteData);
            
            // Download PDF Terfilter
            document.getElementById('btnUnduhFilteredPdf').addEventListener('click', generateFilteredPdf);
            // Download Tabel PDF (Fitur Baru)
            document.getElementById('btnUnduhTablePdf').addEventListener('click', generateTablePdf);

            // Print and Export
            document.getElementById('printPdfBtn').addEventListener('click', printData);
            document.getElementById('exportExcelBtn').addEventListener('click', () => exportData('xlsx'));
            document.getElementById('exportReloadJsBtn').addEventListener('click', () => backupData('reload.js'));
            document.getElementById('sendWaBtn').addEventListener('click', sendDataToWhatsapp);
            document.getElementById('backupDataBtn').addEventListener('click', () => backupData());
            document.getElementById('restoreFileInput').addEventListener('change', function() {
                document.getElementById('restoreDataBtn').disabled = !this.files.length;
            });
            document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
            
            // Event listener untuk tombol Reload Data yang sudah diperbaiki
            document.getElementById('btn-reload-repo').addEventListener('click', handleReloadRepo);
            
            // Detail PDF
            document.getElementById('btnDownloadDetailPdf').addEventListener('click', () => {
                downloadSinglePdf(currentDetailId);
            });

            // Settings Form
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
                appSettings.appSubtitle = document.getElementById('appSubtitle').value;
                appSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value);
                saveSettings(); 
                updateAppIdentity(); 
                renderDataTable();
                showNotification('Pengaturan tersimpan! Nama instansi berhasil diperbarui.', 'success');
            });

            // Sensor Code Form
            document.getElementById('sensorCodeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const currentCode = document.getElementById('currentSensorCode').value;
                const newCode = document.getElementById('newSensorCode').value;
                const confirmCode = document.getElementById('confirmSensorCode').value;
                
                if (currentCode !== appSettings.securityCodeSensor) {
                    showNotification('Kode keamanan sensor saat ini salah!', 'error');
                    return;
                }
                
                if (newCode.length < 6) {
                    showNotification('Kode keamanan baru minimal 6 digit!', 'error');
                    return;
                }
                
                if (newCode !== confirmCode) {
                    showNotification('Konfirmasi kode baru tidak cocok!', 'error');
                    return;
                }
                
                appSettings.securityCodeSensor = newCode;
                saveSettings();
                document.getElementById('currentSensorCode').value = '';
                document.getElementById('newSensorCode').value = '';
                document.getElementById('confirmSensorCode').value = '';
                showNotification('Kode keamanan sensor berhasil diperbarui!', 'success');
            });

            setupFloatingMenu();
        }

        function setupFloatingMenu() {
            const fabMain = document.getElementById('fabMainBtn');
            const container = document.getElementById('fabMenu');
            fabMain.addEventListener('click', () => {
                container.classList.toggle('open');
                const icon = fabMain.querySelector('i');
                if(container.classList.contains('open')){
                    icon.classList.remove('fa-plus'); icon.classList.add('fa-times');
                    fabMain.style.transform = "rotate(90deg)";
                } else {
                    icon.classList.add('fa-plus'); icon.classList.remove('fa-times');
                    fabMain.style.transform = "rotate(0deg)";
                }
            });
            
            const shortcuts = {
                'fabInput': 'v-pills-input-tab', 
                'fabFilter': 'v-pills-filter-tab',
                'fabVerify': 'v-pills-verify-tab',
                'fabExport': 'v-pills-export-tab', 
                'fabBackup': 'v-pills-backup-tab', 
                'fabSettings': 'v-pills-settings-tab'
            };
            
            for (const [id, tabId] of Object.entries(shortcuts)) {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault(); 
                    document.getElementById(tabId).click(); 
                    container.classList.remove('open');
                });
            }
            
            document.getElementById('fabReload').addEventListener('click', (e) => {
                e.preventDefault(); 
                handleReloadRepo();
            });
        }

        // --- CORE LOGIC FUNCTIONS ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('inputForm');
            const kodeVal = document.getElementById('kodeValidasi').value;
            if (!kodeVal || kodeVal.trim() === '') {
                showNotification('Anda WAJIB melakukan GENERATE KODE VALIDASI terlebih dahulu!', 'error');
                document.getElementById('generateKodeBtn').focus();
                return;
            }
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.reportValidity(); 
                return;
            }

            const nik = document.getElementById('nik').value;
            const whatsapp = document.getElementById('whatsapp').value;
            if(nik.length !== 16) return showNotification('NIK harus 16 digit', 'error');
            if(!whatsapp.match(/^\d+$/)) return showNotification('WhatsApp hanya angka', 'error');

            let selectedFish = [];
            document.querySelectorAll('.fish-checkbox:checked').forEach(cb => {
                if(cb.value === "Lainnya") {
                    const otherVal = document.getElementById('jenisIkanLainnya').value.trim();
                    if(otherVal) selectedFish.push(otherVal);
                } else {
                    selectedFish.push(cb.value);
                }
            });
            if(selectedFish.length === 0) return showNotification('Pilih minimal satu jenis ikan!', 'error');

            const editId = form.getAttribute('data-edit-id');
            const duplicateCheck = appData.find(d => d.nik === nik);
            if (duplicateCheck && (!editId || duplicateCheck.id != editId)) {
                return showNotification('GAGAL: NIK sudah terdaftar dalam sistem!', 'error');
            }

            const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
            const formData = {
                id: editId || Date.now(),
                nama: document.getElementById('nama').value,
                nik: nik,
                whatsapp: whatsapp,
                profesi: document.getElementById('profesi').value,
                status: document.getElementById('statusNelayan').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                usia: document.getElementById('usia').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alatTangkap: document.getElementById('alatTangkap').value,
                namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                jenisIkan: selectedFish.join(", "),
                usahaSampingan: document.getElementById('usahaSampingan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value
            };

            if (editId) {
                const index = appData.findIndex(item => item.id == editId);
                appData[index] = formData;
                form.removeAttribute('data-edit-id');
                showNotification('Data berhasil diperbarui', 'success');
            } else {
                appData.push(formData);
                showNotification('Data berhasil disimpan', 'success');
            }

            saveData();
            form.reset();
            document.getElementById('ownerFields').style.display = 'none';
            document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
            document.getElementById('desa').disabled = true;
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalValidasi').value = today;
            
            document.getElementById('apiInfo').style.display = 'none';
            document.getElementById('kapalInfo').style.display = 'none';
            document.getElementById('profesiHelp').innerHTML = '';
            document.getElementById('apiMappingInfo').style.display = 'none';

            updateDashboard(); 
            renderDataTable();
            document.getElementById('v-pills-data-tab').click();
            checkGlobalDuplicates();
        }

        function viewDetail(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;
            currentDetailId = id;
            document.getElementById('d_nama').innerText = d.nama;
            document.getElementById('d_nik').innerText = d.nik; 
            document.getElementById('d_usia').innerText = `${d.usia} Tahun (${d.tahunLahir})`;
            document.getElementById('d_wa').innerText = d.whatsapp;
            document.getElementById('d_domisili').innerText = `${d.desa}, ${d.kecamatan}`;
            
            const profBadge = document.getElementById('d_profesi');
            profBadge.innerText = d.profesi;
            
            let badgeClass = 'bg-primary';
            if(d.profesi === 'Nelayan Penuh Waktu') badgeClass = 'badge-profesi-penuh';
            else if(d.profesi === 'Nelayan Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
            else if(d.profesi === 'Nelayan Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
            profBadge.className = `badge ${badgeClass}`;

            document.getElementById('d_status').innerText = d.status;
            document.getElementById('d_alatTangkap').innerText = d.alatTangkap;
            document.getElementById('d_usaha').innerText = d.usahaSampingan || '-';
            
            const fishContainer = document.getElementById('d_ikan');
            fishContainer.innerHTML = '';
            if(d.jenisIkan) {
                d.jenisIkan.split(', ').forEach(fish => {
                    const iconClass = getFishIconClass(fish);
                    fishContainer.innerHTML += `<span class="badge bg-light text-dark border me-1 mb-1"><i class="fas ${iconClass} me-1"></i>${fish}</span>`;
                });
            }
            if(d.status === 'Pemilik Kapal') {
                document.getElementById('d_kapal_card').style.display = 'block';
                document.getElementById('d_namaKapal').innerText = d.namaKapal;
                document.getElementById('d_jenisKapal').innerText = d.jenisKapal;
            } else {
                document.getElementById('d_kapal_card').style.display = 'none';
            }
            document.getElementById('d_tgl_valid').innerText = d.tanggalValidasi;
            document.getElementById('d_validator').innerText = d.validator;
            detailModal.show();
        }

        function downloadSinglePdf(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;

            document.getElementById('qr-right').innerHTML = "";
            const signatureText = `DOKUMEN SAH\nNama: SUGENG PURWO PRIYANTO, S.E, M.M\nJabatan: Kabid Pemberdayaan Nelayan\nRef: ${d.kodeValidasi || 'N/A'}`;
            new QRCode(document.getElementById("qr-right"), { 
                text: signatureText, width: 256, height: 256,
                colorDark: "#0984e3",
                colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.M
            });

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'a4' });
                
                doc.setDrawColor(12, 36, 97);
                doc.setLineWidth(1);
                doc.rect(10, 10, 190, 277);

                doc.setFillColor(12, 36, 97);
                doc.rect(10, 10, 190, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(appSettings.appName.toUpperCase(), 105, 22, { align: 'center' });
                doc.setFontSize(16);
                doc.text('DINAS PERIKANAN', 105, 29, { align: 'center' });
                doc.setTextColor(246, 185, 59);
                doc.setFont('times', 'italic'); doc.setFontSize(12);
                doc.text('"Situbondo Naik Kelas"', 105, 37, { align: 'center' });
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text(appSettings.appSubtitle, 105, 45, { align: 'center' });
                
                doc.setTextColor(0, 0, 0); doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
                doc.text('BIODATA NELAYAN TERDAFTAR', 105, 65, { align: 'center' });
                doc.setLineWidth(0.5); doc.line(70, 68, 140, 68);

                let y = 80;
                const lineHeight = 7;
                
                const checkPage = (heightNeeded) => {
                    if (y + heightNeeded > 250) { 
                        doc.addPage();
                        doc.setDrawColor(12, 36, 97); doc.setLineWidth(1); doc.rect(10, 10, 190, 277);
                        y = 30; 
                    }
                };

                const printLine = (label, value) => {
                    checkPage(lineHeight);
                    doc.setFont('helvetica', 'normal'); doc.text(label, 25, y);
                    doc.setFont('helvetica', 'bold'); 
                    
                    if (label === 'Domisili' || value.length > 50) {
                        const splitText = doc.splitTextToSize(': ' + value, 110);
                        doc.text(splitText, 80, y);
                        y += (splitText.length * 6);
                    } else {
                        doc.text(': ' + value, 80, y);
                        y += lineHeight;
                    }
                };

                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('I. IDENTITAS PRIBADI', 22, y); y += 12;
                
                doc.setFontSize(10);
                printLine('Nama Lengkap', d.nama);
                printLine('NIK', d.nik);
                printLine('Tempat / Tgl Lahir', `${d.tahunLahir} (Usia: ${d.usia} Thn)`);
                printLine('Domisili', `${d.desa}, ${d.kecamatan}`);
                printLine('No. Handphone', d.whatsapp);
                y += 8;

                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('II. PROFESI & EKONOMI', 22, y); y += 12;

                doc.setFontSize(10);
                printLine('Status Profesi', d.profesi);
                printLine('Posisi Kerja', d.status);
                printLine('Alat Penangkapan Ikan (API)', d.alatTangkap);
                printLine('Usaha Sampingan', d.usahaSampingan || '-');
                y += 8;

                checkPage(30);
                doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                doc.rect(20, y-4, 170, 6, 'F');
                doc.text('III. JENIS IKAN TANGKAPAN UTAMA', 22, y); y += 12;

                doc.setFontSize(10);
                const fishList = d.jenisIkan ? d.jenisIkan.split(', ') : [];
                fishList.forEach((fish, idx) => {
                    printLine(`Ikan ${idx + 1}`, fish);
                });
                y += 8;

                if(d.status === 'Pemilik Kapal') {
                    checkPage(30);
                    doc.setFontSize(11); doc.setFillColor(230, 230, 230);
                    doc.rect(20, y-4, 170, 6, 'F');
                    doc.text('IV. DATA ASET KAPAL', 22, y); y += 12;

                    doc.setFontSize(10);
                    printLine('Nama Kapal', d.namaKapal);
                    printLine('Jenis Kapal', d.jenisKapal);
                }

                if(y > 210) doc.addPage();

                const footerY = 230; 
                const sigCenterX = 150; 
                const leftX = 25;

                doc.setDrawColor(150);
                doc.setLineWidth(0.5);
                doc.rect(leftX, footerY, 70, 30);
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text("DOKUMEN INI TELAH DIVALIDASI", leftX + 35, footerY + 6, {align: 'center'});
                doc.text("SECARA ELEKTRONIK OLEH", leftX + 35, footerY + 10, {align: 'center'});
                doc.text("SISTEM SATU DATA (SIMATA)", leftX + 35, footerY + 14, {align: 'center'});
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text("Dinas Perikanan Kabupaten Situbondo", leftX + 35, footerY + 20, {align: 'center'});
                doc.setTextColor(0, 0, 255);
                doc.text("www.dinasperikanansitubondo.com/simata", leftX + 35, footerY + 25, {align: 'center'});

                doc.setFontSize(10); doc.setTextColor(0,0,0); doc.setFont('helvetica', 'normal');
                const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                doc.text(`Situbondo, ${dateStr}`, sigCenterX, footerY - 5, {align: 'center'});
                doc.text('Diketahui Oleh :', sigCenterX, footerY, {align: 'center'});
                doc.setFont('helvetica', 'bold');
                doc.text('Kepala Bidang Pemberdayaan Nelayan', sigCenterX, footerY + 5, {align: 'center'});

                const qrRightCanvas = document.querySelector('#qr-right canvas');
                if(qrRightCanvas) {
                    const imgRight = qrRightCanvas.toDataURL("image/png");
                    doc.addImage(imgRight, 'PNG', sigCenterX - 12.5, footerY + 8, 25, 25); 
                }

                const nameY = footerY + 38; 
                doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', sigCenterX, nameY, {align: 'center'});
                doc.setFont('helvetica', 'normal');
                doc.text('NIP. 19761103 200903 1 001', sigCenterX, nameY + 5, {align: 'center'});

                doc.setFontSize(7); doc.setTextColor(150);
                doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')} | Ref ID: ${d.kodeValidasi || '-'}`, 105, 285, {align:'center'});

                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`Dokumen ini saling berhubungan - Halaman ${i} dari ${totalPages}`, 105, 292, { align: 'center' });
                }

                doc.save(`${d.nama}_${d.nik}.pdf`);
                document.getElementById('qr-right').innerHTML = "";

            }, 500);
        }

        function toggleBulkDeleteBtn() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length > 0;
            const btn = document.getElementById('bulkDeleteBtn');
            if(checked) btn.classList.remove('d-none'); else btn.classList.add('d-none');
        }

        function bulkDeleteData() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if(checkedBoxes.length === 0) return;
            
            const userCode = prompt(`Anda akan menghapus ${checkedBoxes.length} data.\nMasukkan KODE KEAMANAN SENSOR:`);
            if(userCode === appSettings.securityCodeSensor) {
                const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
                appData = appData.filter(d => !idsToDelete.includes(d.id.toString()));
                saveData(); 
                currentPage = 1; // Reset ke halaman pertama setelah menghapus
                renderDataTable(); 
                updateDashboard();
                showNotification(`${idsToDelete.length} data berhasil dihapus`, 'success');
                document.getElementById('selectAllCheckbox').checked = false;
                checkGlobalDuplicates();
            } else if (userCode !== null) alert("Kode keamanan sensor SALAH!");
        }

        function editData(id) {
            const d = appData.find(item => item.id == id);
            if(!d) return;
            const form = document.getElementById('inputForm');
            form.setAttribute('data-edit-id', id);
            
            ['nama', 'nik', 'whatsapp', 'profesi', 'tahunLahir', 'usia', 'alatTangkap', 'usahaSampingan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan']
             .forEach(key => document.getElementById(key).value = d[key] || '');

            const waInput = document.getElementById('whatsapp');
            const btnWa = document.getElementById('btnNoWA');
            if(d.whatsapp === '00000000') {
                waInput.setAttribute('readonly', true);
                waInput.removeAttribute('required');
                btnWa.classList.add('active', 'btn-secondary');
                btnWa.textContent = "Batal";
            } else {
                waInput.removeAttribute('readonly');
                waInput.setAttribute('required', 'required');
                btnWa.classList.remove('active', 'btn-secondary');
                btnWa.textContent = "Tidak Ada";
            }

            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('jenisIkanLainnya').value = '';
            
            // Set alat tangkap dan update daftar ikan
            document.getElementById('alatTangkap').value = d.alatTangkap;
            updateFishOptionsByAPI(d.alatTangkap);
            
            // Set ikan yang sudah dipilih setelah daftar diupdate
            setTimeout(() => {
                if(d.jenisIkan) {
                    const savedFish = d.jenisIkan.split(', ');
                    savedFish.forEach(fish => {
                        let found = false;
                        document.querySelectorAll('.fish-checkbox').forEach(cb => {
                            if(cb.value === fish) { 
                                cb.checked = true; 
                                found = true; 
                            }
                        });
                        if(!found) {
                            // Jika ikan tidak ada dalam daftar, maka tambahkan ke opsi "Lainnya"
                            const cbLain = document.getElementById('fish_Lainnya');
                            if (cbLain) {
                                cbLain.checked = true;
                                const inputLain = document.getElementById('jenisIkanLainnya');
                                inputLain.style.display = 'block';
                                inputLain.value = fish;
                            }
                        }
                    });
                }
            }, 100);

            const kecSelect = document.getElementById('kecamatan');
            kecSelect.value = d.kecamatan;
            kecSelect.dispatchEvent(new Event('change'));
            document.getElementById('desa').value = d.desa;

            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = d.status;
            statusSelect.dispatchEvent(new Event('change'));

            if(d.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal'].forEach(key => {
                    document.getElementById(key).value = d[key] || '';
                });
                
                if(d.jenisKapal && KAPAL_INFO[d.jenisKapal]) {
                    document.getElementById('kapalInfo').style.display = 'block';
                    document.getElementById('kapalInfo').innerHTML = `<strong>${d.jenisKapal}:</strong> ${KAPAL_INFO[d.jenisKapal]}`;
                    updateAlatTangkapByKapal();
                }
            }

            if(d.alatTangkap && API_INFO[d.alatTangkap]) {
                document.getElementById('apiInfo').style.display = 'block';
                document.getElementById('apiInfo').innerHTML = `<strong>${d.alatTangkap}:</strong> ${API_INFO[d.alatTangkap]}`;
            }

            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0,0);
        }

        function deleteData(id) {
            const userCode = prompt("Masukkan KODE KEAMANAN SENSOR untuk menghapus data:");
            if(userCode === appSettings.securityCodeSensor) {
                if(confirm('Yakin menghapus data ini secara permanen?')) {
                    appData = appData.filter(d => d.id != id);
                    saveData(); 
                    
                    // Periksa apakah halaman saat ini akan kosong setelah penghapusan
                    const totalItems = appData.length;
                    const totalPages = Math.ceil(totalItems / appSettings.itemsPerPage);
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = totalPages;
                    }
                    
                    renderDataTable(); 
                    updateDashboard();
                    showNotification('Data berhasil dihapus', 'success');
                    checkGlobalDuplicates();
                }
            } else if (userCode !== null) alert("Kode keamanan sensor SALAH!");
        }

        function startDuplicateChecker() {
            checkGlobalDuplicates();
            duplicateCheckInterval = setInterval(checkGlobalDuplicates, 15000);
        }

        function checkGlobalDuplicates() {
            const counts = {};
            let hasDuplicate = false;
            for (const d of appData) {
                counts[d.nik] = (counts[d.nik] || 0) + 1;
                if (counts[d.nik] > 1) { hasDuplicate = true; break; }
            }
            document.getElementById('duplicateWarning').style.display = hasDuplicate ? 'block' : 'none';
        }

        function initializeCharts() {
            const profesiCtx = document.getElementById('profesiChart').getContext('2d');
            const kapalCtx = document.getElementById('kapalChart').getContext('2d');

            if (window.profesiChart instanceof Chart) window.profesiChart.destroy();
            if (window.kapalChart instanceof Chart) window.kapalChart.destroy();

            window.profesiChart = new Chart(profesiCtx, {
                type: 'doughnut', 
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
            });

            window.kapalChart = new Chart(kapalCtx, {
                type: 'bar', 
                data: { labels: [], datasets: [] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });
            
            updateDashboard();
        }

        function updateDashboard() {
            if (!window.profesiChart || !window.kapalChart) return; 

            document.getElementById('totalPenerima').textContent = appData.length;
            const penuhWaktuCount = appData.filter(d => d.profesi === 'Nelayan Penuh Waktu').length;
            document.getElementById('totalPenuhWaktu').textContent = penuhWaktuCount;
            document.getElementById('totalPemilik').textContent = appData.filter(d => d.status === 'Pemilik Kapal').length;
            
            const sambilanUtamaCount = appData.filter(d => d.profesi === 'Nelayan Sambilan Utama').length;
            document.getElementById('totalSambilanUtama').textContent = sambilanUtamaCount;
            
            const sambilanTambahanCount = appData.filter(d => d.profesi === 'Nelayan Sambilan Tambahan').length;
            document.getElementById('totalSambilanTambahan').textContent = sambilanTambahanCount;
            
            const abkCount = appData.filter(d => d.status === 'Anak Buah Kapal').length;
            document.getElementById('totalABK').textContent = abkCount;

            const pData = {};
            appData.forEach(d => pData[d.profesi] = (pData[d.profesi] || 0) + 1);
            window.profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{ 
                    data: Object.values(pData), 
                    backgroundColor: ['#0c2461', '#e58e26', '#27ae60', '#4a69bd', '#f6b93b'] 
                }] 
            };
            window.profesiChart.update();

            const kData = {};
            appData.filter(d => d.status === 'Pemilik Kapal').forEach(d => kData[d.jenisKapal] = (kData[d.jenisKapal] || 0) + 1);
            window.kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{ label: 'Unit', data: Object.values(kData), backgroundColor: '#4a69bd' }]
            };
            window.kapalChart.update();
        }

        function saveData() { 
            localStorage.setItem('nelayanData', JSON.stringify(appData)); 
        }
        
        function saveSettings() { 
            appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
            localStorage.setItem('nelayanSettings', JSON.stringify(appSettings)); 
        }
        
        function loadData() { 
            const d = localStorage.getItem('nelayanData'); 
            if(d) appData = JSON.parse(d); 
        }
        
        function loadSettings() { 
            const s = localStorage.getItem('nelayanSettings'); 
            if(s) {
                const loadedSettings = JSON.parse(s);
                loadedSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
                if (!loadedSettings.securityCodeSensor) {
                    loadedSettings.securityCodeSensor = '987654321';
                }
                Object.assign(appSettings, loadedSettings);
            }
        }

        function exportData(type) {
            if(appData.length === 0) return showNotification('Tidak ada data', 'error');
            const dataToExport = appData.map(d => ({
                ...d, nik: maskData(d.nik), whatsapp: maskData(d.whatsapp)
            }));
            const finalData = dataToExport.map(d => ({ ...d, NIK: `'${d.nik}`, WhatsApp: `'${d.whatsapp}` }));
            if(type === 'xlsx') {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalData), "Data Nelayan");
                XLSX.writeFile(wb, `Nelayan_${appSettings.appSubtitle.slice(0,10)}_${Date.now()}.xlsx`);
                showNotification('Ekspor Excel berhasil.', 'success');
            }
        }

        function sendDataToWhatsapp() {
            const message = `Yth. Administrator Dinas Perikanan Kabupaten Situbondo,\n\nBerikut kami lampirkan data pembaruan Sistem Satu Data Nelayan dari:\n*${appSettings.appSubtitle}*\n\nTanggal Laporan: ${new Date().toLocaleDateString('id-ID')}\nTotal Data: ${appData.length} Records\n\nFile lampiran (reload.js) telah kami sertakan pada pesan ini untuk proses sinkronisasi data.\n\nTerima Kasih.`;
            const url = `https://wa.me/6287865614222?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function printData() {
            if (appData.length === 0) {
                showNotification('Tidak ada data untuk dicetak!', 'error');
                return;
            }

            // Hitung statistik per desa
            const desaStats = {};
            appData.forEach(d => {
                const desa = d.desa || "Tidak Diketahui";
                if (!desaStats[desa]) {
                    desaStats[desa] = { 
                        count: 0, 
                        owner: 0, 
                        abk: 0, 
                        penuhWaktu: 0, 
                        sambilanUtama: 0, 
                        sambilanTambahan: 0 
                    };
                }
                desaStats[desa].count++;
                if(d.status === 'Pemilik Kapal') desaStats[desa].owner++; 
                else desaStats[desa].abk++;
                
                if(d.profesi === 'Nelayan Penuh Waktu') desaStats[desa].penuhWaktu++;
                else if(d.profesi === 'Nelayan Sambilan Utama') desaStats[desa].sambilanUtama++;
                else if(d.profesi === 'Nelayan Sambilan Tambahan') desaStats[desa].sambilanTambahan++;
            });

            // Siapkan data untuk tabel
            const tableRows = Object.keys(desaStats).sort().map((desa, index) => [
                index + 1, 
                desa, 
                desaStats[desa].count, 
                desaStats[desa].owner,
                desaStats[desa].abk, 
                desaStats[desa].penuhWaktu, 
                desaStats[desa].sambilanUtama,
                desaStats[desa].sambilanTambahan
            ]);

            // Hitung total
            const totalCount = tableRows.reduce((sum, row) => sum + row[2], 0);
            const totalOwner = tableRows.reduce((sum, row) => sum + row[3], 0);
            const totalAbk = tableRows.reduce((sum, row) => sum + row[4], 0);
            const totalPenuhWaktu = tableRows.reduce((sum, row) => sum + row[5], 0);
            const totalSambilanUtama = tableRows.reduce((sum, row) => sum + row[6], 0);
            const totalSambilanTambahan = tableRows.reduce((sum, row) => sum + row[7], 0);

            // Tambahkan baris total
            tableRows.push([
                "",
                "TOTAL KESELURUHAN",
                totalCount,
                totalOwner,
                totalAbk,
                totalPenuhWaktu,
                totalSambilanUtama,
                totalSambilanTambahan
            ]);

            // Generate kode unik untuk setiap cetakan
            const printId = 'SIMATA-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();

            // Generate QR Code untuk tanda tangan dengan warna biru muda (#4a69bd)
            document.getElementById('qr-right').innerHTML = "";
            const signatureText = `Dokumen Sah - Dinas Perikanan Kabupaten Situbondo\nNama: SUGENG PURWO PRIYANTO, S.E, M.M\nJabatan: Kabid Pemberdayaan Nelayan\nNIP: 19761103 200903 1 001\nTanggal: ${new Date().toLocaleDateString('id-ID')}\nID Dokumen: ${printId}`;
            
            try {
                new QRCode(document.getElementById("qr-right"), { 
                    text: signatureText, 
                    width: 120, 
                    height: 120,
                    colorDark: "#4a69bd", // Biru muda
                    colorLight: "#ffffff", 
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (error) {
                console.error("Error generating QR code:", error);
            }

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    
                    if (typeof jsPDF.API.autoTable !== 'function') {
                        showNotification('Library PDF tidak lengkap. Silakan refresh halaman.', 'error');
                        return;
                    }

                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;

                    // Header
                    doc.setFillColor(12, 36, 97);
                    doc.rect(10, 10, pageWidth - 20, 28, 'F');
                    
                    // Judul utama
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('SISTEM INFORMASI PEMETAAN NELAYAN (SIMATA)', pageWidth/2, 20, { align: 'center' });
                    
                    // Subjudul
                    doc.setFontSize(12);
                    doc.text('DINAS PERIKANAN KABUPATEN SITUBONDO', pageWidth/2, 26, { align: 'center' });

                    // Slogan dengan warna oranye
                    doc.setTextColor(246, 185, 59);
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(10);
                    doc.text('"Situbondo Naik Kelas"', pageWidth/2, 32, { align: 'center' });

                    // Garis bawah header dengan warna aksen
                    doc.setDrawColor(246, 185, 59);
                    doc.setLineWidth(1.5);
                    doc.line(20, 38, pageWidth - 20, 38);

                    // Judul Laporan
                    doc.setTextColor(12, 36, 97);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.text('LAPORAN REKAPITULASI DATA NELAYAN', pageWidth/2, 48, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text('PER DESA / KELURAHAN', pageWidth/2, 54, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const now = new Date();
                    const dateString = now.toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric'});
                    doc.text(`Dicetak pada: ${dateString}`, pageWidth/2, 60, { align: 'center' });

                    // Tabel Data
                    const tableWidth = pageWidth - 40;
                    const tableStartX = (pageWidth - tableWidth) / 2;

                    doc.autoTable({
                        head: [[
                            {content: 'No', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 20}},
                            {content: 'Desa / Kelurahan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 60}},
                            {content: 'Jumlah Nelayan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Pemilik Kapal', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'ABK', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 25}},
                            {content: 'Penuh Waktu', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Sambilan Utama', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 30}},
                            {content: 'Sambilan Tambahan', styles: {fillColor: [12, 36, 97], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', cellWidth: 35}}
                        ]],
                        body: tableRows,
                        startY: 65,
                        theme: 'grid',
                        tableWidth: tableWidth,
                        margin: { left: tableStartX, right: tableStartX },
                        headStyles: { 
                            fillColor: [12, 36, 97],
                            textColor: [255, 255, 255], 
                            fontStyle: 'bold', 
                            halign: 'center',
                            fontSize: 9,
                            cellPadding: 4,
                            lineWidth: 0.5,
                            lineColor: [255, 255, 255]
                        },
                        bodyStyles: {
                            textColor: [0, 0, 0],
                            fontSize: 9,
                            fillColor: [255, 255, 255],
                            cellPadding: 4,
                            lineWidth: 0.1,
                            lineColor: [200, 200, 200]
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        styles: {
                            overflow: 'linebreak',
                            cellPadding: 4,
                            fontSize: 9,
                            valign: 'middle',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: {cellWidth: 20, halign: 'center'},
                            1: {cellWidth: 60, halign: 'left'},
                            2: {cellWidth: 30, halign: 'center'},
                            3: {cellWidth: 30, halign: 'center'},
                            4: {cellWidth: 25, halign: 'center'},
                            5: {cellWidth: 30, halign: 'center'},
                            6: {cellWidth: 30, halign: 'center'},
                            7: {cellWidth: 35, halign: 'center'}
                        },
                        willDrawCell: function(data) {
                            // Baris total dengan warna kuning
                            if (data.row.index === tableRows.length - 1) {
                                data.cell.styles.fillColor = [255, 235, 59];
                                data.cell.styles.textColor = [0, 0, 0];
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.lineWidth = 0.5;
                                data.cell.styles.lineColor = [12, 36, 97];
                            }
                        }
                    });

                    // Footer
                    const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 150;
                    const footerY = Math.min(finalY + 15, pageHeight - 50);
                    
                    // Garis pemisah
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(20, footerY, pageWidth - 20, footerY);
                    
                    // Bagian kiri: Validasi elektronik
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.setTextColor(12, 36, 97);
                    
                    const leftX = 25;
                    const leftY = footerY + 8;
                    
                    doc.text("DOKUMEN INI TELAH DIVALIDASI", leftX, leftY);
                    doc.text("SECARA ELEKTRONIK OLEH", leftX, leftY + 4);
                    doc.text("SISTEM SATU DATA NELAYAN (SIMATA)", leftX, leftY + 8);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text("Dinas Perikanan Kabupaten Situbondo", leftX, leftY + 14);
                    doc.setTextColor(230, 126, 34);
                    doc.text("www.dinasperikanansitubondo.com/simata", leftX, leftY + 18);
                    
                    // Bagian kanan: Tanda tangan dan QR Code
                    const rightX = pageWidth - 85;
                    const rightY = footerY + 5;
                    
                    // Tanggal
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    const currentDate = new Date();
                    const formattedDate = currentDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year:'numeric'});
                    doc.text(`Situbondo, ${formattedDate}`, rightX + 32, rightY, {align: 'center'});
                    
                    // Jabatan
                    doc.text('Kepala Bidang Pemberdayaan Nelayan', rightX + 32, rightY + 6, {align: 'center'});
                    
                    // QR Code dengan warna biru muda
                    const qrRightCanvas = document.querySelector('#qr-right canvas');
                    if(qrRightCanvas) {
                        try {
                            const imgRight = qrRightCanvas.toDataURL("image/png");
                            // QR code 25x25 mm
                            doc.addImage(imgRight, 'PNG', rightX + 19, rightY + 10, 25, 25);
                        } catch (error) {
                            console.error("Error adding QR code image:", error);
                        }
                    }
                    
                    // Garis tanda tangan
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.line(rightX + 5, rightY + 40, rightX + 60, rightY + 40);
                    
                    // Nama dan NIP
                    const nameY = rightY + 45;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('SUGENG PURWO PRIYANTO, S.E, M.M', rightX + 32, nameY, {align: 'center'});
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text('NIP. 19761103 200903 1 001', rightX + 32, nameY + 5, {align: 'center'});

                    // Footer dengan kode unik
                    const totalPages = doc.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(`Halaman ${i} dari ${totalPages}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
                        
                        // Informasi sistem di footer dengan kode unik
                        doc.setFontSize(7);
                        const printTime = new Date().toLocaleString('id-ID');
                        doc.text(`Dicetak dari SIMATA v5.5 - ${printTime} | ID Dokumen: ${printId}`, pageWidth / 2, pageHeight - 7, { align: 'center' });
                    }

                    // Simpan file PDF
                    const fileName = `Laporan_Nelayan_${appSettings.appSubtitle.replace(/\s+/g, '_').slice(0,15)}_${Date.now()}.pdf`;
                    doc.save(fileName);
                    document.getElementById('qr-right').innerHTML = "";
                    
                    showNotification('Laporan PDF berhasil dibuat dan diunduh', 'success');
                    
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    showNotification('Gagal membuat PDF. Silakan coba lagi atau periksa konsol browser.', 'error');
                }
            }, 800);
        }

        // Fungsi untuk generate ID Card dengan error handling
        function safeGenerateIDCard(id) {
            const loadingEl = document.getElementById('idcardLoading');
            
            try {
                const d = appData.find(item => item.id == id);
                if(!d) {
                    showNotification('Data nelayan tidak ditemukan!', 'error');
                    return;
                }
                
                loadingEl.classList.add('active');
                
                if (typeof window.generateSimataIDCard === 'function') {
                    setTimeout(() => {
                        try {
                            window.generateSimataIDCard(d);
                        } catch (error) {
                            console.error('Error in generateSimataIDCard:', error);
                            showNotification('Gagal membuat ID Card. Silakan coba lagi.', 'error');
                        } finally {
                            loadingEl.classList.remove('active');
                        }
                    }, 100);
                } else {
                    showNotification('Fitur ID Card sedang dimuat...', 'info');
                    setTimeout(() => {
                        if (typeof window.generateSimataIDCard === 'function') {
                            window.generateSimataIDCard(d);
                        } else {
                            downloadSinglePdf(id);
                            showNotification('ID Card tidak tersedia, mengunduh PDF detail sebagai ganti.', 'warning');
                        }
                        loadingEl.classList.remove('active');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error in safeGenerateIDCard:', error);
                showNotification('Gagal membuat ID Card, coba lagi!', 'error');
                loadingEl.classList.remove('active');
            }
        }

        function showNotification(message, type = 'info') {
            const toastEl = document.querySelector('.notification-toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            let title = 'Notifikasi';
            let bgClass = 'bg-primary';
            
            switch(type) {
                case 'success':
                    title = 'Sukses!';
                    bgClass = 'bg-success';
                    break;
                case 'error':
                    title = 'Error!';
                    bgClass = 'bg-danger';
                    break;
                case 'warning':
                    title = 'Peringatan!';
                    bgClass = 'bg-warning';
                    break;
                case 'info':
                default:
                    title = 'Informasi';
                    bgClass = 'bg-primary';
                    break;
            }
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Ekspos fungsi-fungsi penting ke window agar bisa diakses dari file lain
        window.maskData = maskData;
        window.viewDetail = viewDetail;
        window.editData = editData;
        window.deleteData = deleteData;
        window.safeGenerateIDCard = safeGenerateIDCard;
        window.showNotification = showNotification;
        window.printData = printData;
        window.verifyKIN = verifyKIN;
        window.verifyKINAndShow = verifyKINAndShow;
        window.showAllKIN = showAllKIN;
        window.resetVerifyForm = resetVerifyForm;
        window.showFishInfoModal = showFishInfoModal;
        window.mergeData = mergeData;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.updateAlatTangkapByKapal = updateAlatTangkapByKapal;
        window.updateFishOptionsByAPI = updateFishOptionsByAPI;
        window.renderDataTable = renderDataTable;
        window.goToPage = goToPage;
        window.applyFilter = applyFilter;
        window.resetFilter = resetFilter;
        window.showDuplicateDataInFilter = showDuplicateDataInFilter;
        window.generateFilteredPdf = generateFilteredPdf;
        window.generateTablePdf = generateTablePdf; // Fungsi baru diekspos
        window.getFilteredData = getFilteredData;

        console.log(' SIMATA Application v5.5 initialized successfully');
        console.log(' Fitur Filter & Validasi Data telah dipindahkan ke menu Database Nelayan');
        console.log(' Fitur Unduh PDF Terfilter telah ditambahkan ke menu Database Nelayan');
        console.log(' Fitur Unduh PDF Tabel Data telah ditambahkan ke menu Database Nelayan');
        console.log(' Verifikasi KIN telah disempurnakan dengan tampilan responsif');
        console.log(' Pagination telah disempurnakan dengan navigasi yang lebih baik');
        console.log(' Semua menu dan fitur tetap utuh dan berfungsi');
    </script>
</body>
</html>
