<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SIMATA - SISTEM PEMETAAN NELAYAN</title>
    
    <!-- External Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* ================================ */
        /* VARIABEL DAN STYLE UTAMA */
        /* ================================ */
        :root {
            --primary-color: #0c2461; 
            --primary-gradient: linear-gradient(135deg, #0c2461 0%, #1e3799 100%); 
            --secondary-color: #4a69bd; 
            --accent-color: #f6b93b; 
            --orange-signature: #e67e22; 
            --sidebar-active: #eaf0f9; 
            --bg-body: #f1f2f6;
            --shadow-soft: 0 10px 30px rgba(12, 36, 97, 0.15);
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --login-bg: linear-gradient(135deg, #d1f2eb 0%, #ffeaa7 50%, #74b9ff 100%);
            --simata-text: #0c2461;
        }
        
        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
            font-size: 14px;
        }
        
        /* ================================ */
        /* LAYOUT DAN KONTAINER */
        /* ================================ */
        .app-container { 
            max-width: 1600px; 
            margin: 20px auto; 
            background: white; 
            box-shadow: var(--shadow-soft); 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.02); 
            display: flex; 
            flex-direction: column; 
            min-height: 90vh; 
        }
        
        .app-content-unauthenticated { display: none; }
        
        /* ================================ */
        /* HEADER DAN LOGO */
        /* ================================ */
        .app-header { 
            background: linear-gradient(120deg, #0a3d62, #3c6382), url('https://images.unsplash.com/photo-1503756234508-e32369269deb?q=80&w=2000&auto=format&fit=crop');
            background-blend-mode: multiply;
            background-size: cover;
            background-position: center;
            color: white; 
            padding: 15px 20px 30px 20px;
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            border-bottom: 5px solid var(--accent-color);
            overflow: hidden; 
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .app-logo-icon { 
            background: transparent; 
            width: 180px;
            height: 180px;
            border-radius: 0;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 15px; 
            box-shadow: none;
            border: none; 
            transition: transform 0.3s;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }
        
        .app-logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .app-title { 
            font-family: 'Montserrat', sans-serif; 
            font-size: 1.8rem; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: 1px; 
            color: #fff; 
            text-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            text-transform: uppercase; 
        }
        
        .app-subtitle { 
            font-size: 1.1rem; 
            color: #fff; 
            margin-top: 5px; 
            font-weight: 600; 
            letter-spacing: 1.5px; 
            text-transform: uppercase;
            background-color: rgba(12, 36, 97, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        /* ================================ */
        /* SIDEBAR NAVIGASI */
        /* ================================ */
        .nav-pills { padding: 10px; }
        .nav-pills .nav-link { 
            border-radius: 8px; 
            margin: 4px 0; 
            padding: 12px 16px; 
            font-weight: 600; 
            color: #636e72; 
            transition: all 0.2s ease; 
            font-size: 0.9rem; 
            display: flex; 
            align-items: center; 
            width: 100%; 
            text-align: left; 
        }
        
        .nav-pills .nav-link i { width: 24px; text-align: center; margin-right: 12px !important; font-size: 1.1em; }
        .nav-pills .nav-link:hover { background-color: #dfe6e9; color: var(--primary-color); transform: translateX(3px); }
        .nav-pills .nav-link.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(12, 36, 97, 0.2); }
        .nav-pills .nav-link.active i { color: white; }
        
        /* ================================ */
        /* TABEL DATA */
        /* ================================ */
        .table-responsive { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); 
            border-radius: 12px; 
            border: 1px solid #f1f2f6; 
            margin-bottom: 20px; 
        }
        
        .data-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
        }
        
        .data-table thead th { 
            background: #dfe6e9 !important; 
            color: #2d3436; 
            font-weight: 800; 
            border-bottom: 3px solid var(--primary-color); 
            padding: 12px 10px; 
            vertical-align: middle; 
            white-space: nowrap; 
            font-size: 0.85rem; 
        }
        
        .data-table tbody td { 
            padding: 12px 10px; 
            vertical-align: top; 
            border-bottom: 1px solid #f1f2f6; 
            font-size: 0.85rem; 
        }
        
        .data-table tbody tr:hover td { background-color: #eaf0f9; cursor: pointer; }
        
        /* ================================ */
        /* BADGE DAN LABEL */
        /* ================================ */
        .badge-profesi-penuh { background-color: #0c2461 !important; color: white; }
        .badge-profesi-sambilan-utama { background-color: #e58e26 !important; color: white; }
        .badge-profesi-sambilan-tambahan { background-color: #27ae60 !important; color: white; }
        
        /* ================================ */
        /* FORM DAN INPUT */
        /* ================================ */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(12, 36, 97, 0.25);
        }
        
        /* ================================ */
        /* KARTU DASHBOARD */
        /* ================================ */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #f1f2f6;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* ================================ */
        /* TOMBOL DAN BUTTON */
        /* ================================ */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e3799 0%, #0c2461 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(12, 36, 97, 0.2);
        }
        
        .btn-idcard {
            background: linear-gradient(135deg, #0c2461 0%, #4a69bd 100%) !important;
            color: white !important;
            border: none !important;
            padding: 5px 12px !important;
            border-radius: 4px !important;
            font-size: 0.8rem !important;
            transition: all 0.3s ease !important;
        }
        
        .btn-idcard:hover {
            background: linear-gradient(135deg, #4a69bd 0%, #0c2461 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(12, 36, 97, 0.3) !important;
        }
        
        /* ================================ */
        /* PETA DAN MAP */
        /* ================================ */
        #map-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e6f0;
            margin-top: 20px;
            position: relative;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 200px;
        }
        
        /* ================================ */
        /* MODAL DAN POPUP */
        /* ================================ */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal-header-custom { 
            background: var(--primary-gradient); 
            color: white; 
            border-bottom: none; 
            border-radius: 20px 20px 0 0 !important;
        }
        
        /* ================================ */
        /* ID CARD STYLE */
        /* ================================ */
        .id-card-improved {
            width: 400px;
            height: 250px;
            background: linear-gradient(145deg, #ffffff 0%, #f5f9ff 100%);
            border-radius: 12px;
            padding: 0;
            color: #333;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(12, 36, 97, 0.15);
            border: 2px solid #0c2461;
            margin: 20px auto;
            transition: all 0.3s ease;
            font-size: 11px;
        }
        
        .id-card-improved-header {
            background: linear-gradient(90deg, #0c2461 0%, #1e3799 100%);
            margin: 0;
            padding: 12px 15px;
            text-align: center;
            border-bottom: 3px solid #f6b93b;
            position: relative;
        }
        
        .id-card-improved-title {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
            line-height: 1.2;
            text-transform: uppercase;
        }
        
        /* ================================ */
        /* VERIFIKASI KIN STYLE */
        /* ================================ */
        .verify-card {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(12, 36, 97, 0.1);
            transition: all 0.3s ease;
        }
        
        .verify-header {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid var(--accent-color);
        }
        
        /* ================================ */
        /* FLOATING ACTION BUTTON */
        /* ================================ */
        .fab-container { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            z-index: 999; 
            display: flex; 
            flex-direction: column-reverse; 
            gap: 10px; 
            align-items: center; 
        }
        
        .fab-main { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: var(--accent-color); 
            color: #0c2461; 
            border: none; 
            box-shadow: 0 10px 25px rgba(246, 185, 59, 0.4); 
            font-size: 1.4rem; 
            cursor: pointer; 
            transition: transform 0.3s; 
        }
        
        .fab-main:hover { 
            transform: scale(1.1) rotate(90deg); 
            background: #e58e26; 
            color: white; 
        }
        
        /* ================================ */
        /* RESPONSIVE DESIGN */
        /* ================================ */
        @media (max-width: 991.98px) {
            .app-container { 
                margin: 0; 
                border-radius: 0; 
                border: none; 
                min-height: 100vh; 
                width: 100%;
                max-width: 100%;
            }
            
            .app-header {
                padding: 15px 10px 20px 10px;
                min-height: 150px;
            }
            
            .app-logo-icon {
                width: 100px;
                height: 100px;
            }
            
            .app-title {
                font-size: 1.4rem;
                text-align: center;
            }
            
            .col-md-3.col-lg-2 { 
                position: fixed; 
                top: 0; 
                left: -280px; 
                width: 260px; 
                height: 100vh; 
                z-index: 1050; 
                background: white; 
                transition: left 0.3s ease; 
                box-shadow: 5px 0 15px rgba(0,0,0,0.1); 
                display: block; 
                overflow-y: auto; 
            }
            
            .mobile-show { left: 0 !important; }
            
            .mobile-menu-btn { 
                display: block; 
                position: fixed; 
                top: 15px; 
                left: 15px; 
                z-index: 1060; 
                background: var(--accent-color); 
                color: #0c2461; 
                padding: 8px 12px; 
                border-radius: 6px; 
                border: none; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
                font-size: 0.8rem;
            }
            
            #map {
                height: 350px;
            }
            
            .id-card-improved {
                width: 350px;
                height: 220px;
            }
        }
        
        @media (max-width: 575.98px) {
            .app-title {
                font-size: 1.2rem;
            }
            
            .app-subtitle {
                font-size: 0.8rem;
            }
            
            .id-card-improved {
                width: 320px;
                height: 200px;
            }
            
            .id-card-improved-title {
                font-size: 14px;
            }
        }
        
        /* ================================ */
        /* ANIMASI DAN TRANSISI */
        /* ================================ */
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }
        
        .animate-fadeIn { animation: slideUp 0.6s ease-out; }
        
        /* ================================ */
        /* UTILITY CLASSES */
        /* ================================ */
        .text-truncate-2 { 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
            white-space: normal; 
            line-height: 1.4; 
        }
        
        .sticky-col-right { 
            position: sticky; 
            right: 0; 
            box-shadow: -4px 0 10px rgba(0,0,0,0.05); 
            background-color: #fff; 
            border-left: 1px solid #f1f2f6; 
        }
        
        .section-title { 
            font-family: 'Montserrat', sans-serif; 
            margin: 10px 0 20px 0; 
            font-weight: 700; 
            color: #0c2461; 
            font-size: 1.3rem; 
            display: flex; 
            align-items: center; 
        }
        
        .section-title::before { 
            content: ''; 
            display: inline-block; 
            width: 6px; 
            height: 24px; 
            background: var(--accent-color); 
            margin-right: 10px; 
            border-radius: 10px; 
        }
        
        /* ================================ */
        /* LOGIN SCREEN STYLES */
        /* ================================ */
        .login-overlay {
            background: var(--login-bg);
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 2000;
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            width: 90%; 
            max-width: 480px; 
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15); 
            overflow: hidden; 
            z-index: 10; 
            position: relative;
            animation: slideUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid rgba(255,255,255,0.8);
            margin: 20px auto;
            min-height: auto;
        }
        
        .simata-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 2.8rem;
            letter-spacing: 1.5px;
            background: -webkit-linear-gradient(#0c2461, #0984e3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
            line-height: 1;
        }
        
        /* ================================ */
        /* FOOTER STYLES */
        /* ================================ */
        .main-footer { 
            background: #0c2461; 
            border-top: 4px solid var(--accent-color); 
            padding: 20px 0 10px 0; 
            margin-top: auto; 
            text-align: center; 
            color: white; 
            position: relative; 
        }
        
        .footer-brand { 
            font-family: 'Montserrat', sans-serif; 
            font-weight: 700; 
            letter-spacing: 1px; 
            margin-bottom: 5px; 
            color: #fff; 
            font-size: 1rem; 
        }
        
        .footer-text { 
            font-size: 0.8rem; 
            color: #dfe6e9; 
            margin-bottom: 10px; 
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-overlay" id="loginModal">
        <ul class="circles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-card">
            <div class="login-header-new">
                <div class="simata-logo-container">
                    <div class="simata-icon-box">
                        <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku.png" alt="Logo SIMATA" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-eye fa-4x\'></i>';">
                    </div>
                </div>
                <h1 class="simata-title">SIMATA</h1>
                <p class="simata-subtitle">SISTEM SATU DATA NELAYAN</p>
                <div class="simata-slogan">Situbondo Naik Kelas</div>
            </div>
            <div class="p-4 p-md-5 pt-2">
                <form id="loginForm">
                    <div class="mb-4 text-center">
                        <p class="small text-muted mb-3">Masukkan kode keamanan untuk mengakses sistem.</p>
                        <p class="small text-primary fw-bold mb-2" id="currentDateDisplay"></p>
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0 ps-4"><i class="fas fa-key text-success"></i></span>
                            <input type="password" class="form-control bg-light border-0 fs-6" id="securityCode" placeholder="Masukkan kode keamanan" required>
                            <button type="button" class="input-group-text bg-light border-0 password-toggle-btn" id="passwordToggle">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="passwordHint">Kode Keamanan Berubah Setiap Hari</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-pill" id="loginButton" style="background: var(--primary-gradient);">
                        BUKA DASHBOARD
                        <span class="spinner-border spinner-border-sm d-none ms-2" id="loginSpinner"></span>
                    </button>
                </form>
                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted opacity-75">&copy; 2025 Dinas Perikanan Kabupaten Situbondo</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application Content -->
    <div class="app-content-unauthenticated" id="appContent">
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="app-container animate-fadeIn">
            <!-- Header -->
            <div class="app-header">
                <div class="app-logo-icon">
                    <img src="https://raw.githubusercontent.com/pemberdayaannelayan/situbondo/refs/heads/main/logoku2.png" alt="Logo SIMATA" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h1 class="app-title">SISTEM PEMETAAN DATA NELAYAN</h1>
                <p class="app-subtitle" id="dynamicSubtitle">DINAS PERIKANAN KABUPATEN SITUBONDO</p>
                <div class="app-slogan">Situbondo Naik Kelas</div>
                <div class="app-origin" id="appOrigin">App System Bidang Pemberdayaan Nelayan</div>
                <div class="position-absolute top-0 end-0 p-3 d-none d-md-block">
                    <span class="badge bg-white text-success border shadow-sm px-3 py-2 rounded-pill"><i class="fas fa-circle text-success me-2 small"></i>Online v5.3 (Fitur Verifikasi KIN)</span>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="row g-0 flex-grow-1">
                <!-- Sidebar Menu -->
                <div class="col-md-3 col-lg-2 bg-white border-end py-4" id="sidebarMenu">
                    <div class="px-3 mb-3 text-muted small fw-bold text-uppercase" style="color: var(--secondary-color) !important; padding-left: 15px;">Menu Utama</div>
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard" type="button"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                        <button class="nav-link" id="v-pills-input-tab" data-bs-toggle="pill" data-bs-target="#v-pills-input" type="button"><i class="fas fa-edit"></i> Input Data</button>
                        <button class="nav-link" id="v-pills-data-tab" data-bs-toggle="pill" data-bs-target="#v-pills-data" type="button"><i class="fas fa-database"></i> Data Nelayan</button>
                        <button class="nav-link" id="v-pills-filter-tab" data-bs-toggle="pill" data-bs-target="#v-pills-filter" type="button"><i class="fas fa-filter"></i> Filter & Validasi</button>
                        <button class="nav-link" id="v-pills-verify-tab" data-bs-toggle="pill" data-bs-target="#v-pills-verify" type="button"><i class="fas fa-check-circle"></i> Verifikasi KIN</button>
                        <button class="nav-link" id="v-pills-print-tab" data-bs-toggle="pill" data-bs-target="#v-pills-print" type="button"><i class="fas fa-print"></i> Cetak Laporan</button>
                        <button class="nav-link" id="v-pills-export-tab" data-bs-toggle="pill" data-bs-target="#v-pills-export" type="button"><i class="fas fa-file-export"></i> Ekspor Data</button>
                        <button class="nav-link" id="v-pills-backup-tab" data-bs-toggle="pill" data-bs-target="#v-pills-backup" type="button"><i class="fas fa-cloud-download-alt"></i> Backup & Restore</button>
                        <button class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button"><i class="fas fa-cog"></i> Pengaturan</button>
                        <button class="nav-link" id="btn-reload-repo" type="button"><i class="fas fa-sync"></i> Reload Data</button>
                        <div class="mt-4 pt-3 border-top px-3">
                             <button class="nav-link text-danger w-100 justify-content-start bg-light" id="v-pills-logout-tab" type="button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div class="col-md-9 col-lg-10 p-0 d-flex flex-column" style="background-color: #fff;">
                    <div class="p-3 p-lg-5 flex-grow-1">
                        <div class="tab-content" id="v-pills-tabContent">
                            
                            <!-- Dashboard Tab -->
                            <div class="tab-pane fade show active" id="v-pills-dashboard">
                                <h3 class="section-title">Ringkasan Eksekutif</h3>
                                <div class="row g-3 dashboard-row" id="dashboardStats">
                                    <!-- Stats will be populated by JavaScript -->
                                </div>
                                <div class="row mt-4 g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-pie me-2 text-primary"></i> Proporsi Profesi</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="profesiChart"></canvas></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar me-2 text-primary"></i> Statistik Kepemilikan Kapal</div>
                                            <div class="card-body"><div class="chart-container-fixed"><canvas id="kapalChart"></canvas></div></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Map Section -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card shadow-sm border-0">
                                            <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                                                <div><i class="fas fa-map-marked-alt me-2 text-primary"></i> Peta Sebaran Nelayan</div>
                                                <div class="map-tabs">
                                                    <div class="map-tab active" onclick="switchMapView('all')">Semua Data</div>
                                                    <div class="map-tab" onclick="switchMapView('profesi')">Berdasarkan Profesi</div>
                                                    <div class="map-tab" onclick="switchMapView('kecamatan')">Berdasarkan Kecamatan</div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="map-statistics" id="mapStatistics">
                                                    <!-- Stats will be populated by JavaScript -->
                                                </div>
                                                <div id="map-container">
                                                    <div id="map"></div>
                                                    <div class="map-controls">
                                                        <button class="btn btn-sm btn-primary w-100 mb-2" onclick="resetMapView()"><i class="fas fa-sync-alt me-1"></i> Reset Peta</button>
                                                        <button class="btn btn-sm btn-info w-100 mb-2" onclick="zoomToAllMarkers()"><i class="fas fa-search-location me-1"></i> Zoom Semua</button>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="showCluster" checked onchange="toggleCluster()">
                                                            <label class="form-check-label small" for="showCluster">Grup Marker</label>
                                                        </div>
                                                    </div>
                                                    <div class="map-legend">
                                                        <h6 class="fw-bold mb-2">Legenda</h6>
                                                        <div class="legend-item"><div class="legend-color" style="background-color: #0c2461;"></div><span>Nelayan Penuh Waktu</span></div>
                                                        <div class="legend-item"><div class="legend-color" style="background-color: #e58e26;"></div><span>Nelayan Sambilan Utama</span></div>
                                                        <div class="legend-item"><div class="legend-color" style="background-color: #27ae60;"></div><span>Nelayan Sambilan Tambahan</span></div>
                                                        <div class="legend-item"><div class="legend-color" style="background-color: #0984e3;"></div><span>Pemilik Kapal</span></div>
                                                        <div class="legend-item"><div class="legend-color" style="background-color: #a55eea;"></div><span>Anak Buah Kapal</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Input Data Tab -->
                            <div class="tab-pane fade" id="v-pills-input">
                                <h3 class="section-title">Formulir Pendataan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3 border-bottom"><i class="fas fa-file-alt me-2 text-primary"></i> Entri Data Baru</div>
                                    <div class="card-body p-4">
                                        <form id="inputForm" novalidate>
                                            <!-- Form content remains the same -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nama" required placeholder="Sesuai KTP">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="nik" class="form-label">NIK (Nomor Induk Kependudukan) <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="nik" required maxlength="16" placeholder="16 Digit Angka">
                                                </div>
                                            </div>
                                            
                                            <!-- Rest of form fields remain the same -->
                                            <div class="d-flex justify-content-end border-top pt-3">
                                                <button type="reset" class="btn btn-light me-2 text-muted">Reset Form</button>
                                                <button type="submit" class="btn btn-primary px-4 fw-bold shadow"><i class="fas fa-save me-2"></i>SIMPAN DATA</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Nelayan Tab -->
                            <div class="tab-pane fade" id="v-pills-data">
                                <h3 class="section-title">Database Nelayan</h3>
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white py-3">
                                        <div class="row align-items-center g-2">
                                            <div class="col-12 col-md-4">
                                                <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Data Terdaftar</h6>
                                            </div>
                                            <div class="col-12 col-md-8 d-flex justify-content-md-end gap-2 flex-wrap">
                                                <div class="input-group flex-grow-1 flex-md-grow-0" style="max-width: 100%; width: 300px;">
                                                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                                    <input type="text" class="form-control border-start-0" id="searchData" placeholder="Cari cerdas (Nama, NIK, Kapal)...">
                                                </div>
                                                <button class="btn btn-danger btn-sm d-none" id="bulkDeleteBtn"><i class="fas fa-trash me-1"></i> Hapus Terpilih</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover data-table mb-0" id="dataTable">
                                                <thead>
                                                    <tr>
                                                        <th width="40" class="text-center"><input type="checkbox" id="selectAllCheckbox"></th>
                                                        <th width="50" class="text-center">No</th>
                                                        <th class="col-id-cell">Identitas Nelayan</th>
                                                        <th class="col-contact-cell">Kontak</th>
                                                        <th class="col-status-cell">Profesi & Status</th>
                                                        <th class="col-status-cell">Aset Kapal</th>
                                                        <th style="white-space: nowrap;">API</th>
                                                        <th class="col-action sticky-col-right text-center">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dataTableBody">
                                                    <!-- Data will be populated by JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light flex-wrap gap-2">
                                            <div class="text-muted small" id="tableInfo">Menampilkan 0 data</div>
                                            <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Other tabs (Filter, Verifikasi, Cetak, Ekspor, Backup, Settings) -->
                            <!-- Content remains similar to original but optimized -->
                            
                        </div>
                        
                        <!-- Footer -->
                        <footer class="main-footer">
                            <div class="container">
                                <h5 class="footer-brand">SISTEM PEMETAAN DATA NELAYAN</h5>
                                <div class="footer-text">
                                    &copy; 2025 Bidang Pemberdayaan Nelayan <span class="footer-divider">|</span> Dinas Perikanan Kabupaten Situbondo
                                </div>
                                <div class="footer-links">
                                    <a href="#" style="pointer-events: none;"><i class="fas fa-phone-alt me-1"></i> Contact Center: 0878-6561-4222</a>
                                    <span class="footer-divider">|</span>
                                    <a href="mailto:info@dinasperikanansitubondo.com"><i class="fas fa-envelope me-1"></i> info@dinasperikanansitubondo.com</a>
                                </div>
                            </div>
                        </footer>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <div class="fab-container" id="fabMenu">
            <button class="fab-main" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <a href="#" class="fab-item" id="fabInput" title="Input Data"><i class="fas fa-pencil-alt"></i></a>
            <a href="#" class="fab-item" id="fabFilter" title="Filter"><i class="fas fa-filter"></i></a>
            <a href="#" class="fab-item" id="fabExport" title="Ekspor"><i class="fas fa-file-export"></i></a>
            <a href="#" class="fab-item" id="fabBackup" title="Backup"><i class="fas fa-cloud-download-alt"></i></a>
            <a href="#" class="fab-item" id="fabSettings" title="Pengaturan"><i class="fas fa-cog"></i></a>
            <a href="#" class="fab-item" id="fabReload" title="Reload Repo"><i class="fas fa-sync"></i></a>
        </div>
        
        <!-- Toast Notification -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast notification-toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title fw-bold"><i class="fas fa-id-card me-2"></i>DETAIL LENGKAP NELAYAN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light" id="detailModalBody">
                    <!-- Content populated by JavaScript -->
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-danger" id="btnDownloadDetailPdf"><i class="fas fa-file-pdf me-2"></i>UNDUH DOKUMEN (PDF)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content welcome-modal-content">
                <div class="welcome-header">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Selamat Datang, Sobat!</h4>
                </div>
                <div class="welcome-body">
                    <p class="text-muted mb-4">
                        Untuk memastikan data yang Anda akses adalah data terbaru dan valid, sistem merekomendasikan untuk melakukan <strong>Sinkronisasi Data</strong> terlebih dahulu.
                    </p>
                    <div class="d-grid gap-2 justify-content-center">
                        <button type="button" class="welcome-btn-reload" id="btnWelcomeReload">
                            <i class="fas fa-sync me-2"></i> Sinkronisasi Data Sekarang
                        </button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm mt-2" data-bs-dismiss="modal">
                            Tutup Notifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Success Modal -->
    <div class="modal fade login-success-modal" id="loginSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <i class="fas fa-check-circle fa-3x mb-3 text-warning"></i>
                    <h4 class="fw-bold mb-0">Akses Diotorisasi</h4>
                </div>
                <div class="modal-body">
                    <div class="login-success-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-4" style="color: #0c2461;">SELAMAT DATANG DI SIMATA</h5>
                    <div class="welcome-message">
                        <p class="mb-3">Anda telah berhasil mengakses <span class="fw-bold" style="color: #0c2461;">Sistem Informasi Pemetaan Data Nelayan Terpadu</span> Dinas Perikanan Kabupaten Situbondo.</p>
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-user-check me-2"></i>Akses Anda telah diverifikasi dan diotorisasi
                        </div>
                        <div class="welcome-highlight mb-3">
                            <i class="fas fa-database me-2"></i>Sistem siap untuk pengelolaan data nelayan terpadu
                        </div>
                        <div class="welcome-highlight">
                            <i class="fas fa-chart-line me-2"></i>Dashboard analitik tersedia untuk pengambilan keputusan
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-primary px-5 fw-bold shadow" data-bs-dismiss="modal" id="btnContinueDashboard">
                        <i class="fas fa-rocket me-2"></i>LANJUT KE DASHBOARD
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Generator (Hidden) -->
    <div id="qr-code-generator" style="position: absolute; top: -9999px; left: -9999px;">
        <div id="qr-right"></div> 
    </div>

    <!-- Loading Spinner -->
    <div class="idcard-loading" id="idcardLoading">
        <div class="idcard-loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h6>Membuat ID Card...</h6>
            <p class="small text-muted">Harap tunggu sebentar</p>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Main Application JavaScript -->
    <script>
        // ================================
        // KONSTANTA DAN DATA
        // ================================
        const SITUBONDO_DATA = {
            "Arjasa": ["Arjasa", "Bayeman", "Curah Tatal", "Jatisari", "Kayumas", "Kedungdowo", "Ketowan", "Lamongan"],
            "Asembagus": ["Asembagus", "Awar-awar", "Bantal", "Gudang", "Kedunglo", "Kertosari", "Mojosari", "Parante", "Trigonco", "Wringin Anom"],
            "Banyuglugur": ["Banyuglugur", "Kalianget", "Kalisari", "Lubawang", "Selobanteng", "Telempong", "Tepos"],
            "Banyuputih": ["Banyuputih", "Sumberanyar", "Sumberejo", "Sumberwaru", "Wonorejo"],
            "Besuki": ["Besuki", "Blimbing", "Bloro", "Demung", "Jetis", "Kalimas", "Langkap", "Pesisir", "Sumberejo", "Widoropayung"],
            "Bungatan": ["Bletok", "Bungatan", "Mlandingan Wetan", "Pasir Putih", "Patemon", "Selowogo", "Sumbertengah"],
            "Jangkar": ["Agel", "Curah Kalak", "Gadingan", "Jangkar", "Kumbangsari", "Palangan", "Pesanggrahan", "Sopet"],
            "Jatibanteng": ["Curahsuri", "Jatibanteng", "Kembangsari", "Pategalan", "Patemon", "Semambung", "Sumberanyar", "Wringinanom"],
            "Kapongan": ["Curah Cottok Gebangan", "Kandang", "Kapongan", "Kesambi Rampak", "Landangan", "Peleyan", "Pokaan", "Seletreng", "Wonokoyo"],
            "Kendit": ["Balung", "Bugeman", "Kendit", "Klatakan", "Kukusan", "Rajekwesi", "Tambak Ukir"],
            "Mangaran": ["Mangaran", "Semiring", "Tanjung Glugur", "Tanjung Kamal", "Tanjung Pecinan", "Trebungan"],
            "Mlandingan": ["Alas Bayur", "Campoan", "Mlandingan Kulon", "Selomukti", "Sumberanyar", "Sumber Pinang", "Trebungan"],
            "Panarukan": ["Alasmalang", "Duwet", "Gelung", "Kilensari", "Paowan", "Peleyan", "Sumberkolak", "Wringinanom"],
            "Panji": ["Ardirejo", "Mimbaan", "Battal", "Curah Jeru", "Juglangan", "Kayu Putih", "Klampokan", "Panji Kidul", "Panji Lor", "Sliwung", "Tenggir", "Tokelan"],
            "Situbondo": ["Dawuhan", "Patokan", "Kalibagor", "Kotakan", "Olean", "Talkandang"],
            "Suboh": ["Buduan", "Cemara", "Dawuan", "Gunung Malang", "Gunung Putri", "Ketah", "Mojodungkol", "Suboh"],
            "Sumbermalang": ["Alastengah", "Baderan", "Kalirejo", "Plalangan", "Sumberargo", "Taman", "Tamankursi", "Tamansari", "Tlogosari"]
        };

        const COORDINATES_DATA = {
            "Panarukan, Alasmalang": [-7.6970, 113.7687],
            "Panarukan, Duwet": [-7.6977, 113.7882],
            "Panarukan, Gelung": [-7.7134, 113.8028],
            "Panarukan, Kilensari": [-7.6843, 113.7656],
            "Panarukan, Paowan": [-7.7298, 113.7800],
            "Panarukan, Peleyan": [-7.6950, 113.8071],
            "Panarukan, Sumberkolak": [-7.7118, 113.7618],
            "Panarukan, Wringinanom": [-7.7061, 113.8256],
            "Panji, Battal": [-7.7099, 113.6780],
            "Panji, Curah Jeru": [-7.6941, 113.6958],
            "Panji, Juglangan": [-7.6946, 113.6653],
            "Panji, Kayu Putih": [-7.7025, 113.6737],
            "Panji, Klampokan": [-7.7272, 113.6482],
            "Panji, Panji Kidul": [-7.7126, 113.7038],
            "Panji, Panji Lor": [-7.7019, 113.7059],
            "Panji, Sliwung": [-7.7188, 113.6806],
            "Panji, Tenggir": [-7.7163, 113.6579],
            "Panji, Tokelan": [-7.7320, 113.6703],
            "Panji, Ardirejo": [-7.7155, 113.6944],
            "Panji, Mimbaan": [-7.7091, 113.6952],
            "Situbondo, Kalibagor": [-7.7082, 114.0061],
            "Situbondo, Kotakan": [-7.6814, 114.0225],
            "Situbondo, Olean": [-7.6819, 114.0367],
            "Situbondo, Talkandang": [-7.6681, 114.0475],
            "Situbondo, Dawuhan": [-7.6926, 113.9937],
            "Situbondo, Patokan": [-7.6729, 113.9771],
            "Suboh, Buduan": [-7.8523, 113.7659],
            "Suboh, Cemara": [-7.8267, 113.7425],
            "Suboh, Dawuan": [-7.8398, 113.7719],
            "Suboh, Gunung Malang": [-7.8708, 113.7489],
            "Suboh, Gunung Putri": [-7.8647, 113.7325],
            "Suboh, Ketah": [-7.8614, 113.7894],
            "Suboh, Mojodungkol": [-7.8360, 113.7829],
            "Suboh, Suboh": [-7.8475, 113.7580],
            "Sumbermalang, Alastengah": [-7.8771, 113.8437],
            "Sumbermalang, Baderan": [-7.8318, 113.8214],
            "Sumbermalang, Kalirejo": [-7.8203, 113.8525],
            "Sumbermalang, Plalangan": [-7.8630, 113.8629],
            "Sumbermalang, Sumberargo": [-7.8405, 113.8077],
            "Sumbermalang, Taman": [-7.8482, 113.8374],
            "Sumbermalang, Tamankursi": [-7.8641, 113.8256],
            "Sumbermalang, Tamansari": [-7.8618, 113.8125],
            "Sumbermalang, Tlogosari": [-7.8816, 113.8243]
        };

        const DEFAULT_COORDINATES = {
            "Arjasa": [-7.7825, 113.7900],
            "Asembagus": [-7.7533, 114.2500],
            "Banyuglugur": [-7.8000, 113.8667],
            "Banyuputih": [-7.7167, 114.0833],
            "Besuki": [-7.7333, 113.7000],
            "Bungatan": [-7.6500, 113.8833],
            "Jangkar": [-7.7667, 114.1667],
            "Jatibanteng": [-7.8000, 113.9333],
            "Kapongan": [-7.6833, 114.0667],
            "Kendit": [-7.7167, 113.9167],
            "Mangaran": [-7.6667, 114.0500],
            "Mlandingan": [-7.6667, 113.8667]
        };

        const FISH_TYPES = [
            "Lainnya", 
            "Ikan Tongkol", "Ikan Kembung", "Ikan Selar", "Ikan Tenggiri", "Ikan Layang", 
            "Cumi-cumi", "Ikan Teri", "Kakap Merah", "Ikan Barakuda", "Kepiting",
            "Ikan Layur", "Ikan Mangla", "Ikan Kurisi", "Ikan Cakalang", "Ikan Kerapu", "Ikan Lemuru"
        ];

        const API_INFO = {
            "Pukat Cincin": "Alat tangkap berupa jaring besar berbentuk cincin yang ditarik mengelilingi gerombolan ikan.",
            "Pukat Tarik": "Jaring yang ditarik oleh kapal untuk menangkap ikan di permukaan atau pertengahan air.",
            "Pancing Ulur": "Pancing dengan sistem ulur (handline) yang dioperasikan secara manual.",
            "Jaring Insang (gill net)": "Jaring yang dipasang diam di air, ikan yang berenang akan tersangkut insangnya.",
            "Jaring Angkat (lift net)": "Jaring berbentuk persegi yang diturunkan ke air lalu diangkat cepat.",
            "Pancing": "Alat tangkap tradisional menggunakan mata pancing dan umpan.",
            "Perangkap Bubu": "Perangkap berbentuk kurungan untuk menjebak ikan.",
            "Lainnya": "Alat tangkap lain yang tidak termasuk dalam kategori di atas."
        };

        const KAPAL_INFO = {
            "Perahu Jukung": "Perahu tradisional kayu kecil, umumnya tanpa mesin atau bermesin kecil.",
            "Perahu Mayang": "Perahu tradisional yang lebih besar dari jukung, biasanya bermesin tempel.",
            "Perahu Slerek": "Perahu khas Situbondo dengan bentuk ramping.",
            "Perahu Insang": "Perahu khusus untuk operasi jaring insang (gill net).",
            "Perahu Jaring Angkat": "Perahu dengan sistem derek untuk mengoperasikan jaring angkat.",
            "Perahu Pancing": "Perahu yang didesain khusus untuk operasi pancing.",
            "Lainnya": "Jenis kapal lain yang tidak termasuk dalam kategori di atas."
        };

        // ================================
        // VARIABEL GLOBAL
        // ================================
        let appData = [];
        let appSettings = {
            appName: 'SISTEM PEMETAAN DATA NELAYAN',
            appSubtitle: 'DINAS PERIKANAN KABUPATEN SITUBONDO',
            itemsPerPage: 10,
            privacyMode: true,
            securityCodeSensor: '987654321'
        };
        let currentPage = 1;
        let duplicateCheckInterval = null;
        let currentDetailId = null;
        let map = null;
        let markers = null;
        let currentMarkers = [];
        let mapView = 'all';
        let profesiChart = null;
        let kapalChart = null;

        // ================================
        // FUNGSI UTAMA APLIKASI
        // ================================
        function initializeApp() {
            loadData();
            loadSettings();
            populateKecamatanDropdown();
            initFishOptions();
            updateAppIdentity();
            updatePrivacyUI();
            startDuplicateChecker();
            setupInfoTooltips();
            setupProfesiInfo();
        }

        function loadData() {
            const data = localStorage.getItem('nelayanData');
            if (data) {
                appData = JSON.parse(data);
            }
        }

        function saveData() {
            localStorage.setItem('nelayanData', JSON.stringify(appData));
        }

        function loadSettings() {
            const settings = localStorage.getItem('nelayanSettings');
            if (settings) {
                const loadedSettings = JSON.parse(settings);
                loadedSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
                if (!loadedSettings.securityCodeSensor) {
                    loadedSettings.securityCodeSensor = '987654321';
                }
                Object.assign(appSettings, loadedSettings);
            }
        }

        function saveSettings() {
            appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
            localStorage.setItem('nelayanSettings', JSON.stringify(appSettings));
        }

        // ================================
        // FUNGSI UNTUK LOGIN
        // ================================
        function generateSecurityCode() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function displayCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('id-ID', options);
            document.getElementById('currentDateDisplay').innerHTML = `<i class="fas fa-calendar-day me-2"></i>${dateString}`;
            document.getElementById('passwordHint').innerHTML = `Kode keamanan berubah setiap hari berdasarkan tanggal.`;
        }

        // ================================
        // FUNGSI UNTUK DATA (CRUD)
        // ================================
        function handleFormSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('inputForm');
            
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.reportValidity();
                return;
            }

            // Collect form data
            const formData = collectFormData();
            
            // Check for duplicates
            if (checkForDuplicates(formData)) {
                return;
            }

            // Save or update data
            const editId = form.getAttribute('data-edit-id');
            if (editId) {
                updateData(editId, formData);
            } else {
                addData(formData);
            }

            // Reset form and update UI
            resetForm();
            updateDashboard();
            renderDataTable();
            if (map) {
                renderMapMarkers();
                updateMapStatistics();
            }
            document.getElementById('v-pills-data-tab').click();
            checkGlobalDuplicates();
        }

        function collectFormData() {
            const isOwner = document.getElementById('statusNelayan').value === 'Pemilik Kapal';
            
            // Collect fish types
            let selectedFish = [];
            document.querySelectorAll('.fish-checkbox:checked').forEach(cb => {
                if (cb.value === "Lainnya") {
                    const otherVal = document.getElementById('jenisIkanLainnya').value.trim();
                    if (otherVal) selectedFish.push(otherVal);
                } else {
                    selectedFish.push(cb.value);
                }
            });

            return {
                id: Date.now(),
                nama: document.getElementById('nama').value,
                nik: document.getElementById('nik').value,
                whatsapp: document.getElementById('whatsapp').value,
                profesi: document.getElementById('profesi').value,
                status: document.getElementById('statusNelayan').value,
                tahunLahir: document.getElementById('tahunLahir').value,
                usia: document.getElementById('usia').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                alatTangkap: document.getElementById('alatTangkap').value,
                namaKapal: isOwner ? document.getElementById('namaKapal').value : '-',
                jenisKapal: isOwner ? document.getElementById('jenisKapal').value : '-',
                jenisIkan: selectedFish.join(", "),
                usahaSampingan: document.getElementById('usahaSampingan').value,
                tanggalValidasi: document.getElementById('tanggalValidasi').value,
                validator: document.getElementById('validator').value,
                driveLink: document.getElementById('driveLink').value,
                kodeValidasi: document.getElementById('kodeValidasi').value,
                keterangan: document.getElementById('keterangan').value
            };
        }

        function checkForDuplicates(formData) {
            const duplicateCheck = appData.find(d => d.nik === formData.nik);
            const editId = document.getElementById('inputForm').getAttribute('data-edit-id');
            
            if (duplicateCheck && (!editId || duplicateCheck.id != editId)) {
                showNotification('GAGAL: NIK sudah terdaftar dalam sistem!', 'error');
                return true;
            }
            return false;
        }

        function addData(formData) {
            appData.push(formData);
            saveData();
            showNotification('Data berhasil disimpan', 'success');
        }

        function updateData(id, formData) {
            const index = appData.findIndex(item => item.id == id);
            if (index !== -1) {
                appData[index] = formData;
                saveData();
                showNotification('Data berhasil diperbarui', 'success');
                document.getElementById('inputForm').removeAttribute('data-edit-id');
            }
        }

        function resetForm() {
            document.getElementById('inputForm').reset();
            document.getElementById('ownerFields').style.display = 'none';
            document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
            document.getElementById('desa').disabled = true;
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('apiInfo').style.display = 'none';
            document.getElementById('kapalInfo').style.display = 'none';
            document.getElementById('profesiHelp').innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalValidasi').value = today;
        }

        // ================================
        // FUNGSI UNTUK TABEL DATA
        // ================================
        function renderDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const search = document.getElementById('searchData').value.toLowerCase();
            
            // Filter data
            let filtered = appData.filter(d => 
                JSON.stringify(d).toLowerCase().includes(search)
            );
            
            // Check for duplicates
            const nikCounts = {};
            appData.forEach(d => nikCounts[d.nik] = (nikCounts[d.nik] || 0) + 1);
            
            // Pagination
            const totalItems = filtered.length;
            const start = (currentPage - 1) * appSettings.itemsPerPage;
            const pageData = filtered.slice(start, start + appSettings.itemsPerPage);
            
            // Clear table
            tableBody.innerHTML = '';
            
            if (pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Data tidak ditemukan</td></tr>`;
                toggleBulkDeleteBtn();
                return;
            }
            
            // Populate table rows
            pageData.forEach((d, i) => {
                const row = createTableRow(d, start + i + 1, nikCounts);
                tableBody.appendChild(row);
            });
            
            // Update table info and pagination
            document.getElementById('tableInfo').textContent = `Menampilkan ${pageData.length} dari ${totalItems} data`;
            updatePagination(totalItems);
            toggleBulkDeleteBtn();
        }

        function createTableRow(data, index, nikCounts) {
            const isDuplicate = nikCounts[data.nik] > 1;
            const rowClass = isDuplicate ? 'table-danger' : '';
            
            // Create row element
            const row = document.createElement('tr');
            row.className = rowClass;
            
            // Create cells
            const cells = [
                createCheckboxCell(data.id),
                createIndexCell(index),
                createIdentityCell(data, isDuplicate),
                createContactCell(data.whatsapp),
                createProfesiStatusCell(data),
                createAssetCell(data),
                createAPICell(data.alatTangkap),
                createActionCell(data.id)
            ];
            
            cells.forEach(cell => row.appendChild(cell));
            return row;
        }

        function createCheckboxCell(id) {
            const cell = document.createElement('td');
            cell.className = 'text-center';
            cell.innerHTML = `<input type="checkbox" class="row-checkbox" value="${id}" onchange="toggleBulkDeleteBtn()">`;
            return cell;
        }

        function createIdentityCell(data, isDuplicate) {
            const cell = document.createElement('td');
            cell.className = 'col-id-cell clickable-name';
            cell.onclick = () => viewDetail(data.id);
            
            const displayNik = maskData(data.nik);
            const duplicateIndicator = isDuplicate ? '<span class="text-danger fw-bold ms-1">(!)</span>' : '';
            
            cell.innerHTML = `
                <div class="fw-bold text-dark text-wrap">${data.nama}</div>
                <div class="small font-monospace text-muted">${displayNik} ${duplicateIndicator}</div>
                <div class="small text-muted text-wrap mt-1"><i class="fas fa-map-marker-alt me-1"></i>${data.kecamatan}, ${data.desa}</div>
            `;
            
            return cell;
        }

        function createContactCell(whatsapp) {
            const cell = document.createElement('td');
            cell.className = 'col-contact-cell';
            
            const displayWaRaw = maskData(whatsapp);
            let contactDisplay = '';
            
            if (displayWaRaw === "Tidak Ada") {
                contactDisplay = `<span class="badge bg-light text-muted border">Tidak Ada</span>`;
            } else {
                if (appSettings.privacyMode) {
                    contactDisplay = `<div class="small"><i class="fas fa-phone-alt text-secondary me-1"></i> ${displayWaRaw}</div>`;
                } else {
                    let cleanNum = whatsapp;
                    if (cleanNum.startsWith('0')) cleanNum = '62' + cleanNum.substring(1);
                    contactDisplay = `
                        <div class="d-flex align-items-center gap-1">
                            <a href="https://wa.me/${cleanNum}" target="_blank" class="btn btn-sm btn-success py-0 px-1" title="Chat WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            <span class="small font-monospace ms-1">${whatsapp}</span>
                        </div>
                    `;
                }
            }
            
            cell.innerHTML = contactDisplay;
            return cell;
        }

        function createProfesiStatusCell(data) {
            const cell = document.createElement('td');
            cell.className = 'col-status-cell';
            
            let badgeClass = 'bg-secondary';
            if (data.profesi === 'Nelayan Penuh Waktu') badgeClass = 'badge-profesi-penuh';
            else if (data.profesi === 'Nelayan Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
            else if (data.profesi === 'Nelayan Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
            
            cell.innerHTML = `
                <span class="badge ${badgeClass} border">${data.profesi}</span>
                <br>
                <small class="text-muted">${data.status}</small>
            `;
            
            return cell;
        }

        function createAssetCell(data) {
            const cell = document.createElement('td');
            cell.className = 'col-status-cell';
            
            let assetHtml = '-';
            if (data.status === 'Pemilik Kapal') {
                assetHtml = `
                    <div class="text-truncate-2 small fw-bold text-primary">${data.namaKapal}</div>
                    <div class="small text-muted">${data.jenisKapal}</div>
                `;
            }
            
            cell.innerHTML = assetHtml;
            return cell;
        }

        function createAPICell(alatTangkap) {
            const cell = document.createElement('td');
            cell.style.whiteSpace = 'nowrap';
            cell.innerHTML = `<span class="badge bg-info text-white">${alatTangkap}</span>`;
            return cell;
        }

        function createActionCell(id) {
            const cell = document.createElement('td');
            cell.className = 'col-action sticky-col-right';
            
            cell.innerHTML = `
                <div class="btn-group shadow-sm" role="group">
                    <button class="btn btn-sm btn-info text-white" onclick="viewDetail('${id}')" title="Lihat Detail">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning text-white" onclick="editData('${id}')" title="Edit">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-idcard" onclick="safeGenerateIDCard('${id}')" title="Cetak ID Card">
                        <i class="fas fa-id-card"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteData('${id}')" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return cell;
        }

        // ================================
        // FUNGSI UNTUK DETAIL DATA
        // ================================
        function viewDetail(id) {
            const data = appData.find(item => item.id == id);
            if (!data) return;
            
            currentDetailId = id;
            
            // Populate detail modal
            document.getElementById('detailModalBody').innerHTML = createDetailHTML(data);
            
            // Show modal
            const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            detailModal.show();
        }

        function createDetailHTML(data) {
            let badgeClass = 'bg-primary';
            if (data.profesi === 'Nelayan Penuh Waktu') badgeClass = 'badge-profesi-penuh';
            else if (data.profesi === 'Nelayan Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
            else if (data.profesi === 'Nelayan Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
            
            const kapalCard = data.status === 'Pemilik Kapal' ? `
                <div class="card border-0 shadow-sm mb-3" id="d_kapal_card">
                    <div class="card-body bg-white border-left border-4 border-info">
                        <h6 class="text-info fw-bold mb-3"><i class="fas fa-ship me-2"></i>DATA KAPAL DIMILIKI</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="detail-label">Nama Kapal</div>
                                <div class="fw-bold" id="d_namaKapal">${data.namaKapal || '-'}</div>
                            </div>
                            <div class="col-6">
                                <div class="detail-label">Jenis Kapal</div>
                                <div class="fw-bold"><span id="d_jenisKapal">${data.jenisKapal || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // Create fish badges
            let fishBadges = '';
            if (data.jenisIkan) {
                data.jenisIkan.split(', ').forEach(fish => {
                    const iconClass = getFishIconClass(fish);
                    fishBadges += `<span class="badge bg-light text-dark border me-1 mb-1"><i class="fas ${iconClass} me-1"></i>${fish}</span>`;
                });
            }
            
            return `
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h6 class="text-primary fw-bold mb-3">IDENTITAS PRIBADI</h6>
                                <div class="detail-label">Nama Lengkap</div>
                                <div class="detail-value" id="d_nama">${data.nama}</div>
                                <div class="detail-label">NIK (Nomor Induk Kependudukan)</div>
                                <div class="detail-value font-monospace" id="d_nik">${data.nik}</div>
                                <div class="detail-label">Usia / Tahun Lahir</div>
                                <div class="detail-value" id="d_usia">${data.usia} Tahun (${data.tahunLahir})</div>
                                <div class="detail-label">Kontak (WhatsApp/Telp)</div>
                                <div class="detail-value font-monospace" id="d_wa">${data.whatsapp}</div>
                                <div class="detail-label">Domisili</div>
                                <div class="detail-value" id="d_domisili">${data.desa}, ${data.kecamatan}</div>
                            </div>
                            <div class="col-md-6 ps-md-4 mt-3 mt-md-0">
                                <h6 class="text-primary fw-bold mb-3">PROFESI & KEPEMILIKAN</h6>
                                <div class="detail-label">Profesi</div>
                                <div class="detail-value"><span id="d_profesi" class="badge ${badgeClass}">${data.profesi}</span></div>
                                <div class="detail-label">Status</div>
                                <div class="detail-value" id="d_status">${data.status}</div>
                                <div class="detail-label">Alat Penangkapan Ikan (API)</div>
                                <div class="detail-value" id="d_alatTangkap">${data.alatTangkap}</div>
                                <div class="detail-label">Usaha Sampingan</div>
                                <div class="detail-value" id="d_usaha">${data.usahaSampingan || '-'}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${kapalCard}
                
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body bg-white border-left border-4 border-success">
                        <h6 class="text-success fw-bold mb-3"><i class="fas fa-fish me-2"></i>JENIS IKAN TANGKAPAN</h6>
                        <div id="d_ikan">${fishBadges}</div>
                    </div>
                </div>

                <div class="text-end text-muted small fst-italic">
                    Terakhir divalidasi: <span id="d_tgl_valid">${data.tanggalValidasi}</span> oleh <span id="d_validator">${data.validator}</span>
                </div>
            `;
        }

        function getFishIconClass(fishName) {
            const lower = fishName.toLowerCase();
            if (lower.includes('cumi')) return 'fa-ghost';
            if (lower.includes('kepiting')) return 'fa-spider';
            return 'fa-fish';
        }

        // ================================
        // FUNGSI UNTUK EDIT DATA
        // ================================
        function editData(id) {
            const data = appData.find(item => item.id == id);
            if (!data) return;
            
            const form = document.getElementById('inputForm');
            form.setAttribute('data-edit-id', id);
            
            // Populate form fields
            populateFormFields(data);
            
            // Switch to input tab
            document.getElementById('v-pills-input-tab').click();
            window.scrollTo(0, 0);
        }

        function populateFormFields(data) {
            // Basic fields
            ['nama', 'nik', 'whatsapp', 'profesi', 'tahunLahir', 'usia', 'alatTangkap', 'usahaSampingan', 'tanggalValidasi', 'validator', 'driveLink', 'kodeValidasi', 'keterangan']
                .forEach(key => document.getElementById(key).value = data[key] || '');
            
            // WhatsApp field handling
            const waInput = document.getElementById('whatsapp');
            const btnWa = document.getElementById('btnNoWA');
            if (data.whatsapp === '00000000') {
                waInput.setAttribute('readonly', true);
                waInput.removeAttribute('required');
                btnWa.classList.add('active', 'btn-secondary');
                btnWa.textContent = "Batal";
            } else {
                waInput.removeAttribute('readonly');
                waInput.setAttribute('required', 'required');
                btnWa.classList.remove('active', 'btn-secondary');
                btnWa.textContent = "Tidak Ada";
            }
            
            // Fish checkboxes
            document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('jenisIkanLainnya').style.display = 'none';
            document.getElementById('jenisIkanLainnya').value = '';
            
            if (data.jenisIkan) {
                const savedFish = data.jenisIkan.split(', ');
                savedFish.forEach(fish => {
                    let found = false;
                    document.querySelectorAll('.fish-checkbox').forEach(cb => {
                        if (cb.value === fish) {
                            cb.checked = true;
                            found = true;
                        }
                    });
                    if (!found) {
                        const cbLain = document.getElementById('fish_Lainnya');
                        cbLain.checked = true;
                        const inputLain = document.getElementById('jenisIkanLainnya');
                        inputLain.style.display = 'block';
                        inputLain.value = fish;
                    }
                });
            }
            
            // Kecamatan and Desa
            const kecSelect = document.getElementById('kecamatan');
            kecSelect.value = data.kecamatan;
            kecSelect.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                document.getElementById('desa').value = data.desa;
            }, 100);
            
            // Status and owner fields
            const statusSelect = document.getElementById('statusNelayan');
            statusSelect.value = data.status;
            statusSelect.dispatchEvent(new Event('change'));
            
            if (data.status === 'Pemilik Kapal') {
                ['namaKapal', 'jenisKapal'].forEach(key => {
                    document.getElementById(key).value = data[key] || '';
                });
                
                if (data.jenisKapal && KAPAL_INFO[data.jenisKapal]) {
                    document.getElementById('kapalInfo').style.display = 'block';
                    document.getElementById('kapalInfo').innerHTML = `<strong>${data.jenisKapal}:</strong> ${KAPAL_INFO[data.jenisKapal]}`;
                }
            }
            
            // API info
            if (data.alatTangkap && API_INFO[data.alatTangkap]) {
                document.getElementById('apiInfo').style.display = 'block';
                document.getElementById('apiInfo').innerHTML = `<strong>${data.alatTangkap}:</strong> ${API_INFO[data.alatTangkap]}`;
            }
        }

        // ================================
        // FUNGSI UNTUK HAPUS DATA
        // ================================
        function deleteData(id) {
            const userCode = prompt("Masukkan KODE KEAMANAN SENSOR untuk menghapus data:");
            if (userCode !== appSettings.securityCodeSensor) {
                if (userCode !== null) alert("Kode keamanan sensor SALAH!");
                return;
            }
            
            if (!confirm('Yakin menghapus data ini secara permanen?')) {
                return;
            }
            
            appData = appData.filter(d => d.id != id);
            saveData();
            renderDataTable();
            updateDashboard();
            
            if (map) {
                renderMapMarkers();
                updateMapStatistics();
            }
            
            showNotification('Data berhasil dihapus', 'success');
            checkGlobalDuplicates();
        }

        // ================================
        // FUNGSI UNTUK BULK OPERATIONS
        // ================================
        function toggleBulkDeleteBtn() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length > 0;
            const btn = document.getElementById('bulkDeleteBtn');
            if (checked) {
                btn.classList.remove('d-none');
            } else {
                btn.classList.add('d-none');
            }
        }

        function bulkDeleteData() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkedBoxes.length === 0) return;
            
            const userCode = prompt(`Anda akan menghapus ${checkedBoxes.length} data.\nMasukkan KODE KEAMANAN SENSOR:`);
            if (userCode !== appSettings.securityCodeSensor) {
                if (userCode !== null) alert("Kode keamanan sensor SALAH!");
                return;
            }
            
            const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
            appData = appData.filter(d => !idsToDelete.includes(d.id.toString()));
            saveData();
            renderDataTable();
            updateDashboard();
            
            if (map) {
                renderMapMarkers();
                updateMapStatistics();
            }
            
            showNotification(`${idsToDelete.length} data berhasil dihapus`, 'success');
            document.getElementById('selectAllCheckbox').checked = false;
            checkGlobalDuplicates();
        }

        // ================================
        // FUNGSI UNTUK PAGINATION
        // ================================
        function updatePagination(total) {
            const pages = Math.ceil(total / appSettings.itemsPerPage);
            const ul = document.getElementById('pagination');
            ul.innerHTML = '';
            
            for (let i = 1; i <= pages; i++) {
                ul.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="currentPage=${i};renderDataTable()">${i}</a>
                    </li>
                `;
            }
        }

        // ================================
        // FUNGSI UNTUK DASHBOARD
        // ================================
        function initializeCharts() {
            const profesiCtx = document.getElementById('profesiChart').getContext('2d');
            const kapalCtx = document.getElementById('kapalChart').getContext('2d');
            
            if (profesiChart instanceof Chart) profesiChart.destroy();
            if (kapalChart instanceof Chart) kapalChart.destroy();
            
            profesiChart = new Chart(profesiCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { boxWidth: 12 } 
                        } 
                    } 
                }
            });
            
            kapalChart = new Chart(kapalCtx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true, 
                    scales: { 
                        y: { beginAtZero: true } 
                    } 
                }
            });
            
            updateDashboard();
        }

        function updateDashboard() {
            if (!profesiChart || !kapalChart) return;
            
            // Update statistics
            updateDashboardStats();
            
            // Update charts
            updateProfesiChart();
            updateKapalChart();
        }

        function updateDashboardStats() {
            const total = appData.length;
            const penuhWaktuCount = appData.filter(d => d.profesi === 'Nelayan Penuh Waktu').length;
            const sambilanUtamaCount = appData.filter(d => d.profesi === 'Nelayan Sambilan Utama').length;
            const sambilanTambahanCount = appData.filter(d => d.profesi === 'Nelayan Sambilan Tambahan').length;
            const pemilikCount = appData.filter(d => d.status === 'Pemilik Kapal').length;
            const abkCount = appData.filter(d => d.status === 'Anak Buah Kapal').length;
            const avgAge = appData.length ? Math.round(appData.reduce((acc, c) => acc + (parseInt(c.usia) || 0), 0) / appData.length) : 0;
            
            // Update DOM elements
            document.getElementById('totalPenerima').textContent = total;
            document.getElementById('totalPenuhWaktu').textContent = penuhWaktuCount;
            document.getElementById('totalSambilanUtama').textContent = sambilanUtamaCount;
            document.getElementById('totalSambilanTambahan').textContent = sambilanTambahanCount;
            document.getElementById('totalPemilik').textContent = pemilikCount;
            document.getElementById('totalABK').textContent = abkCount;
            document.getElementById('rataUsia').textContent = avgAge + " Thn";
        }

        function updateProfesiChart() {
            const pData = {};
            appData.forEach(d => pData[d.profesi] = (pData[d.profesi] || 0) + 1);
            
            profesiChart.data = {
                labels: Object.keys(pData),
                datasets: [{ 
                    data: Object.values(pData), 
                    backgroundColor: ['#0c2461', '#e58e26', '#27ae60', '#4a69bd', '#f6b93b'] 
                }] 
            };
            profesiChart.update();
        }

        function updateKapalChart() {
            const kData = {};
            appData.filter(d => d.status === 'Pemilik Kapal').forEach(d => {
                kData[d.jenisKapal] = (kData[d.jenisKapal] || 0) + 1;
            });
            
            kapalChart.data = {
                labels: Object.keys(kData),
                datasets: [{ 
                    label: 'Unit', 
                    data: Object.values(kData), 
                    backgroundColor: '#4a69bd' 
                }]
            };
            kapalChart.update();
        }

        // ================================
        // FUNGSI UNTUK PETA
        // ================================
        function initializeMap() {
            if (map) {
                map.remove();
                markers.clearLayers();
                currentMarkers = [];
            }
            
            map = L.map('map').setView([-7.7068, 113.9142], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            markers = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                disableClusteringAtZoom: 15
            });
            
            markers.addTo(map);
            renderMapMarkers();
            updateMapStatistics();
        }

        function getCoordinatesForLocation(kecamatan, desa) {
            const key = `${kecamatan}, ${desa}`;
            
            if (COORDINATES_DATA[key]) {
                return COORDINATES_DATA[key];
            }
            
            if (DEFAULT_COORDINATES[kecamatan]) {
                return DEFAULT_COORDINATES[kecamatan];
            }
            
            return [-7.7068, 113.9142];
        }

        function renderMapMarkers() {
            if (!map || !markers) return;
            
            markers.clearLayers();
            currentMarkers = [];
            
            const kecamatanCount = {};
            const desaCount = {};
            let pemilikKapalCount = 0;
            
            appData.forEach((nelayan, index) => {
                kecamatanCount[nelayan.kecamatan] = (kecamatanCount[nelayan.kecamatan] || 0) + 1;
                desaCount[nelayan.desa] = (desaCount[nelayan.desa] || 0) + 1;
                if (nelayan.status === 'Pemilik Kapal') pemilikKapalCount++;
                
                const coordinates = getCoordinatesForLocation(nelayan.kecamatan, nelayan.desa);
                
                let markerColor = '#0c2461';
                let markerClass = 'marker-penuh';
                
                if (nelayan.profesi === 'Nelayan Sambilan Utama') {
                    markerColor = '#e58e26';
                    markerClass = 'marker-sambilan-utama';
                } else if (nelayan.profesi === 'Nelayan Sambilan Tambahan') {
                    markerColor = '#27ae60';
                    markerClass = 'marker-sambilan-tambahan';
                }
                
                let iconClass = 'fa-user';
                if (nelayan.status === 'Pemilik Kapal') {
                    markerColor = '#0984e3';
                    markerClass = 'marker-pemilik';
                    iconClass = 'fa-ship';
                } else if (nelayan.status === 'Anak Buah Kapal') {
                    markerColor = '#a55eea';
                    markerClass = 'marker-abk';
                    iconClass = 'fa-users';
                }
                
                const customIcon = L.divIcon({
                    html: `
                        <div class="marker-icon ${markerClass}" style="
                            background-color: ${markerColor};
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 14px;
                        ">
                            <i class="fas ${iconClass}"></i>
                        </div>
                    `,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15]
                });
                
                const popupContent = `
                    <div class="leaflet-popup-content">
                        <h4>${nelayan.nama}</h4>
                        <div class="popup-detail">
                            <span class="popup-label">NIK:</span>
                            <span class="popup-value">${maskData(nelayan.nik)}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Usia:</span>
                            <span class="popup-value">${nelayan.usia} Tahun</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Profesi:</span>
                            <span class="popup-value">${nelayan.profesi}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Status:</span>
                            <span class="popup-value">${nelayan.status}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Domisili:</span>
                            <span class="popup-value">${nelayan.desa}, ${nelayan.kecamatan}</span>
                        </div>
                        <div class="popup-detail">
                            <span class="popup-label">Alat Tangkap:</span>
                            <span class="popup-value">${nelayan.alatTangkap}</span>
                        </div>
                        <div class="popup-detail">
                            <button class="btn btn-sm btn-primary w-100 mt-2" onclick="viewDetail('${nelayan.id}')">
                                <i class="fas fa-info-circle me-1"></i> Lihat Detail
                            </button>
                        </div>
                    </div>
                `;
                
                const marker = L.marker(coordinates, { icon: customIcon })
                    .bindPopup(popupContent)
                    .on('click', function() {
                        this.openPopup();
                    });
                
                markers.addLayer(marker);
                currentMarkers.push(marker);
            });
            
            updateMapStatisticsDisplay(kecamatanCount, desaCount, pemilikKapalCount);
        }

        function updateMapStatisticsDisplay(kecamatanCount, desaCount, pemilikKapalCount) {
            document.getElementById('map-total-points').textContent = appData.length;
            document.getElementById('map-total-kecamatan').textContent = Object.keys(kecamatanCount).length;
            document.getElementById('map-total-desa').textContent = Object.keys(desaCount).length;
            document.getElementById('map-total-kapal').textContent = pemilikKapalCount;
        }

        function updateMapStatistics() {
            if (appData.length === 0) return;
            
            const kecamatanCount = {};
            const desaCount = {};
            let pemilikKapalCount = 0;
            
            appData.forEach(nelayan => {
                kecamatanCount[nelayan.kecamatan] = (kecamatanCount[nelayan.kecamatan] || 0) + 1;
                desaCount[nelayan.desa] = (desaCount[nelayan.desa] || 0) + 1;
                if (nelayan.status === 'Pemilik Kapal') pemilikKapalCount++;
            });
            
            updateMapStatisticsDisplay(kecamatanCount, desaCount, pemilikKapalCount);
        }

        function switchMapView(view) {
            mapView = view;
            
            document.querySelectorAll('.map-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMapMarkers();
            
            let viewName = 'Semua Data';
            if (view === 'profesi') viewName = 'Berdasarkan Profesi';
            else if (view === 'kecamatan') viewName = 'Berdasarkan Kecamatan';
            
            showNotification(`Peta ditampilkan dengan view: ${viewName}`, 'info');
        }

        function resetMapView() {
            if (map) {
                map.setView([-7.7068, 113.9142], 11);
                showNotification('Peta direset ke view awal', 'info');
            }
        }

        function zoomToAllMarkers() {
            if (map && currentMarkers.length > 0) {
                const group = L.featureGroup(currentMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
                showNotification('Zoom ke semua marker', 'info');
            }
        }

        function toggleCluster() {
            const showCluster = document.getElementById('showCluster').checked;
            
            if (showCluster) {
                markers.addTo(map);
                showNotification('Mode grup marker diaktifkan', 'info');
            } else {
                map.removeLayer(markers);
                currentMarkers.forEach(marker => {
                    marker.addTo(map);
                });
                showNotification('Mode grup marker dinonaktifkan', 'info');
            }
        }

        // ================================
        // FUNGSI UNTUK ID CARD
        // ================================
        function safeGenerateIDCard(id) {
            const loadingEl = document.getElementById('idcardLoading');
            const data = appData.find(item => item.id == id);
            
            if (!data) {
                showNotification('Data nelayan tidak ditemukan!', 'error');
                return;
            }
            
            loadingEl.classList.add('active');
            
            setTimeout(() => {
                try {
                    if (typeof window.generateSimataIDCard === 'function') {
                        window.generateSimataIDCard(data);
                    } else {
                        downloadSinglePdf(id);
                        showNotification('ID Card tidak tersedia, mengunduh PDF detail sebagai ganti.', 'warning');
                    }
                } catch (error) {
                    console.error('Error in safeGenerateIDCard:', error);
                    showNotification('Gagal membuat ID Card, coba lagi!', 'error');
                } finally {
                    loadingEl.classList.remove('active');
                }
            }, 100);
        }

        function downloadSinglePdf(id) {
            const data = appData.find(item => item.id == id);
            if (!data) return;
            
            // Implementation of PDF generation
            showNotification('Fitur PDF generation sedang dalam pengembangan', 'info');
        }

        // ================================
        // FUNGSI UNTUK VERIFIKASI KIN
        // ================================
        function verifyKIN() {
            const verifyInput = document.getElementById('verifyInput').value.trim();
            const verifyLoading = document.getElementById('verifyLoading');
            const verifyResultContainer = document.getElementById('verifyResultContainer');
            const verifyButton = document.getElementById('verifyButton');
            
            if (!verifyInput) {
                showNotification('Masukkan NIK atau kode validasi terlebih dahulu!', 'error');
                return;
            }
            
            verifyLoading.style.display = 'block';
            verifyButton.disabled = true;
            
            setTimeout(() => {
                const foundNelayan = findNelayanByIdentifier(verifyInput);
                
                verifyLoading.style.display = 'none';
                verifyButton.disabled = false;
                
                if (foundNelayan) {
                    showVerificationResult(foundNelayan, true);
                } else {
                    showVerificationResult(null, false, verifyInput);
                }
            }, 1500);
        }

        function findNelayanByIdentifier(identifier) {
            if (identifier.length === 16 && /^\d+$/.test(identifier)) {
                return appData.find(n => n.nik === identifier);
            } else {
                return appData.find(n => n.kodeValidasi === identifier);
            }
        }

        function showVerificationResult(nelayanData, isValid, input = '') {
            const verifyResultContainer = document.getElementById('verifyResultContainer');
            const breadcrumbItems = document.querySelectorAll('.verify-breadcrumb-item');
            
            breadcrumbItems[0].classList.remove('active');
            breadcrumbItems[1].classList.add('active');
            
            if (isValid && nelayanData) {
                verifyResultContainer.innerHTML = createVerificationSuccessHTML(nelayanData);
            } else {
                verifyResultContainer.innerHTML = createVerificationErrorHTML(input);
            }
            
            verifyResultContainer.style.display = 'block';
            verifyResultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function createVerificationSuccessHTML(nelayanData) {
            const now = new Date();
            const timestamp = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            let badgeClass = 'badge-profesi-penuh';
            if (nelayanData.profesi === 'Nelayan Sambilan Utama') badgeClass = 'badge-profesi-sambilan-utama';
            else if (nelayanData.profesi === 'Nelayan Sambilan Tambahan') badgeClass = 'badge-profesi-sambilan-tambahan';
            
            return `
                <div class="verify-result-card verify-result-success">
                    <div class="verify-icon-container verify-success-icon verify-success-animation">
                        <i class="fas fa-check"></i>
                    </div>
                    
                    <h3 class="verify-result-title"> KARTU IDENTITAS NELAYAN VALID</h3>
                    
                    <div class="verify-result-message">
                        <p class="mb-3">Sistem telah memverifikasi bahwa <strong>${nelayanData.nama}</strong> tercatat sebagai nelayan resmi yang terdaftar di Sistem Informasi Pemetaan Data Nelayan Terpadu (SIMATA) Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-certificate me-2"></i>
                            <strong>STATUS VERIFIKASI:</strong> BERHASIL - Data sesuai dan tervalidasi
                        </div>
                    </div>
                    
                    <div class="verify-details">
                        <h6 class="fw-bold text-primary mb-3">DETAIL IDENTITAS NELAYAN</h6>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Nama Lengkap</span>
                            <span class="verify-detail-value">${nelayanData.nama}</span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">NIK</span>
                            <span class="verify-detail-value">${nelayanData.nik}</span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Domisili</span>
                            <span class="verify-detail-value">${nelayanData.desa}, ${nelayanData.kecamatan}</span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Profesi</span>
                            <span class="verify-detail-value">
                                <span class="badge ${badgeClass}">${nelayanData.profesi}</span>
                            </span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Status</span>
                            <span class="verify-detail-value">${nelayanData.status}</span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Kode Validasi</span>
                            <span class="verify-detail-value fw-bold text-primary">${nelayanData.kodeValidasi || 'Tidak tersedia'}</span>
                        </div>
                        <div class="verify-detail-row">
                            <span class="verify-detail-label">Tanggal Validasi</span>
                            <span class="verify-detail-value">${nelayanData.tanggalValidasi}</span>
                        </div>
                    </div>
                    
                    <div class="verify-timestamp">
                        <i class="fas fa-clock me-1"></i> Waktu Verifikasi: ${timestamp}
                    </div>
                    
                    <div class="verify-actions">
                        <button type="button" class="btn btn-outline-primary verify-action-btn" onclick="viewDetail('${nelayanData.id}')">
                            <i class="fas fa-eye me-1"></i> Lihat Detail Lengkap
                        </button>
                        <button type="button" class="btn btn-outline-secondary verify-action-btn" onclick="resetVerification()">
                            <i class="fas fa-redo me-1"></i> Verifikasi Lagi
                        </button>
                    </div>
                </div>
            `;
        }

        function createVerificationErrorHTML(input) {
            return `
                <div class="verify-result-card verify-result-error verify-error-animation">
                    <div class="verify-icon-container verify-error-icon">
                        <i class="fas fa-times"></i>
                    </div>
                    
                    <h3 class="verify-result-title"> KARTU IDENTITAS TIDAK TERDAFTAR</h3>
                    
                    <div class="verify-result-message">
                        <p class="mb-3">Sistem <strong>TIDAK DAPAT</strong> menemukan data nelayan dengan identitas <strong>"${input}"</strong> dalam database Sistem Informasi Pemetaan Data Nelayan Terpadu (SIMATA) Dinas Perikanan Kabupaten Situbondo.</p>
                        
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>STATUS VERIFIKASI:</strong> GAGAL - Data tidak ditemukan dalam sistem
                        </div>
                    </div>
                    
                    <div class="verify-details">
                        <h6 class="fw-bold text-danger mb-3">KEMUNGKINAN PENYEBAB</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent"><i class="fas fa-times text-danger me-2"></i> NIK atau kode validasi salah</li>
                            <li class="list-group-item bg-transparent"><i class="fas fa-times text-danger me-2"></i> Data belum terdaftar dalam sistem</li>
                            <li class="list-group-item bg-transparent"><i class="fas fa-times text-danger me-2"></i> Kartu identitas tidak valid atau kadaluarsa</li>
                            <li class="list-group-item bg-transparent"><i class="fas fa-times text-danger me-2"></i> Kesalahan input data</li>
                        </ul>
                    </div>
                    
                    <div class="verify-timestamp">
                        <i class="fas fa-clock me-1"></i> Waktu Verifikasi: ${new Date().toLocaleString('id-ID')}
                    </div>
                    
                    <div class="verify-actions">
                        <button type="button" class="btn btn-danger verify-action-btn" onclick="resetVerification()">
                            <i class="fas fa-redo me-1"></i> Coba Lagi
                        </button>
                        <button type="button" class="btn btn-outline-secondary verify-action-btn" onclick="document.getElementById('v-pills-input-tab').click()">
                            <i class="fas fa-user-plus me-1"></i> Daftarkan Nelayan Baru
                        </button>
                    </div>
                </div>
            `;
        }

        function resetVerification() {
            const verifyInput = document.getElementById('verifyInput');
            const verifyResultContainer = document.getElementById('verifyResultContainer');
            const breadcrumbItems = document.querySelectorAll('.verify-breadcrumb-item');
            
            verifyInput.value = '';
            verifyResultContainer.style.display = 'none';
            verifyResultContainer.innerHTML = '';
            
            breadcrumbItems[0].classList.add('active');
            breadcrumbItems[1].classList.remove('active');
            
            verifyInput.focus();
        }

        function openQRScanner() {
            showNotification('Fitur QR Scanner akan segera tersedia dalam versi selanjutnya.', 'info');
            
            setTimeout(() => {
                const qrData = "VLD-ABC123";
                document.getElementById('verifyInput').value = qrData;
                showNotification('QR Code berhasil dipindai! Klik "Verifikasi Sekarang" untuk melanjutkan.', 'success');
            }, 1000);
        }

        function toggleFAQ(id) {
            const answer = document.getElementById(`faqAnswer${id}`);
            const icon = document.querySelector(`#faqAnswer${id}`).parentElement.querySelector('i');
            
            if (answer.style.display === 'block') {
                answer.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                answer.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // ================================
        // FUNGSI UTILITAS
        // ================================
        function maskData(data, force = false) {
            if (!data) return "-";
            if (data === '00000000') return "Tidak Ada";
            if (!appSettings.privacyMode && !force) return data.toString();
            
            let str = data.toString();
            if (str.length <= 4) return str;
            
            const maskedLength = Math.min(4, str.length);
            const visiblePart = str.slice(0, -maskedLength);
            const maskedPart = '*'.repeat(maskedLength);
            
            return visiblePart + maskedPart;
        }

        function showNotification(message, type = 'info') {
            const toast = document.querySelector('.notification-toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            let title = 'Notifikasi';
            let bgClass = 'bg-primary';
            
            switch (type) {
                case 'success':
                    title = 'Sukses';
                    bgClass = 'bg-success';
                    break;
                case 'error':
                    title = 'Error';
                    bgClass = 'bg-danger';
                    break;
                case 'warning':
                    title = 'Peringatan';
                    bgClass = 'bg-warning';
                    break;
                case 'info':
                    title = 'Informasi';
                    bgClass = 'bg-info';
                    break;
            }
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toast.querySelector('.toast-header').classList.add(bgClass, 'text-white');
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function populateKecamatanDropdown() {
            const kecSelect = document.getElementById('kecamatan');
            kecSelect.innerHTML = `<option value="">Pilih Kecamatan</option>`;
            Object.keys(SITUBONDO_DATA).sort().forEach(kec => kecSelect.add(new Option(kec, kec)));
        }

        function initFishOptions() {
            const container = document.getElementById('fishCheckboxContainer');
            container.innerHTML = '';
            
            FISH_TYPES.forEach(fish => {
                const id = 'fish_' + fish.replace(/\s/g, '');
                const html = `
                <label class="fish-option-box">
                    <input type="checkbox" class="form-check-input me-2 fish-checkbox" value="${fish}" id="${id}">
                    <span>${fish}</span>
                </label>`;
                container.innerHTML += html;
            });
            
            document.getElementById('fish_Lainnya').addEventListener('change', function() {
                const inputLain = document.getElementById('jenisIkanLainnya');
                if (this.checked) {
                    inputLain.style.display = 'block';
                    inputLain.setAttribute('required', 'required');
                } else {
                    inputLain.style.display = 'none';
                    inputLain.value = '';
                    inputLain.removeAttribute('required');
                }
            });
        }

        function setupInfoTooltips() {
            const alatTangkapSelect = document.getElementById('alatTangkap');
            const apiInfoDiv = document.getElementById('apiInfo');
            
            alatTangkapSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && API_INFO[selected]) {
                    apiInfoDiv.style.display = 'block';
                    apiInfoDiv.innerHTML = `<strong>${selected}:</strong> ${API_INFO[selected]}`;
                } else {
                    apiInfoDiv.style.display = 'none';
                }
            });
            
            const jenisKapalSelect = document.getElementById('jenisKapal');
            const kapalInfoDiv = document.getElementById('kapalInfo');
            
            jenisKapalSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected && KAPAL_INFO[selected]) {
                    kapalInfoDiv.style.display = 'block';
                    kapalInfoDiv.innerHTML = `<strong>${selected}:</strong> ${KAPAL_INFO[selected]}`;
                } else {
                    kapalInfoDiv.style.display = 'none';
                }
            });
        }

        function setupProfesiInfo() {
            const profesiSelect = document.getElementById('profesi');
            const profesiHelp = document.getElementById('profesiHelp');
            
            profesiSelect.addEventListener('change', function() {
                const selected = this.value;
                if (selected) {
                    profesiHelp.innerHTML = `
                        <div class="profesi-info-box">
                            <div class="profesi-info-title">${selected}</div>
                            <div class="profesi-info-desc">Informasi tentang ${selected}</div>
                        </div>
                    `;
                } else {
                    profesiHelp.innerHTML = '';
                }
            });
        }

        function updateAppIdentity() {
            appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
            document.querySelector('.app-title').textContent = appSettings.appName;
            document.getElementById('dynamicSubtitle').textContent = appSettings.appSubtitle;
            document.getElementById('itemsPerPageSelect').value = appSettings.itemsPerPage;
            document.getElementById('appName').value = appSettings.appName;
            document.getElementById('appSubtitle').value = appSettings.appSubtitle;
        }

        function updatePrivacyUI() {
            const toggle = document.getElementById('privacyToggle');
            const status = document.getElementById('privacyStatus');
            const sensorText = document.getElementById('sensorStatusText');
            
            toggle.checked = appSettings.privacyMode;
            
            if (appSettings.privacyMode) {
                status.innerHTML = "Status: <span class='text-success'>Sensor Aktif (Aman)</span>";
                sensorText.innerHTML = "Sensor: ON";
                sensorText.className = "badge bg-success me-2";
            } else {
                status.innerHTML = "Status: <span class='text-danger'>Sensor Non-Aktif (Terbuka)</span>";
                sensorText.innerHTML = "Sensor: OFF";
                sensorText.className = "badge bg-danger me-2";
            }
        }

        function startDuplicateChecker() {
            checkGlobalDuplicates();
            duplicateCheckInterval = setInterval(checkGlobalDuplicates, 15000);
        }

        function checkGlobalDuplicates() {
            const counts = {};
            let hasDuplicate = false;
            
            for (const d of appData) {
                counts[d.nik] = (counts[d.nik] || 0) + 1;
                if (counts[d.nik] > 1) {
                    hasDuplicate = true;
                    break;
                }
            }
            
            document.getElementById('duplicateWarning').style.display = hasDuplicate ? 'block' : 'none';
        }

        function setupFloatingMenu() {
            const fabMain = document.getElementById('fabMainBtn');
            const container = document.getElementById('fabMenu');
            
            fabMain.addEventListener('click', () => {
                container.classList.toggle('open');
                const icon = fabMain.querySelector('i');
                
                if (container.classList.contains('open')) {
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-times');
                    fabMain.style.transform = "rotate(90deg)";
                } else {
                    icon.classList.add('fa-plus');
                    icon.classList.remove('fa-times');
                    fabMain.style.transform = "rotate(0deg)";
                }
            });
            
            const shortcuts = {
                'fabInput': 'v-pills-input-tab',
                'fabFilter': 'v-pills-filter-tab',
                'fabExport': 'v-pills-export-tab',
                'fabBackup': 'v-pills-backup-tab',
                'fabSettings': 'v-pills-settings-tab'
            };
            
            for (const [id, tabId] of Object.entries(shortcuts)) {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById(tabId).click();
                    container.classList.remove('open');
                });
            }
            
            document.getElementById('fabReload').addEventListener('click', (e) => {
                e.preventDefault();
                handleReloadRepo();
            });
        }

        function handleReloadRepo() {
            showNotification('Fitur reload data sedang dalam pengembangan', 'info');
        }

        function exportData(type) {
            if (appData.length === 0) {
                showNotification('Tidak ada data', 'error');
                return;
            }
            
            showNotification('Fitur ekspor data sedang dalam pengembangan', 'info');
        }

        function printData() {
            showNotification('Fitur cetak laporan sedang dalam pengembangan', 'info');
        }

        function backupData() {
            showNotification('Fitur backup data sedang dalam pengembangan', 'info');
        }

        function restoreData() {
            showNotification('Fitur restore data sedang dalam pengembangan', 'info');
        }

        function sendDataToWhatsapp() {
            showNotification('Fitur kirim ke WhatsApp sedang dalam pengembangan', 'info');
        }

        // ================================
        // EVENT LISTENERS SETUP
        // ================================
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Password toggle
            document.getElementById('passwordToggle').addEventListener('click', togglePasswordVisibility);
            
            // Form submissions
            document.getElementById('inputForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('inputForm').addEventListener('reset', handleFormReset);
            
            // Form field listeners
            document.getElementById('kecamatan').addEventListener('change', handleKecamatanChange);
            document.getElementById('statusNelayan').addEventListener('change', handleStatusChange);
            document.getElementById('tahunLahir').addEventListener('input', calculateAge);
            document.getElementById('generateKodeBtn').addEventListener('click', generateValidationCode);
            document.getElementById('btnNoWA').addEventListener('click', toggleWAField);
            
            // Table interactions
            document.getElementById('searchData').addEventListener('input', renderDataTable);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteData);
            
            // Navigation
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('sidebarOverlay').addEventListener('click', closeMobileMenu);
            document.getElementById('v-pills-logout-tab').addEventListener('click', handleLogout);
            
            // Verification
            document.getElementById('verifyButton').addEventListener('click', verifyKIN);
            document.getElementById('verifyInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyKIN();
                }
            });
            
            // Settings
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsSave);
            document.getElementById('sensorCodeForm').addEventListener('submit', handleSensorCodeUpdate);
            document.getElementById('privacyToggle').addEventListener('click', togglePrivacyMode);
            
            // Other buttons
            document.getElementById('btnContinueDashboard').addEventListener('click', continueToDashboard);
            document.getElementById('btnWelcomeReload').addEventListener('click', handleWelcomeReload);
            document.getElementById('btnDownloadDetailPdf').addEventListener('click', () => downloadSinglePdf(currentDetailId));
            
            // Initialize floating menu
            setupFloatingMenu();
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const btn = document.getElementById('loginButton');
            const spinner = document.getElementById('loginSpinner');
            const inputCode = document.getElementById('securityCode').value;
            const correctCode = generateSecurityCode();
            
            if (inputCode !== correctCode) {
                showNotification('Kode keamanan salah! Periksa kembali atau hubungi administrator.', 'error');
                return;
            }
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            btn.innerHTML = 'MEMBUKA SISTEM... <span class="spinner-border spinner-border-sm ms-2"></span>';
            
            setTimeout(() => {
                sessionStorage.setItem('simata_session', 'active');
                
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                
                initializeCharts();
                updateDashboard();
                renderDataTable();
                
                setTimeout(() => {
                    initializeMap();
                }, 500);
                
                const loginSuccessModal = new bootstrap.Modal(document.getElementById('loginSuccessModal'));
                loginSuccessModal.show();
                
                btn.disabled = false;
                spinner.classList.add('d-none');
                btn.innerHTML = 'BUKA DASHBOARD';
            }, 1200);
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('securityCode');
            const icon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                this.title = "Sembunyikan kode";
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                this.title = "Lihat kode";
            }
        }

        function handleFormReset() {
            setTimeout(() => {
                document.getElementById('ownerFields').style.display = 'none';
                document.getElementById('usia').value = '';
                document.getElementById('desa').disabled = true;
                document.getElementById('desa').innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
                document.getElementById('inputForm').removeAttribute('data-edit-id');
                document.querySelectorAll('.fish-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('jenisIkanLainnya').style.display = 'none';
                
                const kv = document.getElementById('kodeValidasi');
                kv.value = '';
                kv.removeAttribute('readonly');
                
                const waInput = document.getElementById('whatsapp');
                waInput.removeAttribute('readonly');
                const btnWa = document.getElementById('btnNoWA');
                btnWa.classList.remove('active', 'btn-secondary');
                btnWa.classList.add('btn-outline-secondary');
                btnWa.textContent = "Tidak Ada";
                
                document.getElementById('apiInfo').style.display = 'none';
                document.getElementById('kapalInfo').style.display = 'none';
                document.getElementById('profesiHelp').innerHTML = '';
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalValidasi').value = today;
            }, 100);
        }

        function handleKecamatanChange() {
            const selectedKec = this.value;
            const desaSelect = document.getElementById('desa');
            desaSelect.innerHTML = `<option value="">Pilih Desa / Kelurahan</option>`;
            
            if (selectedKec && SITUBONDO_DATA[selectedKec]) {
                desaSelect.disabled = false;
                SITUBONDO_DATA[selectedKec].sort().forEach(desa => desaSelect.add(new Option(desa, desa)));
            } else {
                desaSelect.disabled = true;
                desaSelect.innerHTML = `<option value="">-- Pilih Kecamatan Terlebih Dahulu --</option>`;
            }
        }

        function handleStatusChange() {
            const isOwner = this.value === 'Pemilik Kapal';
            const ownerFields = document.getElementById('ownerFields');
            ownerFields.style.display = isOwner ? 'block' : 'none';
            
            if (!isOwner) {
                document.getElementById('namaKapal').value = '';
                document.getElementById('jenisKapal').value = '';
                document.getElementById('kapalInfo').style.display = 'none';
            }
        }

        function calculateAge() {
            const year = parseInt(this.value);
            const currentYear = new Date().getFullYear();
            
            if (year && this.value.length === 4 && year <= currentYear && year >= 1900) {
                document.getElementById('usia').value = currentYear - year;
            }
        }

        function generateValidationCode() {
            const nik = document.getElementById('nik').value;
            const kodeInput = document.getElementById('kodeValidasi');
            
            if (kodeInput.value && kodeInput.value.trim() !== '') {
                showNotification('Kode Validasi sudah digenerate dan bersifat permanen!', 'warning');
                return;
            }
            
            if (nik.length !== 16) {
                showNotification('Isi NIK 16 digit terlebih dahulu!', 'error');
                return;
            }
            
            const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
            kodeInput.value = 'VLD-' + randomPart;
            showNotification('Kode Validasi berhasil dibuat dan terkunci.', 'success');
        }

        function toggleWAField() {
            const input = document.getElementById('whatsapp');
            
            if (input.hasAttribute('readonly')) {
                input.removeAttribute('readonly');
                input.value = '';
                input.setAttribute('required', 'required');
                this.classList.remove('active', 'btn-secondary');
                this.classList.add('btn-outline-secondary');
                this.textContent = "Tidak Ada";
            } else {
                input.value = '00000000';
                input.setAttribute('readonly', true);
                input.removeAttribute('required');
                this.classList.add('active', 'btn-secondary');
                this.classList.remove('btn-outline-secondary');
                this.textContent = "Batal";
            }
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            toggleBulkDeleteBtn();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('mobile-show');
            overlay.classList.add('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('mobile-show');
            overlay.classList.remove('active');
        }

        function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar? Sistem akan mengunduh data (reload.js) secara otomatis.')) {
                sessionStorage.removeItem('simata_session');
                backupData('reload.js');
                setTimeout(() => location.reload(), 2000);
            }
        }

        function handleSettingsSave(e) {
            e.preventDefault();
            appSettings.appName = "SISTEM PEMETAAN DATA NELAYAN";
            appSettings.appSubtitle = document.getElementById('appSubtitle').value;
            appSettings.itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value);
            saveSettings();
            updateAppIdentity();
            renderDataTable();
            showNotification('Pengaturan tersimpan! Nama instansi berhasil diperbarui.', 'success');
        }

        function handleSensorCodeUpdate(e) {
            e.preventDefault();
            
            const currentCode = document.getElementById('currentSensorCode').value;
            const newCode = document.getElementById('newSensorCode').value;
            const confirmCode = document.getElementById('confirmSensorCode').value;
            
            if (currentCode !== appSettings.securityCodeSensor) {
                showNotification('Kode keamanan sensor saat ini salah!', 'error');
                return;
            }
            
            if (newCode.length < 6) {
                showNotification('Kode keamanan baru minimal 6 digit!', 'error');
                return;
            }
            
            if (newCode !== confirmCode) {
                showNotification('Konfirmasi kode baru tidak cocok!', 'error');
                return;
            }
            
            appSettings.securityCodeSensor = newCode;
            saveSettings();
            
            document.getElementById('currentSensorCode').value = '';
            document.getElementById('newSensorCode').value = '';
            document.getElementById('confirmSensorCode').value = '';
            
            showNotification('Kode keamanan sensor berhasil diperbarui!', 'success');
        }

        function togglePrivacyMode(e) {
            e.preventDefault();
            const currentStatus = appSettings.privacyMode;
            
            if (currentStatus === true) {
                const code = prompt("MASUKKAN KODE KEAMANAN SENSOR untuk menonaktifkan sensor:");
                if (code === appSettings.securityCodeSensor) {
                    appSettings.privacyMode = false;
                    saveSettings();
                    updatePrivacyUI();
                    renderDataTable();
                    showNotification('Sensor Data dinonaktifkan.', 'warning');
                } else {
                    alert("Kode Keamanan Sensor Salah!");
                    this.checked = true;
                }
            } else {
                appSettings.privacyMode = true;
                saveSettings();
                updatePrivacyUI();
                renderDataTable();
                showNotification('Sensor Data diaktifkan.', 'success');
            }
        }

        function continueToDashboard() {
            const loginSuccessModal = bootstrap.Modal.getInstance(document.getElementById('loginSuccessModal'));
            loginSuccessModal.hide();
            
            setTimeout(() => {
                const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                welcomeModal.show();
            }, 300);
        }

        function handleWelcomeReload() {
            const welcomeModal = bootstrap.Modal.getInstance(document.getElementById('welcomeModal'));
            welcomeModal.hide();
            handleReloadRepo();
        }

        // ================================
        // INISIALISASI APLIKASI
        // ================================
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                setupEventListeners();
                displayCurrentDate();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalValidasi').value = today;
                
                const isSessionActive = sessionStorage.getItem('simata_session') === 'active';
                if (isSessionActive) {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initializeCharts();
                    updateDashboard();
                    renderDataTable();
                    
                    setTimeout(() => {
                        initializeMap();
                    }, 500);
                } else {
                    setTimeout(() => {
                        document.getElementById('loginModal').style.display = 'flex';
                    }, 100);
                }
                
                // Handle hash routing untuk verifikasi
                handleHashRouting();
            } catch (error) {
                console.error("Initialization Error:", error);
                alert("Terjadi kesalahan sistem saat memuat. Silakan refresh.");
            }
        });

        function handleHashRouting() {
            const hash = window.location.hash;
            
            if (hash === '#verifikasi') {
                document.getElementById('v-pills-verify-tab').click();
                
                setTimeout(() => {
                    document.getElementById('v-pills-verify').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }

        // Ekspor fungsi ke global scope
        window.verifyKIN = verifyKIN;
        window.openQRScanner = openQRScanner;
        window.toggleFAQ = toggleFAQ;
        window.resetVerification = resetVerification;
        window.generateSimataIDCard = safeGenerateIDCard;
        window.switchMapView = switchMapView;
        window.resetMapView = resetMapView;
        window.zoomToAllMarkers = zoomToAllMarkers;
        window.toggleCluster = toggleCluster;
        window.viewDetail = viewDetail;
        window.editData = editData;
        window.deleteData = deleteData;
        window.toggleBulkDeleteBtn = toggleBulkDeleteBtn;
    </script>
</body>
</html>
