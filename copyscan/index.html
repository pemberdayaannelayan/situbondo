<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Data Ganda Berdasarkan NIK KTP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .card {
            background-color: #f9fafc;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #2a5298;
        }
        
        h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #2a5298;
        }
        
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .file-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-input-wrapper {
            position: relative;
            flex-grow: 1;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed #c2c9d6;
            border-radius: 8px;
            background-color: white;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input:hover {
            border-color: #2a5298;
            background-color: #f0f5ff;
        }
        
        .supported-formats {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #2a5298;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.2);
        }
        
        .btn-secondary {
            background-color: #f0f5ff;
            color: #2a5298;
            border: 1px solid #c2c9d6;
        }
        
        .btn-secondary:hover {
            background-color: #e1e9ff;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .info-box {
            background-color: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #2a5298;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #1e3c72;
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-item {
            flex: 1;
            min-width: 150px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            border-top: 4px solid #2a5298;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2a5298;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th {
            background-color: #2a5298;
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eaeaea;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafc;
        }
        
        tr:hover {
            background-color: #f0f5ff;
        }
        
        .duplicate-row {
            background-color: #fff5f5 !important;
        }
        
        .selected-row {
            background-color: #f0fff4 !important;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            margin-top: 20px;
        }
        
        .duplicate-badge {
            background-color: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .selected-badge {
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .download-options {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eaeaea;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f0f0f0;
            border-top: 5px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 14px;
        }
        
        /* Notification Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background-color: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            border-left: 5px solid #2a5298;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success {
            border-left-color: #28a745;
        }
        
        .toast-warning {
            border-left-color: #ffc107;
        }
        
        .toast-error {
            border-left-color: #dc3545;
        }
        
        .toast-info {
            border-left-color: #17a2b8;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-success .toast-icon {
            color: #28a745;
        }
        
        .toast-warning .toast-icon {
            color: #ffc107;
        }
        
        .toast-error .toast-icon {
            color: #dc3545;
        }
        
        .toast-info .toast-icon {
            color: #17a2b8;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            color: #555;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #333;
        }
        
        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #2a5298;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .card {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            .file-input-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .stat-item {
                min-width: 100%;
            }
            
            .toast {
                min-width: 250px;
            }
            
            .toast-container {
                left: 20px;
                right: 20px;
                top: 10px;
            }
            
            .download-options {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Memproses data...</div>
            <div class="loading-subtext" id="loadingSubtext">Silakan tunggu, proses sedang berjalan</div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>
    
    <!-- Notification Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Main Container -->
    <div class="container">
        <header>
            <h1><i class="fas fa-filter"></i> Filter Data Ganda Berdasarkan NIK KTP</h1>
            <p class="subtitle">Impor data Excel/CSV dan hapus duplikat berdasarkan NIK dengan memilih data yang paling lengkap</p>
        </header>
        
        <div class="main-content">
            <div class="card">
                <h2><i class="fas fa-upload"></i> Impor Data Spreadsheet</h2>
                <div class="upload-section">
                    <p>Unggah file Excel (.xlsx, .xls) atau CSV (.csv) yang berisi data dengan kolom: <strong>NAMA, NIK, ALAMAT, KECAMATAN, DESA, NOMOR_HP, PROFESI, ALAT_TANGKAP, JENIS_KAPAL</strong></p>
                    
                    <div class="file-input-container">
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv, .txt, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel, text/csv">
                            <div class="supported-formats">
                                <i class="fas fa-info-circle"></i> Format yang didukung: .xlsx, .xls, .csv
                            </div>
                        </div>
                        <button id="processBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-cogs"></i> Proses Data
                        </button>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Fitur Aplikasi:</strong></p>
                        <ul>
                            <li>Mendeteksi data ganda berdasarkan NIK KTP secara otomatis</li>
                            <li>Memilih data dengan isian paling lengkap untuk setiap NIK</li>
                            <li>Mendukung berbagai format file: Excel (.xlsx, .xls) dan CSV (.csv)</li>
                            <li>Unduh hasil dalam format Excel (.xlsx) atau CSV (.csv)</li>
                            <li>Statistik lengkap dan notifikasi real-time</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Statistik Data</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalData">0</div>
                        <div class="stat-label">Total Data</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="duplicateData">0</div>
                        <div class="stat-label">Data Ganda</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="uniqueData">0</div>
                        <div class="stat-label">Data Unik</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="selectedData">0</div>
                        <div class="stat-label">Data Terpilih</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-table"></i> Data yang Diproses</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fff5f5;"></div>
                        <span>Data Ganda</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f0fff4;"></div>
                        <span>Data Terpilih (Paling Lengkap)</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NAMA</th>
                                <th>NIK</th>
                                <th>ALAMAT</th>
                                <th>KECAMATAN</th>
                                <th>DESA</th>
                                <th>NOMOR_HP</th>
                                <th>PROFESI</th>
                                <th>ALAT_TANGKAP</th>
                                <th>JENIS_KAPAL</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-file-excel" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    Belum ada data. Silakan unggah file Excel/CSV untuk memulai.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="controls">
                    <button id="filterBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-filter"></i> Filter Data Ganda
                    </button>
                    
                    <div class="download-options">
                        <button id="downloadBtn" class="btn btn-success" disabled>
                            <i class="fas fa-download"></i> Unduh Hasil Filter
                        </button>
                        <div class="format-option">
                            <input type="radio" id="formatExcel" name="downloadFormat" value="excel" checked>
                            <label for="formatExcel">Excel (.xlsx)</label>
                        </div>
                        <div class="format-option">
                            <input type="radio" id="formatCSV" name="downloadFormat" value="csv">
                            <label for="formatCSV">CSV (.csv)</label>
                        </div>
                    </div>
                    
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Aplikasi Filter Data Ganda Berdasarkan NIK KTP &copy; 2023</p>
            <p>Data duplikat akan digantikan dengan data yang lebih lengkap isiannya</p>
        </div>
    </div>

    <script>
        // Variabel global untuk menyimpan data
        let originalData = [];
        let filteredData = [];
        let duplicateGroups = {};
        let isProcessing = false;
        
        // Elemen DOM
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const filterBtn = document.getElementById('filterBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tableBody = document.getElementById('tableBody');
        const totalDataEl = document.getElementById('totalData');
        const duplicateDataEl = document.getElementById('duplicateData');
        const uniqueDataEl = document.getElementById('uniqueData');
        const selectedDataEl = document.getElementById('selectedData');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtext = document.getElementById('loadingSubtext');
        const toastContainer = document.getElementById('toastContainer');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const formatExcel = document.getElementById('formatExcel');
        const formatCSV = document.getElementById('formatCSV');
        
        // Kolom yang akan diproses
        const columns = ['NAMA', 'NIK', 'ALAMAT', 'KECAMATAN', 'DESA', 'NOMOR_HP', 'PROFESI', 'ALAT_TANGKAP', 'JENIS_KAPAL'];
        const columnAliases = {
            'NAMA': ['Nama', 'nama', 'Nama Lengkap', 'nama lengkap'],
            'NIK': ['Nik', 'nik', 'Nomor Induk Kependudukan'],
            'ALAMAT': ['Alamat', 'alamat', 'Alamat Lengkap'],
            'KECAMATAN': ['Kecamatan', 'kecamatan', 'KEC'],
            'DESA': ['Desa', 'desa', 'Kelurahan', 'kelurahan'],
            'NOMOR_HP': ['Nomor HP', 'nomor hp', 'Telepon', 'telepon', 'No HP', 'no hp', 'Handphone'],
            'PROFESI': ['Profesi', 'profesi', 'Pekerjaan', 'pekerjaan'],
            'ALAT_TANGKAP': ['Alat Tangkap', 'alat tangkap', 'Alat Tangkap Ikan'],
            'JENIS_KAPAL': ['Jenis Kapal', 'jenis kapal', 'Tipe Kapal', 'tipe kapal']
        };
        
        // Event listener untuk input file
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();
                
                // Validasi ekstensi file
                const validExtensions = ['xlsx', 'xls', 'csv', 'txt'];
                if (!validExtensions.includes(fileExt)) {
                    showNotification('error', 'Format Tidak Didukung', 'Hanya file Excel (.xlsx, .xls) dan CSV (.csv) yang didukung.');
                    fileInput.value = '';
                    processBtn.disabled = true;
                    return;
                }
                
                processBtn.disabled = false;
                showNotification('success', 'File Dipilih', `File "${fileName}" siap untuk diproses`);
            } else {
                processBtn.disabled = true;
            }
        });
        
        // Proses file yang diunggah
        processBtn.addEventListener('click', async function() {
            if (isProcessing) return;
            
            const file = fileInput.files[0];
            if (!file) {
                showNotification('error', 'Kesalahan', 'Silakan pilih file terlebih dahulu.');
                return;
            }
            
            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            
            // Tampilkan loading
            showLoading('Memproses File', `Membaca data dari ${fileName}...`);
            
            try {
                isProcessing = true;
                
                // Update progress
                updateProgress(10, 'Membaca file...');
                
                let data;
                
                // Proses berdasarkan tipe file
                if (fileExt === 'csv' || fileExt === 'txt') {
                    updateProgress(30, 'Membaca file CSV...');
                    data = await readCSVFile(file);
                } else {
                    updateProgress(30, 'Membaca file Excel...');
                    data = await readExcelFile(file);
                }
                
                if (data.length === 0) {
                    hideLoading();
                    showNotification('warning', 'Data Kosong', 'Tidak ada data yang valid ditemukan dalam file.');
                    isProcessing = false;
                    return;
                }
                
                updateProgress(60, 'Memvalidasi data...');
                
                // Simpan data asli
                originalData = data;
                
                updateProgress(80, 'Menyiapkan tampilan...');
                
                // Tampilkan data awal
                displayData(originalData);
                updateStats(originalData);
                
                // Aktifkan tombol filter
                filterBtn.disabled = false;
                downloadBtn.disabled = true;
                
                updateProgress(100, 'Selesai!');
                
                setTimeout(() => {
                    hideLoading();
                    showNotification('success', 'Berhasil', `Berhasil membaca ${originalData.length} data dari ${fileName}.`);
                    isProcessing = false;
                }, 500);
                
            } catch (error) {
                console.error('Error processing file:', error);
                hideLoading();
                showNotification('error', 'Kesalahan', `Gagal memproses file: ${error.message}`);
                isProcessing = false;
            }
        });
        
        // Fungsi untuk membaca file CSV
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const lines = csvText.split('\n');
                        
                        if (lines.length < 2) {
                            resolve([]);
                            return;
                        }
                        
                        // Deteksi separator (koma atau titik koma)
                        const firstLine = lines[0];
                        const hasSemicolon = firstLine.includes(';');
                        const separator = hasSemicolon ? ';' : ',';
                        
                        // Parse header
                        const headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''));
                        
                        // Normalisasi header (cocokkan dengan nama kolom standar)
                        const normalizedHeaders = normalizeHeaders(headers);
                        
                        // Proses data
                        const processedData = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const row = parseCSVLine(lines[i], separator);
                            const rowData = {};
                            
                            normalizedHeaders.forEach((col, index) => {
                                if (col && index < row.length) {
                                    rowData[col] = row[index] !== undefined && row[index] !== null ? 
                                                  String(row[index]).trim().replace(/"/g, '') : '';
                                }
                            });
                            
                            // Hanya tambah data yang memiliki NIK
                            if (rowData.NIK && rowData.NIK.trim() !== '') {
                                // Tambahkan ID unik untuk melacak baris asli
                                rowData.__id = `csv_row_${i}`;
                                processedData.push(rowData);
                            }
                        }
                        
                        resolve(processedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Gagal membaca file CSV'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // Fungsi untuk membaca file Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Ambil data dari sheet pertama
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Konversi ke JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            resolve([]);
                            return;
                        }
                        
                        // Proses data: baris pertama sebagai header
                        const headers = jsonData[0].map(h => h ? String(h).trim() : '');
                        
                        // Normalisasi header
                        const normalizedHeaders = normalizeHeaders(headers);
                        
                        // Ambil data dari baris kedua dan seterusnya
                        const processedData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            const rowData = {};
                            normalizedHeaders.forEach((col, index) => {
                                if (col && index < row.length) {
                                    rowData[col] = row[index] !== undefined && row[index] !== null ? 
                                                  String(row[index]).trim() : '';
                                }
                            });
                            
                            // Hanya tambah data yang memiliki NIK
                            if (rowData.NIK && rowData.NIK.trim() !== '') {
                                // Tambahkan ID unik untuk melacak baris asli
                                rowData.__id = `excel_row_${i}`;
                                processedData.push(rowData);
                            }
                        }
                        
                        resolve(processedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Gagal membaca file Excel'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Normalisasi header untuk mencocokkan dengan nama kolom standar
        function normalizeHeaders(headers) {
            return headers.map(header => {
                if (!header) return null;
                
                const headerLower = header.toLowerCase().trim();
                
                // Cek setiap kolom standar dan aliasnya
                for (const [standardCol, aliases] of Object.entries(columnAliases)) {
                    if (headerLower === standardCol.toLowerCase()) {
                        return standardCol;
                    }
                    
                    // Cek alias
                    for (const alias of aliases) {
                        if (headerLower === alias.toLowerCase()) {
                            return standardCol;
                        }
                    }
                }
                
                // Jika tidak cocok dengan apapun, kembalikan null
                return null;
            });
        }
        
        // Parse line CSV yang mungkin memiliki koma di dalam quotes
        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Fungsi untuk menampilkan data di tabel
        function displayData(data, highlightDuplicates = false) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            Tidak ada data untuk ditampilkan.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Tentukan apakah perlu menyorot duplikat
            const nikCounts = {};
            data.forEach(item => {
                nikCounts[item.NIK] = (nikCounts[item.NIK] || 0) + 1;
            });
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Tentukan kelas untuk baris
                let rowClass = '';
                let statusBadge = '';
                
                if (highlightDuplicates) {
                    const isDuplicate = nikCounts[item.NIK] > 1;
                    const isSelected = duplicateGroups[item.NIK] && 
                                      duplicateGroups[item.NIK].selectedId === item.__id;
                    
                    if (isSelected) {
                        rowClass = 'selected-row';
                        statusBadge = '<span class="selected-badge">Terpilih</span>';
                    } else if (isDuplicate) {
                        rowClass = 'duplicate-row';
                        statusBadge = '<span class="duplicate-badge">Ganda</span>';
                    }
                }
                
                row.className = rowClass;
                
                // Hitung jumlah kolom yang terisi (tidak kosong)
                const filledColumns = columns.filter(col => item[col] && item[col].toString().trim() !== '').length;
                
                // Format nomor HP jika ada
                const nomorHP = item.NOMOR_HP || '';
                const formattedHP = nomorHP && !isNaN(nomorHP.replace(/\D/g, '')) && nomorHP.replace(/\D/g, '').length >= 10 
                    ? formatPhoneNumber(nomorHP) 
                    : nomorHP;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.NAMA || ''}</td>
                    <td>${formatNIK(item.NIK)}</td>
                    <td>${item.ALAMAT || ''}</td>
                    <td>${item.KECAMATAN || ''}</td>
                    <td>${item.DESA || ''}</td>
                    <td>${formattedHP}</td>
                    <td>${item.PROFESI || ''}</td>
                    <td>${item.ALAT_TANGKAP || ''}</td>
                    <td>${item.JENIS_KAPAL || ''}</td>
                    <td>${statusBadge} <br><small>${filledColumns}/9 kolom terisi</small></td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Format NIK untuk tampilan
        function formatNIK(nik) {
            if (!nik) return '';
            const cleanNIK = nik.toString().replace(/\D/g, '');
            if (cleanNIK.length !== 16) return nik;
            return `${cleanNIK.substring(0, 4)}.${cleanNIK.substring(4, 8)}.${cleanNIK.substring(8, 12)}.${cleanNIK.substring(12)}`;
        }
        
        // Format nomor telepon
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.length === 0) return phone;
            
            if (cleaned.startsWith('0')) {
                return cleaned.replace(/(\d{4})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (cleaned.startsWith('62')) {
                return cleaned.replace(/(\d{2})(\d{4})(\d{4})(\d{4})/, '+$1 $2-$3-$4');
            } else if (cleaned.length <= 10) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            } else {
                return cleaned.replace(/(\d{4})(\d{4})(\d{4,})/, '$1-$2-$3');
            }
        }
        
        // Fungsi untuk memperbarui statistik
        function updateStats(data) {
            totalDataEl.textContent = data.length.toLocaleString('id-ID');
            
            // Hitung jumlah data unik berdasarkan NIK
            const uniqueNiks = new Set(data.map(item => item.NIK));
            uniqueDataEl.textContent = uniqueNiks.size.toLocaleString('id-ID');
            
            // Hitung jumlah data ganda
            const duplicateCount = data.length - uniqueNiks.size;
            duplicateDataEl.textContent = duplicateCount.toLocaleString('id-ID');
            
            // Data terpilih (setelah filter)
            selectedDataEl.textContent = filteredData.length ? filteredData.length.toLocaleString('id-ID') : '0';
        }
        
        // Filter data ganda
        filterBtn.addEventListener('click', async function() {
            if (isProcessing) return;
            
            if (originalData.length === 0) {
                showNotification('warning', 'Peringatan', 'Tidak ada data untuk diproses.');
                return;
            }
            
            // Tampilkan loading
            showLoading('Memfilter Data Ganda', 'Menganalisis dan memfilter data duplikat...');
            progressContainer.style.display = 'block';
            
            try {
                isProcessing = true;
                
                // Simulasi progress
                updateProgress(10, 'Menganalisis data...');
                
                // Tunggu sedikit untuk animasi
                await delay(300);
                
                // Kelompokkan data berdasarkan NIK
                updateProgress(30, 'Mengelompokkan data berdasarkan NIK...');
                const groupedByNIK = {};
                duplicateGroups = {};
                
                originalData.forEach((item) => {
                    const nik = item.NIK;
                    if (!groupedByNIK[nik]) {
                        groupedByNIK[nik] = [];
                    }
                    groupedByNIK[nik].push({...item});
                });
                
                await delay(300);
                updateProgress(50, 'Memilih data dengan isian paling lengkap...');
                
                // Untuk setiap NIK, pilih data dengan isian paling lengkap
                filteredData = [];
                
                Object.keys(groupedByNIK).forEach(nik => {
                    const group = groupedByNIK[nik];
                    
                    if (group.length === 1) {
                        // Jika hanya ada satu data, langsung tambahkan
                        filteredData.push(group[0]);
                        duplicateGroups[nik] = {
                            selectedId: group[0].__id,
                            count: 1
                        };
                    } else {
                        // Jika ada duplikat, pilih yang paling lengkap
                        let bestItem = group[0];
                        let maxFilled = 0;
                        
                        // Hitung isian untuk setiap item
                        group.forEach(item => {
                            // Hitung jumlah kolom yang terisi
                            const filledCount = columns.filter(col => 
                                item[col] && item[col].toString().trim() !== ''
                            ).length;
                            
                            // Jika jumlah terisi lebih besar, pilih item ini
                            if (filledCount > maxFilled) {
                                maxFilled = filledCount;
                                bestItem = item;
                            } else if (filledCount === maxFilled) {
                                // Jika jumlah terisi sama, cek kelengkapan per kolom
                                // Prioritas: NAMA, ALAMAT, NOMOR_HP
                                const currentBestScore = calculateDataScore(bestItem);
                                const currentItemScore = calculateDataScore(item);
                                
                                if (currentItemScore > currentBestScore) {
                                    bestItem = item;
                                }
                            }
                        });
                        
                        filteredData.push(bestItem);
                        
                        // Simpan informasi duplikat untuk highlight
                        duplicateGroups[nik] = {
                            selectedId: bestItem.__id,
                            count: group.length
                        };
                    }
                });
                
                await delay(300);
                updateProgress(80, 'Menyiapkan tampilan...');
                
                // Tampilkan data yang sudah difilter dengan highlight
                displayData(originalData, true);
                updateStats(originalData);
                selectedDataEl.textContent = filteredData.length.toLocaleString('id-ID');
                
                // Aktifkan tombol unduh
                downloadBtn.disabled = false;
                
                updateProgress(100, 'Selesai!');
                
                await delay(500);
                hideLoading();
                
                // Tampilkan hasil filter
                const duplicateCount = originalData.length - filteredData.length;
                showNotification(
                    'success', 
                    'Filter Berhasil', 
                    `Ditemukan ${duplicateCount} data ganda. Data unik setelah filter: ${filteredData.length} data.`
                );
                
                isProcessing = false;
                
            } catch (error) {
                console.error('Error filtering data:', error);
                hideLoading();
                showNotification('error', 'Kesalahan', 'Terjadi kesalahan saat memfilter data.');
                isProcessing = false;
            }
        });
        
        // Fungsi untuk menghitung skor data (untuk tie-breaker)
        function calculateDataScore(item) {
            let score = 0;
            
            // Beri bobot lebih untuk kolom penting
            if (item.NAMA && item.NAMA.trim() !== '') score += 3;
            if (item.ALAMAT && item.ALAMAT.trim() !== '') score += 2;
            if (item.NOMOR_HP && item.NOMOR_HP.trim() !== '') score += 2;
            if (item.KECAMATAN && item.KECAMATAN.trim() !== '') score += 1;
            if (item.DESA && item.DESA.trim() !== '') score += 1;
            if (item.PROFESI && item.PROFESI.trim() !== '') score += 1;
            if (item.ALAT_TANGKAP && item.ALAT_TANGKAP.trim() !== '') score += 1;
            if (item.JENIS_KAPAL && item.JENIS_KAPAL.trim() !== '') score += 1;
            
            return score;
        }
        
        // Unduh hasil filter
        downloadBtn.addEventListener('click', async function() {
            if (isProcessing) return;
            
            if (filteredData.length === 0) {
                showNotification('warning', 'Peringatan', 'Tidak ada data untuk diunduh.');
                return;
            }
            
            const format = document.querySelector('input[name="downloadFormat"]:checked').value;
            
            // Tampilkan loading
            showLoading('Menyiapkan File', `Membuat file ${format.toUpperCase()} dari data yang sudah difilter...`);
            
            try {
                isProcessing = true;
                
                // Bersihkan data dari properti internal
                const cleanData = filteredData.map(item => {
                    const { __id, ...cleanItem } = item;
                    return cleanItem;
                });
                
                updateProgress(30, 'Mempersiapkan data...');
                
                let filename, blob;
                
                if (format === 'excel') {
                    updateProgress(60, 'Membuat file Excel...');
                    
                    // Buat worksheet
                    const worksheet = XLSX.utils.json_to_sheet(cleanData);
                    
                    // Buat workbook
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Data Filtered");
                    
                    // Konversi ke binary
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    
                    // Buat blob
                    blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    filename = `data_filtered_${getTimestamp()}.xlsx`;
                    
                } else if (format === 'csv') {
                    updateProgress(60, 'Membuat file CSV...');
                    
                    // Buat header CSV
                    const headers = columns.join(',');
                    
                    // Buat baris data
                    const csvRows = cleanData.map(item => {
                        return columns.map(col => {
                            const value = item[col] || '';
                            // Handle nilai yang mengandung koma atau quote
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',');
                    });
                    
                    // Gabungkan header dan data
                    const csvContent = [headers, ...csvRows].join('\n');
                    
                    // Buat blob
                    blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    filename = `data_filtered_${getTimestamp()}.csv`;
                }
                
                updateProgress(90, 'Menyimpan file...');
                
                // Gunakan FileSaver.js untuk menyimpan file
                saveAs(blob, filename);
                
                updateProgress(100, 'Selesai!');
                
                await delay(500);
                hideLoading();
                showNotification('success', 'Unduh Berhasil', `File "${filename}" berhasil diunduh.`);
                
                isProcessing = false;
                
            } catch (error) {
                console.error('Error downloading file:', error);
                hideLoading();
                showNotification('error', 'Kesalahan', 'Terjadi kesalahan saat mengunduh file.');
                isProcessing = false;
            }
        });
        
        // Reset aplikasi
        resetBtn.addEventListener('click', function() {
            if (isProcessing) return;
            
            // Tampilkan loading
            showLoading('Mereset Aplikasi', 'Membersihkan data dan mengatur ulang...');
            
            // Gunakan setTimeout untuk memberikan waktu tampilan loading
            setTimeout(() => {
                // Reset semua data
                originalData = [];
                filteredData = [];
                duplicateGroups = {};
                
                // Reset UI
                fileInput.value = '';
                processBtn.disabled = true;
                filterBtn.disabled = true;
                downloadBtn.disabled = true;
                
                // Reset format download ke default
                formatExcel.checked = true;
                
                // Reset tabel
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-file-excel" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            Belum ada data. Silakan unggah file Excel/CSV untuk memulai.
                        </td>
                    </tr>
                `;
                
                // Reset statistik
                totalDataEl.textContent = '0';
                duplicateDataEl.textContent = '0';
                uniqueDataEl.textContent = '0';
                selectedDataEl.textContent = '0';
                
                hideLoading();
                showNotification('info', 'Reset Berhasil', 'Aplikasi telah direset. Silakan unggah file baru.');
            }, 500);
        });
        
        // Fungsi untuk menampilkan loading
        function showLoading(title = 'Memproses', message = 'Silakan tunggu...') {
            loadingText.textContent = title;
            loadingSubtext.textContent = message;
            loadingOverlay.style.display = 'flex';
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }
        
        // Fungsi untuk menyembunyikan loading
        function hideLoading() {
            loadingOverlay.style.display = 'none';
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }
        
        // Fungsi untuk update progress bar
        function updateProgress(percent, message = '') {
            progressBar.style.width = `${percent}%`;
            if (message) {
                loadingSubtext.textContent = message;
            }
        }
        
        // Fungsi untuk menampilkan notifikasi
        function showNotification(type, title, message, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Tentukan ikon berdasarkan tipe
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Trigger animasi masuk
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Tambahkan event listener untuk tombol close
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto remove setelah durasi tertentu
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toast);
                }, duration);
            }
            
            return toast;
        }
        
        // Fungsi untuk menghapus notifikasi
        function removeToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // Fungsi utilitas
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function getTimestamp() {
            const now = new Date();
            return now.toISOString().slice(0, 19).replace(/[:]/g, '-').replace('T', '_');
        }
        
        // Load data contoh saat halaman dimuat (untuk demo)
        document.addEventListener('DOMContentLoaded', function() {
            // Tampilkan notifikasi selamat datang
            setTimeout(() => {
                showNotification('info', 'Selamat Datang', 'Unggah file Excel/CSV untuk memulai proses filter data ganda.');
            }, 1000);
            
            // Tambahkan event listener untuk mencegah double click
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (isProcessing && !this.id.includes('reset')) {
                        e.preventDefault();
                        showNotification('warning', 'Sedang Memproses', 'Tunggu hingga proses selesai.');
                    }
                });
            });
        });
    </script>
</body>
</html>
