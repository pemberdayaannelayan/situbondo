<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Data Ganda Berdasarkan NIK KTP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .card {
            background-color: #f9fafc;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #2a5298;
        }
        
        h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #2a5298;
        }
        
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .file-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-input-wrapper {
            position: relative;
            flex-grow: 1;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed #c2c9d6;
            border-radius: 8px;
            background-color: white;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input:hover {
            border-color: #2a5298;
            background-color: #f0f5ff;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #2a5298;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.2);
        }
        
        .btn-secondary {
            background-color: #f0f5ff;
            color: #2a5298;
            border: 1px solid #c2c9d6;
        }
        
        .btn-secondary:hover {
            background-color: #e1e9ff;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .info-box {
            background-color: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #2a5298;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #1e3c72;
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-item {
            flex: 1;
            min-width: 150px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            border-top: 4px solid #2a5298;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2a5298;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th {
            background-color: #2a5298;
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eaeaea;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafc;
        }
        
        tr:hover {
            background-color: #f0f5ff;
        }
        
        .duplicate-row {
            background-color: #fff5f5 !important;
        }
        
        .selected-row {
            background-color: #f0fff4 !important;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            margin-top: 20px;
        }
        
        .duplicate-badge {
            background-color: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .selected-badge {
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eaeaea;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f0f0f0;
            border-top: 5px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 14px;
        }
        
        /* Notification Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background-color: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            border-left: 5px solid #2a5298;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success {
            border-left-color: #28a745;
        }
        
        .toast-warning {
            border-left-color: #ffc107;
        }
        
        .toast-error {
            border-left-color: #dc3545;
        }
        
        .toast-info {
            border-left-color: #17a2b8;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-success .toast-icon {
            color: #28a745;
        }
        
        .toast-warning .toast-icon {
            color: #ffc107;
        }
        
        .toast-error .toast-icon {
            color: #dc3545;
        }
        
        .toast-info .toast-icon {
            color: #17a2b8;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            color: #555;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #333;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .card {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            .file-input-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .stat-item {
                min-width: 100%;
            }
            
            .toast {
                min-width: 250px;
            }
            
            .toast-container {
                left: 20px;
                right: 20px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Memproses data...</div>
            <div class="loading-subtext" id="loadingSubtext">Silakan tunggu, proses sedang berjalan</div>
        </div>
    </div>
    
    <!-- Notification Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Main Container -->
    <div class="container">
        <header>
            <h1><i class="fas fa-filter"></i> Filter Data Ganda Berdasarkan NIK KTP</h1>
            <p class="subtitle">Impor data Excel dan hapus duplikat berdasarkan NIK dengan memilih data yang paling lengkap</p>
        </header>
        
        <div class="main-content">
            <div class="card">
                <h2><i class="fas fa-upload"></i> Impor Data Excel</h2>
                <div class="upload-section">
                    <p>Unggah file Excel (.xlsx) yang berisi data dengan kolom: NAMA, NIK, ALAMAT, KECAMATAN, DESA, NOMOR_HP, PROFESI, ALAT_TANGKAP, JENIS_KAPAL</p>
                    
                    <div class="file-input-container">
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                        </div>
                        <button id="processBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-cogs"></i> Proses Data
                        </button>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Fitur Aplikasi:</strong></p>
                        <ul>
                            <li>Mendeteksi data ganda berdasarkan NIK KTP</li>
                            <li>Otomatis memilih data dengan isian paling lengkap untuk setiap NIK</li>
                            <li>Menampilkan statistik data sebelum dan sesudah diproses</li>
                            <li>Mengunduh hasil data yang sudah difilter</li>
                            <li>Notifikasi dan indikator loading untuk setiap proses</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Statistik Data</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalData">0</div>
                        <div class="stat-label">Total Data</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="duplicateData">0</div>
                        <div class="stat-label">Data Ganda</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="uniqueData">0</div>
                        <div class="stat-label">Data Unik</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="selectedData">0</div>
                        <div class="stat-label">Data Terpilih</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-table"></i> Data yang Diproses</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fff5f5;"></div>
                        <span>Data Ganda</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f0fff4;"></div>
                        <span>Data Terpilih (Paling Lengkap)</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NAMA</th>
                                <th>NIK</th>
                                <th>ALAMAT</th>
                                <th>KECAMATAN</th>
                                <th>DESA</th>
                                <th>NOMOR_HP</th>
                                <th>PROFESI</th>
                                <th>ALAT_TANGKAP</th>
                                <th>JENIS_KAPAL</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-file-excel" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                    Belum ada data. Silakan unggah file Excel untuk memulai.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="controls">
                    <button id="filterBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-filter"></i> Filter Data Ganda
                    </button>
                    <button id="downloadBtn" class="btn btn-success" disabled>
                        <i class="fas fa-download"></i> Unduh Hasil Filter
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Aplikasi Filter Data Ganda Berdasarkan NIK KTP &copy; 2023</p>
            <p>Data duplikat akan digantikan dengan data yang lebih lengkap isiannya</p>
        </div>
    </div>

    <script>
        // Variabel global untuk menyimpan data
        let originalData = [];
        let filteredData = [];
        let duplicateGroups = {};
        
        // Elemen DOM
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const filterBtn = document.getElementById('filterBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tableBody = document.getElementById('tableBody');
        const totalDataEl = document.getElementById('totalData');
        const duplicateDataEl = document.getElementById('duplicateData');
        const uniqueDataEl = document.getElementById('uniqueData');
        const selectedDataEl = document.getElementById('selectedData');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtext = document.getElementById('loadingSubtext');
        const toastContainer = document.getElementById('toastContainer');
        
        // Kolom yang akan diproses
        const columns = ['NAMA', 'NIK', 'ALAMAT', 'KECAMATAN', 'DESA', 'NOMOR_HP', 'PROFESI', 'ALAT_TANGKAP', 'JENIS_KAPAL'];
        
        // Event listener untuk input file
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processBtn.disabled = false;
                showNotification('success', 'File Dipilih', `File "${e.target.files[0].name}" siap untuk diproses`);
            } else {
                processBtn.disabled = true;
            }
        });
        
        // Proses file Excel yang diunggah
        processBtn.addEventListener('click', async function() {
            const file = fileInput.files[0];
            if (!file) {
                showNotification('error', 'Kesalahan', 'Silakan pilih file Excel terlebih dahulu.');
                return;
            }
            
            // Tampilkan loading
            showLoading('Memproses File Excel', 'Membaca dan memvalidasi data dari file...');
            
            // Gunakan setTimeout untuk memberikan waktu tampilan loading
            setTimeout(async () => {
                try {
                    const data = await readExcelFile(file);
                    
                    if (data.length === 0) {
                        hideLoading();
                        showNotification('warning', 'Data Kosong', 'Tidak ada data yang valid ditemukan dalam file.');
                        return;
                    }
                    
                    // Simpan data asli
                    originalData = data;
                    
                    // Tampilkan data awal
                    displayData(originalData);
                    updateStats(originalData);
                    
                    // Aktifkan tombol filter
                    filterBtn.disabled = false;
                    downloadBtn.disabled = true;
                    
                    hideLoading();
                    showNotification('success', 'Berhasil', `Berhasil membaca ${originalData.length} data dari file Excel.`);
                    
                } catch (error) {
                    console.error(error);
                    hideLoading();
                    showNotification('error', 'Kesalahan', 'Terjadi kesalahan saat membaca file. Pastikan file dalam format Excel yang benar.');
                }
            }, 500);
        });
        
        // Fungsi untuk membaca file Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Ambil data dari sheet pertama
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Konversi ke JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // Proses data: baris pertama sebagai header
                        const headers = jsonData[0];
                        
                        // Validasi header
                        const missingColumns = columns.filter(col => !headers.includes(col));
                        if (missingColumns.length > 0) {
                            reject(new Error(`Kolom berikut tidak ditemukan dalam file: ${missingColumns.join(', ')}`));
                            return;
                        }
                        
                        // Ambil data dari baris kedua dan seterusnya
                        const processedData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length === 0) continue;
                            
                            const rowData = {};
                            columns.forEach((col, index) => {
                                const colIndex = headers.indexOf(col);
                                rowData[col] = colIndex !== -1 && row[colIndex] !== undefined && row[colIndex] !== null ? String(row[colIndex]).trim() : '';
                            });
                            
                            // Hanya tambah data yang memiliki NIK
                            if (rowData.NIK && rowData.NIK.trim() !== '') {
                                // Tambahkan ID unik untuk melacak baris asli
                                rowData.__id = `row_${i}`;
                                processedData.push(rowData);
                            }
                        }
                        
                        resolve(processedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Gagal membaca file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Fungsi untuk menampilkan data di tabel
        function displayData(data, highlightDuplicates = false) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            Tidak ada data untuk ditampilkan.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Tentukan apakah perlu menyorot duplikat
            const nikCounts = {};
            data.forEach(item => {
                nikCounts[item.NIK] = (nikCounts[item.NIK] || 0) + 1;
            });
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Tentukan kelas untuk baris
                let rowClass = '';
                let statusBadge = '';
                
                if (highlightDuplicates) {
                    const isDuplicate = nikCounts[item.NIK] > 1;
                    const isSelected = duplicateGroups[item.NIK] && 
                                      duplicateGroups[item.NIK].selectedId === item.__id;
                    
                    if (isSelected) {
                        rowClass = 'selected-row';
                        statusBadge = '<span class="selected-badge">Terpilih</span>';
                    } else if (isDuplicate) {
                        rowClass = 'duplicate-row';
                        statusBadge = '<span class="duplicate-badge">Ganda</span>';
                    }
                }
                
                row.className = rowClass;
                
                // Hitung jumlah kolom yang terisi (tidak kosong)
                const filledColumns = columns.filter(col => item[col] && item[col].toString().trim() !== '').length;
                
                // Format nomor HP jika ada
                const nomorHP = item.NOMOR_HP || '';
                const formattedHP = nomorHP && !isNaN(nomorHP.replace(/\D/g, '')) && nomorHP.replace(/\D/g, '').length >= 10 
                    ? formatPhoneNumber(nomorHP) 
                    : nomorHP;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.NAMA || ''}</td>
                    <td>${formatNIK(item.NIK)}</td>
                    <td>${item.ALAMAT || ''}</td>
                    <td>${item.KECAMATAN || ''}</td>
                    <td>${item.DESA || ''}</td>
                    <td>${formattedHP}</td>
                    <td>${item.PROFESI || ''}</td>
                    <td>${item.ALAT_TANGKAP || ''}</td>
                    <td>${item.JENIS_KAPAL || ''}</td>
                    <td>${statusBadge} <br><small>${filledColumns}/9 kolom terisi</small></td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Format NIK untuk tampilan
        function formatNIK(nik) {
            if (!nik) return '';
            const cleanNIK = nik.toString().replace(/\D/g, '');
            if (cleanNIK.length !== 16) return nik;
            return `${cleanNIK.substring(0, 4)}.${cleanNIK.substring(4, 8)}.${cleanNIK.substring(8, 12)}.${cleanNIK.substring(12)}`;
        }
        
        // Format nomor telepon
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.length === 0) return phone;
            
            if (cleaned.length <= 10) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            } else {
                return cleaned.replace(/(\d{4})(\d{4})(\d{4,})/, '$1-$2-$3');
            }
        }
        
        // Fungsi untuk memperbarui statistik
        function updateStats(data) {
            totalDataEl.textContent = data.length.toLocaleString();
            
            // Hitung jumlah data unik berdasarkan NIK
            const uniqueNiks = new Set(data.map(item => item.NIK));
            uniqueDataEl.textContent = uniqueNiks.size.toLocaleString();
            
            // Hitung jumlah data ganda
            const duplicateCount = data.length - uniqueNiks.size;
            duplicateDataEl.textContent = duplicateCount.toLocaleString();
            
            // Data terpilih (setelah filter)
            selectedDataEl.textContent = filteredData.length ? filteredData.length.toLocaleString() : '0';
        }
        
        // Filter data ganda
        filterBtn.addEventListener('click', function() {
            if (originalData.length === 0) {
                showNotification('warning', 'Peringatan', 'Tidak ada data untuk diproses.');
                return;
            }
            
            // Tampilkan loading
            showLoading('Memfilter Data Ganda', 'Menganalisis dan memfilter data duplikat...');
            
            // Gunakan setTimeout untuk memberikan waktu tampilan loading
            setTimeout(() => {
                try {
                    // Kelompokkan data berdasarkan NIK
                    const groupedByNIK = {};
                    duplicateGroups = {};
                    
                    originalData.forEach((item, index) => {
                        const nik = item.NIK;
                        if (!groupedByNIK[nik]) {
                            groupedByNIK[nik] = [];
                        }
                        groupedByNIK[nik].push({...item});
                    });
                    
                    // Untuk setiap NIK, pilih data dengan isian paling lengkap
                    filteredData = [];
                    
                    Object.keys(groupedByNIK).forEach(nik => {
                        const group = groupedByNIK[nik];
                        
                        if (group.length === 1) {
                            // Jika hanya ada satu data, langsung tambahkan
                            filteredData.push(group[0]);
                            duplicateGroups[nik] = {
                                selectedId: group[0].__id,
                                count: 1
                            };
                        } else {
                            // Jika ada duplikat, pilih yang paling lengkap
                            let bestItem = group[0];
                            let maxFilled = 0;
                            
                            // Hitung isian untuk setiap item
                            group.forEach(item => {
                                // Hitung jumlah kolom yang terisi
                                const filledCount = columns.filter(col => 
                                    item[col] && item[col].toString().trim() !== ''
                                ).length;
                                
                                // Jika jumlah terisi lebih besar, pilih item ini
                                if (filledCount > maxFilled) {
                                    maxFilled = filledCount;
                                    bestItem = item;
                                }
                                // Jika jumlah terisi sama, pertahankan yang pertama
                            });
                            
                            filteredData.push(bestItem);
                            
                            // Simpan informasi duplikat untuk highlight
                            duplicateGroups[nik] = {
                                selectedId: bestItem.__id,
                                count: group.length
                            };
                        }
                    });
                    
                    // Tampilkan data yang sudah difilter dengan highlight
                    displayData(originalData, true);
                    updateStats(originalData);
                    selectedDataEl.textContent = filteredData.length.toLocaleString();
                    
                    // Aktifkan tombol unduh
                    downloadBtn.disabled = false;
                    
                    hideLoading();
                    
                    // Tampilkan hasil filter
                    const duplicateCount = originalData.length - filteredData.length;
                    showNotification(
                        'success', 
                        'Filter Berhasil', 
                        `Ditemukan ${duplicateCount} data ganda. Data unik setelah filter: ${filteredData.length} data.`
                    );
                    
                } catch (error) {
                    console.error(error);
                    hideLoading();
                    showNotification('error', 'Kesalahan', 'Terjadi kesalahan saat memfilter data.');
                }
            }, 800);
        });
        
        // Unduh hasil filter sebagai file Excel
        downloadBtn.addEventListener('click', function() {
            if (filteredData.length === 0) {
                showNotification('warning', 'Peringatan', 'Tidak ada data untuk diunduh.');
                return;
            }
            
            // Tampilkan loading
            showLoading('Menyiapkan File', 'Membuat file Excel dari data yang sudah difilter...');
            
            // Gunakan setTimeout untuk memberikan waktu tampilan loading
            setTimeout(() => {
                try {
                    // Buat worksheet dari data yang sudah difilter
                    const cleanData = filteredData.map(item => {
                        // Hapus properti internal sebelum diunduh
                        const { __id, ...cleanItem } = item;
                        return cleanItem;
                    });
                    
                    const worksheet = XLSX.utils.json_to_sheet(cleanData);
                    
                    // Buat workbook
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Data Filtered");
                    
                    // Simpan file
                    const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g, '-');
                    const filename = `data_filtered_${timestamp}.xlsx`;
                    XLSX.writeFile(workbook, filename);
                    
                    hideLoading();
                    showNotification('success', 'Unduh Berhasil', `File "${filename}" berhasil diunduh.`);
                    
                } catch (error) {
                    console.error(error);
                    hideLoading();
                    showNotification('error', 'Kesalahan', 'Terjadi kesalahan saat mengunduh file.');
                }
            }, 800);
        });
        
        // Reset aplikasi
        resetBtn.addEventListener('click', function() {
            // Tampilkan loading
            showLoading('Mereset Aplikasi', 'Membersihkan data dan mengatur ulang...');
            
            // Gunakan setTimeout untuk memberikan waktu tampilan loading
            setTimeout(() => {
                // Reset semua data
                originalData = [];
                filteredData = [];
                duplicateGroups = {};
                
                // Reset UI
                fileInput.value = '';
                processBtn.disabled = true;
                filterBtn.disabled = true;
                downloadBtn.disabled = true;
                
                // Reset tabel
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-file-excel" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            Belum ada data. Silakan unggah file Excel untuk memulai.
                        </td>
                    </tr>
                `;
                
                // Reset statistik
                totalDataEl.textContent = '0';
                duplicateDataEl.textContent = '0';
                uniqueDataEl.textContent = '0';
                selectedDataEl.textContent = '0';
                
                hideLoading();
                showNotification('info', 'Reset Berhasil', 'Aplikasi telah direset. Silakan unggah file Excel baru.');
            }, 500);
        });
        
        // Fungsi untuk menampilkan loading
        function showLoading(title = 'Memproses', message = 'Silakan tunggu...') {
            loadingText.textContent = title;
            loadingSubtext.textContent = message;
            loadingOverlay.style.display = 'flex';
        }
        
        // Fungsi untuk menyembunyikan loading
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Fungsi untuk menampilkan notifikasi
        function showNotification(type, title, message, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Tentukan ikon berdasarkan tipe
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Trigger animasi masuk
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Tambahkan event listener untuk tombol close
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto remove setelah durasi tertentu
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toast);
                }, duration);
            }
            
            return toast;
        }
        
        // Fungsi untuk menghapus notifikasi
        function removeToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // Load data contoh saat halaman dimuat (untuk demo)
        document.addEventListener('DOMContentLoaded', function() {
            // Tampilkan notifikasi selamat datang
            setTimeout(() => {
                showNotification('info', 'Selamat Datang', 'Unggah file Excel untuk memulai atau gunakan data contoh.');
            }, 1000);
        });
    </script>
</body>
</html>
